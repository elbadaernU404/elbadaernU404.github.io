<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>青域</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="personal IT related station">
<meta property="og:type" content="website">
<meta property="og:title" content="青域">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="青域">
<meta property="og:description" content="personal IT related station">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="青域">
<meta name="twitter:description" content="personal IT related station">
  
    <link rel="alternate" href="/atom.xml" title="青域" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/home.css">
  

  

  

  
  
  

</head>
</html>

  <body>


  
    <header id="header">

	<!-- 背景图模式 -->
	

    
      <div id="intrologo" class="intro-logo" style="background-position:center; background-repeat:no-repeat; background-image: url(); background-size: auto 100%;">

      <!-- Support rolling -->  
        
        <section class="awSlider">
          <div class="carousel slide carousel-fade " data-ride="carousel">

            <!-- Wrapper for slides -->
            <div class="carousel-inner">
               
                  
                    <div class="item active">
                  
                    <img id="carousel-img0" src="/css/images/home-bg.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img0 = new Image();
                      var imageTag0 = document.getElementById("carousel-img0");
                      img0.src = imageTag0.src;
                      img0.onload=function(){
                        if (img0.width / img0.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag0.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag0.style.height = document.body.clientHeight + "px";
                          imageTag0.style.marginLeft = -(document.body.clientHeight * img0.width / img0.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img1" src="/css/images/sample.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img1 = new Image();
                      var imageTag1 = document.getElementById("carousel-img1");
                      img1.src = imageTag1.src;
                      img1.onload=function(){
                        if (img1.width / img1.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag1.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag1.style.height = document.body.clientHeight + "px";
                          imageTag1.style.marginLeft = -(document.body.clientHeight * img1.width / img1.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img2" src="https://api.isoyu.com/bing_images.php">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img2 = new Image();
                      var imageTag2 = document.getElementById("carousel-img2");
                      img2.src = imageTag2.src;
                      img2.onload=function(){
                        if (img2.width / img2.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag2.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag2.style.height = document.body.clientHeight + "px";
                          imageTag2.style.marginLeft = -(document.body.clientHeight * img2.width / img2.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
            </div>

            <!-- Controls -->
            <a class="left carousel-control" href=".carousel" role="button" data-slide="prev">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
              <span class="sr-only">Geri</span>
            </a>
            <a class="right carousel-control" href=".carousel" role="button" data-slide="next">
              <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
              <span class="sr-only">İleri</span>
            </a>
          </div>
        </section>
        <script>
          $('section.awSlider .carousel').carousel({
              pause: '',
              interval: 5000
          });
          var startImage = $('section.awSlider .item.active > img').attr('src');
          $('section.awSlider .carousel').on('slid.bs.carousel', function () {
              var bscn = $(this).find('.item.active > img').attr('src');
              $('section.awSlider > img').attr('src', bscn);
          });
        </script>
      

    
 


    <canvas width="100%" height="100%"></canvas>
    <script>
      var c = document.getElementsByTagName('canvas')[0],
          x = c.getContext('2d'),
          w = window.innerWidth,
          h = window.innerHeight,
          pr = window.devicePixelRatio || 1,
          f = 90,
          q,
          m = Math,
          r = 0,
          u = m.PI*2,
          v = m.cos,
          z = m.random
      c.width = w*pr
      c.height = h*pr
      x.scale(pr, pr)
      x.globalAlpha = 0.6

      <!-- 折线Polyline背景 -->
      
    </script>
    

    
      <div id="homelogo" class="homelogo" style="background: rgba(255,255,255,1);"> 
    

        
          <div class="homelogoback"  style="border: 1px solid #404040;" >
            <h1><a href="#content" id="logo">青域</a></h1>
            <h3>personal IT related station</h3>
            <h5>tianL.R</h5>
            <!-- <p><a href="https://github.com/iTimeTraveler" target="_blank">Github</a></p> -->
          </div>
        
    
    </div>
  </div>

  <!-- 自适应主页背景大图 -->
  

 <!-- home_logo_image居中 -->
 
    <script>
        var homelogodiv = document.getElementById("homelogo");
        if (document.all.homelogo.offsetWidth > document.body.clientWidth) {
          homelogodiv.style.width = document.body.clientWidth + "px";
          homelogodiv.style.marginLeft = document.body.clientWidth * -0.5 + "px";
        } else {
          homelogodiv.style.width = homelogodiv.clientWidth  + "px";
          homelogodiv.style.marginLeft = (homelogodiv.clientWidth)  * -0.5 + "px";
        }
    </script>
  

  <div class="intro-navigate">
      <p class="navigater-list">
        
          <a id="beautifont" class="main-nav-link" href="/">Home</a>
        
          <a id="beautifont" class="main-nav-link" href="/archives">Archives</a>
        
          <a id="beautifont" class="main-nav-link" href="/categories">Categories</a>
        
          <a id="beautifont" class="main-nav-link" href="/tags">Tags</a>
        
          <a id="beautifont" class="main-nav-link" href="/about">About</a>
        
      </p>
  </div>

</header>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=461347998&auto=0&height=66"></iframe>
  
  <div id="container">
    <div id="wrap">
      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;">
  
    <article id="post-关键信息提取（KIE）"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/11/26/关键信息提取（KIE）/">关键信息提取（KIE）</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/11/26/关键信息提取（KIE）/" class="article-date">
	  <time datetime="2024-11-26T11:24:34.000Z" itemprop="datePublished">2024-11-26</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <script src="\assets\js\APlayer.min.js"> </script><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><font color="gold"><strong>· OS: </strong></font>CentOS7.9<br><br><font color="gold"><strong>· GPU: </strong></font> RTX3090 24G<em>2<br><br><font color="gold"><strong>· CUDA: </strong></font> 11.7<br><br><font color="gold"><strong>· CUDNN: </strong></font> 8.9.2<br><br>### 飞桨<br><br><font color="gold"><strong>· paddlepaddle: </strong></font> paddlepaddle-gpu==2.4.2（cudatoolkit=11.7，建议conda安装）<br><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge</span><br></pre></td></tr></table></figure><br><br><font color="gold"><strong>· paddleocr: </strong></font> 2.9.1<br><br><font color="gold"><strong>· paddlenlp: </strong></font> 2.5.2<br><br>### 项目依赖包<br><br><strong><code>requirements.txt</code></strong><br><br><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># paddlepaddle 2.4.2 注：必须</span><br><span class="line"># conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge</span><br><span class="line"></span><br><span class="line">shapely</span><br><span class="line">scikit-image</span><br><span class="line">pyclipper</span><br><span class="line">lmdb</span><br><span class="line">tqdm</span><br><span class="line">numpy</span><br><span class="line">rapidfuzz</span><br><span class="line">opencv-python</span><br><span class="line">opencv-contrib-python</span><br><span class="line">cython</span><br><span class="line">Pillow</span><br><span class="line">pyyaml</span><br><span class="line">requests</span><br><span class="line">albumentations==1.4.10</span><br><span class="line"># to be compatible with albumentations</span><br><span class="line">albucore==0.0.13</span><br><span class="line"></span><br><span class="line">sentencepiece</span><br><span class="line">yacs</span><br><span class="line">seqeval</span><br><span class="line">pypandoc</span><br><span class="line">attrdict3</span><br><span class="line">python_docx</span><br><span class="line">paddlenlp==2.5.2</span><br></pre></td></tr></table></figure><br><br><font color="red"><strong>注：</strong></font> <strong>bugfix</strong><br><br><font color="gold"><strong>1.</strong></font> `ModuleNotFoundError: No module named ‘ppocr.**</em>‘<code>前往官方github主页（&lt;https://github.com/PaddlePaddle/PaddleOCR&gt;）补齐源码到python环境

e.g.conda 虚拟环境下，需要补齐的源码根目录为：</code>/root/anaconda3/envs/py39_kie/lib/python3.9/site-packages/paddleocr/ppocr<code>&lt;font color=&#39;gold&#39;&gt;**2.**&lt;/font&gt;</code>ModuleNotFoundError: No module named ‘paddle.fluid’<code>安装较低版本paddle</code>paddlepaddle2.4.2/2.5.0<code>&lt;font color=&#39;gold&#39;&gt;**3.**&lt;/font&gt; 类型错误：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InvalidArgumentError: The type of data we are trying to retrieve does not match the type of data currently contained in the container.</span><br><span class="line">      [Hint: Expected dtype() == paddle::experimental::CppTypeToDataType&lt;T&gt;::Type(), but received dtype():10 != paddle::experimental::CppTypeToDataType&lt;T&gt;::Type():9.] (at /paddle/paddle/phi/core/dense_tensor.cc:143)</span><br><span class="line">      [operator &lt; less_equal &gt; error]</span><br></pre></td></tr></table></figure>

官方示例bug，需要添加参数项</code>–use_visual_backbone = False<code>&lt;!--more--&gt;

## 模型

参考：&lt;https://paddlepaddle.github.io/PaddleOCR/latest/ppstructure/model_train/train_kie.html&gt;

### 准备（inference模型）

SER任务模型下载链接：&lt;https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/ser_vi_layoutxlm_xfund_infer.tar&gt;

RE任务模型下载链接：&lt;https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/re_vi_layoutxlm_xfund_infer.tar&gt;

创建项目根目录</code>demo<code>并添加测试图片</code>1.png<code>，在</code>demo<code>目录下新建</code>models<code>文件夹用于存放OCR、SER、RE模型、字典文件、字体文件。其中OCR模型可使用ppocrv3、v4版本下检测和识别（det/rec）模型，字典文件复制源码目录下</code>paddleocr/ppocr/utils/dict/kie_dict/xfund_class_list.txt<code>，字体文件使用</code>simfang.ttf<code>### SER/RE模型串联

&lt;font color=&#39;gold&#39;&gt;**1.**&lt;/font&gt;创建官方代码示例</code>demo/test.py<code>用于测试和显示图像（源码：</code>paddleocr/ppstructure/kie/predict_kie_token_ser_re.py<code>）

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2022 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">"../.."</span>)))</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">"FLAGS_allocator_strategy"</span>] = <span class="string">"auto_growth"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.infer.utility <span class="keyword">as</span> utility</span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.infer_kie_token_ser_re <span class="keyword">import</span> make_input</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.postprocess <span class="keyword">import</span> build_post_process</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.logging <span class="keyword">import</span> get_logger</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.visual <span class="keyword">import</span> draw_ser_results, draw_re_results</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.utility <span class="keyword">import</span> get_image_file_list, check_and_read</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.utility <span class="keyword">import</span> parse_args</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.kie.predict_kie_token_ser <span class="keyword">import</span> SerPredictor</span><br><span class="line"></span><br><span class="line">logger = get_logger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerRePredictor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.use_visual_backbone = args.use_visual_backbone</span><br><span class="line">        self.ser_engine = SerPredictor(args)</span><br><span class="line">        <span class="keyword">if</span> args.re_model_dir <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            postprocess_params = &#123;<span class="string">"name"</span>: <span class="string">"VQAReTokenLayoutLMPostProcess"</span>&#125;</span><br><span class="line">            self.postprocess_op = build_post_process(postprocess_params)</span><br><span class="line">            (</span><br><span class="line">                self.predictor,</span><br><span class="line">                self.input_tensor,</span><br><span class="line">                self.output_tensors,</span><br><span class="line">                self.config,</span><br><span class="line">            ) = utility.create_predictor(args, <span class="string">"re"</span>, logger)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.predictor = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        starttime = time.time()</span><br><span class="line">        ser_results, ser_inputs, ser_elapse = self.ser_engine(img)</span><br><span class="line">        <span class="keyword">if</span> self.predictor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ser_results, ser_elapse</span><br><span class="line"></span><br><span class="line">        re_input, entity_idx_dict_batch = make_input(ser_inputs, ser_results)</span><br><span class="line">        <span class="keyword">if</span> self.use_visual_backbone == <span class="literal">False</span>:</span><br><span class="line">            re_input.pop(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(self.input_tensor)):</span><br><span class="line">            self.input_tensor[idx].copy_from_cpu(re_input[idx])</span><br><span class="line"></span><br><span class="line">        self.predictor.run()</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> output_tensor <span class="keyword">in</span> self.output_tensors:</span><br><span class="line">            output = output_tensor.copy_to_cpu()</span><br><span class="line">            outputs.append(output)</span><br><span class="line">        preds = dict(</span><br><span class="line">            loss=outputs[<span class="number">1</span>],</span><br><span class="line">            pred_relations=outputs[<span class="number">2</span>],</span><br><span class="line">            hidden_states=outputs[<span class="number">0</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        post_result = self.postprocess_op(</span><br><span class="line">            preds, ser_results=ser_results, entity_idx_dict_batch=entity_idx_dict_batch</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        elapse = time.time() - starttime</span><br><span class="line">        <span class="keyword">return</span> post_result, elapse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(args)</span>:</span></span><br><span class="line">    image_file_list = get_image_file_list(args.image_dir)</span><br><span class="line">    ser_re_predictor = SerRePredictor(args)</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    total_time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    os.makedirs(args.output, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> open(</span><br><span class="line">            os.path.join(args.output, <span class="string">"infer.txt"</span>), mode=<span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span></span><br><span class="line">    ) <span class="keyword">as</span> f_w:</span><br><span class="line">        <span class="keyword">for</span> image_file <span class="keyword">in</span> image_file_list:</span><br><span class="line">            img, flag, _ = check_and_read(image_file)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">                img = cv2.imread(image_file)</span><br><span class="line">                img = img[:, :, ::<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                logger.info(<span class="string">"error in loading image:&#123;&#125;"</span>.format(image_file))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            re_res, elapse = ser_re_predictor(img)</span><br><span class="line">            re_res = re_res[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            res_str = <span class="string">"&#123;&#125;\t&#123;&#125;\n"</span>.format(</span><br><span class="line">                image_file,</span><br><span class="line">                json.dumps(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"ocr_info"</span>: re_res,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ensure_ascii=<span class="literal">False</span>,</span><br><span class="line">                ),</span><br><span class="line">            )</span><br><span class="line">            f_w.write(res_str)</span><br><span class="line">            <span class="keyword">if</span> ser_re_predictor.predictor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                img_res = draw_re_results(</span><br><span class="line">                    image_file, re_res, font_path=args.vis_font_path</span><br><span class="line">                )</span><br><span class="line">                img_save_path = os.path.join(</span><br><span class="line">                    args.output,</span><br><span class="line">                    os.path.splitext(os.path.basename(image_file))[<span class="number">0</span>] + <span class="string">"_ser_re.jpg"</span>,</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img_res = draw_ser_results(</span><br><span class="line">                    image_file, re_res, font_path=args.vis_font_path</span><br><span class="line">                )</span><br><span class="line">                img_save_path = os.path.join(</span><br><span class="line">                    args.output,</span><br><span class="line">                    os.path.splitext(os.path.basename(image_file))[<span class="number">0</span>] + <span class="string">"_ser.jpg"</span>,</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            cv2.imwrite(img_save_path, img_res)</span><br><span class="line">            logger.info(<span class="string">"save vis result to &#123;&#125;"</span>.format(img_save_path))</span><br><span class="line">            <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">                total_time += elapse</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            logger.info(<span class="string">"Predict time of &#123;&#125;: &#123;&#125;"</span>.format(image_file, elapse))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    args.mode = <span class="string">'kie'</span></span><br><span class="line">    args.use_visual_backbone = <span class="literal">False</span></span><br><span class="line">    args.kie_algorithm = <span class="string">'LayoutXLM'</span></span><br><span class="line">    args.re_model_dir = <span class="string">'./models/re_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_model_dir = <span class="string">'./models/ser_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_dict_path = <span class="string">'./models/xfund_class_list.txt'</span></span><br><span class="line">    args.vis_font_path = <span class="string">'./models/simfang.ttf'</span></span><br><span class="line">    args.ocr_order_method = <span class="string">"tb-yx"</span></span><br><span class="line">    args.det_model_dir = <span class="string">'./models/ch_PP-OCRv3_det_infer'</span></span><br><span class="line">    args.rec_model_dir = <span class="string">'./models/ch_PP-OCRv4_rec_infer'</span></span><br><span class="line">    args.image_dir = <span class="string">'./1.png'</span></span><br><span class="line">    main(args)</span><br></pre></td></tr></table></figure>

![](关键信息提取（KIE）\1.png)

&lt;font color=&#39;gold&#39;&gt;**2.**&lt;/font&gt;创建</code>demo/main.py<code>用于测试

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.kie.predict_kie_token_ser_re <span class="keyword">import</span> SerRePredictor</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.utility <span class="keyword">import</span> parse_args</span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.infer_kie_token_ser_re <span class="keyword">import</span> make_input</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承SerRePredictor类，重写__call__方法，实现同时输出Ser模型结果</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KIE</span><span class="params">(SerRePredictor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, para)</span>:</span></span><br><span class="line">        super().__init__(para)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, im)</span>:</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        ser_results, ser_inputs, ser_elapse = self.ser_engine(im)</span><br><span class="line">        <span class="keyword">if</span> self.predictor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ser_results, ser_elapse</span><br><span class="line"></span><br><span class="line">        re_input, entity_idx_dict_batch = make_input(ser_inputs, ser_results)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.use_visual_backbone:</span><br><span class="line">            re_input.pop(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(self.input_tensor)):</span><br><span class="line">            self.input_tensor[idx].copy_from_cpu(re_input[idx])</span><br><span class="line"></span><br><span class="line">        self.predictor.run()</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> output_tensor <span class="keyword">in</span> self.output_tensors:</span><br><span class="line">            output = output_tensor.copy_to_cpu()</span><br><span class="line">            outputs.append(output)</span><br><span class="line">        preds = dict(</span><br><span class="line">            loss=outputs[<span class="number">1</span>],</span><br><span class="line">            pred_relations=outputs[<span class="number">2</span>],</span><br><span class="line">            hidden_states=outputs[<span class="number">0</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        post_result = self.postprocess_op(</span><br><span class="line">            preds, ser_results=ser_results, entity_idx_dict_batch=entity_idx_dict_batch</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        elapse_time = time.time() - start_time</span><br><span class="line">        <span class="keyword">return</span> ser_results, post_result, elapse_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    args.mode = <span class="string">'kie'</span></span><br><span class="line">    args.show_log = <span class="literal">True</span></span><br><span class="line">    args.use_visual_backbone = <span class="literal">False</span></span><br><span class="line">    args.kie_algorithm = <span class="string">'LayoutXLM'</span></span><br><span class="line">    args.re_model_dir = <span class="string">'./models/re_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_model_dir = <span class="string">'./models/ser_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_dict_path = <span class="string">'./models/xfund_class_list.txt'</span></span><br><span class="line">    args.vis_font_path = <span class="string">'./models/simfang.ttf'</span></span><br><span class="line">    args.ocr_order_method = <span class="string">"tb-yx"</span></span><br><span class="line">    args.det_model_dir = <span class="string">'./models/ch_PP-OCRv3_det_infer'</span></span><br><span class="line">    args.rec_model_dir = <span class="string">'./models/ch_PP-OCRv4_rec_infer'</span></span><br><span class="line">    args.det_limit_side_len = <span class="number">1600</span>,</span><br><span class="line"></span><br><span class="line">    kie = KIE(args)</span><br><span class="line">    img = cv2.imread(<span class="string">'./1.png'</span>)</span><br><span class="line">    ser_res, re_res, elapse = kie(img)</span><br><span class="line">    print(ser_res, <span class="string">'\n'</span>, re_res, <span class="string">'\n'</span>, elapse)</span><br></pre></td></tr></table></figure>

输出：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[&#123;&apos;transcription&apos;: &apos;证号&apos;, &apos;bbox&apos;: [239, 113, 267, 128], &apos;points&apos;: [[239.0, 113.0], [267.0, 113.0], [267.0, 128.0], [239.0, 128.0]], &apos;pred_id&apos;: 0, &apos;pred&apos;: &apos;O&apos;&#125;, &#123;&apos;transcription&apos;: &apos;T4105051990090&apos;, &apos;bbox&apos;: [240, 135, 441, 157], &apos;points&apos;: [[240.0, 135.0], [441.0, 136.0], [440.0, 157.0], [240.0, 156.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;姓名&apos;, &apos;bbox&apos;: [239, 162, 266, 178], &apos;points&apos;: [[239.0, 162.0], [266.0, 162.0], [266.0, 178.0], [239.0, 178.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;作业类别&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;毕宏&apos;, &apos;bbox&apos;: [237, 182, 296, 203], &apos;points&apos;: [[237.0, 182.0], [296.0, 182.0], [296.0, 203.0], [237.0, 203.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 185, 586, 204], &apos;points&apos;: [[432.0, 185.0], [586.0, 185.0], [586.0, 204.0], [432.0, 204.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;男&apos;, &apos;bbox&apos;: [237, 246, 259, 269], &apos;points&apos;: [[237.0, 246.0], [259.0, 246.0], [259.0, 269.0], [237.0, 269.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;性别&apos;, &apos;bbox&apos;: [238, 227, 269, 246], &apos;points&apos;: [[238.0, 227.0], [269.0, 227.0], [269.0, 246.0], [238.0, 246.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;操作项目&apos;, &apos;bbox&apos;: [430, 228, 484, 245], &apos;points&apos;: [[430.0, 228.0], [484.0, 228.0], [484.0, 245.0], [430.0, 245.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;熔化焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 251, 622, 268], &apos;points&apos;: [[432.0, 251.0], [622.0, 251.0], [622.0, 268.0], [432.0, 268.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29&apos;, &apos;bbox&apos;: [71, 342, 173, 362], &apos;points&apos;: [[72.0, 342.0], [173.0, 345.0], [173.0, 362.0], [71.0, 360.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;初领日期&apos;, &apos;bbox&apos;: [73, 325, 128, 341], &apos;points&apos;: [[73.0, 325.0], [128.0, 325.0], [128.0, 341.0], [73.0, 341.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;有效期限&apos;, &apos;bbox&apos;: [226, 327, 278, 342], &apos;points&apos;: [[226.0, 327.0], [278.0, 327.0], [278.0, 342.0], [226.0, 342.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29至2029-03-28&apos;, &apos;bbox&apos;: [226, 345, 448, 362], &apos;points&apos;: [[226.0, 345.0], [448.0, 345.0], [448.0, 362.0], [226.0, 362.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2026-03-28前&apos;, &apos;bbox&apos;: [71, 389, 192, 413], &apos;points&apos;: [[72.0, 389.0], [192.0, 392.0], [192.0, 413.0], [71.0, 410.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;应复审日期&apos;, &apos;bbox&apos;: [74, 373, 140, 390], &apos;points&apos;: [[74.0, 373.0], [140.0, 373.0], [140.0, 390.0], [74.0, 390.0]], &apos;pred_id&apos;: 0, &apos;pred&apos;: &apos;O&apos;&#125;, &#123;&apos;transcription&apos;: &apos;签发机关&apos;, &apos;bbox&apos;: [223, 374, 278, 393], &apos;points&apos;: [[223.0, 375.0], [277.0, 374.0], [278.0, 392.0], [224.0, 393.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;河南省应急管理厅&apos;, &apos;bbox&apos;: [224, 394, 378, 414], &apos;points&apos;: [[224.0, 394.0], [378.0, 394.0], [378.0, 414.0], [224.0, 414.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;]] </span><br><span class="line"> [[(&#123;&apos;transcription&apos;: &apos;姓名&apos;, &apos;bbox&apos;: [239, 162, 266, 178], &apos;points&apos;: [[239.0, 162.0], [266.0, 162.0], [266.0, 178.0], [239.0, 178.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;毕宏&apos;, &apos;bbox&apos;: [237, 182, 296, 203], &apos;points&apos;: [[237.0, 182.0], [296.0, 182.0], [296.0, 203.0], [237.0, 203.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;作业类别&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 185, 586, 204], &apos;points&apos;: [[432.0, 185.0], [586.0, 185.0], [586.0, 204.0], [432.0, 204.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;作业类别&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;熔化焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 251, 622, 268], &apos;points&apos;: [[432.0, 251.0], [622.0, 251.0], [622.0, 268.0], [432.0, 268.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;性别&apos;, &apos;bbox&apos;: [238, 227, 269, 246], &apos;points&apos;: [[238.0, 227.0], [269.0, 227.0], [269.0, 246.0], [238.0, 246.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;男&apos;, &apos;bbox&apos;: [237, 246, 259, 269], &apos;points&apos;: [[237.0, 246.0], [259.0, 246.0], [259.0, 269.0], [237.0, 269.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;初领日期&apos;, &apos;bbox&apos;: [73, 325, 128, 341], &apos;points&apos;: [[73.0, 325.0], [128.0, 325.0], [128.0, 341.0], [73.0, 341.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29&apos;, &apos;bbox&apos;: [71, 342, 173, 362], &apos;points&apos;: [[72.0, 342.0], [173.0, 345.0], [173.0, 362.0], [71.0, 360.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;有效期限&apos;, &apos;bbox&apos;: [226, 327, 278, 342], &apos;points&apos;: [[226.0, 327.0], [278.0, 327.0], [278.0, 342.0], [226.0, 342.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29至2029-03-28&apos;, &apos;bbox&apos;: [226, 345, 448, 362], &apos;points&apos;: [[226.0, 345.0], [448.0, 345.0], [448.0, 362.0], [226.0, 362.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;签发机关&apos;, &apos;bbox&apos;: [223, 374, 278, 393], &apos;points&apos;: [[223.0, 375.0], [277.0, 374.0], [278.0, 392.0], [224.0, 393.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;河南省应急管理厅&apos;, &apos;bbox&apos;: [224, 394, 378, 414], &apos;points&apos;: [[224.0, 394.0], [378.0, 394.0], [378.0, 414.0], [224.0, 414.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;)]] </span><br><span class="line"> 0.959315299987793</span><br></pre></td></tr></table></figure>

## 训练（基于XFUND数据集）

参考：&lt;https://paddlepaddle.github.io/PaddleOCR/latest/ppocr/model_train/kie.html&gt;

### 数据下载

XFUND github主页：&lt;https://github.com/doc-analysis/XFUND&gt;

数据集下载地址：&lt;https://github.com/doc-analysis/XFUND/releases/tag/v1.0&gt;

选择中文数据集</code>zh.train.json<code>、</code>zh.train.zip<code>、</code>zh.val.json<code>、</code>zh.val.zip<code>并下载

![](关键信息提取（KIE）\2.png)

### 数据格式转换

创建XFUND格式转Paddle训练格式代码</code>demo/trans_xfun_data.py<code>（源码：</code>paddleocr/ppstructure/kie/tools/trans_xfun_data.py<code>）

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transfer_xfun_data</span><span class="params">(json_path=None, output_file=None)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(json_path, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fin:</span><br><span class="line">        lines = fin.readlines()</span><br><span class="line"></span><br><span class="line">    json_info = json.loads(lines[<span class="number">0</span>])</span><br><span class="line">    documents = json_info[<span class="string">"documents"</span>]</span><br><span class="line">    <span class="keyword">with</span> open(output_file, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        <span class="keyword">for</span> idx, document <span class="keyword">in</span> enumerate(documents):</span><br><span class="line">            label_info = []</span><br><span class="line">            img_info = document[<span class="string">"img"</span>]</span><br><span class="line">            document = document[<span class="string">"document"</span>]</span><br><span class="line">            image_path = img_info[<span class="string">"fname"</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> doc <span class="keyword">in</span> document:</span><br><span class="line">                x1, y1, x2, y2 = doc[<span class="string">"box"</span>]</span><br><span class="line">                points = [[x1, y1], [x2, y1], [x2, y2], [x1, y2]]</span><br><span class="line">                label_info.append(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"transcription"</span>: doc[<span class="string">"text"</span>],</span><br><span class="line">                        <span class="string">"label"</span>: doc[<span class="string">"label"</span>],</span><br><span class="line">                        <span class="string">"points"</span>: points,</span><br><span class="line">                        <span class="string">"id"</span>: doc[<span class="string">"id"</span>],</span><br><span class="line">                        <span class="string">"linking"</span>: doc[<span class="string">"linking"</span>],</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            fout.write(</span><br><span class="line">                image_path + <span class="string">"\t"</span> + json.dumps(label_info, ensure_ascii=<span class="literal">False</span>) + <span class="string">"\n"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"===ok===="</span>)</span><br><span class="line"></span><br><span class="line">ori_gt_path = <span class="string">r'D:\pycharmproject_2\kie\demo\dataset\zh.val.json'</span></span><br><span class="line">output_path = <span class="string">r'D:\pycharmproject_2\kie\demo\dataset\xfun_val.json'</span></span><br><span class="line"></span><br><span class="line">transfer_xfun_data(ori_gt_path, output_path)</span><br></pre></td></tr></table></figure>

原始格式：

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"lang"</span>: <span class="string">"zh"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.1"</span>,</span><br><span class="line">  <span class="attr">"split"</span>: <span class="string">"train"</span>,</span><br><span class="line">  <span class="attr">"documents"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"zh_train_0"</span>,</span><br><span class="line">      <span class="attr">"uid"</span>: <span class="string">"640a0301a1cb24331748b579405502b44d6791883b25ea0eafc8a68126ccdadd"</span>,</span><br><span class="line">      <span class="attr">"document"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"box"</span>: [</span><br><span class="line">            <span class="number">104</span>,</span><br><span class="line">            <span class="number">114</span>,</span><br><span class="line">            <span class="number">530</span>,</span><br><span class="line">            <span class="number">175</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"汇丰晋信"</span>,</span><br><span class="line">          <span class="attr">"label"</span>: <span class="string">"other"</span>,</span><br><span class="line">          <span class="attr">"words"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">110</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">152</span>,</span><br><span class="line">                <span class="number">175</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"汇"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">189</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">229</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"丰"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">385</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">426</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"晋"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">466</span>,</span><br><span class="line">                <span class="number">116</span>,</span><br><span class="line">                <span class="number">508</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"信"</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"linking"</span>: [],</span><br><span class="line">          <span class="attr">"id"</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">          ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">      ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

转换：

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zh_train_0.jpg	[&#123;"transcription": "汇丰晋信", "label": "other", "points": [[104, 114], [530, 114], [530, 175], [104, 175]], "id": 1, "linking": []&#125;, &#123;"transcription": "受理时间:", "label": "question", "points": [[126, 267], [266, 267], [266, 305], [126, 305]], "id": 7, "linking": [[7, 13]]&#125;, &#123;"transcription": "2020.6.15", "label": "answer", "points": [[321, 239], [537, 239], [537, 285], [321, 285]], "id": 13, "linking": [[7, 13]]&#125;...]</span><br><span class="line">zh_train_1.jpg	[...]</span><br></pre></td></tr></table></figure>

### 配置字典文件

用于存储各段文本的标签类别，这里使用</code>models/xfund_class_list.txt<code>字典文件

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OTHER</span><br><span class="line">QUESTION</span><br><span class="line">ANSWER</span><br><span class="line">HEADER</span><br></pre></td></tr></table></figure>

&lt;font color=&#39;red&#39;&gt;**注：**&lt;/font&gt; 字典中的标签和json文件中的标签不区分大小写

### 配置训练文件

#### SER模型训练文件

创建并修改SER模型训练yaml文件</code>demo/ser_vi_layoutxlm_xfund_zh.yml<code>，源文件路径：</code>configs/kie/vi_layoutxlm/ser_vi_layoutxlm_xfund_zh.yml<code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Global:</span></span><br><span class="line">  <span class="attr">use_gpu:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">epoch_num:</span> <span class="string">&amp;epoch_num</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">log_smooth_window:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">print_batch_step:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">save_model_dir:</span> <span class="string">./output/ser_vi_layoutxlm_xfund_zh</span></span><br><span class="line">  <span class="attr">save_epoch_step:</span> <span class="number">2000</span></span><br><span class="line">  <span class="comment"># evaluation is run every 10 iterations after the 0th iteration</span></span><br><span class="line">  <span class="attr">eval_batch_step:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">19</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">cal_metric_during_train:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">save_inference_dir:</span></span><br><span class="line">  <span class="attr">use_visualdl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">seed:</span> <span class="number">2022</span></span><br><span class="line">  <span class="attr">infer_img:</span> <span class="string">dataset/xfund_train/zh_train/zh_val_42.jpg</span></span><br><span class="line">  <span class="attr">d2s_train_image_shape:</span> <span class="string">[3,</span> <span class="number">224</span><span class="string">,</span> <span class="number">224</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># if you want to predict using the groundtruth ocr info,</span></span><br><span class="line">  <span class="comment"># you can use the following config</span></span><br><span class="line">  <span class="comment"># infer_img: train_data/XFUND/zh_val/val.json</span></span><br><span class="line">  <span class="comment"># infer_mode: False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">save_res_path:</span> <span class="string">./output/ser/xfund_zh/res</span></span><br><span class="line">  <span class="attr">kie_rec_model_dir:</span></span><br><span class="line">  <span class="attr">kie_det_model_dir:</span></span><br><span class="line">  <span class="attr">amp_custom_white_list:</span> <span class="string">['scale',</span> <span class="string">'concat'</span><span class="string">,</span> <span class="string">'elementwise_add'</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Architecture:</span></span><br><span class="line">  <span class="attr">model_type:</span> <span class="string">kie</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&amp;algorithm</span> <span class="string">"LayoutXLM"</span></span><br><span class="line">  <span class="attr">Transform:</span></span><br><span class="line">  <span class="attr">Backbone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LayoutXLMForSer</span></span><br><span class="line">    <span class="attr">pretrained:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">checkpoints:</span></span><br><span class="line">    <span class="comment"># one of base or vi</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">vi</span></span><br><span class="line">    <span class="attr">num_classes:</span> <span class="string">&amp;num_classes</span> <span class="number">7</span> <span class="comment"># &lt;--------------------------------------当标签数为n时，存在OTHER标签，取2n-1；不存在OTHER标签，取2n+1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Loss:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenLayoutLMLoss</span></span><br><span class="line">  <span class="attr">num_classes:</span> <span class="meta">*num_classes</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">"backbone_out"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizer:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">AdamW</span></span><br><span class="line">  <span class="attr">beta1:</span> <span class="number">0.9</span></span><br><span class="line">  <span class="attr">beta2:</span> <span class="number">0.999</span></span><br><span class="line">  <span class="attr">lr:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Linear</span></span><br><span class="line">    <span class="attr">learning_rate:</span> <span class="number">0.00005</span></span><br><span class="line">    <span class="attr">epochs:</span> <span class="meta">*epoch_num</span></span><br><span class="line">    <span class="attr">warmup_epoch:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">regularizer:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">L2</span></span><br><span class="line">    <span class="attr">factor:</span> <span class="number">0.00000</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">PostProcess:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenLayoutLMPostProcess</span></span><br><span class="line">  <span class="attr">class_path:</span> <span class="string">&amp;class_path</span> <span class="string">models/xfund_class_list.txt</span> <span class="comment"># &lt;--------------------------------------字典文件路径</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metric:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenMetric</span></span><br><span class="line">  <span class="attr">main_indicator:</span> <span class="string">hmean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Train:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_train</span> <span class="comment"># &lt;--------------------------------------训练集图像路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_train.json</span> <span class="comment"># &lt;--------------------------------------训练集json文件路径</span></span><br><span class="line">    <span class="attr">ratio_list:</span> <span class="string">[</span> <span class="number">1.0</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">False</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="string">&amp;use_textline_bbox_info</span> <span class="literal">True</span></span><br><span class="line">          <span class="comment"># one of [None, "tb-yx"]</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="string">&amp;order_method</span> <span class="string">"tb-yx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="string">&amp;max_seq_len</span> <span class="number">512</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQASerTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'image'</span><span class="string">,</span> <span class="string">'labels'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Eval:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_val</span> <span class="comment"># &lt;--------------------------------------验证集图片路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_val.json</span> <span class="comment"># &lt;--------------------------------------验证集json文件路径</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">False</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="meta">*use_textline_bbox_info</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="meta">*order_method</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQASerTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'image'</span><span class="string">,</span> <span class="string">'labels'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

#### RE模型训练文件

创建并修改RE模型训练yaml文件</code>demo/re_vi_layoutxlm_xfund_zh.yml<code>，源文件路径：</code>configs/kie/vi_layoutxlm/re_vi_layoutxlm_xfund_zh.yml<code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Global:</span></span><br><span class="line">  <span class="attr">use_gpu:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">epoch_num:</span> <span class="string">&amp;epoch_num</span> <span class="number">130</span></span><br><span class="line">  <span class="attr">log_smooth_window:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">print_batch_step:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">save_model_dir:</span> <span class="string">./output/re_vi_layoutxlm_xfund_zh</span></span><br><span class="line">  <span class="attr">save_epoch_step:</span> <span class="number">2000</span></span><br><span class="line">  <span class="comment"># evaluation is run every 10 iterations after the 0th iteration</span></span><br><span class="line">  <span class="attr">eval_batch_step:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">19</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">cal_metric_during_train:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">save_inference_dir:</span></span><br><span class="line">  <span class="attr">use_visualdl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">seed:</span> <span class="number">2022</span></span><br><span class="line">  <span class="attr">infer_img:</span> <span class="string">dataset/xfund_train/zh_train/zh_val_21.jpg</span></span><br><span class="line">  <span class="attr">save_res_path:</span> <span class="string">./output/re/xfund_zh/with_gt</span></span><br><span class="line">  <span class="attr">kie_rec_model_dir:</span> </span><br><span class="line">  <span class="attr">kie_det_model_dir:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Architecture:</span></span><br><span class="line">  <span class="attr">model_type:</span> <span class="string">kie</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&amp;algorithm</span> <span class="string">"LayoutXLM"</span></span><br><span class="line">  <span class="attr">Transform:</span></span><br><span class="line">  <span class="attr">Backbone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LayoutXLMForRe</span></span><br><span class="line">    <span class="attr">pretrained:</span> <span class="string">dataset/re_vi_layoutxlm_xfund_pretrained</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">vi</span></span><br><span class="line">    <span class="attr">checkpoints:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Loss:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">LossFromOutput</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">loss</span></span><br><span class="line">  <span class="attr">reduction:</span> <span class="string">mean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizer:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">AdamW</span></span><br><span class="line">  <span class="attr">beta1:</span> <span class="number">0.9</span></span><br><span class="line">  <span class="attr">beta2:</span> <span class="number">0.999</span></span><br><span class="line">  <span class="attr">clip_norm:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">lr:</span></span><br><span class="line">    <span class="attr">learning_rate:</span> <span class="number">0.00005</span></span><br><span class="line">    <span class="attr">warmup_epoch:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">regularizer:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">L2</span></span><br><span class="line">    <span class="attr">factor:</span> <span class="number">0.00000</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">PostProcess:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQAReTokenLayoutLMPostProcess</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metric:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQAReTokenMetric</span></span><br><span class="line">  <span class="attr">main_indicator:</span> <span class="string">hmean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Train:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_train</span> <span class="comment"># &lt;--------------------------------------训练集图片路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_train.json</span> <span class="comment"># &lt;--------------------------------------训练集json文件路径</span></span><br><span class="line">    <span class="attr">ratio_list:</span> <span class="string">[</span> <span class="number">1.0</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="string">&amp;class_path</span> <span class="string">models/xfund_class_list.txt</span> <span class="comment"># &lt;--------------------------------------字典文件路径</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="string">&amp;use_textline_bbox_info</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="string">&amp;order_method</span> <span class="string">"tb-yx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="string">&amp;max_seq_len</span> <span class="number">512</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenRelation:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">TensorizeEntitiesRelations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,'attention_mask',</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'entities'</span><span class="string">,</span> <span class="string">'relations'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Eval:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_val</span> <span class="comment"># &lt;--------------------------------------验证集图片路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_val.json</span> <span class="comment"># &lt;--------------------------------------验证集json文件路径</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="meta">*use_textline_bbox_info</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="meta">*order_method</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenRelation:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">TensorizeEntitiesRelations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'entities'</span><span class="string">,</span> <span class="string">'relations'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure>

### 开始训练

创建训练代码</code>demo/train.py<code>，训练源码位置：</code>paddleocr/tools/train.py<code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2020 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">".."</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"><span class="keyword">import</span> paddle.distributed <span class="keyword">as</span> dist</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.data <span class="keyword">import</span> build_dataloader, set_signal_handlers</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.modeling.architectures <span class="keyword">import</span> build_model</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.losses <span class="keyword">import</span> build_loss</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.optimizer <span class="keyword">import</span> build_optimizer</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.postprocess <span class="keyword">import</span> build_post_process</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.metrics <span class="keyword">import</span> build_metric</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.save_load <span class="keyword">import</span> load_model</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.utility <span class="keyword">import</span> set_seed</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.modeling.architectures <span class="keyword">import</span> apply_to_static</span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.program <span class="keyword">as</span> program</span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.naive_sync_bn <span class="keyword">as</span> naive_sync_bn</span><br><span class="line"></span><br><span class="line">dist.get_world_size()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(config, device, logger, vdl_writer, seed)</span>:</span></span><br><span class="line">    <span class="comment"># init dist environment</span></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Global"</span>][<span class="string">"distributed"</span>]:</span><br><span class="line">        dist.init_parallel_env()</span><br><span class="line"></span><br><span class="line">    global_config = config[<span class="string">"Global"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build dataloader</span></span><br><span class="line">    set_signal_handlers()</span><br><span class="line">    train_dataloader = build_dataloader(config, <span class="string">"Train"</span>, device, logger, seed)</span><br><span class="line">    <span class="keyword">if</span> len(train_dataloader) == <span class="number">0</span>:</span><br><span class="line">        logger.error(</span><br><span class="line">            <span class="string">"No Images in train dataset, please ensure\n"</span></span><br><span class="line">            + <span class="string">"\t1. The images num in the train label_file_list should be larger than or equal with batch size.\n"</span></span><br><span class="line">            + <span class="string">"\t2. The annotation file and path in the configuration file are provided normally."</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Eval"</span>]:</span><br><span class="line">        valid_dataloader = build_dataloader(config, <span class="string">"Eval"</span>, device, logger, seed)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        valid_dataloader = <span class="literal">None</span></span><br><span class="line">    step_pre_epoch = len(train_dataloader)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build post process</span></span><br><span class="line">    post_process_class = build_post_process(config[<span class="string">"PostProcess"</span>], global_config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build model</span></span><br><span class="line">    <span class="comment"># for rec algorithm</span></span><br><span class="line">    <span class="keyword">if</span> hasattr(post_process_class, <span class="string">"character"</span>):</span><br><span class="line">        char_num = len(getattr(post_process_class, <span class="string">"character"</span>))</span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"Architecture"</span>][<span class="string">"algorithm"</span>] <span class="keyword">in</span> [</span><br><span class="line">            <span class="string">"Distillation"</span>,</span><br><span class="line">        ]:  <span class="comment"># distillation model</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>]:</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][<span class="string">"name"</span>] == <span class="string">"MultiHead"</span></span><br><span class="line">                ):  <span class="comment"># for multi head</span></span><br><span class="line">                    <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"DistillationSARLabelDecode"</span>:</span><br><span class="line">                        char_num = char_num - <span class="number">2</span></span><br><span class="line">                    <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"DistillationNRTRLabelDecode"</span>:</span><br><span class="line">                        char_num = char_num - <span class="number">3</span></span><br><span class="line">                    out_channels_list = &#123;&#125;</span><br><span class="line">                    out_channels_list[<span class="string">"CTCLabelDecode"</span>] = char_num</span><br><span class="line">                    <span class="comment"># update SARLoss params</span></span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">-1</span>].keys())[<span class="number">0</span>]</span><br><span class="line">                        == <span class="string">"DistillationSARLoss"</span></span><br><span class="line">                    ):</span><br><span class="line">                        config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">-1</span>][<span class="string">"DistillationSARLoss"</span>][</span><br><span class="line">                            <span class="string">"ignore_index"</span></span><br><span class="line">                        ] = (char_num + <span class="number">1</span>)</span><br><span class="line">                        out_channels_list[<span class="string">"SARLabelDecode"</span>] = char_num + <span class="number">2</span></span><br><span class="line">                    <span class="keyword">elif</span> any(</span><br><span class="line">                        <span class="string">"DistillationNRTRLoss"</span> <span class="keyword">in</span> d</span><br><span class="line">                        <span class="keyword">for</span> d <span class="keyword">in</span> config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>]</span><br><span class="line">                    ):</span><br><span class="line">                        out_channels_list[<span class="string">"NRTRLabelDecode"</span>] = char_num + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][</span><br><span class="line">                        <span class="string">"out_channels_list"</span></span><br><span class="line">                    ] = out_channels_list</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][</span><br><span class="line">                        <span class="string">"out_channels"</span></span><br><span class="line">                    ] = char_num</span><br><span class="line">        <span class="keyword">elif</span> config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"name"</span>] == <span class="string">"MultiHead"</span>:  <span class="comment"># for multi head</span></span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"SARLabelDecode"</span>:</span><br><span class="line">                char_num = char_num - <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"NRTRLabelDecode"</span>:</span><br><span class="line">                char_num = char_num - <span class="number">3</span></span><br><span class="line">            out_channels_list = &#123;&#125;</span><br><span class="line">            out_channels_list[<span class="string">"CTCLabelDecode"</span>] = char_num</span><br><span class="line">            <span class="comment"># update SARLoss params</span></span><br><span class="line">            <span class="keyword">if</span> list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>].keys())[<span class="number">0</span>] == <span class="string">"SARLoss"</span>:</span><br><span class="line">                <span class="keyword">if</span> config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>] = &#123;</span><br><span class="line">                        <span class="string">"ignore_index"</span>: char_num + <span class="number">1</span></span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>][<span class="string">"ignore_index"</span>] = (</span><br><span class="line">                        char_num + <span class="number">1</span></span><br><span class="line">                    )</span><br><span class="line">                out_channels_list[<span class="string">"SARLabelDecode"</span>] = char_num + <span class="number">2</span></span><br><span class="line">            <span class="keyword">elif</span> list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>].keys())[<span class="number">0</span>] == <span class="string">"NRTRLoss"</span>:</span><br><span class="line">                out_channels_list[<span class="string">"NRTRLabelDecode"</span>] = char_num + <span class="number">3</span></span><br><span class="line">            config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"out_channels_list"</span>] = out_channels_list</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># base rec model</span></span><br><span class="line">            config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"out_channels"</span>] = char_num</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"SARLabelDecode"</span>:  <span class="comment"># for SAR model</span></span><br><span class="line">            config[<span class="string">"Loss"</span>][<span class="string">"ignore_index"</span>] = char_num - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    model = build_model(config[<span class="string">"Architecture"</span>])</span><br><span class="line"></span><br><span class="line">    use_sync_bn = config[<span class="string">"Global"</span>].get(<span class="string">"use_sync_bn"</span>, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> use_sync_bn:</span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"Global"</span>].get(<span class="string">"use_npu"</span>, <span class="literal">False</span>):</span><br><span class="line">            naive_sync_bn.convert_syncbn(model)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            model = paddle.nn.SyncBatchNorm.convert_sync_batchnorm(model)</span><br><span class="line">        logger.info(<span class="string">"convert_sync_batchnorm"</span>)</span><br><span class="line"></span><br><span class="line">    model = apply_to_static(model, config, logger)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build loss</span></span><br><span class="line">    loss_class = build_loss(config[<span class="string">"Loss"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build optim</span></span><br><span class="line">    optimizer, lr_scheduler = build_optimizer(</span><br><span class="line">        config[<span class="string">"Optimizer"</span>],</span><br><span class="line">        epochs=config[<span class="string">"Global"</span>][<span class="string">"epoch_num"</span>],</span><br><span class="line">        step_each_epoch=len(train_dataloader),</span><br><span class="line">        model=model,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build metric</span></span><br><span class="line">    eval_class = build_metric(config[<span class="string">"Metric"</span>])</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"train dataloader has &#123;&#125; iters"</span>.format(len(train_dataloader)))</span><br><span class="line">    <span class="keyword">if</span> valid_dataloader <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logger.info(<span class="string">"valid dataloader has &#123;&#125; iters"</span>.format(len(valid_dataloader)))</span><br><span class="line"></span><br><span class="line">    use_amp = config[<span class="string">"Global"</span>].get(<span class="string">"use_amp"</span>, <span class="literal">False</span>)</span><br><span class="line">    amp_level = config[<span class="string">"Global"</span>].get(<span class="string">"amp_level"</span>, <span class="string">"O2"</span>)</span><br><span class="line">    amp_dtype = config[<span class="string">"Global"</span>].get(<span class="string">"amp_dtype"</span>, <span class="string">"float16"</span>)</span><br><span class="line">    amp_custom_black_list = config[<span class="string">"Global"</span>].get(<span class="string">"amp_custom_black_list"</span>, [])</span><br><span class="line">    amp_custom_white_list = config[<span class="string">"Global"</span>].get(<span class="string">"amp_custom_white_list"</span>, [])</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(</span><br><span class="line">        os.path.join(config[<span class="string">"Global"</span>][<span class="string">"save_model_dir"</span>], <span class="string">"train_result.json"</span>)</span><br><span class="line">    ):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.remove(</span><br><span class="line">                os.path.join(config[<span class="string">"Global"</span>][<span class="string">"save_model_dir"</span>], <span class="string">"train_result.json"</span>)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> use_amp:</span><br><span class="line">        AMP_RELATED_FLAGS_SETTING = &#123;</span><br><span class="line">            <span class="string">"FLAGS_max_inplace_grad_add"</span>: <span class="number">8</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> paddle.is_compiled_with_cuda():</span><br><span class="line">            AMP_RELATED_FLAGS_SETTING.update(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"FLAGS_cudnn_batchnorm_spatial_persistent"</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">"FLAGS_gemm_use_half_precision_compute_type"</span>: <span class="number">0</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        paddle.set_flags(AMP_RELATED_FLAGS_SETTING)</span><br><span class="line">        scale_loss = config[<span class="string">"Global"</span>].get(<span class="string">"scale_loss"</span>, <span class="number">1.0</span>)</span><br><span class="line">        use_dynamic_loss_scaling = config[<span class="string">"Global"</span>].get(</span><br><span class="line">            <span class="string">"use_dynamic_loss_scaling"</span>, <span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        scaler = paddle.amp.GradScaler(</span><br><span class="line">            init_loss_scaling=scale_loss,</span><br><span class="line">            use_dynamic_loss_scaling=use_dynamic_loss_scaling,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> amp_level == <span class="string">"O2"</span>:</span><br><span class="line">            model, optimizer = paddle.amp.decorate(</span><br><span class="line">                models=model,</span><br><span class="line">                optimizers=optimizer,</span><br><span class="line">                level=amp_level,</span><br><span class="line">                master_weight=<span class="literal">True</span>,</span><br><span class="line">                dtype=amp_dtype,</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        scaler = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># load pretrain model</span></span><br><span class="line">    pre_best_model_dict = load_model(</span><br><span class="line">        config, model, optimizer, config[<span class="string">"Architecture"</span>][<span class="string">"model_type"</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Global"</span>][<span class="string">"distributed"</span>]:</span><br><span class="line">        model = paddle.DataParallel(model)</span><br><span class="line">    <span class="comment"># start train</span></span><br><span class="line">    program.train(</span><br><span class="line">        config,</span><br><span class="line">        train_dataloader,</span><br><span class="line">        valid_dataloader,</span><br><span class="line">        device,</span><br><span class="line">        model,</span><br><span class="line">        loss_class,</span><br><span class="line">        optimizer,</span><br><span class="line">        lr_scheduler,</span><br><span class="line">        post_process_class,</span><br><span class="line">        eval_class,</span><br><span class="line">        pre_best_model_dict,</span><br><span class="line">        logger,</span><br><span class="line">        step_pre_epoch,</span><br><span class="line">        vdl_writer,</span><br><span class="line">        scaler,</span><br><span class="line">        amp_level,</span><br><span class="line">        amp_custom_black_list,</span><br><span class="line">        amp_custom_white_list,</span><br><span class="line">        amp_dtype,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_reader</span><span class="params">(config, device, logger)</span>:</span></span><br><span class="line">    loader = build_dataloader(config, <span class="string">"Train"</span>, device, logger)</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    starttime = time.time()</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> loader():</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count % <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">                batch_time = time.time() - starttime</span><br><span class="line">                starttime = time.time()</span><br><span class="line">                logger.info(</span><br><span class="line">                    <span class="string">"reader: &#123;&#125;, &#123;&#125;, &#123;&#125;"</span>.format(count, len(data[<span class="number">0</span>]), batch_time)</span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.info(e)</span><br><span class="line">    logger.info(<span class="string">"finish reader: &#123;&#125;, Success!"</span>.format(count))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    config, device, logger, vdl_writer = program.preprocess(is_train=<span class="literal">True</span>)</span><br><span class="line">    seed = config[<span class="string">"Global"</span>][<span class="string">"seed"</span>] <span class="keyword">if</span> <span class="string">"seed"</span> <span class="keyword">in</span> config[<span class="string">"Global"</span>] <span class="keyword">else</span> <span class="number">1024</span></span><br><span class="line">    set_seed(seed)</span><br><span class="line">    main(config, device, logger, vdl_writer, seed)</span><br><span class="line">    <span class="comment"># test_reader(config, device, logger)</span></span><br></pre></td></tr></table></figure>

根据训练目标的配置文件，分发显卡和训练任务：

&lt;font color=&#39;gold&#39;&gt;**SER**&lt;/font&gt;:</code>CUDA_VISIBLE_DEVICES=0 python train.py -c ser_vi_layoutxlm_xfund_zh.yml<code>&lt;font color=&#39;gold&#39;&gt;**RE**&lt;/font&gt;:</code>CUDA_VISIBLE_DEVICES=1 python train.py -c re_vi_layoutxlm_xfund_zh.yml<code>首次启动将自动下载预训练模型。日志输出样例如下：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2024/11/26 17:35:39] ppocr INFO: epoch: [1/200], global_step: 10, lr: 0.000006, loss: 1.838789, avg_reader_cost: 0.39165 s, avg_batch_cost: 0.54732 s, avg_samples: 8.0, ips: 14.61671 samples/s, eta: 0:34:34, max_mem_reserved: 11694 MB, max_mem_allocated: 10523 MB</span><br><span class="line">[2024/11/26 17:35:43] ppocr INFO: epoch: [1/200], global_step: 19, lr: 0.000018, loss: 1.446505, avg_reader_cost: 0.22235 s, avg_batch_cost: 0.32516 s, avg_samples: 6.9, ips: 21.22014 samples/s, eta: 0:28:56, max_mem_reserved: 11694 MB, max_mem_allocated: 10523 MB</span><br><span class="line">eval model:: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:04&lt;00:00,  1.61it/s]</span><br><span class="line">[2024/11/26 17:35:47] ppocr INFO: cur metric, precision: 0.05993363749481543, recall: 0.10410662824207492, hmean: 0.07607265069755198, fps: 101.1334614167882</span><br><span class="line">[2024/11/26 17:36:22] ppocr INFO: save best model is to ./output/ser_vi_layoutxlm_xfund_zh/best_accuracy</span><br><span class="line">[2024/11/26 17:36:22] ppocr INFO: best metric, hmean: 0.07607265069755198, precision: 0.05993363749481543, recall: 0.10410662824207492, fps: 101.1334614167882, best_epoch: 1</span><br><span class="line">[2024/11/26 17:36:39] ppocr INFO: save model in ./output/ser_vi_layoutxlm_xfund_zh/latest</span><br></pre></td></tr></table></figure>

### 模型导出

训练结束后，进入最佳模型目录</code>demo/output/re_vi_layoutxlm_xfund_zh/best_accuracy<code>，此时模型不具备</code>.pdmodel<code>文件，不能直接用于预测，需要导出为inference模型（本文适当略过模型评估步骤）

![](关键信息提取（KIE）\3.png)

创建模型导出代码</code>demo/export_model.py<code>，导出源码位置：</code>paddleocr/tools/export_model.py<code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2020 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">".."</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.program <span class="keyword">import</span> load_config, merge_config, ArgsParser</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.export_model <span class="keyword">import</span> export</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    FLAGS = ArgsParser().parse_args()</span><br><span class="line">    config = load_config(FLAGS.config)</span><br><span class="line">    config = merge_config(config, FLAGS.opt)</span><br><span class="line">    <span class="comment"># export model</span></span><br><span class="line">    export(config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

导出命令：

&lt;font color=&#39;gold&#39;&gt;**SER**&lt;/font&gt;:

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python export_model.py -c ser_vi_layoutxlm_xfund_zh.yml -o Architecture.Backbone.checkpoints=./output/ser_vi_layoutxlm_xfund_z</span><br><span class="line">h/best_accuracy Global.save_inference_dir=./inference/ser_vi_layoutxlm Global.save_inference_dir=./inference/ser_vi_layoutxlm</span><br></pre></td></tr></table></figure>

&lt;font color=&#39;gold&#39;&gt;**RE**&lt;/font&gt;:

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python export_model.py -c re_vi_layoutxlm_xfund_zh.yml -o Architecture.Backbone.checkpoints=./output/re_vi_layoutxlm_xfund_z</span><br><span class="line">h/best_accuracy Global.save_inference_dir=./inference/re_vi_layoutxlm Global.save_inference_dir=./inference/re_vi_layoutxlm</span><br></pre></td></tr></table></figure>

将在</code>demo/inference目录下生成导出的推理模型<code>，可修改args参数中模型路径进行验证。

## 客制化

### 标注工具：PPOCRLabel

操作系统回到windows，并创建</code>demo/dataset/temp<code>文件夹存放训练图像

安装：</code>pip install PPOCRLabel==2.1.3 -i <a href="https://pypi.tuna.tsinghua.edu.cn/simple`" target="_blank" rel="noopener">https://pypi.tuna.tsinghua.edu.cn/simple`</a><br><br>启动：<code>PPOCRLabel --lang ch --kie True</code><br><br>此时标注工具左下角显示关键词列表项<br><br><img src="/2024/11/26/关键信息提取（KIE）/4.png" alt><br><br><font color="red"><strong>注：</strong></font> 最新版可能存在bug，建议使用2.1.3版本。<strong>且截至目前（24.11月 v2.1.12版本），工具仍不具备RE任务关系标注功能，需制作后处理脚本</strong> <font color="red"><strong>*难点</strong></font>

<h3 id="后处理："><a href="#后处理：" class="headerlink" title="后处理："></a>后处理：</h3><font color="gold"><strong>SER</strong></font>

<p>创建SER任务处理代码<code>demo/trans+ppocrlabel.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dataset/temp/Label.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> l:</span><br><span class="line">    content = l.readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> content:</span><br><span class="line">        image = line.split(<span class="string">'\t'</span>)[<span class="number">0</span>]</span><br><span class="line">        label = json.loads(line.split(<span class="string">'\t'</span>)[<span class="number">1</span>])</span><br><span class="line">        label_set = []</span><br><span class="line">        <span class="keyword">for</span> i, lab <span class="keyword">in</span> enumerate(label):</span><br><span class="line">            new_lab = &#123;</span><br><span class="line">                <span class="string">'transcription'</span>: lab.get(<span class="string">'transcription'</span>),</span><br><span class="line">                <span class="string">'points'</span>: lab.get(<span class="string">'points'</span>),</span><br><span class="line">                <span class="string">'label'</span>: lab.get(<span class="string">'key_cls'</span>),</span><br><span class="line">                <span class="string">'id'</span>: i,</span><br><span class="line">                <span class="string">'linking'</span>: []</span><br><span class="line">            &#125;</span><br><span class="line">            label_set.append(new_lab)</span><br><span class="line">            label_set_json = json.dumps(label_set, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'./dataset/project/train.json'</span>, <span class="string">'a+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(image)</span><br><span class="line">            f.write(<span class="string">'\t'</span>)</span><br><span class="line">            f.write(label_set_json)</span><br><span class="line">            f.write(<span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>
<font color="gold"><strong>RE</strong></font>

<p>测试中，未完待续</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KIE/">KIE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OCR/">OCR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paddle/">paddle</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-间隙树排序算法的可视化"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/08/06/间隙树排序算法的可视化/">间隙树排序算法的可视化</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/08/06/间隙树排序算法的可视化/" class="article-date">
	  <time datetime="2024-08-06T07:10:43.000Z" itemprop="datePublished">2024-08-06</time>
	</a>

      
    <a class="article-category-link" href="/categories/算法/">算法</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>做文档翻译的OCR程序时，会遇到这样一个场景，因为通常OCR模型的输出都是按文本块逐行返回，当结果进入翻译模型时会丢失行与行之间的信息。为了解决这个问题，需要对OCR结果进行进一步的版面分析，将文本块合并成段落，再输入到翻译模型中去。</p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>间隙·树·排序算法</p>
<p>参考链接：<a href="https://github.com/hiroi-sora/GapTree_Sort_Algorithm" target="_blank" rel="noopener">https://github.com/hiroi-sora/GapTree_Sort_Algorithm</a></p>
<p><img src="/2024/08/06/间隙树排序算法的可视化/1.png" alt></p>
<p>算法主要对文本块按间隙进行划分，再经过树形排序，将底层OCR的输出结果从子文本块转化成段落文本块。</p>
<h3 id="算法重构"><a href="#算法重构" class="headerlink" title="算法重构"></a>算法重构</h3><p>为了使文本块的定位更加准确，使用原算法输出段落块（content_blocks）的上下左右四个边界点构成新段落块（new_blocks）</p>
<p>源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">structure_ocr</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> line, tb <span class="keyword">in</span> enumerate(self.blocks_data):</span><br><span class="line">        tb[<span class="string">"bbox"</span>] = self.bboxes[line]</span><br><span class="line"></span><br><span class="line">    gtree = GapTree(<span class="keyword">lambda</span> tb: tb[<span class="string">"bbox"</span>])</span><br><span class="line">    sorted_text_blocks = gtree.sort(self.blocks_data)  <span class="comment"># 文本块排序</span></span><br><span class="line">    <span class="comment"># print(sorted_text_blocks)</span></span><br><span class="line">    pp = ParagraphParse(self.get_info, self.set_end)</span><br><span class="line">    <span class="comment"># 获取所有区块的文本块</span></span><br><span class="line">    nodes_text_blocks = gtree.get_nodes_text_blocks()</span><br><span class="line">    content_blocks = []</span><br><span class="line">    <span class="keyword">for</span> tbs <span class="keyword">in</span> nodes_text_blocks:</span><br><span class="line">        content = <span class="string">""</span></span><br><span class="line">        tbs = pp.run(tbs)  <span class="comment"># 预测结尾分隔符</span></span><br><span class="line">        <span class="keyword">for</span> tb <span class="keyword">in</span> tbs:  <span class="comment"># 输出文本和结尾分隔符</span></span><br><span class="line">            content += tb[<span class="string">"text"</span>] + tb[<span class="string">"end"</span>]</span><br><span class="line">        content_blocks.append(content)</span><br><span class="line"></span><br><span class="line">    node_tbs = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> gtree.current_nodes:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> node[<span class="string">"units"</span>]:</span><br><span class="line">           <span class="keyword">continue</span>  <span class="comment"># 跳过没有块的根节点</span></span><br><span class="line">        x0 = node[<span class="string">"x_left"</span>]</span><br><span class="line">        x1 = node[<span class="string">"x_right"</span>]</span><br><span class="line">        y0 = gtree.current_rows[node[<span class="string">"r_top"</span>]][<span class="number">0</span>][<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        y1 = gtree.current_rows[node[<span class="string">"r_bottom"</span>]][<span class="number">0</span>][<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line">        node_tbs.append([[x0, y0], [x1, y0], [x1, y1], [x0, y1]])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node_tbs, content_blocks</span><br></pre></td></tr></table></figure>
        <!--  做文档翻译的OCR程序时，会遇到这样一个场景，因为通常OCR模型的输出都是按文本块逐行返回，当结果进入翻译模型时会丢失行与行之间的信息。为了解决这个问题，需要对OCR结果进行进一步的版面分析，将文本块合并成段落，再输入到翻译模型中去。
算法间隙·树·排序算法
参考链接：https://github.com/hiroi-sora/GapTree_Sort_Algorithm

算法主要对文本......  -->
        <p class="article-more-link">
          <a href="/2024/08/06/间隙树排序算法的可视化/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OCR/">OCR</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Surya-OCR"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/07/08/Surya-OCR/">Surya OCR</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/07/08/Surya-OCR/" class="article-date">
	  <time datetime="2024-07-08T09:26:27.000Z" itemprop="datePublished">2024-07-08</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="版本："><a href="#版本：" class="headerlink" title="版本："></a>版本：</h3><p>python3.9 + surya-ocr 0.4.15</p>
<h3 id="模型准备："><a href="#模型准备：" class="headerlink" title="模型准备："></a>模型准备：</h3><p>检测模型：surya_det3</p>
<p>识别模型：surya_rec</p>
<p>版面模型：surya_layout3</p>
<h3 id="源码修改"><a href="#源码修改" class="headerlink" title="源码修改"></a>源码修改</h3><p>因首次使用下载模型被墙，提前将模型收录至模型文件夹并修改源码导入部分：</p>
<p>(源码位置：<code>...Python39/Lib/site-packages/surya/settings.py</code>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Dict, Optional</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> find_dotenv</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> computed_field</span><br><span class="line"><span class="keyword">from</span> pydantic_settings <span class="keyword">import</span> BaseSettings</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span><span class="params">(BaseSettings)</span>:</span></span><br><span class="line">    <span class="comment"># General</span></span><br><span class="line">    TORCH_DEVICE: Optional[str] = <span class="literal">None</span></span><br><span class="line">    IMAGE_DPI: int = <span class="number">96</span></span><br><span class="line">    IN_STREAMLIT: bool = <span class="literal">False</span> <span class="comment"># Whether we're running in streamlit</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Paths</span></span><br><span class="line">    DATA_DIR: str = <span class="string">"data"</span></span><br><span class="line">    RESULT_DIR: str = <span class="string">"results"</span></span><br><span class="line">    BASE_DIR: str = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">    FONT_DIR: str = os.path.join(BASE_DIR, <span class="string">"static"</span>, <span class="string">"fonts"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @computed_field</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">TORCH_DEVICE_MODEL</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">if</span> self.TORCH_DEVICE <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self.TORCH_DEVICE</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"cuda"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torch.backends.mps.is_available():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"mps"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"cpu"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Text detection</span></span><br><span class="line">    DETECTOR_BATCH_SIZE: Optional[int] = <span class="literal">None</span> <span class="comment"># Defaults to 2 for CPU/MPS, 32 otherwise</span></span><br><span class="line">    DETECTOR_MODEL_CHECKPOINT: str = <span class="string">r"D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_det3"</span></span><br><span class="line">    DETECTOR_BENCH_DATASET_NAME: str = <span class="string">"vikp/doclaynet_bench"</span></span><br><span class="line">    DETECTOR_IMAGE_CHUNK_HEIGHT: int = <span class="number">1400</span> <span class="comment"># Height at which to slice images vertically</span></span><br><span class="line">    DETECTOR_TEXT_THRESHOLD: float = <span class="number">0.6</span> <span class="comment"># Threshold for text detection (above this is considered text)</span></span><br><span class="line">    DETECTOR_BLANK_THRESHOLD: float = <span class="number">0.35</span> <span class="comment"># Threshold for blank space (below this is considered blank)</span></span><br><span class="line">    DETECTOR_POSTPROCESSING_CPU_WORKERS: int = min(<span class="number">8</span>, os.cpu_count()) <span class="comment"># Number of workers for postprocessing</span></span><br><span class="line">    DETECTOR_MIN_PARALLEL_THRESH: int = <span class="number">3</span> <span class="comment"># Minimum number of images before we parallelize</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Text recognition</span></span><br><span class="line">    RECOGNITION_MODEL_CHECKPOINT: str = <span class="string">r"D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_rec"</span></span><br><span class="line">    RECOGNITION_MAX_TOKENS: int = <span class="number">175</span></span><br><span class="line">    RECOGNITION_BATCH_SIZE: Optional[int] = <span class="literal">None</span> <span class="comment"># Defaults to 8 for CPU/MPS, 256 otherwise</span></span><br><span class="line">    RECOGNITION_IMAGE_SIZE: Dict = &#123;<span class="string">"height"</span>: <span class="number">196</span>, <span class="string">"width"</span>: <span class="number">896</span>&#125;</span><br><span class="line">    RECOGNITION_RENDER_FONTS: Dict[str, str] = &#123;</span><br><span class="line">        <span class="string">"all"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCurrent-Regular.ttf"</span>),</span><br><span class="line">        <span class="string">"zh"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCJKCore.ttf"</span>),</span><br><span class="line">        <span class="string">"ja"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCJKCore.ttf"</span>),</span><br><span class="line">        <span class="string">"ko"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCJKCore.ttf"</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    RECOGNITION_FONT_DL_BASE: str = <span class="string">"https://github.com/satbyy/go-noto-universal/releases/download/v7.0"</span></span><br><span class="line">    RECOGNITION_BENCH_DATASET_NAME: str = <span class="string">"vikp/rec_bench"</span></span><br><span class="line">    RECOGNITION_PAD_VALUE: int = <span class="number">255</span> <span class="comment"># Should be 0 or 255</span></span><br><span class="line">    RECOGNITION_STATIC_CACHE: bool = <span class="literal">False</span> <span class="comment"># Static cache for torch compile</span></span><br><span class="line">    RECOGNITION_MAX_LANGS: int = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Layout</span></span><br><span class="line">    LAYOUT_MODEL_CHECKPOINT: str = <span class="string">r"D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_layout3"</span></span><br><span class="line">    LAYOUT_BENCH_DATASET_NAME: str = <span class="string">"vikp/publaynet_bench"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ordering</span></span><br><span class="line">    ORDER_MODEL_CHECKPOINT: str = <span class="string">"vikp/surya_order"</span></span><br><span class="line">    ORDER_IMAGE_SIZE: Dict = &#123;<span class="string">"height"</span>: <span class="number">1024</span>, <span class="string">"width"</span>: <span class="number">1024</span>&#125;</span><br><span class="line">    ORDER_MAX_BOXES: int = <span class="number">256</span></span><br><span class="line">    ORDER_BATCH_SIZE: Optional[int] = <span class="literal">None</span>  <span class="comment"># Defaults to 4 for CPU/MPS, 32 otherwise</span></span><br><span class="line">    ORDER_BENCH_DATASET_NAME: str = <span class="string">"vikp/order_bench"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Tesseract (for benchmarks only)</span></span><br><span class="line">    TESSDATA_PREFIX: Optional[str] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @computed_field</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">MODEL_DTYPE</span><span class="params">(self)</span> -&gt; torch.dtype:</span></span><br><span class="line">        <span class="keyword">return</span> torch.float32 <span class="keyword">if</span> self.TORCH_DEVICE_MODEL == <span class="string">"cpu"</span> <span class="keyword">else</span> torch.float16</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">        env_file = find_dotenv(<span class="string">"local.env"</span>)</span><br><span class="line">        extra = <span class="string">"ignore"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">settings = Settings()</span><br></pre></td></tr></table></figure>
        <!--  环境准备版本：python3.9 + surya-ocr 0.4.15
模型准备：检测模型：surya_det3
识别模型：surya_rec
版面模型：surya_layout3
源码修改因首次使用下载模型被墙，提前将模型收录至模型文件夹并修改源码导入部分：
(源码位置：...Python39/Lib/site-packages/surya/settings.py)
1234567891......  -->
        <p class="article-more-link">
          <a href="/2024/07/08/Surya-OCR/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OCR/">OCR</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-doccano"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/06/28/doccano/">doccano</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/06/28/doccano/" class="article-date">
	  <time datetime="2024-06-28T02:42:26.000Z" itemprop="datePublished">2024-06-28</time>
	</a>

      
    <a class="article-category-link" href="/categories/深度学习/">深度学习</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Doccano是一种用于文本标注的开源工具，旨在简化和加速标注任务的进行。它提供了一个直观的用户界面，使标注人员能够轻松地对文本数据进行标注，并创建高质量的训练数据集用于机器学习和自然语言处理任务。</p>
<p><img src="/2024/06/28/doccano/1.png" alt></p>
<p>链接：<a href="https://github.com/doccano/doccano" target="_blank" rel="noopener">https://github.com/doccano/doccano</a></p>
<h2 id="一、安装部署"><a href="#一、安装部署" class="headerlink" title="一、安装部署"></a>一、安装部署</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p><font color="gold">操作系统</font>：Centos7.9</p>
<p><font color="gold">python</font>：3.10</p>
<p><font color="gold">doccano</font>：1.6.2</p>
<h3 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装"></a>pip安装</h3><p><font color="gold">注</font>：百度源没有相应安装包</p>
<p><code>pip install doccano==1.6.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>doccano init</code></p>
<h3 id="设置超级管理员账号密码"><a href="#设置超级管理员账号密码" class="headerlink" title="设置超级管理员账号密码"></a>设置超级管理员账号密码</h3><p><code>doccano createuser --username admin --password 123456</code></p>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p><code>doccano webserver --port 8000</code></p>
<p><img src="/2024/06/28/doccano/2.png" alt></p>
<p><img src="/2024/06/28/doccano/3.png" alt></p>
        <!--  Doccano是一种用于文本标注的开源工具，旨在简化和加速标注任务的进行。它提供了一个直观的用户界面，使标注人员能够轻松地对文本数据进行标注，并创建高质量的训练数据集用于机器学习和自然语言处理任务。

链接：https://github.com/doccano/doccano
一、安装部署环境操作系统：Centos7.9
python：3.10
doccano：1.6.2
pip安装注：百......  -->
        <p class="article-more-link">
          <a href="/2024/06/28/doccano/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ERNIE-UIE/">ERNIE-UIE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/doccano/">doccano</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paddle/">paddle</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-yolov8-seg：皮带机偏移实时检测"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/05/11/yolov8-seg：皮带机偏移实时检测/">yolov8-seg：皮带机偏移实时检测</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/05/11/yolov8-seg：皮带机偏移实时检测/" class="article-date">
	  <time datetime="2024-05-11T01:58:37.000Z" itemprop="datePublished">2024-05-11</time>
	</a>

      
    <a class="article-category-link" href="/categories/实例分割/">实例分割</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境-amp-安装"><a href="#环境-amp-安装" class="headerlink" title="环境&amp;安装"></a>环境&amp;安装</h2><p>同上文yolov8：火灾检测</p>
<p>模型使用<code>yolov8n-seg</code></p>
<h2 id="数据标注"><a href="#数据标注" class="headerlink" title="数据标注"></a>数据标注</h2><h3 id="标注工具：labelme"><a href="#标注工具：labelme" class="headerlink" title="标注工具：labelme"></a>标注工具：labelme</h3><p>对分割目标进行多边矩形标注</p>
<p><img src="/2024/05/11/yolov8-seg：皮带机偏移实时检测/1.png" alt></p>
<p><img src="/2024/05/11/yolov8-seg：皮带机偏移实时检测/2.png" alt></p>
        <!--  环境&amp;安装同上文yolov8：火灾检测
模型使用yolov8n-seg
数据标注标注工具：labelme对分割目标进行多边矩形标注



数据格式转换将labelme多边矩形数据格式转为yolo-seg数据格式，通用转换代码：
123456789101112131415161718192021222324252627282930313233343536373839404142434......  -->
        <p class="article-more-link">
          <a href="/2024/05/11/yolov8-seg：皮带机偏移实时检测/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/opencv/">opencv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yolov8/">yolov8</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Bert-GRU地址归一算法"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/04/05/Bert-GRU地址归一算法/">Bert+GRU地址归一算法</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/04/05/Bert-GRU地址归一算法/" class="article-date">
	  <time datetime="2024-04-05T08:23:15.000Z" itemprop="datePublished">2024-04-05</time>
	</a>

      
    <a class="article-category-link" href="/categories/地址归一/">地址归一</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、-算法简介"><a href="#一、-算法简介" class="headerlink" title="一、 算法简介"></a>一、 算法简介</h2><p>本地址归一算法（已经下简称算法）旨在对输入文本中出现的地址信息或一般地址信息做地址结构化抽取，并输出该地址映射到数据库中的标准化地址。</p>
<h2 id="二、算法模块"><a href="#二、算法模块" class="headerlink" title="二、算法模块"></a>二、算法模块</h2><p>算法由以下不同模块共同组成，各模块在算法的各个生命周期起到重要作用：</p>
<h3 id="1、建立原始地址库"><a href="#1、建立原始地址库" class="headerlink" title="1、建立原始地址库"></a>1、建立原始地址库</h3><p>使用postgres数据库（以下简pg）创建存储全国各级原始地址的原始地址库。通过网络爬虫不断采集和更新地址数据（主要来源为高德地图），并存储到原始地址库，地址库包括地址的名称信息、poi信息、类别信息、经纬度信息等原始内容，为后续工作的开展做数据支撑。</p>
<h3 id="2、文本地址抽取"><a href="#2、文本地址抽取" class="headerlink" title="2、文本地址抽取"></a>2、文本地址抽取</h3><p>使用UIE(Universal Information Extraction)框架，结合ERNIE3.0模型，使模型具备从无结构或半结构的文本中抽取地址信息的能力。</p>
<h3 id="3、地址分级算法"><a href="#3、地址分级算法" class="headerlink" title="3、地址分级算法"></a>3、地址分级算法</h3><h4 id="i-分级标准"><a href="#i-分级标准" class="headerlink" title="i)分级标准"></a>i)分级标准</h4><p>首先需要确定一套地址的分级标准细节，本算法采用的分级标准基于阿里《文地址要素解析标注规范》，并做一定程度范围的修改，将地址分为18个不同级别：</p>
<p>① Prov：省级行政区划，省、自治区、直辖市</p>
<p>② City：地级行政区划，地级市、地区、自治州等</p>
<p>③ District：县级行政区划，市辖区、县级市、县等</p>
<p>④ Devzone：广义的上的开发区，包含一般性产业 园区、度假区</p>
<p>⑤ Town：乡级行政区划，镇、街道、乡等</p>
<p>⑥ Community：包含社区、行政村（生产大队、村委会），自然村</p>
<p>⑦ Village Group：限定 xx 组、xx 队、xx 社</p>
<p>⑧ Road：有正式名称的道路，包括隧道、高架、街、弄、巷等。 步行街、商业街</p>
<p>⑨ Roadno：路牌号</p>
<p>⑩ Poi：目标兴趣点</p>
<p>⑪ Subpoi：目标兴趣点的子兴趣点</p>
<p>⑫ Houseno：楼栋号，农村地址的门牌号(包括类似南楼、北楼一类的描述)</p>
<p>⑬ Cellno：单元号，包括甲乙丙丁等</p>
<p>⑭ Floorno：楼层号</p>
<p>⑮ Roomno：房间号</p>
<p>⑯ Assist：定位词，包括方位、解释性名词</p>
<p>⑰ Intersection：路桥交叉口、交汇处、十字路口等</p>
<p>⑱ Distance：距离</p>
<h4 id="ii-算法细节"><a href="#ii-算法细节" class="headerlink" title="ii)算法细节"></a>ii)算法细节</h4><p>从爬虫获取的原始地址库构建地址结构化数据集，并对数据集划分为训练集和验证集进行数据标注。标注方式采用B-I-E-O-S五位序列标注法，该标注法将尽可能的保留被标注地址的分级信息。</p>
<p>构建地址分级模型。使用基于多头注意力机制Transformers架构的BERT大模型作为预训练模型，并将模型结合CRF、GRU算法。CRF：全称为条件随机场（Conditional Random Fields），结合了最大熵模型和隐马尔可夫模型的特点，是一种无向图模型。它在序列标注任务如分词、词性标注和命名实体识别等方面取得了很好的效果；GRU：全称为门控循环单元（Gated Recurrent Unit），是一种常用于序列数据建模的神经网络模型，能够很好解决BERT循环神经网络中的长期依赖问题，捕获序列中的长期特征，避免训练过程中的梯度消失和梯度爆炸，使完成的模型结构具有更优秀的泛化能力、更好地拟合真实地址数据。</p>
<p><img src="/2024/04/05/Bert-GRU地址归一算法/A.png" alt></p>
        <!--  一、 算法简介本地址归一算法（已经下简称算法）旨在对输入文本中出现的地址信息或一般地址信息做地址结构化抽取，并输出该地址映射到数据库中的标准化地址。
二、算法模块算法由以下不同模块共同组成，各模块在算法的各个生命周期起到重要作用：
1、建立原始地址库使用postgres数据库（以下简pg）创建存储全国各级原始地址的原始地址库。通过网络爬虫不断采集和更新地址数据（主要来源为高德地图），并存储......  -->
        <p class="article-more-link">
          <a href="/2024/04/05/Bert-GRU地址归一算法/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BERT/">BERT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GRU/">GRU</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-RTSP推拉流服务搭建"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/03/07/RTSP推拉流服务搭建/">RTSP推拉流服务搭建</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/03/07/RTSP推拉流服务搭建/" class="article-date">
	  <time datetime="2024-03-07T02:02:13.000Z" itemprop="datePublished">2024-03-07</time>
	</a>

      
    <a class="article-category-link" href="/categories/流媒体/">流媒体</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、基础服务搭建（windows）"><a href="#一、基础服务搭建（windows）" class="headerlink" title="一、基础服务搭建（windows）"></a>一、基础服务搭建（windows）</h2><h3 id="1-下载RTSP服务器"><a href="#1-下载RTSP服务器" class="headerlink" title="1.下载RTSP服务器"></a>1.下载RTSP服务器</h3><p>下载链接：<a href="https://github.com/aler9/rtsp-simple-server/releases" target="_blank" rel="noopener">https://github.com/aler9/rtsp-simple-server/releases</a></p>
<p><img src="/2024/03/07/RTSP推拉流服务搭建/1.png" alt></p>
<h3 id="2-下载FFmpeg工具"><a href="#2-下载FFmpeg工具" class="headerlink" title="2.下载FFmpeg工具"></a>2.下载FFmpeg工具</h3><p>下载链接：<a href="https://github.com/BtbN/FFmpeg-Builds/releases" target="_blank" rel="noopener">https://github.com/BtbN/FFmpeg-Builds/releases</a></p>
<p><img src="/2024/03/07/RTSP推拉流服务搭建/2.png" alt></p>
<h3 id="3-启动服务器"><a href="#3-启动服务器" class="headerlink" title="3.启动服务器"></a>3.启动服务器</h3><p>进入RTSP服务器路径，控制台执行<code>.\mediamtx.exe</code></p>
<p><img src="/2024/03/07/RTSP推拉流服务搭建/3.png" alt></p>
        <!--  一、基础服务搭建（windows）1.下载RTSP服务器下载链接：https://github.com/aler9/rtsp-simple-server/releases

2.下载FFmpeg工具下载链接：https://github.com/BtbN/FFmpeg-Builds/releases

3.启动服务器进入RTSP服务器路径，控制台执行.\mediamtx.exe


4.启......  -->
        <p class="article-more-link">
          <a href="/2024/03/07/RTSP推拉流服务搭建/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RTSP/">RTSP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yolov8/">yolov8</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-yolov8-pose"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/01/30/yolov8-pose/">yolov8-pose：关键点姿态检测</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/01/30/yolov8-pose/" class="article-date">
	  <time datetime="2024-01-30T04:00:00.000Z" itemprop="datePublished">2024-01-30</time>
	</a>

      
    <a class="article-category-link" href="/categories/关键点检测/">关键点检测</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境-amp-安装"><a href="#环境-amp-安装" class="headerlink" title="环境&amp;安装"></a>环境&amp;安装</h2><p>同上文yolov8：火灾检测</p>
<p>模型使用<code>yolov8n-pose</code></p>
<h2 id="数据标注"><a href="#数据标注" class="headerlink" title="数据标注"></a>数据标注</h2><h3 id="标注工具：labelme"><a href="#标注工具：labelme" class="headerlink" title="标注工具：labelme"></a>标注工具：labelme</h3><p>对图像中的目标（人物）及其关键点进行标记，包括1个目标类别和17个关键点类别</p>
<p><img src="/2024/01/30/yolov8-pose/A.png" alt></p>
<h3 id="数据格式转换"><a href="#数据格式转换" class="headerlink" title="数据格式转换"></a>数据格式转换</h3><p>将labelme数据格式转为yolo格式，通用转换代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment"># 参考yolov8-火灾检测，未完待续</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="创建训练yaml文件"><a href="#创建训练yaml文件" class="headerlink" title="创建训练yaml文件"></a>创建训练yaml文件</h3><p>参考<code>yolov8n-pose.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span> <span class="string">/exp/work/video/yolov8/datasets/human-pose/images/train</span> <span class="comment">#训练集文件夹</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">/exp/work/video/yolov8/datasets/human-pose/images/val</span> <span class="comment"># 验证集文件夹</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">/exp/work/video/yolov8/datasets/human-pose/images/val</span> <span class="comment"># 测试集文件夹</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">1</span> <span class="comment"># 分类数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关键点，每个关键点有 X Y 是否可见 三个参数</span></span><br><span class="line"><span class="comment"># 可见性：2-可见不遮挡 1-遮挡 0-没有点</span></span><br><span class="line"><span class="attr">kpt_shape:</span> <span class="string">[17,</span> <span class="number">3</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 框的类别（对于关键点检测，只有一类）</span></span><br><span class="line"><span class="attr">names:</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">people</span></span><br></pre></td></tr></table></figure>
        <!--  环境&amp;安装同上文yolov8：火灾检测
模型使用yolov8n-pose
数据标注标注工具：labelme对图像中的目标（人物）及其关键点进行标记，包括1个目标类别和17个关键点类别

数据格式转换将labelme数据格式转为yolo格式，通用转换代码：
123# TODO:# 参考yolov8-火灾检测，未完待续...
创建训练yaml文件参考yolov8n-pose.yaml
......  -->
        <p class="article-more-link">
          <a href="/2024/01/30/yolov8-pose/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/opencv/">opencv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yolov8/">yolov8</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-yolov8：火灾检测"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/01/25/yolov8：火灾检测/">yolov8-火灾检测</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/01/25/yolov8：火灾检测/" class="article-date">
	  <time datetime="2024-01-25T09:23:20.000Z" itemprop="datePublished">2024-01-25</time>
	</a>

      
    <a class="article-category-link" href="/categories/目标检测/">目标检测</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h3><ul>
<li><font color="gold">NVIDIA 3090*2</font></li>
<li><font color="gold">显卡驱动 535.104.05</font></li>
<li><font color="gold">CUDA版本 12.2</font></li>
<li><font color="gold">CUDAtoolkit</font> (cuda_12.2.2_535.104.05_linux)</li>
<li><font color="gold">cuDNN (v8.9.7)</font>

</li>
</ul>
<h3 id="yolo版本"><a href="#yolo版本" class="headerlink" title="yolo版本"></a>yolo版本</h3><ul>
<li><font color="gold">v8.1.5</font> (ultralytics yolov8)</li>
</ul>
<h3 id="pytorch版本"><a href="#pytorch版本" class="headerlink" title="pytorch版本"></a>pytorch版本</h3><ul>
<li><font color="gold">v2.1.2</font>

</li>
</ul>
<h3 id="python环境"><a href="#python环境" class="headerlink" title="python环境"></a>python环境</h3><ul>
<li><font color="gold">CentOS7.9</font>
</li>
<li><font color="gold">anaconda3</font>
</li>
<li><font color="gold">python3.9</font>

</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>源码主页：<a href="https://github.com/ultralytics/ultralytics" target="_blank" rel="noopener">https://github.com/ultralytics/ultralytics</a></p>
<p>官方文档：<a href="https://docs.ultralytics.com/zh" target="_blank" rel="noopener">https://docs.ultralytics.com/zh</a></p>
<p><img src="/2024/01/25/yolov8：火灾检测/1.png" alt></p>
<h3 id="克隆源码"><a href="#克隆源码" class="headerlink" title="克隆源码"></a>克隆源码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://hub.nuaa.cf/ultralytics/ultralytics.git</span><br></pre></td></tr></table></figure>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pip install ultralytics -i https://mirror.baidu.com/pypi/simple</span><br></pre></td></tr></table></figure>
<h3 id="环境验证"><a href="#环境验证" class="headerlink" title="环境验证"></a>环境验证</h3><p>python</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ultralytics</span><br><span class="line">ultralytics.checks()</span><br></pre></td></tr></table></figure>
<p>cli</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yolo predict model=yolov8n.pt source=ultralytics/assets/zidane.jpg</span><br></pre></td></tr></table></figure>
<p>执行完毕后得到输出的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(py39_yolov8) [root@jdz yolov8]# yolo predict model=yolov8n.pt source=ultralytics/assets/zidane.jpg </span><br><span class="line">Ultralytics YOLOv8.1.5 🚀 Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">YOLOv8n summary (fused): 168 layers, 3151904 parameters, 0 gradients, 8.7 GFLOPs</span><br><span class="line"></span><br><span class="line">image 1/1 /exp/work/video/yolov8/ultralytics/assets/zidane.jpg: 384x640 2 persons, 1 tie, 216.9ms</span><br><span class="line">Speed: 7.3ms preprocess, 216.9ms inference, 762.4ms postprocess per image at shape (1, 3, 384, 640)</span><br><span class="line">Results saved to runs/detect/predict</span><br><span class="line">💡 Learn more at https://docs.ultralytics.com/modes/predict</span><br></pre></td></tr></table></figure>
<p>将在<code>Results saved to runs/detect/predict</code>目录下找到输出结果</p>
        <!--  环境GPU
NVIDIA 3090*2
显卡驱动 535.104.05
CUDA版本 12.2
CUDAtoolkit (cuda_12.2.2_535.104.05_linux)
cuDNN (v8.9.7)



yolo版本
v8.1.5 (ultralytics yolov8)

pytorch版本
v2.1.2



python环境
CentOS7.9

anaconda3

......  -->
        <p class="article-more-link">
          <a href="/2024/01/25/yolov8：火灾检测/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/opencv/">opencv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yolov8/">yolov8</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-NetworkX-图论算法应用"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2024/01/08/NetworkX-图论算法应用/">NetworkX: 图论算法应用</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/01/08/NetworkX-图论算法应用/" class="article-date">
	  <time datetime="2024-01-08T07:48:56.000Z" itemprop="datePublished">2024-01-08</time>
	</a>

      
    <a class="article-category-link" href="/categories/NetworkX/">NetworkX</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="NetworkX"><a href="#NetworkX" class="headerlink" title="NetworkX"></a>NetworkX</h2><p>NetworkX是一款Python的软件包，用于创造、操作复杂网络，以及学习复杂网络的结构、动力学及其功能。有了NetworkX就可以用标准或者不标准的数据格式加载或者存储网络，它可以产生许多种类的随机网络或经典网络，也可以分析网络结构、建立网络模型、设计新的网络算法、绘制网络等</p>
<p>参考文献地址: <a href="https://www.osgeo.cn/networkx/reference/index.html" target="_blank" rel="noopener">https://www.osgeo.cn/networkx/reference/index.html</a></p>
<h2 id="图计算应用方式比较"><a href="#图计算应用方式比较" class="headerlink" title="图计算应用方式比较"></a>图计算应用方式比较</h2><h3 id="1-nebula-spark"><a href="#1-nebula-spark" class="headerlink" title="1.nebula + spark"></a>1.nebula + spark</h3><p>依赖nebula-spark-connector包、nebula-algorithm包和spark集群的数据读取、图计算方式</p>
<h3 id="2-clickhouse-NetworkX"><a href="#2-clickhouse-NetworkX" class="headerlink" title="2.clickhouse + NetworkX"></a>2.clickhouse + NetworkX</h3><p>由于nebula-algorithm依赖spark集群，且nebula-console原生的数据读取能力不佳，在环境受限且计算量有限的情况下优先考虑跳过spark集群和nebula图库，采用clickhouse + NetworkX的图计算方式，其中clickhouse是存储了nebula源数据的列式分布式表，作用类似于方法1中将nebula集群数据通过nebula-spark-connector包导入为spark-DataFrame，仅用做数据读取，再通过将数据转化为NetworkX的图结构进行图计算</p>
<p><img src="/2024/01/08/NetworkX-图论算法应用/9.png" alt></p>
        <!--  NetworkXNetworkX是一款Python的软件包，用于创造、操作复杂网络，以及学习复杂网络的结构、动力学及其功能。有了NetworkX就可以用标准或者不标准的数据格式加载或者存储网络，它可以产生许多种类的随机网络或经典网络，也可以分析网络结构、建立网络模型、设计新的网络算法、绘制网络等
参考文献地址: https://www.osgeo.cn/networkx/reference......  -->
        <p class="article-more-link">
          <a href="/2024/01/08/NetworkX-图论算法应用/#more">Read More</a>
        </p>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nebula/">nebula</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/networkx/">networkx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/图算法/">图算法</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
      </div>
      
        <div align="center" style="margin-top: 30px;"><hr class="hr" style="margin:0px; height:3px;"></div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2024 青域 All Rights Reserved.</p>

	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>










	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            青域
          </div>
          <div class="panel-body">
            Copyright © 2024 tianL.R All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
</script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/hijiki.model.json"},"display":{"position":"left","width":170,"height":340},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>