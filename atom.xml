<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é’åŸŸ</title>
  
  
  <link href="http://yoursite.com/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2025-02-13T02:41:43.647Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>tianL.R</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>yoloç³»æ¨¡å‹çš„tensorrtåŠ é€Ÿ</title>
    <link href="http://yoursite.com/2025/02/10/yolo%E7%B3%BB%E6%A8%A1%E5%9E%8B%E7%9A%84tensorrt%E5%8A%A0%E9%80%9F/"/>
    <id>http://yoursite.com/2025/02/10/yolo%E7%B3%BB%E6%A8%A1%E5%9E%8B%E7%9A%84tensorrt%E5%8A%A0%E9%80%9F/</id>
    <published>2025-02-10T08:14:44.000Z</published>
    <updated>2025-02-13T02:41:43.647Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>trtç®€ä»‹æ‘˜è‡ªUltralyticsã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯èƒ½æå¤§ç¨‹åº¦çš„æé«˜æ¨¡å‹é€Ÿåº¦ï¼Œæ­£æ–‡éƒ¨åˆ†ä¸»è¦è®°å½•éƒ¨ç½²æµç¨‹å’Œæ’å‘æ—¥å¿—ã€‚</p><p><a href="https://developer.nvidia.com/tensorrt" target="_blank" rel="noopener">TensorRT</a>æ˜¯ç”±NVIDIA å¼€å‘ï¼Œä¸“ä¸ºé«˜é€Ÿæ·±åº¦å­¦ä¹ æ¨ç†è€Œè®¾è®¡çš„SDKï¼Œè¯¥SDKå¯é’ˆå¯¹NVIDIA GPUä¼˜åŒ–æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œä»è€Œå®ç°æ›´å¿«ã€æ›´é«˜æ•ˆçš„æ“ä½œã€‚å°†æ·±åº¦å­¦ä¹ æ¨¡å‹è½¬æ¢ä¸ºTensorRTæ ¼å¼å¯ä»¥å……åˆ†å‘æŒ¥NVIDIA GPUçš„æ½œåŠ›ï¼Œéå¸¸é€‚åˆç›®æ ‡æ£€æµ‹ç­‰å®æ—¶åº”ç”¨ã€‚</p><p><img src="/2025/02/10/yoloç³»æ¨¡å‹çš„tensorrtåŠ é€Ÿ/1.png" alt></p><p>TensorRTæ¨¡å‹å…·æœ‰ä¸€ç³»åˆ—å…³é”®ç‰¹æ€§ï¼š</p><ul><li><strong>ç²¾åº¦æ ¡å‡†</strong>ï¼šTensorRTæ”¯æŒç²¾åº¦æ ¡å‡†ï¼Œå…è®¸é’ˆå¯¹ç‰¹å®šç²¾åº¦è¦æ±‚å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒï¼ŒåŒ…æ‹¬å¯¹ INT8 å’Œ FP16 ç­‰é™ä½ç²¾åº¦æ ¼å¼çš„æ”¯æŒï¼Œè¿™å¯ä»¥è¿›ä¸€æ­¥æé«˜æ¨ç†é€Ÿåº¦ï¼ŒåŒæ—¶ä¿æŒå¯æ¥å—çš„ç²¾åº¦æ°´å¹³ã€‚</li><li><strong>å±‚èåˆ</strong>ï¼šTensorRTä¼˜åŒ–è¿‡ç¨‹åŒ…æ‹¬å±‚èåˆï¼Œå³å°†ç¥ç»ç½‘ç»œçš„å¤šä¸ªå±‚åˆå¹¶ä¸ºä¸€ä¸ªæ“ä½œã€‚è¿™å¯ä»¥å‡å°‘è®¡ç®—å¼€é”€ï¼Œå¹¶é€šè¿‡æœ€å¤§é™åº¦åœ°å‡å°‘å†…å­˜è®¿é—®å’Œè®¡ç®—æ¥æé«˜æ¨ç†é€Ÿåº¦ã€‚</li></ul><p><img src="/2025/02/10/yoloç³»æ¨¡å‹çš„tensorrtåŠ é€Ÿ/2.png" alt></p><ul><li><strong>åŠ¨æ€Tensor å†…å­˜ç®¡ç†</strong>ï¼šTensorRTåœ¨æ¨ç†è¿‡ç¨‹ä¸­æœ‰æ•ˆç®¡ç†tensorå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå‡å°‘å†…å­˜å¼€é”€å¹¶ä¼˜åŒ–å†…å­˜åˆ†é…ã€‚è¿™ä½¿å¾—GPUçš„å†…å­˜ä½¿ç”¨æ•ˆç‡æ›´é«˜ã€‚</li><li><strong>è‡ªåŠ¨å†…æ ¸è°ƒæ•´</strong>ï¼šTensorRTåº”ç”¨è‡ªåŠ¨å†…æ ¸è°ƒæ•´åŠŸèƒ½ï¼Œä¸ºæ¨¡å‹çš„æ¯ä¸€å±‚é€‰æ‹©æœ€ä¼˜åŒ–çš„GPUå†…æ ¸ã€‚è¿™ç§è‡ªé€‚åº”æ–¹æ³•å¯ç¡®ä¿æ¨¡å‹å……åˆ†åˆ©ç”¨ GPUçš„è®¡ç®—èƒ½åŠ›ã€‚</li></ul><a id="more"></a><h2 id="YOLOå¯¼å‡ºTensorRT"><a href="#YOLOå¯¼å‡ºTensorRT" class="headerlink" title="YOLOå¯¼å‡ºTensorRT"></a>YOLOå¯¼å‡ºTensorRT</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><h4 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h4><ul><li><font color="gold">NVIDIA 3090*2</font></li><li><font color="gold">æ˜¾å¡é©±åŠ¨ 535.104.05</font></li><li><font color="gold">CUDAç‰ˆæœ¬ 12.2</font></li><li><font color="gold">CUDAtoolkit</font> (cuda_12.2.2_535.104.05_linux)</li><li><font color="gold">cuDNN <del>(v8.9.7)</del> (v9.5.0)</font></li></ul><h4 id="yoloç‰ˆæœ¬"><a href="#yoloç‰ˆæœ¬" class="headerlink" title="yoloç‰ˆæœ¬"></a>yoloç‰ˆæœ¬</h4><ul><li><font color="gold">v11</font> (ultralytics yolov11)</li></ul><h4 id="pytorchç‰ˆæœ¬"><a href="#pytorchç‰ˆæœ¬" class="headerlink" title="pytorchç‰ˆæœ¬"></a>pytorchç‰ˆæœ¬</h4><ul><li><font color="gold">v2.1.2</font></li></ul><h4 id="pythonç¯å¢ƒ"><a href="#pythonç¯å¢ƒ" class="headerlink" title="pythonç¯å¢ƒ"></a>pythonç¯å¢ƒ</h4><ul><li><font color="gold">CentOS7.9</font></li><li><font color="gold">anaconda3</font></li><li><font color="gold">python3.9</font></li></ul><h3 id="å®‰è£…pythonä¾èµ–"><a href="#å®‰è£…pythonä¾èµ–" class="headerlink" title="å®‰è£…pythonä¾èµ–"></a>å®‰è£…pythonä¾èµ–</h3><p>é¦–å…ˆéœ€è¦æ›´æ–°Ultralyticsæºç ã€‚</p><p><code>pip install -U ultralytics -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p><p>æºç é»˜è®¤ä¸åŒ…æ‹¬trtçš„å¯¼å‡ºéƒ¨åˆ†ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬å®‰è£…onnxå’Œtensorrtçš„pythonåŒ…ã€‚ç›´æ¥ä½¿ç”¨å®˜æ–¹å¯¼å‡ºä»£ç äº¦å¯è‡ªåŠ¨å®‰è£…ï¼Œå›½å†…é€Ÿåº¦è¾ƒæ…¢ã€‚</p><p><code>pip install onnx==1.17.0 onnxruntime-gpu==1.16.3 -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p><p>tensorrtç‰ˆæœ¬å®˜æ–¹è¦æ±‚&gt;7.0.0ï¼Œ!=10.1.0ï¼Œä½†æ˜¯å½“å‰ç¯å¢ƒä¸‹å®‰è£…é«˜ç‰ˆæœ¬tensorrtä¼šä¸€ç›´å®‰è£…å¤±è´¥ï¼Œæ¨æµ‹å¯èƒ½æ˜¯cudnnç¯å¢ƒé…ç½®æœ‰é—®é¢˜ã€‚æ•…æŠ˜ä¸­é€‰æ‹©9.0.0.post11.dev1é•œåƒç‰ˆæœ¬ã€‚</p><p><code>pip install tensorrt==9.0.0.post11.dev1 -i https://pypi.tuna.tsinghua.edu.cn/simple</code> </p><h3 id="enginæ¨¡å‹å¯¼å‡º"><a href="#enginæ¨¡å‹å¯¼å‡º" class="headerlink" title="enginæ¨¡å‹å¯¼å‡º"></a>enginæ¨¡å‹å¯¼å‡º</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line">model = YOLO(<span class="string">"yolo11n.pt"</span>)</span><br><span class="line">model.export(format=<span class="string">"engine"</span>)</span><br></pre></td></tr></table></figure><h3 id="è¸©å‘æ—¥å¿—"><a href="#è¸©å‘æ—¥å¿—" class="headerlink" title="è¸©å‘æ—¥å¿—"></a>è¸©å‘æ—¥å¿—</h3><p><strong>ä»¥ä¸‹éƒ¨åˆ†ä¸ºè¸©å‘æ—¥å¿—ï¼Œä¸»è¦è®°å½•è¿‡ç¨‹ä¸­çš„é”™è¯¯ã€‚å¯¼å‡ºéƒ¨åˆ†å¯è·³è½¬è‡³ä¸‹ä¸€ç« èŠ‚ã€‚</strong></p><p>æµ‹è¯•å°†yolo11n.ptæ¨¡å‹è½¬æˆtrtæ ¼å¼ï¼Œç¤ºä¾‹ä»£ç ä¸­<code>.onnx</code>æ ¼å¼ç”Ÿæˆæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯¼å‡º<code>.engine</code>æ ¼å¼æ—¶å‘ç”Ÿé—®é¢˜ï¼ŒæŠ¥é”™ï¼š</p><font color="red"><code>Unable to load any of {libcudnn_engines_precompiled.so.9.5.0, libcudnn_engines_precompiled.so.9.5, libcudnn_engines_precompiled.so.9, libcudnn_engines_precompiled.so}</code></font><font color="red"><code>...</code></font><br><font color="red"><code>RuntimeError: CUDNN_BACKEND_TENSOR_DESCRIPTOR cudnnFinalize failed cudnn_status: CUDNN_STATUS_SUBLIBRARY_LOADING_FAILED</code></font><p>é¦–å…ˆèšç„¦é—®é¢˜<code>CUDNN_BACKEND_TENSOR_DESCRIPTOR cudnnFinalize failed cudnn_status: CUDNN_STATUS_SUBLIBRARY_LOADING_FAILED</code></p><p>æœç´¢äº†å…¨ç½‘ï¼Œå‡ ä¹æ²¡æœ‰åˆç†çš„è§£å†³æ–¹æ¡ˆï¼Œåªèƒ½å®šä½åˆ°æ˜¯CUDNNå‡ºäº†é—®é¢˜ã€‚ç”±äºPytorchä½¿ç”¨çš„æ˜¯condaå†…éƒ¨cudnnï¼Œä½†æ˜¯æ—¥å¸¸å·¥ä½œä¸­ç»å¸¸éœ€è¦ç”¨åˆ°paddlepaddleï¼ŒæœåŠ¡å™¨å±äºç‰©ç†cudnnå’Œè™šæ‹Ÿcudnnå…±å­˜çš„çŠ¶æ€ã€‚</p><p>å°è¯•ç§»é™¤ç‰©ç†CUDNNç¯å¢ƒã€æ‰‹åŠ¨æ·»åŠ torch cudnnåˆ°ç³»ç»Ÿä¸´æ—¶ç¯å¢ƒå˜é‡ï¼ŒæŠ¥é”™ä¾ç„¶å­˜åœ¨ã€‚å¼€å§‹é‡å®¡æŠ¥é”™ä¿¡æ¯ï¼Œå‘ç°å¼€å¤´çš„<code>Unable to load any of {libcudnn_engines_precompiled.so.9.5.0, libcudnn_engines_precompiled.so.9.5, libcudnn_engines_precompiled.so.9, libcudnn_engines_precompiled.so}</code></p><p>è¿™é‡Œå°±æ¸…æ™°æ˜äº†äº†ï¼Œå½“å‰cudnnç¯å¢ƒä¸‹ç¼ºäº†<code>libcudnn_engines_precompiled.so*</code>ï¼Œè¿›è¡Œå…¨ç›˜æœç´¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name libcudnn_engines_precompiled.so*</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥äº†ä¸€ä¸‹condaç¯å¢ƒä¸­å­˜åœ¨<code>libcudnn_engines_precompiled.so</code>ï¼Œè€Œç‰©ç†ç¯å¢ƒ<code>/usr/local/cuda</code>ä¸‹å¹¶æœªæ‰¾åˆ°ï¼ŒçŒœæµ‹ä»å¯èƒ½æ˜¯è¯»å–ç‰©ç†cudnnç¯å¢ƒè€Œå¯¼è‡´çš„å†²çªã€‚é‡æ–°æ£€ç´¢äº†ç‰©ç†ç¯å¢ƒä¸‹çš„cudnnåŸå§‹å®‰è£…åŒ…ï¼Œå‘ç°ç¡®å®ä¸å­˜åœ¨<code>libcudnn_engines_precompiled*</code>è½¯ä»¶ï¼ŒçŒœæµ‹å¯èƒ½éœ€è¦å•ç‹¬å®‰è£…tensorrtã€‚</p><p>äºæ˜¯å•ç‹¬å®‰è£…pycudaï¼Œä¸‹è½½äº†<a href="https://docs.nvidia.com/deeplearning/tensorrt/archives/index.html" target="_blank" rel="noopener">tensorrt</a>ã€‚è§£å‹åå‘ç°ä»ç„¶æ²¡æœ‰<code>libcudnn_engines_precompiled.so*</code>çš„å½±å­ã€‚</p><p>æœ€åæ¨æµ‹éœ€è¦æ›´æ–°æœåŠ¡å™¨cudnnè¯•è¯•ã€‚è¿™é‡Œè¸©äº†ä¸€ä¸ªå‘ï¼Œæˆ‘å®‰è£…cudnnçš„åœ°å€æ˜¯<a href="https://developer.nvidia.com/rdp/cudnn-archive" target="_blank" rel="noopener">https://developer.nvidia.com/rdp/cudnn-archive</a>ï¼Œè¿™é‡Œçš„cudnnæœ€é«˜ç‰ˆæœ¬åªåˆ°v8.9.7ï¼Œæ‰€ä»¥å½“æˆ‘ä¸‹è½½åçœ‹åˆ°æ›¾ç»è£…è¿‡çš„å®‰è£…åŒ…ä»¥åç›¸å½“ç–‘æƒ‘ã€‚æ¯•ç«Ÿå·²ç»å®‰è£…ä¸€å¹´äº†ï¼Œä¸å¯èƒ½è¿˜æ²¡æœ‰æ›´æ–°ã€‚ç«‹é©¬æƒ³æ¸…æ¥šåœ°å€æœ‰é—®é¢˜ï¼Œè¦æ‰¾æ–°ä¸‹è½½åœ°å€ã€‚</p><p>åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œæ‰¾åˆ°äº†æ–°çš„ä¸‹è½½é“¾æ¥ã€‚å› ä¸ºæç¤ºç¼ºå°‘çš„ç‰ˆæœ¬æ˜¯<code>.9.5</code>ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†cudnn v9.5.0ç‰ˆæœ¬ï¼š<a href="https://developer.nvidia.com/cudnn-9-5-0-download-archive" target="_blank" rel="noopener">https://developer.nvidia.com/cudnn-9-5-0-download-archive</a></p><p><img src="/2025/02/10/yoloç³»æ¨¡å‹çš„tensorrtåŠ é€Ÿ/3.png" alt></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/linux-x86_64/cudnn-linux-x86_64-9.5.0.50_cuda12-archive.tar.xz</span><br></pre></td></tr></table></figure><p>è§£å‹åæ›´æ–°cudnnåˆ°9.5.0ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xz -d cudnn-linux-x86_64-9.5.0.50_cuda12-archive.tar.xz</span><br><span class="line">tar -zxvf cudnn-linux-x86_64-9.5.0.50_cuda12-archive.tar</span><br><span class="line">cp cudnn-linux-x86_64-9.5.0.50_cuda12-archive/include/* /usr/local/cuda-12.2/include/</span><br><span class="line">cp cudnn-linux-x86_64-9.5.0.50_cuda12-archive/lib/libcudnn* /usr/local/cuda-12.2/lib64/</span><br><span class="line">chmod a+r /usr/local/cuda-12.2/include/cudnn*.h</span><br><span class="line">chmod a+r /usr/local/cuda-12.2/lib64/libcudnn*</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /usr/local/cuda-12.2/targets/x86_64-linux/include/cudnn_version.h | grep CUDNN_MAJOR -A 2</span><br><span class="line"><span class="meta">#</span>define CUDNN_MAJOR 9</span><br><span class="line"><span class="meta">#</span>define CUDNN_MINOR 5</span><br><span class="line"><span class="meta">#</span>define CUDNN_PATCHLEVEL 0</span><br><span class="line">--</span><br><span class="line"><span class="meta">#</span>define CUDNN_VERSION (CUDNN_MAJOR * 10000 + CUDNN_MINOR * 100 + CUDNN_PATCHLEVEL)</span><br><span class="line"></span><br><span class="line">/* cannot use constexpr here since this is a C-only file */</span><br></pre></td></tr></table></figure><p>æŒ‰ç†è¯´trtè¯»å–ä¸åˆ°è™šæ‹Ÿcudnnä¸‹çš„<code>libcudnn_engines_precompiled.so*</code>ï¼Œé‚£ä¹ˆæ­£å¸¸åº”è¯¥ä¼šè¯»å–ç‰©ç†cudnnçš„ã€‚ä½†æ˜¯å‘ç°æŠ¥é”™ä¾ç„¶å­˜åœ¨ã€‚äºæ˜¯æ·»åŠ ä¸´æ—¶ç³»ç»Ÿå˜é‡ï¼Œå°†å…¶å¼ºåˆ¶åŠ è½½åˆ°ç¯å¢ƒä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LD_PRELOAD=/usr/local/cuda-12.2/targets/x86_64-linux/lib/libcudnn_engines_precompiled.so</span><br></pre></td></tr></table></figure><p>è¿™å›å¦¥äº†ï¼Œç³»ç»Ÿå¯ä»¥æ£€ç´¢åˆ°<code>libcudnn_engines_precompiled.so</code>ã€‚ä½†æ˜¯æ¥ä¸‹æ¥æŠ¥äº†æ–°çš„é”™è¯¯ï¼š</p><font color="red"><code>/lib64/libm.so.6: version &#39;GLIBC_2.27&#39; not found</code></font><p>å¾ˆæå¿ƒæ€ï¼Œä½†æ˜¯ä¸éš¾çœ‹å‡ºåªæ˜¯ç¼ºå°‘äº†è¿™ä¸ªç‰ˆæœ¬çš„GNUåº“ã€‚éªŒè¯ä¸€ä¸‹ï¼ŒæŸ¥çœ‹ç³»ç»Ÿä¸­å½“å‰<code>GLIBC</code>ç‰ˆæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings /lib64/libc.so.6 | grep GLIBC</span><br></pre></td></tr></table></figure><p>ç¡®å®æœ€é«˜åªåˆ°äº†2.17</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GLIBC_2.2.5</span><br><span class="line">GLIBC_2.2.6</span><br><span class="line">GLIBC_2.3</span><br><span class="line">GLIBC_2.3.2</span><br><span class="line">GLIBC_2.3.3</span><br><span class="line">GLIBC_2.3.4</span><br><span class="line">GLIBC_2.4</span><br><span class="line">GLIBC_2.5</span><br><span class="line">GLIBC_2.6</span><br><span class="line">GLIBC_2.7</span><br><span class="line">GLIBC_2.8</span><br><span class="line">GLIBC_2.9</span><br><span class="line">GLIBC_2.10</span><br><span class="line">GLIBC_2.11</span><br><span class="line">GLIBC_2.12</span><br><span class="line">GLIBC_2.13</span><br><span class="line">GLIBC_2.14</span><br><span class="line">GLIBC_2.15</span><br><span class="line">GLIBC_2.16</span><br><span class="line">GLIBC_2.17</span><br><span class="line">GLIBC_PRIVATE</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ›´æ–°<code>GLIBC</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/glibc/glibc-2.27.tar.gz</span><br><span class="line">tar xf glibc-2.27.tar.gz </span><br><span class="line">cd glibc-2.27/ &amp;&amp; mkdir build  &amp;&amp; cd build</span><br><span class="line">../configure --prefix=/usr --disable-profile --enable-add-ons --with-headers=/usr/include --with-binutils=/usr/bin</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>æ­¤è¿‡ç¨‹ä¸­è¿˜éœ€è¦å®‰è£…ä¸€ä¸ªæ’ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bison</span><br></pre></td></tr></table></figure><p>åœ¨ç”Ÿæˆ<code>Makefile</code>è¿‡ç¨‹ä¸­ç…§ä¾‹å‘ç”ŸæŠ¥é”™ï¼ˆçœŸæ˜¯ä¹ ä»¥ä¸ºå¸¸äº†ï¼‰ï¼š</p><font color="red"><code>LD_LIBRARY_PATH shouldn&#39;t contain the current directory when building glibc. Please change the envir</code></font><p>è§£å†³ï¼š<code>LD_LIBRARY_PATH</code>ä¸èƒ½åŒ…å«å½“å‰ç›®å½•ï¼Œéœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡å¹¶é‡æ–°æ‰§è¡Œconfigure</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# echo $LD_LIBRARY_PATH</span><br><span class="line">:/usr/local/cuda-12.2</span><br><span class="line">[root@master ~]# export LD_LIBRARY_PATH=</span><br><span class="line">[root@master ~]# echo $LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure><p>ç»ˆäºæˆåŠŸç”Ÿæˆmakefileã€‚æ¥ä¸‹æ¥è¿›è¡Œmakeæ—¶è¿˜æ˜¯æŠ¥é”™äº†ï¼š</p><font color="red"><code>cc1: all warnings being treated as errors</code></font><p>é—®é¢˜çš„æœ¬è´¨ä¸Šæ˜¯åœ¨ç”Ÿæˆé…ç½®æ–‡ä»¶æ—¶é»˜è®¤æ·»åŠ  â€œ-Werrorâ€ ç¼–è¯‘å™¨æ ‡è®°ï¼ŒCentOS7.9åœ¨ç¼–è¯‘æ—¶ warning è¢«å½“ä½œ error å¤„ç†ã€‚ç½‘ä¸Šæœç´¢åˆ°éƒ½æ˜¯å»<code>Makefile</code>ä¸­å…³é—­æ‰€æœ‰è­¦å‘Šæ³¨é‡Šï¼Œä½†æ˜¯<code>GLIBC</code>çš„<code>Makefile</code>ä¸­æ²¡æœ‰ â€œ-Werrorâ€ ã€‚å»å…¶ä»–æ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹ï¼š</p><p>config.makeï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enable-werror = no</span><br></pre></td></tr></table></figure><p>config.statusï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S[&quot;enable_werror&quot;]=&quot;no&quot;</span><br></pre></td></tr></table></figure><p>Makefileæ·»åŠ ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CFLAGS = -Wall -Wpointer-arith -Wno-unused</span><br><span class="line">KBUILD_CFLAGS += -w</span><br></pre></td></tr></table></figure><p>ç»§ç»­æ‰§è¡Œmakeï¼ŒæŠ¥é”™ï¼š</p><font color="red"><code>make[2]: *** [/usr/local/glibc-2.28/build/link-defines.h] Error 1</code></font><font color="red"><code>*** These critical programs are missing or too old: make</code></font><p>æ›´æ–°makeè§£å†³ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://ftp.gnu.org/gnu/make/make-4.3.tar.gz</span><br><span class="line">tar -xzvf make-4.3.tar.gz </span><br><span class="line">cd make-4.3/</span><br><span class="line">./configure  --prefix=/usr/local/make</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">cd /usr/bin/</span><br><span class="line">mv make make.bak</span><br><span class="line">ln -sv /usr/local/make/bin/make /usr/bin/make</span><br><span class="line">make -v</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å†æ‰§è¡Œ<code>make -j 4</code>ï¼Œç»ˆäºæˆåŠŸã€‚æ‰§è¡Œ<code>make install</code>æœ€åæŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: cannot find -lnss_test2: No such file or directory</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">Execution of gcc -B/usr/bin/ failed!</span><br><span class="line">The script has found some problems with your installation!</span><br><span class="line">Please read the FAQ and the README file and check the following:</span><br><span class="line">- Did you change the gcc specs file (necessary after upgrading from</span><br><span class="line">  Linux libc5)?</span><br><span class="line">- Are there any symbolic links of the form libXXX.so to old libraries?</span><br><span class="line">  Links like libm.so -&gt; libm.so.5 (where libm.so.5 is an old library) are wrong,</span><br><span class="line">  libm.so should point to the newly installed glibc file - and there should be</span><br><span class="line">  only one such link (check e.g. /lib and /usr/lib)</span><br><span class="line">You should restart this script from your build directory after you've</span><br><span class="line">fixed all problems!</span><br><span class="line">Btw. the script doesn't work if you're installing GNU libc not as your</span><br><span class="line">primary library!</span><br><span class="line">make[1]: *** [Makefile:111: install] Error 1</span><br><span class="line">make[1]: Leaving directory '/usr/local/glibc-2.28'</span><br><span class="line">make: *** [Makefile:15: install] Error 2</span><br></pre></td></tr></table></figure><p>å¿ƒå·²å‡‰é€ã€‚ç¼“è¿‡ç¥çœ‹æ­¤æŠ¥é”™ä¿¡æ¯å¤§è‡´æ„æ€æ˜¯ï¼Œ/lib64/libm.so.x (/lib64/libm.so.5)å·²ç»è¢«å ç”¨äº†ã€‚éœ€è¦æˆ‘ä»¬è§£å†³è¿™ä¸ªå ç”¨çš„é—®é¢˜ã€‚</p><p>ä½†æ˜¯å®é™…æŸ¥çœ‹/lib64/libm.so.6çš„è½¯é“¾ï¼Œå·²ç»é“¾æ¥åˆ°äº†éœ€è¦çš„ç‰ˆæœ¬ã€‚æ£€æŸ¥<code>GLIBC</code>ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master build]# ldd --version</span><br><span class="line">ldd (GNU libc) 2.28</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸäº†ã€‚</p><h3 id="ä½¿ç”¨-engineæ¨¡å‹"><a href="#ä½¿ç”¨-engineæ¨¡å‹" class="headerlink" title="ä½¿ç”¨.engineæ¨¡å‹"></a>ä½¿ç”¨<code>.engine</code>æ¨¡å‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the exported TensorRT model</span></span><br><span class="line">tensorrt_model = YOLO(<span class="string">"yolo11n.engine"</span>)</span><br><span class="line"></span><br><span class="line">t = time.time()</span><br><span class="line"><span class="comment"># é¦–æ¬¡é¢„æµ‹ï¼Œæ¨¡å‹åŠ è½½å ç”¨æ—¶é—´è¾ƒé•¿</span></span><br><span class="line">results = tensorrt_model(<span class="string">"test.jpg"</span>)</span><br><span class="line">print(time.time() - t)</span><br><span class="line"></span><br><span class="line">t = time.time()</span><br><span class="line"><span class="comment"># ç¬¬äºŒæ¬¡é¢„æµ‹ï¼Œå¼€å§‹è¿›å…¥æ­£å¸¸é€Ÿåº¦</span></span><br><span class="line">results2 = tensorrt_model(<span class="string">"test.jpg"</span>)</span><br><span class="line">print(time.time() - t)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¾ªç¯æµ‹è¯•ï¼ŒæŸ¥çœ‹ç¨³å®šçš„è¾“å‡ºæ—¶é—´</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">999</span>):</span><br><span class="line">    t = time.time()</span><br><span class="line">    tensorrt_model(<span class="string">"test.jpg"</span>, device=<span class="string">"cuda:1"</span>, save=<span class="literal">False</span>)</span><br><span class="line">    print(time.time() - t)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">image 1/1 /exp/work/video/yolov11trt/bus.jpg: 640x480 4 persons, 1 bus, 0.9ms</span><br><span class="line">Speed: 2.0ms preprocess, 0.9ms inference, 1.0ms postprocess per image at shape (1, 3, 640, 480)</span><br><span class="line">0.009032964706420898</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºç¨³å®šæƒ…å†µä¸‹çº¦9ms/å›¾ï¼Œä½†æ˜¯å®é™…logæ—¥å¿—è¾“å‡ºçš„é¢„å¤„ç†+é¢„æµ‹+åå¤„ç†æ—¶é—´çº¦4msï¼Œè¿˜æœ‰ä¸€åŠæ—¶é—´ä¸çŸ¥é“åšä»€ä¹ˆç”¨äº†ã€‚</p><h3 id="å¯¼å‡ºFP16å’ŒINT8æ¨¡å‹"><a href="#å¯¼å‡ºFP16å’ŒINT8æ¨¡å‹" class="headerlink" title="å¯¼å‡ºFP16å’ŒINT8æ¨¡å‹"></a>å¯¼å‡ºFP16å’ŒINT8æ¨¡å‹</h3><h4 id="FP16"><a href="#FP16" class="headerlink" title="FP16"></a>FP16</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the YOLO11 model</span></span><br><span class="line">model = YOLO(<span class="string">"yolo11n.pt"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Export the model to TensorRT format</span></span><br><span class="line">model.export(format=<span class="string">"engine"</span>, half=<span class="literal">True</span>, imgsz=(<span class="number">640</span>, <span class="number">640</span>),)  <span class="comment"># creates 'yolo11n.engine'</span></span><br></pre></td></tr></table></figure><h4 id="Int8"><a href="#Int8" class="headerlink" title="Int8"></a>Int8</h4><p>æ·»åŠ cocoæ•°æ®é›†</p><p>yamlæ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ultralytics YOLO ğŸš€, AGPL-3.0 license</span></span><br><span class="line"><span class="comment"># COCO128 dataset https://www.kaggle.com/ultralytics/coco128 (first 128 images from COCO train2017) by Ultralytics</span></span><br><span class="line"><span class="comment"># Documentation: https://docs.ultralytics.com/datasets/detect/coco/</span></span><br><span class="line"><span class="comment"># Example usage: yolo train data=coco128.yaml</span></span><br><span class="line"><span class="comment"># parent</span></span><br><span class="line"><span class="comment"># â”œâ”€â”€ ultralytics</span></span><br><span class="line"><span class="comment"># â””â”€â”€ datasets</span></span><br><span class="line"><span class="comment">#     â””â”€â”€ coco128  â† downloads here (7 MB)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">train:</span> <span class="string">/exp/work/video/yolov11trt/coco128/images/train2017</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">/exp/work/video/yolov11trt/coco128/images/train2017</span></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Classes</span></span><br><span class="line"><span class="attr">names:</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">person</span></span><br><span class="line">  <span class="attr">1:</span> <span class="string">bicycle</span></span><br><span class="line">  <span class="attr">2:</span> <span class="string">car</span></span><br><span class="line">  <span class="attr">3:</span> <span class="string">motorcycle</span></span><br><span class="line">  <span class="attr">4:</span> <span class="string">airplane</span></span><br><span class="line">  <span class="attr">5:</span> <span class="string">bus</span></span><br><span class="line">  <span class="attr">6:</span> <span class="string">train</span></span><br><span class="line">  <span class="attr">7:</span> <span class="string">truck</span></span><br><span class="line">  <span class="attr">8:</span> <span class="string">boat</span></span><br><span class="line">  <span class="attr">9:</span> <span class="string">traffic</span> <span class="string">light</span></span><br><span class="line">  <span class="attr">10:</span> <span class="string">fire</span> <span class="string">hydrant</span></span><br><span class="line">  <span class="attr">11:</span> <span class="string">stop</span> <span class="string">sign</span></span><br><span class="line">  <span class="attr">12:</span> <span class="string">parking</span> <span class="string">meter</span></span><br><span class="line">  <span class="attr">13:</span> <span class="string">bench</span></span><br><span class="line">  <span class="attr">14:</span> <span class="string">bird</span></span><br><span class="line">  <span class="attr">15:</span> <span class="string">cat</span></span><br><span class="line">  <span class="attr">16:</span> <span class="string">dog</span></span><br><span class="line">  <span class="attr">17:</span> <span class="string">horse</span></span><br><span class="line">  <span class="attr">18:</span> <span class="string">sheep</span></span><br><span class="line">  <span class="attr">19:</span> <span class="string">cow</span></span><br><span class="line">  <span class="attr">20:</span> <span class="string">elephant</span></span><br><span class="line">  <span class="attr">21:</span> <span class="string">bear</span></span><br><span class="line">  <span class="attr">22:</span> <span class="string">zebra</span></span><br><span class="line">  <span class="attr">23:</span> <span class="string">giraffe</span></span><br><span class="line">  <span class="attr">24:</span> <span class="string">backpack</span></span><br><span class="line">  <span class="attr">25:</span> <span class="string">umbrella</span></span><br><span class="line">  <span class="attr">26:</span> <span class="string">handbag</span></span><br><span class="line">  <span class="attr">27:</span> <span class="string">tie</span></span><br><span class="line">  <span class="attr">28:</span> <span class="string">suitcase</span></span><br><span class="line">  <span class="attr">29:</span> <span class="string">frisbee</span></span><br><span class="line">  <span class="attr">30:</span> <span class="string">skis</span></span><br><span class="line">  <span class="attr">31:</span> <span class="string">snowboard</span></span><br><span class="line">  <span class="attr">32:</span> <span class="string">sports</span> <span class="string">ball</span></span><br><span class="line">  <span class="attr">33:</span> <span class="string">kite</span></span><br><span class="line">  <span class="attr">34:</span> <span class="string">baseball</span> <span class="string">bat</span></span><br><span class="line">  <span class="attr">35:</span> <span class="string">baseball</span> <span class="string">glove</span></span><br><span class="line">  <span class="attr">36:</span> <span class="string">skateboard</span></span><br><span class="line">  <span class="attr">37:</span> <span class="string">surfboard</span></span><br><span class="line">  <span class="attr">38:</span> <span class="string">tennis</span> <span class="string">racket</span></span><br><span class="line">  <span class="attr">39:</span> <span class="string">bottle</span></span><br><span class="line">  <span class="attr">40:</span> <span class="string">wine</span> <span class="string">glass</span></span><br><span class="line">  <span class="attr">41:</span> <span class="string">cup</span></span><br><span class="line">  <span class="attr">42:</span> <span class="string">fork</span></span><br><span class="line">  <span class="attr">43:</span> <span class="string">knife</span></span><br><span class="line">  <span class="attr">44:</span> <span class="string">spoon</span></span><br><span class="line">  <span class="attr">45:</span> <span class="string">bowl</span></span><br><span class="line">  <span class="attr">46:</span> <span class="string">banana</span></span><br><span class="line">  <span class="attr">47:</span> <span class="string">apple</span></span><br><span class="line">  <span class="attr">48:</span> <span class="string">sandwich</span></span><br><span class="line">  <span class="attr">49:</span> <span class="string">orange</span></span><br><span class="line">  <span class="attr">50:</span> <span class="string">broccoli</span></span><br><span class="line">  <span class="attr">51:</span> <span class="string">carrot</span></span><br><span class="line">  <span class="attr">52:</span> <span class="string">hot</span> <span class="string">dog</span></span><br><span class="line">  <span class="attr">53:</span> <span class="string">pizza</span></span><br><span class="line">  <span class="attr">54:</span> <span class="string">donut</span></span><br><span class="line">  <span class="attr">55:</span> <span class="string">cake</span></span><br><span class="line">  <span class="attr">56:</span> <span class="string">chair</span></span><br><span class="line">  <span class="attr">57:</span> <span class="string">couch</span></span><br><span class="line">  <span class="attr">58:</span> <span class="string">potted</span> <span class="string">plant</span></span><br><span class="line">  <span class="attr">59:</span> <span class="string">bed</span></span><br><span class="line">  <span class="attr">60:</span> <span class="string">dining</span> <span class="string">table</span></span><br><span class="line">  <span class="attr">61:</span> <span class="string">toilet</span></span><br><span class="line">  <span class="attr">62:</span> <span class="string">tv</span></span><br><span class="line">  <span class="attr">63:</span> <span class="string">laptop</span></span><br><span class="line">  <span class="attr">64:</span> <span class="string">mouse</span></span><br><span class="line">  <span class="attr">65:</span> <span class="string">remote</span></span><br><span class="line">  <span class="attr">66:</span> <span class="string">keyboard</span></span><br><span class="line">  <span class="attr">67:</span> <span class="string">cell</span> <span class="string">phone</span></span><br><span class="line">  <span class="attr">68:</span> <span class="string">microwave</span></span><br><span class="line">  <span class="attr">69:</span> <span class="string">oven</span></span><br><span class="line">  <span class="attr">70:</span> <span class="string">toaster</span></span><br><span class="line">  <span class="attr">71:</span> <span class="string">sink</span></span><br><span class="line">  <span class="attr">72:</span> <span class="string">refrigerator</span></span><br><span class="line">  <span class="attr">73:</span> <span class="string">book</span></span><br><span class="line">  <span class="attr">74:</span> <span class="string">clock</span></span><br><span class="line">  <span class="attr">75:</span> <span class="string">vase</span></span><br><span class="line">  <span class="attr">76:</span> <span class="string">scissors</span></span><br><span class="line">  <span class="attr">77:</span> <span class="string">teddy</span> <span class="string">bear</span></span><br><span class="line">  <span class="attr">78:</span> <span class="string">hair</span> <span class="string">drier</span></span><br><span class="line">  <span class="attr">79:</span> <span class="string">toothbrush</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download script/URL (optional)</span></span><br><span class="line"><span class="comment">#download: https://ultralytics.com/assets/coco128.zip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#v5loader: True</span></span><br><span class="line"><span class="comment">#fl_gamma: 0.0</span></span><br><span class="line"><span class="comment">#image_weights: False</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line">model = YOLO(<span class="string">"yolo11n_int8.pt"</span>)</span><br><span class="line">model.export(</span><br><span class="line">    format=<span class="string">"engine"</span>,</span><br><span class="line">    int8=<span class="literal">True</span>,</span><br><span class="line">    data=<span class="string">'/exp/work/video/yolov11trt/coco128/coco128.yaml'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the exported TensorRT INT8 model</span></span><br><span class="line">model = YOLO(<span class="string">"yolo11n_int8.engine"</span>)</span><br></pre></td></tr></table></figure><p>é¢„æµ‹æ–¹å¼ç±»ä¼¼ã€‚æœ‰å…¶ä»–å†…å®¹åç»­ç»§ç»­æ›´æ–°ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;trtç®€ä»‹æ‘˜è‡ªUltralyticsã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯èƒ½æå¤§ç¨‹åº¦çš„æé«˜æ¨¡å‹é€Ÿåº¦ï¼Œæ­£æ–‡éƒ¨åˆ†ä¸»è¦è®°å½•éƒ¨ç½²æµç¨‹å’Œæ’å‘æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.nvidia.com/tensorrt&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;TensorRT&lt;/a&gt;æ˜¯ç”±NVIDIA å¼€å‘ï¼Œä¸“ä¸ºé«˜é€Ÿæ·±åº¦å­¦ä¹ æ¨ç†è€Œè®¾è®¡çš„SDKï¼Œè¯¥SDKå¯é’ˆå¯¹NVIDIA GPUä¼˜åŒ–æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œä»è€Œå®ç°æ›´å¿«ã€æ›´é«˜æ•ˆçš„æ“ä½œã€‚å°†æ·±åº¦å­¦ä¹ æ¨¡å‹è½¬æ¢ä¸ºTensorRTæ ¼å¼å¯ä»¥å……åˆ†å‘æŒ¥NVIDIA GPUçš„æ½œåŠ›ï¼Œéå¸¸é€‚åˆç›®æ ‡æ£€æµ‹ç­‰å®æ—¶åº”ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2025/02/10/yoloç³»æ¨¡å‹çš„tensorrtåŠ é€Ÿ/1.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;TensorRTæ¨¡å‹å…·æœ‰ä¸€ç³»åˆ—å…³é”®ç‰¹æ€§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ç²¾åº¦æ ¡å‡†&lt;/strong&gt;ï¼šTensorRTæ”¯æŒç²¾åº¦æ ¡å‡†ï¼Œå…è®¸é’ˆå¯¹ç‰¹å®šç²¾åº¦è¦æ±‚å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒï¼ŒåŒ…æ‹¬å¯¹ INT8 å’Œ FP16 ç­‰é™ä½ç²¾åº¦æ ¼å¼çš„æ”¯æŒï¼Œè¿™å¯ä»¥è¿›ä¸€æ­¥æé«˜æ¨ç†é€Ÿåº¦ï¼ŒåŒæ—¶ä¿æŒå¯æ¥å—çš„ç²¾åº¦æ°´å¹³ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å±‚èåˆ&lt;/strong&gt;ï¼šTensorRTä¼˜åŒ–è¿‡ç¨‹åŒ…æ‹¬å±‚èåˆï¼Œå³å°†ç¥ç»ç½‘ç»œçš„å¤šä¸ªå±‚åˆå¹¶ä¸ºä¸€ä¸ªæ“ä½œã€‚è¿™å¯ä»¥å‡å°‘è®¡ç®—å¼€é”€ï¼Œå¹¶é€šè¿‡æœ€å¤§é™åº¦åœ°å‡å°‘å†…å­˜è®¿é—®å’Œè®¡ç®—æ¥æé«˜æ¨ç†é€Ÿåº¦ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/2025/02/10/yoloç³»æ¨¡å‹çš„tensorrtåŠ é€Ÿ/2.png&quot; alt&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;åŠ¨æ€Tensor å†…å­˜ç®¡ç†&lt;/strong&gt;ï¼šTensorRTåœ¨æ¨ç†è¿‡ç¨‹ä¸­æœ‰æ•ˆç®¡ç†tensorå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå‡å°‘å†…å­˜å¼€é”€å¹¶ä¼˜åŒ–å†…å­˜åˆ†é…ã€‚è¿™ä½¿å¾—GPUçš„å†…å­˜ä½¿ç”¨æ•ˆç‡æ›´é«˜ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è‡ªåŠ¨å†…æ ¸è°ƒæ•´&lt;/strong&gt;ï¼šTensorRTåº”ç”¨è‡ªåŠ¨å†…æ ¸è°ƒæ•´åŠŸèƒ½ï¼Œä¸ºæ¨¡å‹çš„æ¯ä¸€å±‚é€‰æ‹©æœ€ä¼˜åŒ–çš„GPUå†…æ ¸ã€‚è¿™ç§è‡ªé€‚åº”æ–¹æ³•å¯ç¡®ä¿æ¨¡å‹å……åˆ†åˆ©ç”¨ GPUçš„è®¡ç®—èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="TensorRT" scheme="http://yoursite.com/categories/TensorRT/"/>
    
    
    <category term="yolo" scheme="http://yoursite.com/tags/yolo/"/>
    
    <category term="tensorrt" scheme="http://yoursite.com/tags/tensorrt/"/>
    
  </entry>
  
  <entry>
    <title>é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•</title>
    <link href="http://yoursite.com/2025/01/10/%E9%97%B4%E9%9A%99%E6%A0%91%E4%BA%A4%E5%B9%B6%E6%AF%94%E8%81%9A%E7%B1%BB%E7%AE%97%E6%B3%95/"/>
    <id>http://yoursite.com/2025/01/10/%E9%97%B4%E9%9A%99%E6%A0%91%E4%BA%A4%E5%B9%B6%E6%AF%94%E8%81%9A%E7%B1%BB%E7%AE%97%E6%B3%95/</id>
    <published>2025-01-10T05:15:10.000Z</published>
    <updated>2025-02-12T03:59:28.831Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><p>å‰æ–‡ç®€å•ä»‹ç»è¿‡<strong>é—´éš™Â·æ ‘Â·æ’åºç®—æ³•</strong>ä»¥åŠå…¶æ›´æ”¹è¿‡çš„å¯è§†åŒ–è¿‡ç¨‹ã€‚ä½†æ˜¯ç”±äºç®—æ³•æœ¬èº«æ˜¯å¯¹çº¯æ–‡æœ¬å—è¿›è¡Œæ’åºï¼Œå½“é‡åˆ°è¾ƒä¸ºå¤æ‚çš„å›¾åƒç»“æ„æ—¶ï¼Œç”±äºç¼ºå°‘åŸå§‹å›¾åƒä¿¡æ¯ï¼Œå­˜åœ¨ä¸¢å¤±å›¾ç‰‡ç±»å‹æ•°æ®ã€æ— æ³•ç†è§£è¡¨æ ¼ç­‰é—®é¢˜ã€‚</p><p>æ­¤ç®—æ³•çš„è·Ÿè¿›ç‰ˆç›®æ ‡åœ¨äºå¯¹æ’åºç®—æ³•çš„åç»­æ“ä½œæä¾›æ›´ä¸ºç²¾ç¡®çš„ç‰ˆé¢æ¢å¤ï¼Œæ•…åç§°æ²¿ç”¨è‡ªé—´éš™Â·æ ‘Â·æ’åºç®—æ³•ï¼ˆé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/hiroi-sora/GapTree_Sort_Algorithm" target="_blank" rel="noopener">https://github.com/hiroi-sora/GapTree_Sort_Algorithm</a>ï¼‰ï¼Œå‘½å<strong>é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”ï¼ˆIoUï¼‰èšç±»ç®—æ³•</strong>ï¼Œä»¥ä¸‹ç®€ç§°GTIoUCã€‚ç®—æ³•çš„æœ€ç»ˆç›®çš„ä¸ä¼ ç»ŸOCRæˆ–ç‰ˆé¢æ¢å¤ä¸åŒï¼Œæ—¨åœ¨å°†OCRç»“æœåœ¨ç‰ˆé¢åˆ†æç»“æœä¸­èšåˆæˆåŒ…å«å®Œæ•´è¯­ä¹‰çš„æ®µè½ï¼Œä¸ºç¿»è¯‘æä¾›æœåŠ¡ã€‚</p><font color="gold"><strong>GTIoUCåŒ…å«çš„ç®—æ³•ï¼š</strong></font> <em><br><br><font color="gold">â¶</font> <strong>GapTreeæä¾›çš„æ–‡æœ¬å—æ’åºç®—æ³•ï¼›</strong><br><br><font color="gold">â·</font> <strong>åŸºäºYOLOçš„ç‰ˆé¢åˆ†æç®—æ³•ï¼›</strong><br><br><font color="gold">â¸</font> <strong>OCR boxå’Œ YOLO layoutboxä¹‹é—´çš„äº¤å¹¶æ¯”èšç±»ç®—æ³•</strong><br><br><font color="gold"><strong>GTIoUCè§£å†³çš„é—®é¢˜ï¼š</strong></font></em><br><br><font color="gold">â¶</font> <strong>ä»…ä»…ç‰ˆé¢åˆ†æçš„æ•ˆæœä¸å¤Ÿç²¾ç¡®ï¼›</strong><br><br><font color="gold">â·</font> <strong>ç‰ˆé¢åˆ†æåå†…å®¹æ€»æ˜¯å­˜åœ¨ç¼ºå¤±ï¼›</strong><br><br><font color="gold">â¸</font> <strong>ç‰ˆé¢åˆ†æè·å¾—å›¾åƒç»“æ„åå¾€å¾€ä¸å†OCRå›¾åƒä¸­æ–‡å­—ï¼›</strong><br><br><font color="gold">â¹</font> <strong>OCRç»“æœæŒ‰è¡Œè¿”å›ï¼Œæ— æ®µè½ç»“æ„ï¼Œä¸Šä¸‹æ–‡è¯­ä¹‰å­˜åœ¨ç¼ºå¤±ï¼›</strong><br><br><font color="gold"></font><h1 id="GapTreeIoU-Cluster-Algorithm-é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•"><a href="#GapTreeIoU-Cluster-Algorithm-é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•" class="headerlink" title="GapTreeIoU_Cluster_Algorithm | é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•"></a><font color="#0099ee">GapTreeIoU_Cluster_Algorithm | é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•</font></h1><p><img src="/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/0.png" alt></p><p><strong>GTIoUCç®—æ³•çš„ç‰¹æ®Šä¹‹å¤„ï¼š</strong></p><p><font color="gold">â¶</font> <strong>PPStructureç­‰ç‰ˆé¢åˆ†æç®—æ³•éœ€è¦æ ¹æ®ç‰ˆé¢åˆ†æç»“æœåšNæ¬¡æˆªå–ç‰‡æ®µOCRï¼Œä½†æ˜¯ä¼ å…¥OCRæ¨¡å‹çš„<code>det_limit_side_len</code>å‚æ•°æ€»æ˜¯å›ºå®šçš„ï¼Œå¯¼è‡´OCRç»å¸¸æå–ä¸åˆ°ç›¸åº”ç»“æœï¼Œäº§ç”Ÿç©ºç™½é¡µã€‚ç®—æ³•æ¨¡å‹å±‚é¢æ¯è½®ä»…åš1æ¬¡å®Œæ•´çš„å…¨æ–‡OCRå’Œ1æ¬¡Layoutï¼Œè§£å†³OCRç©ºç™½é¡µçš„åŒæ—¶ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–äº†æ—¶é—´å¤æ‚åº¦ï¼›</strong></p><p><font color="gold">â·</font> <strong>ç®—æ³•çš„ç‰ˆé¢åˆ†ææ¨¡å‹ç”±YOLOV11ç»“åˆDocLayNetæ•°æ®é›†è®­ç»ƒå¾—åˆ°ï¼Œç²¾åº¦è¾ƒæ—©æœŸæ¨¡å‹å…·æœ‰è¾ƒå¤§æå‡ï¼Œé€‚ç”¨äºå¤æ‚æ–‡æ¡£ï¼Œæ³›åŒ–èƒ½åŠ›é«˜çš„åŒæ—¶å…¼é¡¾äº†å¤šè¯­ç§è¯†åˆ«ï¼›</strong></p><p><font color="gold">â¸</font> <strong>å°½ç®¡å¦‚æ­¤ï¼Œç›®å‰ä»»ä½•ç‰ˆé¢æ¢å¤æ¨¡å‹ä»æ—§ä¸å…·å¤‡100%æ•è·æ–‡æ¡£ä¿¡æ¯çš„èƒ½åŠ›ã€‚æ­¤æ—¶ç”±äºç®—æ³•çš„OCRéƒ¨åˆ†å’ŒLayoutéƒ¨åˆ†æ˜¯ç›¸å¯¹ç‹¬ç«‹è¿›è¡Œçš„ï¼Œæœ€ç»ˆOCRå’ŒLayoutçš„ç»“æœå°†è¿›è¡ŒIoUèšç±»ï¼ŒIoUè¿‡ç¨‹ä¸­å…ˆå‰Layoutç¼ºå¤±çš„ä¿¡æ¯å°†è¢«OCRç»“æœè¡¥å……ã€å¾—åˆ°æ®µè½å®Œæ•´è¯­ä¹‰ï¼Œæå¤§ç¨‹åº¦ä¸Šæé«˜äº†ç‰ˆé¢æ¢å¤çš„å‡†ç¡®åº¦ã€‚</strong></p><p>ä¸‹é¢å°†è¯¦ç»†ä»‹ç»GTIoUCçš„ç‰ˆé¢æ¢å¤æµç¨‹ã€‚</p><a id="more"></a><h2 id="ç®—æ³•æµç¨‹"><a href="#ç®—æ³•æµç¨‹" class="headerlink" title="ç®—æ³•æµç¨‹"></a>ç®—æ³•æµç¨‹</h2><h3 id="1-Layout"><a href="#1-Layout" class="headerlink" title="1.Layout"></a>1.Layout</h3><h4 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h4><p>DocLayNetï¼ˆ<a href="https://github.com/DS4SD/DocLayNet" target="_blank" rel="noopener">https://github.com/DS4SD/DocLayNet</a>ï¼‰ï¼Œé€‰æ‹©<code>Doclaynet core dataset</code>æ•°æ®é›†ä¸‹è½½</p><p><img src="/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/1.png" alt></p><p>æ•°æ®é›†å…±åŒ…æ‹¬åç§å¸¸è§çš„æ–‡æ¡£æ¿å—ç±»å‹ï¼š</p><p><strong>Â· Captainï¼š</strong>å¤§æ ‡é¢˜</p><p><strong>Â· Footnoteï¼š</strong>è„šæ³¨</p><p><strong>Â· Formulaï¼š</strong>å…¬å¼</p><p><strong>Â· List-itemï¼š</strong>è¡¨æ ¼/åˆ—è¡¨é¡¹</p><p><strong>Â· Page-footerï¼š</strong>é¡µè„š</p><p><strong>Â· Page-headerï¼š</strong>é¡µçœ‰</p><p><strong>Â· Pictureï¼š</strong>å›¾åƒ</p><p><strong>Â· Section-headerï¼š</strong>ç« èŠ‚æ ‡é¢˜</p><p><strong>Â· Tableï¼š</strong>è¡¨æ ¼</p><p><strong>Â· Titleï¼š</strong>å°æ ‡é¢˜</p><h4 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h4><p>æ•°æ®é›†å·²æ˜¯yoloæ ¼å¼ï¼Œä¸éœ€è¦è¿›è¡Œè½¬æ¢ã€‚è¡¥å……yamlæ–‡ä»¶<code>layout.yaml</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span> <span class="string">&#123;fullpath&#125;/doclaynet</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train.txt</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">val.txt</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">val.txt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">names:</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">Caption</span></span><br><span class="line">  <span class="attr">1:</span> <span class="string">Footnote</span></span><br><span class="line">  <span class="attr">2:</span> <span class="string">Formula</span></span><br><span class="line">  <span class="attr">3:</span> <span class="string">List-item</span></span><br><span class="line">  <span class="attr">4:</span> <span class="string">Page-footer</span></span><br><span class="line">  <span class="attr">5:</span> <span class="string">Page-header</span></span><br><span class="line">  <span class="attr">6:</span> <span class="string">Picture</span></span><br><span class="line">  <span class="attr">7:</span> <span class="string">Section-header</span></span><br><span class="line">  <span class="attr">8:</span> <span class="string">Table</span></span><br><span class="line">  <span class="attr">9:</span> <span class="string">Text</span></span><br><span class="line">  <span class="attr">10:</span> <span class="string">Title</span></span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><p>éœ€è¦å®‰è£…æœ€æ–°<code>ultralytics</code>ï¼ˆyolo11ï¼‰ï¼Œæ ¹æ®æ˜¾å­˜å¤§å°è°ƒæ•´batch_sizeã€‚è¿™é‡Œä½¿ç”¨çš„GPUç¯å¢ƒï¼šRTX3090 24G*2ï¼›batch_sizeè®¾ç½®ä¸º8æ—¶ï¼Œæ˜¾å­˜å ç”¨13Gbi/å¡ï¼›ä½¿ç”¨çš„yoloé¢„è®­ç»ƒæ¨¡å‹ï¼šyolo11x.ptã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load a model</span></span><br><span class="line">model = YOLO(<span class="string">'/exp/work/translate_plat/yolov11/yolo11x.pt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train the model with 2 GPUs</span></span><br><span class="line">model.train(</span><br><span class="line">    data=<span class="string">'layout.yaml'</span>,</span><br><span class="line">    batch=<span class="number">8</span>,</span><br><span class="line">    imgsz=<span class="number">1120</span>,</span><br><span class="line">    epochs=<span class="number">500</span>,</span><br><span class="line">    lr0=<span class="number">0.02</span>,</span><br><span class="line">    optimizer=<span class="string">'SGD'</span>,</span><br><span class="line">    device=[<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">model.val()</span><br></pre></td></tr></table></figure><p>è®­ç»ƒè¿‡ç¨‹ä¸­æ¯ä¸ªepochçº¦1å°æ—¶ï¼Œè®­ç»ƒæ—¶é—´è¿‡é•¿ï¼Œä¸å®šæ€§å› ç´ è¾ƒå¤šã€‚å½“è®­ç»ƒä¸­æ­¢åå¯æ›´æ¢è®­ç»ƒè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load a model</span></span><br><span class="line">model = YOLO(<span class="string">'/exp/work/translate_plat/yolov11/runs/detect/train/weights/best.pt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train the model with 2 GPUs</span></span><br><span class="line">model.train(</span><br><span class="line">    data=<span class="string">'layout.yaml'</span>,</span><br><span class="line">    batch=<span class="number">8</span>,</span><br><span class="line">    imgsz=<span class="number">1120</span>,</span><br><span class="line">    epochs=<span class="number">500</span>,</span><br><span class="line">    lr0=<span class="number">0.02</span>,</span><br><span class="line">    resume=<span class="literal">True</span>,</span><br><span class="line">    optimizer=<span class="string">'SGD'</span>,</span><br><span class="line">    device=[<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">model.val()</span><br></pre></td></tr></table></figure><p>çº¦500å°æ—¶ï¼ˆ3å‘¨ï¼‰ä»¥åå¾—åˆ°æœ€ç»ˆLayoutæ¨¡å‹ã€‚è·å–ç‰ˆé¢åˆ†æç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">det_res = model.predict(</span><br><span class="line">    image,</span><br><span class="line">    iou=<span class="number">0.1</span>,</span><br><span class="line">    imgsz=<span class="number">1024</span>,</span><br><span class="line">    conf=<span class="number">0.5</span>,</span><br><span class="line">    device=<span class="string">"cuda:1"</span>,</span><br><span class="line">    save=<span class="literal">False</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><img src="/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/2.png" alt></p><h3 id="2-OCR"><a href="#2-OCR" class="headerlink" title="2.OCR"></a>2.OCR</h3><p>OCRä½œä¸ºä¸€åˆ‡çš„åŸºçŸ³ï¼Œé€‰æ‹©å¸¸ç”¨çš„å³å¯ï¼Œä»…éœ€è¦å¯¹OCRçš„ç»“æœåšä¸€å±‚æ•°æ®ç»“æ„çš„æ ‡å‡†åŒ–ã€‚</p><p>è¿™é‡Œæ¨èä½¿ç”¨ä¸¤æ¬¾OCRï¼šPaddleOCRå’ŒSuryaOCRï¼Œå‰è€…è¾ƒä¸ºå¸¸ç”¨ï¼Œå¯¹ä¸­è‹±æ–‡æ–¹ä¾¿å¼€ç®±ä½¿ç”¨ã€‚åè€…ä¸­æ–‡æ•ˆæœè¾ƒå·®ï¼Œä½†æ˜¯å¤šè¯­ç§æ•ˆæœå‡ ä¹ç¢¾å‹PaddleOCRã€‚</p><p>ä»¥PaddleOCRä¸ºä¾‹ï¼š</p><p><img src="/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/3.png" alt></p><p>OCRæ¥å£è¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[[[[225.0, 9.0], [782.0, 9.0], [782.0, 27.0], [225.0, 27.0]], [&apos;(CollegeofComputerScience,ChongqingUniversity,Chongqing400044,China)&apos;, 0.9394824504852295]], [[[32.0, 45.0], [981.0, 46.0], [981.0, 65.0], [32.0, 64.0]], [&apos;[Abstract]There areboth relevant informationand irrelevant information in a Webpage,the irrelevant information brings some negative&apos;, 0.9342334866523743]], [[[24.0, 73.0], [981.0, 76.0], [981.0, 94.0], [24.0, 92.0]], [&apos;influence to their classification, storage and retrieve.In order to reduce the influence, aiming at theme-related Web pages, this paper&apos;, 0.9241952300071716]], [[[23.0, 103.0], [982.0, 102.0], [982.0, 124.0], [23.0, 125.0]], [&apos;proposes a new method to extract the content of Web pages based on their text and structural features. It removes those unrelated tags in the&apos;, 0.947555661201477]], [[[26.0, 134.0], [979.0, 134.0], [979.0, 152.0], [26.0, 152.0]], [&apos;Webpagebyregular expressions,and segments theWeb into blocks according to Webpages structureand thetext informationBy&apos;, 0.9187150597572327]], [[[25.0, 162.0], [980.0, 162.0], [980.0, 181.0], [25.0, 181.0]], [&apos;analyzing the text blocks and link blocks of the Web, it only retains the main content of the page; those noisy parts are deleted from the&apos;, 0.9074915051460266]], [[[31.0, 219.0], [934.0, 222.0], [934.0, 240.0], [31.0, 238.0]], [&apos;[Keywords] contentextraction; Webpagedenoising;Web pagesegmentation, subject crawling,informationretrieve;Webmining&apos;, 0.9111730456352234]], [[[27.0, 251.0], [328.0, 251.0], [328.0, 267.0], [27.0, 267.0]], [&apos;DOl:10.3969/j.issn.1000-3428.2013.12.043&apos;, 0.9246572256088257]], [[[11.0, 344.0], [98.0, 347.0], [97.0, 373.0], [11.0, 370.0]], [&apos;1æ¦‚è¿°&apos;, 0.9476785063743591]], [[[564.0, 337.0], [987.0, 337.0], [987.0, 352.0], [564.0, 352.0]], [&apos;é’ˆå¯¹æ¥è‡ªåŒä¸€ç«™ç‚¹çš„ç½‘é€šå¸¸å…·æœ‰åŒæ ·çš„ç»“æ„ï¼Œè®¸å¤š&apos;, 0.9185552597045898]], [[[525.0, 363.0], [991.0, 363.0], [991.0, 385.0], [525.0, 385.0]], [&apos;å­¦è€…æå‡ºäº†åŸºäºæ¨¡æ¿çš„æå–æ–¹æ³•[3-4]ã€‚ç®—æ³•é€šè¿‡å¯¹æ¥è‡ªåŒä¸€&apos;, 0.9745544195175171]], [[[56.0, 397.0], [469.0, 397.0], [469.0, 412.0], [56.0, 412.0]], [&apos;ç½‘è´çš„å†…å®¹å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç½‘è´çš„æ­£æ–‡ï¼Œ&apos;, 0.8542546033859253]], [[[526.0, 396.0], [987.0, 396.0], [987.0, 415.0], [526.0, 415.0]], [&apos;ç½‘ç«™2ä¸ªé¡µé¢çš„DOMæ ‘ç»“æ„è¿›è¡Œæ¯”è¾ƒï¼Œåˆ é™¤å…¶å…¬å…±éƒ¨åˆ†ï¼Œ&apos;, 0.977752149105072]], [[[18.0, 428.0], [480.0, 428.0], [480.0, 443.0], [18.0, 443.0]], [&apos;å³ç½‘è´çš„ä¸»é¢˜å†…å®¹ï¼›å¦ä¸€éƒ¨åˆ†æ˜¯å’Œæ­£æ–‡æ— å…³çš„éƒ¨åˆ†ï¼Œå³â€œå™ª&apos;, 0.9320459961891174]], [[[526.0, 429.0], [988.0, 429.0], [988.0, 444.0], [526.0, 444.0]], [&apos;ä¸‹éƒ¨åˆ†å°±ä½œä¸ºå„è‡ªçš„ä¸»é¢˜ä¿¡æ¯ã€‚åŸºäºæ¨¡æ¿çš„æ–¹æ³•å…·æœ‰å‡†&apos;, 0.9174962043762207]], [[[19.0, 458.0], [475.0, 458.0], [475.0, 474.0], [19.0, 474.0]], [&apos;éŸ³â€éƒ¨åˆ†ï¼ˆå³å¯¼èˆªæ¡ã€ç›¸å…³é“¾æ¥ã€å¹¿å‘Šé“¾æ¥ã€ç‰ˆæƒå£°æ˜ç­‰ï¼‰ã€‚&apos;, 0.9373550415039062]], [[[526.0, 460.0], [977.0, 460.0], [977.0, 475.0], [526.0, 475.0]], [&apos;ç¡®ç‡é«˜çš„ç­‰ç‚¹ï¼Œä½†ç¼ºç‚¹æ˜¯äº’è”ç½‘ä¸Šå…·æœ‰éš¾ä»¥è®¡æ•°çš„ç½‘ç«™ï¼š&apos;, 0.9136723279953003]], [[[26.0, 488.0], [482.0, 488.0], [482.0, 507.0], [26.0, 507.0]], [&apos;â€œå™ªéŸ³â€éƒ¨åˆ†å†…å®¹é€šå¸¸å æ®æ•´ä¸ªç½‘é¡µçš„40%~50%ï¼Œç”šè‡³è¿˜&apos;, 0.9449021220207214]], [[[526.0, 490.0], [989.0, 490.0], [989.0, 506.0], [526.0, 506.0]], [&apos;ä¸å¯èƒ½ç”¨åŒä¸€æ¨¡æ¿æ¥å¯¹ç½‘è´Ÿå†…å®¹è¿›è¡Œæå–ï¼Œå› æ­¤ï¼ŒåŸºäºæ¨¡&apos;, 0.9249494671821594]], [[[16.0, 519.0], [128.0, 516.0], [128.0, 536.0], [16.0, 539.0]], [&apos;åœ¨é€æ¸å¢åŠ é—¨ã€‚&apos;, 0.860722541809082]], [[[525.0, 519.0], [714.0, 519.0], [714.0, 537.0], [525.0, 537.0]], [&apos;æ¿çš„æ–¹æ³•ä¸å…·æœ‰æ™®éæ€§ã€‚&apos;, 0.961738646030426]], [[[56.0, 552.0], [480.0, 552.0], [480.0, 567.0], [56.0, 567.0]], [&apos;æ—©åœ¨2001å¹´ï¼ŒRahmanç­‰äººå°±æå‡ºäº†â€œå†…å®¹æå–â€çš„&apos;, 0.9352570176124573]], [[[564.0, 552.0], [987.0, 552.0], [987.0, 567.0], [564.0, 567.0]], [&apos;ç½‘è´æ­£æ–‡éƒ¨åˆ†å…·æœ‰æ–‡å­—å†…å®¹å¤šã€é“¾æ¥å†…å®¹å°‘ã€æ ‡ç­¾å°‘&apos;, 0.9434654116630554]], [[[18.0, 582.0], [480.0, 582.0], [480.0, 598.0], [18.0, 598.0]], [&apos;æ—¢å¿µï¼Œæ­£æ–‡æå–åœ¨WebæŒ–æ˜ã€è‡ªç„¶è¯­è¨€å¤„ç†(NLPï¼‰ã€ä¿¡æ¯æ£€&apos;, 0.920298159122467]], [[[526.0, 582.0], [987.0, 582.0], [987.0, 598.0], [526.0, 598.0]], [&apos;çš„ç‰¹ç‚¹ã€‚åŸºäºç»Ÿè®¡ç†è®ºçš„ç ”ç©¶æ–¹æ³•æ­£æ˜¯åŸºäºæ­¤ç±»ç‰¹å¾æå‡º&apos;, 0.9824463725090027]], [[[17.0, 612.0], [482.0, 612.0], [482.0, 631.0], [17.0, 631.0]], [&apos;ç´¢ã€ç½‘é¡µåœ¨å°å±å¹•å°ºå¯¸è®¾å¤‡ï¼ˆæ‰‹æœºã€PADç­‰ï¼‰ä¸Šæ˜¾ç¤ºç­‰é¢†åŸŸéƒ½&apos;, 0.9575836062431335]], [[[525.0, 612.0], [989.0, 612.0], [989.0, 631.0], [525.0, 631.0]], [&apos;çš„ã€‚æ–‡çŒ®[5]å°†ç½‘é¡µè§£ææˆDOMæ ‘çš„ç»“æ„ï¼Œç„¶åè®¡ç®—æ ‘ä¸­&apos;, 0.9075543284416199]], [[[15.0, 642.0], [167.0, 639.0], [167.0, 661.0], [15.0, 664.0]], [&apos;å…·æœ‰é‡è¦çš„ä½œç”¨[2]ã€‚&apos;, 0.9330642819404602]], [[[526.0, 645.0], [987.0, 645.0], [987.0, 660.0], [526.0, 660.0]], [&apos;çš„èŠ‚ç‚¹éƒ¨åˆ†è¿›è¡Œæ–‡æœ¬å¯†åº¦ï¼Œå°†æ–‡æœ¬å¯†åº¦å¤©çš„éƒ¨åˆ†å½“æˆç½‘è´&apos;, 0.870039701461792]], [[[55.0, 676.0], [480.0, 676.0], [480.0, 691.0], [55.0, 691.0]], [&apos;è¿‘å¹´æ¥ï¼Œç½‘é¡µæ­£æ–‡æå–ä¸€ç›´æ˜¯webç ”ç©¶çš„çƒ­ç‚¹ï¼Œå·²ç»&apos;, 0.9165266156196594]], [[[524.0, 673.0], [987.0, 674.0], [987.0, 693.0], [524.0, 692.0]], [&apos;çš„æ­£æ–‡ï¼Œä»¥æ­¤æ¥è¿›è¡Œæ­£æ–‡å†…å®¹æå–ã€‚æ–‡çŒ®[6]é€šè¿‡åˆ†æå¾—çŸ¥ï¼Œ&apos;, 0.9288652539253235]], [[[17.0, 705.0], [480.0, 704.0], [480.0, 723.0], [17.0, 724.0]], [&apos;æœ‰è®¸å¤šå­¦è€…åœ¨è¿™æ–¹é¢åšè¿‡å¾ˆå¤šç›¸å…³ç ”ç©¶ï¼Œå¹¶ä¸”å–å¾—äº†ä¸å°‘&apos;, 0.9702548384666443]], [[[525.0, 705.0], [989.0, 705.0], [989.0, 724.0], [525.0, 724.0]], [&apos;æ­£æ–‡éƒ¨åˆ†å’Œç½‘é¡µå…¶ä»–éƒ¨åˆ†ç›¸æ¯”ï¼Œæ‰€å«æœ‰çš„æ–‡å­—ä¸ªæ•°ä¸&apos;, 0.9652908444404602]]]]</span><br></pre></td></tr></table></figure><p>å‡è®¾OCRåŸå§‹è¿”å›ç»“æœä¸º<code>ocr_result</code>ï¼Œéœ€è¦å°†OCRç»“æœè½¬æ¢æˆä»¥ä¸‹æ•°æ®ç»“æ„ï¼ˆ<code>json_data</code>ï¼‰ï¼Œä¾›åç»­è§£æï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ocr_boxes = [line[<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]        <span class="comment"># æ£€æµ‹æ¡†</span></span><br><span class="line">ocr_txts = [line[<span class="number">1</span>][<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]      <span class="comment"># æ–‡æœ¬</span></span><br><span class="line">ocr_scores = [line[<span class="number">1</span>][<span class="number">1</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]    <span class="comment"># ç½®ä¿¡åº¦</span></span><br><span class="line"></span><br><span class="line">json_data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(ocr_result[<span class="number">0</span>])):</span><br><span class="line">    json_data.append(&#123;</span><br><span class="line">        <span class="string">"box"</span>: [[int(i[<span class="number">0</span>]), int(i[<span class="number">1</span>])] <span class="keyword">for</span> i <span class="keyword">in</span> ocr_boxes[i]],</span><br><span class="line">        <span class="string">"score"</span>: ocr_scores[i],</span><br><span class="line">        <span class="string">"text"</span>: ocr_txts[i]</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h3 id="3-é—´éš™Â·æ ‘Â·æ’åºç®—æ³•"><a href="#3-é—´éš™Â·æ ‘Â·æ’åºç®—æ³•" class="headerlink" title="3.é—´éš™Â·æ ‘Â·æ’åºç®—æ³•"></a>3.é—´éš™Â·æ ‘Â·æ’åºç®—æ³•</h3><p>å‰ªå»å¤šä½™æ­¥éª¤ï¼Œé‡æ–°å°è£…æˆç±»<code>StructureOCR</code>ï¼Œä»…ä½¿ç”¨GapTreeçš„æ–‡æœ¬å—æ’åºåŠŸèƒ½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gap_tree <span class="keyword">import</span> GapTree</span><br><span class="line"><span class="keyword">from</span> preprocessing <span class="keyword">import</span> linePreprocessing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StructureOCR</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, blocks_data)</span>:</span></span><br><span class="line">        self.blocks_data = blocks_data</span><br><span class="line">        self.bboxes = linePreprocessing(self.blocks_data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_info</span><span class="params">(tb)</span>:</span>  <span class="comment"># è¿”å›ä¿¡æ¯</span></span><br><span class="line">        b = tb[<span class="string">"box"</span>]</span><br><span class="line">        <span class="keyword">return</span> (b[<span class="number">0</span>][<span class="number">0</span>], b[<span class="number">0</span>][<span class="number">1</span>], b[<span class="number">2</span>][<span class="number">0</span>], b[<span class="number">2</span>][<span class="number">1</span>]), tb[<span class="string">"text"</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_end</span><span class="params">(tb, end)</span>:</span>  <span class="comment"># è·å–é¢„æµ‹çš„å—å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">        tb[<span class="string">"end"</span>] = end</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">structure_ocr</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> line, tb <span class="keyword">in</span> enumerate(self.blocks_data):</span><br><span class="line">            tb[<span class="string">"bbox"</span>] = self.bboxes[line]</span><br><span class="line"></span><br><span class="line">        gtree = GapTree(<span class="keyword">lambda</span> tb: tb[<span class="string">"bbox"</span>])</span><br><span class="line">        sorted_text_blocks = gtree.sort(self.blocks_data)  <span class="comment"># æ–‡æœ¬å—æ’åº</span></span><br><span class="line">        <span class="keyword">return</span> sorted_text_blocks</span><br></pre></td></tr></table></figure><p>è·å–ç»è¿‡æ’åºçš„OCRå­—ç¬¦ä¸²åºåˆ—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">so = StructureOCR(json_data)</span><br><span class="line">blocks = so.structure_ocr()</span><br></pre></td></tr></table></figure><h3 id="4-IoUèšç±»"><a href="#4-IoUèšç±»" class="headerlink" title="4.IoUèšç±»"></a>4.IoUèšç±»</h3><p>åœ¨å¾—åˆ°Layoutç»“æœåï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯é‚£äº›æ¿å—éœ€è¦åšèšç±»ï¼ˆä¿æŒæ¢è¡Œ/ä¸Šä¸‹æ–‡è¯­ä¹‰çš„è¿è´¯æ€§ï¼‰ï¼Œå“ªäº›æ¿å—ä¸åšèšç±»ï¼Œè€Œæ˜¯ä¿ç•™OCRçš„ç»“æœã€‚</p><p>åœ¨ç¿»è¯‘ä»»åŠ¡ä¸­ï¼Œé€šå¸¸éœ€è¦ä¿è¯è¯­ä¹‰è¿è´¯çš„éƒ¨åˆ†éƒ½å­˜åœ¨äºæ­£æ–‡ä¸­ï¼Œå¯¹è¡¨æ ¼ã€å›¾ç‰‡å’Œå…¬å¼å¾€å¾€å¹¶ä¸éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œä¸Šä¸‹æ–‡è¯­ä¹‰æ‹¼æ¥ï¼Œåœ¨DocLayNetæ•°æ®é›†ä¸­åˆ†åˆ«å¯¹åº”ç€<code>Formula</code>ã€<code>Picture</code>å’Œ<code>Table</code>ä¸‰ç§æ ‡ç­¾ç±»å‹ã€‚è¿™é‡Œå°†éœ€è¦èšç±»çš„éƒ¨åˆ†è®¾ç½®æˆä¸¤ç»„åˆ—è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content_clses = [<span class="string">"Caption"</span>, <span class="string">"Footnote"</span>, <span class="string">"List-item"</span>, <span class="string">"Section-header"</span>, <span class="string">"Text"</span>, <span class="string">"Title"</span>]</span><br><span class="line">figure_clses = [<span class="string">"Formula"</span>, <span class="string">"Picture"</span>, <span class="string">"Table"</span>]</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«è·å–éœ€è¦å’Œä¸éœ€è¦èšç±»æ¿å—çš„ç±»åˆ«å’Œæ£€æµ‹æ¡†Layout boxã€‚det_resä¸ºä¸Šæ–‡æœ€ç»ˆç‰ˆé¢åˆ†æçš„ç»“æœã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> res <span class="keyword">in</span> det_res:</span><br><span class="line">    boxes = res.boxes</span><br><span class="line">    names = res.names</span><br><span class="line">    clses = [names.get(i) <span class="keyword">for</span> i <span class="keyword">in</span> res.boxes.cls.tolist()]</span><br><span class="line"></span><br><span class="line">    layout_results = [</span><br><span class="line">        &#123;<span class="string">'layout_cls'</span>: cls,</span><br><span class="line">         <span class="string">'layout_box'</span>: [</span><br><span class="line">             [int(box[<span class="number">0</span>]), int(box[<span class="number">1</span>])],</span><br><span class="line">             [int(box[<span class="number">2</span>]), int(box[<span class="number">1</span>])],</span><br><span class="line">             [int(box[<span class="number">2</span>]), int(box[<span class="number">3</span>])],</span><br><span class="line">             [int(box[<span class="number">0</span>]), int(box[<span class="number">3</span>])]</span><br><span class="line">         ]</span><br><span class="line">        &#125; <span class="keyword">for</span> cls, box <span class="keyword">in</span> zip(clses, boxes.xyxy.tolist()) <span class="keyword">if</span> cls <span class="keyword">in</span> content_clses]</span><br><span class="line"></span><br><span class="line">    layout_figures = [</span><br><span class="line">        &#123;<span class="string">'layout_cls'</span>: cls,</span><br><span class="line">         <span class="string">'layout_box'</span>: [</span><br><span class="line">             [int(box[<span class="number">0</span>]), int(box[<span class="number">1</span>])],</span><br><span class="line">             [int(box[<span class="number">2</span>]), int(box[<span class="number">1</span>])],</span><br><span class="line">             [int(box[<span class="number">2</span>]), int(box[<span class="number">3</span>])],</span><br><span class="line">             [int(box[<span class="number">0</span>]), int(box[<span class="number">3</span>])]</span><br><span class="line">         ]</span><br><span class="line">        &#125; <span class="keyword">for</span> cls, box <span class="keyword">in</span> zip(clses, boxes.xyxy.tolist()) <span class="keyword">if</span> cls <span class="keyword">in</span> figure_clses]</span><br></pre></td></tr></table></figure><p>å°†æ¯ä¸ªOCR boxåˆ†åˆ«ä¸èšç±»æ¿å—ä¸­çš„Layout boxè¿›è¡ŒIoUäº¤å¹¶æ¯”è®¡ç®—ï¼Œå°†ç»“æœå…¨éƒ¨å­˜å‚¨å¹¶æ’åºï¼Œè·å–IoUæœ€å¤§çš„ç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OCRå¯¹æ‰€æœ‰æ–‡æœ¬å—è¿›è¡Œæ’åºï¼Œæ¯ä¸ªæ–‡æœ¬å—åŒ¹é…æœ€è¿‘æ¿å—id</span></span><br><span class="line">layout_blocks = []        <span class="comment"># èšåˆç»“æœ</span></span><br><span class="line">un_layout_blocks = []     <span class="comment"># ç¼ºå¤±ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> blocks:</span><br><span class="line">    iou_set = []</span><br><span class="line">    <span class="keyword">for</span> i, layout_result <span class="keyword">in</span> enumerate(layout_results):</span><br><span class="line">        ocr_box = line.get(<span class="string">'box'</span>)</span><br><span class="line">        lay_box = layout_result.get(<span class="string">'layout_box'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># IoU</span></span><br><span class="line">        poly1 = Polygon(ocr_box)</span><br><span class="line">        poly2 = Polygon(lay_box)</span><br><span class="line">        intersection = poly1.intersection(poly2)</span><br><span class="line">        iou_area = intersection.area <span class="keyword">if</span> <span class="keyword">not</span> intersection.is_empty <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        iou_set.append((i, iou_area, line.get(<span class="string">'text'</span>)))</span><br><span class="line"></span><br><span class="line">        iou_set = sorted(iou_set, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])[<span class="number">-1</span>]</span><br></pre></td></tr></table></figure><p>å°†æœ‰IoUæå¤§å€¼çš„OCRç»“æœå­˜å…¥<code>layout_blocks</code>ï¼Œæ— ç»“æœçš„æ•°æ®åˆ™å­˜å…¥<code>un_layout_blocks</code>ä½œä¸ºç‰ˆé¢åˆ†æè¿‡ç¨‹ä¸­ç¼ºå¤±ä¿¡æ¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸ºæ¿å—æ·»åŠ åœ¨å…¶å†…éƒ¨çš„OCRæ–‡æœ¬å—</span></span><br><span class="line"><span class="keyword">if</span> iou_set[<span class="number">1</span>] &gt; <span class="number">0</span>:</span><br><span class="line">    layout_blocks.append((iou_set[<span class="number">0</span>], iou_set[<span class="number">2</span>]))</span><br><span class="line">    <span class="comment"># é¢å¤–å¤„ç†ä¸åœ¨ä»»ä½•æ¿å—å†…çš„OCRæ–‡æœ¬å—</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    un_layout_blocks.append(&#123;<span class="string">"paragraph"</span>: line.get(<span class="string">'text'</span>), <span class="string">"layout_box"</span>: line.get(<span class="string">'box'</span>)&#125;)</span><br></pre></td></tr></table></figure><p>å†å°†èšåˆè¿‡çš„Layboxä¸­çš„æ–‡æœ¬èšåˆæˆæ®µè½ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ–‡æœ¬å—æ’åºç»“æœæŒ‰æ¿å—idèšåˆï¼Œèšåˆç»“æœâ€”â€”æ¿å—idï¼šæ®µè½</span></span><br><span class="line">grouped_layout_blocks = defaultdict(list)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> layout_blocks:</span><br><span class="line">    grouped_layout_blocks[line[<span class="number">0</span>]].append(line[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>æ„å»ºæœ€ç»ˆç»“æœï¼Œæ·»åŠ ä¿å­˜çš„æ®µè½å’Œæœªèšåˆçš„ç»“æœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ¿å—æ£€æµ‹æ¡†æ·»åŠ è¿›èšåˆç»“æœå†…</span></span><br><span class="line">layout_paragraphs = []</span><br><span class="line">layout_figures_list = [i.get(<span class="string">'layout_box'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> layout_figures]</span><br><span class="line"><span class="keyword">for</span> i, layout_result <span class="keyword">in</span> enumerate(layout_results):</span><br><span class="line">    paragraph = grouped_layout_blocks.get(i)</span><br><span class="line">    layout_paragraphs.append(&#123;<span class="string">"paragraph"</span>: <span class="string">""</span>.join(paragraph), <span class="string">"layout_box"</span>: layout_result.get(<span class="string">"layout_box"</span>)&#125;)</span><br><span class="line">    layout_paragraphs.extend(un_layout_blocks)</span><br><span class="line">    layout_paragraphs_list = [i.get(<span class="string">'paragraph'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> layout_paragraphs]</span><br><span class="line">    layout_boxes_list = [i.get(<span class="string">'layout_box'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> layout_paragraphs]</span><br></pre></td></tr></table></figure><h2 id="å¯è§†åŒ–"><a href="#å¯è§†åŒ–" class="headerlink" title="å¯è§†åŒ–"></a>å¯è§†åŒ–</h2><p>æ•´ä½“æ€æƒ³å‚ç…§å‰æ–‡ï¼š<strong>é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–</strong>ï¼Œç•¥æœ‰ä¿®æ”¹</p><p>å½“æ–‡æœ¬æˆæ®µåï¼Œä¸èƒ½ç›´æ¥é€šè¿‡<code>draw.text</code>ç­‰æ–¹æ³•å°†æ–‡æœ¬å†™ä½œä¸€è¡Œï¼Œè€Œæ˜¯è¦è®¾ç½®æ¯è¡Œæ–‡æœ¬ä¸å¾—è¶…è¿‡æ®µè½å—çš„é•¿åº¦ï¼Œå¹¶ä¸”æ€»è¡Œæ•°ä¸èƒ½è¶…å‡ºæ®µè½å—æ€»é•¿åº¦ã€‚éœ€è¦è®¾è®¡ç®—æ³•ï¼Œå½“æ¯è¡Œæ–‡æœ¬è¶…å‡ºé•¿åº¦é™åˆ¶æ—¶ï¼Œè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ã€‚</p><h3 id="æ®µè½æ¢è¡Œç®—æ³•"><a href="#æ®µè½æ¢è¡Œç®—æ³•" class="headerlink" title="æ®µè½æ¢è¡Œç®—æ³•"></a>æ®µè½æ¢è¡Œç®—æ³•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisualizeOCR</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, im, layout_boxes, texts, figures)</span>:</span></span><br><span class="line">        self.boxes = layout_boxes</span><br><span class="line">        self.texts = texts</span><br><span class="line">        self.figures = figures</span><br><span class="line">        <span class="keyword">if</span> isinstance(im, str):</span><br><span class="line">            self.im = Image.open(im)</span><br><span class="line">            self.im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">            self.im = cv2.cvtColor(im, cv2.COLOR_RGB2BGR)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">        self.im = Image.fromarray(self.im)</span><br><span class="line">        self.im = self.im.convert(<span class="string">'RGBA'</span>)</span><br><span class="line">        self.size = (int(self.im.size[<span class="number">0</span>]), int(self.im.size[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">split_text</span><span class="params">(self, width, sentence, font)</span>:</span></span><br><span class="line">        <span class="comment"># æŒ‰è§„å®šå®½åº¦åˆ†ç»„</span></span><br><span class="line">        max_line_height, total_lines = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        allText = []</span><br><span class="line">        <span class="keyword">for</span> sen <span class="keyword">in</span> sentence.split(<span class="string">'\n'</span>):</span><br><span class="line">            paragraph_content, line_height, line_count = self.get_paragraph(sen, width, font)</span><br><span class="line">            max_line_height = max(line_height, max_line_height)</span><br><span class="line">            total_lines += line_count</span><br><span class="line">            allText.append((paragraph_content, line_count))</span><br><span class="line">        line_height = max_line_height</span><br><span class="line">        total_height = total_lines * line_height</span><br><span class="line">        <span class="keyword">return</span> allText, total_height, line_height</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paragraph</span><span class="params">(text, width, font)</span>:</span></span><br><span class="line">        txt = Image.new(<span class="string">'RGBA'</span>, (<span class="number">1920</span>, <span class="number">1080</span>), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>))</span><br><span class="line">        draw = ImageDraw.Draw(txt)</span><br><span class="line">        <span class="comment"># æ‰€æœ‰æ–‡å­—çš„æ®µè½</span></span><br><span class="line">        paragraph_content = <span class="string">""</span></span><br><span class="line">        <span class="comment"># å®½åº¦æ€»å’Œ</span></span><br><span class="line">        sum_width = <span class="number">0</span></span><br><span class="line">        <span class="comment"># è¡Œæ•°</span></span><br><span class="line">        line_count = <span class="number">0</span></span><br><span class="line">        <span class="comment"># è¡Œé«˜</span></span><br><span class="line">        line_height = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">            _, _, w, h = draw.textbbox((<span class="number">0</span>, <span class="number">0</span>), char, font=font)</span><br><span class="line"></span><br><span class="line">            sum_width += w</span><br><span class="line">            <span class="keyword">if</span> sum_width &gt; width:  <span class="comment"># è¶…è¿‡é¢„è®¾å®½åº¦å°±ä¿®æ”¹æ®µè½ ä»¥åŠå½“å‰è¡Œæ•°</span></span><br><span class="line">                line_count += <span class="number">1</span></span><br><span class="line">                sum_width = <span class="number">0</span></span><br><span class="line">                paragraph_content += <span class="string">'\n'</span></span><br><span class="line">            paragraph_content += char</span><br><span class="line">            line_height = max(h, line_height)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> paragraph_content.endswith(<span class="string">'\n'</span>):</span><br><span class="line">            paragraph_content += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> paragraph_content, line_height, line_count</span><br></pre></td></tr></table></figure><h3 id="æ®µè½å­—ä½“å¤§å°ç®—æ³•"><a href="#æ®µè½å­—ä½“å¤§å°ç®—æ³•" class="headerlink" title="æ®µè½å­—ä½“å¤§å°ç®—æ³•"></a>æ®µè½å­—ä½“å¤§å°ç®—æ³•</h3><p>å®ç°æ¢è¡Œåï¼Œè¿˜éœ€è¦è€ƒè™‘å­—ä½“çš„å¤§å°ï¼Œå°†æ–‡å­—é”å®šåœ¨æ–‡æœ¬æ¡†å†…ã€‚åœ¨pillowåº“ä¸­<code>draw.text</code>æ–¹æ³•ä¸­ä¸­æ–‡å­—ç¬¦çš„å¤§å°è¿‘ä¼¼äºå…¶æ­£æ–¹çŸ©å½¢åƒç´ å—çš„è¾¹é•¿ã€‚æ¥ä¸‹æ¥éœ€è¦è€ƒè™‘çš„å‚æ•°å˜é‡æœ‰ä¸‰ä¸ªï¼š</p><p><strong>1.æ¯è¡Œæœ€å¤šçš„å­—ç¬¦xï¼ˆx_numï¼‰;</strong></p><p><strong>2.æ€»è¡Œæ•°yï¼ˆy_numï¼‰;</strong></p><p><strong>3.å­—ä½“åƒç´ sï¼ˆtext_scaleï¼‰</strong></p><p>åŒæ—¶è€ƒè™‘åˆ°å¹¶ä¸æ˜¯æ¯è¡Œéƒ½èƒ½å¤Ÿå†™æ»¡æ®µè½å—çš„é•¿åº¦ï¼Œå¯èƒ½å­˜åœ¨æå‰æ¢è¡Œã€ç©ºè¡Œã€ç»“æŸç­‰æƒ…å†µã€‚å¯ä»¥è®¡ç®—æ®µè½çš„æ€»æ¢è¡Œç¬¦æ•°é‡ï¼ˆcount(â€˜\nâ€™)ï¼‰ï¼Œå°†æ¢è¡Œç¬¦å‡ºç°çš„åœ°æ–¹è§†ä½œç©ºè¡Œï¼Œå¹¶Ã—2ç®—ä½œæ¢è¡Œ+ç•™ç™½éƒ¨åˆ†äº§ç”Ÿçš„åƒç´ é¢ç§¯ã€‚é‚£ä¹ˆå·²çŸ¥å¸¸é‡åŒ…æ‹¬ï¼š</p><p><strong>1.æ¢è¡Œæ¬¡æ•°bï¼ˆblank_scaleï¼‰ï¼›</strong></p><p><strong>2.æ€»å­—æ•°lï¼ˆlen(text)ï¼‰ï¼›</strong></p><p><strong>3.æ®µè½æ¡†é•¿åº¦wï¼ˆwidth_pï¼Œå€¼å–width*0.97ï¼Œå‡å°‘å‡ºç•Œæ¦‚ç‡ï¼‰</strong></p><p><strong>3.æ®µè½æ¡†å®½åº¦hï¼ˆheightï¼‰</strong></p><h4 id="è®¾ç«‹æ–¹ç¨‹ç»„ï¼š"><a href="#è®¾ç«‹æ–¹ç¨‹ç»„ï¼š" class="headerlink" title="è®¾ç«‹æ–¹ç¨‹ç»„ï¼š"></a>è®¾ç«‹æ–¹ç¨‹ç»„ï¼š</h4><p><strong><font color="gold">{</font></strong></p><p><strong><font color="gold">â‘  (y-b)*x=l</font></strong></p><p><strong><font color="gold">â‘¡ x*s = w</font></strong></p><p><strong><font color="gold">â‘¢ y*s = h</font></strong></p><p><strong><font color="gold">{</font></strong></p><h4 id="è½¬æ¢åˆ°ä»£ç ä¸­ï¼š"><a href="#è½¬æ¢åˆ°ä»£ç ä¸­ï¼š" class="headerlink" title="è½¬æ¢åˆ°ä»£ç ä¸­ï¼š"></a>è½¬æ¢åˆ°ä»£ç ä¸­ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(y_num - blank_scale) * x_num = len(text)</span><br><span class="line">x_num * text_scale = width_p</span><br><span class="line">y_num * text_scale = height</span><br></pre></td></tr></table></figure><h4 id="ç®€åŒ–æ–¹ç¨‹ç»„ï¼š"><a href="#ç®€åŒ–æ–¹ç¨‹ç»„ï¼š" class="headerlink" title="ç®€åŒ–æ–¹ç¨‹ç»„ï¼š"></a>ç®€åŒ–æ–¹ç¨‹ç»„ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(y_num - blank_scale) * x_num = len(text)</span><br><span class="line">x_num * text_scale = width_p</span><br><span class="line">y_num * text_scale = height</span><br><span class="line">===&gt;</span><br><span class="line">x_num = len(text) / (y_num - blank_scale)</span><br><span class="line">x_num = width_p / text_scale</span><br><span class="line">width_p / text_scale = len(text) / ((height / text_scale) - blank_scale)</span><br><span class="line">===&gt;</span><br><span class="line">len(text) * text_scale * text_scale + blank_scale * width_p * text_scale - width_p * height = <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="è§£æ–¹ç¨‹ï¼š"><a href="#è§£æ–¹ç¨‹ï¼š" class="headerlink" title="è§£æ–¹ç¨‹ï¼š"></a>è§£æ–¹ç¨‹ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quadratic</span><span class="params">(a, b, c)</span>:</span></span><br><span class="line">    n = b * b - <span class="number">4</span> * a * c</span><br><span class="line">    <span class="keyword">import</span> math</span><br><span class="line">    <span class="keyword">if</span> n &gt;= <span class="number">0</span>:</span><br><span class="line">        x1 = (-b + math.sqrt(n)) / (<span class="number">2</span> * a)</span><br><span class="line">        x2 = (-b - math.sqrt(n)) / (<span class="number">2</span> * a)</span><br><span class="line">        <span class="keyword">return</span> x1 <span class="keyword">if</span> x1 &gt; <span class="number">0</span> <span class="keyword">else</span> x2</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure><h4 id="è·å–æœ€ç»ˆå­—å·ï¼š"><a href="#è·å–æœ€ç»ˆå­—å·ï¼š" class="headerlink" title="è·å–æœ€ç»ˆå­—å·ï¼š"></a>è·å–æœ€ç»ˆå­—å·ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">text_scale = int(quadratic(<span class="number">3</span> * len(text), <span class="number">3</span> * blank_scale * width_p, <span class="number">2</span> * -width_p * height))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sen, line_count <span class="keyword">in</span> paragraph_content:</span><br><span class="line">    draw.text((x, y), sen, fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), font=font)</span><br><span class="line">    y += line_height * line_count</span><br></pre></td></tr></table></figure><h3 id="ç‰ˆé¢æ¢å¤"><a href="#ç‰ˆé¢æ¢å¤" class="headerlink" title="ç‰ˆé¢æ¢å¤"></a>ç‰ˆé¢æ¢å¤</h3><p>æœ€ç»ˆçš„ç¿»è¯‘æ­¥éª¤ä¸­éœ€è¦å°†IoUèšåˆå¥½çš„æ®µè½æˆ–æœªèšåˆçš„å†…å®¹æäº¤ç»™ç¿»è¯‘æ¨¡å‹ã€‚æ­¤æ—¶å¯ä»¥é€‰æ‹©å•ç‹¬æ–°å¼€é¡µé¢è¿˜åŸæ–‡æ¡£æˆ–åœ¨åŸæ–‡æ¡£ä¸Šè¿›è¡ŒPå›¾ä¿®æ”¹ã€‚è¿™é‡Œä½¿ç”¨é«˜æ–¯æ¨¡ç³Šç®—æ³•ç›´æ¥åœ¨åŸå›¾è¿›è¡Œä¿®æ”¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">im_rectangle = self.im.crop((box[<span class="number">0</span>][<span class="number">0</span>], box[<span class="number">0</span>][<span class="number">1</span>], box[<span class="number">2</span>][<span class="number">0</span>], box[<span class="number">2</span>][<span class="number">1</span>]))</span><br><span class="line">im_rectangle = im_rectangle.filter(ImageFilter.GaussianBlur(radius=<span class="number">2000</span>))</span><br><span class="line">self.im.paste(im_rectangle, (box[<span class="number">0</span>][<span class="number">0</span>], box[<span class="number">0</span>][<span class="number">1</span>]))</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œæ‰€æœ‰é€»è¾‘éƒ¨åˆ†å·²å°è£…å®Œæˆï¼Œæ¥ä¸‹æ¥å¯ä»¥è¿›è¡Œæµ‹è¯•è°ƒç”¨æ¨¡å‹å’Œä»£ç ã€‚</p><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ocr_api = <span class="string">'host:7773/ai/surya/ocr'</span></span><br><span class="line">    ocr_lang = <span class="string">'vi'</span></span><br><span class="line">    img = cv2.imread(<span class="string">'imgs/vi.png'</span>)</span><br><span class="line">    ocr_layout_paragraphs, \</span><br><span class="line">        ocr_layout_boxes_list, \</span><br><span class="line">        ocr_layout_paragraphs_list, \</span><br><span class="line">        ocr_layout_figures_list = get_layout_img(img, ocr_api, ocr_lang)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç»“æœå¯è§†åŒ–</span></span><br><span class="line">    vo = VisualizeOCR(img, ocr_layout_boxes_list, ocr_layout_paragraphs_list, ocr_layout_figures_list)</span><br><span class="line">    translated_image = vo.visualize_ocr()</span><br><span class="line">    cv2.imwrite(<span class="string">'output.png'</span>, translated_image)</span><br></pre></td></tr></table></figure><p>ç‰ˆé¢æ¢å¤å¯è§†åŒ–ï¼š</p><p><img src="/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/4.png" alt></p><p>ç¿»è¯‘å¯è§†åŒ–ï¼š</p><p><img src="/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/5.png" alt></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ–‡ç®€å•ä»‹ç»è¿‡&lt;strong&gt;é—´éš™Â·æ ‘Â·æ’åºç®—æ³•&lt;/strong&gt;ä»¥åŠå…¶æ›´æ”¹è¿‡çš„å¯è§†åŒ–è¿‡ç¨‹ã€‚ä½†æ˜¯ç”±äºç®—æ³•æœ¬èº«æ˜¯å¯¹çº¯æ–‡æœ¬å—è¿›è¡Œæ’åºï¼Œå½“é‡åˆ°è¾ƒä¸ºå¤æ‚çš„å›¾åƒç»“æ„æ—¶ï¼Œç”±äºç¼ºå°‘åŸå§‹å›¾åƒä¿¡æ¯ï¼Œå­˜åœ¨ä¸¢å¤±å›¾ç‰‡ç±»å‹æ•°æ®ã€æ— æ³•ç†è§£è¡¨æ ¼ç­‰é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;æ­¤ç®—æ³•çš„è·Ÿè¿›ç‰ˆç›®æ ‡åœ¨äºå¯¹æ’åºç®—æ³•çš„åç»­æ“ä½œæä¾›æ›´ä¸ºç²¾ç¡®çš„ç‰ˆé¢æ¢å¤ï¼Œæ•…åç§°æ²¿ç”¨è‡ªé—´éš™Â·æ ‘Â·æ’åºç®—æ³•ï¼ˆé¡¹ç›®åœ°å€ï¼š&lt;a href=&quot;https://github.com/hiroi-sora/GapTree_Sort_Algorithm&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/hiroi-sora/GapTree_Sort_Algorithm&lt;/a&gt;ï¼‰ï¼Œå‘½å&lt;strong&gt;é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”ï¼ˆIoUï¼‰èšç±»ç®—æ³•&lt;/strong&gt;ï¼Œä»¥ä¸‹ç®€ç§°GTIoUCã€‚ç®—æ³•çš„æœ€ç»ˆç›®çš„ä¸ä¼ ç»ŸOCRæˆ–ç‰ˆé¢æ¢å¤ä¸åŒï¼Œæ—¨åœ¨å°†OCRç»“æœåœ¨ç‰ˆé¢åˆ†æç»“æœä¸­èšåˆæˆåŒ…å«å®Œæ•´è¯­ä¹‰çš„æ®µè½ï¼Œä¸ºç¿»è¯‘æä¾›æœåŠ¡ã€‚&lt;/p&gt;
&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;GTIoUCåŒ…å«çš„ç®—æ³•ï¼š&lt;/strong&gt;&lt;/font&gt; &lt;em&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â¶&lt;/font&gt; &lt;strong&gt;GapTreeæä¾›çš„æ–‡æœ¬å—æ’åºç®—æ³•ï¼›&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â·&lt;/font&gt; &lt;strong&gt;åŸºäºYOLOçš„ç‰ˆé¢åˆ†æç®—æ³•ï¼›&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â¸&lt;/font&gt; &lt;strong&gt;OCR boxå’Œ YOLO layoutboxä¹‹é—´çš„äº¤å¹¶æ¯”èšç±»ç®—æ³•&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;GTIoUCè§£å†³çš„é—®é¢˜ï¼š&lt;/strong&gt;&lt;/font&gt;&lt;/em&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â¶&lt;/font&gt; &lt;strong&gt;ä»…ä»…ç‰ˆé¢åˆ†æçš„æ•ˆæœä¸å¤Ÿç²¾ç¡®ï¼›&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â·&lt;/font&gt; &lt;strong&gt;ç‰ˆé¢åˆ†æåå†…å®¹æ€»æ˜¯å­˜åœ¨ç¼ºå¤±ï¼›&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â¸&lt;/font&gt; &lt;strong&gt;ç‰ˆé¢åˆ†æè·å¾—å›¾åƒç»“æ„åå¾€å¾€ä¸å†OCRå›¾åƒä¸­æ–‡å­—ï¼›&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;â¹&lt;/font&gt; &lt;strong&gt;OCRç»“æœæŒ‰è¡Œè¿”å›ï¼Œæ— æ®µè½ç»“æ„ï¼Œä¸Šä¸‹æ–‡è¯­ä¹‰å­˜åœ¨ç¼ºå¤±ï¼›&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;/font&gt;

&lt;h1 id=&quot;GapTreeIoU-Cluster-Algorithm-é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•&quot;&gt;&lt;a href=&quot;#GapTreeIoU-Cluster-Algorithm-é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•&quot; class=&quot;headerlink&quot; title=&quot;GapTreeIoU_Cluster_Algorithm | é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#0099ee&quot;&gt;GapTreeIoU_Cluster_Algorithm | é—´éš™Â·æ ‘Â·äº¤å¹¶æ¯”èšç±»ç®—æ³•&lt;/font&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2025/01/10/é—´éš™æ ‘äº¤å¹¶æ¯”èšç±»ç®—æ³•/0.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;GTIoUCç®—æ³•çš„ç‰¹æ®Šä¹‹å¤„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;â¶&lt;/font&gt; &lt;strong&gt;PPStructureç­‰ç‰ˆé¢åˆ†æç®—æ³•éœ€è¦æ ¹æ®ç‰ˆé¢åˆ†æç»“æœåšNæ¬¡æˆªå–ç‰‡æ®µOCRï¼Œä½†æ˜¯ä¼ å…¥OCRæ¨¡å‹çš„&lt;code&gt;det_limit_side_len&lt;/code&gt;å‚æ•°æ€»æ˜¯å›ºå®šçš„ï¼Œå¯¼è‡´OCRç»å¸¸æå–ä¸åˆ°ç›¸åº”ç»“æœï¼Œäº§ç”Ÿç©ºç™½é¡µã€‚ç®—æ³•æ¨¡å‹å±‚é¢æ¯è½®ä»…åš1æ¬¡å®Œæ•´çš„å…¨æ–‡OCRå’Œ1æ¬¡Layoutï¼Œè§£å†³OCRç©ºç™½é¡µçš„åŒæ—¶ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–äº†æ—¶é—´å¤æ‚åº¦ï¼›&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;â·&lt;/font&gt; &lt;strong&gt;ç®—æ³•çš„ç‰ˆé¢åˆ†ææ¨¡å‹ç”±YOLOV11ç»“åˆDocLayNetæ•°æ®é›†è®­ç»ƒå¾—åˆ°ï¼Œç²¾åº¦è¾ƒæ—©æœŸæ¨¡å‹å…·æœ‰è¾ƒå¤§æå‡ï¼Œé€‚ç”¨äºå¤æ‚æ–‡æ¡£ï¼Œæ³›åŒ–èƒ½åŠ›é«˜çš„åŒæ—¶å…¼é¡¾äº†å¤šè¯­ç§è¯†åˆ«ï¼›&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;â¸&lt;/font&gt; &lt;strong&gt;å°½ç®¡å¦‚æ­¤ï¼Œç›®å‰ä»»ä½•ç‰ˆé¢æ¢å¤æ¨¡å‹ä»æ—§ä¸å…·å¤‡100%æ•è·æ–‡æ¡£ä¿¡æ¯çš„èƒ½åŠ›ã€‚æ­¤æ—¶ç”±äºç®—æ³•çš„OCRéƒ¨åˆ†å’ŒLayoutéƒ¨åˆ†æ˜¯ç›¸å¯¹ç‹¬ç«‹è¿›è¡Œçš„ï¼Œæœ€ç»ˆOCRå’ŒLayoutçš„ç»“æœå°†è¿›è¡ŒIoUèšç±»ï¼ŒIoUè¿‡ç¨‹ä¸­å…ˆå‰Layoutç¼ºå¤±çš„ä¿¡æ¯å°†è¢«OCRç»“æœè¡¥å……ã€å¾—åˆ°æ®µè½å®Œæ•´è¯­ä¹‰ï¼Œæå¤§ç¨‹åº¦ä¸Šæé«˜äº†ç‰ˆé¢æ¢å¤çš„å‡†ç¡®åº¦ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢å°†è¯¦ç»†ä»‹ç»GTIoUCçš„ç‰ˆé¢æ¢å¤æµç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="http://yoursite.com/categories/ç®—æ³•/"/>
    
    
    <category term="OCR" scheme="http://yoursite.com/tags/OCR/"/>
    
    <category term="yolo" scheme="http://yoursite.com/tags/yolo/"/>
    
  </entry>
  
  <entry>
    <title>å…³é”®ä¿¡æ¯æå–ï¼ˆKIEï¼‰</title>
    <link href="http://yoursite.com/2024/11/26/%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%EF%BC%88KIE%EF%BC%89/"/>
    <id>http://yoursite.com/2024/11/26/%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96%EF%BC%88KIE%EF%BC%89/</id>
    <published>2024-11-26T11:24:34.000Z</published>
    <updated>2025-02-08T07:47:57.131Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="æœåŠ¡å™¨"><a href="#æœåŠ¡å™¨" class="headerlink" title="æœåŠ¡å™¨"></a>æœåŠ¡å™¨</h3><font color="gold"><strong>Â· OS: </strong></font>CentOS7.9<br><br><font color="gold"><strong>Â· GPU:  </strong></font>RTX3090 24G*2<br><br><font color="gold"><strong>Â· CUDA: </strong></font>11.7<br><br><font color="gold"><strong>Â· CUDNN: </strong></font>8.9.2<font color="gold"></font><h3 id="é£æ¡¨"><a href="#é£æ¡¨" class="headerlink" title="é£æ¡¨"></a>é£æ¡¨</h3><font color="gold"><strong>Â· paddlepaddle:</strong></font>  paddlepaddle-gpu==2.4.2ï¼ˆcudatoolkit=11.7ï¼Œå»ºè®®condaå®‰è£…ï¼‰<br><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge</span><br></pre></td></tr></table></figure><br><br><font color="gold"><strong>Â· paddleocr:</strong></font>  2.9.1<br><br><font color="gold"><strong>Â· paddlenlp:</strong></font>  2.5.2<font color="gold"></font><h3 id="é¡¹ç›®ä¾èµ–"><a href="#é¡¹ç›®ä¾èµ–" class="headerlink" title="é¡¹ç›®ä¾èµ–"></a>é¡¹ç›®ä¾èµ–</h3><p><code>requirements.txt</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># paddlepaddle 2.4.2 æ³¨ï¼šå¿…é¡»</span><br><span class="line"># conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge</span><br><span class="line"></span><br><span class="line">shapely</span><br><span class="line">scikit-image</span><br><span class="line">pyclipper</span><br><span class="line">lmdb</span><br><span class="line">tqdm</span><br><span class="line">numpy</span><br><span class="line">rapidfuzz</span><br><span class="line">opencv-python</span><br><span class="line">opencv-contrib-python</span><br><span class="line">cython</span><br><span class="line">Pillow</span><br><span class="line">pyyaml</span><br><span class="line">requests</span><br><span class="line">albumentations==1.4.10</span><br><span class="line"># to be compatible with albumentations</span><br><span class="line">albucore==0.0.13</span><br><span class="line"></span><br><span class="line">sentencepiece</span><br><span class="line">yacs</span><br><span class="line">seqeval</span><br><span class="line">pypandoc</span><br><span class="line">attrdict3</span><br><span class="line">python_docx</span><br><span class="line">paddlenlp==2.5.2</span><br></pre></td></tr></table></figure><font color="red"><strong>æ³¨ï¼š</strong></font><strong>bugfix</strong><br><br><font color="gold"></font><font color="gold"><strong>1.</strong></font><code>ModuleNotFoundError: No module named &#39;ppocr.***&#39;</code><br><br>å‰å¾€å®˜æ–¹githubä¸»é¡µï¼ˆ<a href="https://github.com/PaddlePaddle/PaddleOCR" target="_blank" rel="noopener">https://github.com/PaddlePaddle/PaddleOCR</a>ï¼‰è¡¥é½æºç åˆ°pythonç¯å¢ƒ<br><br>e.g.conda è™šæ‹Ÿç¯å¢ƒä¸‹ï¼Œéœ€è¦è¡¥é½çš„æºç æ ¹ç›®å½•ä¸ºï¼š<code>/root/anaconda3/envs/py39_kie/lib/python3.9/site-packages/paddleocr/ppocr</code><br><br><font color="gold"><strong>2.</strong></font>ModuleNotFoundError: No module named â€˜paddle.fluidâ€™<br><br>å®‰è£…è¾ƒä½ç‰ˆæœ¬paddle <code>paddlepaddle2.4.2/2.5.0</code><br><br><font color="gold"><strong>3.</strong></font>ç±»å‹é”™è¯¯ï¼š<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InvalidArgumentError: The type of data we are trying to retrieve does not match the type of data currently contained in the container.</span><br><span class="line">      [Hint: Expected dtype() == paddle::experimental::CppTypeToDataType&lt;T&gt;::Type(), but received dtype():10 != paddle::experimental::CppTypeToDataType&lt;T&gt;::Type():9.] (at /paddle/paddle/phi/core/dense_tensor.cc:143)</span><br><span class="line">      [operator &lt; less_equal &gt; error]</span><br></pre></td></tr></table></figure><br><br>å®˜æ–¹ç¤ºä¾‹bugï¼Œéœ€è¦æ·»åŠ å‚æ•°é¡¹<strong><code>--use_visual_backbone = False</code></strong><font color="gold"></font><a id="more"></a><h2 id="æ¨¡å‹"><a href="#æ¨¡å‹" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h2><p>å‚è€ƒï¼š<a href="https://paddlepaddle.github.io/PaddleOCR/latest/ppstructure/model_train/train_kie.html" target="_blank" rel="noopener">https://paddlepaddle.github.io/PaddleOCR/latest/ppstructure/model_train/train_kie.html</a></p><h3 id="å‡†å¤‡ï¼ˆinferenceæ¨¡å‹ï¼‰"><a href="#å‡†å¤‡ï¼ˆinferenceæ¨¡å‹ï¼‰" class="headerlink" title="å‡†å¤‡ï¼ˆinferenceæ¨¡å‹ï¼‰"></a>å‡†å¤‡ï¼ˆinferenceæ¨¡å‹ï¼‰</h3><p>SERä»»åŠ¡æ¨¡å‹ä¸‹è½½é“¾æ¥ï¼š<a href="https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/ser_vi_layoutxlm_xfund_infer.tar" target="_blank" rel="noopener">https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/ser_vi_layoutxlm_xfund_infer.tar</a></p><p>REä»»åŠ¡æ¨¡å‹ä¸‹è½½é“¾æ¥ï¼š<a href="https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/re_vi_layoutxlm_xfund_infer.tar" target="_blank" rel="noopener">https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/re_vi_layoutxlm_xfund_infer.tar</a></p><p>åˆ›å»ºé¡¹ç›®æ ¹ç›®å½•<code>demo</code>å¹¶æ·»åŠ æµ‹è¯•å›¾ç‰‡<code>1.png</code>ï¼Œåœ¨<code>demo</code>ç›®å½•ä¸‹æ–°å»º<code>models</code>æ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾OCRã€SERã€REæ¨¡å‹ã€å­—å…¸æ–‡ä»¶ã€å­—ä½“æ–‡ä»¶ã€‚å…¶ä¸­OCRæ¨¡å‹å¯ä½¿ç”¨ppocrv3ã€v4ç‰ˆæœ¬ä¸‹æ£€æµ‹å’Œè¯†åˆ«ï¼ˆdet/recï¼‰æ¨¡å‹ï¼Œå­—å…¸æ–‡ä»¶å¤åˆ¶æºç ç›®å½•ä¸‹<code>paddleocr/ppocr/utils/dict/kie_dict/xfund_class_list.txt</code>ï¼Œå­—ä½“æ–‡ä»¶ä½¿ç”¨<code>simfang.ttf</code></p><h3 id="SER-REæ¨¡å‹ä¸²è”"><a href="#SER-REæ¨¡å‹ä¸²è”" class="headerlink" title="SER/REæ¨¡å‹ä¸²è”"></a>SER/REæ¨¡å‹ä¸²è”</h3><font color="gold"><strong>1.</strong></font>åˆ›å»ºå®˜æ–¹ä»£ç ç¤ºä¾‹<code>demo/test.py</code>ç”¨äºæµ‹è¯•å’Œæ˜¾ç¤ºå›¾åƒï¼ˆæºç ï¼š<code>paddleocr/ppstructure/kie/predict_kie_token_ser_re.py</code>ï¼‰<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2022 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">"../.."</span>)))</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">"FLAGS_allocator_strategy"</span>] = <span class="string">"auto_growth"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.infer.utility <span class="keyword">as</span> utility</span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.infer_kie_token_ser_re <span class="keyword">import</span> make_input</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.postprocess <span class="keyword">import</span> build_post_process</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.logging <span class="keyword">import</span> get_logger</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.visual <span class="keyword">import</span> draw_ser_results, draw_re_results</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.utility <span class="keyword">import</span> get_image_file_list, check_and_read</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.utility <span class="keyword">import</span> parse_args</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.kie.predict_kie_token_ser <span class="keyword">import</span> SerPredictor</span><br><span class="line"></span><br><span class="line">logger = get_logger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerRePredictor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.use_visual_backbone = args.use_visual_backbone</span><br><span class="line">        self.ser_engine = SerPredictor(args)</span><br><span class="line">        <span class="keyword">if</span> args.re_model_dir <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            postprocess_params = &#123;<span class="string">"name"</span>: <span class="string">"VQAReTokenLayoutLMPostProcess"</span>&#125;</span><br><span class="line">            self.postprocess_op = build_post_process(postprocess_params)</span><br><span class="line">            (</span><br><span class="line">                self.predictor,</span><br><span class="line">                self.input_tensor,</span><br><span class="line">                self.output_tensors,</span><br><span class="line">                self.config,</span><br><span class="line">            ) = utility.create_predictor(args, <span class="string">"re"</span>, logger)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.predictor = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        starttime = time.time()</span><br><span class="line">        ser_results, ser_inputs, ser_elapse = self.ser_engine(img)</span><br><span class="line">        <span class="keyword">if</span> self.predictor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ser_results, ser_elapse</span><br><span class="line"></span><br><span class="line">        re_input, entity_idx_dict_batch = make_input(ser_inputs, ser_results)</span><br><span class="line">        <span class="keyword">if</span> self.use_visual_backbone == <span class="literal">False</span>:</span><br><span class="line">            re_input.pop(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(self.input_tensor)):</span><br><span class="line">            self.input_tensor[idx].copy_from_cpu(re_input[idx])</span><br><span class="line"></span><br><span class="line">        self.predictor.run()</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> output_tensor <span class="keyword">in</span> self.output_tensors:</span><br><span class="line">            output = output_tensor.copy_to_cpu()</span><br><span class="line">            outputs.append(output)</span><br><span class="line">        preds = dict(</span><br><span class="line">            loss=outputs[<span class="number">1</span>],</span><br><span class="line">            pred_relations=outputs[<span class="number">2</span>],</span><br><span class="line">            hidden_states=outputs[<span class="number">0</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        post_result = self.postprocess_op(</span><br><span class="line">            preds, ser_results=ser_results, entity_idx_dict_batch=entity_idx_dict_batch</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        elapse = time.time() - starttime</span><br><span class="line">        <span class="keyword">return</span> post_result, elapse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(args)</span>:</span></span><br><span class="line">    image_file_list = get_image_file_list(args.image_dir)</span><br><span class="line">    ser_re_predictor = SerRePredictor(args)</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    total_time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    os.makedirs(args.output, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> open(</span><br><span class="line">            os.path.join(args.output, <span class="string">"infer.txt"</span>), mode=<span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span></span><br><span class="line">    ) <span class="keyword">as</span> f_w:</span><br><span class="line">        <span class="keyword">for</span> image_file <span class="keyword">in</span> image_file_list:</span><br><span class="line">            img, flag, _ = check_and_read(image_file)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">                img = cv2.imread(image_file)</span><br><span class="line">                img = img[:, :, ::<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                logger.info(<span class="string">"error in loading image:&#123;&#125;"</span>.format(image_file))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            re_res, elapse = ser_re_predictor(img)</span><br><span class="line">            re_res = re_res[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            res_str = <span class="string">"&#123;&#125;\t&#123;&#125;\n"</span>.format(</span><br><span class="line">                image_file,</span><br><span class="line">                json.dumps(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"ocr_info"</span>: re_res,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ensure_ascii=<span class="literal">False</span>,</span><br><span class="line">                ),</span><br><span class="line">            )</span><br><span class="line">            f_w.write(res_str)</span><br><span class="line">            <span class="keyword">if</span> ser_re_predictor.predictor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                img_res = draw_re_results(</span><br><span class="line">                    image_file, re_res, font_path=args.vis_font_path</span><br><span class="line">                )</span><br><span class="line">                img_save_path = os.path.join(</span><br><span class="line">                    args.output,</span><br><span class="line">                    os.path.splitext(os.path.basename(image_file))[<span class="number">0</span>] + <span class="string">"_ser_re.jpg"</span>,</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img_res = draw_ser_results(</span><br><span class="line">                    image_file, re_res, font_path=args.vis_font_path</span><br><span class="line">                )</span><br><span class="line">                img_save_path = os.path.join(</span><br><span class="line">                    args.output,</span><br><span class="line">                    os.path.splitext(os.path.basename(image_file))[<span class="number">0</span>] + <span class="string">"_ser.jpg"</span>,</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            cv2.imwrite(img_save_path, img_res)</span><br><span class="line">            logger.info(<span class="string">"save vis result to &#123;&#125;"</span>.format(img_save_path))</span><br><span class="line">            <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">                total_time += elapse</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            logger.info(<span class="string">"Predict time of &#123;&#125;: &#123;&#125;"</span>.format(image_file, elapse))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    args.mode = <span class="string">'kie'</span></span><br><span class="line">    args.use_visual_backbone = <span class="literal">False</span></span><br><span class="line">    args.kie_algorithm = <span class="string">'LayoutXLM'</span></span><br><span class="line">    args.re_model_dir = <span class="string">'./models/re_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_model_dir = <span class="string">'./models/ser_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_dict_path = <span class="string">'./models/xfund_class_list.txt'</span></span><br><span class="line">    args.vis_font_path = <span class="string">'./models/simfang.ttf'</span></span><br><span class="line">    args.ocr_order_method = <span class="string">"tb-yx"</span></span><br><span class="line">    args.det_model_dir = <span class="string">'./models/ch_PP-OCRv3_det_infer'</span></span><br><span class="line">    args.rec_model_dir = <span class="string">'./models/ch_PP-OCRv4_rec_infer'</span></span><br><span class="line">    args.image_dir = <span class="string">'./1.png'</span></span><br><span class="line">    main(args)</span><br></pre></td></tr></table></figure><br><br><img src="/2024/11/26/å…³é”®ä¿¡æ¯æå–ï¼ˆKIEï¼‰/1.png" alt><br><br><font color="gold"><strong>2.</strong></font>åˆ›å»º<code>demo/main.py</code>ç”¨äºæµ‹è¯•<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.kie.predict_kie_token_ser_re <span class="keyword">import</span> SerRePredictor</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.utility <span class="keyword">import</span> parse_args</span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.infer_kie_token_ser_re <span class="keyword">import</span> make_input</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§æ‰¿SerRePredictorç±»ï¼Œé‡å†™__call__æ–¹æ³•ï¼Œå®ç°åŒæ—¶è¾“å‡ºSeræ¨¡å‹ç»“æœ</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KIE</span><span class="params">(SerRePredictor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, para)</span>:</span></span><br><span class="line">        super().__init__(para)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, im)</span>:</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        ser_results, ser_inputs, ser_elapse = self.ser_engine(im)</span><br><span class="line">        <span class="keyword">if</span> self.predictor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ser_results, ser_elapse</span><br><span class="line"></span><br><span class="line">        re_input, entity_idx_dict_batch = make_input(ser_inputs, ser_results)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.use_visual_backbone:</span><br><span class="line">            re_input.pop(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(self.input_tensor)):</span><br><span class="line">            self.input_tensor[idx].copy_from_cpu(re_input[idx])</span><br><span class="line"></span><br><span class="line">        self.predictor.run()</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> output_tensor <span class="keyword">in</span> self.output_tensors:</span><br><span class="line">            output = output_tensor.copy_to_cpu()</span><br><span class="line">            outputs.append(output)</span><br><span class="line">        preds = dict(</span><br><span class="line">            loss=outputs[<span class="number">1</span>],</span><br><span class="line">            pred_relations=outputs[<span class="number">2</span>],</span><br><span class="line">            hidden_states=outputs[<span class="number">0</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        post_result = self.postprocess_op(</span><br><span class="line">            preds, ser_results=ser_results, entity_idx_dict_batch=entity_idx_dict_batch</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        elapse_time = time.time() - start_time</span><br><span class="line">        <span class="keyword">return</span> ser_results, post_result, elapse_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    args.mode = <span class="string">'kie'</span></span><br><span class="line">    args.show_log = <span class="literal">True</span></span><br><span class="line">    args.use_visual_backbone = <span class="literal">False</span></span><br><span class="line">    args.kie_algorithm = <span class="string">'LayoutXLM'</span></span><br><span class="line">    args.re_model_dir = <span class="string">'./models/re_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_model_dir = <span class="string">'./models/ser_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_dict_path = <span class="string">'./models/xfund_class_list.txt'</span></span><br><span class="line">    args.vis_font_path = <span class="string">'./models/simfang.ttf'</span></span><br><span class="line">    args.ocr_order_method = <span class="string">"tb-yx"</span></span><br><span class="line">    args.det_model_dir = <span class="string">'./models/ch_PP-OCRv3_det_infer'</span></span><br><span class="line">    args.rec_model_dir = <span class="string">'./models/ch_PP-OCRv4_rec_infer'</span></span><br><span class="line">    args.det_limit_side_len = <span class="number">1600</span>,</span><br><span class="line"></span><br><span class="line">    kie = KIE(args)</span><br><span class="line">    img = cv2.imread(<span class="string">'./1.png'</span>)</span><br><span class="line">    ser_res, re_res, elapse = kie(img)</span><br><span class="line">    print(ser_res, <span class="string">'\n'</span>, re_res, <span class="string">'\n'</span>, elapse)</span><br></pre></td></tr></table></figure><br><br>è¾“å‡ºï¼š<font color="gold"></font><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[&#123;&apos;transcription&apos;: &apos;è¯å·&apos;, &apos;bbox&apos;: [239, 113, 267, 128], &apos;points&apos;: [[239.0, 113.0], [267.0, 113.0], [267.0, 128.0], [239.0, 128.0]], &apos;pred_id&apos;: 0, &apos;pred&apos;: &apos;O&apos;&#125;, &#123;&apos;transcription&apos;: &apos;T4105051990090&apos;, &apos;bbox&apos;: [240, 135, 441, 157], &apos;points&apos;: [[240.0, 135.0], [441.0, 136.0], [440.0, 157.0], [240.0, 156.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;å§“å&apos;, &apos;bbox&apos;: [239, 162, 266, 178], &apos;points&apos;: [[239.0, 162.0], [266.0, 162.0], [266.0, 178.0], [239.0, 178.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ä½œä¸šç±»åˆ«&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æ¯•å®&apos;, &apos;bbox&apos;: [237, 182, 296, 203], &apos;points&apos;: [[237.0, 182.0], [296.0, 182.0], [296.0, 203.0], [237.0, 203.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç„Šæ¥ä¸çƒ­åˆ‡å‰²ä½œä¸š&apos;, &apos;bbox&apos;: [432, 185, 586, 204], &apos;points&apos;: [[432.0, 185.0], [586.0, 185.0], [586.0, 204.0], [432.0, 204.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç”·&apos;, &apos;bbox&apos;: [237, 246, 259, 269], &apos;points&apos;: [[237.0, 246.0], [259.0, 246.0], [259.0, 269.0], [237.0, 269.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æ€§åˆ«&apos;, &apos;bbox&apos;: [238, 227, 269, 246], &apos;points&apos;: [[238.0, 227.0], [269.0, 227.0], [269.0, 246.0], [238.0, 246.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æ“ä½œé¡¹ç›®&apos;, &apos;bbox&apos;: [430, 228, 484, 245], &apos;points&apos;: [[430.0, 228.0], [484.0, 228.0], [484.0, 245.0], [430.0, 245.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç†”åŒ–ç„Šæ¥ä¸çƒ­åˆ‡å‰²ä½œä¸š&apos;, &apos;bbox&apos;: [432, 251, 622, 268], &apos;points&apos;: [[432.0, 251.0], [622.0, 251.0], [622.0, 268.0], [432.0, 268.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29&apos;, &apos;bbox&apos;: [71, 342, 173, 362], &apos;points&apos;: [[72.0, 342.0], [173.0, 345.0], [173.0, 362.0], [71.0, 360.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;åˆé¢†æ—¥æœŸ&apos;, &apos;bbox&apos;: [73, 325, 128, 341], &apos;points&apos;: [[73.0, 325.0], [128.0, 325.0], [128.0, 341.0], [73.0, 341.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æœ‰æ•ˆæœŸé™&apos;, &apos;bbox&apos;: [226, 327, 278, 342], &apos;points&apos;: [[226.0, 327.0], [278.0, 327.0], [278.0, 342.0], [226.0, 342.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29è‡³2029-03-28&apos;, &apos;bbox&apos;: [226, 345, 448, 362], &apos;points&apos;: [[226.0, 345.0], [448.0, 345.0], [448.0, 362.0], [226.0, 362.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2026-03-28å‰&apos;, &apos;bbox&apos;: [71, 389, 192, 413], &apos;points&apos;: [[72.0, 389.0], [192.0, 392.0], [192.0, 413.0], [71.0, 410.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;åº”å¤å®¡æ—¥æœŸ&apos;, &apos;bbox&apos;: [74, 373, 140, 390], &apos;points&apos;: [[74.0, 373.0], [140.0, 373.0], [140.0, 390.0], [74.0, 390.0]], &apos;pred_id&apos;: 0, &apos;pred&apos;: &apos;O&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç­¾å‘æœºå…³&apos;, &apos;bbox&apos;: [223, 374, 278, 393], &apos;points&apos;: [[223.0, 375.0], [277.0, 374.0], [278.0, 392.0], [224.0, 393.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æ²³å—çœåº”æ€¥ç®¡ç†å…&apos;, &apos;bbox&apos;: [224, 394, 378, 414], &apos;points&apos;: [[224.0, 394.0], [378.0, 394.0], [378.0, 414.0], [224.0, 414.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;]] </span><br><span class="line"> [[(&#123;&apos;transcription&apos;: &apos;å§“å&apos;, &apos;bbox&apos;: [239, 162, 266, 178], &apos;points&apos;: [[239.0, 162.0], [266.0, 162.0], [266.0, 178.0], [239.0, 178.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æ¯•å®&apos;, &apos;bbox&apos;: [237, 182, 296, 203], &apos;points&apos;: [[237.0, 182.0], [296.0, 182.0], [296.0, 203.0], [237.0, 203.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;ä½œä¸šç±»åˆ«&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç„Šæ¥ä¸çƒ­åˆ‡å‰²ä½œä¸š&apos;, &apos;bbox&apos;: [432, 185, 586, 204], &apos;points&apos;: [[432.0, 185.0], [586.0, 185.0], [586.0, 204.0], [432.0, 204.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;ä½œä¸šç±»åˆ«&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç†”åŒ–ç„Šæ¥ä¸çƒ­åˆ‡å‰²ä½œä¸š&apos;, &apos;bbox&apos;: [432, 251, 622, 268], &apos;points&apos;: [[432.0, 251.0], [622.0, 251.0], [622.0, 268.0], [432.0, 268.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;æ€§åˆ«&apos;, &apos;bbox&apos;: [238, 227, 269, 246], &apos;points&apos;: [[238.0, 227.0], [269.0, 227.0], [269.0, 246.0], [238.0, 246.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;ç”·&apos;, &apos;bbox&apos;: [237, 246, 259, 269], &apos;points&apos;: [[237.0, 246.0], [259.0, 246.0], [259.0, 269.0], [237.0, 269.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;åˆé¢†æ—¥æœŸ&apos;, &apos;bbox&apos;: [73, 325, 128, 341], &apos;points&apos;: [[73.0, 325.0], [128.0, 325.0], [128.0, 341.0], [73.0, 341.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29&apos;, &apos;bbox&apos;: [71, 342, 173, 362], &apos;points&apos;: [[72.0, 342.0], [173.0, 345.0], [173.0, 362.0], [71.0, 360.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;æœ‰æ•ˆæœŸé™&apos;, &apos;bbox&apos;: [226, 327, 278, 342], &apos;points&apos;: [[226.0, 327.0], [278.0, 327.0], [278.0, 342.0], [226.0, 342.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29è‡³2029-03-28&apos;, &apos;bbox&apos;: [226, 345, 448, 362], &apos;points&apos;: [[226.0, 345.0], [448.0, 345.0], [448.0, 362.0], [226.0, 362.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;ç­¾å‘æœºå…³&apos;, &apos;bbox&apos;: [223, 374, 278, 393], &apos;points&apos;: [[223.0, 375.0], [277.0, 374.0], [278.0, 392.0], [224.0, 393.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;æ²³å—çœåº”æ€¥ç®¡ç†å…&apos;, &apos;bbox&apos;: [224, 394, 378, 414], &apos;points&apos;: [[224.0, 394.0], [378.0, 394.0], [378.0, 414.0], [224.0, 414.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;)]] </span><br><span class="line"> 0.959315299987793</span><br></pre></td></tr></table></figure><h2 id="è®­ç»ƒï¼ˆåŸºäºXFUNDæ•°æ®é›†ï¼‰"><a href="#è®­ç»ƒï¼ˆåŸºäºXFUNDæ•°æ®é›†ï¼‰" class="headerlink" title="è®­ç»ƒï¼ˆåŸºäºXFUNDæ•°æ®é›†ï¼‰"></a>è®­ç»ƒï¼ˆåŸºäºXFUNDæ•°æ®é›†ï¼‰</h2><p>å‚è€ƒï¼š<a href="https://paddlepaddle.github.io/PaddleOCR/latest/ppocr/model_train/kie.html" target="_blank" rel="noopener">https://paddlepaddle.github.io/PaddleOCR/latest/ppocr/model_train/kie.html</a></p><h3 id="æ•°æ®ä¸‹è½½"><a href="#æ•°æ®ä¸‹è½½" class="headerlink" title="æ•°æ®ä¸‹è½½"></a>æ•°æ®ä¸‹è½½</h3><p>XFUND githubä¸»é¡µï¼š<a href="https://github.com/doc-analysis/XFUND" target="_blank" rel="noopener">https://github.com/doc-analysis/XFUND</a></p><p>æ•°æ®é›†ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/doc-analysis/XFUND/releases/tag/v1.0" target="_blank" rel="noopener">https://github.com/doc-analysis/XFUND/releases/tag/v1.0</a></p><p>é€‰æ‹©ä¸­æ–‡æ•°æ®é›†<code>zh.train.json</code>ã€<code>zh.train.zip</code>ã€<code>zh.val.json</code>ã€<code>zh.val.zip</code>å¹¶ä¸‹è½½</p><p><img src="/2024/11/26/å…³é”®ä¿¡æ¯æå–ï¼ˆKIEï¼‰/2.png" alt></p><h3 id="æ•°æ®æ ¼å¼è½¬æ¢"><a href="#æ•°æ®æ ¼å¼è½¬æ¢" class="headerlink" title="æ•°æ®æ ¼å¼è½¬æ¢"></a>æ•°æ®æ ¼å¼è½¬æ¢</h3><p>åˆ›å»ºXFUNDæ ¼å¼è½¬Paddleè®­ç»ƒæ ¼å¼ä»£ç <code>demo/trans_xfun_data.py</code>ï¼ˆæºç ï¼š<code>paddleocr/ppstructure/kie/tools/trans_xfun_data.py</code>ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transfer_xfun_data</span><span class="params">(json_path=None, output_file=None)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(json_path, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fin:</span><br><span class="line">        lines = fin.readlines()</span><br><span class="line"></span><br><span class="line">    json_info = json.loads(lines[<span class="number">0</span>])</span><br><span class="line">    documents = json_info[<span class="string">"documents"</span>]</span><br><span class="line">    <span class="keyword">with</span> open(output_file, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        <span class="keyword">for</span> idx, document <span class="keyword">in</span> enumerate(documents):</span><br><span class="line">            label_info = []</span><br><span class="line">            img_info = document[<span class="string">"img"</span>]</span><br><span class="line">            document = document[<span class="string">"document"</span>]</span><br><span class="line">            image_path = img_info[<span class="string">"fname"</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> doc <span class="keyword">in</span> document:</span><br><span class="line">                x1, y1, x2, y2 = doc[<span class="string">"box"</span>]</span><br><span class="line">                points = [[x1, y1], [x2, y1], [x2, y2], [x1, y2]]</span><br><span class="line">                label_info.append(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"transcription"</span>: doc[<span class="string">"text"</span>],</span><br><span class="line">                        <span class="string">"label"</span>: doc[<span class="string">"label"</span>],</span><br><span class="line">                        <span class="string">"points"</span>: points,</span><br><span class="line">                        <span class="string">"id"</span>: doc[<span class="string">"id"</span>],</span><br><span class="line">                        <span class="string">"linking"</span>: doc[<span class="string">"linking"</span>],</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            fout.write(</span><br><span class="line">                image_path + <span class="string">"\t"</span> + json.dumps(label_info, ensure_ascii=<span class="literal">False</span>) + <span class="string">"\n"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"===ok===="</span>)</span><br><span class="line"></span><br><span class="line">ori_gt_path = <span class="string">r'D:\pycharmproject_2\kie\demo\dataset\zh.val.json'</span></span><br><span class="line">output_path = <span class="string">r'D:\pycharmproject_2\kie\demo\dataset\xfun_val.json'</span></span><br><span class="line"></span><br><span class="line">transfer_xfun_data(ori_gt_path, output_path)</span><br></pre></td></tr></table></figure><p>åŸå§‹æ ¼å¼ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"lang"</span>: <span class="string">"zh"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.1"</span>,</span><br><span class="line">  <span class="attr">"split"</span>: <span class="string">"train"</span>,</span><br><span class="line">  <span class="attr">"documents"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"zh_train_0"</span>,</span><br><span class="line">      <span class="attr">"uid"</span>: <span class="string">"640a0301a1cb24331748b579405502b44d6791883b25ea0eafc8a68126ccdadd"</span>,</span><br><span class="line">      <span class="attr">"document"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"box"</span>: [</span><br><span class="line">            <span class="number">104</span>,</span><br><span class="line">            <span class="number">114</span>,</span><br><span class="line">            <span class="number">530</span>,</span><br><span class="line">            <span class="number">175</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"æ±‡ä¸°æ™‹ä¿¡"</span>,</span><br><span class="line">          <span class="attr">"label"</span>: <span class="string">"other"</span>,</span><br><span class="line">          <span class="attr">"words"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">110</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">152</span>,</span><br><span class="line">                <span class="number">175</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"æ±‡"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">189</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">229</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"ä¸°"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">385</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">426</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"æ™‹"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">466</span>,</span><br><span class="line">                <span class="number">116</span>,</span><br><span class="line">                <span class="number">508</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"ä¿¡"</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"linking"</span>: [],</span><br><span class="line">          <span class="attr">"id"</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">          ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">      ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬æ¢ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zh_train_0.jpg[&#123;"transcription": "æ±‡ä¸°æ™‹ä¿¡", "label": "other", "points": [[104, 114], [530, 114], [530, 175], [104, 175]], "id": 1, "linking": []&#125;, &#123;"transcription": "å—ç†æ—¶é—´:", "label": "question", "points": [[126, 267], [266, 267], [266, 305], [126, 305]], "id": 7, "linking": [[7, 13]]&#125;, &#123;"transcription": "2020.6.15", "label": "answer", "points": [[321, 239], [537, 239], [537, 285], [321, 285]], "id": 13, "linking": [[7, 13]]&#125;...]</span><br><span class="line">zh_train_1.jpg[...]</span><br></pre></td></tr></table></figure><h3 id="é…ç½®å­—å…¸æ–‡ä»¶"><a href="#é…ç½®å­—å…¸æ–‡ä»¶" class="headerlink" title="é…ç½®å­—å…¸æ–‡ä»¶"></a>é…ç½®å­—å…¸æ–‡ä»¶</h3><p>ç”¨äºå­˜å‚¨å„æ®µæ–‡æœ¬çš„æ ‡ç­¾ç±»åˆ«ï¼Œè¿™é‡Œä½¿ç”¨<code>models/xfund_class_list.txt</code>å­—å…¸æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OTHER</span><br><span class="line">QUESTION</span><br><span class="line">ANSWER</span><br><span class="line">HEADER</span><br></pre></td></tr></table></figure><font color="red"><strong>æ³¨ï¼š</strong></font><strong>å­—å…¸ä¸­çš„æ ‡ç­¾å’Œjsonæ–‡ä»¶ä¸­çš„æ ‡ç­¾ä¸åŒºåˆ†å¤§å°å†™</strong><font color="gold"></font><h3 id="é…ç½®è®­ç»ƒæ–‡ä»¶"><a href="#é…ç½®è®­ç»ƒæ–‡ä»¶" class="headerlink" title="é…ç½®è®­ç»ƒæ–‡ä»¶"></a>é…ç½®è®­ç»ƒæ–‡ä»¶</h3><h4 id="SERæ¨¡å‹è®­ç»ƒæ–‡ä»¶"><a href="#SERæ¨¡å‹è®­ç»ƒæ–‡ä»¶" class="headerlink" title="SERæ¨¡å‹è®­ç»ƒæ–‡ä»¶"></a>SERæ¨¡å‹è®­ç»ƒæ–‡ä»¶</h4><p>åˆ›å»ºå¹¶ä¿®æ”¹SERæ¨¡å‹è®­ç»ƒyamlæ–‡ä»¶<code>demo/ser_vi_layoutxlm_xfund_zh.yml</code>ï¼Œæºæ–‡ä»¶è·¯å¾„ï¼š<code>configs/kie/vi_layoutxlm/ser_vi_layoutxlm_xfund_zh.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Global:</span></span><br><span class="line">  <span class="attr">use_gpu:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">epoch_num:</span> <span class="string">&amp;epoch_num</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">log_smooth_window:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">print_batch_step:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">save_model_dir:</span> <span class="string">./output/ser_vi_layoutxlm_xfund_zh</span></span><br><span class="line">  <span class="attr">save_epoch_step:</span> <span class="number">2000</span></span><br><span class="line">  <span class="comment"># evaluation is run every 10 iterations after the 0th iteration</span></span><br><span class="line">  <span class="attr">eval_batch_step:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">19</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">cal_metric_during_train:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">save_inference_dir:</span></span><br><span class="line">  <span class="attr">use_visualdl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">seed:</span> <span class="number">2022</span></span><br><span class="line">  <span class="attr">infer_img:</span> <span class="string">dataset/xfund_train/zh_train/zh_val_42.jpg</span></span><br><span class="line">  <span class="attr">d2s_train_image_shape:</span> <span class="string">[3,</span> <span class="number">224</span><span class="string">,</span> <span class="number">224</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># if you want to predict using the groundtruth ocr info,</span></span><br><span class="line">  <span class="comment"># you can use the following config</span></span><br><span class="line">  <span class="comment"># infer_img: train_data/XFUND/zh_val/val.json</span></span><br><span class="line">  <span class="comment"># infer_mode: False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">save_res_path:</span> <span class="string">./output/ser/xfund_zh/res</span></span><br><span class="line">  <span class="attr">kie_rec_model_dir:</span></span><br><span class="line">  <span class="attr">kie_det_model_dir:</span></span><br><span class="line">  <span class="attr">amp_custom_white_list:</span> <span class="string">['scale',</span> <span class="string">'concat'</span><span class="string">,</span> <span class="string">'elementwise_add'</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Architecture:</span></span><br><span class="line">  <span class="attr">model_type:</span> <span class="string">kie</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&amp;algorithm</span> <span class="string">"LayoutXLM"</span></span><br><span class="line">  <span class="attr">Transform:</span></span><br><span class="line">  <span class="attr">Backbone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LayoutXLMForSer</span></span><br><span class="line">    <span class="attr">pretrained:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">checkpoints:</span></span><br><span class="line">    <span class="comment"># one of base or vi</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">vi</span></span><br><span class="line">    <span class="attr">num_classes:</span> <span class="string">&amp;num_classes</span> <span class="number">7</span> <span class="comment"># &lt;--------------------------------------å½“æ ‡ç­¾æ•°ä¸ºnæ—¶ï¼Œå­˜åœ¨OTHERæ ‡ç­¾ï¼Œå–2n-1ï¼›ä¸å­˜åœ¨OTHERæ ‡ç­¾ï¼Œå–2n+1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Loss:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenLayoutLMLoss</span></span><br><span class="line">  <span class="attr">num_classes:</span> <span class="meta">*num_classes</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">"backbone_out"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizer:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">AdamW</span></span><br><span class="line">  <span class="attr">beta1:</span> <span class="number">0.9</span></span><br><span class="line">  <span class="attr">beta2:</span> <span class="number">0.999</span></span><br><span class="line">  <span class="attr">lr:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Linear</span></span><br><span class="line">    <span class="attr">learning_rate:</span> <span class="number">0.00005</span></span><br><span class="line">    <span class="attr">epochs:</span> <span class="meta">*epoch_num</span></span><br><span class="line">    <span class="attr">warmup_epoch:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">regularizer:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">L2</span></span><br><span class="line">    <span class="attr">factor:</span> <span class="number">0.00000</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">PostProcess:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenLayoutLMPostProcess</span></span><br><span class="line">  <span class="attr">class_path:</span> <span class="string">&amp;class_path</span> <span class="string">models/xfund_class_list.txt</span> <span class="comment"># &lt;--------------------------------------å­—å…¸æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metric:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenMetric</span></span><br><span class="line">  <span class="attr">main_indicator:</span> <span class="string">hmean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Train:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_train</span> <span class="comment"># &lt;--------------------------------------è®­ç»ƒé›†å›¾åƒè·¯å¾„</span></span><br><span class="line">    <span class="attr">label_file_list:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_train.json</span> <span class="comment"># &lt;--------------------------------------è®­ç»ƒé›†jsonæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="attr">ratio_list:</span> <span class="string">[</span> <span class="number">1.0</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">False</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="string">&amp;use_textline_bbox_info</span> <span class="literal">True</span></span><br><span class="line">          <span class="comment"># one of [None, "tb-yx"]</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="string">&amp;order_method</span> <span class="string">"tb-yx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="string">&amp;max_seq_len</span> <span class="number">512</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQASerTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'image'</span><span class="string">,</span> <span class="string">'labels'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Eval:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_val</span> <span class="comment"># &lt;--------------------------------------éªŒè¯é›†å›¾ç‰‡è·¯å¾„</span></span><br><span class="line">    <span class="attr">label_file_list:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_val.json</span> <span class="comment"># &lt;--------------------------------------éªŒè¯é›†jsonæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">False</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="meta">*use_textline_bbox_info</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="meta">*order_method</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQASerTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'image'</span><span class="string">,</span> <span class="string">'labels'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure><h4 id="REæ¨¡å‹è®­ç»ƒæ–‡ä»¶"><a href="#REæ¨¡å‹è®­ç»ƒæ–‡ä»¶" class="headerlink" title="REæ¨¡å‹è®­ç»ƒæ–‡ä»¶"></a>REæ¨¡å‹è®­ç»ƒæ–‡ä»¶</h4><p>åˆ›å»ºå¹¶ä¿®æ”¹REæ¨¡å‹è®­ç»ƒyamlæ–‡ä»¶<code>demo/re_vi_layoutxlm_xfund_zh.yml</code>ï¼Œæºæ–‡ä»¶è·¯å¾„ï¼š<code>configs/kie/vi_layoutxlm/re_vi_layoutxlm_xfund_zh.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Global:</span></span><br><span class="line">  <span class="attr">use_gpu:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">epoch_num:</span> <span class="string">&amp;epoch_num</span> <span class="number">130</span></span><br><span class="line">  <span class="attr">log_smooth_window:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">print_batch_step:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">save_model_dir:</span> <span class="string">./output/re_vi_layoutxlm_xfund_zh</span></span><br><span class="line">  <span class="attr">save_epoch_step:</span> <span class="number">2000</span></span><br><span class="line">  <span class="comment"># evaluation is run every 10 iterations after the 0th iteration</span></span><br><span class="line">  <span class="attr">eval_batch_step:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">19</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">cal_metric_during_train:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">save_inference_dir:</span></span><br><span class="line">  <span class="attr">use_visualdl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">seed:</span> <span class="number">2022</span></span><br><span class="line">  <span class="attr">infer_img:</span> <span class="string">dataset/xfund_train/zh_train/zh_val_21.jpg</span></span><br><span class="line">  <span class="attr">save_res_path:</span> <span class="string">./output/re/xfund_zh/with_gt</span></span><br><span class="line">  <span class="attr">kie_rec_model_dir:</span> </span><br><span class="line">  <span class="attr">kie_det_model_dir:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Architecture:</span></span><br><span class="line">  <span class="attr">model_type:</span> <span class="string">kie</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&amp;algorithm</span> <span class="string">"LayoutXLM"</span></span><br><span class="line">  <span class="attr">Transform:</span></span><br><span class="line">  <span class="attr">Backbone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LayoutXLMForRe</span></span><br><span class="line">    <span class="attr">pretrained:</span> <span class="string">dataset/re_vi_layoutxlm_xfund_pretrained</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">vi</span></span><br><span class="line">    <span class="attr">checkpoints:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Loss:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">LossFromOutput</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">loss</span></span><br><span class="line">  <span class="attr">reduction:</span> <span class="string">mean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizer:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">AdamW</span></span><br><span class="line">  <span class="attr">beta1:</span> <span class="number">0.9</span></span><br><span class="line">  <span class="attr">beta2:</span> <span class="number">0.999</span></span><br><span class="line">  <span class="attr">clip_norm:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">lr:</span></span><br><span class="line">    <span class="attr">learning_rate:</span> <span class="number">0.00005</span></span><br><span class="line">    <span class="attr">warmup_epoch:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">regularizer:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">L2</span></span><br><span class="line">    <span class="attr">factor:</span> <span class="number">0.00000</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">PostProcess:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQAReTokenLayoutLMPostProcess</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metric:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQAReTokenMetric</span></span><br><span class="line">  <span class="attr">main_indicator:</span> <span class="string">hmean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Train:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_train</span> <span class="comment"># &lt;--------------------------------------è®­ç»ƒé›†å›¾ç‰‡è·¯å¾„</span></span><br><span class="line">    <span class="attr">label_file_list:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_train.json</span> <span class="comment"># &lt;--------------------------------------è®­ç»ƒé›†jsonæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="attr">ratio_list:</span> <span class="string">[</span> <span class="number">1.0</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="string">&amp;class_path</span> <span class="string">models/xfund_class_list.txt</span> <span class="comment"># &lt;--------------------------------------å­—å…¸æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="string">&amp;use_textline_bbox_info</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="string">&amp;order_method</span> <span class="string">"tb-yx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="string">&amp;max_seq_len</span> <span class="number">512</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenRelation:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">TensorizeEntitiesRelations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,'attention_mask',</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'entities'</span><span class="string">,</span> <span class="string">'relations'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Eval:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_val</span> <span class="comment"># &lt;--------------------------------------éªŒè¯é›†å›¾ç‰‡è·¯å¾„</span></span><br><span class="line">    <span class="attr">label_file_list:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_val.json</span> <span class="comment"># &lt;--------------------------------------éªŒè¯é›†jsonæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="meta">*use_textline_bbox_info</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="meta">*order_method</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenRelation:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">TensorizeEntitiesRelations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'entities'</span><span class="string">,</span> <span class="string">'relations'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹è®­ç»ƒ"><a href="#å¼€å§‹è®­ç»ƒ" class="headerlink" title="å¼€å§‹è®­ç»ƒ"></a>å¼€å§‹è®­ç»ƒ</h3><p>åˆ›å»ºè®­ç»ƒä»£ç <code>demo/train.py</code>ï¼Œè®­ç»ƒæºç ä½ç½®ï¼š<code>paddleocr/tools/train.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2020 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">".."</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"><span class="keyword">import</span> paddle.distributed <span class="keyword">as</span> dist</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.data <span class="keyword">import</span> build_dataloader, set_signal_handlers</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.modeling.architectures <span class="keyword">import</span> build_model</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.losses <span class="keyword">import</span> build_loss</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.optimizer <span class="keyword">import</span> build_optimizer</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.postprocess <span class="keyword">import</span> build_post_process</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.metrics <span class="keyword">import</span> build_metric</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.save_load <span class="keyword">import</span> load_model</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.utility <span class="keyword">import</span> set_seed</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.modeling.architectures <span class="keyword">import</span> apply_to_static</span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.program <span class="keyword">as</span> program</span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.naive_sync_bn <span class="keyword">as</span> naive_sync_bn</span><br><span class="line"></span><br><span class="line">dist.get_world_size()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(config, device, logger, vdl_writer, seed)</span>:</span></span><br><span class="line">    <span class="comment"># init dist environment</span></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Global"</span>][<span class="string">"distributed"</span>]:</span><br><span class="line">        dist.init_parallel_env()</span><br><span class="line"></span><br><span class="line">    global_config = config[<span class="string">"Global"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build dataloader</span></span><br><span class="line">    set_signal_handlers()</span><br><span class="line">    train_dataloader = build_dataloader(config, <span class="string">"Train"</span>, device, logger, seed)</span><br><span class="line">    <span class="keyword">if</span> len(train_dataloader) == <span class="number">0</span>:</span><br><span class="line">        logger.error(</span><br><span class="line">            <span class="string">"No Images in train dataset, please ensure\n"</span></span><br><span class="line">            + <span class="string">"\t1. The images num in the train label_file_list should be larger than or equal with batch size.\n"</span></span><br><span class="line">            + <span class="string">"\t2. The annotation file and path in the configuration file are provided normally."</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Eval"</span>]:</span><br><span class="line">        valid_dataloader = build_dataloader(config, <span class="string">"Eval"</span>, device, logger, seed)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        valid_dataloader = <span class="literal">None</span></span><br><span class="line">    step_pre_epoch = len(train_dataloader)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build post process</span></span><br><span class="line">    post_process_class = build_post_process(config[<span class="string">"PostProcess"</span>], global_config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build model</span></span><br><span class="line">    <span class="comment"># for rec algorithm</span></span><br><span class="line">    <span class="keyword">if</span> hasattr(post_process_class, <span class="string">"character"</span>):</span><br><span class="line">        char_num = len(getattr(post_process_class, <span class="string">"character"</span>))</span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"Architecture"</span>][<span class="string">"algorithm"</span>] <span class="keyword">in</span> [</span><br><span class="line">            <span class="string">"Distillation"</span>,</span><br><span class="line">        ]:  <span class="comment"># distillation model</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>]:</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][<span class="string">"name"</span>] == <span class="string">"MultiHead"</span></span><br><span class="line">                ):  <span class="comment"># for multi head</span></span><br><span class="line">                    <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"DistillationSARLabelDecode"</span>:</span><br><span class="line">                        char_num = char_num - <span class="number">2</span></span><br><span class="line">                    <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"DistillationNRTRLabelDecode"</span>:</span><br><span class="line">                        char_num = char_num - <span class="number">3</span></span><br><span class="line">                    out_channels_list = &#123;&#125;</span><br><span class="line">                    out_channels_list[<span class="string">"CTCLabelDecode"</span>] = char_num</span><br><span class="line">                    <span class="comment"># update SARLoss params</span></span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">-1</span>].keys())[<span class="number">0</span>]</span><br><span class="line">                        == <span class="string">"DistillationSARLoss"</span></span><br><span class="line">                    ):</span><br><span class="line">                        config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">-1</span>][<span class="string">"DistillationSARLoss"</span>][</span><br><span class="line">                            <span class="string">"ignore_index"</span></span><br><span class="line">                        ] = (char_num + <span class="number">1</span>)</span><br><span class="line">                        out_channels_list[<span class="string">"SARLabelDecode"</span>] = char_num + <span class="number">2</span></span><br><span class="line">                    <span class="keyword">elif</span> any(</span><br><span class="line">                        <span class="string">"DistillationNRTRLoss"</span> <span class="keyword">in</span> d</span><br><span class="line">                        <span class="keyword">for</span> d <span class="keyword">in</span> config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>]</span><br><span class="line">                    ):</span><br><span class="line">                        out_channels_list[<span class="string">"NRTRLabelDecode"</span>] = char_num + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][</span><br><span class="line">                        <span class="string">"out_channels_list"</span></span><br><span class="line">                    ] = out_channels_list</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][</span><br><span class="line">                        <span class="string">"out_channels"</span></span><br><span class="line">                    ] = char_num</span><br><span class="line">        <span class="keyword">elif</span> config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"name"</span>] == <span class="string">"MultiHead"</span>:  <span class="comment"># for multi head</span></span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"SARLabelDecode"</span>:</span><br><span class="line">                char_num = char_num - <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"NRTRLabelDecode"</span>:</span><br><span class="line">                char_num = char_num - <span class="number">3</span></span><br><span class="line">            out_channels_list = &#123;&#125;</span><br><span class="line">            out_channels_list[<span class="string">"CTCLabelDecode"</span>] = char_num</span><br><span class="line">            <span class="comment"># update SARLoss params</span></span><br><span class="line">            <span class="keyword">if</span> list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>].keys())[<span class="number">0</span>] == <span class="string">"SARLoss"</span>:</span><br><span class="line">                <span class="keyword">if</span> config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>] = &#123;</span><br><span class="line">                        <span class="string">"ignore_index"</span>: char_num + <span class="number">1</span></span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>][<span class="string">"ignore_index"</span>] = (</span><br><span class="line">                        char_num + <span class="number">1</span></span><br><span class="line">                    )</span><br><span class="line">                out_channels_list[<span class="string">"SARLabelDecode"</span>] = char_num + <span class="number">2</span></span><br><span class="line">            <span class="keyword">elif</span> list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>].keys())[<span class="number">0</span>] == <span class="string">"NRTRLoss"</span>:</span><br><span class="line">                out_channels_list[<span class="string">"NRTRLabelDecode"</span>] = char_num + <span class="number">3</span></span><br><span class="line">            config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"out_channels_list"</span>] = out_channels_list</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># base rec model</span></span><br><span class="line">            config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"out_channels"</span>] = char_num</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"SARLabelDecode"</span>:  <span class="comment"># for SAR model</span></span><br><span class="line">            config[<span class="string">"Loss"</span>][<span class="string">"ignore_index"</span>] = char_num - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    model = build_model(config[<span class="string">"Architecture"</span>])</span><br><span class="line"></span><br><span class="line">    use_sync_bn = config[<span class="string">"Global"</span>].get(<span class="string">"use_sync_bn"</span>, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> use_sync_bn:</span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"Global"</span>].get(<span class="string">"use_npu"</span>, <span class="literal">False</span>):</span><br><span class="line">            naive_sync_bn.convert_syncbn(model)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            model = paddle.nn.SyncBatchNorm.convert_sync_batchnorm(model)</span><br><span class="line">        logger.info(<span class="string">"convert_sync_batchnorm"</span>)</span><br><span class="line"></span><br><span class="line">    model = apply_to_static(model, config, logger)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build loss</span></span><br><span class="line">    loss_class = build_loss(config[<span class="string">"Loss"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build optim</span></span><br><span class="line">    optimizer, lr_scheduler = build_optimizer(</span><br><span class="line">        config[<span class="string">"Optimizer"</span>],</span><br><span class="line">        epochs=config[<span class="string">"Global"</span>][<span class="string">"epoch_num"</span>],</span><br><span class="line">        step_each_epoch=len(train_dataloader),</span><br><span class="line">        model=model,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build metric</span></span><br><span class="line">    eval_class = build_metric(config[<span class="string">"Metric"</span>])</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"train dataloader has &#123;&#125; iters"</span>.format(len(train_dataloader)))</span><br><span class="line">    <span class="keyword">if</span> valid_dataloader <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logger.info(<span class="string">"valid dataloader has &#123;&#125; iters"</span>.format(len(valid_dataloader)))</span><br><span class="line"></span><br><span class="line">    use_amp = config[<span class="string">"Global"</span>].get(<span class="string">"use_amp"</span>, <span class="literal">False</span>)</span><br><span class="line">    amp_level = config[<span class="string">"Global"</span>].get(<span class="string">"amp_level"</span>, <span class="string">"O2"</span>)</span><br><span class="line">    amp_dtype = config[<span class="string">"Global"</span>].get(<span class="string">"amp_dtype"</span>, <span class="string">"float16"</span>)</span><br><span class="line">    amp_custom_black_list = config[<span class="string">"Global"</span>].get(<span class="string">"amp_custom_black_list"</span>, [])</span><br><span class="line">    amp_custom_white_list = config[<span class="string">"Global"</span>].get(<span class="string">"amp_custom_white_list"</span>, [])</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(</span><br><span class="line">        os.path.join(config[<span class="string">"Global"</span>][<span class="string">"save_model_dir"</span>], <span class="string">"train_result.json"</span>)</span><br><span class="line">    ):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.remove(</span><br><span class="line">                os.path.join(config[<span class="string">"Global"</span>][<span class="string">"save_model_dir"</span>], <span class="string">"train_result.json"</span>)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> use_amp:</span><br><span class="line">        AMP_RELATED_FLAGS_SETTING = &#123;</span><br><span class="line">            <span class="string">"FLAGS_max_inplace_grad_add"</span>: <span class="number">8</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> paddle.is_compiled_with_cuda():</span><br><span class="line">            AMP_RELATED_FLAGS_SETTING.update(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"FLAGS_cudnn_batchnorm_spatial_persistent"</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">"FLAGS_gemm_use_half_precision_compute_type"</span>: <span class="number">0</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        paddle.set_flags(AMP_RELATED_FLAGS_SETTING)</span><br><span class="line">        scale_loss = config[<span class="string">"Global"</span>].get(<span class="string">"scale_loss"</span>, <span class="number">1.0</span>)</span><br><span class="line">        use_dynamic_loss_scaling = config[<span class="string">"Global"</span>].get(</span><br><span class="line">            <span class="string">"use_dynamic_loss_scaling"</span>, <span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        scaler = paddle.amp.GradScaler(</span><br><span class="line">            init_loss_scaling=scale_loss,</span><br><span class="line">            use_dynamic_loss_scaling=use_dynamic_loss_scaling,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> amp_level == <span class="string">"O2"</span>:</span><br><span class="line">            model, optimizer = paddle.amp.decorate(</span><br><span class="line">                models=model,</span><br><span class="line">                optimizers=optimizer,</span><br><span class="line">                level=amp_level,</span><br><span class="line">                master_weight=<span class="literal">True</span>,</span><br><span class="line">                dtype=amp_dtype,</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        scaler = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># load pretrain model</span></span><br><span class="line">    pre_best_model_dict = load_model(</span><br><span class="line">        config, model, optimizer, config[<span class="string">"Architecture"</span>][<span class="string">"model_type"</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Global"</span>][<span class="string">"distributed"</span>]:</span><br><span class="line">        model = paddle.DataParallel(model)</span><br><span class="line">    <span class="comment"># start train</span></span><br><span class="line">    program.train(</span><br><span class="line">        config,</span><br><span class="line">        train_dataloader,</span><br><span class="line">        valid_dataloader,</span><br><span class="line">        device,</span><br><span class="line">        model,</span><br><span class="line">        loss_class,</span><br><span class="line">        optimizer,</span><br><span class="line">        lr_scheduler,</span><br><span class="line">        post_process_class,</span><br><span class="line">        eval_class,</span><br><span class="line">        pre_best_model_dict,</span><br><span class="line">        logger,</span><br><span class="line">        step_pre_epoch,</span><br><span class="line">        vdl_writer,</span><br><span class="line">        scaler,</span><br><span class="line">        amp_level,</span><br><span class="line">        amp_custom_black_list,</span><br><span class="line">        amp_custom_white_list,</span><br><span class="line">        amp_dtype,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_reader</span><span class="params">(config, device, logger)</span>:</span></span><br><span class="line">    loader = build_dataloader(config, <span class="string">"Train"</span>, device, logger)</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    starttime = time.time()</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> loader():</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count % <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">                batch_time = time.time() - starttime</span><br><span class="line">                starttime = time.time()</span><br><span class="line">                logger.info(</span><br><span class="line">                    <span class="string">"reader: &#123;&#125;, &#123;&#125;, &#123;&#125;"</span>.format(count, len(data[<span class="number">0</span>]), batch_time)</span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.info(e)</span><br><span class="line">    logger.info(<span class="string">"finish reader: &#123;&#125;, Success!"</span>.format(count))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    config, device, logger, vdl_writer = program.preprocess(is_train=<span class="literal">True</span>)</span><br><span class="line">    seed = config[<span class="string">"Global"</span>][<span class="string">"seed"</span>] <span class="keyword">if</span> <span class="string">"seed"</span> <span class="keyword">in</span> config[<span class="string">"Global"</span>] <span class="keyword">else</span> <span class="number">1024</span></span><br><span class="line">    set_seed(seed)</span><br><span class="line">    main(config, device, logger, vdl_writer, seed)</span><br><span class="line">    <span class="comment"># test_reader(config, device, logger)</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®è®­ç»ƒç›®æ ‡çš„é…ç½®æ–‡ä»¶ï¼Œåˆ†å‘æ˜¾å¡å’Œè®­ç»ƒä»»åŠ¡ï¼š</p><font color="gold"><strong>SER:</strong></font><p><code>CUDA_VISIBLE_DEVICES=0 python train.py -c ser_vi_layoutxlm_xfund_zh.yml</code></p><font color="gold"><strong>RE:</strong></font><p><code>CUDA_VISIBLE_DEVICES=1 python train.py -c re_vi_layoutxlm_xfund_zh.yml</code></p><p>é¦–æ¬¡å¯åŠ¨å°†è‡ªåŠ¨ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹ã€‚æ—¥å¿—è¾“å‡ºæ ·ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2024/11/26 17:35:39] ppocr INFO: epoch: [1/200], global_step: 10, lr: 0.000006, loss: 1.838789, avg_reader_cost: 0.39165 s, avg_batch_cost: 0.54732 s, avg_samples: 8.0, ips: 14.61671 samples/s, eta: 0:34:34, max_mem_reserved: 11694 MB, max_mem_allocated: 10523 MB</span><br><span class="line">[2024/11/26 17:35:43] ppocr INFO: epoch: [1/200], global_step: 19, lr: 0.000018, loss: 1.446505, avg_reader_cost: 0.22235 s, avg_batch_cost: 0.32516 s, avg_samples: 6.9, ips: 21.22014 samples/s, eta: 0:28:56, max_mem_reserved: 11694 MB, max_mem_allocated: 10523 MB</span><br><span class="line">eval model:: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:04&lt;00:00,  1.61it/s]</span><br><span class="line">[2024/11/26 17:35:47] ppocr INFO: cur metric, precision: 0.05993363749481543, recall: 0.10410662824207492, hmean: 0.07607265069755198, fps: 101.1334614167882</span><br><span class="line">[2024/11/26 17:36:22] ppocr INFO: save best model is to ./output/ser_vi_layoutxlm_xfund_zh/best_accuracy</span><br><span class="line">[2024/11/26 17:36:22] ppocr INFO: best metric, hmean: 0.07607265069755198, precision: 0.05993363749481543, recall: 0.10410662824207492, fps: 101.1334614167882, best_epoch: 1</span><br><span class="line">[2024/11/26 17:36:39] ppocr INFO: save model in ./output/ser_vi_layoutxlm_xfund_zh/latest</span><br></pre></td></tr></table></figure><h3 id="æ¨¡å‹å¯¼å‡º"><a href="#æ¨¡å‹å¯¼å‡º" class="headerlink" title="æ¨¡å‹å¯¼å‡º"></a>æ¨¡å‹å¯¼å‡º</h3><p>è®­ç»ƒç»“æŸåï¼Œè¿›å…¥æœ€ä½³æ¨¡å‹ç›®å½•<code>demo/output/re_vi_layoutxlm_xfund_zh/best_accuracy</code>ï¼Œæ­¤æ—¶æ¨¡å‹ä¸å…·å¤‡<code>.pdmodel</code>æ–‡ä»¶ï¼Œä¸èƒ½ç›´æ¥ç”¨äºé¢„æµ‹ï¼Œéœ€è¦å¯¼å‡ºä¸ºinferenceæ¨¡å‹ï¼ˆæœ¬æ–‡é€‚å½“ç•¥è¿‡æ¨¡å‹è¯„ä¼°æ­¥éª¤ï¼‰</p><p><img src="/2024/11/26/å…³é”®ä¿¡æ¯æå–ï¼ˆKIEï¼‰/3.png" alt></p><p>åˆ›å»ºæ¨¡å‹å¯¼å‡ºä»£ç <code>demo/export_model.py</code>ï¼Œå¯¼å‡ºæºç ä½ç½®ï¼š<code>paddleocr/tools/export_model.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2020 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">".."</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.program <span class="keyword">import</span> load_config, merge_config, ArgsParser</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.export_model <span class="keyword">import</span> export</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    FLAGS = ArgsParser().parse_args()</span><br><span class="line">    config = load_config(FLAGS.config)</span><br><span class="line">    config = merge_config(config, FLAGS.opt)</span><br><span class="line">    <span class="comment"># export model</span></span><br><span class="line">    export(config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>å¯¼å‡ºå‘½ä»¤ï¼š</p><font color="gold"><strong>SER:</strong></font><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python export_model.py -c ser_vi_layoutxlm_xfund_zh.yml -o Architecture.Backbone.checkpoints=./output/ser_vi_layoutxlm_xfund_z</span><br><span class="line">h/best_accuracy Global.save_inference_dir=./inference/ser_vi_layoutxlm Global.save_inference_dir=./inference/ser_vi_layoutxlm</span><br></pre></td></tr></table></figure><font color="gold"><strong>RE:</strong></font><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python export_model.py -c re_vi_layoutxlm_xfund_zh.yml -o Architecture.Backbone.checkpoints=./output/re_vi_layoutxlm_xfund_z</span><br><span class="line">h/best_accuracy Global.save_inference_dir=./inference/re_vi_layoutxlm Global.save_inference_dir=./inference/re_vi_layoutxlm</span><br></pre></td></tr></table></figure><p>å°†åœ¨<code>demo/inferenceç›®å½•ä¸‹ç”Ÿæˆå¯¼å‡ºçš„æ¨ç†æ¨¡å‹</code>ï¼Œå¯ä¿®æ”¹argså‚æ•°ä¸­æ¨¡å‹è·¯å¾„è¿›è¡ŒéªŒè¯ã€‚</p><h2 id="å®¢åˆ¶åŒ–"><a href="#å®¢åˆ¶åŒ–" class="headerlink" title="å®¢åˆ¶åŒ–"></a>å®¢åˆ¶åŒ–</h2><h3 id="æ ‡æ³¨å·¥å…·ï¼šPPOCRLabel"><a href="#æ ‡æ³¨å·¥å…·ï¼šPPOCRLabel" class="headerlink" title="æ ‡æ³¨å·¥å…·ï¼šPPOCRLabel"></a>æ ‡æ³¨å·¥å…·ï¼šPPOCRLabel</h3><p>æ“ä½œç³»ç»Ÿå›åˆ°windowsï¼Œå¹¶åˆ›å»º<code>demo/dataset/temp</code>æ–‡ä»¶å¤¹å­˜æ”¾è®­ç»ƒå›¾åƒ</p><p>å®‰è£…ï¼š<code>pip install PPOCRLabel==2.1.3 -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p><p>å¯åŠ¨ï¼š<code>PPOCRLabel --lang ch --kie True</code> </p><p>æ­¤æ—¶æ ‡æ³¨å·¥å…·å·¦ä¸‹è§’æ˜¾ç¤ºå…³é”®è¯åˆ—è¡¨é¡¹</p><p><img src="/2024/11/26/å…³é”®ä¿¡æ¯æå–ï¼ˆKIEï¼‰/4.png" alt></p><font color="red"><strong>æ³¨ï¼š</strong></font> æœ€æ–°ç‰ˆå¯èƒ½å­˜åœ¨bugï¼Œå»ºè®®ä½¿ç”¨2.1.3ç‰ˆæœ¬ã€‚<strong>ä¸”æˆªè‡³ç›®å‰ï¼ˆ24.11æœˆ v2.1.12ç‰ˆæœ¬ï¼‰ï¼Œå·¥å…·ä»ä¸å…·å¤‡REä»»åŠ¡å…³ç³»æ ‡æ³¨åŠŸèƒ½ï¼Œéœ€åˆ¶ä½œåå¤„ç†è„šæœ¬</strong> <font color="red"><strong>*éš¾ç‚¹</strong></font><h3 id="åå¤„ç†ï¼š"><a href="#åå¤„ç†ï¼š" class="headerlink" title="åå¤„ç†ï¼š"></a>åå¤„ç†ï¼š</h3><font color="gold"><strong>SER</strong></font><p>åˆ›å»ºSERä»»åŠ¡å¤„ç†ä»£ç <code>demo/trans+ppocrlabel.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dataset/temp/Label.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> l:</span><br><span class="line">    content = l.readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> content:</span><br><span class="line">        image = line.split(<span class="string">'\t'</span>)[<span class="number">0</span>]</span><br><span class="line">        label = json.loads(line.split(<span class="string">'\t'</span>)[<span class="number">1</span>])</span><br><span class="line">        label_set = []</span><br><span class="line">        <span class="keyword">for</span> i, lab <span class="keyword">in</span> enumerate(label):</span><br><span class="line">            new_lab = &#123;</span><br><span class="line">                <span class="string">'transcription'</span>: lab.get(<span class="string">'transcription'</span>),</span><br><span class="line">                <span class="string">'points'</span>: lab.get(<span class="string">'points'</span>),</span><br><span class="line">                <span class="string">'label'</span>: lab.get(<span class="string">'key_cls'</span>),</span><br><span class="line">                <span class="string">'id'</span>: i,</span><br><span class="line">                <span class="string">'linking'</span>: []</span><br><span class="line">            &#125;</span><br><span class="line">            label_set.append(new_lab)</span><br><span class="line">            label_set_json = json.dumps(label_set, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'./dataset/project/train.json'</span>, <span class="string">'a+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(image)</span><br><span class="line">            f.write(<span class="string">'\t'</span>)</span><br><span class="line">            f.write(label_set_json)</span><br><span class="line">            f.write(<span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure><font color="gold"><strong>RE</strong></font><p>æµ‹è¯•ä¸­ï¼Œæœªå®Œå¾…ç»­</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒå‡†å¤‡&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;/a&gt;ç¯å¢ƒå‡†å¤‡&lt;/h2&gt;&lt;h3 id=&quot;æœåŠ¡å™¨&quot;&gt;&lt;a href=&quot;#æœåŠ¡å™¨&quot; class=&quot;headerlink&quot; title=&quot;æœåŠ¡å™¨&quot;&gt;&lt;/a&gt;æœåŠ¡å™¨&lt;/h3&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· OS: &lt;/strong&gt;&lt;/font&gt;CentOS7.9&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· GPU:  &lt;/strong&gt;&lt;/font&gt;RTX3090 24G*2&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· CUDA: &lt;/strong&gt;&lt;/font&gt;11.7&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· CUDNN: &lt;/strong&gt;&lt;/font&gt;8.9.2&lt;font color=&quot;gold&quot;&gt;&lt;/font&gt;

&lt;h3 id=&quot;é£æ¡¨&quot;&gt;&lt;a href=&quot;#é£æ¡¨&quot; class=&quot;headerlink&quot; title=&quot;é£æ¡¨&quot;&gt;&lt;/a&gt;é£æ¡¨&lt;/h3&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· paddlepaddle:&lt;/strong&gt;&lt;/font&gt;  paddlepaddle-gpu==2.4.2ï¼ˆcudatoolkit=11.7ï¼Œå»ºè®®condaå®‰è£…ï¼‰&lt;br&gt;&lt;br&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· paddleocr:&lt;/strong&gt;&lt;/font&gt;  2.9.1&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â· paddlenlp:&lt;/strong&gt;&lt;/font&gt;  2.5.2&lt;font color=&quot;gold&quot;&gt;&lt;/font&gt;

&lt;h3 id=&quot;é¡¹ç›®ä¾èµ–&quot;&gt;&lt;a href=&quot;#é¡¹ç›®ä¾èµ–&quot; class=&quot;headerlink&quot; title=&quot;é¡¹ç›®ä¾èµ–&quot;&gt;&lt;/a&gt;é¡¹ç›®ä¾èµ–&lt;/h3&gt;&lt;p&gt;&lt;code&gt;requirements.txt&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# paddlepaddle 2.4.2 æ³¨ï¼šå¿…é¡»&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;shapely&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scikit-image&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pyclipper&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;lmdb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tqdm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;numpy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rapidfuzz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;opencv-python&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;opencv-contrib-python&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cython&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Pillow&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pyyaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;albumentations==1.4.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# to be compatible with albumentations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;albucore==0.0.13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sentencepiece&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yacs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;seqeval&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pypandoc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;attrdict3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;python_docx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;paddlenlp==2.5.2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;font color=&quot;red&quot;&gt;&lt;strong&gt;æ³¨ï¼š&lt;/strong&gt;&lt;/font&gt;&lt;strong&gt;bugfix&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;/font&gt;

&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;1.&lt;/strong&gt;&lt;/font&gt;&lt;code&gt;ModuleNotFoundError: No module named &amp;#39;ppocr.***&amp;#39;&lt;/code&gt;&lt;br&gt;&lt;br&gt;å‰å¾€å®˜æ–¹githubä¸»é¡µï¼ˆ&lt;a href=&quot;https://github.com/PaddlePaddle/PaddleOCR&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/PaddlePaddle/PaddleOCR&lt;/a&gt;ï¼‰è¡¥é½æºç åˆ°pythonç¯å¢ƒ&lt;br&gt;&lt;br&gt;e.g.conda è™šæ‹Ÿç¯å¢ƒä¸‹ï¼Œéœ€è¦è¡¥é½çš„æºç æ ¹ç›®å½•ä¸ºï¼š&lt;code&gt;/root/anaconda3/envs/py39_kie/lib/python3.9/site-packages/paddleocr/ppocr&lt;/code&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;2.&lt;/strong&gt;&lt;/font&gt;ModuleNotFoundError: No module named â€˜paddle.fluidâ€™&lt;br&gt;&lt;br&gt;å®‰è£…è¾ƒä½ç‰ˆæœ¬paddle &lt;code&gt;paddlepaddle2.4.2/2.5.0&lt;/code&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;3.&lt;/strong&gt;&lt;/font&gt;ç±»å‹é”™è¯¯ï¼š&lt;br&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;InvalidArgumentError: The type of data we are trying to retrieve does not match the type of data currently contained in the container.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      [Hint: Expected dtype() == paddle::experimental::CppTypeToDataType&amp;lt;T&amp;gt;::Type(), but received dtype():10 != paddle::experimental::CppTypeToDataType&amp;lt;T&amp;gt;::Type():9.] (at /paddle/paddle/phi/core/dense_tensor.cc:143)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      [operator &amp;lt; less_equal &amp;gt; error]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;br&gt;&lt;br&gt;å®˜æ–¹ç¤ºä¾‹bugï¼Œéœ€è¦æ·»åŠ å‚æ•°é¡¹&lt;strong&gt;&lt;code&gt;--use_visual_backbone = False&lt;/code&gt;&lt;/strong&gt;&lt;font color=&quot;gold&quot;&gt;&lt;/font&gt;</summary>
    
    
    
    
    <category term="OCR" scheme="http://yoursite.com/tags/OCR/"/>
    
    <category term="paddle" scheme="http://yoursite.com/tags/paddle/"/>
    
    <category term="KIE" scheme="http://yoursite.com/tags/KIE/"/>
    
  </entry>
  
  <entry>
    <title>é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–</title>
    <link href="http://yoursite.com/2024/08/06/%E9%97%B4%E9%9A%99%E6%A0%91%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E7%9A%84%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    <id>http://yoursite.com/2024/08/06/%E9%97%B4%E9%9A%99%E6%A0%91%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E7%9A%84%E5%8F%AF%E8%A7%86%E5%8C%96/</id>
    <published>2024-08-06T07:10:43.000Z</published>
    <updated>2025-02-12T03:13:04.097Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><p>åšæ–‡æ¡£ç¿»è¯‘çš„OCRç¨‹åºæ—¶ï¼Œä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå› ä¸ºé€šå¸¸OCRæ¨¡å‹çš„è¾“å‡ºéƒ½æ˜¯æŒ‰æ–‡æœ¬å—é€è¡Œè¿”å›ï¼Œå½“ç»“æœè¿›å…¥ç¿»è¯‘æ¨¡å‹æ—¶ä¼šä¸¢å¤±è¡Œä¸è¡Œä¹‹é—´çš„ä¿¡æ¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å¯¹OCRç»“æœè¿›è¡Œè¿›ä¸€æ­¥çš„ç‰ˆé¢åˆ†æï¼Œå°†æ–‡æœ¬å—åˆå¹¶æˆæ®µè½ï¼Œå†è¾“å…¥åˆ°ç¿»è¯‘æ¨¡å‹ä¸­å»ã€‚</p><h2 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h2><p>é—´éš™Â·æ ‘Â·æ’åºç®—æ³•</p><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://github.com/hiroi-sora/GapTree_Sort_Algorithm" target="_blank" rel="noopener">https://github.com/hiroi-sora/GapTree_Sort_Algorithm</a></p><p><img src="/2024/08/06/é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–/1.png" alt></p><p>ç®—æ³•ä¸»è¦å¯¹æ–‡æœ¬å—æŒ‰é—´éš™è¿›è¡Œåˆ’åˆ†ï¼Œå†ç»è¿‡æ ‘å½¢æ’åºï¼Œå°†åº•å±‚OCRçš„è¾“å‡ºç»“æœä»å­æ–‡æœ¬å—è½¬åŒ–æˆæ®µè½æ–‡æœ¬å—ã€‚</p><h3 id="ç®—æ³•é‡æ„"><a href="#ç®—æ³•é‡æ„" class="headerlink" title="ç®—æ³•é‡æ„"></a>ç®—æ³•é‡æ„</h3><p>ä¸ºäº†ä½¿æ–‡æœ¬å—çš„å®šä½æ›´åŠ å‡†ç¡®ï¼Œä½¿ç”¨åŸç®—æ³•è¾“å‡ºæ®µè½å—ï¼ˆcontent_blocksï¼‰çš„ä¸Šä¸‹å·¦å³å››ä¸ªè¾¹ç•Œç‚¹æ„æˆæ–°æ®µè½å—ï¼ˆnew_blocksï¼‰</p><p>æºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">structure_ocr</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> line, tb <span class="keyword">in</span> enumerate(self.blocks_data):</span><br><span class="line">        tb[<span class="string">"bbox"</span>] = self.bboxes[line]</span><br><span class="line"></span><br><span class="line">    gtree = GapTree(<span class="keyword">lambda</span> tb: tb[<span class="string">"bbox"</span>])</span><br><span class="line">    sorted_text_blocks = gtree.sort(self.blocks_data)  <span class="comment"># æ–‡æœ¬å—æ’åº</span></span><br><span class="line">    <span class="comment"># print(sorted_text_blocks)</span></span><br><span class="line">    pp = ParagraphParse(self.get_info, self.set_end)</span><br><span class="line">    <span class="comment"># è·å–æ‰€æœ‰åŒºå—çš„æ–‡æœ¬å—</span></span><br><span class="line">    nodes_text_blocks = gtree.get_nodes_text_blocks()</span><br><span class="line">    content_blocks = []</span><br><span class="line">    <span class="keyword">for</span> tbs <span class="keyword">in</span> nodes_text_blocks:</span><br><span class="line">        content = <span class="string">""</span></span><br><span class="line">        tbs = pp.run(tbs)  <span class="comment"># é¢„æµ‹ç»“å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">        <span class="keyword">for</span> tb <span class="keyword">in</span> tbs:  <span class="comment"># è¾“å‡ºæ–‡æœ¬å’Œç»“å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">            content += tb[<span class="string">"text"</span>] + tb[<span class="string">"end"</span>]</span><br><span class="line">        content_blocks.append(content)</span><br><span class="line"></span><br><span class="line">    node_tbs = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> gtree.current_nodes:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> node[<span class="string">"units"</span>]:</span><br><span class="line">           <span class="keyword">continue</span>  <span class="comment"># è·³è¿‡æ²¡æœ‰å—çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        x0 = node[<span class="string">"x_left"</span>]</span><br><span class="line">        x1 = node[<span class="string">"x_right"</span>]</span><br><span class="line">        y0 = gtree.current_rows[node[<span class="string">"r_top"</span>]][<span class="number">0</span>][<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        y1 = gtree.current_rows[node[<span class="string">"r_bottom"</span>]][<span class="number">0</span>][<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line">        node_tbs.append([[x0, y0], [x1, y0], [x1, y1], [x0, y1]])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node_tbs, content_blocks</span><br></pre></td></tr></table></figure><a id="more"></a><p>ä¿®æ”¹åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">structure_ocr</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> line, tb <span class="keyword">in</span> enumerate(self.blocks_data):</span><br><span class="line">        tb[<span class="string">"bbox"</span>] = self.bboxes[line]</span><br><span class="line"></span><br><span class="line">    gtree = GapTree(<span class="keyword">lambda</span> tb: tb[<span class="string">"bbox"</span>])</span><br><span class="line">    sorted_text_blocks = gtree.sort(self.blocks_data)  <span class="comment"># æ–‡æœ¬å—æ’åº</span></span><br><span class="line">    <span class="comment"># print(sorted_text_blocks)</span></span><br><span class="line">    pp = ParagraphParse(self.get_info, self.set_end)</span><br><span class="line">    <span class="comment"># è·å–æ‰€æœ‰åŒºå—çš„æ–‡æœ¬å—</span></span><br><span class="line">    nodes_text_blocks = gtree.get_nodes_text_blocks()</span><br><span class="line">    content_blocks = []</span><br><span class="line">    <span class="keyword">for</span> tbs <span class="keyword">in</span> nodes_text_blocks:</span><br><span class="line">        content = <span class="string">""</span></span><br><span class="line">        tbs = pp.run(tbs)  <span class="comment"># é¢„æµ‹ç»“å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">        <span class="keyword">for</span> tb <span class="keyword">in</span> tbs:  <span class="comment"># è¾“å‡ºæ–‡æœ¬å’Œç»“å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">            content += tb[<span class="string">"text"</span>] + tb[<span class="string">"end"</span>]</span><br><span class="line">        content_blocks.append(content)</span><br><span class="line"></span><br><span class="line">    new_blocks = []</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> nodes_text_blocks:</span><br><span class="line">        x1_list = []</span><br><span class="line">        y1_list = []</span><br><span class="line">        x2_list = []</span><br><span class="line">        y2_list = []</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> m:</span><br><span class="line">            box_ = n.get(<span class="string">'box'</span>)</span><br><span class="line">            x1_list.append(box_[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">            y1_list.append(box_[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">            x2_list.append(box_[<span class="number">2</span>][<span class="number">0</span>])</span><br><span class="line">            y2_list.append(box_[<span class="number">2</span>][<span class="number">1</span>])</span><br><span class="line">        x1_ = min(x1_list)</span><br><span class="line">        y1_ = min(y1_list)</span><br><span class="line">        x2_ = max(x2_list)</span><br><span class="line">        y2_ = max(y2_list)</span><br><span class="line">        new_blocks.append([[x1_, y1_], [x2_, y1_], [x2_, y2_], [x1_, y2_]])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> new_blocks, content_blocks</span><br></pre></td></tr></table></figure><h3 id="å°è£…"><a href="#å°è£…" class="headerlink" title="å°è£…"></a>å°è£…</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StructureOCR</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, blocks_data)</span>:</span></span><br><span class="line">        self.blocks_data = blocks_data</span><br><span class="line">        self.bboxes = linePreprocessing(self.blocks_data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_info</span><span class="params">(tb)</span>:</span>  <span class="comment"># è¿”å›ä¿¡æ¯</span></span><br><span class="line">        b = tb[<span class="string">"box"</span>]</span><br><span class="line">        <span class="keyword">return</span> (b[<span class="number">0</span>][<span class="number">0</span>], b[<span class="number">0</span>][<span class="number">1</span>], b[<span class="number">2</span>][<span class="number">0</span>], b[<span class="number">2</span>][<span class="number">1</span>]), tb[<span class="string">"text"</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_end</span><span class="params">(tb, end)</span>:</span>  <span class="comment"># è·å–é¢„æµ‹çš„å—å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">        tb[<span class="string">"end"</span>] = end</span><br><span class="line">        <span class="comment"># alsoï¼š tb["text"] += end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">structure_ocr</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> line, tb <span class="keyword">in</span> enumerate(self.blocks_data):</span><br><span class="line">            tb[<span class="string">"bbox"</span>] = self.bboxes[line]</span><br><span class="line"></span><br><span class="line">        gtree = GapTree(<span class="keyword">lambda</span> tb: tb[<span class="string">"bbox"</span>])</span><br><span class="line">        sorted_text_blocks = gtree.sort(self.blocks_data)  <span class="comment"># æ–‡æœ¬å—æ’åº</span></span><br><span class="line">        <span class="comment"># print(sorted_text_blocks)</span></span><br><span class="line">        pp = ParagraphParse(self.get_info, self.set_end)</span><br><span class="line">        <span class="comment"># è·å–æ‰€æœ‰åŒºå—çš„æ–‡æœ¬å—</span></span><br><span class="line">        nodes_text_blocks = gtree.get_nodes_text_blocks()</span><br><span class="line">        content_blocks = []</span><br><span class="line">        <span class="keyword">for</span> tbs <span class="keyword">in</span> nodes_text_blocks:</span><br><span class="line">            content = <span class="string">""</span></span><br><span class="line">            tbs = pp.run(tbs)  <span class="comment"># é¢„æµ‹ç»“å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">            <span class="keyword">for</span> tb <span class="keyword">in</span> tbs:  <span class="comment"># è¾“å‡ºæ–‡æœ¬å’Œç»“å°¾åˆ†éš”ç¬¦</span></span><br><span class="line">                content += tb[<span class="string">"text"</span>] + tb[<span class="string">"end"</span>]</span><br><span class="line">            content_blocks.append(content)</span><br><span class="line"></span><br><span class="line">        node_tbs = []</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> gtree.current_nodes:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> node[<span class="string">"units"</span>]:</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># è·³è¿‡æ²¡æœ‰å—çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">            x0 = node[<span class="string">"x_left"</span>]</span><br><span class="line">            x1 = node[<span class="string">"x_right"</span>]</span><br><span class="line">            y0 = gtree.current_rows[node[<span class="string">"r_top"</span>]][<span class="number">0</span>][<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">            y1 = gtree.current_rows[node[<span class="string">"r_bottom"</span>]][<span class="number">0</span>][<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line">            node_tbs.append([[x0, y0], [x1, y0], [x1, y1], [x0, y1]])</span><br><span class="line"></span><br><span class="line">        new_blocks = []</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> nodes_text_blocks:</span><br><span class="line">            x1_list = []</span><br><span class="line">            y1_list = []</span><br><span class="line">            x2_list = []</span><br><span class="line">            y2_list = []</span><br><span class="line">            <span class="keyword">for</span> n <span class="keyword">in</span> m:</span><br><span class="line">                box_ = n.get(<span class="string">'box'</span>)</span><br><span class="line">                x1_list.append(box_[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">                y1_list.append(box_[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">                x2_list.append(box_[<span class="number">2</span>][<span class="number">0</span>])</span><br><span class="line">                y2_list.append(box_[<span class="number">2</span>][<span class="number">1</span>])</span><br><span class="line">            x1_ = min(x1_list)</span><br><span class="line">            y1_ = min(y1_list)</span><br><span class="line">            x2_ = max(x2_list)</span><br><span class="line">            y2_ = max(y2_list)</span><br><span class="line">            new_blocks.append([[x1_, y1_], [x2_, y1_], [x2_, y2_], [x1_, y2_]])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> new_blocks, content_blocks</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h3><p>ä½¿ç”¨paddleOCRï¼Œå°†OCRç»“æœè½¬æˆç®—æ³•è¾“å…¥çš„json_data</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">import</span> base64</span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">    test_image = <span class="string">'./test/t2.png'</span></span><br><span class="line">    origin_image = cv2.imread(test_image)</span><br><span class="line">    encoded = cv2_base64(origin_image)</span><br><span class="line"></span><br><span class="line">    json_data = &#123;</span><br><span class="line">        <span class="string">"img_b64"</span>: encoded,</span><br><span class="line">        <span class="string">"lang"</span>: <span class="string">"cn"</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(<span class="string">'localhost:port/ai/ppocr/ai/ppocr'</span>, json=json_data).json()</span><br><span class="line">    ocr_result = response.get(<span class="string">'data'</span>)</span><br><span class="line">    ocr_boxes = [line[<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]</span><br><span class="line">    ocr_txts = [line[<span class="number">1</span>][<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]</span><br><span class="line">    ocr_scores = [line[<span class="number">1</span>][<span class="number">1</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">    json_data = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(ocr_result[<span class="number">0</span>])):</span><br><span class="line">        json_data.append(&#123;</span><br><span class="line">            <span class="string">"box"</span>: [[int(i[<span class="number">0</span>]), int(i[<span class="number">1</span>])] <span class="keyword">for</span> i <span class="keyword">in</span> ocr_boxes[i]],</span><br><span class="line">            <span class="string">"score"</span>: ocr_scores[i],</span><br><span class="line">            <span class="string">"text"</span>: ocr_txts[i]</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    so = StructureOCR(json_data)</span><br><span class="line">    blocks, paragraphs = so.structure_ocr()</span><br></pre></td></tr></table></figure><h2 id="å¯è§†åŒ–"><a href="#å¯è§†åŒ–" class="headerlink" title="å¯è§†åŒ–"></a>å¯è§†åŒ–</h2><p>å½“æ–‡æœ¬æˆæ®µåï¼Œä¸èƒ½ç›´æ¥é€šè¿‡<code>draw.text</code>ç­‰æ–¹æ³•å°†æ–‡æœ¬å†™ä½œä¸€è¡Œï¼Œè€Œæ˜¯è¦è®¾ç½®æ¯è¡Œæ–‡æœ¬ä¸å¾—è¶…è¿‡æ®µè½å—çš„é•¿åº¦ï¼Œå¹¶ä¸”æ€»è¡Œæ•°ä¸èƒ½è¶…å‡ºæ®µè½å—æ€»é•¿åº¦ã€‚éœ€è¦è®¾è®¡ç®—æ³•ï¼Œå½“æ¯è¡Œæ–‡æœ¬è¶…å‡ºé•¿åº¦é™åˆ¶æ—¶ï¼Œè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ã€‚</p><h3 id="æ®µè½æ¢è¡Œç®—æ³•"><a href="#æ®µè½æ¢è¡Œç®—æ³•" class="headerlink" title="æ®µè½æ¢è¡Œç®—æ³•"></a>æ®µè½æ¢è¡Œç®—æ³•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisualizeOCR</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, im, boxes, texts)</span>:</span></span><br><span class="line">        self.boxes = boxes</span><br><span class="line">        self.texts = texts</span><br><span class="line">        <span class="keyword">if</span> isinstance(im, str):</span><br><span class="line">            self.im = Image.open(im)</span><br><span class="line">            self.im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">            self.im = cv2.cvtColor(im, cv2.COLOR_RGB2BGR)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">        self.im = Image.fromarray(self.im)</span><br><span class="line">        self.im = self.im.convert(<span class="string">'RGBA'</span>)</span><br><span class="line">        self.size = (int(self.im.size[<span class="number">0</span>]), int(self.im.size[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">split_text</span><span class="params">(self, width, sentence, font, text_scale)</span>:</span></span><br><span class="line">        <span class="comment"># æŒ‰è§„å®šå®½åº¦åˆ†ç»„</span></span><br><span class="line">        max_line_height, total_lines = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        allText = []</span><br><span class="line">        <span class="keyword">for</span> sen <span class="keyword">in</span> sentence.split(<span class="string">'\n'</span>):</span><br><span class="line">            paragraph, line_height, line_count = self.get_paragraph(sen, width, font, text_scale)</span><br><span class="line">            max_line_height = max(line_height, max_line_height)</span><br><span class="line">            total_lines += line_count</span><br><span class="line">            allText.append((paragraph, line_count))</span><br><span class="line">        line_height = max_line_height</span><br><span class="line">        total_height = total_lines * line_height</span><br><span class="line">        <span class="keyword">return</span> allText, total_height, line_height</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paragraph</span><span class="params">(text, width, font, text_scale)</span>:</span></span><br><span class="line">        <span class="comment"># å­—ä½“åƒç´ è¾ƒå°æ—¶ï¼Œæ¢è¡Œæ•ˆæœä¸ä½³ï¼Œæ¯5ä¸ªåƒç´ æ¢è¡Œä¸‹ç§»0.05ä¸ªåƒç´ </span></span><br><span class="line">        text_size = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> text_scale &lt;= <span class="number">15</span>:</span><br><span class="line">            text_size = <span class="number">0.1</span></span><br><span class="line">        <span class="keyword">elif</span> text_scale &lt;= <span class="number">10</span>:</span><br><span class="line">            text_size = <span class="number">0.15</span></span><br><span class="line">        <span class="keyword">elif</span> text_scale &lt;= <span class="number">5</span>:</span><br><span class="line">            text_size = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">        txt = Image.new(<span class="string">'RGBA'</span>, (<span class="number">1033</span>, <span class="number">737</span>), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>))</span><br><span class="line">        draw = ImageDraw.Draw(txt)</span><br><span class="line">        <span class="comment"># æ‰€æœ‰æ–‡å­—çš„æ®µè½</span></span><br><span class="line">        paragraph = <span class="string">""</span></span><br><span class="line">        <span class="comment"># å®½åº¦æ€»å’Œ</span></span><br><span class="line">        sum_width = <span class="number">0</span></span><br><span class="line">        <span class="comment"># è¡Œæ•°</span></span><br><span class="line">        line_count = <span class="number">1</span></span><br><span class="line">        <span class="comment"># è¡Œé«˜</span></span><br><span class="line">        line_height = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">            _, _, w, h = draw.textbbox((<span class="number">0</span>, <span class="number">0</span>), char, font=font)</span><br><span class="line"></span><br><span class="line">            sum_width += w</span><br><span class="line">            <span class="keyword">if</span> sum_width &gt; width:  <span class="comment"># è¶…è¿‡é¢„è®¾å®½åº¦å°±ä¿®æ”¹æ®µè½ ä»¥åŠå½“å‰è¡Œæ•°</span></span><br><span class="line">                line_count += <span class="number">1</span></span><br><span class="line">                line_count += text_size + <span class="number">0.1</span></span><br><span class="line">                sum_width = <span class="number">0</span></span><br><span class="line">                paragraph += <span class="string">'\n'</span></span><br><span class="line">            paragraph += char</span><br><span class="line">            line_height = max(h, line_height)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> paragraph.endswith(<span class="string">'\n'</span>):</span><br><span class="line">            paragraph += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> paragraph, line_height, line_count</span><br></pre></td></tr></table></figure><p>å®ç°æ¢è¡Œåï¼Œè¿˜éœ€è¦è€ƒè™‘å­—ä½“çš„å¤§å°ï¼Œå°†æ–‡å­—é”å®šåœ¨æ–‡æœ¬æ¡†å†…ã€‚åœ¨pillowåº“ä¸­<code>draw.text</code>æ–¹æ³•ä¸­ä¸­æ–‡å­—ç¬¦çš„å¤§å°è¿‘ä¼¼äºå…¶æ­£æ–¹çŸ©å½¢åƒç´ å—çš„è¾¹é•¿ã€‚æ¥ä¸‹æ¥éœ€è¦è€ƒè™‘çš„å‚æ•°å˜é‡æœ‰ä¸‰ä¸ªï¼š</p><p><strong>1.æ¯è¡Œæœ€å¤šçš„å­—ç¬¦xï¼ˆx_numï¼‰;</strong></p><p><strong>2.æ€»è¡Œæ•°yï¼ˆy_numï¼‰;</strong></p><p><strong>3.å­—ä½“åƒç´ sï¼ˆtext_scaleï¼‰</strong></p><p>åŒæ—¶è€ƒè™‘åˆ°å¹¶ä¸æ˜¯æ¯è¡Œéƒ½èƒ½å¤Ÿå†™æ»¡æ®µè½å—çš„é•¿åº¦ï¼Œå¯èƒ½å­˜åœ¨æå‰æ¢è¡Œã€ç©ºè¡Œã€ç»“æŸç­‰æƒ…å†µã€‚å¯ä»¥è®¡ç®—æ®µè½çš„æ€»æ¢è¡Œç¬¦æ•°é‡ï¼ˆcount(â€˜\nâ€™)ï¼‰ï¼Œå°†æ¢è¡Œç¬¦å‡ºç°çš„åœ°æ–¹è§†ä½œç©ºè¡Œï¼Œå¹¶Ã—2ç®—ä½œæ¢è¡Œ+ç•™ç™½éƒ¨åˆ†äº§ç”Ÿçš„åƒç´ é¢ç§¯ã€‚é‚£ä¹ˆå·²çŸ¥å¸¸é‡åŒ…æ‹¬ï¼š</p><p><strong>1.æ¢è¡Œæ¬¡æ•°bï¼ˆblank_scaleï¼‰ï¼›</strong></p><p><strong>2.æ€»å­—æ•°lï¼ˆlen(text)ï¼‰ï¼›</strong></p><p><strong>3.æ®µè½æ¡†é•¿åº¦wï¼ˆwidth_pï¼Œå€¼å–width*0.97ï¼Œå‡å°‘å‡ºç•Œæ¦‚ç‡ï¼‰</strong></p><p><strong>3.æ®µè½æ¡†å®½åº¦hï¼ˆheightï¼‰</strong></p><h4 id="è®¾ç«‹æ–¹ç¨‹ç»„ï¼š"><a href="#è®¾ç«‹æ–¹ç¨‹ç»„ï¼š" class="headerlink" title="è®¾ç«‹æ–¹ç¨‹ç»„ï¼š"></a>è®¾ç«‹æ–¹ç¨‹ç»„ï¼š</h4><p><strong><font color="gold">{</font></strong></p><p><strong><font color="gold">â‘  (y-b)*x=l</font></strong></p><p><strong><font color="gold">â‘¡ x*s = w</font></strong></p><p><strong><font color="gold">â‘¢ y*s = h</font></strong></p><p><strong><font color="gold">{</font></strong></p><h4 id="è½¬æ¢åˆ°ä»£ç ä¸­ï¼š"><a href="#è½¬æ¢åˆ°ä»£ç ä¸­ï¼š" class="headerlink" title="è½¬æ¢åˆ°ä»£ç ä¸­ï¼š"></a>è½¬æ¢åˆ°ä»£ç ä¸­ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(y_num - blank_scale) * x_num = len(text)</span><br><span class="line">x_num * text_scale = width_p</span><br><span class="line">y_num * text_scale = height</span><br></pre></td></tr></table></figure><h4 id="ç®€åŒ–æ–¹ç¨‹ç»„ï¼š"><a href="#ç®€åŒ–æ–¹ç¨‹ç»„ï¼š" class="headerlink" title="ç®€åŒ–æ–¹ç¨‹ç»„ï¼š"></a>ç®€åŒ–æ–¹ç¨‹ç»„ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(y_num - blank_scale) * x_num = len(text)</span><br><span class="line">x_num * text_scale = width_p</span><br><span class="line">y_num * text_scale = height</span><br><span class="line">===&gt;</span><br><span class="line">x_num = len(text) / (y_num - blank_scale)</span><br><span class="line">x_num = width_p / text_scale</span><br><span class="line">width_p / text_scale = len(text) / ((height / text_scale) - blank_scale)</span><br><span class="line">===&gt;</span><br><span class="line">len(text) * text_scale * text_scale + blank_scale * width_p * text_scale - width_p * height = <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="è§£æ–¹ç¨‹"><a href="#è§£æ–¹ç¨‹" class="headerlink" title="è§£æ–¹ç¨‹"></a>è§£æ–¹ç¨‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quadratic</span><span class="params">(a, b, c)</span>:</span></span><br><span class="line">    n = b * b - <span class="number">4</span> * a * c</span><br><span class="line">    <span class="keyword">import</span> math</span><br><span class="line">    <span class="keyword">if</span> n &gt;= <span class="number">0</span>:</span><br><span class="line">        x1 = (-b + math.sqrt(n)) / (<span class="number">2</span> * a)</span><br><span class="line">        x2 = (-b - math.sqrt(n)) / (<span class="number">2</span> * a)</span><br><span class="line">        <span class="keyword">return</span> x1 <span class="keyword">if</span> x1 &gt; <span class="number">0</span> <span class="keyword">else</span> x2</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure><h4 id="è·å–æœ€ä½³åƒç´ å€¼"><a href="#è·å–æœ€ä½³åƒç´ å€¼" class="headerlink" title="è·å–æœ€ä½³åƒç´ å€¼"></a>è·å–æœ€ä½³åƒç´ å€¼</h4><p>ç»è¿‡å®é™…è§‚å¯Ÿï¼Œå¯¹äºä¸­æ–‡å­—ç¬¦ï¼Œå°†è®¡ç®—å¾—åˆ°çš„åƒç´ å¤§å°-2åè§†è§‰æ•ˆæœæ›´ä½³ã€‚åŒæ—¶å¯ä»¥æ ¹æ®å›¾åƒå¤§å°ã€å•æ–‡æœ¬è¡Œä¸æ¢è¡Œç­‰å› ç´ ï¼Œé€‰æ‹©æœ€ä½³å­—ä½“å¤§å°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">text_scale = min(</span><br><span class="line">    int(quadratic(len(text), blank_scale * len(text), -width_p * height)) - <span class="number">2</span>,</span><br><span class="line">    int(self.size[<span class="number">0</span>] / <span class="number">66</span>),</span><br><span class="line">    int(height/<span class="number">2</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="å°è£…-1"><a href="#å°è£…-1" class="headerlink" title="å°è£…"></a>å°è£…</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisualizeOCR</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, im, boxes, texts)</span>:</span></span><br><span class="line">        self.boxes = boxes</span><br><span class="line">        self.texts = texts</span><br><span class="line">        <span class="keyword">if</span> isinstance(im, str):</span><br><span class="line">            self.im = Image.open(im)</span><br><span class="line">            self.im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">            self.im = cv2.cvtColor(im, cv2.COLOR_RGB2BGR)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">        self.im = Image.fromarray(self.im)</span><br><span class="line">        self.im = self.im.convert(<span class="string">'RGBA'</span>)</span><br><span class="line">        self.size = (int(self.im.size[<span class="number">0</span>]), int(self.im.size[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">split_text</span><span class="params">(self, width, sentence, font, text_scale)</span>:</span></span><br><span class="line">        <span class="comment"># æŒ‰è§„å®šå®½åº¦åˆ†ç»„</span></span><br><span class="line">        max_line_height, total_lines = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        allText = []</span><br><span class="line">        <span class="keyword">for</span> sen <span class="keyword">in</span> sentence.split(<span class="string">'\n'</span>):</span><br><span class="line">            paragraph, line_height, line_count = self.get_paragraph(sen, width, font, text_scale)</span><br><span class="line">            max_line_height = max(line_height, max_line_height)</span><br><span class="line">            total_lines += line_count</span><br><span class="line">            allText.append((paragraph, line_count))</span><br><span class="line">        line_height = max_line_height</span><br><span class="line">        total_height = total_lines * line_height</span><br><span class="line">        <span class="keyword">return</span> allText, total_height, line_height</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paragraph</span><span class="params">(text, width, font, text_scale)</span>:</span></span><br><span class="line">        text_size = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> text_scale &lt;= <span class="number">15</span>:</span><br><span class="line">            text_size = <span class="number">0.1</span></span><br><span class="line">        <span class="keyword">elif</span> text_scale &lt;= <span class="number">10</span>:</span><br><span class="line">            text_size = <span class="number">0.15</span></span><br><span class="line">        <span class="keyword">elif</span> text_scale &lt;= <span class="number">5</span>:</span><br><span class="line">            text_size = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">        txt = Image.new(<span class="string">'RGBA'</span>, (<span class="number">1033</span>, <span class="number">737</span>), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>))</span><br><span class="line">        draw = ImageDraw.Draw(txt)</span><br><span class="line">        <span class="comment"># æ‰€æœ‰æ–‡å­—çš„æ®µè½</span></span><br><span class="line">        paragraph = <span class="string">""</span></span><br><span class="line">        <span class="comment"># å®½åº¦æ€»å’Œ</span></span><br><span class="line">        sum_width = <span class="number">0</span></span><br><span class="line">        <span class="comment"># è¡Œæ•°</span></span><br><span class="line">        line_count = <span class="number">1</span></span><br><span class="line">        <span class="comment"># è¡Œé«˜</span></span><br><span class="line">        line_height = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">            _, _, w, h = draw.textbbox((<span class="number">0</span>, <span class="number">0</span>), char, font=font)</span><br><span class="line"></span><br><span class="line">            sum_width += w</span><br><span class="line">            <span class="keyword">if</span> sum_width &gt; width:  <span class="comment"># è¶…è¿‡é¢„è®¾å®½åº¦å°±ä¿®æ”¹æ®µè½ ä»¥åŠå½“å‰è¡Œæ•°</span></span><br><span class="line">                line_count += <span class="number">1</span></span><br><span class="line">                line_count += text_size + <span class="number">0.1</span></span><br><span class="line">                sum_width = <span class="number">0</span></span><br><span class="line">                paragraph += <span class="string">'\n'</span></span><br><span class="line">            paragraph += char</span><br><span class="line">            line_height = max(h, line_height)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> paragraph.endswith(<span class="string">'\n'</span>):</span><br><span class="line">            paragraph += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> paragraph, line_height, line_count</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visualize_ocr</span><span class="params">(self)</span>:</span></span><br><span class="line">        im_canvas = Image.new(<span class="string">'RGBA'</span>, self.size, (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, res <span class="keyword">in</span> enumerate(self.texts):</span><br><span class="line">            <span class="keyword">if</span> self.boxes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                box = self.boxes[i]</span><br><span class="line">                x, y = box[<span class="number">0</span>][<span class="number">0</span>], box[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">                width = int(box[<span class="number">1</span>][<span class="number">0</span>] - box[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">                height = int(box[<span class="number">2</span>][<span class="number">1</span>] - box[<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">                width_p = int((box[<span class="number">1</span>][<span class="number">0</span>] - box[<span class="number">0</span>][<span class="number">0</span>]) * <span class="number">0.97</span>)</span><br><span class="line">                text = res</span><br><span class="line">                <span class="keyword">if</span> text == <span class="string">""</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                blank_line_count = text.count(<span class="string">'\n'</span>)</span><br><span class="line">                blank_scale = blank_line_count * <span class="number">2</span> <span class="keyword">if</span> blank_line_count &gt; <span class="number">1</span> <span class="keyword">else</span> blank_line_count</span><br><span class="line"></span><br><span class="line">                <span class="string">"""</span></span><br><span class="line"><span class="string">                æ–¹ç¨‹ç»„ï¼Œæ±‚å­—ä½“æœ€å¤§åƒç´ </span></span><br><span class="line"><span class="string">                x_num: xè½´ä¸ªæ•°</span></span><br><span class="line"><span class="string">                y_num: yè½´ä¸ªæ•°</span></span><br><span class="line"><span class="string">                text_scale: æ–‡æœ¬åƒç´ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                (y_num - blank_scale) * x_num = len(text)</span></span><br><span class="line"><span class="string">                x_num * text_scale = width_p</span></span><br><span class="line"><span class="string">                y_num * text_scale = height</span></span><br><span class="line"><span class="string">                ===&gt;</span></span><br><span class="line"><span class="string">                x_num = len(text) / (y_num - blank_scale)</span></span><br><span class="line"><span class="string">                x_num = width_p / text_scale</span></span><br><span class="line"><span class="string">                width_p / text_scale = len(text) / ((height / text_scale) - blank_scale)</span></span><br><span class="line"><span class="string">                ===&gt;</span></span><br><span class="line"><span class="string">                len(text) * text_scale * text_scale + blank_scale * len(text) * text_scale - width_p * height = 0</span></span><br><span class="line"><span class="string">                """</span></span><br><span class="line"></span><br><span class="line">                text_scale = min(</span><br><span class="line">                    int(quadratic(len(text), blank_scale * len(text), -width_p * height)) - <span class="number">2</span>,</span><br><span class="line">                    int(self.size[<span class="number">0</span>] / <span class="number">66</span>),</span><br><span class="line">                    int(height/<span class="number">2</span>)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                font = ImageFont.truetype(<span class="string">"SourceHanSansCN-Medium.otf"</span>, text_scale)</span><br><span class="line">                draw = ImageDraw.Draw(im_canvas)</span><br><span class="line">                paragraph, note_height, line_height = self.split_text(width_p, text, font, text_scale)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> sen, line_count <span class="keyword">in</span> paragraph:</span><br><span class="line">                    draw.text((x, y), sen, fill=(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), font=font)</span><br><span class="line">                    y += line_height * line_count</span><br><span class="line">                draw.rectangle(</span><br><span class="line">                    ((box[<span class="number">0</span>][<span class="number">0</span>], box[<span class="number">0</span>][<span class="number">1</span>]), (box[<span class="number">2</span>][<span class="number">0</span>], box[<span class="number">2</span>][<span class="number">1</span>])),</span><br><span class="line">                    fill=<span class="literal">None</span>,</span><br><span class="line">                    outline=(<span class="number">139</span>, <span class="number">0</span>, <span class="number">139</span>),</span><br><span class="line">                    width=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        im = image_join(self.im, im_canvas, <span class="string">'x'</span>)</span><br><span class="line">        im = im.convert(<span class="string">'RGB'</span>)</span><br><span class="line">        <span class="comment"># è¿˜åŸè¿ç»­å­˜å‚¨æ•°ç»„</span></span><br><span class="line">        im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">        <span class="keyword">return</span> im</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quadratic</span><span class="params">(a, b, c)</span>:</span></span><br><span class="line">    n = b * b - <span class="number">4</span> * a * c</span><br><span class="line">    <span class="keyword">import</span> math</span><br><span class="line">    <span class="keyword">if</span> n &gt;= <span class="number">0</span>:</span><br><span class="line">        x1 = (-b + math.sqrt(n)) / (<span class="number">2</span> * a)</span><br><span class="line">        x2 = (-b - math.sqrt(n)) / (<span class="number">2</span> * a)</span><br><span class="line">        <span class="keyword">return</span> x1 <span class="keyword">if</span> x1 &gt; <span class="number">0</span> <span class="keyword">else</span> x2</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'è¯¥ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹æ— è§£'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image_join</span><span class="params">(img1, img2, flag=<span class="string">'y'</span>)</span>:</span></span><br><span class="line">    size1, size2 = img1.size, img2.size</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="string">'x'</span>:</span><br><span class="line">        im = Image.new(<span class="string">"RGB"</span>, (size1[<span class="number">0</span>] + size2[<span class="number">0</span>], size1[<span class="number">1</span>]))</span><br><span class="line">        loc1, loc2 = (<span class="number">0</span>, <span class="number">0</span>), (size1[<span class="number">0</span>], <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        im = Image.new(<span class="string">"RGB"</span>, (size1[<span class="number">0</span>], size2[<span class="number">1</span>] + size1[<span class="number">1</span>]))</span><br><span class="line">        loc1, loc2 = (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">0</span>, size1[<span class="number">1</span>])</span><br><span class="line">    im.paste(img1, loc1)</span><br><span class="line">    im.paste(img2, loc2)</span><br><span class="line">    <span class="keyword">return</span> im</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨-1"><a href="#è°ƒç”¨-1" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">import</span> base64</span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">    test_image = <span class="string">'./test/t2.png'</span></span><br><span class="line">    origin_image = cv2.imread(test_image)</span><br><span class="line">    encoded = cv2_base64(origin_image)</span><br><span class="line"></span><br><span class="line">    json_data = &#123;</span><br><span class="line">        <span class="string">"img_b64"</span>: encoded,</span><br><span class="line">        <span class="string">"lang"</span>: <span class="string">"cn"</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(<span class="string">'localhost:port/ai/ppocr'</span>, json=json_data).json()</span><br><span class="line">    ocr_result = response.get(<span class="string">'data'</span>)</span><br><span class="line">    ocr_boxes = [line[<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]</span><br><span class="line">    ocr_txts = [line[<span class="number">1</span>][<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]</span><br><span class="line">    ocr_scores = [line[<span class="number">1</span>][<span class="number">1</span>] <span class="keyword">for</span> line <span class="keyword">in</span> ocr_result[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">    json_data = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(ocr_result[<span class="number">0</span>])):</span><br><span class="line">        json_data.append(&#123;</span><br><span class="line">            <span class="string">"box"</span>: [[int(i[<span class="number">0</span>]), int(i[<span class="number">1</span>])] <span class="keyword">for</span> i <span class="keyword">in</span> ocr_boxes[i]],</span><br><span class="line">            <span class="string">"score"</span>: ocr_scores[i],</span><br><span class="line">            <span class="string">"text"</span>: ocr_txts[i]</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    so = StructureOCR(json_data)</span><br><span class="line">    blocks, paragraphs = so.structure_ocr()</span><br><span class="line">    </span><br><span class="line">    vo = VisualizeOCR(origin_image, blocks, paragraphs)</span><br><span class="line">    image = vo.visualize_ocr()</span><br><span class="line">    </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    æ˜¾ç¤ºå›¾åƒ</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># é€‚é…æ˜¾ç¤ºå™¨</span></span><br><span class="line">    <span class="keyword">if</span> image.shape[<span class="number">0</span>] &gt; <span class="number">1080</span>:</span><br><span class="line">        mag = int(image.shape[<span class="number">0</span>] / <span class="number">1080</span>)</span><br><span class="line">        image = cv2.resize(image, (int(image.shape[<span class="number">1</span>] / mag), int(image.shape[<span class="number">0</span>] / mag)))</span><br><span class="line">    <span class="keyword">if</span> image.shape[<span class="number">1</span>] &gt; <span class="number">1920</span>:</span><br><span class="line">        mag = image.shape[<span class="number">1</span>] / <span class="number">1920</span></span><br><span class="line">        image = cv2.resize(image, (int(image.shape[<span class="number">1</span>] / mag), int(image.shape[<span class="number">0</span>] / mag)))</span><br><span class="line"></span><br><span class="line">    cv2.imshow(<span class="string">"image"</span>, image)</span><br><span class="line">    cv2.waitKey(<span class="number">-1</span>)</span><br></pre></td></tr></table></figure><p>æ•ˆæœæ¼”ç¤ºï¼š</p><p><img src="/2024/08/06/é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–/2.png" alt></p><p><img src="/2024/08/06/é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–/3.png" alt></p><p><img src="/2024/08/06/é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–/4.png" alt></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åšæ–‡æ¡£ç¿»è¯‘çš„OCRç¨‹åºæ—¶ï¼Œä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå› ä¸ºé€šå¸¸OCRæ¨¡å‹çš„è¾“å‡ºéƒ½æ˜¯æŒ‰æ–‡æœ¬å—é€è¡Œè¿”å›ï¼Œå½“ç»“æœè¿›å…¥ç¿»è¯‘æ¨¡å‹æ—¶ä¼šä¸¢å¤±è¡Œä¸è¡Œä¹‹é—´çš„ä¿¡æ¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å¯¹OCRç»“æœè¿›è¡Œè¿›ä¸€æ­¥çš„ç‰ˆé¢åˆ†æï¼Œå°†æ–‡æœ¬å—åˆå¹¶æˆæ®µè½ï¼Œå†è¾“å…¥åˆ°ç¿»è¯‘æ¨¡å‹ä¸­å»ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç®—æ³•&quot;&gt;&lt;a href=&quot;#ç®—æ³•&quot; class=&quot;headerlink&quot; title=&quot;ç®—æ³•&quot;&gt;&lt;/a&gt;ç®—æ³•&lt;/h2&gt;&lt;p&gt;é—´éš™Â·æ ‘Â·æ’åºç®—æ³•&lt;/p&gt;
&lt;p&gt;å‚è€ƒé“¾æ¥ï¼š&lt;a href=&quot;https://github.com/hiroi-sora/GapTree_Sort_Algorithm&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/hiroi-sora/GapTree_Sort_Algorithm&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/08/06/é—´éš™æ ‘æ’åºç®—æ³•çš„å¯è§†åŒ–/1.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;ç®—æ³•ä¸»è¦å¯¹æ–‡æœ¬å—æŒ‰é—´éš™è¿›è¡Œåˆ’åˆ†ï¼Œå†ç»è¿‡æ ‘å½¢æ’åºï¼Œå°†åº•å±‚OCRçš„è¾“å‡ºç»“æœä»å­æ–‡æœ¬å—è½¬åŒ–æˆæ®µè½æ–‡æœ¬å—ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ç®—æ³•é‡æ„&quot;&gt;&lt;a href=&quot;#ç®—æ³•é‡æ„&quot; class=&quot;headerlink&quot; title=&quot;ç®—æ³•é‡æ„&quot;&gt;&lt;/a&gt;ç®—æ³•é‡æ„&lt;/h3&gt;&lt;p&gt;ä¸ºäº†ä½¿æ–‡æœ¬å—çš„å®šä½æ›´åŠ å‡†ç¡®ï¼Œä½¿ç”¨åŸç®—æ³•è¾“å‡ºæ®µè½å—ï¼ˆcontent_blocksï¼‰çš„ä¸Šä¸‹å·¦å³å››ä¸ªè¾¹ç•Œç‚¹æ„æˆæ–°æ®µè½å—ï¼ˆnew_blocksï¼‰&lt;/p&gt;
&lt;p&gt;æºç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;structure_ocr&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; line, tb &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; enumerate(self.blocks_data):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        tb[&lt;span class=&quot;string&quot;&gt;&quot;bbox&quot;&lt;/span&gt;] = self.bboxes[line]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    gtree = GapTree(&lt;span class=&quot;keyword&quot;&gt;lambda&lt;/span&gt; tb: tb[&lt;span class=&quot;string&quot;&gt;&quot;bbox&quot;&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sorted_text_blocks = gtree.sort(self.blocks_data)  &lt;span class=&quot;comment&quot;&gt;# æ–‡æœ¬å—æ’åº&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# print(sorted_text_blocks)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pp = ParagraphParse(self.get_info, self.set_end)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# è·å–æ‰€æœ‰åŒºå—çš„æ–‡æœ¬å—&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    nodes_text_blocks = gtree.get_nodes_text_blocks()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    content_blocks = []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; tbs &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; nodes_text_blocks:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        content = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        tbs = pp.run(tbs)  &lt;span class=&quot;comment&quot;&gt;# é¢„æµ‹ç»“å°¾åˆ†éš”ç¬¦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; tb &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; tbs:  &lt;span class=&quot;comment&quot;&gt;# è¾“å‡ºæ–‡æœ¬å’Œç»“å°¾åˆ†éš”ç¬¦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            content += tb[&lt;span class=&quot;string&quot;&gt;&quot;text&quot;&lt;/span&gt;] + tb[&lt;span class=&quot;string&quot;&gt;&quot;end&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        content_blocks.append(content)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    node_tbs = []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; node &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; gtree.current_nodes:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; node[&lt;span class=&quot;string&quot;&gt;&quot;units&quot;&lt;/span&gt;]:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# è·³è¿‡æ²¡æœ‰å—çš„æ ¹èŠ‚ç‚¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        x0 = node[&lt;span class=&quot;string&quot;&gt;&quot;x_left&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        x1 = node[&lt;span class=&quot;string&quot;&gt;&quot;x_right&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        y0 = gtree.current_rows[node[&lt;span class=&quot;string&quot;&gt;&quot;r_top&quot;&lt;/span&gt;]][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;][&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        y1 = gtree.current_rows[node[&lt;span class=&quot;string&quot;&gt;&quot;r_bottom&quot;&lt;/span&gt;]][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;][&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        node_tbs.append([[x0, y0], [x1, y0], [x1, y1], [x0, y1]])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; node_tbs, content_blocks&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="ç®—æ³•" scheme="http://yoursite.com/categories/ç®—æ³•/"/>
    
    
    <category term="OCR" scheme="http://yoursite.com/tags/OCR/"/>
    
  </entry>
  
  <entry>
    <title>Surya OCR</title>
    <link href="http://yoursite.com/2024/07/08/Surya-OCR/"/>
    <id>http://yoursite.com/2024/07/08/Surya-OCR/</id>
    <published>2024-07-08T09:26:27.000Z</published>
    <updated>2024-12-06T09:44:51.112Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="ç‰ˆæœ¬ï¼š"><a href="#ç‰ˆæœ¬ï¼š" class="headerlink" title="ç‰ˆæœ¬ï¼š"></a>ç‰ˆæœ¬ï¼š</h3><p>python3.9 + surya-ocr 0.4.15</p><h3 id="æ¨¡å‹å‡†å¤‡ï¼š"><a href="#æ¨¡å‹å‡†å¤‡ï¼š" class="headerlink" title="æ¨¡å‹å‡†å¤‡ï¼š"></a>æ¨¡å‹å‡†å¤‡ï¼š</h3><p>æ£€æµ‹æ¨¡å‹ï¼šsurya_det3</p><p>è¯†åˆ«æ¨¡å‹ï¼šsurya_rec</p><p>ç‰ˆé¢æ¨¡å‹ï¼šsurya_layout3</p><h3 id="æºç ä¿®æ”¹"><a href="#æºç ä¿®æ”¹" class="headerlink" title="æºç ä¿®æ”¹"></a>æºç ä¿®æ”¹</h3><p>å› é¦–æ¬¡ä½¿ç”¨ä¸‹è½½æ¨¡å‹è¢«å¢™ï¼Œæå‰å°†æ¨¡å‹æ”¶å½•è‡³æ¨¡å‹æ–‡ä»¶å¤¹å¹¶ä¿®æ”¹æºç å¯¼å…¥éƒ¨åˆ†ï¼š</p><p>(æºç ä½ç½®ï¼š<code>...Python39/Lib/site-packages/surya/settings.py</code>)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Dict, Optional</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> find_dotenv</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> computed_field</span><br><span class="line"><span class="keyword">from</span> pydantic_settings <span class="keyword">import</span> BaseSettings</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Settings</span><span class="params">(BaseSettings)</span>:</span></span><br><span class="line">    <span class="comment"># General</span></span><br><span class="line">    TORCH_DEVICE: Optional[str] = <span class="literal">None</span></span><br><span class="line">    IMAGE_DPI: int = <span class="number">96</span></span><br><span class="line">    IN_STREAMLIT: bool = <span class="literal">False</span> <span class="comment"># Whether we're running in streamlit</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Paths</span></span><br><span class="line">    DATA_DIR: str = <span class="string">"data"</span></span><br><span class="line">    RESULT_DIR: str = <span class="string">"results"</span></span><br><span class="line">    BASE_DIR: str = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">    FONT_DIR: str = os.path.join(BASE_DIR, <span class="string">"static"</span>, <span class="string">"fonts"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @computed_field</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">TORCH_DEVICE_MODEL</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">if</span> self.TORCH_DEVICE <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self.TORCH_DEVICE</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"cuda"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torch.backends.mps.is_available():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"mps"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"cpu"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Text detection</span></span><br><span class="line">    DETECTOR_BATCH_SIZE: Optional[int] = <span class="literal">None</span> <span class="comment"># Defaults to 2 for CPU/MPS, 32 otherwise</span></span><br><span class="line">    DETECTOR_MODEL_CHECKPOINT: str = <span class="string">r"D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_det3"</span></span><br><span class="line">    DETECTOR_BENCH_DATASET_NAME: str = <span class="string">"vikp/doclaynet_bench"</span></span><br><span class="line">    DETECTOR_IMAGE_CHUNK_HEIGHT: int = <span class="number">1400</span> <span class="comment"># Height at which to slice images vertically</span></span><br><span class="line">    DETECTOR_TEXT_THRESHOLD: float = <span class="number">0.6</span> <span class="comment"># Threshold for text detection (above this is considered text)</span></span><br><span class="line">    DETECTOR_BLANK_THRESHOLD: float = <span class="number">0.35</span> <span class="comment"># Threshold for blank space (below this is considered blank)</span></span><br><span class="line">    DETECTOR_POSTPROCESSING_CPU_WORKERS: int = min(<span class="number">8</span>, os.cpu_count()) <span class="comment"># Number of workers for postprocessing</span></span><br><span class="line">    DETECTOR_MIN_PARALLEL_THRESH: int = <span class="number">3</span> <span class="comment"># Minimum number of images before we parallelize</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Text recognition</span></span><br><span class="line">    RECOGNITION_MODEL_CHECKPOINT: str = <span class="string">r"D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_rec"</span></span><br><span class="line">    RECOGNITION_MAX_TOKENS: int = <span class="number">175</span></span><br><span class="line">    RECOGNITION_BATCH_SIZE: Optional[int] = <span class="literal">None</span> <span class="comment"># Defaults to 8 for CPU/MPS, 256 otherwise</span></span><br><span class="line">    RECOGNITION_IMAGE_SIZE: Dict = &#123;<span class="string">"height"</span>: <span class="number">196</span>, <span class="string">"width"</span>: <span class="number">896</span>&#125;</span><br><span class="line">    RECOGNITION_RENDER_FONTS: Dict[str, str] = &#123;</span><br><span class="line">        <span class="string">"all"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCurrent-Regular.ttf"</span>),</span><br><span class="line">        <span class="string">"zh"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCJKCore.ttf"</span>),</span><br><span class="line">        <span class="string">"ja"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCJKCore.ttf"</span>),</span><br><span class="line">        <span class="string">"ko"</span>: os.path.join(FONT_DIR, <span class="string">"GoNotoCJKCore.ttf"</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    RECOGNITION_FONT_DL_BASE: str = <span class="string">"https://github.com/satbyy/go-noto-universal/releases/download/v7.0"</span></span><br><span class="line">    RECOGNITION_BENCH_DATASET_NAME: str = <span class="string">"vikp/rec_bench"</span></span><br><span class="line">    RECOGNITION_PAD_VALUE: int = <span class="number">255</span> <span class="comment"># Should be 0 or 255</span></span><br><span class="line">    RECOGNITION_STATIC_CACHE: bool = <span class="literal">False</span> <span class="comment"># Static cache for torch compile</span></span><br><span class="line">    RECOGNITION_MAX_LANGS: int = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Layout</span></span><br><span class="line">    LAYOUT_MODEL_CHECKPOINT: str = <span class="string">r"D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_layout3"</span></span><br><span class="line">    LAYOUT_BENCH_DATASET_NAME: str = <span class="string">"vikp/publaynet_bench"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ordering</span></span><br><span class="line">    ORDER_MODEL_CHECKPOINT: str = <span class="string">"vikp/surya_order"</span></span><br><span class="line">    ORDER_IMAGE_SIZE: Dict = &#123;<span class="string">"height"</span>: <span class="number">1024</span>, <span class="string">"width"</span>: <span class="number">1024</span>&#125;</span><br><span class="line">    ORDER_MAX_BOXES: int = <span class="number">256</span></span><br><span class="line">    ORDER_BATCH_SIZE: Optional[int] = <span class="literal">None</span>  <span class="comment"># Defaults to 4 for CPU/MPS, 32 otherwise</span></span><br><span class="line">    ORDER_BENCH_DATASET_NAME: str = <span class="string">"vikp/order_bench"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Tesseract (for benchmarks only)</span></span><br><span class="line">    TESSDATA_PREFIX: Optional[str] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @computed_field</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">MODEL_DTYPE</span><span class="params">(self)</span> -&gt; torch.dtype:</span></span><br><span class="line">        <span class="keyword">return</span> torch.float32 <span class="keyword">if</span> self.TORCH_DEVICE_MODEL == <span class="string">"cpu"</span> <span class="keyword">else</span> torch.float16</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">        env_file = find_dotenv(<span class="string">"local.env"</span>)</span><br><span class="line">        extra = <span class="string">"ignore"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">settings = Settings()</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="å°è¯­ç§OCRè¯†åˆ«"><a href="#å°è¯­ç§OCRè¯†åˆ«" class="headerlink" title="å°è¯­ç§OCRè¯†åˆ«"></a>å°è¯­ç§OCRè¯†åˆ«</h3><p><img src="/2024/07/08/Surya-OCR/yn.png" alt></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> surya.detection <span class="keyword">import</span> batch_text_detection</span><br><span class="line"><span class="keyword">from</span> surya.layout <span class="keyword">import</span> batch_layout_detection</span><br><span class="line"><span class="keyword">from</span> surya.model.detection.model <span class="keyword">import</span> load_model, load_processor</span><br><span class="line"><span class="keyword">from</span> surya.settings <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">IMAGE_PATH = <span class="string">'./test/7.png'</span>  <span class="comment">## éœ€æ£€æµ‹å›¾ç‰‡åœ°å€</span></span><br><span class="line">DET_MODEL_PATH = <span class="string">'./models/surya_det3'</span>  <span class="comment">## æ¨¡å‹å‚æ•°ä¿å­˜åœ°å€</span></span><br><span class="line">LAYOUT_MODEL_PATH = <span class="string">'./models/surya_layout3'</span>  <span class="comment">## æ¨¡å‹å‚æ•°ä¿å­˜åœ°å€</span></span><br><span class="line"></span><br><span class="line">image = Image.open(IMAGE_PATH)</span><br><span class="line">surya_layout_model = load_model(checkpoint=settings.LAYOUT_MODEL_CHECKPOINT)</span><br><span class="line">surya_processor = load_processor(checkpoint=settings.LAYOUT_MODEL_CHECKPOINT)</span><br><span class="line">surya_det_model = load_model()</span><br><span class="line">surya_det_processor = load_processor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># layout_predictions is a list of dicts, one per image</span></span><br><span class="line">line_predictions = batch_text_detection([image], surya_det_model, surya_det_processor)</span><br><span class="line">layout_predictions = batch_layout_detection([image], surya_layout_model, surya_processor, line_predictions)</span><br><span class="line"></span><br><span class="line">image = cv2.imread(IMAGE_PATH)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">surya_layout2paddle_structure</span><span class="params">(surya_layout_res, im)</span>:</span></span><br><span class="line">    paddle_structure_res = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> surya_layout_res[<span class="number">0</span>].bboxes:</span><br><span class="line">        surya_layout_dict = dict(item)</span><br><span class="line">        paddle_structure_res.append(&#123;</span><br><span class="line">            <span class="string">'bbox'</span>: [</span><br><span class="line">                surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">0</span>][<span class="number">0</span>],</span><br><span class="line">                surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">0</span>][<span class="number">1</span>],</span><br><span class="line">                surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">2</span>][<span class="number">0</span>],</span><br><span class="line">                surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">'type'</span>: surya_layout_dict[<span class="string">'label'</span>],</span><br><span class="line">            <span class="string">'img'</span>: im[</span><br><span class="line">                   surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">0</span>][<span class="number">1</span>]: surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">2</span>][<span class="number">1</span>],</span><br><span class="line">                   surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">0</span>][<span class="number">0</span>]: surya_layout_dict[<span class="string">'polygon'</span>][<span class="number">2</span>][<span class="number">0</span>]</span><br><span class="line">                   ]</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> paddle_structure_res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(surya_layout2paddle_structure(layout_predictions, image))</span><br><span class="line"></span><br><span class="line">res = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> layout_predictions[<span class="number">0</span>].bboxes:</span><br><span class="line">    res.append(dict(i))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p>è¯†åˆ«ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Loaded detection model ./models/surya_det3 on device cpu with dtype torch.float32</span><br><span class="line">Loaded recognition model ./models/surya_rec on device cpu with dtype torch.float32</span><br><span class="line">ok</span><br><span class="line">Detecting bboxes: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:05&lt;00:00,  5.15s/it]</span><br><span class="line">Recognizing Text: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:18&lt;00:00, 18.12s/it]</span><br><span class="line"></span><br><span class="line">[OCRResult(text_lines=[TextLine(polygon=[[65.0, 12.0], [424.0, 11.0], [425.0, 49.0], [66.0, 50.0]], confidence=0.8231586813926697, text=&apos;Ä Phong CÃ¡ch&apos;, bbox=[65.0, 12.0, 424.0, 49.0]), TextLine(polygon=[[146.0, 60.0], [345.0, 60.0], [345.0, 95.0], [146.0, 95.0]], confidence=0.9834306836128235, text=&apos;KhÃ¡c BiÃªt&apos;, bbox=[146.0, 60.0, 345.0, 95.0]), TextLine(polygon=[[9.0, 114.0], [482.0, 114.0], [482.0, 126.0], [9.0, 126.0]], confidence=0.9684180021286011, text=&apos;TrÃªn tay chÃ© tÃ¡c nquyÃªn khÅ‘i Ä‘áº«n Ä‘áº§u xu hÆ°á»›ng vá»›i thiáº¿t káº¿ thÃ¢n mÃ¡y liÃ¨n mach, Ä‘Ã´ mÃ²ng áº¥n tÆ°Æ¡ng 8.5mm cÃ¹ng&apos;, bbox=[9.0, 114.0, 482.0, 126.0]), TextLine(polygon=[[0.0, 132.0], [490.0, 132.0], [490.0, 143.0], [0.0, 143.0]], confidence=0.9850525856018066, text=&apos;kiá»ƒu dÃ¡ng mÄƒt kÃ­nh bÃ³ng mÆ°Æ¡t, sang trong tá»« Galaxy M30. Vá»«a vÄƒn hoÃ n háº£o trong lÃ²ng bÃ n tay, thoáº£ thÃ­ch thá»ƒ hiá»‡n&apos;, bbox=[0.0, 132.0, 490.0, 143.0]), TextLine(polygon=[[95.0, 149.0], [393.0, 149.0], [394.0, 160.0], [95.0, 160.0]], confidence=0.9769484400749207, text=&apos;phong cach thá»i thÆ°á»£ng vá»›i hai phiÃªn báº£n máº£u Äen hoÄc Xanh cÃ¡ tÃ­nh.&apos;, bbox=[95.0, 149.0, 393.0, 160.0])], languages=[&apos;en&apos;], image_bbox=[0.0, 0.0, 494.0, 182.0])]</span><br><span class="line">[&apos;Ä Phong CÃ¡ch&apos;, &apos;KhÃ¡c BiÃªt&apos;, &apos;TrÃªn tay chÃ© tÃ¡c nquyÃªn khÅ‘i Ä‘áº«n Ä‘áº§u xu hÆ°á»›ng vá»›i thiáº¿t káº¿ thÃ¢n mÃ¡y liÃ¨n mach, Ä‘Ã´ mÃ²ng áº¥n tÆ°Æ¡ng 8.5mm cÃ¹ng&apos;, &apos;kiá»ƒu dÃ¡ng mÄƒt kÃ­nh bÃ³ng mÆ°Æ¡t, sang trong tá»« Galaxy M30. Vá»«a vÄƒn hoÃ n háº£o trong lÃ²ng bÃ n tay, thoáº£ thÃ­ch thá»ƒ hiá»‡n&apos;, &apos;phong cach thá»i thÆ°á»£ng vá»›i hai phiÃªn báº£n máº£u Äen hoÄc Xanh cÃ¡ tÃ­nh.&apos;] 5</span><br><span class="line">[[[65.0, 12.0], [424.0, 11.0], [425.0, 49.0], [66.0, 50.0]], [[146.0, 60.0], [345.0, 60.0], [345.0, 95.0], [146.0, 95.0]], [[9.0, 114.0], [482.0, 114.0], [482.0, 126.0], [9.0, 126.0]], [[0.0, 132.0], [490.0, 132.0], [490.0, 143.0], [0.0, 143.0]], [[95.0, 149.0], [393.0, 149.0], [394.0, 160.0], [95.0, 160.0]]] 5</span><br><span class="line">[0.8231586813926697, 0.9834306836128235, 0.9684180021286011, 0.9850525856018066, 0.9769484400749207] 5</span><br></pre></td></tr></table></figure><h3 id="OCRç‰ˆé¢åˆ†æ"><a href="#OCRç‰ˆé¢åˆ†æ" class="headerlink" title="OCRç‰ˆé¢åˆ†æ"></a>OCRç‰ˆé¢åˆ†æ</h3><p>æœªå®Œå¾…ç»­</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒå‡†å¤‡&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;/a&gt;ç¯å¢ƒå‡†å¤‡&lt;/h2&gt;&lt;h3 id=&quot;ç‰ˆæœ¬ï¼š&quot;&gt;&lt;a href=&quot;#ç‰ˆæœ¬ï¼š&quot; class=&quot;headerlink&quot; title=&quot;ç‰ˆæœ¬ï¼š&quot;&gt;&lt;/a&gt;ç‰ˆæœ¬ï¼š&lt;/h3&gt;&lt;p&gt;python3.9 + surya-ocr 0.4.15&lt;/p&gt;
&lt;h3 id=&quot;æ¨¡å‹å‡†å¤‡ï¼š&quot;&gt;&lt;a href=&quot;#æ¨¡å‹å‡†å¤‡ï¼š&quot; class=&quot;headerlink&quot; title=&quot;æ¨¡å‹å‡†å¤‡ï¼š&quot;&gt;&lt;/a&gt;æ¨¡å‹å‡†å¤‡ï¼š&lt;/h3&gt;&lt;p&gt;æ£€æµ‹æ¨¡å‹ï¼šsurya_det3&lt;/p&gt;
&lt;p&gt;è¯†åˆ«æ¨¡å‹ï¼šsurya_rec&lt;/p&gt;
&lt;p&gt;ç‰ˆé¢æ¨¡å‹ï¼šsurya_layout3&lt;/p&gt;
&lt;h3 id=&quot;æºç ä¿®æ”¹&quot;&gt;&lt;a href=&quot;#æºç ä¿®æ”¹&quot; class=&quot;headerlink&quot; title=&quot;æºç ä¿®æ”¹&quot;&gt;&lt;/a&gt;æºç ä¿®æ”¹&lt;/h3&gt;&lt;p&gt;å› é¦–æ¬¡ä½¿ç”¨ä¸‹è½½æ¨¡å‹è¢«å¢™ï¼Œæå‰å°†æ¨¡å‹æ”¶å½•è‡³æ¨¡å‹æ–‡ä»¶å¤¹å¹¶ä¿®æ”¹æºç å¯¼å…¥éƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;p&gt;(æºç ä½ç½®ï¼š&lt;code&gt;...Python39/Lib/site-packages/surya/settings.py&lt;/code&gt;)&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; typing &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Dict, Optional&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; dotenv &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; find_dotenv&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; pydantic &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; computed_field&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; pydantic_settings &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; BaseSettings&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; torch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; os&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Settings&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(BaseSettings)&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# General&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    TORCH_DEVICE: Optional[str] = &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    IMAGE_DPI: int = &lt;span class=&quot;number&quot;&gt;96&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    IN_STREAMLIT: bool = &lt;span class=&quot;literal&quot;&gt;False&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether we&#39;re running in streamlit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# Paths&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DATA_DIR: str = &lt;span class=&quot;string&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RESULT_DIR: str = &lt;span class=&quot;string&quot;&gt;&quot;results&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    BASE_DIR: str = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FONT_DIR: str = os.path.join(BASE_DIR, &lt;span class=&quot;string&quot;&gt;&quot;static&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;fonts&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;    @computed_field&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TORCH_DEVICE_MODEL&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt; -&amp;gt; str:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.TORCH_DEVICE &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; self.TORCH_DEVICE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; torch.cuda.is_available():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;cuda&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; torch.backends.mps.is_available():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;mps&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;cpu&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# Text detection&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_BATCH_SIZE: Optional[int] = &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Defaults to 2 for CPU/MPS, 32 otherwise&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_MODEL_CHECKPOINT: str = &lt;span class=&quot;string&quot;&gt;r&quot;D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_det3&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_BENCH_DATASET_NAME: str = &lt;span class=&quot;string&quot;&gt;&quot;vikp/doclaynet_bench&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_IMAGE_CHUNK_HEIGHT: int = &lt;span class=&quot;number&quot;&gt;1400&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Height at which to slice images vertically&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_TEXT_THRESHOLD: float = &lt;span class=&quot;number&quot;&gt;0.6&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Threshold for text detection (above this is considered text)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_BLANK_THRESHOLD: float = &lt;span class=&quot;number&quot;&gt;0.35&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Threshold for blank space (below this is considered blank)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_POSTPROCESSING_CPU_WORKERS: int = min(&lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;, os.cpu_count()) &lt;span class=&quot;comment&quot;&gt;# Number of workers for postprocessing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DETECTOR_MIN_PARALLEL_THRESH: int = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Minimum number of images before we parallelize&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# Text recognition&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_MODEL_CHECKPOINT: str = &lt;span class=&quot;string&quot;&gt;r&quot;D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_rec&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_MAX_TOKENS: int = &lt;span class=&quot;number&quot;&gt;175&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_BATCH_SIZE: Optional[int] = &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Defaults to 8 for CPU/MPS, 256 otherwise&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_IMAGE_SIZE: Dict = &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;height&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;196&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;width&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;896&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_RENDER_FONTS: Dict[str, str] = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;all&quot;&lt;/span&gt;: os.path.join(FONT_DIR, &lt;span class=&quot;string&quot;&gt;&quot;GoNotoCurrent-Regular.ttf&quot;&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;zh&quot;&lt;/span&gt;: os.path.join(FONT_DIR, &lt;span class=&quot;string&quot;&gt;&quot;GoNotoCJKCore.ttf&quot;&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;ja&quot;&lt;/span&gt;: os.path.join(FONT_DIR, &lt;span class=&quot;string&quot;&gt;&quot;GoNotoCJKCore.ttf&quot;&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;ko&quot;&lt;/span&gt;: os.path.join(FONT_DIR, &lt;span class=&quot;string&quot;&gt;&quot;GoNotoCJKCore.ttf&quot;&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_FONT_DL_BASE: str = &lt;span class=&quot;string&quot;&gt;&quot;https://github.com/satbyy/go-noto-universal/releases/download/v7.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_BENCH_DATASET_NAME: str = &lt;span class=&quot;string&quot;&gt;&quot;vikp/rec_bench&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_PAD_VALUE: int = &lt;span class=&quot;number&quot;&gt;255&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Should be 0 or 255&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_STATIC_CACHE: bool = &lt;span class=&quot;literal&quot;&gt;False&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Static cache for torch compile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RECOGNITION_MAX_LANGS: int = &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# Layout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    LAYOUT_MODEL_CHECKPOINT: str = &lt;span class=&quot;string&quot;&gt;r&quot;D:\pycharmproject_2\translate_plat\surya_ocr\models\surya_layout3&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    LAYOUT_BENCH_DATASET_NAME: str = &lt;span class=&quot;string&quot;&gt;&quot;vikp/publaynet_bench&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# Ordering&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ORDER_MODEL_CHECKPOINT: str = &lt;span class=&quot;string&quot;&gt;&quot;vikp/surya_order&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ORDER_IMAGE_SIZE: Dict = &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;height&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;width&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ORDER_MAX_BOXES: int = &lt;span class=&quot;number&quot;&gt;256&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ORDER_BATCH_SIZE: Optional[int] = &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# Defaults to 4 for CPU/MPS, 32 otherwise&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ORDER_BENCH_DATASET_NAME: str = &lt;span class=&quot;string&quot;&gt;&quot;vikp/order_bench&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# Tesseract (for benchmarks only)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    TESSDATA_PREFIX: Optional[str] = &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;    @computed_field&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;    @property&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MODEL_DTYPE&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt; -&amp;gt; torch.dtype:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; torch.float32 &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.TORCH_DEVICE_MODEL == &lt;span class=&quot;string&quot;&gt;&quot;cpu&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; torch.float16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Config&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        env_file = find_dotenv(&lt;span class=&quot;string&quot;&gt;&quot;local.env&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        extra = &lt;span class=&quot;string&quot;&gt;&quot;ignore&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;settings = Settings()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="OCR" scheme="http://yoursite.com/tags/OCR/"/>
    
  </entry>
  
  <entry>
    <title>doccano</title>
    <link href="http://yoursite.com/2024/06/28/doccano/"/>
    <id>http://yoursite.com/2024/06/28/doccano/</id>
    <published>2024-06-28T02:42:26.000Z</published>
    <updated>2024-06-28T09:28:33.660Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><p>Doccanoæ˜¯ä¸€ç§ç”¨äºæ–‡æœ¬æ ‡æ³¨çš„å¼€æºå·¥å…·ï¼Œæ—¨åœ¨ç®€åŒ–å’ŒåŠ é€Ÿæ ‡æ³¨ä»»åŠ¡çš„è¿›è¡Œã€‚å®ƒæä¾›äº†ä¸€ä¸ªç›´è§‚çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿æ ‡æ³¨äººå‘˜èƒ½å¤Ÿè½»æ¾åœ°å¯¹æ–‡æœ¬æ•°æ®è¿›è¡Œæ ‡æ³¨ï¼Œå¹¶åˆ›å»ºé«˜è´¨é‡çš„è®­ç»ƒæ•°æ®é›†ç”¨äºæœºå™¨å­¦ä¹ å’Œè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ã€‚</p><p><img src="/2024/06/28/doccano/1.png" alt></p><p>é“¾æ¥ï¼š<a href="https://github.com/doccano/doccano" target="_blank" rel="noopener">https://github.com/doccano/doccano</a></p><h2 id="ä¸€ã€å®‰è£…éƒ¨ç½²"><a href="#ä¸€ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="ä¸€ã€å®‰è£…éƒ¨ç½²"></a>ä¸€ã€å®‰è£…éƒ¨ç½²</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p><font color="gold">æ“ä½œç³»ç»Ÿ</font>ï¼šCentos7.9</p><p><font color="gold">python</font>ï¼š3.10</p><p><font color="gold">doccano</font>ï¼š1.6.2</p><h3 id="pipå®‰è£…"><a href="#pipå®‰è£…" class="headerlink" title="pipå®‰è£…"></a>pipå®‰è£…</h3><p><font color="gold">æ³¨</font>ï¼šç™¾åº¦æºæ²¡æœ‰ç›¸åº”å®‰è£…åŒ…</p><p><code>pip install doccano==1.6.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p><code>doccano init</code></p><h3 id="è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç "><a href="#è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç " class="headerlink" title="è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç "></a>è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç </h3><p><code>doccano createuser --username admin --password 123456</code></p><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><p><code>doccano webserver --port 8000</code></p><p><img src="/2024/06/28/doccano/2.png" alt></p><p><img src="/2024/06/28/doccano/3.png" alt></p><a id="more"></a><h2 id="ERNIE-UIE-å…³ç³»æŠ½å–å¾®è°ƒæ•°æ®æ ‡æ³¨"><a href="#ERNIE-UIE-å…³ç³»æŠ½å–å¾®è°ƒæ•°æ®æ ‡æ³¨" class="headerlink" title="ERNIE-UIE å…³ç³»æŠ½å–å¾®è°ƒæ•°æ®æ ‡æ³¨"></a>ERNIE-UIE å…³ç³»æŠ½å–å¾®è°ƒæ•°æ®æ ‡æ³¨</h2><h3 id="åˆ›å»ºåºåˆ—æ ‡æ³¨ä»»åŠ¡"><a href="#åˆ›å»ºåºåˆ—æ ‡æ³¨ä»»åŠ¡" class="headerlink" title="åˆ›å»ºåºåˆ—æ ‡æ³¨ä»»åŠ¡"></a>åˆ›å»ºåºåˆ—æ ‡æ³¨ä»»åŠ¡</h3><p><img src="/2024/06/28/doccano/4.png" alt></p><h3 id="å¯¼å…¥å¢é‡è®­ç»ƒæ•°æ®é›†"><a href="#å¯¼å…¥å¢é‡è®­ç»ƒæ•°æ®é›†" class="headerlink" title="å¯¼å…¥å¢é‡è®­ç»ƒæ•°æ®é›†"></a>å¯¼å…¥å¢é‡è®­ç»ƒæ•°æ®é›†</h3><p><img src="/2024/06/28/doccano/5.png" alt></p><p><font color="gold">æ³¨</font>ï¼šå¦‚æœå¯¼å…¥ä¸æˆåŠŸï¼Œé•¿æ—¶é—´è½¬åœˆï¼Œéœ€è¦å»æ§åˆ¶å°æ‰§è¡Œ<code>doccano task</code></p><h3 id="åˆ›å»ºå®ä½“æ ‡ç­¾å’Œå…³ç³»æ ‡ç­¾"><a href="#åˆ›å»ºå®ä½“æ ‡ç­¾å’Œå…³ç³»æ ‡ç­¾" class="headerlink" title="åˆ›å»ºå®ä½“æ ‡ç­¾å’Œå…³ç³»æ ‡ç­¾"></a>åˆ›å»ºå®ä½“æ ‡ç­¾å’Œå…³ç³»æ ‡ç­¾</h3><p><img src="/2024/06/28/doccano/6.png" alt></p><p><img src="/2024/06/28/doccano/7.png" alt></p><h3 id="æ•°æ®æ ‡æ³¨"><a href="#æ•°æ®æ ‡æ³¨" class="headerlink" title="æ•°æ®æ ‡æ³¨"></a>æ•°æ®æ ‡æ³¨</h3><p><img src="/2024/06/28/doccano/8.png" alt></p><p><img src="/2024/06/28/doccano/9.png" alt></p><h3 id="æ•°æ®é›†å¯¼å‡º"><a href="#æ•°æ®é›†å¯¼å‡º" class="headerlink" title="æ•°æ®é›†å¯¼å‡º"></a>æ•°æ®é›†å¯¼å‡º</h3><p><img src="/2024/06/28/doccano/10.png" alt></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"id"</span>: <span class="number">11</span>, <span class="attr">"text"</span>: <span class="string">"é’¢ç­‹è°ƒç›´å®œé‡‡ç”¨æœºæ¢°æ–¹æ³•,ä¹Ÿå¯ä»¥é‡‡ç”¨å†·æ‹‰æ–¹æ³•"</span>, <span class="attr">"relations"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">1</span>, <span class="attr">"from_id"</span>: <span class="number">45</span>, <span class="attr">"to_id"</span>: <span class="number">44</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">2</span>, <span class="attr">"from_id"</span>: <span class="number">46</span>, <span class="attr">"to_id"</span>: <span class="number">44</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;], <span class="attr">"entities"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">44</span>, <span class="attr">"start_offset"</span>: <span class="number">0</span>, <span class="attr">"end_offset"</span>: <span class="number">4</span>, <span class="attr">"label"</span>: <span class="string">"å·¥ç¨‹"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">45</span>, <span class="attr">"start_offset"</span>: <span class="number">7</span>, <span class="attr">"end_offset"</span>: <span class="number">11</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">46</span>, <span class="attr">"start_offset"</span>: <span class="number">17</span>, <span class="attr">"end_offset"</span>: <span class="number">21</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;]&#125;</span><br><span class="line">&#123;<span class="attr">"id"</span>: <span class="number">12</span>, <span class="attr">"text"</span>: <span class="string">"å—åŠ›é’¢ç­‹çš„æ¥å¤´å½¢å¼åº”æŒ‰è®¾è®¡è¦æ±‚é‡‡ç”¨,è‹¥è®¾è®¡æ— è¦æ±‚æ—¶,é’¢ç­‹å®œé‡‡ç”¨ç„Šæ¥æ¥å¤´å’Œæœºæ¢°è¿æ¥æ¥å¤´,ä¹Ÿå¯é‡‡ç”¨ç»‘æ‰æ¥å¤´ã€‚"</span>, <span class="attr">"relations"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">3</span>, <span class="attr">"from_id"</span>: <span class="number">53</span>, <span class="attr">"to_id"</span>: <span class="number">22</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">4</span>, <span class="attr">"from_id"</span>: <span class="number">54</span>, <span class="attr">"to_id"</span>: <span class="number">22</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">5</span>, <span class="attr">"from_id"</span>: <span class="number">55</span>, <span class="attr">"to_id"</span>: <span class="number">22</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;], <span class="attr">"entities"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">22</span>, <span class="attr">"start_offset"</span>: <span class="number">0</span>, <span class="attr">"end_offset"</span>: <span class="number">9</span>, <span class="attr">"label"</span>: <span class="string">"å·¥ç¨‹"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">53</span>, <span class="attr">"start_offset"</span>: <span class="number">31</span>, <span class="attr">"end_offset"</span>: <span class="number">35</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">54</span>, <span class="attr">"start_offset"</span>: <span class="number">36</span>, <span class="attr">"end_offset"</span>: <span class="number">42</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">55</span>, <span class="attr">"start_offset"</span>: <span class="number">47</span>, <span class="attr">"end_offset"</span>: <span class="number">51</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;]&#125;</span><br><span class="line">&#123;<span class="attr">"id"</span>: <span class="number">13</span>, <span class="attr">"text"</span>: <span class="string">"å¤šå±‚éç„Šæ¥é’¢ç­‹éª¨æ¶çš„å„å±‚é’¢ç­‹ä¹‹é—´,åº”ä¿æŒå±‚è·å‡†ç¡®,å®œé‡‡ç”¨çŸ­é’¢ç­‹æ”¯å«ã€‚"</span>, <span class="attr">"relations"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">6</span>, <span class="attr">"from_id"</span>: <span class="number">60</span>, <span class="attr">"to_id"</span>: <span class="number">59</span>, <span class="attr">"type"</span>: <span class="string">"å·¥è‰º"</span>&#125;], <span class="attr">"entities"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">59</span>, <span class="attr">"start_offset"</span>: <span class="number">0</span>, <span class="attr">"end_offset"</span>: <span class="number">9</span>, <span class="attr">"label"</span>: <span class="string">"å·¥ç¨‹"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">60</span>, <span class="attr">"start_offset"</span>: <span class="number">28</span>, <span class="attr">"end_offset"</span>: <span class="number">33</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;]&#125;</span><br><span class="line">&#123;<span class="attr">"id"</span>: <span class="number">14</span>, <span class="attr">"text"</span>: <span class="string">"é¢„åˆ¶æ¡©çš„ä¿®ç­‘å·¥è‰ºåŒ…æ‹¬ä¸€ä½“åŒ–æˆå­”ã€è‡ªçŒæ³¨ã€‚"</span>, <span class="attr">"relations"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">7</span>, <span class="attr">"from_id"</span>: <span class="number">62</span>, <span class="attr">"to_id"</span>: <span class="number">28</span>, <span class="attr">"type"</span>: <span class="string">"å·¥è‰º"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">8</span>, <span class="attr">"from_id"</span>: <span class="number">61</span>, <span class="attr">"to_id"</span>: <span class="number">28</span>, <span class="attr">"type"</span>: <span class="string">"å·¥è‰º"</span>&#125;], <span class="attr">"entities"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">28</span>, <span class="attr">"start_offset"</span>: <span class="number">0</span>, <span class="attr">"end_offset"</span>: <span class="number">3</span>, <span class="attr">"label"</span>: <span class="string">"å·¥ç¨‹"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">61</span>, <span class="attr">"start_offset"</span>: <span class="number">10</span>, <span class="attr">"end_offset"</span>: <span class="number">15</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">62</span>, <span class="attr">"start_offset"</span>: <span class="number">16</span>, <span class="attr">"end_offset"</span>: <span class="number">19</span>, <span class="attr">"label"</span>: <span class="string">"å·¥è‰º"</span>&#125;]&#125;</span><br><span class="line">&#123;<span class="attr">"id"</span>: <span class="number">15</span>, <span class="attr">"text"</span>: <span class="string">"ç›®å‰æˆ‘å›½æ°´è¿å·¥ç¨‹çš„æ¨¡æ¿ç”¨æå·²å‘å¤šæ ·åŒ–å‘å±•,é™¤é’¢æå’Œæœ¨æå¤–,èƒ¶æœ¨æ¿ã€ç«¹èƒ¶æ¿ã€å¡‘æ–™ç­‰å·²å¾—åˆ°å¹¿æ³›è¿ç”¨,å¹¶å–å¾—äº†è¾ƒå¥½çš„æŠ€æœ¯ç»æµæ•ˆç›Šã€‚"</span>, <span class="attr">"relations"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">9</span>, <span class="attr">"from_id"</span>: <span class="number">63</span>, <span class="attr">"to_id"</span>: <span class="number">52</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">10</span>, <span class="attr">"from_id"</span>: <span class="number">64</span>, <span class="attr">"to_id"</span>: <span class="number">52</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">11</span>, <span class="attr">"from_id"</span>: <span class="number">65</span>, <span class="attr">"to_id"</span>: <span class="number">52</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">12</span>, <span class="attr">"from_id"</span>: <span class="number">67</span>, <span class="attr">"to_id"</span>: <span class="number">52</span>, <span class="attr">"type"</span>: <span class="string">"ææ–™"</span>&#125;], <span class="attr">"entities"</span>: [&#123;<span class="attr">"id"</span>: <span class="number">52</span>, <span class="attr">"start_offset"</span>: <span class="number">4</span>, <span class="attr">"end_offset"</span>: <span class="number">8</span>, <span class="attr">"label"</span>: <span class="string">"å·¥ç¨‹"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">63</span>, <span class="attr">"start_offset"</span>: <span class="number">22</span>, <span class="attr">"end_offset"</span>: <span class="number">24</span>, <span class="attr">"label"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">64</span>, <span class="attr">"start_offset"</span>: <span class="number">25</span>, <span class="attr">"end_offset"</span>: <span class="number">27</span>, <span class="attr">"label"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">65</span>, <span class="attr">"start_offset"</span>: <span class="number">29</span>, <span class="attr">"end_offset"</span>: <span class="number">32</span>, <span class="attr">"label"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">66</span>, <span class="attr">"start_offset"</span>: <span class="number">33</span>, <span class="attr">"end_offset"</span>: <span class="number">36</span>, <span class="attr">"label"</span>: <span class="string">"ææ–™"</span>&#125;, &#123;<span class="attr">"id"</span>: <span class="number">67</span>, <span class="attr">"start_offset"</span>: <span class="number">37</span>, <span class="attr">"end_offset"</span>: <span class="number">39</span>, <span class="attr">"label"</span>: <span class="string">"ææ–™"</span>&#125;]&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®é›†æ ¼å¼è½¬æ¢"><a href="#æ•°æ®é›†æ ¼å¼è½¬æ¢" class="headerlink" title="æ•°æ®é›†æ ¼å¼è½¬æ¢"></a>æ•°æ®é›†æ ¼å¼è½¬æ¢</h3><p>å‚è€ƒ<a href="https://github.com/PaddlePaddle/PaddleNLP/tree/develop/legacy/model_zoo/uie" target="_blank" rel="noopener">https://github.com/PaddlePaddle/PaddleNLP/tree/develop/legacy/model_zoo/uie</a></p><p>è¿›å…¥PaddleNLP-UIEè·¯å¾„ï¼Œå°†jsonæ–‡ä»¶æ”¾ç½®åœ¨è·¯å¾„ä¸‹ï¼Œåˆ›å»ºdataæ–‡ä»¶å¤¹ç”¨äºå­˜å‚¨æ•°æ®é›†ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python doccano.py \</span><br><span class="line">    --doccano_file ./data/doccano_ext.json \</span><br><span class="line">    --task_type ext \</span><br><span class="line">    --save_dir ./data \</span><br><span class="line">    --splits 0.8 0.2 0 \</span><br><span class="line">    --schema_lang ch</span><br></pre></td></tr></table></figure><p>ç”±äºæµ‹è¯•æ ·æœ¬è¾ƒå°‘ï¼ˆ5æ¡ï¼‰ï¼Œæœªè‡ªåŠ¨åŒ–åˆ†éªŒè¯é›†devï¼Œæ‰‹åŠ¨å°†æµ‹è¯•é›†å†…å®¹å¤åˆ¶åˆ°éªŒè¯é›†å½“ä¸­ã€‚</p><h3 id="å¼€å¯è®­ç»ƒ"><a href="#å¼€å¯è®­ç»ƒ" class="headerlink" title="å¼€å¯è®­ç»ƒ"></a>å¼€å¯è®­ç»ƒ</h3><p>åœ¨UIEè·¯å¾„ä¸‹åˆ›å»º<code>checkpoint/model_best</code>ç”¨äºå­˜æ”¾æ¨¡å‹</p><p>æ‰§è¡Œï¼ˆGPUï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">export finetuned_model=./checkpoint/model_best</span><br><span class="line"></span><br><span class="line">python -u -m paddle.distributed.launch --gpus "0,1" finetune.py \</span><br><span class="line">    --device gpu \</span><br><span class="line">    --logging_steps 10 \</span><br><span class="line">    --save_steps 100 \</span><br><span class="line">    --eval_steps 100 \</span><br><span class="line">    --seed 42 \</span><br><span class="line">    --model_name_or_path uie-base \</span><br><span class="line">    --output_dir $finetuned_model \</span><br><span class="line">    --train_path data/train.txt \</span><br><span class="line">    --dev_path data/dev.txt  \</span><br><span class="line">    --max_seq_length 512  \</span><br><span class="line">    --per_device_eval_batch_size 16 \</span><br><span class="line">    --per_device_train_batch_size  16 \</span><br><span class="line">    --num_train_epochs 100 \</span><br><span class="line">    --learning_rate 1e-5 \</span><br><span class="line">    --do_train \</span><br><span class="line">    --do_eval \</span><br><span class="line">    --do_export \</span><br><span class="line">    --export_model_dir $finetuned_model \</span><br><span class="line">    --label_names "start_positions" "end_positions" \</span><br><span class="line">    --overwrite_output_dir \</span><br><span class="line">    --disable_tqdm True \</span><br><span class="line">    --metric_for_best_model eval_f1 \</span><br><span class="line">    --load_best_model_at_end  True \</span><br><span class="line">    --save_total_limit 1 \</span><br></pre></td></tr></table></figure><p>è®­ç»ƒç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line">(py39_ppner_2_7_2) [root@jdz uie]# python -u -m paddle.distributed.launch --gpus "1" finetune.py     --device gpu     --logging_steps 10     --save_steps 100     --eval_steps 100     --seed 42     --model_name_or_path uie-base     --output_dir $finetuned_model     --train_path data/train.txt     --dev_path data/dev.txt      --max_seq_length 512      --per_device_eval_batch_size 16     --per_device_train_batch_size  16     --num_train_epochs 100     --learning_rate 1e-5     --do_train     --do_eval     --do_export     --export_model_dir $finetuned_model     --label_names "start_positions" "end_positions"     --overwrite_output_dir     --disable_tqdm True     --metric_for_best_model eval_f1     --load_best_model_at_end  True     --save_total_limit 1 </span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,778 -----------  Configuration  ----------------------</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 auto_parallel_config: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 auto_tuner_json: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 devices: 1</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 elastic_level: -1</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 elastic_timeout: 30</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 enable_gpu_log: True</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 gloo_port: 6767</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 host: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 ips: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 job_id: default</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 legacy: False</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,779 log_dir: log</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 log_level: INFO</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 log_overwrite: False</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 master: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 max_restart: 3</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 nnodes: 1</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 nproc_per_node: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 rank: -1</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 run_mode: collective</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 server_num: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 servers: </span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 sort_ip: False</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 start_port: 6070</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 trainer_num: None</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 trainers: </span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,780 training_script: finetune.py</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,781 training_script_args: ['--device', 'gpu', '--logging_steps', '10', '--save_steps', '100', '--eval_steps', '100', '--seed', '42', '--model_name_or_path', 'uie-base', '--output_dir', './checkpoint/model_best', '--train_path', 'data/train.txt', '--dev_path', 'data/dev.txt', '--max_seq_length', '512', '--per_device_eval_batch_size', '16', '--per_device_train_batch_size', '16', '--num_train_epochs', '100', '--learning_rate', '1e-5', '--do_train', '--do_eval', '--do_export', '--export_model_dir', './checkpoint/model_best', '--label_names', 'start_positions', 'end_positions', '--overwrite_output_dir', '--disable_tqdm', 'True', '--metric_for_best_model', 'eval_f1', '--load_best_model_at_end', 'True', '--save_total_limit', '1']</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,781 with_gloo: 1</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,781 --------------------------------------------------</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,782 Job: default, mode collective, replicas 1[1:1], elastic False</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,797 Run Pod: pwbjet, replicas 1, status ready</span><br><span class="line">LAUNCH INFO 2024-06-26 18:05:23,824 Watching Pod: pwbjet, replicas 1, status running</span><br><span class="line">/root/anaconda3/envs/py39_ppner_2_7_2/lib/python3.9/site-packages/_distutils_hack/__init__.py:33: UserWarning: Setuptools is replacing distutils.</span><br><span class="line">  warnings.warn("Setuptools is replacing distutils.")</span><br><span class="line">[2024-06-26 18:05:27,933] [ WARNING] - evaluation_strategy reset to IntervalStrategy.STEPS for do_eval is True. you can also set evaluation_strategy='epoch'.</span><br><span class="line">[2024-06-26 18:05:27,933] [    INFO] - The default value for the training argument `--report_to` will change in v5 (from all installed integrations to none). In v5, you will need to use `--report_to all` to get the same behavior as now. You should start updating your code and make this info disappear :-).</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - ============================================================</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] -      Model Configuration Arguments      </span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - paddle commit id              :fbf852dd832bc0e63ae31cd4aa37defd829e4c03</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - export_model_dir              :./checkpoint/model_best</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - model_name_or_path            :uie-base</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - multilingual                  :False</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - </span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - ============================================================</span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] -       Data Configuration Arguments      </span><br><span class="line">[2024-06-26 18:05:27,934] [    INFO] - paddle commit id              :fbf852dd832bc0e63ae31cd4aa37defd829e4c03</span><br><span class="line">[2024-06-26 18:05:27,935] [    INFO] - dev_path                      :data/dev.txt</span><br><span class="line">[2024-06-26 18:05:27,935] [    INFO] - dynamic_max_length            :None</span><br><span class="line">[2024-06-26 18:05:27,935] [    INFO] - max_seq_length                :512</span><br><span class="line">[2024-06-26 18:05:27,935] [    INFO] - train_path                    :data/train.txt</span><br><span class="line">[2024-06-26 18:05:27,935] [    INFO] - </span><br><span class="line">[2024-06-26 18:05:27,935] [ WARNING] - Process rank: -1, device: gpu, world_size: 1, distributed training: False, 16-bits training: False</span><br><span class="line">[2024-06-26 18:05:27,935] [    INFO] - We are using (&lt;class 'paddlenlp.transformers.ernie.tokenizer.ErnieTokenizer'&gt;, False) to load 'uie-base'.</span><br><span class="line">[2024-06-26 18:05:27,936] [    INFO] - Already cached /root/.paddlenlp/models/uie-base/ernie_3.0_base_zh_vocab.txt</span><br><span class="line">[2024-06-26 18:05:27,968] [    INFO] - tokenizer config file saved in /root/.paddlenlp/models/uie-base/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:05:27,969] [    INFO] - Special tokens file saved in /root/.paddlenlp/models/uie-base/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:05:27,970] [    INFO] - Already cached /root/.paddlenlp/models/uie-base/model_state.pdparams</span><br><span class="line">[2024-06-26 18:05:27,970] [    INFO] - Loading weights file model_state.pdparams from cache at /root/.paddlenlp/models/uie-base/model_state.pdparams</span><br><span class="line">[2024-06-26 18:05:28,898] [    INFO] - Loaded weights file from disk, setting weights to model.</span><br><span class="line">W0626 18:05:29.062965 285242 gpu_resources.cc:119] Please NOTE: device: 1, GPU Compute Capability: 8.6, Driver API Version: 12.2, Runtime API Version: 12.0</span><br><span class="line">W0626 18:05:29.064332 285242 gpu_resources.cc:164] device: 1, cuDNN Version: 8.9.</span><br><span class="line">[2024-06-26 18:05:30,516] [    INFO] - All model checkpoint weights were used when initializing UIE.</span><br><span class="line"></span><br><span class="line">[2024-06-26 18:05:30,517] [    INFO] - All the weights of UIE were initialized from the model checkpoint at uie-base.</span><br><span class="line">If your task is similar to the task the model of the checkpoint was trained on, you can already use UIE for predictions without further training.</span><br><span class="line">[2024-06-26 18:05:30,562] [    INFO] - The global seed is set to 42, local seed is set to 43 and random seed is set to 42.</span><br><span class="line">[2024-06-26 18:05:30,655] [   DEBUG] - ============================================================</span><br><span class="line">[2024-06-26 18:05:30,655] [   DEBUG] -     Training Configuration Arguments    </span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - paddle commit id              : fbf852dd832bc0e63ae31cd4aa37defd829e4c03</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - paddlenlp commit id           : b39e701e21d11ff66ac3abfc81d384b6af8f8240</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - _no_sync_in_gradient_accumulation: True</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - activation_quantize_type      : None</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - adam_beta1                    : 0.9</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - adam_beta2                    : 0.999</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - adam_epsilon                  : 1e-08</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - algo_list                     : None</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - amp_custom_black_list         : None</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - amp_custom_white_list         : None</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - amp_master_grad               : False</span><br><span class="line">[2024-06-26 18:05:30,656] [   DEBUG] - batch_num_list                : None</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - batch_size_list               : None</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - bf16                          : False</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - bf16_full_eval                : False</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - bias_correction               : False</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - current_device                : gpu:1</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - data_parallel_rank            : 0</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - dataloader_drop_last          : False</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - dataloader_num_workers        : 0</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - dataset_rank                  : 0</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - dataset_world_size            : 1</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - device                        : gpu</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - disable_tqdm                  : True</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - distributed_dataloader        : False</span><br><span class="line">[2024-06-26 18:05:30,657] [   DEBUG] - do_compress                   : False</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - do_eval                       : True</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - do_export                     : True</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - do_predict                    : False</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - do_train                      : True</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - eval_accumulation_steps       : None</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - eval_batch_size               : 16</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - eval_steps                    : 100</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - evaluation_strategy           : IntervalStrategy.STEPS</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - flatten_param_grads           : False</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - force_reshard_pp              : False</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - fp16                          : False</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - fp16_full_eval                : False</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - fp16_opt_level                : O1</span><br><span class="line">[2024-06-26 18:05:30,658] [   DEBUG] - gradient_accumulation_steps   : 1</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - greater_is_better             : True</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - hybrid_parallel_topo_order    : None</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - ignore_data_skip              : False</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - ignore_load_lr_and_optim      : False</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - input_dtype                   : int64</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - input_infer_model_path        : None</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - label_names                   : ['start_positions', 'end_positions']</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - lazy_data_processing          : True</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - learning_rate                 : 1e-05</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - load_best_model_at_end        : True</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - load_sharded_model            : False</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - local_process_index           : 0</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - local_rank                    : -1</span><br><span class="line">[2024-06-26 18:05:30,659] [   DEBUG] - log_level                     : -1</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - log_level_replica             : -1</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - log_on_each_node              : True</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - logging_dir                   : ./checkpoint/model_best/runs/Jun26_18-05-27_jdz</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - logging_first_step            : False</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - logging_steps                 : 10</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - logging_strategy              : IntervalStrategy.STEPS</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - logical_process_index         : 0</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - lr_end                        : 1e-07</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - lr_scheduler_type             : SchedulerType.LINEAR</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - max_evaluate_steps            : -1</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - max_grad_norm                 : 1.0</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - max_steps                     : -1</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - metric_for_best_model         : eval_f1</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - minimum_eval_times            : None</span><br><span class="line">[2024-06-26 18:05:30,660] [   DEBUG] - moving_rate                   : 0.9</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - no_cuda                       : False</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - num_cycles                    : 0.5</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - num_train_epochs              : 100.0</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - onnx_format                   : True</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - optim                         : OptimizerNames.ADAMW</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - optimizer_name_suffix         : None</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - output_dir                    : ./checkpoint/model_best</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - overwrite_output_dir          : True</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - past_index                    : -1</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - per_device_eval_batch_size    : 16</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - per_device_train_batch_size   : 16</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - pipeline_parallel_config      : </span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - pipeline_parallel_degree      : -1</span><br><span class="line">[2024-06-26 18:05:30,661] [   DEBUG] - pipeline_parallel_rank        : 0</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - power                         : 1.0</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - prediction_loss_only          : False</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - process_index                 : 0</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - prune_embeddings              : False</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - recompute                     : False</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - remove_unused_columns         : True</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - report_to                     : ['visualdl']</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - resume_from_checkpoint        : None</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - round_type                    : round</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - run_name                      : ./checkpoint/model_best</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - save_on_each_node             : False</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - save_sharded_model            : False</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - save_steps                    : 100</span><br><span class="line">[2024-06-26 18:05:30,662] [   DEBUG] - save_strategy                 : IntervalStrategy.STEPS</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - save_total_limit              : 1</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - scale_loss                    : 32768</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - seed                          : 42</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - sep_parallel_degree           : -1</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - sharding                      : []</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - sharding_degree               : -1</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - sharding_parallel_config      : </span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - sharding_parallel_degree      : -1</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - sharding_parallel_rank        : 0</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - should_load_dataset           : True</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - should_load_sharding_stage1_model: False</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - should_log                    : True</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - should_save                   : True</span><br><span class="line">[2024-06-26 18:05:30,663] [   DEBUG] - should_save_model_state       : True</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - should_save_sharding_stage1_model: False</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - skip_memory_metrics           : True</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - skip_profile_timer            : True</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - strategy                      : dynabert+ptq</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - tensor_parallel_config        : </span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - tensor_parallel_degree        : -1</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - tensor_parallel_rank          : 0</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - to_static                     : False</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - train_batch_size              : 16</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - unified_checkpoint            : False</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - unified_checkpoint_config     : </span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - use_auto_parallel             : False</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - use_hybrid_parallel           : False</span><br><span class="line">[2024-06-26 18:05:30,664] [   DEBUG] - use_pact                      : True</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - warmup_ratio                  : 0.1</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - warmup_steps                  : 0</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - weight_decay                  : 0.0</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - weight_name_suffix            : None</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - weight_quantize_type          : channel_wise_abs_max</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - width_mult_list               : None</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - world_size                    : 1</span><br><span class="line">[2024-06-26 18:05:30,665] [   DEBUG] - </span><br><span class="line">[2024-06-26 18:05:30,666] [    INFO] - Starting training from resume_from_checkpoint : None</span><br><span class="line">/root/anaconda3/envs/py39_ppner_2_7_2/lib/python3.9/site-packages/paddle/distributed/parallel.py:410: UserWarning: The program will return to single-card operation. Please check 1, whether you use spawn or fleetrun to start the program. 2, Whether it is a multi-card program. 3, Is the current environment multi-card.</span><br><span class="line">  warnings.warn(</span><br><span class="line">[2024-06-26 18:05:30,667] [    INFO] - [timelog] checkpoint loading time: 0.00s (2024-06-26 18:05:30) </span><br><span class="line">[2024-06-26 18:05:30,667] [    INFO] - ***** Running training *****</span><br><span class="line">[2024-06-26 18:05:30,667] [    INFO] -   Num examples = 68</span><br><span class="line">[2024-06-26 18:05:30,667] [    INFO] -   Num Epochs = 100</span><br><span class="line">[2024-06-26 18:05:30,667] [    INFO] -   Instantaneous batch size per device = 16</span><br><span class="line">[2024-06-26 18:05:30,668] [    INFO] -   Total train batch size (w. parallel, distributed &amp; accumulation) = 16</span><br><span class="line">[2024-06-26 18:05:30,668] [    INFO] -   Gradient Accumulation steps = 1</span><br><span class="line">[2024-06-26 18:05:30,668] [    INFO] -   Total optimization steps = 500</span><br><span class="line">[2024-06-26 18:05:30,668] [    INFO] -   Total num train samples = 6,800</span><br><span class="line">[2024-06-26 18:05:30,670] [   DEBUG] -   Number of trainable parameters = 117,946,370 (per device)</span><br><span class="line">/root/anaconda3/envs/py39_ppner_2_7_2/lib/python3.9/site-packages/paddlenlp/transformers/tokenizer_utils_base.py:2538: FutureWarning: The `max_seq_len` argument is deprecated and will be removed in a future version, please use `max_length` instead.</span><br><span class="line">  warnings.warn(</span><br><span class="line">/root/anaconda3/envs/py39_ppner_2_7_2/lib/python3.9/site-packages/paddlenlp/transformers/tokenizer_utils_base.py:1938: FutureWarning: The `pad_to_max_length` argument is deprecated and will be removed in a future version, use `padding=True` or `padding='longest'` to pad to the longest sequence in the batch, or use `padding='max_length'` to pad to a max length. In this case, you can give a specific length with `max_length` (e.g. `max_length=45`) or leave max_length to None to pad to the maximal input size of the model (e.g. 512 for Bert).</span><br><span class="line">  warnings.warn(</span><br><span class="line">[2024-06-26 18:05:34,727] [    INFO] - loss: 0.00208795, learning_rate: 1e-05, global_step: 10, interval_runtime: 4.0565, interval_samples_per_second: 39.44293710564109, interval_steps_per_second: 2.4651835691025683, progress_or_epoch: 2.0</span><br><span class="line">[2024-06-26 18:05:37,278] [    INFO] - loss: 0.00129266, learning_rate: 1e-05, global_step: 20, interval_runtime: 2.55, interval_samples_per_second: 62.74611413497253, interval_steps_per_second: 3.921632133435783, progress_or_epoch: 4.0</span><br><span class="line">[2024-06-26 18:05:39,833] [    INFO] - loss: 0.00092623, learning_rate: 1e-05, global_step: 30, interval_runtime: 2.5559, interval_samples_per_second: 62.599374107598685, interval_steps_per_second: 3.912460881724918, progress_or_epoch: 6.0</span><br><span class="line">[2024-06-26 18:05:42,413] [    INFO] - loss: 0.00058895, learning_rate: 1e-05, global_step: 40, interval_runtime: 2.5801, interval_samples_per_second: 62.012657597381434, interval_steps_per_second: 3.8757910998363396, progress_or_epoch: 8.0</span><br><span class="line">[2024-06-26 18:05:44,946] [    INFO] - loss: 0.00047016, learning_rate: 1e-05, global_step: 50, interval_runtime: 2.5327, interval_samples_per_second: 63.17332385701746, interval_steps_per_second: 3.948332741063591, progress_or_epoch: 10.0</span><br><span class="line">[2024-06-26 18:05:47,514] [    INFO] - loss: 0.00031726, learning_rate: 1e-05, global_step: 60, interval_runtime: 2.5675, interval_samples_per_second: 62.316911606640005, interval_steps_per_second: 3.8948069754150003, progress_or_epoch: 12.0</span><br><span class="line">[2024-06-26 18:05:50,081] [    INFO] - loss: 0.00024869, learning_rate: 1e-05, global_step: 70, interval_runtime: 2.5673, interval_samples_per_second: 62.32305770213569, interval_steps_per_second: 3.8951911063834808, progress_or_epoch: 14.0</span><br><span class="line">[2024-06-26 18:05:52,658] [    INFO] - loss: 0.00041933, learning_rate: 1e-05, global_step: 80, interval_runtime: 2.5765, interval_samples_per_second: 62.10074334302723, interval_steps_per_second: 3.881296458939202, progress_or_epoch: 16.0</span><br><span class="line">[2024-06-26 18:05:55,223] [    INFO] - loss: 0.00017784, learning_rate: 1e-05, global_step: 90, interval_runtime: 2.5647, interval_samples_per_second: 62.38556549647052, interval_steps_per_second: 3.8990978435294075, progress_or_epoch: 18.0</span><br><span class="line">[2024-06-26 18:05:57,816] [    INFO] - loss: 0.00019145, learning_rate: 1e-05, global_step: 100, interval_runtime: 2.5931, interval_samples_per_second: 61.70326891265709, interval_steps_per_second: 3.856454307041068, progress_or_epoch: 20.0</span><br><span class="line">[2024-06-26 18:05:57,817] [    INFO] - ***** Running Evaluation *****</span><br><span class="line">[2024-06-26 18:05:57,817] [    INFO] -   Num examples = 4</span><br><span class="line">[2024-06-26 18:05:57,817] [    INFO] -   Total prediction steps = 1</span><br><span class="line">[2024-06-26 18:05:57,817] [    INFO] -   Pre device batch size = 16</span><br><span class="line">[2024-06-26 18:05:57,818] [    INFO] -   Total Batch size = 16</span><br><span class="line">[2024-06-26 18:05:57,889] [    INFO] - eval_loss: 0.005224619060754776, eval_precision: 0.4, eval_recall: 0.4, eval_f1: 0.4000000000000001, eval_runtime: 0.0705, eval_samples_per_second: 56.74937846074747, eval_steps_per_second: 14.187344615186868, progress_or_epoch: 20.0</span><br><span class="line">[2024-06-26 18:05:57,889] [    INFO] - Saving model checkpoint to ./checkpoint/model_best/checkpoint-100</span><br><span class="line">[2024-06-26 18:05:57,890] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/checkpoint-100/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:05:57,890] [    INFO] - Special tokens file saved in ./checkpoint/model_best/checkpoint-100/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:05:57,902] [    INFO] - Configuration saved in ./checkpoint/model_best/checkpoint-100/config.json</span><br><span class="line">[2024-06-26 18:06:00,646] [    INFO] - Model weights saved in ./checkpoint/model_best/checkpoint-100/model_state.pdparams</span><br><span class="line">[2024-06-26 18:06:00,648] [    INFO] - Saving optimizer files.</span><br><span class="line">[2024-06-26 18:06:07,375] [    INFO] - [timelog] checkpoint saving time: 9.48s (2024-06-26 18:06:07) </span><br><span class="line">[2024-06-26 18:06:09,924] [    INFO] - loss: 0.00022237, learning_rate: 1e-05, global_step: 110, interval_runtime: 12.1083, interval_samples_per_second: 13.21409688201894, interval_steps_per_second: 0.8258810551261837, progress_or_epoch: 22.0</span><br><span class="line">[2024-06-26 18:06:12,478] [    INFO] - loss: 0.00017666, learning_rate: 1e-05, global_step: 120, interval_runtime: 2.5542, interval_samples_per_second: 62.64218200480218, interval_steps_per_second: 3.9151363753001363, progress_or_epoch: 24.0</span><br><span class="line">[2024-06-26 18:06:15,065] [    INFO] - loss: 0.00024367, learning_rate: 1e-05, global_step: 130, interval_runtime: 2.587, interval_samples_per_second: 61.84880269252828, interval_steps_per_second: 3.8655501682830176, progress_or_epoch: 26.0</span><br><span class="line">[2024-06-26 18:06:17,695] [    INFO] - loss: 0.0001915, learning_rate: 1e-05, global_step: 140, interval_runtime: 2.6297, interval_samples_per_second: 60.84334418667863, interval_steps_per_second: 3.8027090116674143, progress_or_epoch: 28.0</span><br><span class="line">[2024-06-26 18:06:20,298] [    INFO] - loss: 0.00017253, learning_rate: 1e-05, global_step: 150, interval_runtime: 2.5998, interval_samples_per_second: 61.542086843031, interval_steps_per_second: 3.8463804276894376, progress_or_epoch: 30.0</span><br><span class="line">[2024-06-26 18:06:22,895] [    INFO] - loss: 0.00014841, learning_rate: 1e-05, global_step: 160, interval_runtime: 2.6008, interval_samples_per_second: 61.51999965531349, interval_steps_per_second: 3.844999978457093, progress_or_epoch: 32.0</span><br><span class="line">[2024-06-26 18:06:25,498] [    INFO] - loss: 0.00012293, learning_rate: 1e-05, global_step: 170, interval_runtime: 2.6024, interval_samples_per_second: 61.48274409158785, interval_steps_per_second: 3.8426715057242404, progress_or_epoch: 34.0</span><br><span class="line">[2024-06-26 18:06:28,099] [    INFO] - loss: 0.00010312, learning_rate: 1e-05, global_step: 180, interval_runtime: 2.601, interval_samples_per_second: 61.514997685471634, interval_steps_per_second: 3.844687355341977, progress_or_epoch: 36.0</span><br><span class="line">[2024-06-26 18:06:30,698] [    INFO] - loss: 9.851e-05, learning_rate: 1e-05, global_step: 190, interval_runtime: 2.5992, interval_samples_per_second: 61.5571084161852, interval_steps_per_second: 3.847319276011575, progress_or_epoch: 38.0</span><br><span class="line">[2024-06-26 18:06:33,295] [    INFO] - loss: 0.00013552, learning_rate: 1e-05, global_step: 200, interval_runtime: 2.5971, interval_samples_per_second: 61.60644154857953, interval_steps_per_second: 3.8504025967862208, progress_or_epoch: 40.0</span><br><span class="line">[2024-06-26 18:06:33,295] [    INFO] - ***** Running Evaluation *****</span><br><span class="line">[2024-06-26 18:06:33,295] [    INFO] -   Num examples = 4</span><br><span class="line">[2024-06-26 18:06:33,295] [    INFO] -   Total prediction steps = 1</span><br><span class="line">[2024-06-26 18:06:33,295] [    INFO] -   Pre device batch size = 16</span><br><span class="line">[2024-06-26 18:06:33,295] [    INFO] -   Total Batch size = 16</span><br><span class="line">[2024-06-26 18:06:33,358] [    INFO] - eval_loss: 0.006688571535050869, eval_precision: 0.4, eval_recall: 0.4, eval_f1: 0.4000000000000001, eval_runtime: 0.0621, eval_samples_per_second: 64.41700614712398, eval_steps_per_second: 16.104251536780996, progress_or_epoch: 40.0</span><br><span class="line">[2024-06-26 18:06:33,359] [    INFO] - Saving model checkpoint to ./checkpoint/model_best/checkpoint-200</span><br><span class="line">[2024-06-26 18:06:33,360] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/checkpoint-200/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:06:33,360] [    INFO] - Special tokens file saved in ./checkpoint/model_best/checkpoint-200/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:06:33,370] [    INFO] - Configuration saved in ./checkpoint/model_best/checkpoint-200/config.json</span><br><span class="line">[2024-06-26 18:06:34,574] [    INFO] - Model weights saved in ./checkpoint/model_best/checkpoint-200/model_state.pdparams</span><br><span class="line">[2024-06-26 18:06:34,574] [    INFO] - Saving optimizer files.</span><br><span class="line">[2024-06-26 18:06:39,080] [    INFO] - [timelog] checkpoint saving time: 5.72s (2024-06-26 18:06:39) </span><br><span class="line">[2024-06-26 18:06:41,672] [    INFO] - loss: 0.00011128, learning_rate: 1e-05, global_step: 210, interval_runtime: 8.3772, interval_samples_per_second: 19.099448736351285, interval_steps_per_second: 1.1937155460219553, progress_or_epoch: 42.0</span><br><span class="line">[2024-06-26 18:06:44,288] [    INFO] - loss: 0.00011245, learning_rate: 1e-05, global_step: 220, interval_runtime: 2.6149, interval_samples_per_second: 61.18868160731556, interval_steps_per_second: 3.8242926004572224, progress_or_epoch: 44.0</span><br><span class="line">[2024-06-26 18:06:46,911] [    INFO] - loss: 0.00012268, learning_rate: 1e-05, global_step: 230, interval_runtime: 2.6234, interval_samples_per_second: 60.98920142963071, interval_steps_per_second: 3.8118250893519194, progress_or_epoch: 46.0</span><br><span class="line">[2024-06-26 18:06:49,537] [    INFO] - loss: 0.00013804, learning_rate: 1e-05, global_step: 240, interval_runtime: 2.6259, interval_samples_per_second: 60.93070388366043, interval_steps_per_second: 3.8081689927287767, progress_or_epoch: 48.0</span><br><span class="line">[2024-06-26 18:06:52,117] [    INFO] - loss: 0.00020081, learning_rate: 1e-05, global_step: 250, interval_runtime: 2.5809, interval_samples_per_second: 61.99492724918558, interval_steps_per_second: 3.8746829530740987, progress_or_epoch: 50.0</span><br><span class="line">[2024-06-26 18:06:54,753] [    INFO] - loss: 0.00014258, learning_rate: 1e-05, global_step: 260, interval_runtime: 2.6358, interval_samples_per_second: 60.702937625070206, interval_steps_per_second: 3.793933601566888, progress_or_epoch: 52.0</span><br><span class="line">[2024-06-26 18:06:57,369] [    INFO] - loss: 0.00012738, learning_rate: 1e-05, global_step: 270, interval_runtime: 2.6164, interval_samples_per_second: 61.153369707036596, interval_steps_per_second: 3.8220856066897873, progress_or_epoch: 54.0</span><br><span class="line">[2024-06-26 18:07:00,006] [    INFO] - loss: 0.00010497, learning_rate: 1e-05, global_step: 280, interval_runtime: 2.6373, interval_samples_per_second: 60.669083466377856, interval_steps_per_second: 3.791817716648616, progress_or_epoch: 56.0</span><br><span class="line">[2024-06-26 18:07:02,657] [    INFO] - loss: 0.00010167, learning_rate: 1e-05, global_step: 290, interval_runtime: 2.6499, interval_samples_per_second: 60.38069724825452, interval_steps_per_second: 3.7737935780159075, progress_or_epoch: 58.0</span><br><span class="line">[2024-06-26 18:07:05,297] [    INFO] - loss: 0.000171, learning_rate: 1e-05, global_step: 300, interval_runtime: 2.6399, interval_samples_per_second: 60.60732256501828, interval_steps_per_second: 3.7879576603136424, progress_or_epoch: 60.0</span><br><span class="line">[2024-06-26 18:07:05,298] [    INFO] - ***** Running Evaluation *****</span><br><span class="line">[2024-06-26 18:07:05,298] [    INFO] -   Num examples = 4</span><br><span class="line">[2024-06-26 18:07:05,298] [    INFO] -   Total prediction steps = 1</span><br><span class="line">[2024-06-26 18:07:05,298] [    INFO] -   Pre device batch size = 16</span><br><span class="line">[2024-06-26 18:07:05,298] [    INFO] -   Total Batch size = 16</span><br><span class="line">[2024-06-26 18:07:05,357] [    INFO] - eval_loss: 0.007026550825685263, eval_precision: 0.4, eval_recall: 0.4, eval_f1: 0.4000000000000001, eval_runtime: 0.0582, eval_samples_per_second: 68.67042956838507, eval_steps_per_second: 17.16760739209627, progress_or_epoch: 60.0</span><br><span class="line">[2024-06-26 18:07:05,358] [    INFO] - Saving model checkpoint to ./checkpoint/model_best/checkpoint-300</span><br><span class="line">[2024-06-26 18:07:05,358] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/checkpoint-300/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:07:05,358] [    INFO] - Special tokens file saved in ./checkpoint/model_best/checkpoint-300/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:07:05,364] [    INFO] - Configuration saved in ./checkpoint/model_best/checkpoint-300/config.json</span><br><span class="line">[2024-06-26 18:07:07,995] [    INFO] - Model weights saved in ./checkpoint/model_best/checkpoint-300/model_state.pdparams</span><br><span class="line">[2024-06-26 18:07:07,996] [    INFO] - Saving optimizer files.</span><br><span class="line">[2024-06-26 18:07:11,005] [    INFO] - [timelog] checkpoint saving time: 5.64s (2024-06-26 18:07:11) </span><br><span class="line">[2024-06-26 18:07:13,640] [    INFO] - loss: 9.265e-05, learning_rate: 1e-05, global_step: 310, interval_runtime: 8.3438, interval_samples_per_second: 19.17600366118997, interval_steps_per_second: 1.1985002288243731, progress_or_epoch: 62.0</span><br><span class="line">[2024-06-26 18:07:16,285] [    INFO] - loss: 0.00012613, learning_rate: 1e-05, global_step: 320, interval_runtime: 2.6441, interval_samples_per_second: 60.512013700058034, interval_steps_per_second: 3.782000856253627, progress_or_epoch: 64.0</span><br><span class="line">[2024-06-26 18:07:18,887] [    INFO] - loss: 7.656e-05, learning_rate: 1e-05, global_step: 330, interval_runtime: 2.603, interval_samples_per_second: 61.4676855948393, interval_steps_per_second: 3.8417303496774564, progress_or_epoch: 66.0</span><br><span class="line">[2024-06-26 18:07:21,539] [    INFO] - loss: 9.599e-05, learning_rate: 1e-05, global_step: 340, interval_runtime: 2.6517, interval_samples_per_second: 60.33811856609532, interval_steps_per_second: 3.7711324103809574, progress_or_epoch: 68.0</span><br><span class="line">[2024-06-26 18:07:24,185] [    INFO] - loss: 9.96e-05, learning_rate: 1e-05, global_step: 350, interval_runtime: 2.6462, interval_samples_per_second: 60.463986738962795, interval_steps_per_second: 3.7789991711851747, progress_or_epoch: 70.0</span><br><span class="line">[2024-06-26 18:07:26,830] [    INFO] - loss: 9.502e-05, learning_rate: 1e-05, global_step: 360, interval_runtime: 2.6438, interval_samples_per_second: 60.51813635974227, interval_steps_per_second: 3.782383522483892, progress_or_epoch: 72.0</span><br><span class="line">[2024-06-26 18:07:29,486] [    INFO] - loss: 8.396e-05, learning_rate: 1e-05, global_step: 370, interval_runtime: 2.6568, interval_samples_per_second: 60.22368303445632, interval_steps_per_second: 3.76398018965352, progress_or_epoch: 74.0</span><br><span class="line">[2024-06-26 18:07:32,128] [    INFO] - loss: 0.000107, learning_rate: 1e-05, global_step: 380, interval_runtime: 2.6414, interval_samples_per_second: 60.57406701856363, interval_steps_per_second: 3.785879188660227, progress_or_epoch: 76.0</span><br><span class="line">[2024-06-26 18:07:34,774] [    INFO] - loss: 0.00015859, learning_rate: 1e-05, global_step: 390, interval_runtime: 2.646, interval_samples_per_second: 60.46891186644317, interval_steps_per_second: 3.7793069916526982, progress_or_epoch: 78.0</span><br><span class="line">[2024-06-26 18:07:37,422] [    INFO] - loss: 8.44e-05, learning_rate: 1e-05, global_step: 400, interval_runtime: 2.6486, interval_samples_per_second: 60.40979254722639, interval_steps_per_second: 3.7756120342016493, progress_or_epoch: 80.0</span><br><span class="line">[2024-06-26 18:07:37,423] [    INFO] - ***** Running Evaluation *****</span><br><span class="line">[2024-06-26 18:07:37,423] [    INFO] -   Num examples = 4</span><br><span class="line">[2024-06-26 18:07:37,423] [    INFO] -   Total prediction steps = 1</span><br><span class="line">[2024-06-26 18:07:37,423] [    INFO] -   Pre device batch size = 16</span><br><span class="line">[2024-06-26 18:07:37,423] [    INFO] -   Total Batch size = 16</span><br><span class="line">[2024-06-26 18:07:37,482] [    INFO] - eval_loss: 0.00755023630335927, eval_precision: 0.4, eval_recall: 0.4, eval_f1: 0.4000000000000001, eval_runtime: 0.0578, eval_samples_per_second: 69.19010227647641, eval_steps_per_second: 17.297525569119102, progress_or_epoch: 80.0</span><br><span class="line">[2024-06-26 18:07:37,482] [    INFO] - Saving model checkpoint to ./checkpoint/model_best/checkpoint-400</span><br><span class="line">[2024-06-26 18:07:37,483] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/checkpoint-400/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:07:37,483] [    INFO] - Special tokens file saved in ./checkpoint/model_best/checkpoint-400/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:07:37,489] [    INFO] - Configuration saved in ./checkpoint/model_best/checkpoint-400/config.json</span><br><span class="line">[2024-06-26 18:07:38,671] [    INFO] - Model weights saved in ./checkpoint/model_best/checkpoint-400/model_state.pdparams</span><br><span class="line">[2024-06-26 18:07:38,671] [    INFO] - Saving optimizer files.</span><br><span class="line">[2024-06-26 18:07:41,730] [    INFO] - [timelog] checkpoint saving time: 4.24s (2024-06-26 18:07:41) </span><br><span class="line">[2024-06-26 18:07:44,394] [    INFO] - loss: 8.615e-05, learning_rate: 1e-05, global_step: 410, interval_runtime: 6.9719, interval_samples_per_second: 22.949178353528108, interval_steps_per_second: 1.4343236470955067, progress_or_epoch: 82.0</span><br><span class="line">[2024-06-26 18:07:47,030] [    INFO] - loss: 8.146e-05, learning_rate: 1e-05, global_step: 420, interval_runtime: 2.6363, interval_samples_per_second: 60.691782269542095, interval_steps_per_second: 3.793236391846381, progress_or_epoch: 84.0</span><br><span class="line">[2024-06-26 18:07:49,660] [    INFO] - loss: 0.0001024, learning_rate: 1e-05, global_step: 430, interval_runtime: 2.6297, interval_samples_per_second: 60.84334970295866, interval_steps_per_second: 3.8027093564349164, progress_or_epoch: 86.0</span><br><span class="line">[2024-06-26 18:07:52,296] [    INFO] - loss: 0.00011797, learning_rate: 1e-05, global_step: 440, interval_runtime: 2.6357, interval_samples_per_second: 60.70518895680559, interval_steps_per_second: 3.7940743098003495, progress_or_epoch: 88.0</span><br><span class="line">[2024-06-26 18:07:54,939] [    INFO] - loss: 0.00014716, learning_rate: 1e-05, global_step: 450, interval_runtime: 2.6435, interval_samples_per_second: 60.52505176192572, interval_steps_per_second: 3.7828157351203573, progress_or_epoch: 90.0</span><br><span class="line">[2024-06-26 18:07:57,583] [    INFO] - loss: 7.592e-05, learning_rate: 1e-05, global_step: 460, interval_runtime: 2.6437, interval_samples_per_second: 60.520177521644605, interval_steps_per_second: 3.782511095102788, progress_or_epoch: 92.0</span><br><span class="line">[2024-06-26 18:08:00,303] [    INFO] - loss: 8.616e-05, learning_rate: 1e-05, global_step: 470, interval_runtime: 2.7201, interval_samples_per_second: 58.82132721602211, interval_steps_per_second: 3.676332951001382, progress_or_epoch: 94.0</span><br><span class="line">[2024-06-26 18:08:02,968] [    INFO] - loss: 7.984e-05, learning_rate: 1e-05, global_step: 480, interval_runtime: 2.6645, interval_samples_per_second: 60.048504909189305, interval_steps_per_second: 3.7530315568243315, progress_or_epoch: 96.0</span><br><span class="line">[2024-06-26 18:08:05,618] [    INFO] - loss: 7.743e-05, learning_rate: 1e-05, global_step: 490, interval_runtime: 2.6507, interval_samples_per_second: 60.3610372488141, interval_steps_per_second: 3.7725648280508812, progress_or_epoch: 98.0</span><br><span class="line">[2024-06-26 18:08:08,285] [    INFO] - loss: 7.793e-05, learning_rate: 1e-05, global_step: 500, interval_runtime: 2.6661, interval_samples_per_second: 60.01194714924565, interval_steps_per_second: 3.750746696827853, progress_or_epoch: 100.0</span><br><span class="line">[2024-06-26 18:08:08,285] [    INFO] - ***** Running Evaluation *****</span><br><span class="line">[2024-06-26 18:08:08,285] [    INFO] -   Num examples = 4</span><br><span class="line">[2024-06-26 18:08:08,286] [    INFO] -   Total prediction steps = 1</span><br><span class="line">[2024-06-26 18:08:08,286] [    INFO] -   Pre device batch size = 16</span><br><span class="line">[2024-06-26 18:08:08,286] [    INFO] -   Total Batch size = 16</span><br><span class="line">[2024-06-26 18:08:08,344] [    INFO] - eval_loss: 0.007735834456980228, eval_precision: 0.4, eval_recall: 0.4, eval_f1: 0.4000000000000001, eval_runtime: 0.0574, eval_samples_per_second: 69.71943866123114, eval_steps_per_second: 17.429859665307784, progress_or_epoch: 100.0</span><br><span class="line">[2024-06-26 18:08:08,344] [    INFO] - Saving model checkpoint to ./checkpoint/model_best/checkpoint-500</span><br><span class="line">[2024-06-26 18:08:08,345] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/checkpoint-500/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:08:08,345] [    INFO] - Special tokens file saved in ./checkpoint/model_best/checkpoint-500/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:08:08,351] [    INFO] - Configuration saved in ./checkpoint/model_best/checkpoint-500/config.json</span><br><span class="line">[2024-06-26 18:08:09,518] [    INFO] - Model weights saved in ./checkpoint/model_best/checkpoint-500/model_state.pdparams</span><br><span class="line">[2024-06-26 18:08:09,518] [    INFO] - Saving optimizer files.</span><br><span class="line">[2024-06-26 18:08:11,773] [    INFO] - [timelog] checkpoint saving time: 3.42s (2024-06-26 18:08:11) </span><br><span class="line">[2024-06-26 18:08:11,774] [    INFO] - </span><br><span class="line">Training completed. </span><br><span class="line"></span><br><span class="line">[2024-06-26 18:08:11,774] [    INFO] - Loading best model from ./checkpoint/model_best/checkpoint-100 (score: 0.4000000000000001).</span><br><span class="line">[2024-06-26 18:08:12,116] [    INFO] - set state-dict :([], [])</span><br><span class="line">[2024-06-26 18:08:12,118] [    INFO] - train_runtime: 161.4472, train_samples_per_second: 42.1190341985795, train_steps_per_second: 3.0969878087190805, train_loss: 0.00023241847997996956, progress_or_epoch: 100.0</span><br><span class="line">[2024-06-26 18:08:12,134] [    INFO] - Saving model checkpoint to ./checkpoint/model_best</span><br><span class="line">[2024-06-26 18:08:12,135] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:08:12,135] [    INFO] - Special tokens file saved in ./checkpoint/model_best/special_tokens_map.json</span><br><span class="line">[2024-06-26 18:08:12,142] [    INFO] - Configuration saved in ./checkpoint/model_best/config.json</span><br><span class="line">[2024-06-26 18:08:13,814] [    INFO] - Model weights saved in ./checkpoint/model_best/model_state.pdparams</span><br><span class="line">[2024-06-26 18:08:13,815] [    INFO] - ***** train metrics *****</span><br><span class="line">[2024-06-26 18:08:13,815] [    INFO] -   progress_or_epoch        =      100.0</span><br><span class="line">[2024-06-26 18:08:13,815] [    INFO] -   train_loss               =     0.0002</span><br><span class="line">[2024-06-26 18:08:13,815] [    INFO] -   train_runtime            = 0:02:41.44</span><br><span class="line">[2024-06-26 18:08:13,815] [    INFO] -   train_samples_per_second =     42.119</span><br><span class="line">[2024-06-26 18:08:13,815] [    INFO] -   train_steps_per_second   =      3.097</span><br><span class="line">[2024-06-26 18:08:13,820] [    INFO] - ***** Running Evaluation *****</span><br><span class="line">[2024-06-26 18:08:13,820] [    INFO] -   Num examples = 4</span><br><span class="line">[2024-06-26 18:08:13,820] [    INFO] -   Total prediction steps = 1</span><br><span class="line">[2024-06-26 18:08:13,820] [    INFO] -   Pre device batch size = 16</span><br><span class="line">[2024-06-26 18:08:13,820] [    INFO] -   Total Batch size = 16</span><br><span class="line">[2024-06-26 18:08:13,888] [    INFO] - eval_loss: 0.005224619060754776, eval_precision: 0.4, eval_recall: 0.4, eval_f1: 0.4000000000000001, eval_runtime: 0.0687, eval_samples_per_second: 58.19804494272889, eval_steps_per_second: 14.549511235682223, progress_or_epoch: 100.0</span><br><span class="line">[2024-06-26 18:08:13,889] [    INFO] - ***** eval metrics *****</span><br><span class="line">[2024-06-26 18:08:13,889] [    INFO] -   eval_f1                 =        0.4</span><br><span class="line">[2024-06-26 18:08:13,889] [    INFO] -   eval_loss               =     0.0052</span><br><span class="line">[2024-06-26 18:08:13,889] [    INFO] -   eval_precision          =        0.4</span><br><span class="line">[2024-06-26 18:08:13,889] [    INFO] -   eval_recall             =        0.4</span><br><span class="line">[2024-06-26 18:08:13,889] [    INFO] -   eval_runtime            = 0:00:00.06</span><br><span class="line">[2024-06-26 18:08:13,890] [    INFO] -   eval_samples_per_second =     58.198</span><br><span class="line">[2024-06-26 18:08:13,890] [    INFO] -   eval_steps_per_second   =    14.5495</span><br><span class="line">[2024-06-26 18:08:13,890] [    INFO] -   progress_or_epoch       =      100.0</span><br><span class="line">/root/anaconda3/envs/py39_ppner_2_7_2/lib/python3.9/site-packages/paddle/jit/dy2static/program_translator.py:712: UserWarning: full_graph=False don't support input_spec arguments. It will not produce any effect.</span><br><span class="line">You can set full_graph=True, then you can assign input spec.</span><br><span class="line"></span><br><span class="line">  warnings.warn(</span><br><span class="line">[2024-06-26 18:08:13,895] [    INFO] - Exporting inference model to ./checkpoint/model_best/model</span><br><span class="line">I0626 18:08:15.824677 285242 program_interpreter.cc:212] New Executor is Running.</span><br><span class="line">[2024-06-26 18:08:18,295] [    INFO] - Inference model exported.</span><br><span class="line">[2024-06-26 18:08:18,297] [    INFO] - tokenizer config file saved in ./checkpoint/model_best/tokenizer_config.json</span><br><span class="line">[2024-06-26 18:08:18,297] [    INFO] - Special tokens file saved in ./checkpoint/model_best/special_tokens_map.json</span><br><span class="line">LAUNCH INFO 2024-06-26 18:08:20,044 Pod completed</span><br><span class="line">LAUNCH INFO 2024-06-26 18:08:20,045 Exit code 0</span><br></pre></td></tr></table></figure><p>æ¨¡å‹æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(py39_ppner_2_7_2) [root@jdz uie]# ll checkpoint/model_best/</span><br><span class="line">total 919580</span><br><span class="line">-rw-r--r-- 1 root root       207 Jun 26 18:08 all_results.json</span><br><span class="line">drwxr-xr-x 2 root root       251 Jun 26 18:06 checkpoint-100</span><br><span class="line">drwxr-xr-x 2 root root       251 Jun 26 18:06 checkpoint-200</span><br><span class="line">drwxr-xr-x 2 root root       251 Jun 26 18:07 checkpoint-300</span><br><span class="line">drwxr-xr-x 2 root root       251 Jun 26 18:07 checkpoint-400</span><br><span class="line">drwxr-xr-x 2 root root       251 Jun 26 18:08 checkpoint-500</span><br><span class="line">-rw-r--r-- 1 root root       559 Jun 26 18:08 config.json</span><br><span class="line">-rw-r--r-- 1 root root 469428391 Jun 26 18:08 model.pdiparams</span><br><span class="line">-rw-r--r-- 1 root root     17581 Jun 26 18:08 model.pdiparams.info</span><br><span class="line">-rw-r--r-- 1 root root    153135 Jun 26 18:08 model.pdmodel</span><br><span class="line">-rw-r--r-- 1 root root 471806543 Jun 26 18:12 model_state.pdparams</span><br><span class="line">drwxr-xr-x 7 root root       136 Jun 26 18:05 runs</span><br><span class="line">-rw-r--r-- 1 root root       112 Jun 26 18:08 special_tokens_map.json</span><br><span class="line">drwxr-xr-x 2 root root        90 Jun 26 18:12 static</span><br><span class="line">-rw-r--r-- 1 root root       197 Jun 26 18:08 tokenizer_config.json</span><br><span class="line">-rw-r--r-- 1 root root     16736 Jun 26 18:08 trainer_state.json</span><br><span class="line">-rw-r--r-- 1 root root      2598 Jun 26 18:08 training_args.bin</span><br><span class="line">-rw-r--r-- 1 root root       207 Jun 26 18:08 train_results.json</span><br><span class="line">-rw-r--r-- 1 root root    186807 Jun 26 18:08 vocab.txt</span><br><span class="line">(py39_ppner_2_7_2) [root@jdz uie]#</span><br></pre></td></tr></table></figure><p>è°ƒç”¨apiæµ‹è¯•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br><span class="line"><span class="keyword">from</span> paddlenlp <span class="keyword">import</span> Taskflow</span><br><span class="line"></span><br><span class="line">schema = [&#123;<span class="string">'å·¥ç¨‹'</span>: [<span class="string">'å·¥è‰º'</span>]&#125;]</span><br><span class="line"></span><br><span class="line">ie = Taskflow(<span class="string">'information_extraction'</span>, schema=schema, task_path=<span class="string">'./checkpoint/model_best'</span>)</span><br><span class="line"></span><br><span class="line">ie.set_schema(schema) <span class="comment"># Reset schema</span></span><br><span class="line">pprint(ie(<span class="string">"""å—åŠ›é’¢ç­‹çš„æ¥å¤´å½¢å¼åº”æŒ‰è®¾è®¡è¦æ±‚é‡‡ç”¨,è‹¥è®¾è®¡æ— è¦æ±‚æ—¶,é’¢ç­‹å®œé‡‡ç”¨ç„Šæ¥æ¥å¤´å’Œæœºæ¢°è¿æ¥æ¥å¤´,ä¹Ÿå¯é‡‡ç”¨ç»‘æ‰æ¥å¤´ã€‚"""</span>))</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[&#123;'å·¥ç¨‹': [&#123;'end': 9,</span><br><span class="line">          'probability': 0.9548929987860788,</span><br><span class="line">          'relations': &#123;'å·¥è‰º': [&#123;'end': 42,</span><br><span class="line">                                'probability': 0.2548182944884658,</span><br><span class="line">                                'start': 36,</span><br><span class="line">                                'text': 'æœºæ¢°è¿æ¥æ¥å¤´'&#125;]&#125;,</span><br><span class="line">          'start': 0,</span><br><span class="line">          'text': 'å—åŠ›é’¢ç­‹çš„æ¥å¤´å½¢å¼'&#125;]&#125;]</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Doccanoæ˜¯ä¸€ç§ç”¨äºæ–‡æœ¬æ ‡æ³¨çš„å¼€æºå·¥å…·ï¼Œæ—¨åœ¨ç®€åŒ–å’ŒåŠ é€Ÿæ ‡æ³¨ä»»åŠ¡çš„è¿›è¡Œã€‚å®ƒæä¾›äº†ä¸€ä¸ªç›´è§‚çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿æ ‡æ³¨äººå‘˜èƒ½å¤Ÿè½»æ¾åœ°å¯¹æ–‡æœ¬æ•°æ®è¿›è¡Œæ ‡æ³¨ï¼Œå¹¶åˆ›å»ºé«˜è´¨é‡çš„è®­ç»ƒæ•°æ®é›†ç”¨äºæœºå™¨å­¦ä¹ å’Œè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/06/28/doccano/1.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;é“¾æ¥ï¼š&lt;a href=&quot;https://github.com/doccano/doccano&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/doccano/doccano&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ä¸€ã€å®‰è£…éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#ä¸€ã€å®‰è£…éƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å®‰è£…éƒ¨ç½²&quot;&gt;&lt;/a&gt;ä¸€ã€å®‰è£…éƒ¨ç½²&lt;/h2&gt;&lt;h3 id=&quot;ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&lt;/h3&gt;&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;æ“ä½œç³»ç»Ÿ&lt;/font&gt;ï¼šCentos7.9&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;python&lt;/font&gt;ï¼š3.10&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;doccano&lt;/font&gt;ï¼š1.6.2&lt;/p&gt;
&lt;h3 id=&quot;pipå®‰è£…&quot;&gt;&lt;a href=&quot;#pipå®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;pipå®‰è£…&quot;&gt;&lt;/a&gt;pipå®‰è£…&lt;/h3&gt;&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;æ³¨&lt;/font&gt;ï¼šç™¾åº¦æºæ²¡æœ‰ç›¸åº”å®‰è£…åŒ…&lt;/p&gt;
&lt;p&gt;&lt;code&gt;pip install doccano==1.6.2 -i https://pypi.tuna.tsinghua.edu.cn/simple&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;åˆå§‹åŒ–&quot;&gt;&lt;a href=&quot;#åˆå§‹åŒ–&quot; class=&quot;headerlink&quot; title=&quot;åˆå§‹åŒ–&quot;&gt;&lt;/a&gt;åˆå§‹åŒ–&lt;/h3&gt;&lt;p&gt;&lt;code&gt;doccano init&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç &quot;&gt;&lt;a href=&quot;#è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç &quot; class=&quot;headerlink&quot; title=&quot;è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç &quot;&gt;&lt;/a&gt;è®¾ç½®è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç &lt;/h3&gt;&lt;p&gt;&lt;code&gt;doccano createuser --username admin --password 123456&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;å¯åŠ¨æœåŠ¡&quot;&gt;&lt;a href=&quot;#å¯åŠ¨æœåŠ¡&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ¨æœåŠ¡&quot;&gt;&lt;/a&gt;å¯åŠ¨æœåŠ¡&lt;/h3&gt;&lt;p&gt;&lt;code&gt;doccano webserver --port 8000&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/06/28/doccano/2.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/06/28/doccano/3.png&quot; alt&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://yoursite.com/categories/æ·±åº¦å­¦ä¹ /"/>
    
    
    <category term="doccano" scheme="http://yoursite.com/tags/doccano/"/>
    
    <category term="paddle" scheme="http://yoursite.com/tags/paddle/"/>
    
    <category term="ERNIE-UIE" scheme="http://yoursite.com/tags/ERNIE-UIE/"/>
    
  </entry>
  
  <entry>
    <title>yolov8-segï¼šçš®å¸¦æœºåç§»å®æ—¶æ£€æµ‹</title>
    <link href="http://yoursite.com/2024/05/11/yolov8-seg%EF%BC%9A%E7%9A%AE%E5%B8%A6%E6%9C%BA%E5%81%8F%E7%A7%BB%E5%AE%9E%E6%97%B6%E6%A3%80%E6%B5%8B/"/>
    <id>http://yoursite.com/2024/05/11/yolov8-seg%EF%BC%9A%E7%9A%AE%E5%B8%A6%E6%9C%BA%E5%81%8F%E7%A7%BB%E5%AE%9E%E6%97%B6%E6%A3%80%E6%B5%8B/</id>
    <published>2024-05-11T01:58:37.000Z</published>
    <updated>2024-06-28T08:16:23.152Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ç¯å¢ƒ-amp-å®‰è£…"><a href="#ç¯å¢ƒ-amp-å®‰è£…" class="headerlink" title="ç¯å¢ƒ&amp;å®‰è£…"></a>ç¯å¢ƒ&amp;å®‰è£…</h2><p>åŒä¸Šæ–‡yolov8ï¼šç«ç¾æ£€æµ‹</p><p>æ¨¡å‹ä½¿ç”¨<code>yolov8n-seg</code></p><h2 id="æ•°æ®æ ‡æ³¨"><a href="#æ•°æ®æ ‡æ³¨" class="headerlink" title="æ•°æ®æ ‡æ³¨"></a>æ•°æ®æ ‡æ³¨</h2><h3 id="æ ‡æ³¨å·¥å…·ï¼šlabelme"><a href="#æ ‡æ³¨å·¥å…·ï¼šlabelme" class="headerlink" title="æ ‡æ³¨å·¥å…·ï¼šlabelme"></a>æ ‡æ³¨å·¥å…·ï¼šlabelme</h3><p>å¯¹åˆ†å‰²ç›®æ ‡è¿›è¡Œå¤šè¾¹çŸ©å½¢æ ‡æ³¨</p><p><img src="/2024/05/11/yolov8-segï¼šçš®å¸¦æœºåç§»å®æ—¶æ£€æµ‹/1.png" alt></p><p><img src="/2024/05/11/yolov8-segï¼šçš®å¸¦æœºåç§»å®æ—¶æ£€æµ‹/2.png" alt></p><a id="more"></a><h3 id="æ•°æ®æ ¼å¼è½¬æ¢"><a href="#æ•°æ®æ ¼å¼è½¬æ¢" class="headerlink" title="æ•°æ®æ ¼å¼è½¬æ¢"></a>æ•°æ®æ ¼å¼è½¬æ¢</h3><p>å°†labelmeå¤šè¾¹çŸ©å½¢æ•°æ®æ ¼å¼è½¬ä¸ºyolo-segæ•°æ®æ ¼å¼ï¼Œé€šç”¨è½¬æ¢ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_labelme_to_yolo</span><span class="params">(json_file, output_txt_file, label_to_class_id)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(json_file, <span class="string">'r'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        data = json.load(file)</span><br><span class="line"></span><br><span class="line">    image_width = data[<span class="string">'imageWidth'</span>]</span><br><span class="line">    image_height = data[<span class="string">'imageHeight'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(output_txt_file, <span class="string">'w'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">for</span> shape <span class="keyword">in</span> data[<span class="string">'shapes'</span>]:</span><br><span class="line">            points = shape[<span class="string">'points'</span>]</span><br><span class="line">            class_id = label_to_class_id.get(shape[<span class="string">'label'</span>], <span class="number">-1</span>)</span><br><span class="line">            normalized_points = []</span><br><span class="line">            <span class="keyword">for</span> x, y <span class="keyword">in</span> points:</span><br><span class="line">                nx = round(x / image_width, <span class="number">6</span>)</span><br><span class="line">                ny = round(y / image_height, <span class="number">6</span>)</span><br><span class="line">                normalized_points.append(<span class="string">f"<span class="subst">&#123;nx&#125;</span> <span class="subst">&#123;ny&#125;</span>"</span>)</span><br><span class="line">            file.write(<span class="string">f"<span class="subst">&#123;class_id&#125;</span> "</span> + <span class="string">" "</span>.join(normalized_points) + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">batch_convert</span><span class="params">(json_folder, output_folder, label_to_class_id)</span>:</span></span><br><span class="line">    <span class="comment"># ç¡®ä¿è¾“å‡ºæ–‡ä»¶å¤¹å­˜åœ¨</span></span><br><span class="line">    os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># éå†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰JSONæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(json_folder):</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">'.json'</span>):</span><br><span class="line">            json_file = os.path.join(json_folder, filename)</span><br><span class="line">            output_txt_file = os.path.join(output_folder, filename.replace(<span class="string">'.json'</span>, <span class="string">'.txt'</span>))</span><br><span class="line">            convert_labelme_to_yolo(json_file, output_txt_file, label_to_class_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_label_file</span><span class="params">(label_dict, output)</span>:</span></span><br><span class="line">    sorted_labels = [label <span class="keyword">for</span> label, _ <span class="keyword">in</span> sorted(label_dict.items(), key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(output, <span class="string">'w'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">for</span> label <span class="keyword">in</span> sorted_labels:</span><br><span class="line">            file.write(<span class="string">f"<span class="subst">&#123;label&#125;</span>\n"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">    label_map = &#123;</span><br><span class="line">        <span class="string">'belt'</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json_path = <span class="string">r'D:\pycharmproject_2\yolo\ultralytics\datasets\belt_seg\json'</span></span><br><span class="line">    output_path = <span class="string">r'D:\pycharmproject_2\yolo\ultralytics\datasets\belt_seg\images'</span></span><br><span class="line"></span><br><span class="line">    batch_convert(json_path, output_path, label_map)</span><br><span class="line">    <span class="comment"># ç”Ÿæˆlabelme.txtæ–‡ä»¶ï¼ŒæŒ‰ç…§label_dictçš„å€¼ä»å°åˆ°å¤§æ’åˆ—ï¼Œä¸€ä¸ªç±»åˆ«1è¡Œ</span></span><br><span class="line">    create_label_file(label_map, <span class="string">r'D:\pycharmproject_2\yolo\ultralytics\datasets\belt_seg\yolo-label.txt'</span>)</span><br></pre></td></tr></table></figure><p>å®Œæˆåç¨ä½œæ•´ç†ï¼Œå°†æ•°æ®é›†æŒ‰5:1:1æ¯”ä¾‹åˆ’åˆ†æˆtrain/test/val</p><h3 id="åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶"><a href="#åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶" class="headerlink" title="åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶"></a>åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶</h3><p>å‚è€ƒ<code>yolov8n-seg.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span> <span class="string">/exp/work/video/ultralytics/datasets/belt_seg/data/train/images</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">/exp/work/video/ultralytics/datasets/belt_seg/data/val/images</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">/exp/work/video/ultralytics/datasets/belt_seg/data/test/images</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">names:</span> <span class="string">[belt]</span></span><br></pre></td></tr></table></figure><h2 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h2><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></span><br><span class="line">model = YOLO(<span class="string">'yolov8n-seg.pt'</span>)  <span class="comment"># load a pretrained model (recommended for training)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨åŒå¡è®­ç»ƒ</span></span><br><span class="line">model.train(</span><br><span class="line">    data=<span class="string">'datasets/belt_seg/belt_seg.yaml'</span>,</span><br><span class="line">    epochs=<span class="number">300</span>,</span><br><span class="line">    device=[<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">    save_dir=<span class="string">'runs/segment/belt'</span>)</span><br><span class="line"><span class="comment"># å¯ç”¨æ¨¡å‹éªŒè¯</span></span><br><span class="line">model.val()</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">(py39_yolov8) [root@jdz ultralytics]# python yolov8_train.py </span><br><span class="line">Ultralytics YOLOv8.2.41 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                           CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">engine/trainer: task=segment, mode=train, model=yolov8n-seg.pt, data=datasets/belt_seg/belt_seg.yaml, epochs=300, time=None, patience=100, batch=16, imgsz=640, save=True, save_period=-1, cache=False, device=[0, 1], workers=8, project=None, name=train6, exist_ok=False, pretrained=True, optimizer=auto, verbose=True, seed=0, deterministic=True, single_cls=False, rect=False, cos_lr=False, close_mosaic=10, resume=False, amp=True, fraction=1.0, profile=False, freeze=None, multi_scale=False, overlap_mask=True, mask_ratio=4, dropout=0.0, val=True, split=val, save_json=False, save_hybrid=False, conf=None, iou=0.7, max_det=300, half=False, dnn=False, plots=True, source=None, vid_stride=1, stream_buffer=False, visualize=False, augment=False, agnostic_nms=False, classes=None, retina_masks=False, embed=None, show=False, save_frames=False, save_txt=False, save_conf=False, save_crop=False, show_labels=True, show_conf=True, show_boxes=True, line_width=None, format=torchscript, keras=False, optimize=False, int8=False, dynamic=False, simplify=False, opset=None, workspace=4, nms=False, lr0=0.01, lrf=0.01, momentum=0.937, weight_decay=0.0005, warmup_epochs=3.0, warmup_momentum=0.8, warmup_bias_lr=0.1, box=7.5, cls=0.5, dfl=1.5, pose=12.0, kobj=1.0, label_smoothing=0.0, nbs=64, hsv_h=0.015, hsv_s=0.7, hsv_v=0.4, degrees=0.0, translate=0.1, scale=0.5, shear=0.0, perspective=0.0, flipud=0.0, fliplr=0.5, bgr=0.0, mosaic=1.0, mixup=0.0, copy_paste=0.0, auto_augment=randaugment, erasing=0.4, crop_fraction=1.0, cfg=None, tracker=botsort.yaml, save_dir=runs/segment/train6</span><br><span class="line">Overriding model.yaml nc=80 with nc=1</span><br><span class="line"></span><br><span class="line">                   from  n    params  module                                       arguments                     </span><br><span class="line">  0                  -1  1       464  ultralytics.nn.modules.conv.Conv             [3, 16, 3, 2]                 </span><br><span class="line">  1                  -1  1      4672  ultralytics.nn.modules.conv.Conv             [16, 32, 3, 2]                </span><br><span class="line">  2                  -1  1      7360  ultralytics.nn.modules.block.C2f             [32, 32, 1, True]             </span><br><span class="line">  3                  -1  1     18560  ultralytics.nn.modules.conv.Conv             [32, 64, 3, 2]                </span><br><span class="line">  4                  -1  2     49664  ultralytics.nn.modules.block.C2f             [64, 64, 2, True]             </span><br><span class="line">  5                  -1  1     73984  ultralytics.nn.modules.conv.Conv             [64, 128, 3, 2]               </span><br><span class="line">  6                  -1  2    197632  ultralytics.nn.modules.block.C2f             [128, 128, 2, True]           </span><br><span class="line">  7                  -1  1    295424  ultralytics.nn.modules.conv.Conv             [128, 256, 3, 2]              </span><br><span class="line">  8                  -1  1    460288  ultralytics.nn.modules.block.C2f             [256, 256, 1, True]           </span><br><span class="line">  9                  -1  1    164608  ultralytics.nn.modules.block.SPPF            [256, 256, 5]                 </span><br><span class="line"> 10                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, 'nearest']          </span><br><span class="line"> 11             [-1, 6]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 12                  -1  1    148224  ultralytics.nn.modules.block.C2f             [384, 128, 1]                 </span><br><span class="line"> 13                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, 'nearest']          </span><br><span class="line"> 14             [-1, 4]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 15                  -1  1     37248  ultralytics.nn.modules.block.C2f             [192, 64, 1]                  </span><br><span class="line"> 16                  -1  1     36992  ultralytics.nn.modules.conv.Conv             [64, 64, 3, 2]                </span><br><span class="line"> 17            [-1, 12]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 18                  -1  1    123648  ultralytics.nn.modules.block.C2f             [192, 128, 1]                 </span><br><span class="line"> 19                  -1  1    147712  ultralytics.nn.modules.conv.Conv             [128, 128, 3, 2]              </span><br><span class="line"> 20             [-1, 9]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 21                  -1  1    493056  ultralytics.nn.modules.block.C2f             [384, 256, 1]                 </span><br><span class="line"> 22        [15, 18, 21]  1   1004275  ultralytics.nn.modules.head.Segment          [1, 32, 64, [64, 128, 256]]   </span><br><span class="line">YOLOv8n-seg summary: 261 layers, 3263811 parameters, 3263795 gradients, 12.1 GFLOPs</span><br><span class="line"></span><br><span class="line">Transferred 381/417 items from pretrained weights</span><br><span class="line">DDP: debug command /root/anaconda3/envs/py39_yolov8/bin/python -m torch.distributed.run --nproc_per_node 2 --master_port 48598 /root/.config/Ultralytics/DDP/_temp_p1zi2y0s140608071072736.py</span><br><span class="line">Ultralytics YOLOv8.2.41 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                           CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">Overriding model.yaml nc=80 with nc=1</span><br><span class="line">Transferred 381/417 items from pretrained weights</span><br><span class="line">Freezing layer 'model.22.dfl.conv.weight'</span><br><span class="line">AMP: running Automatic Mixed Precision (AMP) checks with YOLOv8n...</span><br><span class="line">AMP: checks passed âœ…</span><br><span class="line">train: Scanning /exp/work/video/ultralytics/datasets/belt_seg/data/train/labels... 100 images, 0 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 100/100 [00:00&lt;00:00, 681.30it/s]</span><br><span class="line">train: WARNING âš ï¸ /exp/work/video/ultralytics/datasets/belt_seg/data/train/images/04221812151.jpg: corrupt JPEG restored and saved</span><br><span class="line">train: WARNING âš ï¸ /exp/work/video/ultralytics/datasets/belt_seg/data/train/images/1549055475952230.jpg: corrupt JPEG restored and saved</span><br><span class="line">train: New cache created: /exp/work/video/ultralytics/datasets/belt_seg/data/train/labels.cache</span><br><span class="line">val: Scanning /exp/work/video/ultralytics/datasets/belt_seg/data/val/labels... 20 images, 0 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 20/20 [00:00&lt;00:00, 557.79it/s]</span><br><span class="line">val: New cache created: /exp/work/video/ultralytics/datasets/belt_seg/data/val/labels.cache</span><br><span class="line">Plotting labels to runs/segment/train6/labels.jpg... </span><br><span class="line">optimizer: 'optimizer=auto' found, ignoring 'lr0=0.01' and 'momentum=0.937' and determining best 'optimizer', 'lr0' and 'momentum' automatically... </span><br><span class="line">optimizer: AdamW(lr=0.000714, momentum=0.9) with parameter groups 66 weight(decay=0.0), 77 weight(decay=0.0005), 76 bias(decay=0.0)</span><br><span class="line">Image sizes 640 train, 640 val</span><br><span class="line">Using 16 dataloader workers</span><br><span class="line">Logging results to runs/segment/train6</span><br><span class="line">Starting training for 300 epochs...</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      1/300      1.57G     0.9085      3.003      2.743      1.368          6        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:05&lt;00:00,  1.35it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  2.54it/s]</span><br><span class="line">                   all         20         21     0.0035          1      0.179      0.087     0.0035          1      0.113     0.0414</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      2/300       1.6G     0.7924      2.131      2.561      1.221          6        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  4.83it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  8.52it/s]</span><br><span class="line">                   all         20         21     0.0035          1      0.753      0.548     0.0035          1      0.753      0.499</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      3/300      1.63G     0.5945      1.036      1.887       1.12          3        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  4.93it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  8.46it/s]</span><br><span class="line">                   all         20         21     0.0035          1      0.886      0.581     0.0035          1      0.886      0.616</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      4/300      1.62G     0.5529     0.7711      1.401      1.065          7        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.25it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  7.88it/s]</span><br><span class="line">                   all         20         21      0.606      0.952      0.819      0.582      0.606      0.952      0.819      0.641</span><br><span class="line">...</span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    295/300      1.61G     0.1653     0.1045     0.2493     0.8894          3        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.45it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  9.24it/s]</span><br><span class="line">                   all         20         21      0.982          1      0.995      0.926      0.982          1      0.995      0.912</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    296/300      1.63G     0.2021     0.1132     0.2765      0.895          2        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.70it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  9.00it/s]</span><br><span class="line">                   all         20         21      0.974          1      0.995      0.933      0.974          1      0.995      0.917</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    297/300      1.63G     0.1777     0.1075     0.2616     0.8351          2        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.51it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  7.61it/s]</span><br><span class="line">                   all         20         21      0.969          1      0.995      0.927      0.969          1      0.995      0.915</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    298/300      1.63G     0.1736     0.1195     0.2461     0.8778          2        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.64it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  8.73it/s]</span><br><span class="line">                   all         20         21      0.968          1      0.995      0.935      0.968          1      0.995      0.916</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    299/300      1.61G     0.2036     0.6821     0.2815     0.8217          2        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.33it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  8.39it/s]</span><br><span class="line">                   all         20         21      0.962          1      0.995      0.933      0.962          1      0.995      0.905</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   seg_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    300/300      1.63G      0.155     0.1236     0.2409     0.8592          2        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:01&lt;00:00,  5.38it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  8.70it/s]</span><br><span class="line">                   all         20         21      0.977          1      0.995      0.927      0.977          1      0.995      0.917</span><br><span class="line"></span><br><span class="line">300 epochs completed in 0.181 hours.</span><br><span class="line">Optimizer stripped from runs/segment/train6/weights/last.pt, 6.8MB</span><br><span class="line">Optimizer stripped from runs/segment/train6/weights/best.pt, 6.8MB</span><br><span class="line"></span><br><span class="line">Validating runs/segment/train6/weights/best.pt...</span><br><span class="line">Ultralytics YOLOv8.2.41 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                           CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">YOLOv8n-seg summary (fused): 195 layers, 3258259 parameters, 0 gradients, 12.0 GFLOPs</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00,  9.32it/s]</span><br><span class="line">                   all         20         21      0.995          1      0.995      0.948      0.995          1      0.995      0.944</span><br><span class="line">Speed: 0.2ms preprocess, 1.5ms inference, 0.0ms loss, 0.9ms postprocess per image</span><br><span class="line">Results saved to runs/segment/train6</span><br><span class="line">Ultralytics YOLOv8.2.41 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                           CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">YOLOv8n-seg summary (fused): 195 layers, 3258259 parameters, 0 gradients, 12.0 GFLOPs</span><br><span class="line">val: Scanning /exp/work/video/ultralytics/datasets/belt_seg/data/val/labels.cache... 20 images, 0 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 20/20 [00:00&lt;?, ?it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:01&lt;00:00,  1.42it/s]</span><br><span class="line">                   all         20         21      0.995          1      0.995      0.948      0.995          1      0.995      0.944</span><br><span class="line">Speed: 0.3ms preprocess, 24.2ms inference, 0.0ms loss, 32.2ms postprocess per image</span><br><span class="line">Results saved to runs/segment/train62</span><br></pre></td></tr></table></figure><h2 id="é¢„æµ‹"><a href="#é¢„æµ‹" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h2><h3 id="å¯¼åŒ…ã€æ¨¡å‹åŠ è½½-amp-GPUåŠ è½½"><a href="#å¯¼åŒ…ã€æ¨¡å‹åŠ è½½-amp-GPUåŠ è½½" class="headerlink" title="å¯¼åŒ…ã€æ¨¡å‹åŠ è½½&amp;GPUåŠ è½½"></a>å¯¼åŒ…ã€æ¨¡å‹åŠ è½½&amp;GPUåŠ è½½</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line">model2 = YOLO(<span class="string">'runs/segment/train6/weights/best.pt'</span>)</span><br><span class="line">t = time.time()</span><br><span class="line">results = model2.predict(<span class="string">'video/belt.mp4'</span>, stream=<span class="literal">False</span>, save=<span class="literal">False</span>, device=[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> res <span class="keyword">in</span> results:</span><br><span class="line">    print(res)</span><br><span class="line">print(time.time() - t)</span><br></pre></td></tr></table></figure><h2 id="å¤šåª’ä½“æ¨æ‹‰æµ"><a href="#å¤šåª’ä½“æ¨æ‹‰æµ" class="headerlink" title="å¤šåª’ä½“æ¨æ‹‰æµ"></a>å¤šåª’ä½“æ¨æ‹‰æµ</h2><p>ä¸»å‡½æ•°ï¼ˆå¤šè¿›ç¨‹ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">from</span> visualize.segment <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamingSegmentServer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, stream_src, stream_dst, cordon)</span>:</span></span><br><span class="line">        self.pipe = <span class="literal">None</span></span><br><span class="line">        self.model = <span class="literal">None</span></span><br><span class="line">        self.capture = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.fps = <span class="number">0</span></span><br><span class="line">        self.width = <span class="number">0</span></span><br><span class="line">        self.height = <span class="number">0</span></span><br><span class="line">        self.frame_id = <span class="number">0</span></span><br><span class="line">        self.solve_id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.cordon = cordon</span><br><span class="line">        self.stream_src = stream_src</span><br><span class="line">        self.stream_dst = stream_dst</span><br><span class="line"></span><br><span class="line">        self.center = self.calculate_geometric_center()</span><br><span class="line">        self.avg_width = (self.cordon[<span class="number">3</span>][<span class="number">0</span>]-self.cordon[<span class="number">0</span>][<span class="number">0</span>] + self.cordon[<span class="number">2</span>][<span class="number">0</span>]-self.cordon[<span class="number">1</span>][<span class="number">0</span>]) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calculate_geometric_center</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(self.cordon) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        sum_x = sum([point[<span class="number">0</span>] <span class="keyword">for</span> point <span class="keyword">in</span> self.cordon])</span><br><span class="line">        sum_y = sum([point[<span class="number">1</span>] <span class="keyword">for</span> point <span class="keyword">in</span> self.cordon])</span><br><span class="line">        center_x = sum_x / len(self.cordon)</span><br><span class="line">        center_y = sum_y / len(self.cordon)</span><br><span class="line">        <span class="keyword">return</span> center_x, center_y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        framequeue = multiprocessing.Queue(<span class="number">10</span>)</span><br><span class="line">        solvequeue = multiprocessing.Queue(<span class="number">10</span>)</span><br><span class="line">        solvequeue.put(<span class="number">1</span>)</span><br><span class="line">        self.capture = cv2.VideoCapture(self.stream_src)</span><br><span class="line">        self.fps = int(self.capture.get(cv2.CAP_PROP_FPS))</span><br><span class="line">        self.width = int(self.capture.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">        self.height = int(self.capture.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line"></span><br><span class="line">        command = [<span class="string">'ffmpeg'</span>,</span><br><span class="line">                   <span class="string">'-y'</span>,</span><br><span class="line">                   <span class="string">'-f'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">                   <span class="string">'-vcodec'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">                   <span class="string">'-pix_fmt'</span>, <span class="string">'bgr24'</span>,</span><br><span class="line">                   <span class="string">'-s'</span>, <span class="string">"&#123;&#125;x&#123;&#125;"</span>.format(self.width, self.height),</span><br><span class="line">                   <span class="string">'-r'</span>, str(self.fps),</span><br><span class="line">                   <span class="string">'-i'</span>, <span class="string">'-'</span>,</span><br><span class="line">                   <span class="string">'-c:v'</span>, <span class="string">'libx264'</span>,</span><br><span class="line">                   <span class="string">'-pix_fmt'</span>, <span class="string">'yuv420p'</span>,</span><br><span class="line">                   <span class="string">'-preset'</span>, <span class="string">'ultrafast'</span>,</span><br><span class="line">                   <span class="string">'-f'</span>, <span class="string">'rtsp'</span>,</span><br><span class="line">                   self.stream_dst]</span><br><span class="line">        pipe = sp.Popen(command, stdin=sp.PIPE)</span><br><span class="line"></span><br><span class="line">        capture_thread = threading.Thread(target=self.capture_video, args=(framequeue,))</span><br><span class="line">        capture_thread.start()</span><br><span class="line"></span><br><span class="line">        solve_id = multiprocessing.Value(<span class="string">'i'</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(worker.get(<span class="string">'worker_threads'</span>)):</span><br><span class="line">            process_thread = multiprocessing.Process(target=self.process_video, args=(pipe, framequeue, solve_id))</span><br><span class="line">            process_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">capture_video</span><span class="params">(self, framequeue)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> framequeue.full():</span><br><span class="line">                time.sleep(<span class="number">0.05</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ret, frame = self.capture.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                image_bgr = frame</span><br><span class="line">                self.frame_id += <span class="number">1</span></span><br><span class="line">                framequeue.put((image_bgr, self.frame_id))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_video</span><span class="params">(self, pipe, framequeue, solve_id)</span>:</span></span><br><span class="line">        model = YOLO(<span class="string">'runs/segment/train6/weights/best.pt'</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> framequeue.empty():</span><br><span class="line">                frame_bgr, frame_id = framequeue.get()</span><br><span class="line">                results = model.predict(</span><br><span class="line">                    frame_bgr,</span><br><span class="line">                    stream=<span class="literal">False</span>,</span><br><span class="line">                    save=<span class="literal">False</span>,</span><br><span class="line">                    device=[<span class="number">0</span>],</span><br><span class="line">                    verbose=<span class="literal">False</span></span><br><span class="line">                )</span><br><span class="line">                names = results[<span class="number">0</span>].names</span><br><span class="line">                clses = [int(i) <span class="keyword">for</span> i <span class="keyword">in</span> results[<span class="number">0</span>].boxes.cls.tolist()]</span><br><span class="line">                masks = [i.tolist() <span class="keyword">for</span> i <span class="keyword">in</span> results[<span class="number">0</span>].masks.xy]</span><br><span class="line">                name_set = [names.get(i) <span class="keyword">for</span> i <span class="keyword">in</span> clses]</span><br><span class="line"></span><br><span class="line">                frame_bgr = visualize_seg(</span><br><span class="line">                    frame_bgr,</span><br><span class="line">                    masks,</span><br><span class="line">                    name_set,</span><br><span class="line">                    self.cordon,</span><br><span class="line">                    self.center,</span><br><span class="line">                    self.avg_width)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">                    <span class="keyword">if</span> solve_id.value == frame_id:</span><br><span class="line">                        pipe.stdin.write(frame_bgr.tobytes())</span><br><span class="line">                        solve_id.value += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rtsp_url = <span class="string">'rtsp://192.168.9.164:8554/video'</span></span><br><span class="line">    rtsp_stream = <span class="string">'rtsp://192.168.9.164:8554/live'</span></span><br><span class="line">    outline = [[<span class="number">268</span>, <span class="number">4</span>], [<span class="number">145</span>, <span class="number">311</span>],..., [<span class="number">482</span>, <span class="number">311</span>], [<span class="number">358</span>, <span class="number">4</span>]] <span class="comment"># è‡ªå®šä¹‰å®‰å…¨åŒºåŸŸ</span></span><br><span class="line">    sss = StreamingSegmentServer(rtsp_url, rtsp_stream, outline)</span><br><span class="line">    sss.run()</span><br></pre></td></tr></table></figure><p>å¯è§†åŒ– &amp; åç§»ç®—æ³•ï¼ˆè®¡ç®—åˆ†å‰²æ©ç ä¸å®‰å…¨åŒºåŸŸä¸­å¿ƒç‚¹xè½´åç§»é‡ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFile, ImageFont</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> PR</span><br><span class="line"></span><br><span class="line">font_file = os.path.join(PR, <span class="string">'visualize/SourceHanSansCN-Medium.otf'</span>)</span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_geometric_center</span><span class="params">(points)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(points) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    sum_x = sum([point[<span class="number">0</span>] <span class="keyword">for</span> point <span class="keyword">in</span> points])</span><br><span class="line">    sum_y = sum([point[<span class="number">1</span>] <span class="keyword">for</span> point <span class="keyword">in</span> points])</span><br><span class="line">    center_x = sum_x / len(points)</span><br><span class="line">    center_y = sum_y / len(points)</span><br><span class="line">    <span class="keyword">return</span> center_x, center_y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visualize_seg</span><span class="params">(im, masks, names, cordon, center, avg_width)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(im, str):</span><br><span class="line">        im = Image.open(im)</span><br><span class="line">        im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">        im = cv2.cvtColor(im, cv2.COLOR_RGB2BGR)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        im = np.ascontiguousarray(np.copy(im))</span><br><span class="line"></span><br><span class="line">    im = Image.fromarray(im)</span><br><span class="line">    im = im.convert(<span class="string">'RGBA'</span>)</span><br><span class="line">    size = im.size</span><br><span class="line"></span><br><span class="line">    layer = Image.new(<span class="string">'RGBA'</span>, size)</span><br><span class="line">    draw = ImageDraw.Draw(im)</span><br><span class="line">    draw2 = ImageDraw.Draw(layer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, name <span class="keyword">in</span> enumerate(names):</span><br><span class="line">        mask = masks[i]</span><br><span class="line">        mask = [tuple(j) <span class="keyword">for</span> j <span class="keyword">in</span> mask]</span><br><span class="line">        text = name</span><br><span class="line">        center_rt = calculate_geometric_center(mask)</span><br><span class="line">        <span class="comment"># offset = math.sqrt(pow(center_rt[0] - center[0], 2) + pow(center_rt[1] - center[1], 2)) / avg_width è®¡ç®—è·ç¦»åç§»</span></span><br><span class="line">        offset = (center_rt[<span class="number">0</span>] - center[<span class="number">0</span>]) / avg_width</span><br><span class="line"></span><br><span class="line">        draw2.polygon(mask,</span><br><span class="line">                      fill=(<span class="number">128</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">160</span>),</span><br><span class="line">                      outline=(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span><br><span class="line">        im.paste(layer, mask=layer)</span><br><span class="line">        draw.text(</span><br><span class="line">            (mask[<span class="number">0</span>][<span class="number">0</span>], mask[<span class="number">0</span>][<span class="number">1</span>]),</span><br><span class="line">            text,</span><br><span class="line">            font=ImageFont.truetype(font_file, size=<span class="number">13</span>),</span><br><span class="line">            fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>))</span><br><span class="line">        draw.text(</span><br><span class="line">            (mask[<span class="number">0</span>][<span class="number">0</span>], mask[<span class="number">0</span>][<span class="number">1</span>]+<span class="number">20</span>),</span><br><span class="line">            <span class="string">'offset: '</span> + str(offset),</span><br><span class="line">            font=ImageFont.truetype(font_file, size=<span class="number">13</span>),</span><br><span class="line">            fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">    draw.polygon([tuple(i) <span class="keyword">for</span> i <span class="keyword">in</span> cordon],</span><br><span class="line">                 fill=<span class="literal">None</span>,</span><br><span class="line">                 outline=(<span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">    im = im.convert(<span class="string">'RGB'</span>)</span><br><span class="line">    im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">    <span class="keyword">return</span> im</span><br></pre></td></tr></table></figure><p>é…ç½®é¡¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">PR = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line">worker = &#123;</span><br><span class="line">    <span class="string">'worker_threads'</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="string">'worker_queue_len'</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/05/11/yolov8-segï¼šçš®å¸¦æœºåç§»å®æ—¶æ£€æµ‹/3.png" alt></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¯å¢ƒ-amp-å®‰è£…&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ-amp-å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&amp;amp;å®‰è£…&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&amp;amp;å®‰è£…&lt;/h2&gt;&lt;p&gt;åŒä¸Šæ–‡yolov8ï¼šç«ç¾æ£€æµ‹&lt;/p&gt;
&lt;p&gt;æ¨¡å‹ä½¿ç”¨&lt;code&gt;yolov8n-seg&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;æ•°æ®æ ‡æ³¨&quot;&gt;&lt;a href=&quot;#æ•°æ®æ ‡æ³¨&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®æ ‡æ³¨&quot;&gt;&lt;/a&gt;æ•°æ®æ ‡æ³¨&lt;/h2&gt;&lt;h3 id=&quot;æ ‡æ³¨å·¥å…·ï¼šlabelme&quot;&gt;&lt;a href=&quot;#æ ‡æ³¨å·¥å…·ï¼šlabelme&quot; class=&quot;headerlink&quot; title=&quot;æ ‡æ³¨å·¥å…·ï¼šlabelme&quot;&gt;&lt;/a&gt;æ ‡æ³¨å·¥å…·ï¼šlabelme&lt;/h3&gt;&lt;p&gt;å¯¹åˆ†å‰²ç›®æ ‡è¿›è¡Œå¤šè¾¹çŸ©å½¢æ ‡æ³¨&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/05/11/yolov8-segï¼šçš®å¸¦æœºåç§»å®æ—¶æ£€æµ‹/1.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/05/11/yolov8-segï¼šçš®å¸¦æœºåç§»å®æ—¶æ£€æµ‹/2.png&quot; alt&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="å®ä¾‹åˆ†å‰²" scheme="http://yoursite.com/categories/å®ä¾‹åˆ†å‰²/"/>
    
    
    <category term="yolov8" scheme="http://yoursite.com/tags/yolov8/"/>
    
    <category term="opencv" scheme="http://yoursite.com/tags/opencv/"/>
    
  </entry>
  
  <entry>
    <title>Bert+GRUåœ°å€å½’ä¸€ç®—æ³•</title>
    <link href="http://yoursite.com/2024/04/05/Bert-GRU%E5%9C%B0%E5%9D%80%E5%BD%92%E4%B8%80%E7%AE%97%E6%B3%95/"/>
    <id>http://yoursite.com/2024/04/05/Bert-GRU%E5%9C%B0%E5%9D%80%E5%BD%92%E4%B8%80%E7%AE%97%E6%B3%95/</id>
    <published>2024-04-05T08:23:15.000Z</published>
    <updated>2024-06-28T08:40:03.114Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ä¸€ã€-ç®—æ³•ç®€ä»‹"><a href="#ä¸€ã€-ç®—æ³•ç®€ä»‹" class="headerlink" title="ä¸€ã€ ç®—æ³•ç®€ä»‹"></a>ä¸€ã€ ç®—æ³•ç®€ä»‹</h2><p>æœ¬åœ°å€å½’ä¸€ç®—æ³•ï¼ˆå·²ç»ä¸‹ç®€ç§°ç®—æ³•ï¼‰æ—¨åœ¨å¯¹è¾“å…¥æ–‡æœ¬ä¸­å‡ºç°çš„åœ°å€ä¿¡æ¯æˆ–ä¸€èˆ¬åœ°å€ä¿¡æ¯åšåœ°å€ç»“æ„åŒ–æŠ½å–ï¼Œå¹¶è¾“å‡ºè¯¥åœ°å€æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„æ ‡å‡†åŒ–åœ°å€ã€‚</p><h2 id="äºŒã€ç®—æ³•æ¨¡å—"><a href="#äºŒã€ç®—æ³•æ¨¡å—" class="headerlink" title="äºŒã€ç®—æ³•æ¨¡å—"></a>äºŒã€ç®—æ³•æ¨¡å—</h2><p>ç®—æ³•ç”±ä»¥ä¸‹ä¸åŒæ¨¡å—å…±åŒç»„æˆï¼Œå„æ¨¡å—åœ¨ç®—æ³•çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸèµ·åˆ°é‡è¦ä½œç”¨ï¼š</p><h3 id="1ã€å»ºç«‹åŸå§‹åœ°å€åº“"><a href="#1ã€å»ºç«‹åŸå§‹åœ°å€åº“" class="headerlink" title="1ã€å»ºç«‹åŸå§‹åœ°å€åº“"></a>1ã€å»ºç«‹åŸå§‹åœ°å€åº“</h3><p>ä½¿ç”¨postgresæ•°æ®åº“ï¼ˆä»¥ä¸‹ç®€pgï¼‰åˆ›å»ºå­˜å‚¨å…¨å›½å„çº§åŸå§‹åœ°å€çš„åŸå§‹åœ°å€åº“ã€‚é€šè¿‡ç½‘ç»œçˆ¬è™«ä¸æ–­é‡‡é›†å’Œæ›´æ–°åœ°å€æ•°æ®ï¼ˆä¸»è¦æ¥æºä¸ºé«˜å¾·åœ°å›¾ï¼‰ï¼Œå¹¶å­˜å‚¨åˆ°åŸå§‹åœ°å€åº“ï¼Œåœ°å€åº“åŒ…æ‹¬åœ°å€çš„åç§°ä¿¡æ¯ã€poiä¿¡æ¯ã€ç±»åˆ«ä¿¡æ¯ã€ç»çº¬åº¦ä¿¡æ¯ç­‰åŸå§‹å†…å®¹ï¼Œä¸ºåç»­å·¥ä½œçš„å¼€å±•åšæ•°æ®æ”¯æ’‘ã€‚</p><h3 id="2ã€æ–‡æœ¬åœ°å€æŠ½å–"><a href="#2ã€æ–‡æœ¬åœ°å€æŠ½å–" class="headerlink" title="2ã€æ–‡æœ¬åœ°å€æŠ½å–"></a>2ã€æ–‡æœ¬åœ°å€æŠ½å–</h3><p>ä½¿ç”¨UIE(Universal Information Extraction)æ¡†æ¶ï¼Œç»“åˆERNIE3.0æ¨¡å‹ï¼Œä½¿æ¨¡å‹å…·å¤‡ä»æ— ç»“æ„æˆ–åŠç»“æ„çš„æ–‡æœ¬ä¸­æŠ½å–åœ°å€ä¿¡æ¯çš„èƒ½åŠ›ã€‚</p><h3 id="3ã€åœ°å€åˆ†çº§ç®—æ³•"><a href="#3ã€åœ°å€åˆ†çº§ç®—æ³•" class="headerlink" title="3ã€åœ°å€åˆ†çº§ç®—æ³•"></a>3ã€åœ°å€åˆ†çº§ç®—æ³•</h3><h4 id="i-åˆ†çº§æ ‡å‡†"><a href="#i-åˆ†çº§æ ‡å‡†" class="headerlink" title="i)åˆ†çº§æ ‡å‡†"></a>i)åˆ†çº§æ ‡å‡†</h4><p>é¦–å…ˆéœ€è¦ç¡®å®šä¸€å¥—åœ°å€çš„åˆ†çº§æ ‡å‡†ç»†èŠ‚ï¼Œæœ¬ç®—æ³•é‡‡ç”¨çš„åˆ†çº§æ ‡å‡†åŸºäºé˜¿é‡Œã€Šæ–‡åœ°å€è¦ç´ è§£ææ ‡æ³¨è§„èŒƒã€‹ï¼Œå¹¶åšä¸€å®šç¨‹åº¦èŒƒå›´çš„ä¿®æ”¹ï¼Œå°†åœ°å€åˆ†ä¸º18ä¸ªä¸åŒçº§åˆ«ï¼š</p><p>â‘  Provï¼šçœçº§è¡Œæ”¿åŒºåˆ’ï¼Œçœã€è‡ªæ²»åŒºã€ç›´è¾–å¸‚</p><p>â‘¡ Cityï¼šåœ°çº§è¡Œæ”¿åŒºåˆ’ï¼Œåœ°çº§å¸‚ã€åœ°åŒºã€è‡ªæ²»å·ç­‰</p><p>â‘¢ Districtï¼šå¿çº§è¡Œæ”¿åŒºåˆ’ï¼Œå¸‚è¾–åŒºã€å¿çº§å¸‚ã€å¿ç­‰</p><p>â‘£ Devzoneï¼šå¹¿ä¹‰çš„ä¸Šçš„å¼€å‘åŒºï¼ŒåŒ…å«ä¸€èˆ¬æ€§äº§ä¸š å›­åŒºã€åº¦å‡åŒº</p><p>â‘¤ Townï¼šä¹¡çº§è¡Œæ”¿åŒºåˆ’ï¼Œé•‡ã€è¡—é“ã€ä¹¡ç­‰</p><p>â‘¥ Communityï¼šåŒ…å«ç¤¾åŒºã€è¡Œæ”¿æ‘ï¼ˆç”Ÿäº§å¤§é˜Ÿã€æ‘å§”ä¼šï¼‰ï¼Œè‡ªç„¶æ‘</p><p>â‘¦ Village Groupï¼šé™å®š xx ç»„ã€xx é˜Ÿã€xx ç¤¾</p><p>â‘§ Roadï¼šæœ‰æ­£å¼åç§°çš„é“è·¯ï¼ŒåŒ…æ‹¬éš§é“ã€é«˜æ¶ã€è¡—ã€å¼„ã€å··ç­‰ã€‚ æ­¥è¡Œè¡—ã€å•†ä¸šè¡—</p><p>â‘¨ Roadnoï¼šè·¯ç‰Œå·</p><p>â‘© Poiï¼šç›®æ ‡å…´è¶£ç‚¹</p><p>â‘ª Subpoiï¼šç›®æ ‡å…´è¶£ç‚¹çš„å­å…´è¶£ç‚¹</p><p>â‘« Housenoï¼šæ¥¼æ ‹å·ï¼Œå†œæ‘åœ°å€çš„é—¨ç‰Œå·(åŒ…æ‹¬ç±»ä¼¼å—æ¥¼ã€åŒ—æ¥¼ä¸€ç±»çš„æè¿°)</p><p>â‘¬ Cellnoï¼šå•å…ƒå·ï¼ŒåŒ…æ‹¬ç”²ä¹™ä¸™ä¸ç­‰</p><p>â‘­ Floornoï¼šæ¥¼å±‚å·</p><p>â‘® Roomnoï¼šæˆ¿é—´å·</p><p>â‘¯ Assistï¼šå®šä½è¯ï¼ŒåŒ…æ‹¬æ–¹ä½ã€è§£é‡Šæ€§åè¯</p><p>â‘° Intersectionï¼šè·¯æ¡¥äº¤å‰å£ã€äº¤æ±‡å¤„ã€åå­—è·¯å£ç­‰</p><p>â‘± Distanceï¼šè·ç¦»</p><h4 id="ii-ç®—æ³•ç»†èŠ‚"><a href="#ii-ç®—æ³•ç»†èŠ‚" class="headerlink" title="ii)ç®—æ³•ç»†èŠ‚"></a>ii)ç®—æ³•ç»†èŠ‚</h4><p>ä»çˆ¬è™«è·å–çš„åŸå§‹åœ°å€åº“æ„å»ºåœ°å€ç»“æ„åŒ–æ•°æ®é›†ï¼Œå¹¶å¯¹æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†è¿›è¡Œæ•°æ®æ ‡æ³¨ã€‚æ ‡æ³¨æ–¹å¼é‡‡ç”¨B-I-E-O-Säº”ä½åºåˆ—æ ‡æ³¨æ³•ï¼Œè¯¥æ ‡æ³¨æ³•å°†å°½å¯èƒ½çš„ä¿ç•™è¢«æ ‡æ³¨åœ°å€çš„åˆ†çº§ä¿¡æ¯ã€‚</p><p>æ„å»ºåœ°å€åˆ†çº§æ¨¡å‹ã€‚ä½¿ç”¨åŸºäºå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶Transformersæ¶æ„çš„BERTå¤§æ¨¡å‹ä½œä¸ºé¢„è®­ç»ƒæ¨¡å‹ï¼Œå¹¶å°†æ¨¡å‹ç»“åˆCRFã€GRUç®—æ³•ã€‚CRFï¼šå…¨ç§°ä¸ºæ¡ä»¶éšæœºåœºï¼ˆConditional Random Fieldsï¼‰ï¼Œç»“åˆäº†æœ€å¤§ç†µæ¨¡å‹å’Œéšé©¬å°”å¯å¤«æ¨¡å‹çš„ç‰¹ç‚¹ï¼Œæ˜¯ä¸€ç§æ— å‘å›¾æ¨¡å‹ã€‚å®ƒåœ¨åºåˆ—æ ‡æ³¨ä»»åŠ¡å¦‚åˆ†è¯ã€è¯æ€§æ ‡æ³¨å’Œå‘½åå®ä½“è¯†åˆ«ç­‰æ–¹é¢å–å¾—äº†å¾ˆå¥½çš„æ•ˆæœï¼›GRUï¼šå…¨ç§°ä¸ºé—¨æ§å¾ªç¯å•å…ƒï¼ˆGated Recurrent Unitï¼‰ï¼Œæ˜¯ä¸€ç§å¸¸ç”¨äºåºåˆ—æ•°æ®å»ºæ¨¡çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œèƒ½å¤Ÿå¾ˆå¥½è§£å†³BERTå¾ªç¯ç¥ç»ç½‘ç»œä¸­çš„é•¿æœŸä¾èµ–é—®é¢˜ï¼Œæ•è·åºåˆ—ä¸­çš„é•¿æœŸç‰¹å¾ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸ï¼Œä½¿å®Œæˆçš„æ¨¡å‹ç»“æ„å…·æœ‰æ›´ä¼˜ç§€çš„æ³›åŒ–èƒ½åŠ›ã€æ›´å¥½åœ°æ‹ŸåˆçœŸå®åœ°å€æ•°æ®ã€‚</p><p><img src="/2024/04/05/Bert-GRUåœ°å€å½’ä¸€ç®—æ³•/A.png" alt></p><a id="more"></a><h3 id="4ã€å»ºç«‹æ ‡å‡†åœ°å€åº“"><a href="#4ã€å»ºç«‹æ ‡å‡†åœ°å€åº“" class="headerlink" title="4ã€å»ºç«‹æ ‡å‡†åœ°å€åº“"></a>4ã€å»ºç«‹æ ‡å‡†åœ°å€åº“</h3><p>ä½¿ç”¨pgæ•°æ®åº“å»ºç«‹æ ‡å‡†åœ°å€åº“ï¼Œåœ°å€åº“å°†åŒ…æ‹¬åœ°å€çš„åŸå§‹idã€åç§°ä¿¡æ¯ã€poiä¿¡æ¯ã€ç±»åˆ«ä¿¡æ¯ã€ç»çº¬åº¦ä¿¡æ¯ä»¥åŠ18çº§åˆ†çº§ä¿¡æ¯ã€‚</p><p>é€šè¿‡ä¸Šä¸€æ­¥éª¤è®­ç»ƒå¥½åœ°å€åˆ†çº§æ¨¡å‹ï¼Œå¹¶å°è£…è¿›æ•°æ®è®¡ç®—ä¸­å¿ƒï¼Œä½¿ç”¨GPUå¹¶å‘è®¡ç®—åŸå§‹åœ°å€åº“çš„æ•°æ®ï¼Œå¹¶å°†ç»“æœè¾“å‡ºä¿å­˜è¿›æ ‡å‡†åœ°å€åº“ã€‚</p><h3 id="5ã€åœ°å€æ’åºç®—æ³•"><a href="#5ã€åœ°å€æ’åºç®—æ³•" class="headerlink" title="5ã€åœ°å€æ’åºç®—æ³•"></a>5ã€åœ°å€æ’åºç®—æ³•</h3><p>ä¸»è¦æ˜¯åŸºäºå¸Œå°”æ’åºç®—æ³•æ€æƒ³å°†æ¨¡å—äºŒæŠ½å–åˆ°çš„åœ°å€ä¿¡æ¯è¿›è¡Œæ’åˆ—ç»„åˆï¼Œå»é™¤å™ªå£°ã€è¿‡æ»¤å†—ä½™ç»“æ„ï¼Œæœ€åæ‹Ÿåˆå¾—åˆ°æ•°æ®åº“ä¸­æœ€æ¥è¿‘å½“å‰åœ°å€ä¿¡æ¯çš„æŸ¥è¯¢æ¡ä»¶ã€‚</p><p><img src="/2024/04/05/Bert-GRUåœ°å€å½’ä¸€ç®—æ³•/3.png" alt></p><h3 id="6ã€å»ºç«‹åœ°å€åˆ†çº§åŒ¹é…ç³»ç»Ÿï¼ˆæ£€ç´¢ï¼‰"><a href="#6ã€å»ºç«‹åœ°å€åˆ†çº§åŒ¹é…ç³»ç»Ÿï¼ˆæ£€ç´¢ï¼‰" class="headerlink" title="6ã€å»ºç«‹åœ°å€åˆ†çº§åŒ¹é…ç³»ç»Ÿï¼ˆæ£€ç´¢ï¼‰"></a>6ã€å»ºç«‹åœ°å€åˆ†çº§åŒ¹é…ç³»ç»Ÿï¼ˆæ£€ç´¢ï¼‰</h3><p>é€šè¿‡pgæ•°æ®åº“çš„é«˜æ•ˆæ£€ç´¢åŠŸèƒ½ï¼Œå®ç°å¯¹åœ°å€æ•°æ®çš„å®æ—¶ç»“æ„åŒ–æŸ¥è¯¢å’Œæ•°æ®æ¨é€ï¼Œå®ç°ç®—æ³•å®Œæ•´åŠŸèƒ½ã€‚</p><h2 id="ä¸‰ã€æ¥å£æœåŠ¡"><a href="#ä¸‰ã€æ¥å£æœåŠ¡" class="headerlink" title="ä¸‰ã€æ¥å£æœåŠ¡"></a>ä¸‰ã€æ¥å£æœåŠ¡</h2><p>ç®—æ³•ç›®å‰å¯æä¾›5ç±»æ¥å£ï¼š</p><p>1ã€æ–‡æœ¬åœ°å€è‡ªåŠ¨å½’ä¸€æ¥å£ï¼šæå–æ–‡æœ¬ä¸­çš„æ‰€æœ‰åœ°å€ï¼Œå¹¶æ ‡å‡†åŒ–ï¼›</p><p>2ã€åœ°å€æ£€ç´¢æ¥å£ï¼šè‡ªåŠ¨æ‹†åˆ†ã€æ£€ç´¢ç›¸å…³åœ°å€ï¼›</p><p>3ã€åœ°å€æå–æ¥å£ï¼šä»…æå–æ–‡æœ¬ä¸­æ‰€æœ‰åœ°å€ï¼Œä¸åšæ ‡å‡†åŒ–å¤„ç†ï¼›</p><p>4ã€åœ°ç‚¹æ£€ç´¢æ¥å£ï¼šæ£€ç´¢ç›¸å…³åœ°ç‚¹çš„æ ‡å‡†åœ°å€ï¼›</p><p>5ã€åœ°å€åˆ†çº§æ¥å£ï¼šå¯¹è¾“å…¥åœ°å€è¿›è¡Œå±‚çº§åˆ’åˆ†ã€‚</p><h2 id="å››ã€æ¨¡å‹æ›´æ–°-amp-æ•°æ®è¿ç»´"><a href="#å››ã€æ¨¡å‹æ›´æ–°-amp-æ•°æ®è¿ç»´" class="headerlink" title="å››ã€æ¨¡å‹æ›´æ–° &amp; æ•°æ®è¿ç»´"></a>å››ã€æ¨¡å‹æ›´æ–° &amp; æ•°æ®è¿ç»´</h2><p>å½“å‰ç‰ˆæœ¬æ¨¡å‹çš„æ›´æ–°åŒ…æ‹¬åˆ†çº§æ¨¡å‹çš„æ›´æ–°ï¼ˆå†è®­ç»ƒï¼‰å’Œæ’åºç®—æ³•çš„æ›´æ–°ã€‚æ•°æ®çš„ç»´æŠ¤ä¸»è¦ä»ä¸‰ä¸ªæ–¹é¢è¿›è¡Œï¼š</p><p>1ã€çˆ¬è™«è„šæœ¬çš„å®šæœŸç»´æŠ¤ï¼Œæ›´æ–°åŸå§‹åœ°å€pgæ•°æ®åº“ï¼›</p><p>2ã€ç»´æŒæ ‡å‡†åœ°å€åº“çš„æ•°æ®è®¡ç®—ä¸­å¿ƒä¸çˆ¬è™«åŒæ­¥è¿è½¬ï¼›</p><p>3ã€å¯¹æ ‡å‡†åœ°å€åº“ä¸­çš„é”™è¯¯ä¿¡æ¯åšæå–ï¼Œæ·»åŠ è¿›è®­ç»ƒé›†ã€‚</p><h2 id="äº”ã€æœºå™¨é…ç½®"><a href="#äº”ã€æœºå™¨é…ç½®" class="headerlink" title="äº”ã€æœºå™¨é…ç½®"></a>äº”ã€æœºå™¨é…ç½®</h2><p>ç®—æ³•å’Œæ¨¡å‹çš„å„ä¸ªæ¨¡å—ä½¿ç”¨pythonè¯­è¨€ç¼–å†™ï¼Œåœ¨linuxæœåŠ¡å™¨ä¸Šè¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•ï¼Œå¹¶ä½¿ç”¨åŸºäºNVIDIA CUDAç”Ÿæ€çš„Torchæ¡†æ¶è¿›è¡Œç§‘å­¦è®¡ç®—ã€‚</p><p>ç›®å‰æ»¡è¶³æ¨¡å‹å„åŠŸèƒ½æ­£å¸¸å¿«é€Ÿè¿è½¬å ç”¨çš„æ˜¾å­˜ç†è®ºä¸Šä¸ä½äº5GBï¼Œæ˜¾å¡æ˜¾å­˜ä¸ä½äº8GBã€‚</p><h2 id="å…­ã€é—®é¢˜"><a href="#å…­ã€é—®é¢˜" class="headerlink" title="å…­ã€é—®é¢˜"></a>å…­ã€é—®é¢˜</h2><p>ç›®å‰æ¨¡å‹ç‰ˆæœ¬å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š</p><p>1ã€B-I-E-O-Såºåˆ—æ ‡æ³¨æ³•æ•°æ®æ ‡æ³¨è¿‡ç¨‹å¤æ‚ï¼Œä¸”å¯¹æ•°æ®é›†çš„ç²¾åº¦è¦æ±‚è¾ƒé«˜ï¼›</p><p>2ã€éƒ¨åˆ†å¤æ‚ç»“æ„åœ°å€æ ·æœ¬æš‚ä¸å……è¶³ï¼›</p><p>3ã€çˆ¬è™«æ¨¡å—éœ€è¦è´¦å·æ”¯æ’‘æ­£å¸¸è¿è¡Œï¼Œçˆ¬è™«ç›®å‰é€’å½’ç®—æ³•ï¼ˆDFSï¼‰ï¼Œå¯èƒ½å­˜åœ¨é—æ¼æƒ…å†µï¼›</p><p>4ã€å…¨å›½åœ°å€æ›´æ–°è¾ƒä¸ºé¢‘ç¹ï¼Œéœ€è¦ä»çˆ¬è™«å’Œæ•°æ®è®¡ç®—ä¸­å¿ƒä¸¤ä¸ªå±‚é¢åˆ†åˆ«è§£å†³æ•°æ®æ›´æ–°çš„é—®é¢˜ï¼›</p><p>5ã€ç›®å‰ä½¿ç”¨pgæ¨¡ç³Šæ£€ç´¢ä¸æ”¯æŒå­—æ®µç´¢å¼•ï¼Œéšæ•°æ®é‡æŒ‡æ•°ä¸Šå‡å¯èƒ½å­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œæš‚æœªéªŒè¯ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€-ç®—æ³•ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ä¸€ã€-ç®—æ³•ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ ç®—æ³•ç®€ä»‹&quot;&gt;&lt;/a&gt;ä¸€ã€ ç®—æ³•ç®€ä»‹&lt;/h2&gt;&lt;p&gt;æœ¬åœ°å€å½’ä¸€ç®—æ³•ï¼ˆå·²ç»ä¸‹ç®€ç§°ç®—æ³•ï¼‰æ—¨åœ¨å¯¹è¾“å…¥æ–‡æœ¬ä¸­å‡ºç°çš„åœ°å€ä¿¡æ¯æˆ–ä¸€èˆ¬åœ°å€ä¿¡æ¯åšåœ°å€ç»“æ„åŒ–æŠ½å–ï¼Œå¹¶è¾“å‡ºè¯¥åœ°å€æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„æ ‡å‡†åŒ–åœ°å€ã€‚&lt;/p&gt;
&lt;h2 id=&quot;äºŒã€ç®—æ³•æ¨¡å—&quot;&gt;&lt;a href=&quot;#äºŒã€ç®—æ³•æ¨¡å—&quot; class=&quot;headerlink&quot; title=&quot;äºŒã€ç®—æ³•æ¨¡å—&quot;&gt;&lt;/a&gt;äºŒã€ç®—æ³•æ¨¡å—&lt;/h2&gt;&lt;p&gt;ç®—æ³•ç”±ä»¥ä¸‹ä¸åŒæ¨¡å—å…±åŒç»„æˆï¼Œå„æ¨¡å—åœ¨ç®—æ³•çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸèµ·åˆ°é‡è¦ä½œç”¨ï¼š&lt;/p&gt;
&lt;h3 id=&quot;1ã€å»ºç«‹åŸå§‹åœ°å€åº“&quot;&gt;&lt;a href=&quot;#1ã€å»ºç«‹åŸå§‹åœ°å€åº“&quot; class=&quot;headerlink&quot; title=&quot;1ã€å»ºç«‹åŸå§‹åœ°å€åº“&quot;&gt;&lt;/a&gt;1ã€å»ºç«‹åŸå§‹åœ°å€åº“&lt;/h3&gt;&lt;p&gt;ä½¿ç”¨postgresæ•°æ®åº“ï¼ˆä»¥ä¸‹ç®€pgï¼‰åˆ›å»ºå­˜å‚¨å…¨å›½å„çº§åŸå§‹åœ°å€çš„åŸå§‹åœ°å€åº“ã€‚é€šè¿‡ç½‘ç»œçˆ¬è™«ä¸æ–­é‡‡é›†å’Œæ›´æ–°åœ°å€æ•°æ®ï¼ˆä¸»è¦æ¥æºä¸ºé«˜å¾·åœ°å›¾ï¼‰ï¼Œå¹¶å­˜å‚¨åˆ°åŸå§‹åœ°å€åº“ï¼Œåœ°å€åº“åŒ…æ‹¬åœ°å€çš„åç§°ä¿¡æ¯ã€poiä¿¡æ¯ã€ç±»åˆ«ä¿¡æ¯ã€ç»çº¬åº¦ä¿¡æ¯ç­‰åŸå§‹å†…å®¹ï¼Œä¸ºåç»­å·¥ä½œçš„å¼€å±•åšæ•°æ®æ”¯æ’‘ã€‚&lt;/p&gt;
&lt;h3 id=&quot;2ã€æ–‡æœ¬åœ°å€æŠ½å–&quot;&gt;&lt;a href=&quot;#2ã€æ–‡æœ¬åœ°å€æŠ½å–&quot; class=&quot;headerlink&quot; title=&quot;2ã€æ–‡æœ¬åœ°å€æŠ½å–&quot;&gt;&lt;/a&gt;2ã€æ–‡æœ¬åœ°å€æŠ½å–&lt;/h3&gt;&lt;p&gt;ä½¿ç”¨UIE(Universal Information Extraction)æ¡†æ¶ï¼Œç»“åˆERNIE3.0æ¨¡å‹ï¼Œä½¿æ¨¡å‹å…·å¤‡ä»æ— ç»“æ„æˆ–åŠç»“æ„çš„æ–‡æœ¬ä¸­æŠ½å–åœ°å€ä¿¡æ¯çš„èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;h3 id=&quot;3ã€åœ°å€åˆ†çº§ç®—æ³•&quot;&gt;&lt;a href=&quot;#3ã€åœ°å€åˆ†çº§ç®—æ³•&quot; class=&quot;headerlink&quot; title=&quot;3ã€åœ°å€åˆ†çº§ç®—æ³•&quot;&gt;&lt;/a&gt;3ã€åœ°å€åˆ†çº§ç®—æ³•&lt;/h3&gt;&lt;h4 id=&quot;i-åˆ†çº§æ ‡å‡†&quot;&gt;&lt;a href=&quot;#i-åˆ†çº§æ ‡å‡†&quot; class=&quot;headerlink&quot; title=&quot;i)åˆ†çº§æ ‡å‡†&quot;&gt;&lt;/a&gt;i)åˆ†çº§æ ‡å‡†&lt;/h4&gt;&lt;p&gt;é¦–å…ˆéœ€è¦ç¡®å®šä¸€å¥—åœ°å€çš„åˆ†çº§æ ‡å‡†ç»†èŠ‚ï¼Œæœ¬ç®—æ³•é‡‡ç”¨çš„åˆ†çº§æ ‡å‡†åŸºäºé˜¿é‡Œã€Šæ–‡åœ°å€è¦ç´ è§£ææ ‡æ³¨è§„èŒƒã€‹ï¼Œå¹¶åšä¸€å®šç¨‹åº¦èŒƒå›´çš„ä¿®æ”¹ï¼Œå°†åœ°å€åˆ†ä¸º18ä¸ªä¸åŒçº§åˆ«ï¼š&lt;/p&gt;
&lt;p&gt;â‘  Provï¼šçœçº§è¡Œæ”¿åŒºåˆ’ï¼Œçœã€è‡ªæ²»åŒºã€ç›´è¾–å¸‚&lt;/p&gt;
&lt;p&gt;â‘¡ Cityï¼šåœ°çº§è¡Œæ”¿åŒºåˆ’ï¼Œåœ°çº§å¸‚ã€åœ°åŒºã€è‡ªæ²»å·ç­‰&lt;/p&gt;
&lt;p&gt;â‘¢ Districtï¼šå¿çº§è¡Œæ”¿åŒºåˆ’ï¼Œå¸‚è¾–åŒºã€å¿çº§å¸‚ã€å¿ç­‰&lt;/p&gt;
&lt;p&gt;â‘£ Devzoneï¼šå¹¿ä¹‰çš„ä¸Šçš„å¼€å‘åŒºï¼ŒåŒ…å«ä¸€èˆ¬æ€§äº§ä¸š å›­åŒºã€åº¦å‡åŒº&lt;/p&gt;
&lt;p&gt;â‘¤ Townï¼šä¹¡çº§è¡Œæ”¿åŒºåˆ’ï¼Œé•‡ã€è¡—é“ã€ä¹¡ç­‰&lt;/p&gt;
&lt;p&gt;â‘¥ Communityï¼šåŒ…å«ç¤¾åŒºã€è¡Œæ”¿æ‘ï¼ˆç”Ÿäº§å¤§é˜Ÿã€æ‘å§”ä¼šï¼‰ï¼Œè‡ªç„¶æ‘&lt;/p&gt;
&lt;p&gt;â‘¦ Village Groupï¼šé™å®š xx ç»„ã€xx é˜Ÿã€xx ç¤¾&lt;/p&gt;
&lt;p&gt;â‘§ Roadï¼šæœ‰æ­£å¼åç§°çš„é“è·¯ï¼ŒåŒ…æ‹¬éš§é“ã€é«˜æ¶ã€è¡—ã€å¼„ã€å··ç­‰ã€‚ æ­¥è¡Œè¡—ã€å•†ä¸šè¡—&lt;/p&gt;
&lt;p&gt;â‘¨ Roadnoï¼šè·¯ç‰Œå·&lt;/p&gt;
&lt;p&gt;â‘© Poiï¼šç›®æ ‡å…´è¶£ç‚¹&lt;/p&gt;
&lt;p&gt;â‘ª Subpoiï¼šç›®æ ‡å…´è¶£ç‚¹çš„å­å…´è¶£ç‚¹&lt;/p&gt;
&lt;p&gt;â‘« Housenoï¼šæ¥¼æ ‹å·ï¼Œå†œæ‘åœ°å€çš„é—¨ç‰Œå·(åŒ…æ‹¬ç±»ä¼¼å—æ¥¼ã€åŒ—æ¥¼ä¸€ç±»çš„æè¿°)&lt;/p&gt;
&lt;p&gt;â‘¬ Cellnoï¼šå•å…ƒå·ï¼ŒåŒ…æ‹¬ç”²ä¹™ä¸™ä¸ç­‰&lt;/p&gt;
&lt;p&gt;â‘­ Floornoï¼šæ¥¼å±‚å·&lt;/p&gt;
&lt;p&gt;â‘® Roomnoï¼šæˆ¿é—´å·&lt;/p&gt;
&lt;p&gt;â‘¯ Assistï¼šå®šä½è¯ï¼ŒåŒ…æ‹¬æ–¹ä½ã€è§£é‡Šæ€§åè¯&lt;/p&gt;
&lt;p&gt;â‘° Intersectionï¼šè·¯æ¡¥äº¤å‰å£ã€äº¤æ±‡å¤„ã€åå­—è·¯å£ç­‰&lt;/p&gt;
&lt;p&gt;â‘± Distanceï¼šè·ç¦»&lt;/p&gt;
&lt;h4 id=&quot;ii-ç®—æ³•ç»†èŠ‚&quot;&gt;&lt;a href=&quot;#ii-ç®—æ³•ç»†èŠ‚&quot; class=&quot;headerlink&quot; title=&quot;ii)ç®—æ³•ç»†èŠ‚&quot;&gt;&lt;/a&gt;ii)ç®—æ³•ç»†èŠ‚&lt;/h4&gt;&lt;p&gt;ä»çˆ¬è™«è·å–çš„åŸå§‹åœ°å€åº“æ„å»ºåœ°å€ç»“æ„åŒ–æ•°æ®é›†ï¼Œå¹¶å¯¹æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†è¿›è¡Œæ•°æ®æ ‡æ³¨ã€‚æ ‡æ³¨æ–¹å¼é‡‡ç”¨B-I-E-O-Säº”ä½åºåˆ—æ ‡æ³¨æ³•ï¼Œè¯¥æ ‡æ³¨æ³•å°†å°½å¯èƒ½çš„ä¿ç•™è¢«æ ‡æ³¨åœ°å€çš„åˆ†çº§ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;p&gt;æ„å»ºåœ°å€åˆ†çº§æ¨¡å‹ã€‚ä½¿ç”¨åŸºäºå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶Transformersæ¶æ„çš„BERTå¤§æ¨¡å‹ä½œä¸ºé¢„è®­ç»ƒæ¨¡å‹ï¼Œå¹¶å°†æ¨¡å‹ç»“åˆCRFã€GRUç®—æ³•ã€‚CRFï¼šå…¨ç§°ä¸ºæ¡ä»¶éšæœºåœºï¼ˆConditional Random Fieldsï¼‰ï¼Œç»“åˆäº†æœ€å¤§ç†µæ¨¡å‹å’Œéšé©¬å°”å¯å¤«æ¨¡å‹çš„ç‰¹ç‚¹ï¼Œæ˜¯ä¸€ç§æ— å‘å›¾æ¨¡å‹ã€‚å®ƒåœ¨åºåˆ—æ ‡æ³¨ä»»åŠ¡å¦‚åˆ†è¯ã€è¯æ€§æ ‡æ³¨å’Œå‘½åå®ä½“è¯†åˆ«ç­‰æ–¹é¢å–å¾—äº†å¾ˆå¥½çš„æ•ˆæœï¼›GRUï¼šå…¨ç§°ä¸ºé—¨æ§å¾ªç¯å•å…ƒï¼ˆGated Recurrent Unitï¼‰ï¼Œæ˜¯ä¸€ç§å¸¸ç”¨äºåºåˆ—æ•°æ®å»ºæ¨¡çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œèƒ½å¤Ÿå¾ˆå¥½è§£å†³BERTå¾ªç¯ç¥ç»ç½‘ç»œä¸­çš„é•¿æœŸä¾èµ–é—®é¢˜ï¼Œæ•è·åºåˆ—ä¸­çš„é•¿æœŸç‰¹å¾ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸ï¼Œä½¿å®Œæˆçš„æ¨¡å‹ç»“æ„å…·æœ‰æ›´ä¼˜ç§€çš„æ³›åŒ–èƒ½åŠ›ã€æ›´å¥½åœ°æ‹ŸåˆçœŸå®åœ°å€æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/04/05/Bert-GRUåœ°å€å½’ä¸€ç®—æ³•/A.png&quot; alt&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="åœ°å€å½’ä¸€" scheme="http://yoursite.com/categories/åœ°å€å½’ä¸€/"/>
    
    
    <category term="BERT" scheme="http://yoursite.com/tags/BERT/"/>
    
    <category term="GRU" scheme="http://yoursite.com/tags/GRU/"/>
    
  </entry>
  
  <entry>
    <title>RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º</title>
    <link href="http://yoursite.com/2024/03/07/RTSP%E6%8E%A8%E6%8B%89%E6%B5%81%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/"/>
    <id>http://yoursite.com/2024/03/07/RTSP%E6%8E%A8%E6%8B%89%E6%B5%81%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/</id>
    <published>2024-03-07T02:02:13.000Z</published>
    <updated>2024-07-08T07:14:12.066Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰"><a href="#ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰" class="headerlink" title="ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰"></a>ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰</h2><h3 id="1-ä¸‹è½½RTSPæœåŠ¡å™¨"><a href="#1-ä¸‹è½½RTSPæœåŠ¡å™¨" class="headerlink" title="1.ä¸‹è½½RTSPæœåŠ¡å™¨"></a>1.ä¸‹è½½RTSPæœåŠ¡å™¨</h3><p>ä¸‹è½½é“¾æ¥ï¼š<a href="https://github.com/aler9/rtsp-simple-server/releases" target="_blank" rel="noopener">https://github.com/aler9/rtsp-simple-server/releases</a></p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/1.png" alt></p><h3 id="2-ä¸‹è½½FFmpegå·¥å…·"><a href="#2-ä¸‹è½½FFmpegå·¥å…·" class="headerlink" title="2.ä¸‹è½½FFmpegå·¥å…·"></a>2.ä¸‹è½½FFmpegå·¥å…·</h3><p>ä¸‹è½½é“¾æ¥ï¼š<a href="https://github.com/BtbN/FFmpeg-Builds/releases" target="_blank" rel="noopener">https://github.com/BtbN/FFmpeg-Builds/releases</a></p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/2.png" alt></p><h3 id="3-å¯åŠ¨æœåŠ¡å™¨"><a href="#3-å¯åŠ¨æœåŠ¡å™¨" class="headerlink" title="3.å¯åŠ¨æœåŠ¡å™¨"></a>3.å¯åŠ¨æœåŠ¡å™¨</h3><p>è¿›å…¥RTSPæœåŠ¡å™¨è·¯å¾„ï¼Œæ§åˆ¶å°æ‰§è¡Œ<code>.\mediamtx.exe</code></p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/3.png" alt></p><a id="more"></a><h3 id="4-å¯åŠ¨æ¨æµæœåŠ¡"><a href="#4-å¯åŠ¨æ¨æµæœåŠ¡" class="headerlink" title="4.å¯åŠ¨æ¨æµæœåŠ¡"></a>4.å¯åŠ¨æ¨æµæœåŠ¡</h3><p>è¿›å…¥FFmpegæœåŠ¡å™¨è·¯å¾„ï¼Œæ§åˆ¶å°æ‰§è¡Œ<code>ffmpeg -re -stream_loop -1 -i belt.mp4 -c copy -f rtsp rtsp://127.0.0.1:8554/video</code>ï¼Œå¾ªç¯æ’­æ”¾è§†é¢‘æ–‡ä»¶å¹¶è¿›è¡Œæ¨æµ</p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/4.png" alt></p><h3 id="5-æ’­æ”¾æµåª’ä½“"><a href="#5-æ’­æ”¾æµåª’ä½“" class="headerlink" title="5.æ’­æ”¾æµåª’ä½“"></a>5.æ’­æ”¾æµåª’ä½“</h3><p>å¯åŠ¨VLCæ’­æ”¾å™¨</p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/5.png" alt></p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/6.png" alt></p><h2 id="äºŒã€opencv-python-å®ç°RTSPæ¨æ‹‰æµ"><a href="#äºŒã€opencv-python-å®ç°RTSPæ¨æ‹‰æµ" class="headerlink" title="äºŒã€opencv+python å®ç°RTSPæ¨æ‹‰æµ"></a>äºŒã€opencv+python å®ç°RTSPæ¨æ‹‰æµ</h2><h3 id="1-æ‹‰æµ"><a href="#1-æ‹‰æµ" class="headerlink" title="1.æ‹‰æµ"></a>1.æ‹‰æµ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">capturevideo</span><span class="params">(capture, framequeue)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> framequeue.full():</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret, frame = capture.read()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            image_bgr = frame</span><br><span class="line">            framequeue.put(image_bgr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_rtsp</span><span class="params">(rtsp_src)</span>:</span></span><br><span class="line">    capture = cv2.VideoCapture(rtsp_src)</span><br><span class="line">    framequeue = queue.Queue(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    thread = threading.Thread(</span><br><span class="line">        target=capturevideo, args=(capture, framequeue))</span><br><span class="line">    thread.start()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    width = int(capture.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">    height = int(capture.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">    fps = int(capture.get(cv2.CAP_PROP_FPS))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> framequeue.empty():</span><br><span class="line">            frame_bgr = framequeue.get()</span><br><span class="line">            cv2.imshow(<span class="string">"image"</span>, frame_bgr)  <span class="comment"># æ˜¾ç¤ºå›¾åƒ</span></span><br><span class="line">            cv2.waitKey(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rtsp_url = <span class="string">'rtsp://192.168.9.164:8554/video'</span></span><br><span class="line">    execute_rtsp(rtsp_url)</span><br></pre></td></tr></table></figure><h3 id="2-æ‹‰æµ-æ¨æµ"><a href="#2-æ‹‰æµ-æ¨æµ" class="headerlink" title="2.æ‹‰æµ+æ¨æµ"></a>2.æ‹‰æµ+æ¨æµ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">capturevideo</span><span class="params">(capture, framequeue)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> framequeue.full():</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret, frame = capture.read()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            image_bgr = frame</span><br><span class="line">            framequeue.put(image_bgr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_rtsp</span><span class="params">(rtsp_src, rtsp_dst)</span>:</span></span><br><span class="line">    capture = cv2.VideoCapture(rtsp_src)</span><br><span class="line">    framequeue = queue.Queue(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    thread = threading.Thread(</span><br><span class="line">        target=capturevideo, args=(capture, framequeue))</span><br><span class="line">    thread.start()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    width = int(capture.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">    height = int(capture.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">    fps = int(capture.get(cv2.CAP_PROP_FPS))</span><br><span class="line">    command = [<span class="string">'ffmpeg'</span>,</span><br><span class="line">               <span class="string">'-y'</span>,</span><br><span class="line">               <span class="string">'-f'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">               <span class="string">'-vcodec'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">               <span class="string">'-pix_fmt'</span>, <span class="string">'bgr24'</span>,</span><br><span class="line">               <span class="string">'-s'</span>, <span class="string">"&#123;&#125;x&#123;&#125;"</span>.format(width, height),</span><br><span class="line">               <span class="string">'-r'</span>, str(fps),</span><br><span class="line">               <span class="string">'-i'</span>, <span class="string">'-'</span>,</span><br><span class="line">               <span class="string">'-c:v'</span>, <span class="string">'libx264'</span>,</span><br><span class="line">               <span class="string">'-pix_fmt'</span>, <span class="string">'yuv420p'</span>,</span><br><span class="line">               <span class="string">'-preset'</span>, <span class="string">'ultrafast'</span>,</span><br><span class="line">               <span class="string">'-f'</span>, <span class="string">'rtsp'</span>,</span><br><span class="line">               rtsp_dst]</span><br><span class="line">    pipe = sp.Popen(command, stdin=sp.PIPE)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> framequeue.empty():</span><br><span class="line">            frame_bgr = framequeue.get()</span><br><span class="line">            pipe.stdin.write(frame_bgr.tostring())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rtsp_url = <span class="string">'rtsp://192.168.9.164:8554/video'</span></span><br><span class="line">    rtsp_stream = <span class="string">'rtsp://192.168.9.164:8554/live'</span></span><br><span class="line">    execute_rtsp(rtsp_url, rtsp_stream)</span><br></pre></td></tr></table></figure><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/7.png" alt></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè§†é¢‘ç æµå·²æ¨é€åˆ°8554/liveåœ°å€ä¸‹</p><h2 id="ä¸‰ã€è§†é¢‘å¤„ç†ï¼Œæ¨æµ"><a href="#ä¸‰ã€è§†é¢‘å¤„ç†ï¼Œæ¨æµ" class="headerlink" title="ä¸‰ã€è§†é¢‘å¤„ç†ï¼Œæ¨æµ"></a>ä¸‰ã€è§†é¢‘å¤„ç†ï¼Œæ¨æµ</h2><h3 id="1-å¤šçº¿ç¨‹å¤„ç†è§†é¢‘å¸§"><a href="#1-å¤šçº¿ç¨‹å¤„ç†è§†é¢‘å¸§" class="headerlink" title="1.å¤šçº¿ç¨‹å¤„ç†è§†é¢‘å¸§"></a>1.å¤šçº¿ç¨‹å¤„ç†è§†é¢‘å¸§</h3><p>ä¸»å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">from</span> visualize.detection <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">capturevideo</span><span class="params">(capture, framequeue)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> frame_id</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> framequeue.full():</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret, frame = capture.read()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            image_bgr = frame</span><br><span class="line">            frame_id += <span class="number">1</span></span><br><span class="line">            framequeue.put((image_bgr, frame_id))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_rtsp</span><span class="params">(rtsp_src, rtsp_dst)</span>:</span></span><br><span class="line">    capture = cv2.VideoCapture(rtsp_src)</span><br><span class="line">    framequeue = queue.Queue(<span class="number">10</span>)</span><br><span class="line">    outputqueue = queue.Queue(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    thread = threading.Thread(</span><br><span class="line">        target=capturevideo, args=(capture, framequeue))</span><br><span class="line">    thread.start()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    width = int(capture.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">    height = int(capture.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">    fps = int(capture.get(cv2.CAP_PROP_FPS))</span><br><span class="line">    command = [<span class="string">'ffmpeg'</span>,</span><br><span class="line">               <span class="string">'-y'</span>,</span><br><span class="line">               <span class="string">'-f'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">               <span class="string">'-vcodec'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">               <span class="string">'-pix_fmt'</span>, <span class="string">'bgr24'</span>,</span><br><span class="line">               <span class="string">'-s'</span>, <span class="string">"&#123;&#125;x&#123;&#125;"</span>.format(width, height),</span><br><span class="line">               <span class="string">'-r'</span>, str(fps),</span><br><span class="line">               <span class="string">'-i'</span>, <span class="string">'-'</span>,</span><br><span class="line">               <span class="string">'-c:v'</span>, <span class="string">'libx264'</span>,</span><br><span class="line">               <span class="string">'-pix_fmt'</span>, <span class="string">'yuv420p'</span>,</span><br><span class="line">               <span class="string">'-preset'</span>, <span class="string">'ultrafast'</span>,</span><br><span class="line">               <span class="string">'-f'</span>, <span class="string">'rtsp'</span>,</span><br><span class="line">               rtsp_dst]</span><br><span class="line">    pipe = sp.Popen(command, stdin=sp.PIPE)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        t = threading.Thread(target=process, args=(framequeue, outputqueue, pipe))</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(framequeue, outputqueue, pipe)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> queue_id</span><br><span class="line">    model = YOLO(<span class="string">'runs/detect/helmet_model/weights/best.pt'</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> framequeue.empty():</span><br><span class="line">            frame_bgr, frame_uid = framequeue.get()</span><br><span class="line">            results = model.predict(</span><br><span class="line">                frame_bgr,</span><br><span class="line">                stream=<span class="literal">False</span>,</span><br><span class="line">                save=<span class="literal">False</span>,</span><br><span class="line">                classes=[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>],</span><br><span class="line">                device=[<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">                verbose=<span class="literal">False</span>,</span><br><span class="line">            )</span><br><span class="line">            names = results[<span class="number">0</span>].names</span><br><span class="line">            clses = [int(i) <span class="keyword">for</span> i <span class="keyword">in</span> results[<span class="number">0</span>].boxes.cls.tolist()]</span><br><span class="line">            boxes = results[<span class="number">0</span>].boxes.xyxy.tolist()</span><br><span class="line">            name_set = [names.get(i) <span class="keyword">for</span> i <span class="keyword">in</span> clses]</span><br><span class="line"></span><br><span class="line">            frame_bgr = visualize_det(frame_bgr, boxes, name_set)</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                time.sleep(<span class="number">0.0001</span>)</span><br><span class="line">                <span class="keyword">if</span> queue_id+<span class="number">1</span> == frame_uid:</span><br><span class="line">                    outputqueue.put(frame_bgr)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            frame = outputqueue.get()</span><br><span class="line">            pipe.stdin.write(frame.tostring())</span><br><span class="line">            queue_id += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    frame_id = <span class="number">0</span></span><br><span class="line">    queue_id = <span class="number">0</span></span><br><span class="line">    rtsp_url = <span class="string">'rtsp://192.168.9.164:8554/video'</span></span><br><span class="line">    rtsp_stream = <span class="string">'rtsp://192.168.9.164:8554/live'</span></span><br><span class="line">    execute_rtsp(rtsp_url, rtsp_stream)</span><br></pre></td></tr></table></figure><p>å¯è§†åŒ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFile, ImageFont</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> PR</span><br><span class="line"></span><br><span class="line">font_file = os.path.join(PR, <span class="string">'visualize/SourceHanSansCN-Medium.otf'</span>)</span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visualize_det</span><span class="params">(im, boxes, names)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(im, str):</span><br><span class="line">        im = Image.open(im)</span><br><span class="line">        im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">        im = cv2.cvtColor(im, cv2.COLOR_RGB2BGR)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        im = np.ascontiguousarray(np.copy(im))</span><br><span class="line"></span><br><span class="line">    im = Image.fromarray(im)</span><br><span class="line">    im = im.convert(<span class="string">'RGBA'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, name <span class="keyword">in</span> enumerate(names):</span><br><span class="line">        box = boxes[i]</span><br><span class="line">        box = [int(j) <span class="keyword">for</span> j <span class="keyword">in</span> box]</span><br><span class="line">        text = name</span><br><span class="line"></span><br><span class="line">        draw = ImageDraw.Draw(im)</span><br><span class="line">        draw.text(</span><br><span class="line">            (box[<span class="number">0</span>], box[<span class="number">1</span>]),</span><br><span class="line">            text,</span><br><span class="line">            font=ImageFont.truetype(font_file, size=<span class="number">20</span>),</span><br><span class="line">            fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>))</span><br><span class="line">        draw.rectangle(</span><br><span class="line">            ((box[<span class="number">0</span>], box[<span class="number">1</span>]), (box[<span class="number">2</span>], box[<span class="number">3</span>])),</span><br><span class="line">            fill=<span class="literal">None</span>,</span><br><span class="line">            outline=(<span class="number">139</span>, <span class="number">0</span>, <span class="number">139</span>),</span><br><span class="line">            width=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    im = im.convert(<span class="string">'RGB'</span>)</span><br><span class="line">    im = np.ascontiguousarray(np.copy(im))</span><br><span class="line">    <span class="keyword">return</span> im</span><br></pre></td></tr></table></figure><h3 id="2-å¤šçº¿ç¨‹å°è£…"><a href="#2-å¤šçº¿ç¨‹å°è£…" class="headerlink" title="2.å¤šçº¿ç¨‹å°è£…"></a>2.å¤šçº¿ç¨‹å°è£…</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">from</span> visualize.detection <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamingDetectionServer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, stream_src, stream_dst)</span>:</span></span><br><span class="line">        self.pipe = <span class="literal">None</span></span><br><span class="line">        self.model = <span class="literal">None</span></span><br><span class="line">        self.capture = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.fps = <span class="number">0</span></span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        self.width = <span class="number">0</span></span><br><span class="line">        self.height = <span class="number">0</span></span><br><span class="line">        self.frame_id = <span class="number">0</span></span><br><span class="line">        self.solve_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self.stream_src = stream_src</span><br><span class="line">        self.stream_dst = stream_dst</span><br><span class="line"></span><br><span class="line">        self.framequeue = queue.PriorityQueue(<span class="number">10</span>)</span><br><span class="line">        self.outputqueue = queue.PriorityQueue()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.capture = cv2.VideoCapture(self.stream_src)</span><br><span class="line">        self.fps = int(self.capture.get(cv2.CAP_PROP_FPS))</span><br><span class="line">        self.width = int(self.capture.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">        self.height = int(self.capture.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line"></span><br><span class="line">        command = [<span class="string">'ffmpeg'</span>,</span><br><span class="line">                   <span class="comment"># '-y',</span></span><br><span class="line">                   <span class="string">'-re'</span>,</span><br><span class="line">                   <span class="string">'-f'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">                   <span class="string">'-vcodec'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">                   <span class="string">'-pix_fmt'</span>, <span class="string">'bgr24'</span>,</span><br><span class="line">                   <span class="string">'-s'</span>, <span class="string">"&#123;&#125;x&#123;&#125;"</span>.format(self.width, self.height),</span><br><span class="line">                   <span class="string">'-r'</span>, str(self.fps),</span><br><span class="line">                   <span class="string">'-i'</span>, <span class="string">'-'</span>,</span><br><span class="line">                   <span class="string">'-c:v'</span>, <span class="string">'libx264'</span>,</span><br><span class="line">                   <span class="string">'-pix_fmt'</span>, <span class="string">'yuv420p'</span>,</span><br><span class="line">                   <span class="string">'-preset'</span>, <span class="string">'ultrafast'</span>,</span><br><span class="line">                   <span class="string">'-f'</span>, <span class="string">'rtsp'</span>,</span><br><span class="line">                   self.stream_dst]</span><br><span class="line">        pipe = sp.Popen(command, stdin=sp.PIPE)</span><br><span class="line"></span><br><span class="line">        capture_thread = threading.Thread(target=self.capture_video)</span><br><span class="line">        capture_thread.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">            process_thread = threading.Thread(target=self.process_video)</span><br><span class="line">            process_thread.start()</span><br><span class="line"></span><br><span class="line">        output_thread = threading.Thread(target=self.output_video, args=(pipe,))</span><br><span class="line">        output_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">capture_video</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> self.framequeue.full():</span><br><span class="line">                time.sleep(<span class="number">0.01</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ret, frame = self.capture.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                image_bgr = frame</span><br><span class="line">                self.frame_id += <span class="number">1</span></span><br><span class="line">                self.framequeue.put((self.frame_id, image_bgr))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output_video</span><span class="params">(self, pipe)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.outputqueue.empty():</span><br><span class="line">                frame_id, frame_bgr = self.outputqueue.get()</span><br><span class="line">                pipe.stdin.write(frame_bgr.tobytes())</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                time.sleep(<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_video</span><span class="params">(self)</span>:</span></span><br><span class="line">        model = YOLO(<span class="string">'runs/detect/helmet_model/weights/best.pt'</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.framequeue.empty():</span><br><span class="line">                <span class="keyword">with</span> lock:</span><br><span class="line">                    frame_id, frame_bgr = self.framequeue.get()</span><br><span class="line">                results = model.track(</span><br><span class="line">                    frame_bgr,</span><br><span class="line">                    stream=<span class="literal">False</span>,</span><br><span class="line">                    save=<span class="literal">False</span>,</span><br><span class="line">                    classes=[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>],</span><br><span class="line">                    device=<span class="string">"0"</span>,</span><br><span class="line">                    verbose=<span class="literal">False</span>,</span><br><span class="line">                    tracker=<span class="string">"bytetrack.yaml"</span></span><br><span class="line">                )</span><br><span class="line">                names = results[<span class="number">0</span>].names</span><br><span class="line">                clses = [int(i) <span class="keyword">for</span> i <span class="keyword">in</span> results[<span class="number">0</span>].boxes.cls.tolist()]</span><br><span class="line">                boxes = results[<span class="number">0</span>].boxes.xyxy.tolist()</span><br><span class="line">                name_set = [names.get(i) <span class="keyword">for</span> i <span class="keyword">in</span> clses]</span><br><span class="line">                frame_bgr = visualize_det_cv2(frame_bgr, boxes, name_set)</span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    time.sleep(<span class="number">0.001</span>)</span><br><span class="line">                    <span class="keyword">if</span> self.solve_id == frame_id:</span><br><span class="line">                        self.outputqueue.put((frame_id, frame_bgr))</span><br><span class="line">                        self.solve_id += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rtsp_url = input(<span class="string">'ç æµé“¾æ¥ï¼š'</span>)</span><br><span class="line">    rtsp_stream = <span class="string">'rtsp://192.168.9.164:8554/live2'</span></span><br><span class="line">    sds = StreamingDetectionServer(rtsp_url, rtsp_stream)</span><br><span class="line">    sds.run()</span><br></pre></td></tr></table></figure><h3 id="3-å¤šè¿›ç¨‹å¤„ç†è§†é¢‘å¸§ï¼ˆä¼˜åŒ–åˆ°æè‡´ï¼Œè¿›ä¸€æ­¥æå‡ç®—æ³•å¤„ç†é€Ÿåº¦ï¼Œåç»­å°†å•ç‹¬å¼€æ¿å—åšå‡ºè¯´æ˜ï¼‰"><a href="#3-å¤šè¿›ç¨‹å¤„ç†è§†é¢‘å¸§ï¼ˆä¼˜åŒ–åˆ°æè‡´ï¼Œè¿›ä¸€æ­¥æå‡ç®—æ³•å¤„ç†é€Ÿåº¦ï¼Œåç»­å°†å•ç‹¬å¼€æ¿å—åšå‡ºè¯´æ˜ï¼‰" class="headerlink" title="3.å¤šè¿›ç¨‹å¤„ç†è§†é¢‘å¸§ï¼ˆä¼˜åŒ–åˆ°æè‡´ï¼Œè¿›ä¸€æ­¥æå‡ç®—æ³•å¤„ç†é€Ÿåº¦ï¼Œåç»­å°†å•ç‹¬å¼€æ¿å—åšå‡ºè¯´æ˜ï¼‰"></a>3.å¤šè¿›ç¨‹å¤„ç†è§†é¢‘å¸§ï¼ˆä¼˜åŒ–åˆ°æè‡´ï¼Œè¿›ä¸€æ­¥æå‡ç®—æ³•å¤„ç†é€Ÿåº¦ï¼Œåç»­å°†å•ç‹¬å¼€æ¿å—åšå‡ºè¯´æ˜ï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">from</span> visualize.detection <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> PriorityQueue</span><br><span class="line"><span class="keyword">from</span> multiprocessing.managers <span class="keyword">import</span> BaseManager</span><br><span class="line"></span><br><span class="line">lock = multiprocessing.Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span><span class="params">(BaseManager)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Manager.register(<span class="string">'get_priorityQueue'</span>, PriorityQueue)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamingDetectionServer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, stream_src, stream_dst)</span>:</span></span><br><span class="line">        self.pipe = <span class="literal">None</span></span><br><span class="line">        self.model = <span class="literal">None</span></span><br><span class="line">        self.capture = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.fps = <span class="number">0</span></span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        self.width = <span class="number">0</span></span><br><span class="line">        self.height = <span class="number">0</span></span><br><span class="line">        self.frame_id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.stream_src = stream_src</span><br><span class="line">        self.stream_dst = stream_dst</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        q = queue.PriorityQueue() <span class="comment"># ç”¨äºå°†å¤šè¿›ç¨‹é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒæ­¥åˆ°çº¿ç¨‹ä¸»çº¿ç¨‹ä¸­çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå®ç°æŒ‰å¸§å‡ºé˜Ÿåˆ—</span></span><br><span class="line">        m = Manager()</span><br><span class="line">        m.start()</span><br><span class="line">        <span class="comment"># framequeue = multiprocessing.Queue(10)</span></span><br><span class="line">        framequeue = torch.multiprocessing.Queue(<span class="number">10</span>)</span><br><span class="line">        outputqueue = multiprocessing.Queue()</span><br><span class="line">        <span class="comment"># outputqueue = m.get_priorityQueue() # ç»§æ‰¿å¤šçº¿ç¨‹ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å¤šè¿›ç¨‹é˜Ÿåˆ—ï¼Œå¤„ç†æ—¶é—´è¿‡é•¿ï¼Œæ”¾å¼ƒ</span></span><br><span class="line">        self.capture = cv2.VideoCapture(self.stream_src)</span><br><span class="line">        self.fps = int(self.capture.get(cv2.CAP_PROP_FPS))</span><br><span class="line">        self.width = int(self.capture.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">        self.height = int(self.capture.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line"></span><br><span class="line">        command = [<span class="string">'ffmpeg'</span>,</span><br><span class="line">                   <span class="comment"># '-y',</span></span><br><span class="line">                   <span class="string">'-re'</span>,</span><br><span class="line">                   <span class="string">'-f'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">                   <span class="string">'-vcodec'</span>, <span class="string">'rawvideo'</span>,</span><br><span class="line">                   <span class="string">'-pix_fmt'</span>, <span class="string">'bgr24'</span>,</span><br><span class="line">                   <span class="string">'-s'</span>, <span class="string">"&#123;&#125;x&#123;&#125;"</span>.format(self.width, self.height),</span><br><span class="line">                   <span class="string">'-r'</span>, str(self.fps),</span><br><span class="line">                   <span class="string">'-i'</span>, <span class="string">'-'</span>,</span><br><span class="line">                   <span class="string">'-c:v'</span>, <span class="string">'libx264'</span>,</span><br><span class="line">                   <span class="string">'-pix_fmt'</span>, <span class="string">'yuv420p'</span>,</span><br><span class="line">                   <span class="string">'-preset'</span>, <span class="string">'ultrafast'</span>,</span><br><span class="line">                   <span class="string">'-f'</span>, <span class="string">'rtsp'</span>,</span><br><span class="line">                   self.stream_dst]</span><br><span class="line">        pipe = sp.Popen(command, stdin=sp.PIPE)</span><br><span class="line"></span><br><span class="line">        solve_id = multiprocessing.Value(<span class="string">'i'</span>, <span class="number">1</span>)  <span class="comment"># ä½¿ç”¨è¿›ç¨‹å…¨å±€å˜é‡è®°å½•å¤„ç†è§†é¢‘å¸§çš„é¡ºåº</span></span><br><span class="line"></span><br><span class="line">        capture_thread = threading.Thread(target=self.capture_video, args=(framequeue,))</span><br><span class="line">        capture_thread.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">            process_thread = multiprocessing.Process(target=self.process_video, args=(framequeue, outputqueue, solve_id))</span><br><span class="line">            process_thread.start()</span><br><span class="line"></span><br><span class="line">        queue_thread = threading.Thread(target=self.make_queue, args=(outputqueue, q))</span><br><span class="line">        queue_thread.start()</span><br><span class="line"></span><br><span class="line">        output_thread = threading.Thread(target=self.output_video, args=(pipe, q))</span><br><span class="line">        output_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ç æµ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">capture_video</span><span class="params">(self, framequeue)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> framequeue.full():</span><br><span class="line">                time.sleep(<span class="number">0.01</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ret, frame = self.capture.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                image_bgr = frame</span><br><span class="line">                image_bgr = torch.from_numpy(image_bgr)</span><br><span class="line">                image_bgr.share_memory_()</span><br><span class="line">                self.frame_id += <span class="number">1</span></span><br><span class="line">                framequeue.put((self.frame_id, image_bgr))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤šè¿›ç¨‹é˜Ÿåˆ—æ•°æ®åŒæ­¥è‡³ä¼˜å…ˆçº§é˜Ÿåˆ—</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_queue</span><span class="params">(outputqueue, q)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> outputqueue.empty():</span><br><span class="line">                frame_id, frame_bgr = outputqueue.get()</span><br><span class="line">                q.put((frame_id, frame_bgr))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                time.sleep(<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»ä¼˜å…ˆçº§é˜Ÿåˆ—æ¨æµ</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output_video</span><span class="params">(pipe, q)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> q.qsize() &gt;= <span class="number">10</span>:</span><br><span class="line">                frame_id, frame_bgr = q.get()</span><br><span class="line">                pipe.stdin.write(frame_bgr.tobytes())</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                time.sleep(<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤šè¿›ç¨‹</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_video</span><span class="params">(framequeue, outputqueue, solve_id)</span>:</span></span><br><span class="line">        model = YOLO(<span class="string">'runs/detect/helmet_model/weights/best.pt'</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> framequeue.empty():</span><br><span class="line">                <span class="keyword">with</span> lock:</span><br><span class="line">                    frame_id, frame_bgr = framequeue.get()</span><br><span class="line">                frame_bgr = frame_bgr.numpy()</span><br><span class="line">                results = model.track(</span><br><span class="line">                    frame_bgr,</span><br><span class="line">                    stream=<span class="literal">False</span>,</span><br><span class="line">                    save=<span class="literal">False</span>,</span><br><span class="line">                    classes=[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>],</span><br><span class="line">                    device=<span class="string">"0"</span>,</span><br><span class="line">                    batch=<span class="number">16</span>,</span><br><span class="line">                    verbose=<span class="literal">False</span>,</span><br><span class="line">                    tracker=<span class="string">"bytetrack.yaml"</span></span><br><span class="line">                )</span><br><span class="line">                names = results[<span class="number">0</span>].names</span><br><span class="line">                clses = [int(i) <span class="keyword">for</span> i <span class="keyword">in</span> results[<span class="number">0</span>].boxes.cls.tolist()]</span><br><span class="line">                boxes = results[<span class="number">0</span>].boxes.xyxy.tolist()</span><br><span class="line">                name_set = [names.get(i) <span class="keyword">for</span> i <span class="keyword">in</span> clses]</span><br><span class="line">                frame_bgr = visualize_det_cv2(frame_bgr, boxes, name_set)</span><br><span class="line">                <span class="comment"># é€šè¿‡å…±äº«å®ç°idå®ç°ä¼˜å…ˆçº§å…¥é˜Ÿ</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    <span class="keyword">if</span> solve_id.value == frame_id:</span><br><span class="line">                        outputqueue.put((frame_id, frame_bgr))</span><br><span class="line">                        solve_id.value += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rtsp_url = input(<span class="string">'ç æµé“¾æ¥ï¼š'</span>)</span><br><span class="line">    rtsp_stream = <span class="string">'rtsp://192.168.9.164:8554/live'</span></span><br><span class="line">    sds = StreamingDetectionServer(rtsp_url, rtsp_stream)</span><br><span class="line">    sds.run()</span><br></pre></td></tr></table></figure><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/8.png" alt></p><p><img src="/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/9.png" alt></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰&quot;&gt;&lt;a href=&quot;#ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰&quot;&gt;&lt;/a&gt;ä¸€ã€åŸºç¡€æœåŠ¡æ­å»ºï¼ˆwindowsï¼‰&lt;/h2&gt;&lt;h3 id=&quot;1-ä¸‹è½½RTSPæœåŠ¡å™¨&quot;&gt;&lt;a href=&quot;#1-ä¸‹è½½RTSPæœåŠ¡å™¨&quot; class=&quot;headerlink&quot; title=&quot;1.ä¸‹è½½RTSPæœåŠ¡å™¨&quot;&gt;&lt;/a&gt;1.ä¸‹è½½RTSPæœåŠ¡å™¨&lt;/h3&gt;&lt;p&gt;ä¸‹è½½é“¾æ¥ï¼š&lt;a href=&quot;https://github.com/aler9/rtsp-simple-server/releases&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/aler9/rtsp-simple-server/releases&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/1.png&quot; alt&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-ä¸‹è½½FFmpegå·¥å…·&quot;&gt;&lt;a href=&quot;#2-ä¸‹è½½FFmpegå·¥å…·&quot; class=&quot;headerlink&quot; title=&quot;2.ä¸‹è½½FFmpegå·¥å…·&quot;&gt;&lt;/a&gt;2.ä¸‹è½½FFmpegå·¥å…·&lt;/h3&gt;&lt;p&gt;ä¸‹è½½é“¾æ¥ï¼š&lt;a href=&quot;https://github.com/BtbN/FFmpeg-Builds/releases&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/BtbN/FFmpeg-Builds/releases&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/2.png&quot; alt&gt;&lt;/p&gt;
&lt;h3 id=&quot;3-å¯åŠ¨æœåŠ¡å™¨&quot;&gt;&lt;a href=&quot;#3-å¯åŠ¨æœåŠ¡å™¨&quot; class=&quot;headerlink&quot; title=&quot;3.å¯åŠ¨æœåŠ¡å™¨&quot;&gt;&lt;/a&gt;3.å¯åŠ¨æœåŠ¡å™¨&lt;/h3&gt;&lt;p&gt;è¿›å…¥RTSPæœåŠ¡å™¨è·¯å¾„ï¼Œæ§åˆ¶å°æ‰§è¡Œ&lt;code&gt;.\mediamtx.exe&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/03/07/RTSPæ¨æ‹‰æµæœåŠ¡æ­å»º/3.png&quot; alt&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="æµåª’ä½“" scheme="http://yoursite.com/categories/æµåª’ä½“/"/>
    
    
    <category term="yolov8" scheme="http://yoursite.com/tags/yolov8/"/>
    
    <category term="RTSP" scheme="http://yoursite.com/tags/RTSP/"/>
    
  </entry>
  
  <entry>
    <title>yolov8-poseï¼šå…³é”®ç‚¹å§¿æ€æ£€æµ‹</title>
    <link href="http://yoursite.com/2024/01/30/yolov8-pose/"/>
    <id>http://yoursite.com/2024/01/30/yolov8-pose/</id>
    <published>2024-01-30T04:00:00.000Z</published>
    <updated>2024-06-28T07:31:50.162Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ç¯å¢ƒ-amp-å®‰è£…"><a href="#ç¯å¢ƒ-amp-å®‰è£…" class="headerlink" title="ç¯å¢ƒ&amp;å®‰è£…"></a>ç¯å¢ƒ&amp;å®‰è£…</h2><p>åŒä¸Šæ–‡yolov8ï¼šç«ç¾æ£€æµ‹</p><p>æ¨¡å‹ä½¿ç”¨<code>yolov8n-pose</code></p><h2 id="æ•°æ®æ ‡æ³¨"><a href="#æ•°æ®æ ‡æ³¨" class="headerlink" title="æ•°æ®æ ‡æ³¨"></a>æ•°æ®æ ‡æ³¨</h2><h3 id="æ ‡æ³¨å·¥å…·ï¼šlabelme"><a href="#æ ‡æ³¨å·¥å…·ï¼šlabelme" class="headerlink" title="æ ‡æ³¨å·¥å…·ï¼šlabelme"></a>æ ‡æ³¨å·¥å…·ï¼šlabelme</h3><p>å¯¹å›¾åƒä¸­çš„ç›®æ ‡ï¼ˆäººç‰©ï¼‰åŠå…¶å…³é”®ç‚¹è¿›è¡Œæ ‡è®°ï¼ŒåŒ…æ‹¬1ä¸ªç›®æ ‡ç±»åˆ«å’Œ17ä¸ªå…³é”®ç‚¹ç±»åˆ«</p><p><img src="/2024/01/30/yolov8-pose/A.png" alt></p><h3 id="æ•°æ®æ ¼å¼è½¬æ¢"><a href="#æ•°æ®æ ¼å¼è½¬æ¢" class="headerlink" title="æ•°æ®æ ¼å¼è½¬æ¢"></a>æ•°æ®æ ¼å¼è½¬æ¢</h3><p>å°†labelmeæ•°æ®æ ¼å¼è½¬ä¸ºyoloæ ¼å¼ï¼Œé€šç”¨è½¬æ¢ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment"># å‚è€ƒyolov8-ç«ç¾æ£€æµ‹ï¼Œæœªå®Œå¾…ç»­</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶"><a href="#åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶" class="headerlink" title="åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶"></a>åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶</h3><p>å‚è€ƒ<code>yolov8n-pose.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span> <span class="string">/exp/work/video/yolov8/datasets/human-pose/images/train</span> <span class="comment">#è®­ç»ƒé›†æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">/exp/work/video/yolov8/datasets/human-pose/images/val</span> <span class="comment"># éªŒè¯é›†æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">/exp/work/video/yolov8/datasets/human-pose/images/val</span> <span class="comment"># æµ‹è¯•é›†æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">1</span> <span class="comment"># åˆ†ç±»æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®ç‚¹ï¼Œæ¯ä¸ªå…³é”®ç‚¹æœ‰ X Y æ˜¯å¦å¯è§ ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"># å¯è§æ€§ï¼š2-å¯è§ä¸é®æŒ¡ 1-é®æŒ¡ 0-æ²¡æœ‰ç‚¹</span></span><br><span class="line"><span class="attr">kpt_shape:</span> <span class="string">[17,</span> <span class="number">3</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¡†çš„ç±»åˆ«ï¼ˆå¯¹äºå…³é”®ç‚¹æ£€æµ‹ï¼Œåªæœ‰ä¸€ç±»ï¼‰</span></span><br><span class="line"><span class="attr">names:</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">people</span></span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h2><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½æ¨¡å‹</span></span><br><span class="line">model = YOLO(<span class="string">'yolov8n.pt'</span>)  <span class="comment"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒå¡è®­ç»ƒ</span></span><br><span class="line">model.train(</span><br><span class="line">    data=<span class="string">'datasets/human-pose/data/human-pose.yaml'</span>,</span><br><span class="line">    epochs=<span class="number">300</span>,</span><br><span class="line">    device=[<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨éªŒè¯</span></span><br><span class="line">model.val()</span><br></pre></td></tr></table></figure><h2 id="é¢„æµ‹"><a href="#é¢„æµ‹" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h2><h3 id="å¯¼åŒ…ã€æ¨¡å‹åŠ è½½-amp-GPUåŠ è½½"><a href="#å¯¼åŒ…ã€æ¨¡å‹åŠ è½½-amp-GPUåŠ è½½" class="headerlink" title="å¯¼åŒ…ã€æ¨¡å‹åŠ è½½ &amp; GPUåŠ è½½"></a>å¯¼åŒ…ã€æ¨¡å‹åŠ è½½ &amp; GPUåŠ è½½</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># GPU</span></span><br><span class="line">os.environ[<span class="string">'CUDA_VISIBLE_DEVICES'</span>] = <span class="string">'0,1'</span></span><br><span class="line"><span class="comment"># device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')</span></span><br><span class="line"><span class="comment"># print('using device:', device)</span></span><br><span class="line"></span><br><span class="line">model = YOLO(<span class="string">'yolov8n-pose.pt'</span>)</span><br><span class="line"><span class="comment"># model.to(device)</span></span><br></pre></td></tr></table></figure><h3 id="è®¾è®¡æ ·å¼å‚æ•°"><a href="#è®¾è®¡æ ·å¼å‚æ•°" class="headerlink" title="è®¾è®¡æ ·å¼å‚æ•°"></a>è®¾è®¡æ ·å¼å‚æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æµ‹æ¡†ï¼ˆrectangleï¼‰å¯è§†åŒ–é…ç½®</span></span><br><span class="line">bbox_color = (<span class="number">150</span>, <span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># æ¡†çš„ BGR é¢œè‰²</span></span><br><span class="line">bbox_thickness = <span class="number">2</span>  <span class="comment"># æ¡†çš„çº¿å®½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹æ¡†ç±»åˆ«æ–‡å­—</span></span><br><span class="line">bbox_labelstr = &#123;</span><br><span class="line">    <span class="string">'font_size'</span>: <span class="number">1</span>,  <span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">    <span class="string">'font_thickness'</span>: <span class="number">2</span>,  <span class="comment"># å­—ä½“ç²—ç»†</span></span><br><span class="line">    <span class="string">'offset_x'</span>: <span class="number">0</span>,  <span class="comment"># X æ–¹å‘ï¼Œæ–‡å­—åç§»è·ç¦»ï¼Œå‘å³ä¸ºæ­£</span></span><br><span class="line">    <span class="string">'offset_y'</span>: <span class="number">-10</span>,  <span class="comment"># Y æ–¹å‘ï¼Œæ–‡å­—åç§»è·ç¦»ï¼Œå‘ä¸‹ä¸ºæ­£</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®ç‚¹ BGR é…è‰²</span></span><br><span class="line">kpt_color_map = &#123;</span><br><span class="line">    <span class="number">0</span>: &#123;<span class="string">'name'</span>: <span class="string">'Nose'</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># é¼»å°–</span></span><br><span class="line">    <span class="number">1</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Eye'</span>, <span class="string">'color'</span>: [<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³è¾¹çœ¼ç›</span></span><br><span class="line">    <span class="number">2</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Eye'</span>, <span class="string">'color'</span>: [<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦è¾¹çœ¼ç›</span></span><br><span class="line">    <span class="number">3</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Ear'</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³è¾¹è€³æœµ</span></span><br><span class="line">    <span class="number">4</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Ear'</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦è¾¹è€³æœµ</span></span><br><span class="line">    <span class="number">5</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Shoulder'</span>, <span class="string">'color'</span>: [<span class="number">193</span>, <span class="number">182</span>, <span class="number">255</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³è¾¹è‚©è†€</span></span><br><span class="line">    <span class="number">6</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Shoulder'</span>, <span class="string">'color'</span>: [<span class="number">193</span>, <span class="number">182</span>, <span class="number">255</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦è¾¹è‚©è†€</span></span><br><span class="line">    <span class="number">7</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Elbow'</span>, <span class="string">'color'</span>: [<span class="number">16</span>, <span class="number">144</span>, <span class="number">247</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³ä¾§èƒ³è†Šè‚˜</span></span><br><span class="line">    <span class="number">8</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Elbow'</span>, <span class="string">'color'</span>: [<span class="number">16</span>, <span class="number">144</span>, <span class="number">247</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦ä¾§èƒ³è†Šè‚˜</span></span><br><span class="line">    <span class="number">9</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Wrist'</span>, <span class="string">'color'</span>: [<span class="number">1</span>, <span class="number">240</span>, <span class="number">255</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³ä¾§æ‰‹è…•</span></span><br><span class="line">    <span class="number">10</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Wrist'</span>, <span class="string">'color'</span>: [<span class="number">1</span>, <span class="number">240</span>, <span class="number">255</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦ä¾§æ‰‹è…•</span></span><br><span class="line">    <span class="number">11</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Hip'</span>, <span class="string">'color'</span>: [<span class="number">140</span>, <span class="number">47</span>, <span class="number">240</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³ä¾§èƒ¯</span></span><br><span class="line">    <span class="number">12</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Hip'</span>, <span class="string">'color'</span>: [<span class="number">140</span>, <span class="number">47</span>, <span class="number">240</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦ä¾§èƒ¯</span></span><br><span class="line">    <span class="number">13</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Knee'</span>, <span class="string">'color'</span>: [<span class="number">223</span>, <span class="number">155</span>, <span class="number">60</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³ä¾§è†ç›–</span></span><br><span class="line">    <span class="number">14</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Knee'</span>, <span class="string">'color'</span>: [<span class="number">223</span>, <span class="number">155</span>, <span class="number">60</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦ä¾§è†ç›–</span></span><br><span class="line">    <span class="number">15</span>: &#123;<span class="string">'name'</span>: <span class="string">'Right Ankle'</span>, <span class="string">'color'</span>: [<span class="number">139</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å³ä¾§è„šè¸</span></span><br><span class="line">    <span class="number">16</span>: &#123;<span class="string">'name'</span>: <span class="string">'Left Ankle'</span>, <span class="string">'color'</span>: [<span class="number">139</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="string">'radius'</span>: <span class="number">6</span>&#125;,  <span class="comment"># å·¦ä¾§è„šè¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç‚¹ç±»åˆ«æ–‡å­—</span></span><br><span class="line">kpt_labelstr = &#123;</span><br><span class="line">    <span class="string">'font_size'</span>: <span class="number">0.5</span>,  <span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">    <span class="string">'font_thickness'</span>: <span class="number">1</span>,  <span class="comment"># å­—ä½“ç²—ç»†</span></span><br><span class="line">    <span class="string">'offset_x'</span>: <span class="number">10</span>,  <span class="comment"># X æ–¹å‘ï¼Œæ–‡å­—åç§»è·ç¦»ï¼Œå‘å³ä¸ºæ­£</span></span><br><span class="line">    <span class="string">'offset_y'</span>: <span class="number">0</span>,  <span class="comment"># Y æ–¹å‘ï¼Œæ–‡å­—åç§»è·ç¦»ï¼Œå‘ä¸‹ä¸ºæ­£</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># éª¨æ¶è¿æ¥ BGR é…è‰²</span></span><br><span class="line">skeleton_map = [</span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">15</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">13</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">100</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³ä¾§è„šè¸-å³ä¾§è†ç›–</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">13</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">11</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³ä¾§è†ç›–-å³ä¾§èƒ¯</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">16</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">14</span>, <span class="string">'color'</span>: [<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å·¦ä¾§è„šè¸-å·¦ä¾§è†ç›–</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">14</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">12</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å·¦ä¾§è†ç›–-å·¦ä¾§èƒ¯</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">11</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">12</span>, <span class="string">'color'</span>: [<span class="number">122</span>, <span class="number">160</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³ä¾§èƒ¯-å·¦ä¾§èƒ¯</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">5</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">11</span>, <span class="string">'color'</span>: [<span class="number">139</span>, <span class="number">0</span>, <span class="number">139</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³è¾¹è‚©è†€-å³ä¾§èƒ¯</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">6</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">12</span>, <span class="string">'color'</span>: [<span class="number">237</span>, <span class="number">149</span>, <span class="number">100</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å·¦è¾¹è‚©è†€-å·¦ä¾§èƒ¯</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">5</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">6</span>, <span class="string">'color'</span>: [<span class="number">152</span>, <span class="number">251</span>, <span class="number">152</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³è¾¹è‚©è†€-å·¦è¾¹è‚©è†€</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">5</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">7</span>, <span class="string">'color'</span>: [<span class="number">148</span>, <span class="number">0</span>, <span class="number">69</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³è¾¹è‚©è†€-å³ä¾§èƒ³è†Šè‚˜</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">6</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">8</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">75</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å·¦è¾¹è‚©è†€-å·¦ä¾§èƒ³è†Šè‚˜</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">7</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">9</span>, <span class="string">'color'</span>: [<span class="number">56</span>, <span class="number">230</span>, <span class="number">25</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³ä¾§èƒ³è†Šè‚˜-å³ä¾§æ‰‹è…•</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">8</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">10</span>, <span class="string">'color'</span>: [<span class="number">0</span>, <span class="number">240</span>, <span class="number">240</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å·¦ä¾§èƒ³è†Šè‚˜-å·¦ä¾§æ‰‹è…•</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">1</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">2</span>, <span class="string">'color'</span>: [<span class="number">224</span>, <span class="number">255</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³è¾¹çœ¼ç›-å·¦è¾¹çœ¼ç›</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">0</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">1</span>, <span class="string">'color'</span>: [<span class="number">47</span>, <span class="number">255</span>, <span class="number">173</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># é¼»å°–-å·¦è¾¹çœ¼ç›</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">0</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">2</span>, <span class="string">'color'</span>: [<span class="number">203</span>, <span class="number">192</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># é¼»å°–-å·¦è¾¹çœ¼ç›</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">1</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">3</span>, <span class="string">'color'</span>: [<span class="number">196</span>, <span class="number">75</span>, <span class="number">255</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³è¾¹çœ¼ç›-å³è¾¹è€³æœµ</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">2</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">4</span>, <span class="string">'color'</span>: [<span class="number">86</span>, <span class="number">0</span>, <span class="number">25</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å·¦è¾¹çœ¼ç›-å·¦è¾¹è€³æœµ</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">3</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">5</span>, <span class="string">'color'</span>: [<span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;,  <span class="comment"># å³è¾¹è€³æœµ-å³è¾¹è‚©è†€</span></span><br><span class="line">    &#123;<span class="string">'srt_kpt_id'</span>: <span class="number">4</span>, <span class="string">'dst_kpt_id'</span>: <span class="number">6</span>, <span class="string">'color'</span>: [<span class="number">255</span>, <span class="number">18</span>, <span class="number">200</span>], <span class="string">'thickness'</span>: <span class="number">2</span>&#125;  <span class="comment"># å·¦è¾¹è€³æœµ-å·¦è¾¹è‚©è†€</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="è§†é¢‘å¤„ç†å‡½æ•°"><a href="#è§†é¢‘å¤„ç†å‡½æ•°" class="headerlink" title="è§†é¢‘å¤„ç†å‡½æ•°"></a>è§†é¢‘å¤„ç†å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_frame</span><span class="params">(img_bgr)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    è¾“å…¥æ‘„åƒå¤´ç”»é¢ bgr-arrayï¼Œè¾“å‡ºå›¾åƒ bgr-array</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    results = model(img_bgr, verbose=<span class="literal">False</span>)  <span class="comment"># verboseè®¾ç½®ä¸ºFalseï¼Œä¸å•ç‹¬æ‰“å°æ¯ä¸€å¸§é¢„æµ‹ç»“æœ</span></span><br><span class="line">    <span class="comment"># é¢„æµ‹æ¡†çš„ä¸ªæ•°</span></span><br><span class="line">    num_bbox = len(results[<span class="number">0</span>].boxes.cls)</span><br><span class="line">    <span class="comment"># é¢„æµ‹æ¡†çš„ xyxy åæ ‡</span></span><br><span class="line">    bboxes_xyxy = results[<span class="number">0</span>].boxes.xyxy.cpu().numpy().astype(<span class="string">'uint32'</span>)</span><br><span class="line">    <span class="comment"># å…³é”®ç‚¹çš„ xy åæ ‡</span></span><br><span class="line">    bboxes_keypoints = results[<span class="number">0</span>].keypoints.data.cpu().numpy()</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> range(num_bbox):  <span class="comment"># éå†æ¯ä¸ªæ¡†</span></span><br><span class="line">        <span class="comment"># è·å–è¯¥æ¡†åæ ‡</span></span><br><span class="line">        bbox_xyxy = bboxes_xyxy[idx]</span><br><span class="line">        <span class="comment"># è·å–æ¡†çš„é¢„æµ‹ç±»åˆ«(å¯¹äºå…³é”®ç‚¹æ£€æµ‹ï¼Œåªæœ‰ä¸€ä¸ªç±»åˆ«)</span></span><br><span class="line">        bbox_label = results[<span class="number">0</span>].names[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># ç”»æ¡†</span></span><br><span class="line">        img_bgr = cv2.rectangle(img_bgr, (bbox_xyxy[<span class="number">0</span>], bbox_xyxy[<span class="number">1</span>]), (bbox_xyxy[<span class="number">2</span>], bbox_xyxy[<span class="number">3</span>]), bbox_color,</span><br><span class="line">                                bbox_thickness)</span><br><span class="line">        <span class="comment"># å†™æ¡†ç±»åˆ«æ–‡å­—ï¼šå›¾ç‰‡ï¼Œæ–‡å­—å­—ç¬¦ä¸²ï¼Œæ–‡å­—å·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">        img_bgr = cv2.putText(img_bgr, bbox_label,</span><br><span class="line">                              (bbox_xyxy[<span class="number">0</span>] + bbox_labelstr[<span class="string">'offset_x'</span>], bbox_xyxy[<span class="number">1</span>] + bbox_labelstr[<span class="string">'offset_y'</span>]),</span><br><span class="line">                              cv2.FONT_HERSHEY_SIMPLEX, bbox_labelstr[<span class="string">'font_size'</span>], bbox_color,</span><br><span class="line">                              bbox_labelstr[<span class="string">'font_thickness'</span>])</span><br><span class="line">        bbox_keypoints = bboxes_keypoints[idx]  <span class="comment"># è¯¥æ¡†æ‰€æœ‰å…³é”®ç‚¹åæ ‡å’Œç½®ä¿¡åº¦</span></span><br><span class="line">        <span class="comment"># ç”»è¯¥æ¡†çš„éª¨æ¶è¿æ¥</span></span><br><span class="line">        <span class="keyword">for</span> skeleton <span class="keyword">in</span> skeleton_map:</span><br><span class="line">            <span class="comment"># è·å–èµ·å§‹ç‚¹åæ ‡</span></span><br><span class="line">            srt_kpt_id = skeleton[<span class="string">'srt_kpt_id'</span>]</span><br><span class="line">            srt_kpt_x = round(bbox_keypoints[srt_kpt_id][<span class="number">0</span>])</span><br><span class="line">            srt_kpt_y = round(bbox_keypoints[srt_kpt_id][<span class="number">1</span>])</span><br><span class="line">            srt_kpt_conf = bbox_keypoints[srt_kpt_id][<span class="number">2</span>]  <span class="comment"># è·å–èµ·å§‹ç‚¹ç½®ä¿¡åº¦</span></span><br><span class="line">            <span class="comment"># print(srt_kpt_conf)</span></span><br><span class="line">            <span class="comment"># è·å–ç»ˆæ­¢ç‚¹åæ ‡</span></span><br><span class="line">            dst_kpt_id = skeleton[<span class="string">'dst_kpt_id'</span>]</span><br><span class="line">            dst_kpt_x = round(bbox_keypoints[dst_kpt_id][<span class="number">0</span>])</span><br><span class="line">            dst_kpt_y = round(bbox_keypoints[dst_kpt_id][<span class="number">1</span>])</span><br><span class="line">            dst_kpt_conf = bbox_keypoints[dst_kpt_id][<span class="number">2</span>]  <span class="comment"># è·å–ç»ˆæ­¢ç‚¹ç½®ä¿¡åº¦</span></span><br><span class="line">            <span class="comment"># print(dst_kpt_conf)</span></span><br><span class="line">            <span class="comment"># è·å–éª¨æ¶è¿æ¥é¢œè‰²</span></span><br><span class="line">            skeleton_color = skeleton[<span class="string">'color'</span>]</span><br><span class="line">            <span class="comment"># è·å–éª¨æ¶è¿æ¥çº¿å®½</span></span><br><span class="line">            skeleton_thickness = skeleton[<span class="string">'thickness'</span>]</span><br><span class="line">            <span class="comment"># å¦‚æœèµ·å§‹ç‚¹å’Œç»ˆæ­¢ç‚¹çš„ç½®ä¿¡åº¦éƒ½é«˜äºé˜ˆå€¼ï¼Œæ‰ç”»éª¨æ¶è¿æ¥</span></span><br><span class="line">            <span class="keyword">if</span> srt_kpt_conf &gt; <span class="number">0.5</span> <span class="keyword">and</span> dst_kpt_conf &gt; <span class="number">0.5</span>:</span><br><span class="line">                <span class="comment"># ç”»éª¨æ¶è¿æ¥</span></span><br><span class="line">                img_bgr = cv2.line(img_bgr, (srt_kpt_x, srt_kpt_y), (dst_kpt_x, dst_kpt_y), color=skeleton_color,</span><br><span class="line">                                   thickness=skeleton_thickness)</span><br><span class="line">        <span class="comment"># ç”»è¯¥æ¡†çš„å…³é”®ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> kpt_id <span class="keyword">in</span> kpt_color_map:</span><br><span class="line">            <span class="comment"># è·å–è¯¥å…³é”®ç‚¹çš„é¢œè‰²ã€åŠå¾„ã€XYåæ ‡</span></span><br><span class="line">            kpt_color = kpt_color_map[kpt_id][<span class="string">'color'</span>]</span><br><span class="line">            kpt_radius = kpt_color_map[kpt_id][<span class="string">'radius'</span>]</span><br><span class="line">            kpt_x = round(bbox_keypoints[kpt_id][<span class="number">0</span>])</span><br><span class="line">            kpt_y = round(bbox_keypoints[kpt_id][<span class="number">1</span>])</span><br><span class="line">            kpt_conf = bbox_keypoints[kpt_id][<span class="number">2</span>]  <span class="comment"># è·å–è¯¥å…³é”®ç‚¹ç½®ä¿¡åº¦</span></span><br><span class="line">            <span class="keyword">if</span> kpt_conf &gt; <span class="number">0.5</span>:</span><br><span class="line">                <span class="comment"># ç”»åœ†ï¼šå›¾ç‰‡ã€XYåæ ‡ã€åŠå¾„ã€é¢œè‰²ã€çº¿å®½(-1ä¸ºå¡«å……)</span></span><br><span class="line">                img_bgr = cv2.circle(img_bgr, (kpt_x, kpt_y), kpt_radius, kpt_color, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img_bgr</span><br></pre></td></tr></table></figure><h3 id="CV2å¤„ç†å‡½æ•°"><a href="#CV2å¤„ç†å‡½æ•°" class="headerlink" title="CV2å¤„ç†å‡½æ•°"></a>CV2å¤„ç†å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_video</span><span class="params">(input_path=<span class="string">'video/robot.mp4'</span>)</span>:</span></span><br><span class="line">    file_head = input_path.split(<span class="string">'/'</span>)[<span class="number">-1</span>]</span><br><span class="line">    output_path = <span class="string">"out-"</span> + file_head</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'è§†é¢‘å¼€å§‹å¤„ç†'</span>, input_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘æ€»å¸§æ•°</span></span><br><span class="line">    cap = cv2.VideoCapture(input_path)</span><br><span class="line">    frame_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> cap.isOpened():</span><br><span class="line">        success, frame = cap.read()</span><br><span class="line">        frame_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    cap.release()</span><br><span class="line">    print(<span class="string">'è§†é¢‘æ€»å¸§æ•°ä¸º'</span>, frame_count)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cv2.namedWindow('Crack Detection and Measurement Video Processing')</span></span><br><span class="line">    cap = cv2.VideoCapture(input_path)</span><br><span class="line">    frame_size = (cap.get(cv2.CAP_PROP_FRAME_WIDTH), cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fourcc = int(cap.get(cv2.CAP_PROP_FOURCC))</span></span><br><span class="line">    <span class="comment"># fourcc = cv2.VideoWriter_fourcc(*'XVID')</span></span><br><span class="line">    fourcc = cv2.VideoWriter_fourcc(*<span class="string">'mp4v'</span>)</span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line"></span><br><span class="line">    out = cv2.VideoWriter(output_path, fourcc, fps, (int(frame_size[<span class="number">0</span>]), int(frame_size[<span class="number">1</span>])))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿›åº¦æ¡ç»‘å®šè§†é¢‘æ€»å¸§æ•°</span></span><br><span class="line">    <span class="keyword">with</span> tqdm(total=frame_count - <span class="number">1</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="comment"># noinspection PyBroadException</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> cap.isOpened():</span><br><span class="line">                success, frame = cap.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># noinspection PyBroadException</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    frame = process_frame(frame)</span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    print(<span class="string">'error'</span>)</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> success:</span><br><span class="line">                    <span class="comment"># cv2.imshow('Video Processing', frame)</span></span><br><span class="line">                    out.write(frame)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># è¿›åº¦æ¡æ›´æ–°ä¸€å¸§</span></span><br><span class="line">                    pbar.update(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># if cv2.waitKey(1) &amp; 0xFF == ord('q'):</span></span><br><span class="line">                <span class="comment"># break</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            print(<span class="string">'ä¸­é€”ä¸­æ–­'</span>)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    cv2.destroyAllWindows()</span><br><span class="line">    out.release()</span><br><span class="line">    cap.release()</span><br><span class="line">    print(<span class="string">'è§†é¢‘å·²ä¿å­˜'</span>, output_path)</span><br></pre></td></tr></table></figure><h3 id="é¢„æµ‹-1"><a href="#é¢„æµ‹-1" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h3><p>å°†ä»£ç æ•´åˆä»¥åï¼Œæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    generate_video(input_path=<span class="string">'video/test.mp4'</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¯å¢ƒ-amp-å®‰è£…&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ-amp-å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&amp;amp;å®‰è£…&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&amp;amp;å®‰è£…&lt;/h2&gt;&lt;p&gt;åŒä¸Šæ–‡yolov8ï¼šç«ç¾æ£€æµ‹&lt;/p&gt;
&lt;p&gt;æ¨¡å‹ä½¿ç”¨&lt;code&gt;yolov8n-pose&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;æ•°æ®æ ‡æ³¨&quot;&gt;&lt;a href=&quot;#æ•°æ®æ ‡æ³¨&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®æ ‡æ³¨&quot;&gt;&lt;/a&gt;æ•°æ®æ ‡æ³¨&lt;/h2&gt;&lt;h3 id=&quot;æ ‡æ³¨å·¥å…·ï¼šlabelme&quot;&gt;&lt;a href=&quot;#æ ‡æ³¨å·¥å…·ï¼šlabelme&quot; class=&quot;headerlink&quot; title=&quot;æ ‡æ³¨å·¥å…·ï¼šlabelme&quot;&gt;&lt;/a&gt;æ ‡æ³¨å·¥å…·ï¼šlabelme&lt;/h3&gt;&lt;p&gt;å¯¹å›¾åƒä¸­çš„ç›®æ ‡ï¼ˆäººç‰©ï¼‰åŠå…¶å…³é”®ç‚¹è¿›è¡Œæ ‡è®°ï¼ŒåŒ…æ‹¬1ä¸ªç›®æ ‡ç±»åˆ«å’Œ17ä¸ªå…³é”®ç‚¹ç±»åˆ«&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/01/30/yolov8-pose/A.png&quot; alt&gt;&lt;/p&gt;
&lt;h3 id=&quot;æ•°æ®æ ¼å¼è½¬æ¢&quot;&gt;&lt;a href=&quot;#æ•°æ®æ ¼å¼è½¬æ¢&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®æ ¼å¼è½¬æ¢&quot;&gt;&lt;/a&gt;æ•°æ®æ ¼å¼è½¬æ¢&lt;/h3&gt;&lt;p&gt;å°†labelmeæ•°æ®æ ¼å¼è½¬ä¸ºyoloæ ¼å¼ï¼Œé€šç”¨è½¬æ¢ä»£ç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# &lt;span class=&quot;doctag&quot;&gt;TODO:&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å‚è€ƒyolov8-ç«ç¾æ£€æµ‹ï¼Œæœªå®Œå¾…ç»­&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶&quot;&gt;&lt;a href=&quot;#åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶&quot;&gt;&lt;/a&gt;åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶&lt;/h3&gt;&lt;p&gt;å‚è€ƒ&lt;code&gt;yolov8n-pose.yaml&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;train:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/exp/work/video/yolov8/datasets/human-pose/images/train&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#è®­ç»ƒé›†æ–‡ä»¶å¤¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;val:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/exp/work/video/yolov8/datasets/human-pose/images/val&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# éªŒè¯é›†æ–‡ä»¶å¤¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;test:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/exp/work/video/yolov8/datasets/human-pose/images/val&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# æµ‹è¯•é›†æ–‡ä»¶å¤¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;nc:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# åˆ†ç±»æ•°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å…³é”®ç‚¹ï¼Œæ¯ä¸ªå…³é”®ç‚¹æœ‰ X Y æ˜¯å¦å¯è§ ä¸‰ä¸ªå‚æ•°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å¯è§æ€§ï¼š2-å¯è§ä¸é®æŒ¡ 1-é®æŒ¡ 0-æ²¡æœ‰ç‚¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kpt_shape:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;[17,&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æ¡†çš„ç±»åˆ«ï¼ˆå¯¹äºå…³é”®ç‚¹æ£€æµ‹ï¼Œåªæœ‰ä¸€ç±»ï¼‰&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;names:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;0:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;people&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="å…³é”®ç‚¹æ£€æµ‹" scheme="http://yoursite.com/categories/å…³é”®ç‚¹æ£€æµ‹/"/>
    
    
    <category term="yolov8" scheme="http://yoursite.com/tags/yolov8/"/>
    
    <category term="opencv" scheme="http://yoursite.com/tags/opencv/"/>
    
  </entry>
  
  <entry>
    <title>yolov8-ç«ç¾æ£€æµ‹</title>
    <link href="http://yoursite.com/2024/01/25/yolov8%EF%BC%9A%E7%81%AB%E7%81%BE%E6%A3%80%E6%B5%8B/"/>
    <id>http://yoursite.com/2024/01/25/yolov8%EF%BC%9A%E7%81%AB%E7%81%BE%E6%A3%80%E6%B5%8B/</id>
    <published>2024-01-25T09:23:20.000Z</published>
    <updated>2024-02-07T01:54:57.353Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><h3 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h3><ul><li><font color="gold">NVIDIA 3090*2</font></li><li><font color="gold">æ˜¾å¡é©±åŠ¨ 535.104.05</font></li><li><font color="gold">CUDAç‰ˆæœ¬ 12.2</font></li><li><font color="gold">CUDAtoolkit</font> (cuda_12.2.2_535.104.05_linux)</li><li><font color="gold">cuDNN (v8.9.7)</font></li></ul><h3 id="yoloç‰ˆæœ¬"><a href="#yoloç‰ˆæœ¬" class="headerlink" title="yoloç‰ˆæœ¬"></a>yoloç‰ˆæœ¬</h3><ul><li><font color="gold">v8.1.5</font> (ultralytics yolov8)</li></ul><h3 id="pytorchç‰ˆæœ¬"><a href="#pytorchç‰ˆæœ¬" class="headerlink" title="pytorchç‰ˆæœ¬"></a>pytorchç‰ˆæœ¬</h3><ul><li><font color="gold">v2.1.2</font></li></ul><h3 id="pythonç¯å¢ƒ"><a href="#pythonç¯å¢ƒ" class="headerlink" title="pythonç¯å¢ƒ"></a>pythonç¯å¢ƒ</h3><ul><li><font color="gold">CentOS7.9</font></li><li><font color="gold">anaconda3</font></li><li><font color="gold">python3.9</font></li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>æºç ä¸»é¡µï¼š<a href="https://github.com/ultralytics/ultralytics" target="_blank" rel="noopener">https://github.com/ultralytics/ultralytics</a></p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.ultralytics.com/zh" target="_blank" rel="noopener">https://docs.ultralytics.com/zh</a></p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/1.png" alt></p><h3 id="å…‹éš†æºç "><a href="#å…‹éš†æºç " class="headerlink" title="å…‹éš†æºç "></a>å…‹éš†æºç </h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://hub.nuaa.cf/ultralytics/ultralytics.git</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pip install ultralytics -i https://mirror.baidu.com/pypi/simple</span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒéªŒè¯"><a href="#ç¯å¢ƒéªŒè¯" class="headerlink" title="ç¯å¢ƒéªŒè¯"></a>ç¯å¢ƒéªŒè¯</h3><p>python</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ultralytics</span><br><span class="line">ultralytics.checks()</span><br></pre></td></tr></table></figure><p>cli</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yolo predict model=yolov8n.pt source=ultralytics/assets/zidane.jpg</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œæ¯•åå¾—åˆ°è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(py39_yolov8) [root@jdz yolov8]# yolo predict model=yolov8n.pt source=ultralytics/assets/zidane.jpg </span><br><span class="line">Ultralytics YOLOv8.1.5 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">YOLOv8n summary (fused): 168 layers, 3151904 parameters, 0 gradients, 8.7 GFLOPs</span><br><span class="line"></span><br><span class="line">image 1/1 /exp/work/video/yolov8/ultralytics/assets/zidane.jpg: 384x640 2 persons, 1 tie, 216.9ms</span><br><span class="line">Speed: 7.3ms preprocess, 216.9ms inference, 762.4ms postprocess per image at shape (1, 3, 384, 640)</span><br><span class="line">Results saved to runs/detect/predict</span><br><span class="line">ğŸ’¡ Learn more at https://docs.ultralytics.com/modes/predict</span><br></pre></td></tr></table></figure><p>å°†åœ¨<code>Results saved to runs/detect/predict</code>ç›®å½•ä¸‹æ‰¾åˆ°è¾“å‡ºç»“æœ</p><a id="more"></a><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/2.png" alt></p><p>è‡³æ­¤ï¼Œå·²éªŒè¯åŸºç¡€ç¯å¢ƒæ­£å¸¸å·¥ä½œã€‚</p><h2 id="è®­ç»ƒé›†"><a href="#è®­ç»ƒé›†" class="headerlink" title="è®­ç»ƒé›†"></a>è®­ç»ƒé›†</h2><p>å‰å¾€kaggleå®˜ç½‘å¯»æ‰¾ç«ç„°è®­ç»ƒé›†ï¼Œè¿™é‡Œä½¿ç”¨Fire and Smoke Datasetæ•°æ®é›†ï¼ˆ<a href="https://www.kaggle.com/datasets/dataclusterlabs/fire-and-smoke-dataset" target="_blank" rel="noopener">https://www.kaggle.com/datasets/dataclusterlabs/fire-and-smoke-dataset</a>ï¼‰</p><p>æ•°æ®é›†åŒ…å«çƒŸã€ç«å›¾åƒå…±100å¼ </p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/3.png" alt></p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/4.png" alt></p><h2 id="æ•°æ®æ ‡æ³¨"><a href="#æ•°æ®æ ‡æ³¨" class="headerlink" title="æ•°æ®æ ‡æ³¨"></a>æ•°æ®æ ‡æ³¨</h2><h3 id="æ ‡æ³¨å·¥å…·ï¼šlabelme"><a href="#æ ‡æ³¨å·¥å…·ï¼šlabelme" class="headerlink" title="æ ‡æ³¨å·¥å…·ï¼šlabelme"></a>æ ‡æ³¨å·¥å…·ï¼šlabelme</h3><p>å¯¹å›¾åƒä¸­çš„ç«ç„°å’ŒçƒŸé›¾è¿›è¡ŒçŸ©å½¢æ ‡è®°ï¼Œå°†æ•°æ®çš„labelåˆ†ä¸ºä¸¤ç±»ï¼š0-ç«ç„°ï¼›1-çƒŸé›¾</p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/5.png" alt></p><h3 id="æ•°æ®æ ¼å¼è½¬æ¢"><a href="#æ•°æ®æ ¼å¼è½¬æ¢" class="headerlink" title="æ•°æ®æ ¼å¼è½¬æ¢"></a>æ•°æ®æ ¼å¼è½¬æ¢</h3><p>å°†labelmeæ•°æ®æ ¼å¼è½¬ä¸ºyoloæ ¼å¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> PR</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®é›†ç›®å½•</span></span><br><span class="line">Dataset_root = os.path.join(PR, <span class="string">'datasets/protective_clothing'</span>)</span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/images'</span>)</span><br><span class="line">test_frac = <span class="number">0.2</span>  <span class="comment"># æµ‹è¯•é›†æ¯”ä¾‹</span></span><br><span class="line">random.seed(<span class="number">123</span>) <span class="comment"># éšæœºæ•°ç§å­ï¼Œä¾¿äºå¤ç°</span></span><br><span class="line"></span><br><span class="line">img_paths = os.listdir(<span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/images'</span>)</span><br><span class="line">random.shuffle(img_paths) <span class="comment"># éšæœºæ‰“ä¹±</span></span><br><span class="line"></span><br><span class="line">val_number = int(len(img_paths) * test_frac) <span class="comment"># æµ‹è¯•é›†æ–‡ä»¶ä¸ªæ•°</span></span><br><span class="line">train_files = img_paths[val_number:]         <span class="comment"># è®­ç»ƒé›†æ–‡ä»¶ååˆ—è¡¨</span></span><br><span class="line">val_files = img_paths[:val_number]           <span class="comment"># æµ‹è¯•é›†æ–‡ä»¶ååˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'æ•°æ®é›†æ–‡ä»¶æ€»æ•°'</span>, len(img_paths))</span><br><span class="line">print(<span class="string">'è®­ç»ƒé›†æ–‡ä»¶ä¸ªæ•°'</span>, len(train_files))</span><br><span class="line">print(<span class="string">'æµ‹è¯•é›†æ–‡ä»¶ä¸ªæ•°'</span>, len(val_files))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'train'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'train'</span>)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> tqdm(train_files):</span><br><span class="line">        shutil.move(each, <span class="string">'train'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'val'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'val'</span>)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> tqdm(val_files):</span><br><span class="line">        shutil.move(each, <span class="string">'val'</span>)</span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/labelme_jsons'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'train'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'train'</span>)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> tqdm(train_files):</span><br><span class="line">        srt_path = each.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.json'</span></span><br><span class="line">        shutil.move(srt_path, <span class="string">'train'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'val'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'val'</span>)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> tqdm(val_files):</span><br><span class="line">        srt_path = each.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.json'</span></span><br><span class="line">        shutil.move(srt_path, <span class="string">'val'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">classes = &#123;</span><br><span class="line">    <span class="string">'unprotected'</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">'protected'</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">os.chdir(Dataset_root)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'classes.txt'</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> list(classes.keys()):</span><br><span class="line">        f.write(each + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'labels'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'labels'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'labels/train'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'labels/train'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'labels/val'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'labels/val'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_single_json</span><span class="params">(labelme_path, save_folder=<span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/labels/train'</span>)</span>:</span></span><br><span class="line">    <span class="comment"># è½½å…¥ labelmeæ ¼å¼çš„ json æ ‡æ³¨æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">with</span> open(labelme_path, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        labelme = json.load(f)</span><br><span class="line"></span><br><span class="line">    img_width = labelme[<span class="string">'imageWidth'</span>]  <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">    img_height = labelme[<span class="string">'imageHeight'</span>]  <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”Ÿæˆ YOLO æ ¼å¼çš„ txt æ–‡ä»¶</span></span><br><span class="line">    suffix = labelme_path.split(<span class="string">'.'</span>)[<span class="number">-2</span>]</span><br><span class="line">    yolo_txt_path = suffix + <span class="string">'.txt'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(yolo_txt_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> each_ann <span class="keyword">in</span> labelme[<span class="string">'shapes'</span>]:  <span class="comment"># éå†æ¯ä¸ªæ¡†</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> each_ann[<span class="string">'shape_type'</span>] == <span class="string">'rectangle'</span>:  <span class="comment"># ç­›é€‰å‡ºæ¡†</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># è·å–ç±»åˆ« ID</span></span><br><span class="line">                bbox_class_id = classes[each_ann[<span class="string">'label'</span>]]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„ XY åƒç´ åæ ‡</span></span><br><span class="line">                bbox_top_left_x = int(min(each_ann[<span class="string">'points'</span>][<span class="number">0</span>][<span class="number">0</span>], each_ann[<span class="string">'points'</span>][<span class="number">1</span>][<span class="number">0</span>]))</span><br><span class="line">                bbox_bottom_right_x = int(max(each_ann[<span class="string">'points'</span>][<span class="number">0</span>][<span class="number">0</span>], each_ann[<span class="string">'points'</span>][<span class="number">1</span>][<span class="number">0</span>]))</span><br><span class="line">                bbox_top_left_y = int(min(each_ann[<span class="string">'points'</span>][<span class="number">0</span>][<span class="number">1</span>], each_ann[<span class="string">'points'</span>][<span class="number">1</span>][<span class="number">1</span>]))</span><br><span class="line">                bbox_bottom_right_y = int(max(each_ann[<span class="string">'points'</span>][<span class="number">0</span>][<span class="number">1</span>], each_ann[<span class="string">'points'</span>][<span class="number">1</span>][<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ¡†ä¸­å¿ƒç‚¹çš„ XY åƒç´ åæ ‡</span></span><br><span class="line">                bbox_center_x = int((bbox_top_left_x + bbox_bottom_right_x) / <span class="number">2</span>)</span><br><span class="line">                bbox_center_y = int((bbox_top_left_y + bbox_bottom_right_y) / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ¡†å®½åº¦</span></span><br><span class="line">                bbox_width = bbox_bottom_right_x - bbox_top_left_x</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ¡†é«˜åº¦</span></span><br><span class="line">                bbox_height = bbox_bottom_right_y - bbox_top_left_y</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ¡†ä¸­å¿ƒç‚¹å½’ä¸€åŒ–åæ ‡</span></span><br><span class="line">                bbox_center_x_norm = bbox_center_x / img_width</span><br><span class="line">                bbox_center_y_norm = bbox_center_y / img_height</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ¡†å½’ä¸€åŒ–å®½åº¦</span></span><br><span class="line">                bbox_width_norm = bbox_width / img_width</span><br><span class="line">                <span class="comment"># æ¡†å½’ä¸€åŒ–é«˜åº¦</span></span><br><span class="line">                bbox_height_norm = bbox_height / img_height</span><br><span class="line"></span><br><span class="line">                <span class="comment"># ç”Ÿæˆ YOLO æ ¼å¼çš„ä¸€è¡Œæ ‡æ³¨ï¼ŒæŒ‡å®šä¿ç•™å°æ•°ç‚¹åå‡ ä½</span></span><br><span class="line">                bbox_yolo_str = <span class="string">'&#123;&#125; &#123;:.4f&#125; &#123;:.4f&#125; &#123;:.4f&#125; &#123;:.4f&#125;'</span>.format(bbox_class_id, bbox_center_x_norm,</span><br><span class="line">                                                                        bbox_center_y_norm, bbox_width_norm,</span><br><span class="line">                                                                        bbox_height_norm)</span><br><span class="line">                <span class="comment"># å†™å…¥ txt æ–‡ä»¶ä¸­</span></span><br><span class="line">                f.write(bbox_yolo_str + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">    shutil.move(yolo_txt_path, save_folder)</span><br><span class="line">    print(<span class="string">'&#123;&#125; --&gt; &#123;&#125; è½¬æ¢å®Œæˆ'</span>.format(labelme_path, yolo_txt_path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/labelme_jsons/train'</span>)</span><br><span class="line"></span><br><span class="line">save_folder = <span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/labels/train'</span></span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> os.listdir():</span><br><span class="line">    process_single_json(path, save_folder=save_folder)</span><br><span class="line">print(<span class="string">'YOLOæ ¼å¼çš„txtæ ‡æ³¨æ–‡ä»¶å·²ä¿å­˜è‡³ '</span>, save_folder)</span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>/labelme_jsons/val'</span>)</span><br><span class="line">save_folder = <span class="string">fr'<span class="subst">&#123;Dataset_root&#125;</span>//labels/val'</span></span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> os.listdir():</span><br><span class="line">    process_single_json(path, save_folder=save_folder)</span><br><span class="line">print(<span class="string">'YOLOæ ¼å¼çš„txtæ ‡æ³¨æ–‡ä»¶å·²ä¿å­˜è‡³ '</span>, save_folder)</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶"><a href="#åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶" class="headerlink" title="åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶"></a>åˆ›å»ºè®­ç»ƒyamlæ–‡ä»¶</h3><p>åœ¨æ•°æ®é›†çš„æ ¹ç›®å½•ä¸‹æ–°å»º<code>fire.yaml</code>æ–‡ä»¶ç”¨äºè®°å½•è®­ç»ƒé›†ä¿¡æ¯</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span> <span class="string">/exp/work/video/yolov8/datasets/fire/data/train/images</span> <span class="comment"># è®­ç»ƒé›†</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">/exp/work/video/yolov8/datasets/fire/data/val/images</span> <span class="comment"># éªŒè¯é›†</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">/exp/work/video/yolov8/datasets/fire/data/test/images</span> <span class="comment"># æµ‹è¯•é›†</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">2</span> <span class="comment"># åˆ†ç±»æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="attr">names:</span> <span class="string">[fire,</span> <span class="string">smoke]</span> <span class="comment"># ç±»åˆ«åç§°</span></span><br></pre></td></tr></table></figure><h2 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h2><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºè®­ç»ƒè„šæœ¬<code>yolov8_train.py</code>ï¼Œå¹¶è®¾ç½®åŒå¡è®­ç»ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½æ¨¡å‹</span></span><br><span class="line">model = YOLO(<span class="string">'yolov8n.pt'</span>)  <span class="comment"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒå¡è®­ç»ƒ</span></span><br><span class="line">model.train(</span><br><span class="line">    data=<span class="string">'datasets/fire/data/fire.yaml'</span>,</span><br><span class="line">    epochs=<span class="number">300</span>,</span><br><span class="line">    device=[<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨éªŒè¯</span></span><br><span class="line">model.val()</span><br></pre></td></tr></table></figure><p>å¯åŠ¨è®­ç»ƒè„šæœ¬ï¼Œå¼€å¯è®­ç»ƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python yolov8_train.py</span><br></pre></td></tr></table></figure><p>æ‰“å°é…ç½®ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Ultralytics YOLOv8.1.5 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                          CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">engine/trainer: task=detect, mode=train, model=yolov8n.pt, data=datasets/fire/data/fire.yaml, epochs=300, time=None, patience=50, batch=16, imgsz=640, save=True, save_period=-1, cache=False, device=[0, 1], workers=8, project=None, name=train9, exist_ok=False, pretrained=True, optimizer=auto, verbose=True, seed=0, deterministic=True, single_cls=False, rect=False, cos_lr=False, close_mosaic=10, resume=False, amp=True, fraction=1.0, profile=False, freeze=None, multi_scale=False, overlap_mask=True, mask_ratio=4, dropout=0.0, val=True, split=val, save_json=False, save_hybrid=False, conf=None, iou=0.7, max_det=300, half=False, dnn=False, plots=True, source=None, vid_stride=1, stream_buffer=False, visualize=False, augment=False, agnostic_nms=False, classes=None, retina_masks=False, embed=None, show=False, save_frames=False, save_txt=False, save_conf=False, save_crop=False, show_labels=True, show_conf=True, show_boxes=True, line_width=None, format=torchscript, keras=False, optimize=False, int8=False, dynamic=False, simplify=False, opset=None, workspace=4, nms=False, lr0=0.01, lrf=0.01, momentum=0.937, weight_decay=0.0005, warmup_epochs=3.0, warmup_momentum=0.8, warmup_bias_lr=0.1, box=7.5, cls=0.5, dfl=1.5, pose=12.0, kobj=1.0, label_smoothing=0.0, nbs=64, hsv_h=0.015, hsv_s=0.7, hsv_v=0.4, degrees=0.0, translate=0.1, scale=0.5, shear=0.0, perspective=0.0, flipud=0.0, fliplr=0.5, mosaic=1.0, mixup=0.0, copy_paste=0.0, auto_augment=randaugment, erasing=0.4, crop_fraction=1.0, cfg=None, tracker=botsort.yaml, save_dir=runs/detect/train9</span><br><span class="line">Overriding model.yaml nc=80 with nc=2</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">                   from  n    params  module                                       arguments                     </span><br><span class="line">  0                  -1  1       464  ultralytics.nn.modules.conv.Conv             [3, 16, 3, 2]                 </span><br><span class="line">  1                  -1  1      4672  ultralytics.nn.modules.conv.Conv             [16, 32, 3, 2]                </span><br><span class="line">  2                  -1  1      7360  ultralytics.nn.modules.block.C2f             [32, 32, 1, True]             </span><br><span class="line">  3                  -1  1     18560  ultralytics.nn.modules.conv.Conv             [32, 64, 3, 2]                </span><br><span class="line">  4                  -1  2     49664  ultralytics.nn.modules.block.C2f             [64, 64, 2, True]             </span><br><span class="line">  5                  -1  1     73984  ultralytics.nn.modules.conv.Conv             [64, 128, 3, 2]               </span><br><span class="line">  6                  -1  2    197632  ultralytics.nn.modules.block.C2f             [128, 128, 2, True]           </span><br><span class="line">  7                  -1  1    295424  ultralytics.nn.modules.conv.Conv             [128, 256, 3, 2]              </span><br><span class="line">  8                  -1  1    460288  ultralytics.nn.modules.block.C2f             [256, 256, 1, True]           </span><br><span class="line">  9                  -1  1    164608  ultralytics.nn.modules.block.SPPF            [256, 256, 5]                 </span><br><span class="line"> 10                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, 'nearest']          </span><br><span class="line"> 11             [-1, 6]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 12                  -1  1    148224  ultralytics.nn.modules.block.C2f             [384, 128, 1]                 </span><br><span class="line"> 13                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, 'nearest']          </span><br><span class="line"> 14             [-1, 4]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 15                  -1  1     37248  ultralytics.nn.modules.block.C2f             [192, 64, 1]                  </span><br><span class="line"> 16                  -1  1     36992  ultralytics.nn.modules.conv.Conv             [64, 64, 3, 2]                </span><br><span class="line"> 17            [-1, 12]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 18                  -1  1    123648  ultralytics.nn.modules.block.C2f             [192, 128, 1]                 </span><br><span class="line"> 19                  -1  1    147712  ultralytics.nn.modules.conv.Conv             [128, 128, 3, 2]              </span><br><span class="line"> 20             [-1, 9]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 21                  -1  1    493056  ultralytics.nn.modules.block.C2f             [384, 256, 1]                 </span><br><span class="line"> 22        [15, 18, 21]  1    751702  ultralytics.nn.modules.head.Detect           [2, [64, 128, 256]]           </span><br><span class="line">Model summary: 225 layers, 3011238 parameters, 3011222 gradients, 8.2 GFLOPs</span><br><span class="line"></span><br><span class="line">Transferred 319/355 items from pretrained weights</span><br><span class="line">DDP: debug command /root/anaconda3/envs/py39_yolov8/bin/python -m torch.distributed.run --nproc_per_node 2 --master_port 45027 /root/.config/Ultralytics/DDP/_temp_bfxihrb7140614302513712.py</span><br><span class="line">WARNING:__main__:</span><br><span class="line">*****************************************</span><br><span class="line">Setting OMP_NUM_THREADS environment variable for each process to be 1 in default, to avoid your system being overloaded, please further tune the variable for optimal performance in your application as needed. </span><br><span class="line">*****************************************</span><br><span class="line">Ultralytics YOLOv8.1.5 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                          CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">Overriding model.yaml nc=80 with nc=2</span><br><span class="line">Transferred 319/355 items from pretrained weights</span><br><span class="line">Freezing layer 'model.22.dfl.conv.weight'</span><br><span class="line">AMP: running Automatic Mixed Precision (AMP) checks with YOLOv8n...</span><br><span class="line">AMP: checks passed âœ…</span><br></pre></td></tr></table></figure><p>è®°å½•æ¨¡å‹è¾“å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Plotting labels to runs/detect/train9/labels.jpg... </span><br><span class="line">optimizer: 'optimizer=auto' found, ignoring 'lr0=0.01' and 'momentum=0.937' and determining best 'optimizer', 'lr0' and 'momentum' automatically... </span><br><span class="line">optimizer: AdamW(lr=0.000714, momentum=0.9) with parameter groups 57 weight(decay=0.0), 64 weight(decay=0.0005), 63 bias(decay=0.0)</span><br><span class="line">Image sizes 640 train, 640 val</span><br><span class="line">Using 16 dataloader workers</span><br><span class="line">Logging results to runs/detect/train9</span><br></pre></td></tr></table></figure><p>è®­ç»ƒå¼€å§‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Starting training for 300 epochs...</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      1/300      1.38G      2.132      4.599       2.13          6        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:04&lt;00:00,  1.53s/it]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  3.10it/s]</span><br><span class="line">                   all         41         62    0.00191      0.349     0.0223     0.0121</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      2/300      1.44G      1.984      4.085      1.942         18        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  5.08it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.57it/s]</span><br><span class="line">                   all         41         62    0.00209      0.373     0.0247     0.0119</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      3/300      1.48G      2.421      4.407      2.348         14        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  5.78it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 10.23it/s]</span><br><span class="line">                   all         41         62    0.00205      0.373     0.0335     0.0165</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      4/300      1.48G      1.795      3.787      1.724         18        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  5.61it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  9.82it/s]</span><br><span class="line">                   all         41         62    0.00239      0.434     0.0445     0.0219</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">      5/300      1.48G      1.707      3.619      1.785         17        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  5.49it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  8.87it/s]</span><br><span class="line">                   all         41         62      0.003      0.495     0.0735     0.0283</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    295/300       1.5G     0.3742     0.5917     0.8247          7        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  7.21it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.40it/s]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.946</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    296/300      1.44G     0.4263     0.6716     0.8004          7        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  6.86it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.97it/s]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.945</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    297/300       1.5G      0.473     0.6775     0.8499          7        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  7.20it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.12it/s]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.945</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    298/300      1.51G     0.4877     0.6956     0.8936         11        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  6.73it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.03it/s]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.942</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    299/300       1.5G     0.4303      0.622     0.8264          6        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  6.89it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.62it/s]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.941</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">    300/300      1.44G     0.4593     0.6413     0.8419          6        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00,  6.31it/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 11.83it/s]</span><br><span class="line">                   all         41         62      0.995          1      0.995       0.94</span><br></pre></td></tr></table></figure><p>è®­ç»ƒç»“æŸï¼ŒéªŒè¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">300 epochs completed in 0.101 hours.</span><br><span class="line">Optimizer stripped from runs/detect/train9/weights/last.pt, 6.3MB</span><br><span class="line">Optimizer stripped from runs/detect/train9/weights/best.pt, 6.3MB</span><br><span class="line"></span><br><span class="line">Validating runs/detect/train9/weights/best.pt...</span><br><span class="line">Ultralytics YOLOv8.1.5 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                          CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">Model summary (fused): 168 layers, 3006038 parameters, 0 gradients, 8.1 GFLOPs</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:00&lt;00:00, 10.62it/s]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.946</span><br><span class="line">                  fire         41         41      0.999          1      0.995      0.938</span><br><span class="line">                 smoke         41         21      0.992          1      0.995      0.955</span><br><span class="line">Speed: 0.1ms preprocess, 1.4ms inference, 0.0ms loss, 1.0ms postprocess per image</span><br><span class="line">Results saved to runs/detect/train9</span><br><span class="line">Ultralytics YOLOv8.1.5 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">                                                          CUDA:1 (NVIDIA GeForce RTX 3090, 24260MiB)</span><br><span class="line">Model summary (fused): 168 layers, 3006038 parameters, 0 gradients, 8.1 GFLOPs</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:04&lt;00:00,  1.41s/it]</span><br><span class="line">                   all         41         62      0.996          1      0.995      0.941</span><br><span class="line">                  fire         41         41      0.999          1      0.995      0.939</span><br><span class="line">                 smoke         41         21      0.992          1      0.995      0.942</span><br><span class="line">Speed: 0.2ms preprocess, 14.3ms inference, 0.0ms loss, 16.8ms postprocess per image</span><br><span class="line">Results saved to runs/detect/train92</span><br></pre></td></tr></table></figure><h2 id="è¯„ä¼°"><a href="#è¯„ä¼°" class="headerlink" title="è¯„ä¼°"></a>è¯„ä¼°</h2><p>è¿›å…¥ä¿å­˜è®­ç»ƒç»“æœçš„æ–‡ä»¶å¤¹å†…ï¼Œå…¶ä¸­<code>weights</code>æ–‡ä»¶å¤¹åŒ…å«äº†æœ€ä½³è®­ç»ƒæ¨¡å‹å’Œæœ€è¿‘è®­ç»ƒæ¨¡å‹ï¼Œæ–‡ä»¶å¤¹å¤–å­˜å‚¨è®­ç»ƒçš„å„é¡¹è®°å½•å’Œæµ‹è¯•æ›²çº¿ç­‰</p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/6.png" alt></p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/7.png" alt></p><p><code>result.csv</code>æ–‡ä»¶ä¸­è®°å½•äº†300è½®epochçš„è¯¦ç»†ç»“æœ</p><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/8.png" alt></p><h2 id="é¢„æµ‹"><a href="#é¢„æµ‹" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h2><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºé¢„æµ‹è„šæœ¬<code>yolov8_test.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line">model = YOLO(<span class="string">'runs/detect/train9/weights/best.pt'</span>) <span class="comment"># æŒ‡å®šæœ€ä½³æ¨¡å‹</span></span><br><span class="line">model.predict(<span class="string">'video/fire.mp4'</span>, save=<span class="literal">True</span>, classes=[<span class="number">0</span>, <span class="number">1</span>]) <span class="comment"># æŒ‡å®šè¾“å‡ºç±»åˆ«</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">video 1/1 (1/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 208.5ms</span><br><span class="line">video 1/1 (2/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 9.6ms</span><br><span class="line">video 1/1 (3/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.9ms</span><br><span class="line">video 1/1 (4/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.9ms</span><br><span class="line">video 1/1 (5/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 8.0ms</span><br><span class="line">video 1/1 (6/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.8ms</span><br><span class="line">video 1/1 (7/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.7ms</span><br><span class="line">video 1/1 (8/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.6ms</span><br><span class="line">video 1/1 (9/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.9ms</span><br><span class="line">video 1/1 (10/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.8ms</span><br><span class="line">video 1/1 (11/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 8.1ms</span><br><span class="line">video 1/1 (12/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 8.1ms</span><br><span class="line">video 1/1 (13/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 8.2ms</span><br><span class="line">video 1/1 (14/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 8.0ms</span><br><span class="line">video 1/1 (15/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.7ms</span><br><span class="line">video 1/1 (16/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.8ms</span><br><span class="line">video 1/1 (17/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 (no detections), 7.6ms</span><br><span class="line">video 1/1 (18/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.6ms</span><br><span class="line">video 1/1 (19/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.8ms</span><br><span class="line">video 1/1 (20/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.6ms</span><br><span class="line">video 1/1 (21/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.8ms</span><br><span class="line">video 1/1 (22/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 2 fires, 7.7ms</span><br><span class="line">video 1/1 (23/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.6ms</span><br><span class="line">video 1/1 (24/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.5ms</span><br><span class="line">video 1/1 (25/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.7ms</span><br><span class="line">video 1/1 (26/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.5ms</span><br><span class="line">video 1/1 (27/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.4ms</span><br><span class="line">video 1/1 (28/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.6ms</span><br><span class="line">video 1/1 (29/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.8ms</span><br><span class="line">video 1/1 (30/306) /exp/work/video/yolov8/video/fire.mp4: 384x640 1 fire, 7.7ms</span><br><span class="line">...</span><br><span class="line">Speed: 2.2ms preprocess, 8.3ms inference, 3.8ms postprocess per image at shape (1, 3, 384, 640)</span><br><span class="line">Results saved to runs/detect/predict13</span><br></pre></td></tr></table></figure><p><img src="/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/fire.gif" alt></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&lt;/h2&gt;&lt;h3 id=&quot;GPU&quot;&gt;&lt;a href=&quot;#GPU&quot; class=&quot;headerlink&quot; title=&quot;GPU&quot;&gt;&lt;/a&gt;GPU&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;NVIDIA 3090*2&lt;/font&gt;&lt;/li&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;æ˜¾å¡é©±åŠ¨ 535.104.05&lt;/font&gt;&lt;/li&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;CUDAç‰ˆæœ¬ 12.2&lt;/font&gt;&lt;/li&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;CUDAtoolkit&lt;/font&gt; (cuda_12.2.2_535.104.05_linux)&lt;/li&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;cuDNN (v8.9.7)&lt;/font&gt;

&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;yoloç‰ˆæœ¬&quot;&gt;&lt;a href=&quot;#yoloç‰ˆæœ¬&quot; class=&quot;headerlink&quot; title=&quot;yoloç‰ˆæœ¬&quot;&gt;&lt;/a&gt;yoloç‰ˆæœ¬&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;v8.1.5&lt;/font&gt; (ultralytics yolov8)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;pytorchç‰ˆæœ¬&quot;&gt;&lt;a href=&quot;#pytorchç‰ˆæœ¬&quot; class=&quot;headerlink&quot; title=&quot;pytorchç‰ˆæœ¬&quot;&gt;&lt;/a&gt;pytorchç‰ˆæœ¬&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;v2.1.2&lt;/font&gt;

&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;pythonç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#pythonç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;pythonç¯å¢ƒ&quot;&gt;&lt;/a&gt;pythonç¯å¢ƒ&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;CentOS7.9&lt;/font&gt;
&lt;/li&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;anaconda3&lt;/font&gt;
&lt;/li&gt;
&lt;li&gt;&lt;font color=&quot;gold&quot;&gt;python3.9&lt;/font&gt;

&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h2&gt;&lt;p&gt;æºç ä¸»é¡µï¼š&lt;a href=&quot;https://github.com/ultralytics/ultralytics&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/ultralytics/ultralytics&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;https://docs.ultralytics.com/zh&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://docs.ultralytics.com/zh&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/01/25/yolov8ï¼šç«ç¾æ£€æµ‹/1.png&quot; alt&gt;&lt;/p&gt;
&lt;h3 id=&quot;å…‹éš†æºç &quot;&gt;&lt;a href=&quot;#å…‹éš†æºç &quot; class=&quot;headerlink&quot; title=&quot;å…‹éš†æºç &quot;&gt;&lt;/a&gt;å…‹éš†æºç &lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone https://hub.nuaa.cf/ultralytics/ultralytics.git&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;å®‰è£…ä¾èµ–&quot;&gt;&lt;a href=&quot;#å®‰è£…ä¾èµ–&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…ä¾èµ–&quot;&gt;&lt;/a&gt;å®‰è£…ä¾èµ–&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;pip install pip install ultralytics -i https://mirror.baidu.com/pypi/simple&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;ç¯å¢ƒéªŒè¯&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒéªŒè¯&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒéªŒè¯&quot;&gt;&lt;/a&gt;ç¯å¢ƒéªŒè¯&lt;/h3&gt;&lt;p&gt;python&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ultralytics&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ultralytics.checks()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;cli&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yolo predict model=yolov8n.pt source=ultralytics/assets/zidane.jpg&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æ‰§è¡Œå®Œæ¯•åå¾—åˆ°è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(py39_yolov8) [root@jdz yolov8]# yolo predict model=yolov8n.pt source=ultralytics/assets/zidane.jpg &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ultralytics YOLOv8.1.5 ğŸš€ Python-3.9.18 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 3090, 24260MiB)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;YOLOv8n summary (fused): 168 layers, 3151904 parameters, 0 gradients, 8.7 GFLOPs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;image 1/1 /exp/work/video/yolov8/ultralytics/assets/zidane.jpg: 384x640 2 persons, 1 tie, 216.9ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Speed: 7.3ms preprocess, 216.9ms inference, 762.4ms postprocess per image at shape (1, 3, 384, 640)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Results saved to runs/detect/predict&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ğŸ’¡ Learn more at https://docs.ultralytics.com/modes/predict&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å°†åœ¨&lt;code&gt;Results saved to runs/detect/predict&lt;/code&gt;ç›®å½•ä¸‹æ‰¾åˆ°è¾“å‡ºç»“æœ&lt;/p&gt;</summary>
    
    
    
    <category term="ç›®æ ‡æ£€æµ‹" scheme="http://yoursite.com/categories/ç›®æ ‡æ£€æµ‹/"/>
    
    
    <category term="yolov8" scheme="http://yoursite.com/tags/yolov8/"/>
    
    <category term="opencv" scheme="http://yoursite.com/tags/opencv/"/>
    
  </entry>
  
  <entry>
    <title>NetworkX: å›¾è®ºç®—æ³•åº”ç”¨</title>
    <link href="http://yoursite.com/2024/01/08/NetworkX-%E5%9B%BE%E8%AE%BA%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8/"/>
    <id>http://yoursite.com/2024/01/08/NetworkX-%E5%9B%BE%E8%AE%BA%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8/</id>
    <published>2024-01-08T07:48:56.000Z</published>
    <updated>2024-01-25T08:23:02.432Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="NetworkX"><a href="#NetworkX" class="headerlink" title="NetworkX"></a>NetworkX</h2><p>NetworkXæ˜¯ä¸€æ¬¾Pythonçš„è½¯ä»¶åŒ…ï¼Œç”¨äºåˆ›é€ ã€æ“ä½œå¤æ‚ç½‘ç»œï¼Œä»¥åŠå­¦ä¹ å¤æ‚ç½‘ç»œçš„ç»“æ„ã€åŠ¨åŠ›å­¦åŠå…¶åŠŸèƒ½ã€‚æœ‰äº†NetworkXå°±å¯ä»¥ç”¨æ ‡å‡†æˆ–è€…ä¸æ ‡å‡†çš„æ•°æ®æ ¼å¼åŠ è½½æˆ–è€…å­˜å‚¨ç½‘ç»œï¼Œå®ƒå¯ä»¥äº§ç”Ÿè®¸å¤šç§ç±»çš„éšæœºç½‘ç»œæˆ–ç»å…¸ç½‘ç»œï¼Œä¹Ÿå¯ä»¥åˆ†æç½‘ç»œç»“æ„ã€å»ºç«‹ç½‘ç»œæ¨¡å‹ã€è®¾è®¡æ–°çš„ç½‘ç»œç®—æ³•ã€ç»˜åˆ¶ç½‘ç»œç­‰</p><p>å‚è€ƒæ–‡çŒ®åœ°å€: <a href="https://www.osgeo.cn/networkx/reference/index.html" target="_blank" rel="noopener">https://www.osgeo.cn/networkx/reference/index.html</a></p><h2 id="å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ"><a href="#å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ" class="headerlink" title="å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ"></a>å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ</h2><h3 id="1-nebula-spark"><a href="#1-nebula-spark" class="headerlink" title="1.nebula + spark"></a>1.nebula + spark</h3><p>ä¾èµ–nebula-spark-connectoråŒ…ã€nebula-algorithmåŒ…å’Œsparké›†ç¾¤çš„æ•°æ®è¯»å–ã€å›¾è®¡ç®—æ–¹å¼</p><h3 id="2-clickhouse-NetworkX"><a href="#2-clickhouse-NetworkX" class="headerlink" title="2.clickhouse + NetworkX"></a>2.clickhouse + NetworkX</h3><p>ç”±äºnebula-algorithmä¾èµ–sparké›†ç¾¤ï¼Œä¸”nebula-consoleåŸç”Ÿçš„æ•°æ®è¯»å–èƒ½åŠ›ä¸ä½³ï¼Œåœ¨ç¯å¢ƒå—é™ä¸”è®¡ç®—é‡æœ‰é™çš„æƒ…å†µä¸‹ä¼˜å…ˆè€ƒè™‘è·³è¿‡sparké›†ç¾¤å’Œnebulaå›¾åº“ï¼Œé‡‡ç”¨clickhouse + NetworkXçš„å›¾è®¡ç®—æ–¹å¼ï¼Œå…¶ä¸­clickhouseæ˜¯å­˜å‚¨äº†nebulaæºæ•°æ®çš„åˆ—å¼åˆ†å¸ƒå¼è¡¨ï¼Œä½œç”¨ç±»ä¼¼äºæ–¹æ³•1ä¸­å°†nebulaé›†ç¾¤æ•°æ®é€šè¿‡nebula-spark-connectoråŒ…å¯¼å…¥ä¸ºspark-DataFrameï¼Œä»…ç”¨åšæ•°æ®è¯»å–ï¼Œå†é€šè¿‡å°†æ•°æ®è½¬åŒ–ä¸ºNetworkXçš„å›¾ç»“æ„è¿›è¡Œå›¾è®¡ç®—</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/9.png" alt></p><a id="more"></a><h2 id="åº”ç”¨å®ä¾‹"><a href="#åº”ç”¨å®ä¾‹" class="headerlink" title="åº”ç”¨å®ä¾‹"></a>åº”ç”¨å®ä¾‹</h2><p>nebulaé›†ç¾¤å­˜å‚¨ä»¥ç¾¤èŠå’Œç¾¤æˆå‘˜ã€å¥½å‹å…³ç³»æ‰€ç»„æˆçš„å…³ç³»ç½‘ï¼Œclickhouseé›†ç¾¤å­˜å‚¨èŠ‚ç‚¹æºæ•°æ®å’Œå¯¹åº”å…³ç³»</p><h3 id="ä¸€ã€é›†åˆè¿ç®—"><a href="#ä¸€ã€é›†åˆè¿ç®—" class="headerlink" title="ä¸€ã€é›†åˆè¿ç®—"></a>ä¸€ã€é›†åˆè¿ç®—</h3><p>äº¤ã€å¹¶ã€å·®é›†</p><p>ç›´æ¥ä½¿ç”¨clickhouseè¿›è¡ŒæŸ¥è¯¢ï¼Œé€‚ç”¨äºä¸¤ä¸ªç¾¤ç»„æˆå‘˜æˆ–è´¦å·æ‰€åŠ ç¾¤çš„äº¤å¹¶å·®é›†</p><p><strong>è¾“å…¥ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> nä¸ªè´¦å·ï¼ˆnâ‰¥2ï¼‰</p><p><strong><font color="gold">Â·</font></strong> nä¸ªç¾¤ç»„ï¼ˆnâ‰¥2ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/1.png" alt></p><h3 id="äºŒã€è·¯å¾„æ¢å¯»"><a href="#äºŒã€è·¯å¾„æ¢å¯»" class="headerlink" title="äºŒã€è·¯å¾„æ¢å¯»"></a>äºŒã€è·¯å¾„æ¢å¯»</h3><p>ç›´æ¥ä½¿ç”¨nebulaè¿›è¡ŒæŸ¥è¯¢ï¼Œé€‚ç”¨äºæœç´¢å›¾è°±ä¸­ä»»æ„ä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€çŸ­å¯è¾¾è·¯å¾„</p><p><strong>è¾“å…¥ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> ä»»æ„ç±»å‹2ä¸ªèŠ‚ç‚¹</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/2.png" alt></p><h3 id="ä¸‰ã€ä¸­å¿ƒæ€§"><a href="#ä¸‰ã€ä¸­å¿ƒæ€§" class="headerlink" title="ä¸‰ã€ä¸­å¿ƒæ€§"></a>ä¸‰ã€ä¸­å¿ƒæ€§</h3><p><strong>è¾“å…¥ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> nä¸ªç¾¤ç»„ï¼ˆnâ‰¥1ï¼‰ï¼Œåˆ†æåŒ…æ‹¬æŒ‡å®šnä¸ªç¾¤ç»„ã€ç¾¤ç»„ç¾¤æˆå‘˜ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤ç»„æˆå…³ç³»ç½‘å„èŠ‚ç‚¹çš„ä¸­å¿ƒæ€§</p><p><strong><font color="gold">Â·</font></strong> nä¸ªè´¦å·ï¼ˆnâ‰¥1ï¼‰ï¼Œåˆ†æåŒ…æ‹¬æŒ‡å®šnä¸ªè´¦å·ã€è´¦å·æ‰€åŠ ç¾¤ã€ç¾¤æˆå‘˜ç»„æˆå…³ç³»ç½‘å„èŠ‚ç‚¹çš„ä¸­å¿ƒæ€§</p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šå…³ç³»ç½‘ï¼Œåˆ†æå„èŠ‚ç‚¹ä¸­å¿ƒæ€§</p><p><strong>ClickHouse SQLç¤ºä¾‹ï¼ˆå…³ç³»å›¾è°±ï¼‰ï¼š</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  team_id,account_id <span class="keyword">FROM</span> mqv3.ly_team_ship lts </span><br><span class="line">PREWHERE account_id <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> </span><br><span class="line">(<span class="keyword">SELECT</span> account_id <span class="keyword">FROM</span> mqv3.ly_team_ship lts PREWHERE team_id=<span class="string">'&#123;src_vid&#125;'</span>);</span><br></pre></td></tr></table></figure><h4 id="1-åº¦ä¸­å¿ƒæ€§"><a href="#1-åº¦ä¸­å¿ƒæ€§" class="headerlink" title="1.åº¦ä¸­å¿ƒæ€§"></a>1.åº¦ä¸­å¿ƒæ€§</h4><p>è¡¡é‡èŠ‚ç‚¹ä¸­å¿ƒæ€§çš„æŒ‡æ ‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = nx.degree_centrality(G)</span><br><span class="line">res = dict(sorted(res.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹åº¦ä¸­å¿ƒæ€§ï¼ˆæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/3.png" alt></p><h4 id="2-æ¥è¿‘ä¸­å¿ƒæ€§"><a href="#2-æ¥è¿‘ä¸­å¿ƒæ€§" class="headerlink" title="2.æ¥è¿‘ä¸­å¿ƒæ€§"></a>2.æ¥è¿‘ä¸­å¿ƒæ€§</h4><p>åæ˜ åœ¨å…³ç³»ç½‘ç»œä¸­æŸä¸€èŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹ä¹‹é—´çš„æ¥è¿‘ç¨‹åº¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = nx.closeness_centrality(G)</span><br><span class="line">res = dict(sorted(res.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹æ¥è¿‘ä¸­å¿ƒæ€§ï¼ˆæŠ›å¼ƒåº¦&lt;50çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/4.png" alt></p><h4 id="3-ä¸­ä»‹ä¸­å¿ƒæ€§"><a href="#3-ä¸­ä»‹ä¸­å¿ƒæ€§" class="headerlink" title="3.ä¸­ä»‹ä¸­å¿ƒæ€§"></a>3.ä¸­ä»‹ä¸­å¿ƒæ€§</h4><p>ä»¥ç»è¿‡æŸä¸ªèŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„æ•°ç›®æ¥åˆ»ç”»èŠ‚ç‚¹é‡è¦æ€§çš„æŒ‡æ ‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = nx.betweenness_centrality(G, k=<span class="number">1000</span>)</span><br><span class="line">res = dict(sorted(res.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹ä¸­ä»‹ä¸­å¿ƒæ€§ï¼ˆæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/5.png" alt></p><h4 id="4-ç‰¹å¾å‘é‡ä¸­å¿ƒæ€§"><a href="#4-ç‰¹å¾å‘é‡ä¸­å¿ƒæ€§" class="headerlink" title="4.ç‰¹å¾å‘é‡ä¸­å¿ƒæ€§"></a>4.ç‰¹å¾å‘é‡ä¸­å¿ƒæ€§</h4><p>å…³ç³»ç½‘ç»œä¸­ä¸€ä¸ªèŠ‚ç‚¹çš„é‡è¦æ€§æ—¢å–å†³äºå…¶é‚»å±…èŠ‚ç‚¹çš„æ•°é‡ï¼ˆå³è¯¥èŠ‚ç‚¹çš„åº¦ï¼‰ï¼Œä¹Ÿå–å†³äºå…¶é‚»å±…èŠ‚ç‚¹çš„é‡è¦æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = nx.eigenvector_centrality(G)</span><br><span class="line">res = dict(sorted(res.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹ç‰¹å¾å‘é‡ä¸­å¿ƒæ€§ï¼ˆæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/6.png" alt></p><h3 id="å››ã€é‡è¦æ€§"><a href="#å››ã€é‡è¦æ€§" class="headerlink" title="å››ã€é‡è¦æ€§"></a>å››ã€é‡è¦æ€§</h3><p><strong>è¾“å…¥ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> nä¸ªç¾¤ç»„ï¼ˆnâ‰¥1ï¼‰ï¼Œåˆ†æåŒ…æ‹¬æŒ‡å®šnä¸ªç¾¤ç»„ã€ç¾¤ç»„ç¾¤æˆå‘˜ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤ç»„æˆå…³ç³»ç½‘å„èŠ‚ç‚¹çš„é‡è¦ç¨‹åº¦</p><p><strong><font color="gold">Â·</font></strong> nä¸ªè´¦å·ï¼ˆnâ‰¥1ï¼‰ï¼Œåˆ†æåŒ…æ‹¬æŒ‡å®šnä¸ªè´¦å·ã€è´¦å·æ‰€åŠ ç¾¤ã€ç¾¤æˆå‘˜ç»„æˆå…³ç³»ç½‘å„èŠ‚ç‚¹çš„é‡è¦ç¨‹åº¦</p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šå…³ç³»ç½‘ï¼Œåˆ†æå„èŠ‚ç‚¹çš„é‡è¦ç¨‹åº¦</p><h4 id="1-kæ ¸"><a href="#1-kæ ¸" class="headerlink" title="1.kæ ¸"></a>1.kæ ¸</h4><p>ç”¨äºåœ¨å›¾ä¸­å¯»æ‰¾ç¬¦åˆä¸€å®šç´§å¯†å…³ç³»æ¡ä»¶ï¼ˆKï¼‰çš„å­å›¾ç»“æ„çš„ç®—æ³•ï¼Œè¦æ±‚æ¯ä¸ªé¡¶ç‚¹è‡³å°‘ä¸è¯¥å­å›¾çš„å…¶ä»–Kä¸ªé¡¶ç‚¹å…³è”</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">res1 = nx.core_number(G)</span><br><span class="line">res2 = nx.k_core(G, <span class="number">6</span>)</span><br><span class="line">res1 = dict(sorted(res1.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res1)</span><br><span class="line">print(list(res2))</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹k-coreå€¼ï¼Œç»“åˆlouvainç¤¾åŒºä¸Šè‰²ï¼ˆå…¨å›¾ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/7.png" alt></p><h4 id="2-PageRank"><a href="#2-PageRank" class="headerlink" title="2.PageRank"></a>2.PageRank</h4><p>è¡¡é‡å›¾ä¸­èŠ‚ç‚¹é‡è¦æ€§çš„æŒ‡æ ‡ï¼Œå€¼è¶Šé«˜ï¼Œå›¾ä¸­è®¿é—®è¯¥èŠ‚ç‚¹çš„æ¦‚ç‡è¶Šé«˜</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = nx.pagerank(G, alpha=<span class="number">0.85</span>)</span><br><span class="line">res = dict(sorted(res.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.1.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹pagerankå€¼ï¼ˆæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/8.png" alt></p><p><strong>e.g.2.</strong> ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—ä¸‰çº§å…³ç³»ç½‘å„èŠ‚ç‚¹pagerankå€¼ï¼Œç»“åˆlouvainç¤¾åŒºï¼ˆå…¨å›¾ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/9.png" alt></p><h3 id="äº”ã€èšç±»ç®—æ³•"><a href="#äº”ã€èšç±»ç®—æ³•" class="headerlink" title="äº”ã€èšç±»ç®—æ³•"></a>äº”ã€èšç±»ç®—æ³•</h3><p><strong>è¾“å…¥ï¼ˆç¤¾åŒºå‘ç°ï¼‰ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> nä¸ªç¾¤ç»„ï¼ˆnâ‰¥1ï¼‰ï¼Œåˆ’åˆ†åŒ…æ‹¬æŒ‡å®šnä¸ªç¾¤ç»„ã€ç¾¤ç»„ç¾¤æˆå‘˜ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤ç»„æˆå…³ç³»ç½‘çš„å„ä¸ªç¤¾åŒº</p><p><strong><font color="gold">Â·</font></strong> nä¸ªè´¦å·ï¼ˆnâ‰¥1ï¼‰ï¼Œåˆ’åˆ†åŒ…æ‹¬æŒ‡å®šnä¸ªè´¦å·ã€è´¦å·æ‰€åŠ ç¾¤ã€ç¾¤æˆå‘˜ç»„æˆå…³ç³»ç½‘çš„å„ä¸ªç¤¾åŒº</p><p><strong><font color="gold">Â·</font></strong> åˆ’åˆ†æŒ‡å®šå…³ç³»ç½‘å„èŠ‚ç‚¹çš„ç¤¾åŒº</p><p><strong>è¾“å…¥ï¼ˆä¸‰è§’å½¢è®¡æ•°ï¼‰ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> nä¸ªç¾¤ç»„ï¼ˆnâ‰¥1ï¼‰ï¼Œè®¡ç®—åŒ…æ‹¬æŒ‡å®šnä¸ªç¾¤ç»„ã€ç¾¤ç»„ç¾¤æˆå‘˜ã€ç¾¤æˆå‘˜å¥½å‹ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤ç»„ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤ç»„æˆå…³ç³»ç½‘çš„ä¸‰è§’å½¢æ•°é‡ï¼ŒæŒ–æ˜å›¢ä½“å…³ç³»</p><p><strong><font color="gold">Â·</font></strong> è®¡ç®—æŒ‡å®šå…³ç³»ç½‘å„èŠ‚ç‚¹çš„ä¸‰è§’å½¢æ•°é‡ï¼ŒæŒ–æ˜å›¢ä½“å…³ç³»</p><p>ç”¨äºè®¡ç®—å›¾è°±ä¸­ä¸‰è§’å…³ç³»æ•°é‡ï¼ŒæŒ–æ˜å…³ç³»å›¢ä½“</p><p><strong>ClickHouse SQLç¤ºä¾‹ï¼ˆä¸‰è§’å½¢è®¡æ•°ï¼‰ï¼š</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> T <span class="keyword">AS</span>(<span class="comment">-- æŒ‡å®šç¾¤ç¾¤æˆå‘˜</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> team_id,account_id <span class="keyword">FROM</span> mqv3.ly_team_ship PREWHERE team_id = <span class="string">'&#123;src_vid&#125;'</span></span><br><span class="line">),T1 <span class="keyword">AS</span>(<span class="comment">-- æŒ‡å®šç¾¤ç¾¤æˆå‘˜çš„å¥½å‹</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> account_id,fri_account_id <span class="keyword">FROM</span> mqv3.ly_account_ship PREWHERE account_id <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> account_id <span class="keyword">FROM</span> T) </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">DISTINCT</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> fri_account_id,account_id <span class="keyword">FROM</span> mqv3.ly_account_ship PREWHERE fri_account_id <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> account_id <span class="keyword">FROM</span> T)</span><br><span class="line">),T2 <span class="keyword">AS</span>(<span class="comment">-- ç¾¤æˆå‘˜æ‰€åŠ ç¾¤</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> team_id,account_id <span class="keyword">FROM</span> mqv3.ly_team_ship PREWHERE account_id <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> account_id <span class="keyword">FROM</span> T)</span><br><span class="line">),T3 <span class="keyword">AS</span>(<span class="comment">-- ç¾¤æˆå‘˜æ‰€åŠ ç¾¤å’Œç¾¤æˆå‘˜å’Œç¾¤æˆå‘˜çš„å¥½å‹</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> team_id,account_id,fri_account_id <span class="keyword">FROM</span> T2 <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> T1 <span class="keyword">ON</span> T2.account_id = T1.account_id</span><br><span class="line">),T4 <span class="keyword">AS</span>(<span class="comment">-- ç¾¤æˆå‘˜å¥½å‹æ‰€åŠ ç¾¤</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> team_id,account_id <span class="keyword">AS</span> fri_account_id <span class="keyword">FROM</span> mqv3.ly_team_ship lts PREWHERE lts.account_id <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> fri_account_id <span class="keyword">FROM</span> T1)</span><br><span class="line">),T5 <span class="keyword">AS</span>(<span class="comment">-- å…±åŒæ‰€åŠ ç¾¤</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> team_id,account_id,fri_account_id <span class="keyword">FROM</span> T3 <span class="keyword">JOIN</span> T4 <span class="keyword">ON</span> (T3.team_id = T4.team_id <span class="keyword">AND</span> T3.fri_account_id = T4.fri_account_id)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">DISTINCT</span> team_id,account_id,fri_account_id <span class="keyword">from</span> T5</span><br></pre></td></tr></table></figure><h4 id="1-æ ‡ç­¾ä¼ æ’­ï¼ˆLPAç¤¾åŒºå‘ç°ï¼‰"><a href="#1-æ ‡ç­¾ä¼ æ’­ï¼ˆLPAç¤¾åŒºå‘ç°ï¼‰" class="headerlink" title="1.æ ‡ç­¾ä¼ æ’­ï¼ˆLPAç¤¾åŒºå‘ç°ï¼‰"></a>1.æ ‡ç­¾ä¼ æ’­ï¼ˆLPAç¤¾åŒºå‘ç°ï¼‰</h4><p>åŸºäºlpaçš„ç¤¾åŒºåˆ’åˆ†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = nx.algorithms.community.label_propagation_communities(G)</span><br><span class="line">print(list(res))</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong>ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œåˆ’åˆ†lpaæ ‡ç­¾ä¼ æ’­ç¤¾åŒºï¼ˆæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/10.png" alt></p><h4 id="2-é²æ±¶ï¼ˆLouvainç¤¾åŒºå‘ç°ï¼‰"><a href="#2-é²æ±¶ï¼ˆLouvainç¤¾åŒºå‘ç°ï¼‰" class="headerlink" title="2.é²æ±¶ï¼ˆLouvainç¤¾åŒºå‘ç°ï¼‰"></a>2.é²æ±¶ï¼ˆLouvainç¤¾åŒºå‘ç°ï¼‰</h4><p>åŸºäºlouvainçš„ç¤¾åŒºåˆ’åˆ†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = nx.algorithms.community.louvain_communities(G, resolution=<span class="number">0.5</span>)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.1.</strong>ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œåˆ’åˆ†louvainé²æ±¶ç¤¾åŒºï¼ˆresolution=1ï¼ŒæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/11.png" alt></p><p><strong>e.g.2.</strong>ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œåˆ’åˆ†louvainé²æ±¶ç¤¾åŒºï¼ˆresolution=0.3ï¼ŒæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/12.png" alt></p><h4 id="3-ä¸‰è§’å½¢è®¡æ•°"><a href="#3-ä¸‰è§’å½¢è®¡æ•°" class="headerlink" title="3.ä¸‰è§’å½¢è®¡æ•°"></a>3.ä¸‰è§’å½¢è®¡æ•°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = nx.triangles(G)</span><br><span class="line">res = dict(sorted(res.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p><strong>e.g.</strong>ä»¥ç¾¤ï¼ˆ-1151413367ã€-1541749047ï¼‰ä¸ºæŒ‡å®šèŠ‚ç‚¹ï¼Œè®¡ç®—å…³ç³»ç½‘ä¸­å„ä¸ªèŠ‚ç‚¹ä¸‰è§’å½¢æ•°é‡ï¼ˆæŠ›å¼ƒåº¦&lt;5çš„èŠ‚ç‚¹ï¼Œçªå‡ºç»“æ„ï¼‰</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/13.png" alt></p><h3 id="å…­ã€è¿é€šæ€§"><a href="#å…­ã€è¿é€šæ€§" class="headerlink" title="å…­ã€è¿é€šæ€§"></a>å…­ã€è¿é€šæ€§</h3><p><strong>è¾“å…¥ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šnä¸ªç¾¤ç»„ï¼ˆnâ‰¥2ï¼‰ï¼Œåˆ¤æ–­ç¾¤ç»„ã€ç¾¤æˆå‘˜ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤æ‰€ç»„å…³ç³»ç½‘æ˜¯å¦ä¸ºè¿é€šå›¾</p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šnä¸ªè´¦å·ï¼ˆnâ‰¥2ï¼‰ï¼Œåˆ¤æ–­è´¦å·ã€è´¦å·æ‰€åŠ ç¾¤ã€ç¾¤æˆå‘˜æ‰€ç»„å…³ç³»ç½‘æ˜¯å¦ä¸ºè¿é€šå›¾</p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šå…³ç³»ç½‘</p><h4 id="1-è¿é€šæ€§æ£€æµ‹"><a href="#1-è¿é€šæ€§æ£€æµ‹" class="headerlink" title="1.è¿é€šæ€§æ£€æµ‹"></a>1.è¿é€šæ€§æ£€æµ‹</h4><p>åˆ¤æ–­ç›®æ ‡å›¾è°±æ˜¯å¦ä¸ºè¿é€šå›¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res1 = nx.is_connected(G)</span><br><span class="line">print(res1)</span><br></pre></td></tr></table></figure><p><strong>e.g.1.</strong>è¿é€šå›¾</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/14.png" alt></p><p><strong>e.g.2.</strong>éè¿é€šå›¾</p><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/15.png" alt></p><h4 id="2-è”é€šç»„ä»¶æ•°"><a href="#2-è”é€šç»„ä»¶æ•°" class="headerlink" title="2.è”é€šç»„ä»¶æ•°"></a>2.è”é€šç»„ä»¶æ•°</h4><p>åˆ¤æ–­ç›®æ ‡å›¾è°±ä¸­è”é€šç»„ä»¶çš„æ•°é‡ï¼ˆnï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res2 = nx.number_connected_components(G)</span><br><span class="line">print(res2)</span><br></pre></td></tr></table></figure><h4 id="3-è”é€šç»„ä»¶"><a href="#3-è”é€šç»„ä»¶" class="headerlink" title="3.è”é€šç»„ä»¶"></a>3.è”é€šç»„ä»¶</h4><p>æ˜¾ç¤ºç›®æ ‡å›¾è°±ä¸­çš„å…¨éƒ¨è”é€šç»„ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res3 = nx.connected_components(G)</span><br><span class="line">print(res3)</span><br></pre></td></tr></table></figure><h4 id="4-æŒ‡å®šèŠ‚ç‚¹è”é€šç»„ä»¶"><a href="#4-æŒ‡å®šèŠ‚ç‚¹è”é€šç»„ä»¶" class="headerlink" title="4.æŒ‡å®šèŠ‚ç‚¹è”é€šç»„ä»¶"></a>4.æŒ‡å®šèŠ‚ç‚¹è”é€šç»„ä»¶</h4><p>æ˜¾ç¤ºç›®æ ‡å›¾è°±ä¸­æŒ‡å®šèŠ‚ç‚¹æ‰€åœ¨çš„è”é€šç»„ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res4 = nx.node_connected_component(G, <span class="string">"sample_node"</span>)</span><br><span class="line">print(res4)</span><br></pre></td></tr></table></figure><h3 id="ä¸ƒã€å‡ ä½•"><a href="#ä¸ƒã€å‡ ä½•" class="headerlink" title="ä¸ƒã€å‡ ä½•"></a>ä¸ƒã€å‡ ä½•</h3><p><strong>è¾“å…¥ï¼š</strong></p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šnä¸ªç¾¤ç»„ï¼ˆnâ‰¥2ï¼‰ï¼Œè®¡ç®—ç¾¤ç»„ã€ç¾¤æˆå‘˜ã€ç¾¤æˆå‘˜æ‰€åŠ ç¾¤æ‰€ç»„å…³ç³»ç½‘çš„ä¸­å¿ƒã€é‡å¿ƒ</p><p><strong><font color="gold">Â·</font></strong> æŒ‡å®šnä¸ªè´¦å·ï¼ˆnâ‰¥2ï¼‰ï¼Œè®¡ç®—è´¦å·ã€è´¦å·æ‰€åŠ ç¾¤ã€ç¾¤æˆå‘˜æ‰€ç»„å…³ç³»ç½‘çš„ä¸­å¿ƒã€é‡å¿ƒ</p><p><strong><font color="gold">Â·</font></strong> è®¡ç®—æŒ‡å®šå…³ç³»ç½‘å‡ ä½•ä¸­å¿ƒã€é‡å¿ƒ</p><h4 id="1-å‡ ä½•é‡å¿ƒ"><a href="#1-å‡ ä½•é‡å¿ƒ" class="headerlink" title="1.å‡ ä½•é‡å¿ƒ"></a>1.å‡ ä½•é‡å¿ƒ</h4><p>å›¾çš„é‡å¿ƒèŠ‚ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res1 = nx.barycenter(G)</span><br><span class="line">print(res1)</span><br></pre></td></tr></table></figure><h4 id="2-å‡ ä½•ä¸­å¿ƒ"><a href="#2-å‡ ä½•ä¸­å¿ƒ" class="headerlink" title="2.å‡ ä½•ä¸­å¿ƒ"></a>2.å‡ ä½•ä¸­å¿ƒ</h4><p>å›¾çš„ä¸­å¿ƒèŠ‚ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res2 = nx.center(G)</span><br><span class="line">print(res2)</span><br></pre></td></tr></table></figure><h2 id="ç»˜å›¾"><a href="#ç»˜å›¾" class="headerlink" title="ç»˜å›¾"></a>ç»˜å›¾</h2><p><strong>e.g.</strong> ä¸­å¿ƒä¸­å¿ƒæ€§ + LPAæ ‡ç­¾ä¼ æ’­ç®—æ³•èšç±»</p><p>æ•°æ®æºï¼š<a href="https://www.inetbio.org/wormnet/downloadnetwork.php" target="_blank" rel="noopener">https://www.inetbio.org/wormnet/downloadnetwork.php</a></p><p><strong><font color="gold">Â·</font></strong> WormNet v.3-GS (<a href="https://www.inetbio.org/wormnet/download.php?type=2" target="_blank" rel="noopener">https://www.inetbio.org/wormnet/download.php?type=2</a>)</p><p> å®Œæ•´ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> sample</span><br><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gold standard data of positive gene functional associations</span></span><br><span class="line"><span class="comment"># from https://www.inetbio.org/wormnet/downloadnetwork.php</span></span><br><span class="line">G = nx.read_edgelist(<span class="string">"WormNet.v3.benchmark.txt"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove randomly selected nodes (to make example fast)</span></span><br><span class="line">num_to_remove = int(len(G) / <span class="number">1.5</span>)</span><br><span class="line">nodes = sample(list(G.nodes), num_to_remove)</span><br><span class="line">G.remove_nodes_from(nodes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove low-degree nodes</span></span><br><span class="line">low_degree = [n <span class="keyword">for</span> n, d <span class="keyword">in</span> G.degree() <span class="keyword">if</span> d &lt; <span class="number">10</span>]</span><br><span class="line">G.remove_nodes_from(low_degree)</span><br><span class="line"></span><br><span class="line"><span class="comment"># largest connected component</span></span><br><span class="line">components = nx.connected_components(G)</span><br><span class="line">largest_component = max(components, key=len)</span><br><span class="line">H = G.subgraph(largest_component)</span><br><span class="line"></span><br><span class="line"><span class="comment"># compute centrality</span></span><br><span class="line">centrality = nx.betweenness_centrality(H, k=<span class="number">10</span>, endpoints=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># compute community structure</span></span><br><span class="line">lpc = nx.community.label_propagation_communities(H)</span><br><span class="line">community_index = &#123;n: i <span class="keyword">for</span> i, com <span class="keyword">in</span> enumerate(lpc) <span class="keyword">for</span> n <span class="keyword">in</span> com&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#### draw graph ####</span></span><br><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">20</span>, <span class="number">15</span>))</span><br><span class="line">pos = nx.spring_layout(H, k=<span class="number">0.15</span>, seed=<span class="number">4572321</span>)</span><br><span class="line">node_color = [community_index[n] <span class="keyword">for</span> n <span class="keyword">in</span> H]</span><br><span class="line">node_size = [v * <span class="number">20000</span> <span class="keyword">for</span> v <span class="keyword">in</span> centrality.values()]</span><br><span class="line">nx.draw_networkx(</span><br><span class="line">    H,</span><br><span class="line">    pos=pos,</span><br><span class="line">    with_labels=<span class="literal">False</span>,</span><br><span class="line">    node_color=node_color,</span><br><span class="line">    node_size=node_size,</span><br><span class="line">    edge_color=<span class="string">"gainsboro"</span>,</span><br><span class="line">    alpha=<span class="number">0.4</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Title/legend</span></span><br><span class="line">font = &#123;<span class="string">"color"</span>: <span class="string">"k"</span>, <span class="string">"fontweight"</span>: <span class="string">"bold"</span>, <span class="string">"fontsize"</span>: <span class="number">20</span>&#125;</span><br><span class="line">ax.set_title(<span class="string">"Gene functional association network (C. elegans)"</span>, font)</span><br><span class="line"><span class="comment"># Change font color for legend</span></span><br><span class="line">font[<span class="string">"color"</span>] = <span class="string">"r"</span></span><br><span class="line"></span><br><span class="line">ax.text(</span><br><span class="line">    <span class="number">0.80</span>,</span><br><span class="line">    <span class="number">0.10</span>,</span><br><span class="line">    <span class="string">"node color = community structure"</span>,</span><br><span class="line">    horizontalalignment=<span class="string">"center"</span>,</span><br><span class="line">    transform=ax.transAxes,</span><br><span class="line">    fontdict=font,</span><br><span class="line">)</span><br><span class="line">ax.text(</span><br><span class="line">    <span class="number">0.80</span>,</span><br><span class="line">    <span class="number">0.06</span>,</span><br><span class="line">    <span class="string">"node size = betweeness centrality"</span>,</span><br><span class="line">    horizontalalignment=<span class="string">"center"</span>,</span><br><span class="line">    transform=ax.transAxes,</span><br><span class="line">    fontdict=font,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resize figure for label readibility</span></span><br><span class="line">ax.margins(<span class="number">0.1</span>, <span class="number">0.05</span>)</span><br><span class="line">fig.tight_layout()</span><br><span class="line">plt.axis(<span class="string">"off"</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/16.png" alt></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;NetworkX&quot;&gt;&lt;a href=&quot;#NetworkX&quot; class=&quot;headerlink&quot; title=&quot;NetworkX&quot;&gt;&lt;/a&gt;NetworkX&lt;/h2&gt;&lt;p&gt;NetworkXæ˜¯ä¸€æ¬¾Pythonçš„è½¯ä»¶åŒ…ï¼Œç”¨äºåˆ›é€ ã€æ“ä½œå¤æ‚ç½‘ç»œï¼Œä»¥åŠå­¦ä¹ å¤æ‚ç½‘ç»œçš„ç»“æ„ã€åŠ¨åŠ›å­¦åŠå…¶åŠŸèƒ½ã€‚æœ‰äº†NetworkXå°±å¯ä»¥ç”¨æ ‡å‡†æˆ–è€…ä¸æ ‡å‡†çš„æ•°æ®æ ¼å¼åŠ è½½æˆ–è€…å­˜å‚¨ç½‘ç»œï¼Œå®ƒå¯ä»¥äº§ç”Ÿè®¸å¤šç§ç±»çš„éšæœºç½‘ç»œæˆ–ç»å…¸ç½‘ç»œï¼Œä¹Ÿå¯ä»¥åˆ†æç½‘ç»œç»“æ„ã€å»ºç«‹ç½‘ç»œæ¨¡å‹ã€è®¾è®¡æ–°çš„ç½‘ç»œç®—æ³•ã€ç»˜åˆ¶ç½‘ç»œç­‰&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡çŒ®åœ°å€: &lt;a href=&quot;https://www.osgeo.cn/networkx/reference/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.osgeo.cn/networkx/reference/index.html&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ&quot;&gt;&lt;a href=&quot;#å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ&quot; class=&quot;headerlink&quot; title=&quot;å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ&quot;&gt;&lt;/a&gt;å›¾è®¡ç®—åº”ç”¨æ–¹å¼æ¯”è¾ƒ&lt;/h2&gt;&lt;h3 id=&quot;1-nebula-spark&quot;&gt;&lt;a href=&quot;#1-nebula-spark&quot; class=&quot;headerlink&quot; title=&quot;1.nebula + spark&quot;&gt;&lt;/a&gt;1.nebula + spark&lt;/h3&gt;&lt;p&gt;ä¾èµ–nebula-spark-connectoråŒ…ã€nebula-algorithmåŒ…å’Œsparké›†ç¾¤çš„æ•°æ®è¯»å–ã€å›¾è®¡ç®—æ–¹å¼&lt;/p&gt;
&lt;h3 id=&quot;2-clickhouse-NetworkX&quot;&gt;&lt;a href=&quot;#2-clickhouse-NetworkX&quot; class=&quot;headerlink&quot; title=&quot;2.clickhouse + NetworkX&quot;&gt;&lt;/a&gt;2.clickhouse + NetworkX&lt;/h3&gt;&lt;p&gt;ç”±äºnebula-algorithmä¾èµ–sparké›†ç¾¤ï¼Œä¸”nebula-consoleåŸç”Ÿçš„æ•°æ®è¯»å–èƒ½åŠ›ä¸ä½³ï¼Œåœ¨ç¯å¢ƒå—é™ä¸”è®¡ç®—é‡æœ‰é™çš„æƒ…å†µä¸‹ä¼˜å…ˆè€ƒè™‘è·³è¿‡sparké›†ç¾¤å’Œnebulaå›¾åº“ï¼Œé‡‡ç”¨clickhouse + NetworkXçš„å›¾è®¡ç®—æ–¹å¼ï¼Œå…¶ä¸­clickhouseæ˜¯å­˜å‚¨äº†nebulaæºæ•°æ®çš„åˆ—å¼åˆ†å¸ƒå¼è¡¨ï¼Œä½œç”¨ç±»ä¼¼äºæ–¹æ³•1ä¸­å°†nebulaé›†ç¾¤æ•°æ®é€šè¿‡nebula-spark-connectoråŒ…å¯¼å…¥ä¸ºspark-DataFrameï¼Œä»…ç”¨åšæ•°æ®è¯»å–ï¼Œå†é€šè¿‡å°†æ•°æ®è½¬åŒ–ä¸ºNetworkXçš„å›¾ç»“æ„è¿›è¡Œå›¾è®¡ç®—&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2024/01/08/NetworkX-å›¾è®ºç®—æ³•åº”ç”¨/9.png&quot; alt&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="NetworkX" scheme="http://yoursite.com/categories/NetworkX/"/>
    
    
    <category term="nebula" scheme="http://yoursite.com/tags/nebula/"/>
    
    <category term="å›¾ç®—æ³•" scheme="http://yoursite.com/tags/å›¾ç®—æ³•/"/>
    
    <category term="networkx" scheme="http://yoursite.com/tags/networkx/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°ä»¥å›¾æœå›¾</title>
    <link href="http://yoursite.com/2024/01/02/%E5%9F%BA%E4%BA%8EVGG%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%9B%BE%E6%90%9C%E5%9B%BE/"/>
    <id>http://yoursite.com/2024/01/02/%E5%9F%BA%E4%BA%8EVGG%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%9B%BE%E6%90%9C%E5%9B%BE/</id>
    <published>2024-01-02T11:11:22.000Z</published>
    <updated>2024-02-07T03:39:00.650Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p><font color="gold"> <strong>Â·</strong> </font>é¢„å…ˆå‡†å¤‡ä¸€ä»½å›¾ç‰‡åº“ï¼Œå¹¶å¯¹å…¶ä¸­æ•°æ®è¿›è¡Œæ‰¹å¤„ç†æ“ä½œï¼Œä½¿ç”¨VGG16å·ç§¯ç¥ç»ç½‘ç»œæå–å›¾åƒçš„512ç»´å·ç§¯ç‰¹å¾ï¼Œåˆ·å…¥æ•°æ®åº“ï¼ˆClickHouseï¼‰è®°å½•ï¼›</p><p><font color="gold"> <strong>Â·</strong> </font>ä¸Šä¼ ç›®æ ‡å›¾åƒè¿›è¡Œè¯†å›¾ï¼ŒåŒæ ·ä½¿ç”¨VGG16æå–ç›®æ ‡å›¾åƒç‰¹å¾ï¼Œä½¿ç”¨CKæ•°æ®åº“è·ç¦»å‡½æ•°è¿›è¡ŒåŒ¹é…ï¼Œé«˜äºé˜ˆå€¼å³å¯è¿”å›è¯†å›¾ç»“æœ</p><h2 id="ç¥ç»ç½‘ç»œ"><a href="#ç¥ç»ç½‘ç»œ" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author : tianL.R</span></span><br><span class="line"><span class="comment"># @Email : rtl1312@163.com</span></span><br><span class="line"><span class="comment"># @Time : 2023.11.26</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> keras.applications.vgg16 <span class="keyword">import</span> VGG16</span><br><span class="line"><span class="keyword">from</span> keras.applications.vgg16 <span class="keyword">import</span> preprocess_input</span><br><span class="line"><span class="keyword">from</span> keras.preprocessing <span class="keyword">import</span> image</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> linalg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VGG16Net</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.input_shape = (<span class="number">224</span>, <span class="number">224</span>, <span class="number">3</span>)</span><br><span class="line">        self.weight = <span class="string">'imagenet'</span></span><br><span class="line">        self.pooling = <span class="string">'max'</span></span><br><span class="line">        self.model_vgg = VGG16(weights=self.weight,</span><br><span class="line">                               input_shape=(self.input_shape[<span class="number">0</span>], self.input_shape[<span class="number">1</span>], self.input_shape[<span class="number">2</span>],),</span><br><span class="line">                               pooling=self.pooling,</span><br><span class="line">                               include_top=<span class="literal">False</span>)</span><br><span class="line">        self.model_vgg.predict(np.zeros((<span class="number">1</span>, <span class="number">224</span>, <span class="number">224</span>, <span class="number">3</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detection</span><span class="params">(self, img_path)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        æå–VGG16æœ€åä¸€å±‚å·ç§¯ç‰¹å¾</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># img = image.load_img(img_path, target_size=(self.input_shape[0], self.input_shape[1]))</span></span><br><span class="line">        img = img_path.resize((self.input_shape[<span class="number">0</span>], self.input_shape[<span class="number">1</span>]))</span><br><span class="line">        img = image.img_to_array(img)</span><br><span class="line">        img = np.expand_dims(img, axis=<span class="number">0</span>)</span><br><span class="line">        img = preprocess_input(img)</span><br><span class="line">        feat = self.model_vgg.predict(img)</span><br><span class="line">        norm_feat = feat[<span class="number">0</span>] / linalg.norm(feat[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span> norm_feat.tolist()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    img1 = <span class="string">'333.jpg'</span></span><br><span class="line">    img2 = <span class="string">'555.jpg'</span></span><br><span class="line">    img1 = Image.open(img1)</span><br><span class="line">    img2 = Image.open(img2)</span><br><span class="line"></span><br><span class="line">    vgg = VGG16Net()</span><br><span class="line">    queryVec1 = np.array(vgg.detection(img1))</span><br><span class="line">    queryVec2 = np.array(vgg.detection(img2))</span><br><span class="line">    scores = np.dot(queryVec1, queryVec2)</span><br><span class="line">    score2 = queryVec1.dot(queryVec2) / (np.linalg.norm(queryVec1) * np.linalg.norm(queryVec2))</span><br><span class="line">    print(scores)</span><br><span class="line">    print(score2)</span><br></pre></td></tr></table></figure><a id="more"></a>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ€è·¯&quot;&gt;&lt;a href=&quot;#æ€è·¯&quot; class=&quot;headerlink&quot; title=&quot;æ€è·¯&quot;&gt;&lt;/a&gt;æ€è·¯&lt;/h2&gt;&lt;p&gt;&lt;font color=&quot;gold&quot;&gt; &lt;strong&gt;Â·&lt;/strong&gt; &lt;/font&gt;é¢„å…ˆå‡†å¤‡ä¸€ä»½å›¾ç‰‡åº“ï¼Œå¹¶å¯¹å…¶ä¸­æ•°æ®è¿›è¡Œæ‰¹å¤„ç†æ“ä½œï¼Œä½¿ç”¨VGG16å·ç§¯ç¥ç»ç½‘ç»œæå–å›¾åƒçš„512ç»´å·ç§¯ç‰¹å¾ï¼Œåˆ·å…¥æ•°æ®åº“ï¼ˆClickHouseï¼‰è®°å½•ï¼›&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt; &lt;strong&gt;Â·&lt;/strong&gt; &lt;/font&gt;ä¸Šä¼ ç›®æ ‡å›¾åƒè¿›è¡Œè¯†å›¾ï¼ŒåŒæ ·ä½¿ç”¨VGG16æå–ç›®æ ‡å›¾åƒç‰¹å¾ï¼Œä½¿ç”¨CKæ•°æ®åº“è·ç¦»å‡½æ•°è¿›è¡ŒåŒ¹é…ï¼Œé«˜äºé˜ˆå€¼å³å¯è¿”å›è¯†å›¾ç»“æœ&lt;/p&gt;
&lt;h2 id=&quot;ç¥ç»ç½‘ç»œ&quot;&gt;&lt;a href=&quot;#ç¥ç»ç½‘ç»œ&quot; class=&quot;headerlink&quot; title=&quot;ç¥ç»ç½‘ç»œ&quot;&gt;&lt;/a&gt;ç¥ç»ç½‘ç»œ&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# -*- coding: utf-8 -*-&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# @Author : tianL.R&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# @Email : rtl1312@163.com&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# @Time : 2023.11.26&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; numpy &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; np&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; PIL &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Image&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; keras.applications.vgg16 &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; VGG16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; keras.applications.vgg16 &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; preprocess_input&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; keras.preprocessing &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; image&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; numpy &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; linalg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;VGG16Net&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;__init__&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.input_shape = (&lt;span class=&quot;number&quot;&gt;224&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;224&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.weight = &lt;span class=&quot;string&quot;&gt;&#39;imagenet&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.pooling = &lt;span class=&quot;string&quot;&gt;&#39;max&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.model_vgg = VGG16(weights=self.weight,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               input_shape=(self.input_shape[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], self.input_shape[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], self.input_shape[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;],),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               pooling=self.pooling,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               include_top=&lt;span class=&quot;literal&quot;&gt;False&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.model_vgg.predict(np.zeros((&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;224&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;224&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;detection&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self, img_path)&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;        æå–VGG16æœ€åä¸€å±‚å·ç§¯ç‰¹å¾&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;        &quot;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;# img = image.load_img(img_path, target_size=(self.input_shape[0], self.input_shape[1]))&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        img = img_path.resize((self.input_shape[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], self.input_shape[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        img = image.img_to_array(img)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        img = np.expand_dims(img, axis=&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        img = preprocess_input(img)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        feat = self.model_vgg.predict(img)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        norm_feat = feat[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] / linalg.norm(feat[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; norm_feat.tolist()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; __name__ == &lt;span class=&quot;string&quot;&gt;&#39;__main__&#39;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    img1 = &lt;span class=&quot;string&quot;&gt;&#39;333.jpg&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    img2 = &lt;span class=&quot;string&quot;&gt;&#39;555.jpg&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    img1 = Image.open(img1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    img2 = Image.open(img2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vgg = VGG16Net()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    queryVec1 = np.array(vgg.detection(img1))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    queryVec2 = np.array(vgg.detection(img2))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    scores = np.dot(queryVec1, queryVec2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    score2 = queryVec1.dot(queryVec2) / (np.linalg.norm(queryVec1) * np.linalg.norm(queryVec2))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    print(scores)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    print(score2)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://yoursite.com/categories/æ·±åº¦å­¦ä¹ /"/>
    
    
    <category term="VGG" scheme="http://yoursite.com/tags/VGG/"/>
    
    <category term="å·ç§¯ç¥ç»ç½‘ç»œ" scheme="http://yoursite.com/tags/å·ç§¯ç¥ç»ç½‘ç»œ/"/>
    
  </entry>
  
  <entry>
    <title>å·ç§¯ç¥ç»ç½‘ç»œå›¾åƒåˆ†ç±»ç®—æ³•å°é›†</title>
    <link href="http://yoursite.com/2024/01/01/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB%E7%AE%97%E6%B3%95%E5%B0%8F%E9%9B%86/"/>
    <id>http://yoursite.com/2024/01/01/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB%E7%AE%97%E6%B3%95%E5%B0%8F%E9%9B%86/</id>
    <published>2024-01-01T02:12:35.000Z</published>
    <updated>2024-04-15T09:32:19.819Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h2><h3 id="è®­ç»ƒç»“æ„"><a href="#è®­ç»ƒç»“æ„" class="headerlink" title="è®­ç»ƒç»“æ„"></a>è®­ç»ƒç»“æ„</h3><p><font color="gold"><strong>Â·</strong></font> åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ•°æ®é›†æ–‡ä»¶å¤¹<code>data_set</code>ï¼Œå»ºç«‹å­æ–‡ä»¶å¤¹ï¼ˆæ•°æ®é›†åç§°ï¼‰ç”¨äºå­˜æ”¾è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼›</p><p><font color="gold"><strong>Â·</strong></font> åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ•°æ®é›†æ–‡ä»¶å¤¹<code>class_j</code>ï¼Œç”¨äºå­˜æ”¾åˆ†ç±»jsonæ–‡ä»¶ï¼›</p><p><font color="gold"><strong>Â·</strong></font> åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ•°æ®é›†æ–‡ä»¶å¤¹<code>models</code>ï¼Œç”¨äºå­˜æ”¾è®­ç»ƒå¥½çš„æ¨¡å‹æ–‡ä»¶ï¼›</p><p><font color="gold"><strong>Â·</strong></font> ç¥ç»ç½‘ç»œ<code>model.py</code>ï¼›</p><p><font color="gold"><strong>Â·</strong></font> è®­ç»ƒè„šæœ¬<code>train.py</code>ï¼›</p><p><font color="gold"><strong>Â·</strong></font> é¢„æµ‹è„šæœ¬<code>predict.py</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> project</span></span><br><span class="line">â”œâ”€â”€ data_set</span><br><span class="line">â”‚â”œâ”€â”€ data</span><br><span class="line">â”‚     â”œâ”€â”€ train</span><br><span class="line">â”‚     â”‚    â”œâ”€â”€ 00001.jpg</span><br><span class="line">â”‚     â”‚    â”œâ”€â”€ 00002.jpg</span><br><span class="line">â”‚     â”‚    â”œâ”€â”€ 00003.jpg</span><br><span class="line">â”‚     â”‚    â”œâ”€â”€ ...</span><br><span class="line">â”‚     â”‚    â””â”€â”€ 10000.jpg</span><br><span class="line">â”‚     â””â”€â”€ val</span><br><span class="line">â”‚          â”œâ”€â”€ 00001.jpg</span><br><span class="line">â”‚          â”œâ”€â”€ 00002.jpg</span><br><span class="line">â”‚          â”œâ”€â”€ 00003.jpg</span><br><span class="line">â”‚          â”œâ”€â”€ ...</span><br><span class="line">â”‚          â””â”€â”€ 01000.jpg</span><br><span class="line">â”œâ”€â”€ class_j</span><br><span class="line">â”‚â”œâ”€â”€ class_indices.json</span><br><span class="line">â”œâ”€â”€ models</span><br><span class="line">â”‚â”œâ”€â”€ model.pth</span><br><span class="line">â”œâ”€â”€ model.py</span><br><span class="line">â”œâ”€â”€ train.py</span><br><span class="line">â””â”€â”€ predict.py</span><br></pre></td></tr></table></figure><h3 id="å°è£…ç»“æ„"><a href="#å°è£…ç»“æ„" class="headerlink" title="å°è£…ç»“æ„"></a>å°è£…ç»“æ„</h3><p>ä»¥<code>GoogLeNet</code>ç¥ç»ç½‘ç»œä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> GoogLeNet</span></span><br><span class="line">â”œâ”€â”€ class_j</span><br><span class="line">â”‚â”œâ”€â”€ class_indices.json</span><br><span class="line">â”‚â”€â”€ weights</span><br><span class="line">â”‚â”œâ”€â”€ GoogLeNet_GPU_v1.pth</span><br><span class="line">â””â”€â”€ model.py</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="ç¥ç»ç½‘ç»œ"><a href="#ç¥ç»ç½‘ç»œ" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h2><h3 id="VGG"><a href="#VGG" class="headerlink" title="VGG"></a>VGG</h3><h4 id="ç¥ç»ç½‘ç»œ-1"><a href="#ç¥ç»ç½‘ç»œ-1" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><p><code>model.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">VGGæ¨¡å‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> PR, vgg_model</span><br><span class="line"></span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„è®­ç»ƒæƒé‡æ¨¡å‹</span></span><br><span class="line">model_urls = &#123;</span><br><span class="line">    <span class="string">'vgg11'</span>: <span class="string">'https://download.pytorch.org/models/vgg11-bbd30ac9.pth'</span>,</span><br><span class="line">    <span class="string">'vgg13'</span>: <span class="string">'https://download.pytorch.org/models/vgg13-c768596a.pth'</span>,</span><br><span class="line">    <span class="string">'vgg16'</span>: <span class="string">'https://download.pytorch.org/models/vgg16-397923af.pth'</span>,</span><br><span class="line">    <span class="string">'vgg19'</span>: <span class="string">'https://download.pytorch.org/models/vgg19-dcbb9e9d.pth'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfgs = &#123;</span><br><span class="line">    <span class="string">'vgg11'</span>: [<span class="number">64</span>, <span class="string">'M'</span>, <span class="number">128</span>, <span class="string">'M'</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>],</span><br><span class="line">    <span class="string">'vgg13'</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">'M'</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">'M'</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>],</span><br><span class="line">    <span class="string">'vgg16'</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">'M'</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">'M'</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>],</span><br><span class="line">    <span class="string">'vgg19'</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">'M'</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">'M'</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">'M'</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VGG</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, features, num_classes=<span class="number">1000</span>, init_weights=False)</span>:</span></span><br><span class="line">        super(VGG, self).__init__()</span><br><span class="line">        self.features = features</span><br><span class="line">        self.classifier = nn.Sequential(</span><br><span class="line">            nn.Linear(<span class="number">512</span> * <span class="number">7</span> * <span class="number">7</span>, <span class="number">4096</span>),  <span class="comment"># ç¬¬1çº¿æ€§å±‚, 2048 å‡å°‘å‚æ•°</span></span><br><span class="line">            nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">            nn.Dropout(p=<span class="number">0.5</span>),</span><br><span class="line">            nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>),  <span class="comment"># ç¬¬2çº¿æ€§å±‚</span></span><br><span class="line">            nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">            nn.Dropout(p=<span class="number">0.5</span>),</span><br><span class="line">            nn.Linear(<span class="number">4096</span>, num_classes),  <span class="comment"># ç¬¬3çº¿æ€§å±‚</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> init_weights:</span><br><span class="line">            self._initialize_weights()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.features(x)  <span class="comment"># N x 3 x 224 x 224</span></span><br><span class="line">        x = torch.flatten(x, start_dim=<span class="number">1</span>)  <span class="comment"># N x 512 x 7 x 7</span></span><br><span class="line">        x = self.classifier(x)  <span class="comment"># N x 512*7*7</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize_weights</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                nn.init.xavier_uniform_(m.weight)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.Linear):</span><br><span class="line">                nn.init.xavier_uniform_(m.weight)</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_features</span><span class="params">(cfg: list)</span>:</span></span><br><span class="line">    layers = []</span><br><span class="line">    in_channels = <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> cfg:</span><br><span class="line">        <span class="keyword">if</span> v == <span class="string">"M"</span>:</span><br><span class="line">            layers += [nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            conv2d = nn.Conv2d(in_channels, v, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">            layers += [conv2d, nn.ReLU(<span class="literal">True</span>)]</span><br><span class="line">            in_channels = v</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vgg</span><span class="params">(model_name=<span class="string">"vgg16"</span>, **kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> model_name <span class="keyword">in</span> cfgs, <span class="string">"Warning: model number &#123;&#125; not in cfgs dist!"</span>.format(model_name)</span><br><span class="line">    cfg = cfgs[model_name]</span><br><span class="line">    model = VGG(make_features(cfg), **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VGGNetImageClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</span></span><br><span class="line">        self.device = torch.device(<span class="string">"cpu"</span>)</span><br><span class="line">        self.data_transform = transforms.Compose([</span><br><span class="line">            transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">        ])</span><br><span class="line">        self.json_path = os.path.join(PR, <span class="string">"im_weight_vgg/class_j/class_indices.json"</span>)</span><br><span class="line">        self.weights_path = os.path.join(PR, <span class="string">f"im_weight_vgg/weights/<span class="subst">&#123;vgg_model&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">        self.model = vgg(model_name=<span class="string">"vgg19"</span>, num_classes=<span class="number">13</span>).to(self.device)</span><br><span class="line">        self.model.load_state_dict(torch.load(self.weights_path, map_location=self.device))</span><br><span class="line">        self.model.eval()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(self.json_path, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.class_indices = json.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detection</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        img = self.data_transform(img) <span class="comment"># [N, C H, W]</span></span><br><span class="line">        img = torch.unsqueeze(img, dim=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            output = torch.squeeze(self.model(img.to(self.device))).cpu()</span><br><span class="line">            predict = torch.softmax(output, dim=<span class="number">0</span>)</span><br><span class="line">            predict_cla = torch.argmax(predict).numpy()</span><br><span class="line">            result = &#123;</span><br><span class="line">                <span class="string">'class'</span>: predict_cla.tolist(),</span><br><span class="line">                <span class="string">'prob'</span>: predict[predict_cla].numpy().tolist()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><p><code>train.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">è®­ç»ƒ(GPU)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms, datasets, utils</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> vgg</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageFile</span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">    print(<span class="string">f"use device is <span class="subst">&#123;device&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    data_transform = &#123;</span><br><span class="line">        <span class="string">"train"</span>: transforms.Compose([</span><br><span class="line">            transforms.RandomResizedCrop(<span class="number">224</span>),</span><br><span class="line">            transforms.RandomHorizontalFlip(),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)),</span><br><span class="line">        ]),</span><br><span class="line">        <span class="string">"val"</span>: transforms.Compose([</span><br><span class="line">            transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)),</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">    data_root = os.path.abspath(os.path.join(os.getcwd(), <span class="string">"./"</span>))</span><br><span class="line">    image_path = os.path.join(data_root, <span class="string">"data_set"</span>, <span class="string">"data"</span>)</span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(image_path), <span class="string">"&#123;&#125; path does not exist."</span>.format(image_path)</span><br><span class="line">    train_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"train"</span>),</span><br><span class="line">                                         transform=data_transform[<span class="string">"train"</span>]</span><br><span class="line">                                         )</span><br><span class="line">    train_num = len(train_dataset)</span><br><span class="line">    flower_list = train_dataset.class_to_idx</span><br><span class="line">    cla_dict = dict((val, key) <span class="keyword">for</span> key, val <span class="keyword">in</span> flower_list.items())</span><br><span class="line">    json_str = json.dumps(cla_dict, indent=<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"class_j/class_indices.json"</span>, <span class="string">'w'</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">        json_file.write(json_str)</span><br><span class="line"></span><br><span class="line">    batch_size = <span class="number">32</span></span><br><span class="line">    nw = min([os.cpu_count(), batch_size <span class="keyword">if</span> batch_size &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>, <span class="number">8</span>])  <span class="comment"># çº¿ç¨‹æ•°è®¡ç®—</span></span><br><span class="line">    nw = <span class="number">0</span></span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;nw&#125;</span> dataloader workers every process."</span>)</span><br><span class="line"></span><br><span class="line">    train_loader = torch.utils.data.DataLoader(train_dataset,</span><br><span class="line">                                               batch_size=batch_size,</span><br><span class="line">                                               shuffle=<span class="literal">True</span>,</span><br><span class="line">                                               num_workers=nw</span><br><span class="line">                                               )</span><br><span class="line">    val_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"val"</span>),</span><br><span class="line">                                       transform=data_transform[<span class="string">"val"</span>]</span><br><span class="line">                                       )</span><br><span class="line">    val_num = len(val_dataset)</span><br><span class="line">    val_loader = torch.utils.data.DataLoader(val_dataset,</span><br><span class="line">                                             batch_size=<span class="number">4</span>,</span><br><span class="line">                                             shuffle=<span class="literal">False</span>,</span><br><span class="line">                                             num_workers=nw</span><br><span class="line">                                             )</span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;train_num&#125;</span> images for training, <span class="subst">&#123;val_num&#125;</span> images for validation."</span>)</span><br><span class="line"></span><br><span class="line">    model_name = <span class="string">"vgg19"</span></span><br><span class="line">    net = vgg(model_name=model_name, num_classes=<span class="number">13</span>, init_weights=<span class="literal">True</span>)  <span class="comment"># å®ä¾‹åŒ–ç½‘ç»œ(13åˆ†ç±»)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># """ åŠ è½½é¢„è®­ç»ƒæ¨¡å‹æƒé‡</span></span><br><span class="line">    model_weight_path = <span class="string">'./models/VGG19Net_GPU_v5.pth'</span></span><br><span class="line">    net.load_state_dict(torch.load(model_weight_path, map_location=<span class="string">'cpu'</span>))</span><br><span class="line">    <span class="comment"># """</span></span><br><span class="line">    net.to(device)</span><br><span class="line">    loss_function = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr=<span class="number">0.0001</span>)</span><br><span class="line"></span><br><span class="line">    epochs = <span class="number">300</span></span><br><span class="line">    save_path = <span class="string">"./VGG19Net_GPU_RE.pth"</span></span><br><span class="line">    best_accuracy = <span class="number">0.0</span></span><br><span class="line">    train_steps = len(train_loader)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(epochs):</span><br><span class="line">        net.train()</span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        train_bar = tqdm(train_loader, file=sys.stdout)</span><br><span class="line">        <span class="keyword">for</span> step, data <span class="keyword">in</span> enumerate(train_bar):</span><br><span class="line">            images, labels = data</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            outputs = net(images.to(device))</span><br><span class="line">            loss = loss_function(outputs, labels.to(device))</span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            running_loss += loss.item()</span><br><span class="line">            train_bar.desc = <span class="string">"train epoch [&#123;&#125;/&#123;&#125;] loss:&#123;:.3f&#125;"</span>.format(epoch + <span class="number">1</span>,</span><br><span class="line">                                                                      epochs,</span><br><span class="line">                                                                      loss</span><br><span class="line">                                                                      )</span><br><span class="line">        <span class="comment"># éªŒè¯</span></span><br><span class="line">        net.eval()</span><br><span class="line">        acc = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            val_bar = tqdm(val_loader, file=sys.stdout)</span><br><span class="line">            <span class="keyword">for</span> val_data <span class="keyword">in</span> val_bar:</span><br><span class="line">                val_images, val_labels = val_data</span><br><span class="line">                outputs = net(val_images.to(device))</span><br><span class="line">                predict_y = torch.max(outputs, dim=<span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">                acc += torch.eq(predict_y, val_labels.to(device)).sum().item()</span><br><span class="line">        val_accuracy = acc / val_num</span><br><span class="line">        print(<span class="string">"[epoch %d ] train_loss: %3f    val_accurancy: %3f"</span> %</span><br><span class="line">              (epoch + <span class="number">1</span>, running_loss / train_steps, val_accuracy))</span><br><span class="line">        <span class="keyword">if</span> val_accuracy &gt; best_accuracy:</span><br><span class="line">            best_accuracy = val_accuracy</span><br><span class="line">        torch.save(net.state_dict(), save_path+str(val_accuracy))</span><br><span class="line">    print(<span class="string">"Finshed Training."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    os.environ[<span class="string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="string">"1"</span></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="é¢„æµ‹"><a href="#é¢„æµ‹" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h4><p><code>predict.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">é¢„æµ‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> im_weight_vgg.model <span class="keyword">import</span> VGGNetImageClass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    im_class = VGGNetImageClass()</span><br><span class="line">    url = <span class="string">'http://192.168.3.18:300/files/group1/M00/11/0E/wKgCBWRUgjWAGTfNAAEKiw0XSZc371.jpg'</span></span><br><span class="line">    img_bytes = urlopen(url).read()</span><br><span class="line">    img_pil = Image.open(BytesIO(img_bytes))</span><br><span class="line"></span><br><span class="line">    print(im_class.detection(img_pil))</span><br><span class="line">    print(im_class.detection(Image.open(<span class="string">"-532576361772532412_120.jpg"</span>).convert(<span class="string">"RGB"</span>)))</span><br></pre></td></tr></table></figure><p>é™„ï¼švgg16+transformer</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># VGG16ç¥ç»ç½‘ç»œå®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VGG16</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="string">"""Vgg16 Net"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, requires_grad=False)</span>:</span></span><br><span class="line">        super(VGG16, self).__init__()</span><br><span class="line">        vgg_pretrained_features = models.vgg16(pretrained=<span class="literal">True</span>).features</span><br><span class="line">        self.slice1 = torch.nn.Sequential()</span><br><span class="line">        self.slice2 = torch.nn.Sequential()</span><br><span class="line">        self.slice3 = torch.nn.Sequential()</span><br><span class="line">        self.slice4 = torch.nn.Sequential()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            self.slice1.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>, <span class="number">9</span>):</span><br><span class="line">            self.slice2.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">9</span>, <span class="number">16</span>):</span><br><span class="line">            self.slice3.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">16</span>, <span class="number">23</span>):</span><br><span class="line">            self.slice4.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> requires_grad:</span><br><span class="line">            <span class="keyword">for</span> param <span class="keyword">in</span> self.parameters():</span><br><span class="line">                param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, X)</span>:</span></span><br><span class="line">        h = self.slice1(X)</span><br><span class="line">        h_relu1_2 = h</span><br><span class="line">        h = self.slice2(h)</span><br><span class="line">        h_relu2_2 = h</span><br><span class="line">        h = self.slice3(h)</span><br><span class="line">        h_relu3_3 = h</span><br><span class="line">        h = self.slice4(h)</span><br><span class="line">        h_relu4_3 = h</span><br><span class="line"></span><br><span class="line">        vgg_outputs = namedtuple(<span class="string">"VggOutputs"</span>, [<span class="string">"relu1_2"</span>, <span class="string">"relu2_2"</span>, <span class="string">"relu3_3"</span>, <span class="string">"relu4_3"</span>])</span><br><span class="line">        output = vgg_outputs(h_relu1_2, h_relu2_2, h_relu3_3, h_relu4_3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransformerNet</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(TransformerNet, self).__init__()</span><br><span class="line">        self.model = nn.Sequential(</span><br><span class="line">            ConvBlock(<span class="number">3</span>, <span class="number">32</span>, kernel_size=<span class="number">9</span>, stride=<span class="number">1</span>),</span><br><span class="line">            ConvBlock(<span class="number">32</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">            ConvBlock(<span class="number">64</span>, <span class="number">128</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ConvBlock(<span class="number">128</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, upsample=<span class="literal">True</span>),</span><br><span class="line">            ConvBlock(<span class="number">64</span>, <span class="number">32</span>, kernel_size=<span class="number">3</span>, upsample=<span class="literal">True</span>),</span><br><span class="line">            ConvBlock(<span class="number">32</span>, <span class="number">3</span>, kernel_size=<span class="number">9</span>, stride=<span class="number">1</span>, normalize=<span class="literal">False</span>, relu=<span class="literal">False</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.model(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResidualBlock</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, channels)</span>:</span></span><br><span class="line">        super(ResidualBlock, self).__init__()</span><br><span class="line">        self.block = nn.Sequential(</span><br><span class="line">            ConvBlock(channels, channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, normalize=<span class="literal">True</span>, relu=<span class="literal">True</span>),</span><br><span class="line">            ConvBlock(channels, channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, normalize=<span class="literal">True</span>, relu=<span class="literal">False</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.block(x) + x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvBlock</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, out_channels, kernel_size, stride=<span class="number">1</span>, upsample=False, normalize=True, relu=True)</span>:</span></span><br><span class="line">        super(ConvBlock, self).__init__()</span><br><span class="line">        self.upsample = upsample</span><br><span class="line">        self.block = nn.Sequential(</span><br><span class="line">            nn.ReflectionPad2d(kernel_size // <span class="number">2</span>),</span><br><span class="line">            nn.Conv2d(in_channels, out_channels, kernel_size, (stride,))</span><br><span class="line">        )</span><br><span class="line">        self.norm = nn.InstanceNorm2d(out_channels, affine=<span class="literal">True</span>) <span class="keyword">if</span> normalize <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        self.relu = relu</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.upsample:</span><br><span class="line">            x = F.interpolate(x, scale_factor=<span class="number">2</span>)</span><br><span class="line">        x = self.block(x)</span><br><span class="line">        <span class="keyword">if</span> self.norm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            x = self.norm(x)</span><br><span class="line">        <span class="keyword">if</span> self.relu:</span><br><span class="line">            x = F.relu(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    input1 = torch.rand([<span class="number">224</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>])</span><br><span class="line">    model_x = VGG16()</span><br><span class="line">    print(model_x)</span><br></pre></td></tr></table></figure><h3 id="GoogLeNet"><a href="#GoogLeNet" class="headerlink" title="GoogLeNet"></a>GoogLeNet</h3><p><code>model.py</code></p><h4 id="ç¥ç»ç½‘ç»œ-2"><a href="#ç¥ç»ç½‘ç»œ-2" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> GoogLeNet_model</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># å®šä¹‰å·ç§¯+æ¿€æ´»å‡½æ•°æ“ä½œæ¨¡æ¿</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicConv2d</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, out_channels, **kwargs)</span>:</span></span><br><span class="line">        super(BasicConv2d, self).__init__()</span><br><span class="line">        self.conv = nn.Conv2d(in_channels, out_channels, **kwargs)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># å®šä¹‰ Iception è¾…åŠ©åˆ†ç±»å™¨æ¨¡æ¿</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InceptionAux</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, num_classes)</span>:</span></span><br><span class="line">        super(InceptionAux, self).__init__()</span><br><span class="line">        self.averagePool = nn.AvgPool2d(kernel_size=<span class="number">5</span>, stride=<span class="number">3</span>)</span><br><span class="line">        self.conv = BasicConv2d(in_channels, <span class="number">128</span>, kernel_size=<span class="number">1</span>)  <span class="comment"># output = [batch, 128, 4, 4]</span></span><br><span class="line">        self.fc1 = nn.Linear(<span class="number">2048</span>, <span class="number">1024</span>)</span><br><span class="line">        self.fc2 = nn.Linear(<span class="number">1024</span>, num_classes)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># aux1: N*512*14*14, aux2: N*528*14*14</span></span><br><span class="line">        x = self.averagePool(x)</span><br><span class="line">        <span class="comment"># aux1: N*512*4*4, aux2: N*528*4*4</span></span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        <span class="comment"># N*128*4*4</span></span><br><span class="line">        x = torch.flatten(x, <span class="number">1</span>)</span><br><span class="line">        x = F.dropout(x, <span class="number">0.5</span>, training=self.training)</span><br><span class="line">        <span class="comment"># N*2048</span></span><br><span class="line">        x = F.relu(self.fc1(x), inplace=<span class="literal">True</span>)</span><br><span class="line">        x = F.dropout(x, <span class="number">0.5</span>, training=self.training)</span><br><span class="line">        <span class="comment"># N*1024</span></span><br><span class="line">        x = self.fc2(x)</span><br><span class="line">        <span class="comment"># N*num_classes</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># Inception æ¨¡æ¿ </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Inception</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, ch1x1, ch3x3red, ch3x3, ch5x5red, ch5x5, pool_proj)</span>:</span></span><br><span class="line">        super(Inception, self).__init__()</span><br><span class="line">        self.branch1 = BasicConv2d(in_channels, ch1x1, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.branch2 = nn.Sequential(</span><br><span class="line">            BasicConv2d(in_channels, ch3x3red, kernel_size=<span class="number">1</span>),</span><br><span class="line">            BasicConv2d(ch3x3red, ch3x3, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)  <span class="comment"># ä¿è¯è¾“å‡ºå¤§å°ç­‰äºè¾“å…¥å¤§å°</span></span><br><span class="line">        )</span><br><span class="line">        self.branch3 = nn.Sequential(</span><br><span class="line">            BasicConv2d(in_channels, ch5x5red, kernel_size=<span class="number">1</span>),</span><br><span class="line">            <span class="comment"># å®˜æ–¹ 3x3, https://github.com/pytorch/vision/issues/906</span></span><br><span class="line">            BasicConv2d(ch5x5red, ch5x5, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>)  <span class="comment"># è¾“å‡ºå¤§å°=è¾“å…¥å¤§å°</span></span><br><span class="line">        )</span><br><span class="line">        self.branch4 = nn.Sequential(</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">            BasicConv2d(in_channels, pool_proj, kernel_size=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        branch1 = self.branch1(x)</span><br><span class="line">        branch2 = self.branch2(x)</span><br><span class="line">        branch3 = self.branch3(x)</span><br><span class="line">        branch4 = self.branch4(x)</span><br><span class="line">        outputs = [branch1, branch2, branch3, branch4]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> torch.cat(outputs, <span class="number">1</span>)  <span class="comment"># æ‹¼æ¥æ•°æ®</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># GoogLeNet æ¨¡å‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogLeNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_classes=<span class="number">1000</span>, aux_logits=True, init_weights=False)</span>:</span></span><br><span class="line">        super(GoogLeNet, self).__init__()</span><br><span class="line">        self.aux_logits = aux_logits</span><br><span class="line"></span><br><span class="line">        self.conv1 = BasicConv2d(<span class="number">3</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>)</span><br><span class="line">        self.maxpool1 = nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        self.conv2 = BasicConv2d(<span class="number">64</span>, <span class="number">64</span>, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.conv3 = BasicConv2d(<span class="number">64</span>, <span class="number">192</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.maxpool2 = nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        self.inception3a = Inception(<span class="number">192</span>, <span class="number">64</span>, <span class="number">96</span>, <span class="number">128</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">32</span>)</span><br><span class="line">        self.inception3b = Inception(<span class="number">256</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">192</span>, <span class="number">32</span>, <span class="number">96</span>, <span class="number">64</span>)</span><br><span class="line">        self.maxpool3 = nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        self.inception4a = Inception(<span class="number">480</span>, <span class="number">192</span>, <span class="number">96</span>, <span class="number">208</span>, <span class="number">16</span>, <span class="number">48</span>, <span class="number">64</span>)</span><br><span class="line">        self.inception4b = Inception(<span class="number">512</span>, <span class="number">160</span>, <span class="number">112</span>, <span class="number">224</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">64</span>)</span><br><span class="line">        self.inception4c = Inception(<span class="number">512</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">64</span>)</span><br><span class="line">        self.inception4d = Inception(<span class="number">512</span>, <span class="number">112</span>, <span class="number">144</span>, <span class="number">288</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">64</span>)</span><br><span class="line">        self.inception4e = Inception(<span class="number">528</span>, <span class="number">256</span>, <span class="number">160</span>, <span class="number">320</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line">        self.maxpool4 = nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        self.inception5a = Inception(<span class="number">832</span>, <span class="number">256</span>, <span class="number">160</span>, <span class="number">320</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line">        self.inception5b = Inception(<span class="number">832</span>, <span class="number">384</span>, <span class="number">192</span>, <span class="number">384</span>, <span class="number">48</span>, <span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.aux_logits:</span><br><span class="line">            self.aux1 = InceptionAux(<span class="number">512</span>, num_classes)</span><br><span class="line">            self.aux2 = InceptionAux(<span class="number">528</span>, num_classes)</span><br><span class="line"></span><br><span class="line">        self.avgpool = nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.dropout = nn.Dropout(<span class="number">0.4</span>)</span><br><span class="line">        self.fc = nn.Linear(<span class="number">1024</span>, num_classes)</span><br><span class="line">        <span class="keyword">if</span> init_weights:</span><br><span class="line">            self._initialize_weights()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># N*3*224*224</span></span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        <span class="comment"># N*64*112*112</span></span><br><span class="line">        x = self.maxpool1(x)</span><br><span class="line">        <span class="comment"># N*64*56*56</span></span><br><span class="line">        x = self.conv2(x)</span><br><span class="line">        <span class="comment"># N*64*56*56</span></span><br><span class="line">        x = self.conv3(x)</span><br><span class="line">        <span class="comment"># N*192*56*56</span></span><br><span class="line">        x = self.maxpool2(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># N*192*28*28</span></span><br><span class="line">        x = self.inception3a(x)</span><br><span class="line">        <span class="comment"># N*256*28*28</span></span><br><span class="line">        x = self.inception3b(x)</span><br><span class="line">        <span class="comment"># N*480*28*28</span></span><br><span class="line">        x = self.maxpool3(x)</span><br><span class="line">        <span class="comment"># N*480*14*14</span></span><br><span class="line">        x = self.inception4a(x)</span><br><span class="line">        <span class="comment"># N*512*14*14</span></span><br><span class="line">        <span class="keyword">if</span> self.training <span class="keyword">and</span> self.aux_logits:  <span class="comment"># eval model lose this layer</span></span><br><span class="line">            aux1 = self.aux1(x)</span><br><span class="line"></span><br><span class="line">        x = self.inception4b(x)</span><br><span class="line">        <span class="comment"># N*512*14*14</span></span><br><span class="line">        x = self.inception4c(x)</span><br><span class="line">        <span class="comment"># N*512*14*14</span></span><br><span class="line">        x = self.inception4d(x)</span><br><span class="line">        <span class="comment"># N*528*14*14</span></span><br><span class="line">        <span class="keyword">if</span> self.training <span class="keyword">and</span> self.aux_logits:  <span class="comment"># eval model lose this layer</span></span><br><span class="line">            aux2 = self.aux2(x)</span><br><span class="line"></span><br><span class="line">        x = self.inception4e(x)</span><br><span class="line">        <span class="comment"># N*832*14*14</span></span><br><span class="line">        x = self.maxpool4(x)</span><br><span class="line">        <span class="comment"># N*832*7*7</span></span><br><span class="line">        x = self.inception5a(x)</span><br><span class="line">        <span class="comment"># N*832*7*7</span></span><br><span class="line">        x = self.inception5b(x)</span><br><span class="line">        <span class="comment"># N*1024*7*7</span></span><br><span class="line"></span><br><span class="line">        x = self.avgpool(x)</span><br><span class="line">        <span class="comment"># N*1024*1*1</span></span><br><span class="line">        x = torch.flatten(x, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># N*1024</span></span><br><span class="line">        x = self.dropout(x)</span><br><span class="line">        x = self.fc(x)</span><br><span class="line">        <span class="comment"># N*1000 (num_classes)</span></span><br><span class="line">        <span class="keyword">if</span> self.training <span class="keyword">and</span> self.aux_logits:  <span class="comment"># eval model lose this layer</span></span><br><span class="line">            <span class="keyword">return</span> x, aux2, aux1</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize_weights</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight, mode=<span class="string">'fan_out'</span>, nonlinearity=<span class="string">'relu'</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.Linear):</span><br><span class="line">                nn.init.normal_(m.weight, <span class="number">0</span>, <span class="number">0.01</span>)</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogLeNetImageClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</span></span><br><span class="line">        self.device = torch.device(<span class="string">"cpu"</span>)</span><br><span class="line">        self.data_transform = transforms.Compose([</span><br><span class="line">            transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">        ])</span><br><span class="line">        self.json_path = <span class="string">"im_weight_gln/class_j/class_indices.json"</span></span><br><span class="line">        self.weights_path = <span class="string">f"im_weight_gln/weights/<span class="subst">&#123;GoogLeNet_model&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">        self.model = GoogLeNet(num_classes=<span class="number">13</span>, aux_logits=<span class="literal">False</span>).to(self.device)</span><br><span class="line">        self.model.load_state_dict(torch.load(self.weights_path, map_location=self.device), strict=<span class="literal">False</span>)</span><br><span class="line">        self.model.eval()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(self.json_path, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.class_indices = json.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detection</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        img = self.data_transform(img)  <span class="comment"># [N, C H, W]</span></span><br><span class="line">        img = torch.unsqueeze(img, dim=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            output = torch.squeeze(self.model(img.to(self.device))).cpu()</span><br><span class="line">            predict = torch.softmax(output, dim=<span class="number">0</span>)</span><br><span class="line">            predict_cla = torch.argmax(predict).numpy()</span><br><span class="line">            result = &#123;</span><br><span class="line">                <span class="string">'class'</span>: predict_cla.tolist(),</span><br><span class="line">                <span class="string">'prob'</span>: predict[predict_cla].numpy().tolist()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒ-1"><a href="#è®­ç»ƒ-1" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><p><code>train.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">è®­ç»ƒ(GPU)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms, datasets, utils</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> GoogLeNet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">    print(<span class="string">f"use device is <span class="subst">&#123;device&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    data_transform = &#123;</span><br><span class="line">        <span class="string">"train"</span>: transforms.Compose([</span><br><span class="line">            transforms.RandomResizedCrop(<span class="number">224</span>),</span><br><span class="line">            transforms.RandomHorizontalFlip(),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)),</span><br><span class="line">        ]),</span><br><span class="line">        <span class="string">"val"</span>: transforms.Compose([</span><br><span class="line">            transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)),</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">    data_root = os.path.abspath(os.path.join(os.getcwd(), <span class="string">"./"</span>))</span><br><span class="line">    image_path = <span class="string">"/exp/work/algorithm/vgg/data_set/data"</span></span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(image_path), <span class="string">"&#123;&#125; path does not exist."</span>.format(image_path)</span><br><span class="line">    train_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"train"</span>),</span><br><span class="line">                                         transform=data_transform[<span class="string">"train"</span>]</span><br><span class="line">                                         )</span><br><span class="line">    train_num = len(train_dataset)</span><br><span class="line">    flower_list = train_dataset.class_to_idx</span><br><span class="line">    cla_dict = dict((val, key) <span class="keyword">for</span> key, val <span class="keyword">in</span> flower_list.items())</span><br><span class="line">    json_str = json.dumps(cla_dict, indent=<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"calss_indices.json"</span>, <span class="string">'w'</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">        json_file.write(json_str)</span><br><span class="line"></span><br><span class="line">    batch_size = <span class="number">32</span></span><br><span class="line">    nw = min([os.cpu_count(), batch_size <span class="keyword">if</span> batch_size &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>, <span class="number">8</span>])  <span class="comment"># çº¿ç¨‹æ•°è®¡ç®—</span></span><br><span class="line">    nw = <span class="number">0</span></span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;nw&#125;</span> dataloader workers every process."</span>)</span><br><span class="line"></span><br><span class="line">    train_loader = torch.utils.data.DataLoader(train_dataset,</span><br><span class="line">                                               batch_size=batch_size,</span><br><span class="line">                                               shuffle=<span class="literal">True</span>,</span><br><span class="line">                                               num_workers=nw</span><br><span class="line">                                               )</span><br><span class="line">    val_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"val"</span>),</span><br><span class="line">                                       transform=data_transform[<span class="string">"val"</span>]</span><br><span class="line">                                       )</span><br><span class="line">    val_num = len(val_dataset)</span><br><span class="line">    val_loader = torch.utils.data.DataLoader(val_dataset,</span><br><span class="line">                                             batch_size=<span class="number">4</span>,</span><br><span class="line">                                             shuffle=<span class="literal">False</span>,</span><br><span class="line">                                             num_workers=nw</span><br><span class="line">                                             )</span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;train_num&#125;</span> images for training, <span class="subst">&#123;val_num&#125;</span> images for validation."</span>)</span><br><span class="line"></span><br><span class="line">    net = GoogLeNet(num_classes=<span class="number">13</span>, aux_logits=<span class="literal">True</span>, init_weights=<span class="literal">True</span>)  <span class="comment"># å®ä¾‹åŒ–ç½‘ç»œ(5åˆ†ç±»)</span></span><br><span class="line">    net.to(device)</span><br><span class="line">    loss_function = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr=<span class="number">0.0001</span>)</span><br><span class="line"></span><br><span class="line">    epochs = <span class="number">300</span></span><br><span class="line">    save_path = <span class="string">"./GoogLeNet_GPU.pth"</span></span><br><span class="line">    best_accuracy = <span class="number">0.0</span></span><br><span class="line">    train_steps = len(train_loader)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(epochs):</span><br><span class="line">        net.train()</span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        train_bar = tqdm(train_loader, file=sys.stdout)</span><br><span class="line">        <span class="keyword">for</span> step, data <span class="keyword">in</span> enumerate(train_bar):</span><br><span class="line">            images, labels = data</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            logits, aux_logits2, aux_logits1 = net(images.to(device))</span><br><span class="line">            loss0 = loss_function(logits, labels.to(device))</span><br><span class="line">            loss1 = loss_function(aux_logits1, labels.to(device))</span><br><span class="line">            loss2 = loss_function(aux_logits2, labels.to(device))</span><br><span class="line">            loss = loss0 + loss1 * <span class="number">0.3</span> + loss2 * <span class="number">0.3</span></span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            running_loss += loss.item()</span><br><span class="line">            train_bar.desc = <span class="string">"train epoch [&#123;&#125;/&#123;&#125;] loss:&#123;:.3f&#125;"</span>.format(epoch + <span class="number">1</span>,</span><br><span class="line">                                                                      epochs,</span><br><span class="line">                                                                      loss</span><br><span class="line">                                                                      )</span><br><span class="line">        <span class="comment"># éªŒè¯</span></span><br><span class="line">        net.eval()</span><br><span class="line">        acc = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            val_bar = tqdm(val_loader, file=sys.stdout)</span><br><span class="line">            <span class="keyword">for</span> val_data <span class="keyword">in</span> val_bar:</span><br><span class="line">                val_images, val_labels = val_data</span><br><span class="line">                outputs = net(val_images.to(device))</span><br><span class="line">                predict_y = torch.max(outputs, dim=<span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">                acc += torch.eq(predict_y, val_labels.to(device)).sum().item()</span><br><span class="line">        val_accuracy = acc / val_num</span><br><span class="line">        print(<span class="string">"[epoch %d ] train_loss: %3f    val_accurancy: %3f"</span> %</span><br><span class="line">              (epoch + <span class="number">1</span>, running_loss / train_steps, val_accuracy))</span><br><span class="line">        <span class="keyword">if</span> val_accuracy &gt; best_accuracy:</span><br><span class="line">            best_accuracy = val_accuracy</span><br><span class="line">            torch.save(net.state_dict(), save_path)</span><br><span class="line">    print(<span class="string">"Finshed Training."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    os.environ[<span class="string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="string">"1"</span></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="é¢„æµ‹-1"><a href="#é¢„æµ‹-1" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h4><p><code>predict.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">é¢„æµ‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> im_weight_gln.model <span class="keyword">import</span> GoogLeNetImageClass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    im_class = GoogLeNetImageClass()</span><br><span class="line">    url = <span class="string">'http://192.168.3.18:300/files/group1/M00/11/0E/wKgCBWRUgjWAGTfNAAEKiw0XSZc371.jpg'</span></span><br><span class="line">    img_bytes = urlopen(url).read()</span><br><span class="line">    img_pil = Image.open(BytesIO(img_bytes))</span><br><span class="line"></span><br><span class="line">    print(im_class.detection(img_pil))</span><br><span class="line">    print(im_class.detection(Image.open(<span class="string">"-532576361772532412_120.jpg"</span>).convert(<span class="string">"RGB"</span>)))</span><br></pre></td></tr></table></figure><h3 id="ResNet-ResNext"><a href="#ResNet-ResNext" class="headerlink" title="ResNet/ResNext"></a>ResNet/ResNext</h3><h4 id="ç¥ç»ç½‘ç»œ-3"><a href="#ç¥ç»ç½‘ç»œ-3" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><p><code>model.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">ResNetræ¨¡å‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> PR, ResNet_model</span><br><span class="line"></span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">model_urls = &#123;</span><br><span class="line">    <span class="string">'resnet18'</span>: <span class="string">'https://download.pytorch.org/models/resnet18-5c106cde.pth'</span>,</span><br><span class="line">    <span class="string">'resnet34'</span>: <span class="string">'https://download.pytorch.org/models/resnet34-333f7ec4.pth'</span>,</span><br><span class="line">    <span class="string">'resnet50'</span>: <span class="string">'https://download.pytorch.org/models/resnet50-19c8e357.pth'</span>,</span><br><span class="line">    <span class="string">'resnet101'</span>: <span class="string">'https://download.pytorch.org/models/resnet101-5d3b4d8f.pth'</span>,</span><br><span class="line">    <span class="string">'resnet152'</span>: <span class="string">'https://download.pytorch.org/models/resnet152-b121ed2d.pth'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># å®šä¹‰ BasicBlock æ¨¡å—</span></span><br><span class="line"><span class="string"># ResNet18/34çš„æ®‹å·®ç»“æ„, ç”¨çš„æ˜¯2ä¸ª3x3å¤§å°çš„å·ç§¯</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicBlock</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">1</span>  <span class="comment"># æ®‹å·®ç»“æ„ä¸­, åˆ¤æ–­ä¸»åˆ†æ”¯çš„å·ç§¯æ ¸ä¸ªæ•°æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œä¸å˜åˆ™ä¸º1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channel, out_channel, stride=<span class="number">1</span>, downsample=None, **kwargs)</span>:</span>  <span class="comment"># downsample å¯¹åº”è™šçº¿æ®‹å·®ç»“æ„</span></span><br><span class="line">        super(BasicBlock, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(in_channels=in_channel, out_channels=out_channel,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, stride=stride, padding=<span class="number">1</span>, bias=<span class="literal">False</span></span><br><span class="line">                               )</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(out_channel)</span><br><span class="line">        self.relu = nn.ReLU()</span><br><span class="line">        self.conv2 = nn.Conv2d(in_channels=out_channel, out_channels=out_channel,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span></span><br><span class="line">                               )</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(out_channel)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        identity = x</span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  <span class="comment"># è™šçº¿æ®‹å·®ç»“æ„ï¼Œéœ€è¦ä¸‹é‡‡æ ·</span></span><br><span class="line">            identity = self.downsample(x)  <span class="comment"># æ·å¾„åˆ†æ”¯short cut</span></span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line"></span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># å®šä¹‰ Bottleneck æ¨¡å—</span></span><br><span class="line"><span class="string"># ResNet50/101/152çš„æ®‹å·®ç»“æ„ï¼Œç”¨çš„æ˜¯1x1+3x3+1x1çš„å·ç§¯</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    #   æ³¨æ„ï¼šåŸè®ºæ–‡ä¸­ï¼Œåœ¨è™šçº¿æ®‹å·®ç»“æ„çš„ä¸»åˆ†æ”¯ä¸Šï¼Œç¬¬ä¸€ä¸ª1x1å·ç§¯å±‚çš„æ­¥è·æ˜¯2ï¼Œç¬¬äºŒä¸ª3x3å·ç§¯å±‚æ­¥è·æ˜¯1ã€‚</span></span><br><span class="line"><span class="string">    #  ä½†åœ¨pytorchå®˜æ–¹å®ç°è¿‡ç¨‹ä¸­æ˜¯ç¬¬ä¸€ä¸ª1x1å·ç§¯å±‚çš„æ­¥è·æ˜¯1ï¼Œç¬¬äºŒä¸ª3x3å·ç§¯å±‚æ­¥è·æ˜¯2ï¼Œ</span></span><br><span class="line"><span class="string">    #   è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯èƒ½å¤Ÿåœ¨top1ä¸Šæå‡å¤§æ¦‚0.5%çš„å‡†ç¡®ç‡ã€‚</span></span><br><span class="line"><span class="string">    #   å¯å‚è€ƒResnet v1.5 https://ngc.nvidia.com/catalog/model-scripts/nvidia:resnet_50_v1_5_for_pytorch</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">    expansion = <span class="number">4</span>  <span class="comment"># æ®‹å·®ç»“æ„ä¸­ç¬¬ä¸‰å±‚å·ç§¯æ ¸ä¸ªæ•°æ˜¯ç¬¬1/2å±‚å·ç§¯æ ¸ä¸ªæ•°çš„4å€</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channel, out_channel, stride=<span class="number">1</span>, downsample=None, groups=<span class="number">1</span>, width_per_group=<span class="number">64</span>)</span>:</span></span><br><span class="line">        super(Bottleneck, self).__init__()</span><br><span class="line"></span><br><span class="line">        width = int(out_channel * (width_per_group / <span class="number">64.</span>)) * groups</span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Conv2d(in_channels=in_channel, out_channels=width, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(width)</span><br><span class="line"></span><br><span class="line">        self.conv2 = nn.Conv2d(in_channels=width, out_channels=width, groups=groups,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, stride=stride, bias=<span class="literal">False</span>, padding=<span class="number">1</span></span><br><span class="line">                               )</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(width)</span><br><span class="line"></span><br><span class="line">        self.conv3 = nn.Conv2d(in_channels=width, out_channels=out_channel * self.expansion,</span><br><span class="line">                               kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(out_channel * self.expansion)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        identity = x</span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            identity = self.downsample(x)  <span class="comment"># æ·å¾„åˆ†æ”¯short cut</span></span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># æ®‹å·®ç½‘ç»œç»“æ„</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="comment"># block = BasicBlock or Bottleneck</span></span><br><span class="line">    <span class="comment"># blocks_num ä¸ºæ®‹å·®ç»“æ„ä¸­ conv2_x~conv5_x ä¸­æ®‹å·®å—ä¸ªæ•°, ä¸€ä¸ªåˆ—è¡¨</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, block, blocks_num, num_classes=<span class="number">1000</span>, include_top=True, groups=<span class="number">1</span>, width_per_group=<span class="number">64</span>)</span>:</span></span><br><span class="line">        super(ResNet, self).__init__()</span><br><span class="line">        self.include_top = include_top</span><br><span class="line">        self.in_channel = <span class="number">64</span></span><br><span class="line">        self.groups = groups</span><br><span class="line">        self.width_per_group = width_per_group</span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">3</span>, self.in_channel, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(self.in_channel)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">64</span>, blocks_num[<span class="number">0</span>])</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, blocks_num[<span class="number">1</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, blocks_num[<span class="number">2</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.layer4 = self._make_layer(block, <span class="number">512</span>, blocks_num[<span class="number">3</span>], stride=<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> self.include_top:</span><br><span class="line">            self.avgpool = nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>))  <span class="comment"># output size = (1, 1)</span></span><br><span class="line">            self.fc = nn.Linear(<span class="number">512</span> * block.expansion, num_classes)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight, mode=<span class="string">'fan_out'</span>, nonlinearity=<span class="string">'relu'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># channel ä¸ºæ®‹å·®ç»“æ„ä¸­ç¬¬1å±‚å·ç§¯æ ¸ä¸ªæ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span><span class="params">(self, block, channel, block_num, stride=<span class="number">1</span>)</span>:</span></span><br><span class="line">        downsample = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># ResNet50/101/152 çš„æ®‹å·®ç»“æ„, block.expansion=4</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.in_channel != channel * block.expansion:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(self.in_channel, channel * block.expansion, kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(channel * block.expansion)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(block(self.in_channel,</span><br><span class="line">                            channel,</span><br><span class="line">                            downsample=downsample,</span><br><span class="line">                            stride=stride,</span><br><span class="line">                            groups=self.groups,</span><br><span class="line">                            width_per_group=self.width_per_group,</span><br><span class="line">                            ))</span><br><span class="line">        self.in_channel = channel * block.expansion</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1</span>, block_num):</span><br><span class="line">            layers.append(block(self.in_channel,</span><br><span class="line">                                channel,</span><br><span class="line">                                groups=self.groups,</span><br><span class="line">                                width_per_group=self.width_per_group,</span><br><span class="line">                                ))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.bn1(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line">        x = self.maxpool(x)</span><br><span class="line"></span><br><span class="line">        x = self.layer1(x)</span><br><span class="line">        x = self.layer2(x)</span><br><span class="line">        x = self.layer3(x)</span><br><span class="line">        x = self.layer4(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.include_top:</span><br><span class="line">            x = self.avgpool(x)</span><br><span class="line">            x = torch.flatten(x, <span class="number">1</span>)</span><br><span class="line">            x = self.fc(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># resnet34 ç»“æ„</span></span><br><span class="line"><span class="string"># https://download.pytorch.org/models/resnet34-333f7ec4.pth</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet34</span><span class="params">(num_classes=<span class="number">1000</span>, include_top=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], num_classes=num_classes, include_top=include_top)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># resnet50 ç»“æ„</span></span><br><span class="line"><span class="string"># https://download.pytorch.org/models/resnet50-19c8e357.pth</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet50</span><span class="params">(num_classes=<span class="number">1000</span>, include_top=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], num_classes=num_classes, include_top=include_top)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># resnet101 ç»“æ„</span></span><br><span class="line"><span class="string"># https://download.pytorch.org/models/resnet101-5d3b4d8f.pth</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet101</span><span class="params">(num_classes=<span class="number">1000</span>, include_top=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>], num_classes=num_classes, include_top=include_top)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># resnet152 ç»“æ„</span></span><br><span class="line"><span class="string"># https://download.pytorch.org/models/resnet152-b121ed2d.pth</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet152</span><span class="params">(num_classes=<span class="number">1000</span>, include_top=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">8</span>, <span class="number">36</span>, <span class="number">3</span>], num_classes=num_classes, include_top=include_top)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># resnext50_32x4d ç»“æ„</span></span><br><span class="line"><span class="string"># https://download.pytorch.org/models/resnext50_32x4d-7cdf4587.pth</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnext50_32x4d</span><span class="params">(num_classes=<span class="number">1000</span>, include_top=True)</span>:</span></span><br><span class="line">    groups = <span class="number">32</span></span><br><span class="line">    width_per_group = <span class="number">4</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>],</span><br><span class="line">                  num_classes=num_classes,</span><br><span class="line">                  include_top=include_top,</span><br><span class="line">                  groups=groups,</span><br><span class="line">                  width_per_group=width_per_group)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># resnext101_32x8d ç»“æ„</span></span><br><span class="line"><span class="string"># https://download.pytorch.org/models/resnext101_32x8d-8ba56ff5.pth</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnext101_32x8d</span><span class="params">(num_classes=<span class="number">1000</span>, include_top=True)</span>:</span></span><br><span class="line">    groups = <span class="number">32</span></span><br><span class="line">    width_per_group = <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>],</span><br><span class="line">                  num_classes=num_classes,</span><br><span class="line">                  include_top=include_top,</span><br><span class="line">                  groups=groups,</span><br><span class="line">                  width_per_group=width_per_group)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNetImageClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</span></span><br><span class="line">        self.device = torch.device(<span class="string">"cpu"</span>)</span><br><span class="line">        self.data_transform = transforms.Compose([</span><br><span class="line">            transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">        ])</span><br><span class="line">        self.json_path = <span class="string">"im_weight_Res/class_j/class_indices.json"</span></span><br><span class="line">        self.weights_path = <span class="string">f"im_weight_Res/weights/<span class="subst">&#123;ResNet_model&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">        self.model = resnet152(num_classes=<span class="number">13</span>).to(self.device)</span><br><span class="line">        self.model.load_state_dict(torch.load(self.weights_path, map_location=self.device))</span><br><span class="line">        self.model.eval()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(self.json_path, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.class_indices = json.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detection</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        img = self.data_transform(img) <span class="comment"># [N, C H, W]</span></span><br><span class="line">        img = torch.unsqueeze(img, dim=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            output = torch.squeeze(self.model(img.to(self.device))).cpu()</span><br><span class="line">            predict = torch.softmax(output, dim=<span class="number">0</span>)</span><br><span class="line">            predict_cla = torch.argmax(predict).numpy()</span><br><span class="line">            result = &#123;</span><br><span class="line">                <span class="string">'class'</span>: predict_cla.tolist(),</span><br><span class="line">                <span class="string">'prob'</span>: predict[predict_cla].numpy().tolist()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒ-2"><a href="#è®­ç»ƒ-2" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><p><code>train.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">è®­ç»ƒ(GPU)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms, datasets, utils</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> resnet152</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">    print(<span class="string">f"use device is <span class="subst">&#123;device&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    data_transform = &#123;</span><br><span class="line">        <span class="string">"train"</span>: transforms.Compose([</span><br><span class="line">            transforms.RandomResizedCrop(<span class="number">224</span>),</span><br><span class="line">            transforms.RandomHorizontalFlip(),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize([<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">        ]),</span><br><span class="line">        <span class="string">"val"</span>: transforms.Compose([</span><br><span class="line">            transforms.Resize(<span class="number">256</span>),</span><br><span class="line">            transforms.CenterCrop(<span class="number">224</span>),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize([<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]),</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">    data_root = os.path.abspath(os.path.join(os.getcwd(), <span class="string">"./"</span>))</span><br><span class="line">    image_path = <span class="string">"/exp/work/algorithm/vgg/data_set/data"</span></span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(image_path), <span class="string">"&#123;&#125; path does not exist."</span>.format(image_path)</span><br><span class="line">    train_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"train"</span>),</span><br><span class="line">                                         transform=data_transform[<span class="string">"train"</span>]</span><br><span class="line">                                         )</span><br><span class="line">    train_num = len(train_dataset)</span><br><span class="line">    flower_list = train_dataset.class_to_idx</span><br><span class="line">    cla_dict = dict((val, key) <span class="keyword">for</span> key, val <span class="keyword">in</span> flower_list.items())</span><br><span class="line">    json_str = json.dumps(cla_dict, indent=<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"calss_indices.json"</span>, <span class="string">'w'</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">        json_file.write(json_str)</span><br><span class="line"></span><br><span class="line">    batch_size = <span class="number">16</span></span><br><span class="line">    nw = min([os.cpu_count(), batch_size <span class="keyword">if</span> batch_size &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>, <span class="number">8</span>])  <span class="comment"># çº¿ç¨‹æ•°è®¡ç®—</span></span><br><span class="line">    nw = <span class="number">0</span></span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;nw&#125;</span> dataloader workers every process."</span>)</span><br><span class="line"></span><br><span class="line">    train_loader = torch.utils.data.DataLoader(train_dataset,</span><br><span class="line">                                               batch_size=batch_size,</span><br><span class="line">                                               shuffle=<span class="literal">True</span>,</span><br><span class="line">                                               num_workers=nw</span><br><span class="line">                                               )</span><br><span class="line">    val_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"val"</span>),</span><br><span class="line">                                       transform=data_transform[<span class="string">"val"</span>]</span><br><span class="line">                                       )</span><br><span class="line">    val_num = len(val_dataset)</span><br><span class="line">    val_loader = torch.utils.data.DataLoader(val_dataset,</span><br><span class="line">                                             batch_size=<span class="number">4</span>,</span><br><span class="line">                                             shuffle=<span class="literal">False</span>,</span><br><span class="line">                                             num_workers=nw</span><br><span class="line">                                             )</span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;train_num&#125;</span> images for training, <span class="subst">&#123;val_num&#125;</span> images for validation."</span>)</span><br><span class="line"></span><br><span class="line">    net = resnet152()  <span class="comment"># å®ä¾‹åŒ–ç½‘ç»œ</span></span><br><span class="line">    <span class="comment"># load pretrain weights</span></span><br><span class="line">    <span class="comment"># download url: https://download.pytorch.org/models/resnet34-333f7ec4.pth</span></span><br><span class="line">    <span class="comment"># """</span></span><br><span class="line">    model_weight_path = <span class="string">"./ResNet152_GPU_v2.pth"</span></span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(model_weight_path), <span class="string">"file &#123;&#125; does not exist."</span>.format(model_weight_path)</span><br><span class="line">    net.load_state_dict(torch.load(model_weight_path, map_location=<span class="string">'cpu'</span>))</span><br><span class="line">    <span class="comment"># """</span></span><br><span class="line">    <span class="comment"># for param in net.parameters():</span></span><br><span class="line">    <span class="comment">#     param.requires_grad = False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># change fc layer structure</span></span><br><span class="line">    in_channel = net.fc.in_features</span><br><span class="line">    net.fc = nn.Linear(in_channel, <span class="number">13</span>)  <span class="comment"># (5åˆ†ç±»)</span></span><br><span class="line">    net.to(device)</span><br><span class="line">    loss_function = nn.CrossEntropyLoss()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct an optimizer</span></span><br><span class="line">    <span class="comment"># optimizer = optim.Adam(net.parameters(), lr=0.0001)</span></span><br><span class="line">    params = [p <span class="keyword">for</span> p <span class="keyword">in</span> net.parameters() <span class="keyword">if</span> p.requires_grad]</span><br><span class="line">    optimizer = optim.Adam(params, lr=<span class="number">0.0001</span>)</span><br><span class="line"></span><br><span class="line">    epochs = <span class="number">300</span></span><br><span class="line">    save_path = <span class="string">"./ResNet152_GPU_RE.pth"</span></span><br><span class="line">    best_accuracy = <span class="number">0.0</span></span><br><span class="line">    train_steps = len(train_loader)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(epochs):</span><br><span class="line">        net.train()</span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        train_bar = tqdm(train_loader, file=sys.stdout)</span><br><span class="line">        <span class="keyword">for</span> step, data <span class="keyword">in</span> enumerate(train_bar):</span><br><span class="line">            images, labels = data</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            logits = net(images.to(device))</span><br><span class="line">            loss = loss_function(logits, labels.to(device))  <span class="comment"># è®¡ç®—æŸå¤±å‡½æ•°</span></span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            running_loss += loss.item()</span><br><span class="line">            train_bar.desc = <span class="string">"train epoch [&#123;&#125;/&#123;&#125;] loss:&#123;:.3f&#125;"</span>.format(epoch + <span class="number">1</span>,</span><br><span class="line">                                                                      epochs,</span><br><span class="line">                                                                      loss</span><br><span class="line">                                                                      )</span><br><span class="line">        <span class="comment"># éªŒè¯</span></span><br><span class="line">        net.eval()</span><br><span class="line">        acc = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            val_bar = tqdm(val_loader, file=sys.stdout)</span><br><span class="line">            <span class="keyword">for</span> val_data <span class="keyword">in</span> val_bar:</span><br><span class="line">                val_images, val_labels = val_data</span><br><span class="line">                outputs = net(val_images.to(device))</span><br><span class="line">                predict_y = torch.max(outputs, dim=<span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">                acc += torch.eq(predict_y, val_labels.to(device)).sum().item()</span><br><span class="line">        val_accuracy = acc / val_num</span><br><span class="line">        print(<span class="string">"[epoch %d ] train_loss: %3f    val_accurancy: %3f"</span> %</span><br><span class="line">              (epoch + <span class="number">1</span>, running_loss / train_steps, val_accuracy))</span><br><span class="line">        <span class="keyword">if</span> val_accuracy &gt; best_accuracy:</span><br><span class="line">            best_accuracy = val_accuracy</span><br><span class="line">            torch.save(net.state_dict(), save_path)</span><br><span class="line">    print(<span class="string">"Finished Training."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="é¢„æµ‹-2"><a href="#é¢„æµ‹-2" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h4><p><code>predict.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">é¢„æµ‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> im_weight_Res.model <span class="keyword">import</span> ResNetImageClass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    im_class = ResNetImageClass()</span><br><span class="line">    url = <span class="string">'http://192.168.3.18:300/files/group1/M00/11/0E/wKgCBWRUgjWAGTfNAAEKiw0XSZc371.jpg'</span></span><br><span class="line">    img_bytes = urlopen(url).read()</span><br><span class="line">    img_pil = Image.open(BytesIO(img_bytes))</span><br><span class="line"></span><br><span class="line">    print(im_class.detection(img_pil))</span><br><span class="line">    print(im_class.detection(Image.open(<span class="string">"-532576361772532412_120.jpg"</span>).convert(<span class="string">"RGB"</span>)))</span><br></pre></td></tr></table></figure><h3 id="AlexNet"><a href="#AlexNet" class="headerlink" title="AlexNet"></a>AlexNet</h3><h4 id="ç¥ç»ç½‘ç»œ-4"><a href="#ç¥ç»ç½‘ç»œ-4" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><p><code>model.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlexNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_classes=<span class="number">1000</span>, init_weights=False)</span>:</span></span><br><span class="line">        super(AlexNet, self).__init__()</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        ç‰¹å¾æå–</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.features = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">3</span>, <span class="number">48</span>, kernel_size=<span class="number">11</span>, stride=<span class="number">4</span>, padding=<span class="number">2</span>),   <span class="comment"># è¾“å…¥[3, 224, 224] è¾“å‡º[48, 55, 55]</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),  <span class="comment"># è¾“å‡º [48,27,27]</span></span><br><span class="line">            nn.Conv2d(<span class="number">48</span>, <span class="number">128</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>),   <span class="comment"># è¾“å‡º [128, 27, 27]</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),  <span class="comment"># è¾“å‡º [128, 13, 13]</span></span><br><span class="line">            nn.Conv2d(<span class="number">128</span>, <span class="number">192</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),  <span class="comment"># è¾“å‡º[192, 13, 13]</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">192</span>, <span class="number">192</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>), <span class="comment"># è¾“å‡º[192, 13, 13]</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">192</span>, <span class="number">128</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),  <span class="comment"># è¾“å‡º[128, 13, 13]</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>)   <span class="comment"># è¾“å‡º [128, 6, 6]</span></span><br><span class="line">        )</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆ†ç±»å™¨</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.classifier = nn.Sequential(</span><br><span class="line">            nn.Dropout(p=<span class="number">0.5</span>),  <span class="comment"># Dropout éšæœºå¤±æ´»ç¥ç»å…ƒ, æ¯”ä¾‹è¯¶0.5</span></span><br><span class="line">            nn.Linear(<span class="number">128</span> * <span class="number">6</span> * <span class="number">6</span>, <span class="number">2048</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Dropout(p=<span class="number">0.5</span>),</span><br><span class="line">            nn.Linear(<span class="number">2048</span>, <span class="number">2048</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Linear(<span class="number">2048</span>, num_classes)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> init_weights:</span><br><span class="line">            self._initialize_weights()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.features(x)</span><br><span class="line">        x = torch.flatten(x, start_dim=<span class="number">1</span>)</span><br><span class="line">        x = self.classifier(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    æƒé‡åˆå§‹åŒ–</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize_weights</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight, mode=<span class="string">'fan_out'</span>, nonlinearity=<span class="string">'relu'</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.Linear):</span><br><span class="line">                nn.init.normal_(m.weight, <span class="number">0.01</span>)</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒ-3"><a href="#è®­ç»ƒ-3" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><p><code>train.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">è®­ç»ƒ(GPU)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms, datasets, utils</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> AlexNet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">    print(<span class="string">f"use device is <span class="subst">&#123;device&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    data_transform = &#123;</span><br><span class="line">        <span class="string">"train"</span>: transforms.Compose([</span><br><span class="line">            transforms.RandomResizedCrop(<span class="number">224</span>),</span><br><span class="line">            transforms.RandomHorizontalFlip(),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)),</span><br><span class="line">        ]),</span><br><span class="line">        <span class="string">"val"</span>: transforms.Compose([</span><br><span class="line">            transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)),</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">    data_root = os.path.abspath(os.path.join(os.getcwd(), <span class="string">"./"</span>))</span><br><span class="line">    image_path = os.path.join(data_root, <span class="string">"data_set"</span>, <span class="string">"flower_data"</span>)</span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(image_path), <span class="string">"&#123;&#125; path does not exist."</span>.format(image_path)</span><br><span class="line">    train_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"train"</span>),</span><br><span class="line">                                         transform=data_transform[<span class="string">"train"</span>]</span><br><span class="line">                                         )</span><br><span class="line">    train_num = len(train_dataset)</span><br><span class="line">    flower_list = train_dataset.class_to_idx</span><br><span class="line">    cla_dict = dict((val, key) <span class="keyword">for</span> key, val <span class="keyword">in</span> flower_list.items())</span><br><span class="line">    json_str = json.dumps(cla_dict, indent=<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"calss_indices.json"</span>, <span class="string">'w'</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">        json_file.write(json_str)</span><br><span class="line"></span><br><span class="line">    batch_size = <span class="number">32</span></span><br><span class="line">    nw = min([os.cpu_count(), batch_size <span class="keyword">if</span> batch_size &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>, <span class="number">8</span>])  <span class="comment"># çº¿ç¨‹æ•°è®¡ç®—</span></span><br><span class="line">    nw = <span class="number">0</span></span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;nw&#125;</span> dataloader workers every process."</span>)</span><br><span class="line"></span><br><span class="line">    train_loader = torch.utils.data.DataLoader(train_dataset,</span><br><span class="line">                                               batch_size=batch_size,</span><br><span class="line">                                               shuffle=<span class="literal">True</span>,</span><br><span class="line">                                               num_workers=nw</span><br><span class="line">                                               )</span><br><span class="line">    val_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="string">"val"</span>),</span><br><span class="line">                                       transform=data_transform[<span class="string">"val"</span>]</span><br><span class="line">                                       )</span><br><span class="line">    val_num = len(val_dataset)</span><br><span class="line">    val_loader = torch.utils.data.DataLoader(val_dataset,</span><br><span class="line">                                             batch_size=<span class="number">4</span>,</span><br><span class="line">                                             shuffle=<span class="literal">False</span>,</span><br><span class="line">                                             num_workers=nw</span><br><span class="line">                                             )</span><br><span class="line">    print(<span class="string">f"Using <span class="subst">&#123;train_num&#125;</span> images for training, <span class="subst">&#123;val_num&#125;</span> images for validation."</span>)</span><br><span class="line"></span><br><span class="line">    net = AlexNet(num_classes=<span class="number">5</span>, init_weights=<span class="literal">True</span>)</span><br><span class="line">    net.to(device)</span><br><span class="line">    loss_function = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr=<span class="number">0.0002</span>)</span><br><span class="line"></span><br><span class="line">    epochs = <span class="number">10</span></span><br><span class="line">    save_path = <span class="string">"./AlexNet.pth"</span></span><br><span class="line">    best_accuracy = <span class="number">0.0</span></span><br><span class="line">    train_steps = len(train_loader)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(epochs):</span><br><span class="line">        net.train()</span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        train_bar = tqdm(train_loader, file=sys.stdout)</span><br><span class="line">        <span class="keyword">for</span> step, data <span class="keyword">in</span> enumerate(train_bar):</span><br><span class="line">            images, labels = data</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            outputs = net(images.to(device))</span><br><span class="line">            loss = loss_function(outputs, labels.to(device))</span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            running_loss += loss.item()</span><br><span class="line">            train_bar.desc = <span class="string">"train epoch [&#123;&#125;/&#123;&#125;] loss:&#123;:.3f&#125;"</span>.format(epoch + <span class="number">1</span>,</span><br><span class="line">                                                                      epochs,</span><br><span class="line">                                                                      loss</span><br><span class="line">                                                                      )</span><br><span class="line">        <span class="comment"># éªŒè¯</span></span><br><span class="line">        net.eval()</span><br><span class="line">        acc = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            val_bar = tqdm(val_loader, file=sys.stdout)</span><br><span class="line">            <span class="keyword">for</span> val_data <span class="keyword">in</span> val_bar:</span><br><span class="line">                val_images, val_labels = val_data</span><br><span class="line">                outputs = net(val_images.to(device))</span><br><span class="line">                predict_y = torch.max(outputs, dim=<span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">                acc += torch.eq(predict_y, val_labels.to(device)).sum().item()</span><br><span class="line">        val_accuracy = acc / val_num</span><br><span class="line">        print(<span class="string">"[epoch %d ] train_loss: %3f    val_accurancy: %3f"</span> %</span><br><span class="line">              (epoch + <span class="number">1</span>, running_loss / train_steps, val_accuracy))</span><br><span class="line">        <span class="keyword">if</span> val_accuracy &gt; best_accuracy:</span><br><span class="line">            best_accuracy = val_accuracy</span><br><span class="line">            torch.save(net.state_dict(), save_path)</span><br><span class="line">    print(<span class="string">"Finshed Training."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="é¢„æµ‹-3"><a href="#é¢„æµ‹-3" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h4><p>ï¼ˆæš‚æœªå°è£…ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">é¢„æµ‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> AlexNet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line"></span><br><span class="line">    data_transform = transforms.Compose([</span><br><span class="line">        transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    image_path = <span class="string">"./sunflowers01.jpg"</span></span><br><span class="line">    img = Image.open(image_path)</span><br><span class="line">    plt.imshow(img)</span><br><span class="line">    img = data_transform(img)  <span class="comment"># [N, C H, W]</span></span><br><span class="line">    img = torch.unsqueeze(img, dim=<span class="number">0</span>)  <span class="comment"># ç»´åº¦æ‰©å±•</span></span><br><span class="line">    <span class="comment"># print(f"img=&#123;img&#125;")</span></span><br><span class="line">    json_path = <span class="string">"./calss_indices.json"</span></span><br><span class="line">    <span class="keyword">with</span> open(json_path, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        class_indict = json.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># model = AlexNet(num_classes=5).to(device)   # GPU</span></span><br><span class="line">    model = AlexNet(num_classes=<span class="number">5</span>)  <span class="comment"># CPU</span></span><br><span class="line">    weights_path = <span class="string">"./AlexNet.pth"</span></span><br><span class="line">    model.load_state_dict(torch.load(weights_path))</span><br><span class="line">    model.eval()  <span class="comment"># å…³é—­ Dorpout</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="comment"># output = torch.squeeze(model(img.to(device))).cpu()   #GPU</span></span><br><span class="line">        output = torch.squeeze(model(img))  <span class="comment"># ç»´åº¦å‹ç¼©</span></span><br><span class="line">        predict = torch.softmax(output, dim=<span class="number">0</span>)</span><br><span class="line">        predict_cla = torch.argmax(predict).numpy()</span><br><span class="line">        print_res = <span class="string">"class: &#123;&#125;  prob: &#123;:.3&#125;"</span>.format(class_indict[str(predict_cla)],</span><br><span class="line">                                                    predict[predict_cla].numpy())</span><br><span class="line">        plt.title(print_res)</span><br><span class="line">        <span class="comment"># for i in range(len(predict)):</span></span><br><span class="line">        <span class="comment">#     print("class: &#123;&#125;  prob: &#123;:.3&#125;".format(class_indict[str(predict_cla)],</span></span><br><span class="line">        <span class="comment">#                                             predict[predict_cla].numpy()))</span></span><br><span class="line">        plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="LeNet"><a href="#LeNet" class="headerlink" title="LeNet"></a>LeNet</h3><h4 id="ç¥ç»ç½‘ç»œ-5"><a href="#ç¥ç»ç½‘ç»œ-5" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><p><code>model.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeNet</span><span class="params">(nn.Module)</span>:</span>  <span class="comment"># é›†æˆnn.Moduleçˆ¶ç±»</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(LeNet, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># çœ‹ä¸€ä¸‹å…·ä½“çš„å‚æ•°</span></span><br><span class="line">        self.conv1 = nn.Conv2d(in_channels=<span class="number">3</span>,</span><br><span class="line">                               out_channels=<span class="number">16</span>,</span><br><span class="line">                               kernel_size=<span class="number">5</span>,</span><br><span class="line">                               stride=<span class="number">1</span>,</span><br><span class="line">                               padding=<span class="number">0</span>,</span><br><span class="line">                               bias=<span class="literal">True</span></span><br><span class="line">                               )</span><br><span class="line">        self.pool1 = nn.MaxPool2d(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(<span class="number">16</span>, <span class="number">32</span>, <span class="number">5</span>)</span><br><span class="line">        self.pool2 = nn.MaxPool2d(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        self.fc1 = nn.Linear(<span class="number">32</span> * <span class="number">5</span> * <span class="number">5</span>, <span class="number">120</span>)</span><br><span class="line">        self.fc2 = nn.Linear(<span class="number">120</span>, <span class="number">84</span>)</span><br><span class="line">        self.fc3 = nn.Linear(<span class="number">84</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># self.relu = nn.ReLU(inplace=True)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ­£å‘ä¼ æ’­</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = F.relu(self.conv1(x))  <span class="comment"># è¾“å…¥: (3, 32, 32), è¾“å‡º: (16, 28, 28)</span></span><br><span class="line">        x = self.pool1(x)  <span class="comment"># è¾“å‡º: (16, 14, 14)</span></span><br><span class="line">        x = F.relu(self.conv2(x))  <span class="comment"># è¾“å‡º: (32, 10, 10)</span></span><br><span class="line">        x = self.pool2(x)  <span class="comment"># è¾“å‡º: (32, 5, 5)</span></span><br><span class="line">        x = x.view(<span class="number">-1</span>, <span class="number">32</span> * <span class="number">5</span> * <span class="number">5</span>)  <span class="comment"># è¾“å‡º: (32*5*5)</span></span><br><span class="line">        x = F.relu(self.fc1(x))  <span class="comment"># è¾“å‡º: (120)</span></span><br><span class="line">        x = F.relu(self.fc2(x))  <span class="comment"># è¾“å‡º: (84)</span></span><br><span class="line">        x = self.fc3(x)  <span class="comment"># è¾“å‡º(10)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒ-4"><a href="#è®­ç»ƒ-4" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><p><code>train.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">è®­ç»ƒ</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> LeNet</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.ToTensor(),  <span class="comment"># æ•°æ®è½¬ä¸ºå¼ é‡</span></span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))  <span class="comment"># æ ‡å‡†åŒ–å¤„ç†</span></span><br><span class="line">    ])</span><br><span class="line">    <span class="comment"># å¯¼å…¥è®­ç»ƒé›†æ•°æ®(50000å¼ å›¾ç‰‡)</span></span><br><span class="line">    train_set = torchvision.datasets.CIFAR10(root=<span class="string">'./data'</span>,  <span class="comment"># root: æ•°æ®é›†å­˜å‚¨è·¯å¾„</span></span><br><span class="line">                                             train=<span class="literal">True</span>,  <span class="comment"># æ•°æ®é›†ä¸ºè®­ç»ƒé›†</span></span><br><span class="line">                                             download=<span class="literal">False</span>,  <span class="comment"># download: Trueæ—¶ä¸‹è½½æ•°æ®é›†(ä¸‹è½½å®Œæˆä¿®æ”¹ä¸ºFalse)</span></span><br><span class="line">                                             transform=transform  <span class="comment"># æ•°æ®é¢„å¤„ç†</span></span><br><span class="line">                                             )</span><br><span class="line">    <span class="comment">#   åŠ è½½è®­ç»ƒé›†</span></span><br><span class="line">    train_loader = torch.utils.data.DataLoader(train_set,  <span class="comment"># åŠ è½½è®­ç»ƒé›†</span></span><br><span class="line">                                               batch_size=<span class="number">50</span>,  <span class="comment"># batch å¤§å°</span></span><br><span class="line">                                               shuffle=<span class="literal">True</span>,  <span class="comment"># æ˜¯å¦éšæœºæ‰“ä¹±è®­ç»ƒé›†</span></span><br><span class="line">                                               num_workers=<span class="number">0</span>  <span class="comment"># ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">                                               )</span><br><span class="line">    <span class="comment"># å¯¼å…¥æµ‹è¯•é›†(10000å¼ å›¾ç‰‡)</span></span><br><span class="line">    val_set = torchvision.datasets.CIFAR10(root=<span class="string">'./data'</span>,</span><br><span class="line">                                           train=<span class="literal">False</span>,  <span class="comment"># æ•°æ®é›†ä¸ºæµ‹è¯•é›†</span></span><br><span class="line">                                           download=<span class="literal">False</span>,</span><br><span class="line">                                           transform=transform</span><br><span class="line">                                           )</span><br><span class="line">    <span class="comment"># åŠ è½½æµ‹è¯•é›†æ•°æ®</span></span><br><span class="line">    val_loader = torch.utils.data.DataLoader(val_set,</span><br><span class="line">                                             batch_size=<span class="number">10000</span>,  <span class="comment"># æµ‹è¯•é›†batchå¤§å°</span></span><br><span class="line">                                             shuffle=<span class="literal">False</span>,</span><br><span class="line">                                             num_workers=<span class="number">0</span></span><br><span class="line">                                             )</span><br><span class="line">    <span class="comment"># è·å–æµ‹è¯•é›†ä¸­çš„å›¾ç‰‡å’Œæ ‡ç­¾</span></span><br><span class="line">    val_data_iter = iter(val_loader)</span><br><span class="line">    <span class="comment"># val_image, val_label = val_data_iter.next()</span></span><br><span class="line">    val_image, val_label = next(val_data_iter)  <span class="comment"># python 3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # -------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">    æŸ¥çœ‹æ•°æ®é›†, æ³¨æ„ä¿®æ”¹æŸ¥çœ‹æ•°æ®é›†çš„ batch</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># å®šä¹‰çš„åˆ†ç±»æ ‡ç­¾</span></span><br><span class="line">    <span class="comment"># class_labels = ('plane', 'car', 'bird', 'cat', 'deer', 'dog', 'frog', 'horse', 'ship', 'truck')</span></span><br><span class="line">    <span class="comment"># æŸ¥çœ‹æ•°æ®é›†çš„å›¾ç‰‡</span></span><br><span class="line">    <span class="comment">#  def img_show(img):</span></span><br><span class="line">    <span class="comment">#      img = img / 2 + 0.5</span></span><br><span class="line">    <span class="comment">#      np_img = img.numpy()</span></span><br><span class="line">    <span class="comment">#      plt.imshow(np.transpose(np_img, (1, 2, 0)))</span></span><br><span class="line">    <span class="comment">#      plt.show()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#  # æŸ¥çœ‹æ•°æ®é›†ä¸­çš„5å¼ å›¾åƒ</span></span><br><span class="line">    <span class="comment">#  print(''.join(" %5s " % class_labels[val_label[j]] for j in range(5)))</span></span><br><span class="line">    <span class="comment">#  img_show(torchvision.utils.make_grid(val_image))</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # -------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ˜¯å¦æ”¯æŒCPU</span></span><br><span class="line">    <span class="comment"># if torch.cuda.is_available():</span></span><br><span class="line">    <span class="comment">#     use_dev = torch.device("cuda")</span></span><br><span class="line">    <span class="comment"># else:</span></span><br><span class="line">    <span class="comment">#     use_dev = torch.device("cpu")</span></span><br><span class="line">    <span class="comment"># print(use_dev)</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line"></span><br><span class="line">    net = LeNet()  <span class="comment"># ç”¨äºè®­ç»ƒçš„ç½‘ç»œæ¨¡å‹</span></span><br><span class="line">    <span class="comment"># æŒ‡å®šGPU or CPU è¿›è¡Œè®­ç»ƒ</span></span><br><span class="line">    net.to(<span class="string">"cpu"</span>)</span><br><span class="line">    loss_function = nn.CrossEntropyLoss()  <span class="comment"># æŸå¤±å‡½æ•°(äº¤å‰ç†µå‡½æ•°)</span></span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr=<span class="number">0.001</span>)  <span class="comment"># ä¼˜åŒ–å™¨(è®­ç»ƒå‚æ•°, å­¦ä¹ ç‡)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®­ç»ƒçš„è½®æ•°</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        start_time = time.perf_counter()</span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># éå†è®­ç»ƒé›†, ä»0å¼€å§‹</span></span><br><span class="line">        <span class="keyword">for</span> step, data <span class="keyword">in</span> enumerate(train_loader, start=<span class="number">0</span>):</span><br><span class="line">            inputs, labels = data  <span class="comment"># å¾—åˆ°è®­ç»ƒé›†å›¾ç‰‡å’Œæ ‡ç­¾</span></span><br><span class="line">            optimizer.zero_grad()  <span class="comment"># æ¸…é™¤å†å²æ¢¯åº¦</span></span><br><span class="line">            outputs = net(inputs)  <span class="comment"># æ­£å‘ä¼ æ’­</span></span><br><span class="line">            loss = loss_function(outputs, labels)  <span class="comment"># æŸå¤±è®¡ç®—</span></span><br><span class="line">            loss.backward()  <span class="comment"># åå‘ä¼ æ’­</span></span><br><span class="line">            optimizer.step()  <span class="comment"># ä¼˜åŒ–å™¨æ›´æ–°å‚æ•°</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç”¨äºæ‰“å°ç²¾ç¡®ç‡ç­‰è¯„ä¼°å‚æ•°</span></span><br><span class="line">            running_loss += loss.item()</span><br><span class="line">            <span class="keyword">if</span> step % <span class="number">500</span> == <span class="number">499</span>:  <span class="comment"># 500æ­¥æ‰“å°ä¸€æ¬¡</span></span><br><span class="line">                <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">                    outputs = net(val_image)  <span class="comment"># ä¼ å…¥æµ‹è¯•é›†æ•°æ®</span></span><br><span class="line">                    predict_y = torch.max(outputs, dim=<span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">                    accuracy = torch.eq(predict_y, val_label).sum().item() / val_label.size(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># æ‰“å°è®­ç»ƒè½®æ•°ã€ç²¾ç¡®ç‡ç­‰</span></span><br><span class="line">                    print(<span class="string">"[%d, %5d] train_loss: %.3f   test_accuracy: %.3f"</span> %</span><br><span class="line">                          (epoch + <span class="number">1</span>, step + <span class="number">1</span>, running_loss / <span class="number">500</span>, accuracy)</span><br><span class="line">                          )</span><br><span class="line">                    running_loss = <span class="number">0.0</span></span><br><span class="line">        end_time = time.perf_counter()</span><br><span class="line">        print(<span class="string">"cost time = "</span>, end_time - start_time)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Finished trainning"</span>)</span><br><span class="line"></span><br><span class="line">    save_path = <span class="string">"./LeNet.pth"</span></span><br><span class="line">    torch.save(net.state_dict(), save_path)  <span class="comment"># ä¿å­˜è®­ç»ƒè¾“å‡ºçš„æ¨¡å‹æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="é¢„æµ‹-4"><a href="#é¢„æµ‹-4" class="headerlink" title="é¢„æµ‹"></a>é¢„æµ‹</h4><p>ï¼ˆæš‚æœªå°è£…ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""""</span></span><br><span class="line"><span class="string">æµ‹è¯•</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> LeNet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.Resize((<span class="number">32</span>, <span class="number">32</span>)),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    data_class = (<span class="string">'plane'</span>, <span class="string">'car'</span>, <span class="string">'bird'</span>, <span class="string">'cat'</span>, <span class="string">'deer'</span>, <span class="string">'dog'</span>, <span class="string">'frog'</span>, <span class="string">'horse'</span>, <span class="string">'ship'</span>, <span class="string">'truck'</span>)</span><br><span class="line"></span><br><span class="line">    net = LeNet()</span><br><span class="line">    net.load_state_dict(torch.load(<span class="string">'LeNet.pth'</span>))</span><br><span class="line">    <span class="comment"># net.load_state_dict(torch.load('LeNet.pth', map_location=torch.device("cpu")))</span></span><br><span class="line"></span><br><span class="line">    test_image = Image.open(<span class="string">'cat_test2.jpg'</span>)</span><br><span class="line">    test_image = transform(test_image)  <span class="comment"># [C H W]</span></span><br><span class="line">    test_image = torch.unsqueeze(test_image, dim=<span class="number">0</span>)  <span class="comment"># [N C H W]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        outputs = net(test_image)</span><br><span class="line">        predict = torch.max(outputs, dim=<span class="number">1</span>)[<span class="number">1</span>].numpy()</span><br><span class="line">    print(<span class="string">f"It is <span class="subst">&#123;data_class[int(predict)]&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç›®å½•ç»“æ„&quot;&gt;&lt;a href=&quot;#ç›®å½•ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;ç›®å½•ç»“æ„&quot;&gt;&lt;/a&gt;ç›®å½•ç»“æ„&lt;/h2&gt;&lt;h3 id=&quot;è®­ç»ƒç»“æ„&quot;&gt;&lt;a href=&quot;#è®­ç»ƒç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;è®­ç»ƒç»“æ„&quot;&gt;&lt;/a&gt;è®­ç»ƒç»“æ„&lt;/h3&gt;&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt;&lt;/font&gt; åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ•°æ®é›†æ–‡ä»¶å¤¹&lt;code&gt;data_set&lt;/code&gt;ï¼Œå»ºç«‹å­æ–‡ä»¶å¤¹ï¼ˆæ•°æ®é›†åç§°ï¼‰ç”¨äºå­˜æ”¾è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼›&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt;&lt;/font&gt; åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ•°æ®é›†æ–‡ä»¶å¤¹&lt;code&gt;class_j&lt;/code&gt;ï¼Œç”¨äºå­˜æ”¾åˆ†ç±»jsonæ–‡ä»¶ï¼›&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt;&lt;/font&gt; åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ•°æ®é›†æ–‡ä»¶å¤¹&lt;code&gt;models&lt;/code&gt;ï¼Œç”¨äºå­˜æ”¾è®­ç»ƒå¥½çš„æ¨¡å‹æ–‡ä»¶ï¼›&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt;&lt;/font&gt; ç¥ç»ç½‘ç»œ&lt;code&gt;model.py&lt;/code&gt;ï¼›&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt;&lt;/font&gt; è®­ç»ƒè„šæœ¬&lt;code&gt;train.py&lt;/code&gt;ï¼›&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt;&lt;/font&gt; é¢„æµ‹è„šæœ¬&lt;code&gt;predict.py&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; project&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”œâ”€â”€ data_set&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	â”œâ”€â”€ data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â”œâ”€â”€ train&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â”‚    â”œâ”€â”€ 00001.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â”‚    â”œâ”€â”€ 00002.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â”‚    â”œâ”€â”€ 00003.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â”‚    â”œâ”€â”€ ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â”‚    â””â”€â”€ 10000.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	     â””â”€â”€ val&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	          â”œâ”€â”€ 00001.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	          â”œâ”€â”€ 00002.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	          â”œâ”€â”€ 00003.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	          â”œâ”€â”€ ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	          â””â”€â”€ 01000.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”œâ”€â”€ class_j&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	â”œâ”€â”€ class_indices.json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”œâ”€â”€ models&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	â”œâ”€â”€ model.pth&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”œâ”€â”€ model.py&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”œâ”€â”€ train.py&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â””â”€â”€ predict.py&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;å°è£…ç»“æ„&quot;&gt;&lt;a href=&quot;#å°è£…ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;å°è£…ç»“æ„&quot;&gt;&lt;/a&gt;å°è£…ç»“æ„&lt;/h3&gt;&lt;p&gt;ä»¥&lt;code&gt;GoogLeNet&lt;/code&gt;ç¥ç»ç½‘ç»œä¸ºä¾‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; GoogLeNet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”œâ”€â”€ class_j&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	â”œâ”€â”€ class_indices.json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚â”€â”€ weights&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â”‚	â”œâ”€â”€ GoogLeNet_GPU_v1.pth&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;â””â”€â”€ model.py&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://yoursite.com/categories/æ·±åº¦å­¦ä¹ /"/>
    
    
    <category term="VGG" scheme="http://yoursite.com/tags/VGG/"/>
    
    <category term="AlexNet" scheme="http://yoursite.com/tags/AlexNet/"/>
    
    <category term="LeNet" scheme="http://yoursite.com/tags/LeNet/"/>
    
    <category term="GoogLeNet" scheme="http://yoursite.com/tags/GoogLeNet/"/>
    
    <category term="ResNet" scheme="http://yoursite.com/tags/ResNet/"/>
    
    <category term="å·ç§¯ç¥ç»ç½‘ç»œ" scheme="http://yoursite.com/tags/å·ç§¯ç¥ç»ç½‘ç»œ/"/>
    
  </entry>
  
  <entry>
    <title>CentOS-LibreOfficeå·¥å…·åŒ…å®‰è£…</title>
    <link href="http://yoursite.com/2023/12/28/CentOS-LibreOffice%E5%B7%A5%E5%85%B7%E5%8C%85%E5%AE%89%E8%A3%85/"/>
    <id>http://yoursite.com/2023/12/28/CentOS-LibreOffice%E5%B7%A5%E5%85%B7%E5%8C%85%E5%AE%89%E8%A3%85/</id>
    <published>2023-12-28T06:43:49.000Z</published>
    <updated>2023-12-28T07:05:48.623Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><p><strong>Â·</strong> <font color="gold">ç³»ç»Ÿï¼š</font> CentOS7</p><p><strong>Â·</strong> <font color="gold">LibreOfficeï¼š</font> 7.4.5.1 ç¨³å®šç‰ˆ</p><h2 id="èµ„æºä¸‹è½½"><a href="#èµ„æºä¸‹è½½" class="headerlink" title="èµ„æºä¸‹è½½"></a>èµ„æºä¸‹è½½</h2><p><strong>Â·</strong> å®˜æ–¹ç½‘ç«™ï¼š <a href="https://zh-cn.libreoffice.org/download/libreoffice/" target="_blank" rel="noopener">https://zh-cn.libreoffice.org/download/libreoffice/</a></p><p><strong>Â·</strong> ä¸‹è½½åœ°å€ï¼š<a href="https://downloadarchive.documentfoundation.org/libreoffice/old/7.4.5.1/rpm/x86_64/" target="_blank" rel="noopener">https://downloadarchive.documentfoundation.org/libreoffice/old/7.4.5.1/rpm/x86_64/</a></p><p>é€‰æ‹©<code>LibreOffice_7.4.5.1_Linux_x86-64_rpm.tar.gz</code>å®‰è£…åŒ…å’Œ<code>LibreOffice_7.4.5.1_Linux_x86-64_rpm_langpack_zh-CN.tar.gz</code>ä¸­æ–‡è¯­è¨€åŒ…å¹¶ä¸‹è½½</p><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>è¿›å…¥å®‰è£…åŒ…ä¸‹è½½ç›®å½•è¿›è¡Œè§£å‹ï¼Œè¿™é‡Œä¸º<code>/usr/local/</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/   è¿›å…¥ç›®å½•</span><br><span class="line">tar -zxvf LibreOffice_7.4.6.1_Linux_x86-64_rpm.tar.gz   è§£å‹libreoffice</span><br><span class="line">tar -zxvf LibreOffice7.4.6.1_Linux_x86-64_rpm_langpack_zh-CN.tar.gz   è§£å‹ä¸­æ–‡è¯­è¨€åŒ…</span><br></pre></td></tr></table></figure><p>å®‰è£…<code>libreoffice</code>å’Œè¯­è¨€åŒ…çš„rpmåŒ…ï¼Œé»˜è®¤å®‰è£…ç›®å½•ä¸º<code>/opt/libreoffice7.4</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/LibreOffice_7.4.6.1_Linux_x86-64_rpm/RPMS/</span><br><span class="line">yum -y install *.rpm</span><br><span class="line">cd /usr/local/LibreOffice_7.4.6.1_Linux_x86-64_rpm_langpack_zh-CN/RPMS</span><br><span class="line">yum -y install *.rpm</span><br></pre></td></tr></table></figure><p>å®‰è£…<code>soffice</code>ï¼Œè¿›å…¥<code>/opt/libreoffice7.4/program</code>ç›®å½•æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/libreoffice7.4/program/</span><br><span class="line">yum install cairo </span><br><span class="line">yum install cups-libs</span><br><span class="line">yum install libSM</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/libreoffice7.4/program/soffice -help</span><br></pre></td></tr></table></figure><p>æ­£å¸¸è¾“å‡ºï¼Œå®‰è£…æˆåŠŸï¼Œæ¥ä¸‹æ¥å°†<code>soffice</code>æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> libreoffice</span><br><span class="line">export LibreOffice_PATH=/opt/libreoffice7.4/program</span><br><span class="line">export PATH=$LibreOffice_PATH:$PATH</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="å®‰è£…ä¸­æ–‡å­—ä½“åŒ…"><a href="#å®‰è£…ä¸­æ–‡å­—ä½“åŒ…" class="headerlink" title="å®‰è£…ä¸­æ–‡å­—ä½“åŒ…"></a>å®‰è£…ä¸­æ–‡å­—ä½“åŒ…</h2><p>windowsç³»ç»Ÿå­—ä½“åŒ…ä½äºè·¯å¾„<code>C:\Windows\Font</code>ä¸‹</p><p>centosç³»ç»Ÿå­—ä½“åŒ…ä½äºè·¯å¾„<code>/usr/share/fonts</code>ä¸‹</p><p>è¿›å…¥<code>/usr/share/fonts</code>åˆ›å»ºwindowsç³»ç»Ÿå­—ä½“åŒ…ç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/fonts/</span><br><span class="line">mkdir windowsFont</span><br></pre></td></tr></table></figure><p>å°†windowså­—ä½“æ–‡ä»¶å…¨éƒ¨æ‹·è´è¿›è¯¥è·¯å¾„ä¸‹ï¼Œæ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfontscale</span><br><span class="line">mkfontdir</span><br><span class="line">fc-cache</span><br></pre></td></tr></table></figure><p>å®Œæˆï¼å¯ä»¥åœ¨linuxç³»ç»Ÿä¸‹é¡ºåˆ©æ“ä½œ<code>.docs</code>ã€<code>.pdf</code>ç­‰æ–‡æ¡£æ–‡ä»¶ï¼Œåœ¨langchain-chatchatä¸­æ·»åŠ æ–‡æ¡£å½¢çŸ¥è¯†åº“ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;ç³»ç»Ÿï¼š&lt;/font&gt; CentOS7&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;LibreOfficeï¼š&lt;/font&gt; 7.4.5.1 ç¨³å®šç‰ˆ&lt;/p&gt;
&lt;h2 id=&quot;èµ„æºä¸‹è½½&quot;&gt;&lt;a href=&quot;#èµ„æºä¸‹è½½&quot; class=&quot;headerlink&quot; title=&quot;èµ„æºä¸‹è½½&quot;&gt;&lt;/a&gt;èµ„æºä¸‹è½½&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; å®˜æ–¹ç½‘ç«™ï¼š &lt;a href=&quot;https://zh-cn.libreoffice.org/download/libreoffice/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://zh-cn.libreoffice.org/download/libreoffice/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; ä¸‹è½½åœ°å€ï¼š&lt;a href=&quot;https://downloadarchive.documentfoundation.org/libreoffice/old/7.4.5.1/rpm/x86_64/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://downloadarchive.documentfoundation.org/libreoffice/old/7.4.5.1/rpm/x86_64/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;é€‰æ‹©&lt;code&gt;LibreOffice_7.4.5.1_Linux_x86-64_rpm.tar.gz&lt;/code&gt;å®‰è£…åŒ…å’Œ&lt;code&gt;LibreOffice_7.4.5.1_Linux_x86-64_rpm_langpack_zh-CN.tar.gz&lt;/code&gt;ä¸­æ–‡è¯­è¨€åŒ…å¹¶ä¸‹è½½&lt;/p&gt;
&lt;h2 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h2&gt;&lt;p&gt;è¿›å…¥å®‰è£…åŒ…ä¸‹è½½ç›®å½•è¿›è¡Œè§£å‹ï¼Œè¿™é‡Œä¸º&lt;code&gt;/usr/local/&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cd /usr/local/   è¿›å…¥ç›®å½•&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tar -zxvf LibreOffice_7.4.6.1_Linux_x86-64_rpm.tar.gz   è§£å‹libreoffice&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tar -zxvf LibreOffice7.4.6.1_Linux_x86-64_rpm_langpack_zh-CN.tar.gz   è§£å‹ä¸­æ–‡è¯­è¨€åŒ…&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å®‰è£…&lt;code&gt;libreoffice&lt;/code&gt;å’Œè¯­è¨€åŒ…çš„rpmåŒ…ï¼Œé»˜è®¤å®‰è£…ç›®å½•ä¸º&lt;code&gt;/opt/libreoffice7.4&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cd /usr/local/LibreOffice_7.4.6.1_Linux_x86-64_rpm/RPMS/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install *.rpm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cd /usr/local/LibreOffice_7.4.6.1_Linux_x86-64_rpm_langpack_zh-CN/RPMS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install *.rpm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å®‰è£…&lt;code&gt;soffice&lt;/code&gt;ï¼Œè¿›å…¥&lt;code&gt;/opt/libreoffice7.4/program&lt;/code&gt;ç›®å½•æ‰§è¡Œ&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cd /opt/libreoffice7.4/program/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install cairo &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install cups-libs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install libSM&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æ£€æŸ¥&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/opt/libreoffice7.4/program/soffice -help&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æ­£å¸¸è¾“å‡ºï¼Œå®‰è£…æˆåŠŸï¼Œæ¥ä¸‹æ¥å°†&lt;code&gt;soffice&lt;/code&gt;æ·»åŠ åˆ°ç¯å¢ƒå˜é‡&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;vim /etc/profile&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;/span&gt; libreoffice&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;export LibreOffice_PATH=/opt/libreoffice7.4/program&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;export PATH=$LibreOffice_PATH:$PATH&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;source /etc/profile&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://yoursite.com/categories/Linux/"/>
    
    
    <category term="linuxå·¥å…·" scheme="http://yoursite.com/tags/linuxå·¥å…·/"/>
    
    <category term="LibreOffice" scheme="http://yoursite.com/tags/LibreOffice/"/>
    
  </entry>
  
  <entry>
    <title>LangChain + ChatGLM2-6Bçš„æœ¬åœ°çŸ¥è¯†é—®ç­”åº“</title>
    <link href="http://yoursite.com/2023/10/24/LangChain%20+%20ChatGLM2-6B%E7%9A%84%E6%9C%AC%E5%9C%B0%E7%9F%A5%E8%AF%86%E9%97%AE%E7%AD%94%E5%BA%93/"/>
    <id>http://yoursite.com/2023/10/24/LangChain%20+%20ChatGLM2-6B%E7%9A%84%E6%9C%AC%E5%9C%B0%E7%9F%A5%E8%AF%86%E9%97%AE%E7%AD%94%E5%BA%93/</id>
    <published>2023-10-24T01:14:34.000Z</published>
    <updated>2023-11-06T08:31:28.442Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><p>åŸé¡¹ç›®Githubï¼š<a href="https://github.com/imClumsyPanda/langchain-ChatGLM" target="_blank" rel="noopener">https://github.com/imClumsyPanda/langchain-ChatGLM</a></p><h2 id="é¡¹ç›®éƒ¨ç½²"><a href="#é¡¹ç›®éƒ¨ç½²" class="headerlink" title="é¡¹ç›®éƒ¨ç½²"></a>é¡¹ç›®éƒ¨ç½²</h2><p><strong>Â·</strong> <font color="gold">v 0.2.6</font></p><h3 id="æœºå™¨é…ç½®ï¼š"><a href="#æœºå™¨é…ç½®ï¼š" class="headerlink" title="æœºå™¨é…ç½®ï¼š"></a>æœºå™¨é…ç½®ï¼š</h3><p><strong>Â·</strong> <font color="gold">python ç¯å¢ƒï¼šanaconda3 + python3.10.12</font></p><p><strong>Â·</strong> <font color="gold">GPUï¼šRTX3090*2 + CUDA11.7</font></p><p><strong>Â·</strong> <font color="gold">torchï¼š2.0.1ï¼ˆCUDAæœªå‡è‡³12ï¼‰</font></p><p><strong>Â·</strong> <font color="gold">condaï¼špy310_dtglm</font></p><h3 id="æ¨¡å‹ä¸‹è½½"><a href="#æ¨¡å‹ä¸‹è½½" class="headerlink" title="æ¨¡å‹ä¸‹è½½"></a>æ¨¡å‹ä¸‹è½½</h3><p><strong>Â·</strong> <font color="gold">m3e</font> <a href="https://huggingface.co/moka-ai/m3e-base/tree/main" target="_blank" rel="noopener">https://huggingface.co/moka-ai/m3e-base/tree/main</a></p><p><strong>Â·</strong> <font color="gold">chatglm2-6b</font> <a href="https://huggingface.co/THUDM/chatglm2-6b/tree/main" target="_blank" rel="noopener">https://huggingface.co/THUDM/chatglm2-6b/tree/main</a></p><p>chatglmæ¸…åæº <a href="https://cloud.tsinghua.edu.cn/d/674208019e314311ab5c/?p=%2F&amp;mode=list" target="_blank" rel="noopener">https://cloud.tsinghua.edu.cn/d/674208019e314311ab5c/?p=%2F&amp;mode=list</a></p><p>(è¿™é‡Œå°†æ¨¡å‹å…¨éƒ¨ä¸‹è½½è‡³<code>/root/huggingface</code>ä¸‹)</p><h3 id="åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–"><a href="#åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–" class="headerlink" title="åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–"></a>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conda create -n py310_dtglm python=3.10.12</span><br><span class="line">conda activate py310_dtglm</span><br><span class="line"></span><br><span class="line">pip install --use-pep517 -r requirements.txt -i https://mirror.baidu.com/pypi/simple</span><br><span class="line">pip install --use-pep517 -r requirements_api.txt -i https://mirror.baidu.com/pypi/simple</span><br><span class="line">pip install --use-pep517 -r requirements_webui.txt -i https://mirror.baidu.com/pypi/simple</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„"><a href="#ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„" class="headerlink" title="ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„"></a>ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„</h3><p>å¤åˆ¶é…ç½®æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python copy_config_example.py</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p><p><strong>Â·</strong> <font color="gold">model_config.py</font></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MODEL_ROOT_PATH = <span class="string">"/root/huggingface"</span></span><br><span class="line"></span><br><span class="line">MODEL_PATH = &#123;</span><br><span class="line">    <span class="string">"embed_model"</span>: &#123;</span><br><span class="line">...</span><br><span class="line">        <span class="string">"m3e-base"</span>: <span class="string">"/root/huggingface/m3e-base"</span>, <span class="comment"># ä¿®æ”¹m3eæ¨¡å‹è·¯å¾„</span></span><br><span class="line">...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> add all supported llm models</span></span><br><span class="line">    <span class="string">"llm_model"</span>: &#123;</span><br><span class="line">...</span><br><span class="line">        <span class="string">"chatglm2-6b"</span>: <span class="string">"/root/huggingface/chatglm2-6b"</span>, <span class="comment"># ä¿®æ”¹chatglm2-6bæ¨¡å‹è·¯å¾„</span></span><br><span class="line">...</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EMBEDDING_MODEL = <span class="string">"m3e-base"</span> <span class="comment"># å¯ä»¥å°è¯•æœ€æ–°çš„åµŒå…¥å¼sotaæ¨¡å‹ï¼šbge-large-zh-v1.5</span></span><br><span class="line">LLM_MODEL = <span class="string">"chatglm2-6b"</span></span><br></pre></td></tr></table></figure><a id="more"></a><p><strong>Â·</strong> <font color="gold">server_config.py</font></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># webui.py server</span></span><br><span class="line">WEBUI_SERVER = &#123;</span><br><span class="line">    <span class="string">"host"</span>: DEFAULT_BIND_HOST,</span><br><span class="line">    <span class="string">"port"</span>: <span class="number">8501</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># api.py server</span></span><br><span class="line">API_SERVER = &#123;</span><br><span class="line">    <span class="string">"host"</span>: DEFAULT_BIND_HOST,</span><br><span class="line">    <span class="string">"port"</span>: <span class="number">7861</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastchat openai_api server</span></span><br><span class="line">FSCHAT_OPENAI_API = &#123;</span><br><span class="line">    <span class="string">"host"</span>: DEFAULT_BIND_HOST,</span><br><span class="line">    <span class="string">"port"</span>: <span class="number">20000</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FSCHAT_MODEL_WORKERS = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"host"</span>: DEFAULT_BIND_HOST,</span><br><span class="line">        <span class="string">"port"</span>: <span class="number">20002</span>,</span><br><span class="line">        <span class="string">"device"</span>: LLM_DEVICE,</span><br><span class="line">        <span class="string">"infer_turbo"</span>: <span class="literal">False</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># model_workerå¤šå¡åŠ è½½éœ€è¦é…ç½®çš„å‚æ•°</span></span><br><span class="line">        <span class="string">"gpus"</span>: <span class="string">"0,1"</span>, <span class="comment"># ä½¿ç”¨çš„GPUï¼Œä»¥strçš„æ ¼å¼æŒ‡å®šï¼Œå¦‚"0,1"ï¼Œå¦‚å¤±æ•ˆè¯·ä½¿ç”¨CUDA_VISIBLE_DEVICES="0,1"ç­‰å½¢å¼æŒ‡å®š</span></span><br><span class="line">        <span class="string">"num_gpus"</span>: <span class="number">2</span>, <span class="comment"># ä½¿ç”¨GPUçš„æ•°é‡</span></span><br><span class="line">        <span class="string">"max_gpu_memory"</span>: <span class="string">"20GiB"</span>, <span class="comment"># æ¯ä¸ªGPUå ç”¨çš„æœ€å¤§æ˜¾å­˜</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">"zhipu-api"</span>: &#123; <span class="comment"># è¯·ä¸ºæ¯ä¸ªè¦è¿è¡Œçš„åœ¨çº¿APIè®¾ç½®ä¸åŒçš„ç«¯å£</span></span><br><span class="line">        <span class="string">"port"</span>: <span class="number">21001</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastchat controller server</span></span><br><span class="line">FSCHAT_CONTROLLER = &#123;</span><br><span class="line">    <span class="string">"host"</span>: DEFAULT_BIND_HOST,</span><br><span class="line">    <span class="string">"port"</span>: <span class="number">20001</span>,</span><br><span class="line">    <span class="string">"dispatch_method"</span>: <span class="string">"shortest_queue"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–é»˜è®¤çŸ¥è¯†åº“"><a href="#åˆå§‹åŒ–é»˜è®¤çŸ¥è¯†åº“" class="headerlink" title="åˆå§‹åŒ–é»˜è®¤çŸ¥è¯†åº“"></a>åˆå§‹åŒ–é»˜è®¤çŸ¥è¯†åº“</h3><p>æ ·ä¾‹çŸ¥è¯†åº“æ–‡ä»¶ä½ç½®ï¼š<code>knowledge_base/samples/content/test.txt</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python init_database.py --recreate-vs</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨é¡¹ç›®"><a href="#å¯åŠ¨é¡¹ç›®" class="headerlink" title="å¯åŠ¨é¡¹ç›®"></a>å¯åŠ¨é¡¹ç›®</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python startup.py -a</span><br></pre></td></tr></table></figure><p><img src="/2023/10/24/LangChain + ChatGLM2-6Bçš„æœ¬åœ°çŸ¥è¯†é—®ç­”åº“/A.png" alt></p><h3 id="é€šè¿‡fastapiæ¥å£æ·»åŠ çŸ¥è¯†åº“"><a href="#é€šè¿‡fastapiæ¥å£æ·»åŠ çŸ¥è¯†åº“" class="headerlink" title="é€šè¿‡fastapiæ¥å£æ·»åŠ çŸ¥è¯†åº“"></a>é€šè¿‡fastapiæ¥å£æ·»åŠ çŸ¥è¯†åº“</h3><p><code>http://host:7861/knowledge_base/upload_docs</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -X 'POST' \</span><br><span class="line">  'http://host:7861/knowledge_base/upload_docs' \</span><br><span class="line">  -H 'accept: application/json' \</span><br><span class="line">  -H 'Content-Type: multipart/form-data' \</span><br><span class="line">  -F 'to_vector_store=true' \</span><br><span class="line">  -F 'override=false' \</span><br><span class="line">  -F 'not_refresh_vs_cache=false' \</span><br><span class="line">  -F 'chunk_size=250' \</span><br><span class="line">  -F 'chunk_overlap=50' \</span><br><span class="line">  -F 'zh_title_enhance=true' \</span><br><span class="line">  -F 'files=@åˆ†ä½“å¼Må½•AIæ™ºèƒ½åˆ†æè®¾å¤‡å»ºè®¾æ–¹æ¡ˆ.docx;type=application/vnd.openxmlformats-officedocument.wordprocessingml.document' \</span><br><span class="line">  -F 'knowledge_base_name=ç…çŠ' \</span><br><span class="line">  -F 'docs='</span><br></pre></td></tr></table></figure><p><img src="/2023/10/24/LangChain + ChatGLM2-6Bçš„æœ¬åœ°çŸ¥è¯†é—®ç­”åº“/B.png" alt></p><h3 id="é€‰æ‹©çŸ¥è¯†åº“é—®ç­”"><a href="#é€‰æ‹©çŸ¥è¯†åº“é—®ç­”" class="headerlink" title="é€‰æ‹©çŸ¥è¯†åº“é—®ç­”"></a>é€‰æ‹©çŸ¥è¯†åº“é—®ç­”</h3><p><img src="/2023/10/24/LangChain + ChatGLM2-6Bçš„æœ¬åœ°çŸ¥è¯†é—®ç­”åº“/C.png" alt></p><p><img src="/2023/10/24/LangChain + ChatGLM2-6Bçš„æœ¬åœ°çŸ¥è¯†é—®ç­”åº“/D.png" alt></p><h2 id="ä»£ç è°ƒæ•´"><a href="#ä»£ç è°ƒæ•´" class="headerlink" title="ä»£ç è°ƒæ•´"></a>ä»£ç è°ƒæ•´</h2><h3 id="ç™¾å·å¤§æ¨¡å‹æ¥å…¥"><a href="#ç™¾å·å¤§æ¨¡å‹æ¥å…¥" class="headerlink" title="ç™¾å·å¤§æ¨¡å‹æ¥å…¥"></a>ç™¾å·å¤§æ¨¡å‹æ¥å…¥</h3><p>è°ƒæ•´<code>./configs/model_config.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"llm_model"</span>: &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'baichuan-13b-chat'</span>:<span class="string">'/home/Baichuan2-main/baichuan-inc/Baichuan2-13B-Chat'</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># LLM åç§°</span></span><br><span class="line">LLM_MODEL = <span class="string">"baichuan-13b-chat"</span></span><br></pre></td></tr></table></figure><h3 id="æ¥å£æµå¼è¾“å‡º"><a href="#æ¥å£æµå¼è¾“å‡º" class="headerlink" title="æ¥å£æµå¼è¾“å‡º"></a>æ¥å£æµå¼è¾“å‡º</h3><p>å®‰è£…sse_starlette</p><p><code>pip install sse-starlette -i https://mirror.baidu.com/pypi/simple</code></p><p>è¿›å…¥<code>./chat/*.py</code>ï¼Œä¿®æ”¹æ¥å£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sse_starlette.sse <span class="keyword">import</span> EventSourceResponse</span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> EventSourceResponse(chat_iterator(query=query,</span><br><span class="line">                                         history=history,</span><br><span class="line">                                         model_name=model_name,</span><br><span class="line">                                         prompt_name=prompt_name))</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*æ³¨é‡Šå†…å®¹ */</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸé¡¹ç›®Githubï¼š&lt;a href=&quot;https://github.com/imClumsyPanda/langchain-ChatGLM&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/imClumsyPanda/langchain-ChatGLM&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;é¡¹ç›®éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#é¡¹ç›®éƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;é¡¹ç›®éƒ¨ç½²&quot;&gt;&lt;/a&gt;é¡¹ç›®éƒ¨ç½²&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;v 0.2.6&lt;/font&gt;&lt;/p&gt;
&lt;h3 id=&quot;æœºå™¨é…ç½®ï¼š&quot;&gt;&lt;a href=&quot;#æœºå™¨é…ç½®ï¼š&quot; class=&quot;headerlink&quot; title=&quot;æœºå™¨é…ç½®ï¼š&quot;&gt;&lt;/a&gt;æœºå™¨é…ç½®ï¼š&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;python ç¯å¢ƒï¼šanaconda3 + python3.10.12&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;GPUï¼šRTX3090*2 + CUDA11.7&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;torchï¼š2.0.1ï¼ˆCUDAæœªå‡è‡³12ï¼‰&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;condaï¼špy310_dtglm&lt;/font&gt;&lt;/p&gt;
&lt;h3 id=&quot;æ¨¡å‹ä¸‹è½½&quot;&gt;&lt;a href=&quot;#æ¨¡å‹ä¸‹è½½&quot; class=&quot;headerlink&quot; title=&quot;æ¨¡å‹ä¸‹è½½&quot;&gt;&lt;/a&gt;æ¨¡å‹ä¸‹è½½&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;m3e&lt;/font&gt; &lt;a href=&quot;https://huggingface.co/moka-ai/m3e-base/tree/main&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://huggingface.co/moka-ai/m3e-base/tree/main&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;chatglm2-6b&lt;/font&gt; &lt;a href=&quot;https://huggingface.co/THUDM/chatglm2-6b/tree/main&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://huggingface.co/THUDM/chatglm2-6b/tree/main&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;chatglmæ¸…åæº &lt;a href=&quot;https://cloud.tsinghua.edu.cn/d/674208019e314311ab5c/?p=%2F&amp;amp;mode=list&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://cloud.tsinghua.edu.cn/d/674208019e314311ab5c/?p=%2F&amp;amp;mode=list&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;(è¿™é‡Œå°†æ¨¡å‹å…¨éƒ¨ä¸‹è½½è‡³&lt;code&gt;/root/huggingface&lt;/code&gt;ä¸‹)&lt;/p&gt;
&lt;h3 id=&quot;åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–&quot;&gt;&lt;a href=&quot;#åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–&quot; class=&quot;headerlink&quot; title=&quot;åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–&quot;&gt;&lt;/a&gt;åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…ä¾èµ–&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;conda create -n py310_dtglm python=3.10.12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;conda activate py310_dtglm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pip install --use-pep517 -r requirements.txt -i https://mirror.baidu.com/pypi/simple&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pip install --use-pep517 -r requirements_api.txt -i https://mirror.baidu.com/pypi/simple&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pip install --use-pep517 -r requirements_webui.txt -i https://mirror.baidu.com/pypi/simple&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„&quot;&gt;&lt;a href=&quot;#ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„&quot; class=&quot;headerlink&quot; title=&quot;ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„&quot;&gt;&lt;/a&gt;ä¿®æ”¹é…ç½®ã€æ¨¡å‹è·¯å¾„&lt;/h3&gt;&lt;p&gt;å¤åˆ¶é…ç½®æ–‡ä»¶&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;python copy_config_example.py&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¿®æ”¹é…ç½®æ–‡ä»¶&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Â·&lt;/strong&gt; &lt;font color=&quot;gold&quot;&gt;model_config.py&lt;/font&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;MODEL_ROOT_PATH = &lt;span class=&quot;string&quot;&gt;&quot;/root/huggingface&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MODEL_PATH = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;embed_model&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;m3e-base&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;/root/huggingface/m3e-base&quot;&lt;/span&gt;, &lt;span class=&quot;comment&quot;&gt;# ä¿®æ”¹m3eæ¨¡å‹è·¯å¾„&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# &lt;span class=&quot;doctag&quot;&gt;TODO:&lt;/span&gt; add all supported llm models&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;llm_model&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;chatglm2-6b&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;/root/huggingface/chatglm2-6b&quot;&lt;/span&gt;, &lt;span class=&quot;comment&quot;&gt;# ä¿®æ”¹chatglm2-6bæ¨¡å‹è·¯å¾„&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMBEDDING_MODEL = &lt;span class=&quot;string&quot;&gt;&quot;m3e-base&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# å¯ä»¥å°è¯•æœ€æ–°çš„åµŒå…¥å¼sotaæ¨¡å‹ï¼šbge-large-zh-v1.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LLM_MODEL = &lt;span class=&quot;string&quot;&gt;&quot;chatglm2-6b&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="GPT" scheme="http://yoursite.com/categories/GPT/"/>
    
    
    <category term="langchain-chatchat" scheme="http://yoursite.com/tags/langchain-chatchat/"/>
    
    <category term="chat-glm" scheme="http://yoursite.com/tags/chat-glm/"/>
    
    <category term="baichuan" scheme="http://yoursite.com/tags/baichuan/"/>
    
  </entry>
  
  <entry>
    <title>Nebula3é›†ç¾¤ç‰ˆæ–°æ—§ç‰ˆæœ¬å¤šå¼€</title>
    <link href="http://yoursite.com/2023/09/28/Nebula3%E9%9B%86%E7%BE%A4%E7%89%88%E7%89%88%E6%9C%AC%E5%A4%9A%E5%BC%80/"/>
    <id>http://yoursite.com/2023/09/28/Nebula3%E9%9B%86%E7%BE%A4%E7%89%88%E7%89%88%E6%9C%AC%E5%A4%9A%E5%BC%80/</id>
    <published>2023-09-28T02:10:10.000Z</published>
    <updated>2023-11-03T09:32:18.875Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><font color="gold"><strong>Â·</strong> ç³»ç»Ÿï¼šCentOS7</font><font color="gold"><strong>Â·</strong> å·²æœ‰nebulaç‰ˆæœ¬ï¼š2.6.1ï¼ˆå¼€æºç¤¾åŒºç‰ˆï¼‰</font><font color="gold"><strong>Â·</strong> å·²æœ‰nebula-consoleç‰ˆæœ¬ï¼š2.6.0</font><font color="gold"><strong>Â·</strong> å·²æœ‰nebula-graph-studioç‰ˆæœ¬ï¼š3.2.3</font><font color="gold"><strong>Â·</strong> å¤šå¼€nebulaç‰ˆæœ¬ï¼š3.6.0ï¼ˆå¼€æºç¤¾åŒºç‰ˆï¼‰</font><font color="gold"><strong>Â·</strong> å¤šå¼€nebula-graph-studioç‰ˆæœ¬ï¼š3.2.3</font><font color="gold"><strong>Â·</strong> å¤šå¼€nebula-consoleç‰ˆæœ¬ï¼š3.6.0</font><h2 id="é›†ç¾¤éƒ¨ç½²"><a href="#é›†ç¾¤éƒ¨ç½²" class="headerlink" title="é›†ç¾¤éƒ¨ç½²"></a>é›†ç¾¤éƒ¨ç½²</h2><p><strong>Â·</strong> å‚è€ƒå•æœºéƒ¨ç½²æ–¹å¼ï¼Œå¯¹é…ç½®æ–‡ä»¶<code>--meta_server_addrs</code>åšæ‰©å±•ï¼Œæ·»åŠ metaæœºå™¨</p><p><strong>Â·</strong> åŒºåˆ†2.6.1ç‰ˆæœ¬å·²è¢«å ç”¨çš„ç«¯å£ï¼Œæ‰¾åˆ°é…ç½®æ–‡ä»¶é»˜è®¤çš„<code>9559</code>ã€<code>19559</code>ã€<code>9669</code>ã€<code>19669</code>ã€<code>9779</code>ã€<code>19779</code>ç«¯å£ï¼Œä¿®æ”¹ä¸º<code>8559</code>ã€<code>18559</code>ã€<code>8669</code>ã€<code>18669</code>ã€<code>8779</code>ã€<code>18779</code></p><p><strong>Â·</strong> å¯åŠ¨é›†ç¾¤</p><p><strong>Â·</strong> é…ç½®nebula-graph-studioé»˜è®¤ç«¯å£ä¸º<code>7002</code></p><p><font color="gold"><strong>Â·</strong> æ³¨</font>ï¼šåŒå¼€nebulaåä½¿ç”¨åŒç‰ˆæœ¬nebula-graph-studioå³ä½¿æ›´æ¢äº†ç«¯å£ï¼Œä¹Ÿä¸èƒ½åŒæ—¶è¿è¡Œï¼Œå¯ä»¥å®‰è£…nebula-consoleæ¥åŒæ—¶å¯åŠ¨nebulaæ§åˆ¶å°</p><p><code>chmod 111 nebula-console</code></p><p><code>./nebula-console --addr &lt;host&gt; --port 9669 -u root -p nebula</code></p><p><code>./nebula-console --addr &lt;host&gt; --port 8669 -u root -p nebula</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt; ç³»ç»Ÿï¼šCentOS7&lt;/font&gt;

&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/str</summary>
      
    
    
    
    <category term="BigData" scheme="http://yoursite.com/categories/BigData/"/>
    
    
    <category term="database" scheme="http://yoursite.com/tags/database/"/>
    
    <category term="nebula" scheme="http://yoursite.com/tags/nebula/"/>
    
  </entry>
  
  <entry>
    <title>Nebula3å•æœºç‰ˆå¿«é€Ÿå®‰è£…</title>
    <link href="http://yoursite.com/2023/09/27/Nebula3%E5%8D%95%E6%9C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85/"/>
    <id>http://yoursite.com/2023/09/27/Nebula3%E5%8D%95%E6%9C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85/</id>
    <published>2023-09-27T08:12:31.000Z</published>
    <updated>2024-02-01T06:59:02.195Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><font color="gold"><strong>Â·</strong> ç³»ç»Ÿï¼šCentOS7</font><font color="gold"><strong>Â·</strong> nebulaç‰ˆæœ¬ï¼š3.6.0ï¼ˆå¼€æºç¤¾åŒºç‰ˆï¼‰</font><font color="gold"><strong>Â·</strong> nebula-graph-studioç‰ˆæœ¬ï¼š3.2.3</font><h2 id="å•æœºéƒ¨ç½²"><a href="#å•æœºéƒ¨ç½²" class="headerlink" title="å•æœºéƒ¨ç½²"></a>å•æœºéƒ¨ç½²</h2><h3 id="taråŒ…æºç ä¸‹è½½"><a href="#taråŒ…æºç ä¸‹è½½" class="headerlink" title="taråŒ…æºç ä¸‹è½½"></a>taråŒ…æºç ä¸‹è½½</h3><p><code>wget https://oss-cdn.nebula-graph.com.cn/package/3.6.0/nebula-graph-3.6.0.el7.x86_64.tar.gz</code></p><h3 id="è§£å‹å¹¶é‡å‘½å"><a href="#è§£å‹å¹¶é‡å‘½å" class="headerlink" title="è§£å‹å¹¶é‡å‘½å"></a>è§£å‹å¹¶é‡å‘½å</h3><p><code>tar -xvzf nebula-graph-3.6.0.el7.x86_64.tar.gz</code></p><p><code>mv nebula-graph-3.6.0.el7.x86_64 nebula</code></p><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p><code>cd nebula/etc</code></p><p><code>mv nebula-graphd.conf.default nebula-graphd.conf</code></p><p><code>mv nebula-metad.conf.default nebula-metad.conf</code></p><p><code>mv nebula-storaged.conf.default nebula-storaged.conf</code></p><p>ä¿®æ”¹å¯¹åº”æ–‡ä»¶å­˜å‚¨ä½ç½®ã€èŠ‚ç‚¹ipåœ°å€ï¼Œé›†ç¾¤åŒç†</p><a id="more"></a><p><strong>ç¤ºä¾‹ï¼š</strong></p><p><strong>Â·</strong> <code>nebula-graphd.conf</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">########## basics ##########</span><br><span class="line"># Whether to run as a daemon process</span><br><span class="line">--daemonize=true</span><br><span class="line"># The file to host the process id</span><br><span class="line">--pid_file=pids/nebula-graphd.pid</span><br><span class="line"># Whether to enable optimizer</span><br><span class="line">--enable_optimizer=true</span><br><span class="line"># The default charset when a space is created</span><br><span class="line">--default_charset=utf8</span><br><span class="line"># The default collate when a space is created</span><br><span class="line">--default_collate=utf8_bin</span><br><span class="line"># Whether to use the configuration obtained from the configuration file</span><br><span class="line">--local_config=true</span><br><span class="line"></span><br><span class="line">########## logging ##########</span><br><span class="line"># The directory to host logging files</span><br><span class="line">--log_dir=/home/nebula/graph/logs</span><br><span class="line"># Log level, 0, 1, 2, 3 for INFO, WARNING, ERROR, FATAL respectively</span><br><span class="line">--minloglevel=0</span><br><span class="line"># Verbose log level, 1, 2, 3, 4, the higher of the level, the more verbose of the logging</span><br><span class="line">--v=0</span><br><span class="line"># Maximum seconds to buffer the log messages</span><br><span class="line">--logbufsecs=0</span><br><span class="line"># Whether to redirect stdout and stderr to separate output files</span><br><span class="line">--redirect_stdout=true</span><br><span class="line"># Destination filename of stdout and stderr, which will also reside in log_dir.</span><br><span class="line">--stdout_log_file=graphd-stdout.log</span><br><span class="line">--stderr_log_file=graphd-stderr.log</span><br><span class="line"># Copy log messages at or above this level to stderr in addition to logfiles. The numbers of severity levels INFO, WARNING, ERROR, and FATAL are 0, 1, 2, and 3, respectively.</span><br><span class="line">--stderrthreshold=3</span><br><span class="line"># wether logging files&apos; name contain time stamp.</span><br><span class="line">--timestamp_in_logfile_name=true</span><br><span class="line">########## query ##########</span><br><span class="line"># Whether to treat partial success as an error.</span><br><span class="line"># This flag is only used for Read-only access, and Modify access always treats partial success as an error.</span><br><span class="line">--accept_partial_success=false</span><br><span class="line"># Maximum sentence length, unit byte</span><br><span class="line">--max_allowed_query_size=4194304</span><br><span class="line"></span><br><span class="line">########## networking ##########</span><br><span class="line"># Comma separated Meta Server Addresses</span><br><span class="line">--meta_server_addrs=192.168.9.103:9559</span><br><span class="line"># Local IP used to identify the nebula-graphd process.</span><br><span class="line"># Change it to an address other than loopback if the service is distributed or</span><br><span class="line"># will be accessed remotely.</span><br><span class="line">--local_ip=192.168.9.103</span><br><span class="line"># Network device to listen on</span><br><span class="line">--listen_netdev=any</span><br><span class="line"># Port to listen on</span><br><span class="line">--port=9669</span><br><span class="line"># To turn on SO_REUSEPORT or not</span><br><span class="line">--reuse_port=false</span><br><span class="line"># Backlog of the listen socket, adjust this together with net.core.somaxconn</span><br><span class="line">--listen_backlog=1024</span><br><span class="line"># The number of seconds Nebula service waits before closing the idle connections</span><br><span class="line">--client_idle_timeout_secs=28800</span><br><span class="line"># The number of seconds before idle sessions expire</span><br><span class="line"># The range should be in [1, 604800]</span><br><span class="line">--session_idle_timeout_secs=28800</span><br><span class="line"># The number of threads to accept incoming connections</span><br><span class="line">--num_accept_threads=1</span><br><span class="line"># The number of networking IO threads, 0 for # of CPU cores</span><br><span class="line">--num_netio_threads=0</span><br><span class="line"># Max active connections for all networking threads. 0 means no limit.</span><br><span class="line"># Max connections for each networking thread = num_max_connections / num_netio_threads</span><br><span class="line">--num_max_connections=0</span><br><span class="line"># The number of threads to execute user queries, 0 for # of CPU cores</span><br><span class="line">--num_worker_threads=0</span><br><span class="line"># HTTP service ip</span><br><span class="line">--ws_ip=0.0.0.0</span><br><span class="line"># HTTP service port</span><br><span class="line">--ws_http_port=19669</span><br><span class="line"># storage client timeout</span><br><span class="line">--storage_client_timeout_ms=60000</span><br><span class="line"># slow query threshold in us</span><br><span class="line">--slow_query_threshold_us=200000</span><br><span class="line"># Port to listen on Meta with HTTP protocol, it corresponds to ws_http_port in metad&apos;s configuration file</span><br><span class="line">--ws_meta_http_port=19559</span><br><span class="line"></span><br><span class="line">########## authentication ##########</span><br><span class="line"># Enable authorization</span><br><span class="line">--enable_authorize=false</span><br><span class="line"># User login authentication type, password for nebula authentication, ldap for ldap authentication, cloud for cloud authentication</span><br><span class="line">--auth_type=password</span><br><span class="line"></span><br><span class="line">########## memory ##########</span><br><span class="line"># System memory high watermark ratio, cancel the memory checking when the ratio greater than 1.0</span><br><span class="line">--system_memory_high_watermark_ratio=0.8</span><br><span class="line"></span><br><span class="line">########## metrics ##########</span><br><span class="line">--enable_space_level_metrics=false</span><br><span class="line"></span><br><span class="line">########## experimental feature ##########</span><br><span class="line"># if use experimental features</span><br><span class="line">--enable_experimental_feature=false</span><br><span class="line"></span><br><span class="line"># if use balance data feature, only work if enable_experimental_feature is true</span><br><span class="line">--enable_data_balance=true</span><br><span class="line"></span><br><span class="line"># enable udf, written in c++ only for now</span><br><span class="line">--enable_udf=true</span><br><span class="line"></span><br><span class="line"># set the directory where the .so files of udf are stored, when enable_udf is true</span><br><span class="line">--udf_path=/home/nebula/dev/nebula/udf/</span><br><span class="line"></span><br><span class="line">########## session ##########</span><br><span class="line"># Maximum number of sessions that can be created per IP and per user</span><br><span class="line">--max_sessions_per_ip_per_user=300</span><br><span class="line"></span><br><span class="line">########## memory tracker ##########</span><br><span class="line"># trackable memory ratio (trackable_memory / (total_memory - untracked_reserved_memory) )</span><br><span class="line">--memory_tracker_limit_ratio=0.8</span><br><span class="line"># untracked reserved memory in Mib</span><br><span class="line">--memory_tracker_untracked_reserved_memory_mb=50</span><br><span class="line"></span><br><span class="line"># enable log memory tracker stats periodically</span><br><span class="line">--memory_tracker_detail_log=false</span><br><span class="line"># log memory tacker stats interval in milliseconds</span><br><span class="line">--memory_tracker_detail_log_interval_ms=60000</span><br><span class="line"></span><br><span class="line"># enable memory background purge (if jemalloc is used)</span><br><span class="line">--memory_purge_enabled=true</span><br><span class="line"># memory background purge interval in seconds</span><br><span class="line">--memory_purge_interval_seconds=10</span><br><span class="line"></span><br><span class="line">########## performance optimization ##########</span><br><span class="line"># The max job size in multi job mode</span><br><span class="line">--max_job_size=1</span><br><span class="line"># The min batch size for handling dataset in multi job mode, only enabled when max_job_size is greater than 1</span><br><span class="line">--min_batch_size=8192</span><br><span class="line"># if true, return directly without go through RPC</span><br><span class="line">--optimize_appendvertices=false</span><br><span class="line"># number of paths constructed by each thread</span><br><span class="line">--path_batch_size=10000</span><br></pre></td></tr></table></figure><p><strong>Â·</strong> <code>nebula-metad.conf</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">########## basics ##########</span><br><span class="line"># Whether to run as a daemon process</span><br><span class="line">--daemonize=true</span><br><span class="line"># The file to host the process id</span><br><span class="line">--pid_file=pids/nebula-metad.pid</span><br><span class="line"></span><br><span class="line">########## logging ##########</span><br><span class="line"># The directory to host logging files</span><br><span class="line">--log_dir=/home/nebula/meta/logs</span><br><span class="line"># Log level, 0, 1, 2, 3 for INFO, WARNING, ERROR, FATAL respectively</span><br><span class="line">--minloglevel=0</span><br><span class="line"># Verbose log level, 1, 2, 3, 4, the higher of the level, the more verbose of the logging</span><br><span class="line">--v=0</span><br><span class="line"># Maximum seconds to buffer the log messages</span><br><span class="line">--logbufsecs=0</span><br><span class="line"># Whether to redirect stdout and stderr to separate output files</span><br><span class="line">--redirect_stdout=true</span><br><span class="line"># Destination filename of stdout and stderr, which will also reside in log_dir.</span><br><span class="line">--stdout_log_file=metad-stdout.log</span><br><span class="line">--stderr_log_file=metad-stderr.log</span><br><span class="line"># Copy log messages at or above this level to stderr in addition to logfiles. The numbers of severity levels INFO, WARNING, ERROR, and FATAL are 0, 1, 2, and 3, respectively.</span><br><span class="line">--stderrthreshold=3</span><br><span class="line"># wether logging files&apos; name contain time stamp, If Using logrotate to rotate logging files, than should set it to true.</span><br><span class="line">--timestamp_in_logfile_name=true</span><br><span class="line"></span><br><span class="line">########## networking ##########</span><br><span class="line"># Comma separated Meta Server addresses</span><br><span class="line">--meta_server_addrs=192.168.9.103:9559</span><br><span class="line"># Local IP used to identify the nebula-metad process.</span><br><span class="line"># Change it to an address other than loopback if the service is distributed or</span><br><span class="line"># will be accessed remotely.</span><br><span class="line">--local_ip=192.168.9.103</span><br><span class="line"># Meta daemon listening port</span><br><span class="line">--port=9559</span><br><span class="line"># HTTP service ip</span><br><span class="line">--ws_ip=0.0.0.0</span><br><span class="line"># HTTP service port</span><br><span class="line">--ws_http_port=19559</span><br><span class="line"># Port to listen on Storage with HTTP protocol, it corresponds to ws_http_port in storage&apos;s configuration file</span><br><span class="line">--ws_storage_http_port=19779</span><br><span class="line"></span><br><span class="line">########## storage ##########</span><br><span class="line"># Root data path, here should be only single path for metad</span><br><span class="line">--data_path=/home/nebula/data/meta</span><br><span class="line"></span><br><span class="line">########## Misc #########</span><br><span class="line"># The default number of parts when a space is created</span><br><span class="line">--default_parts_num=100</span><br><span class="line"># The default replica factor when a space is created</span><br><span class="line">--default_replica_factor=1</span><br><span class="line"></span><br><span class="line">--heartbeat_interval_secs=10</span><br><span class="line">--agent_heartbeat_interval_secs=60</span><br></pre></td></tr></table></figure><p><strong>Â·</strong> <code>nebula-metad.conf</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">########## basics ##########</span><br><span class="line"># Whether to run as a daemon process</span><br><span class="line">--daemonize=true</span><br><span class="line"># The file to host the process id</span><br><span class="line">--pid_file=pids/nebula-storaged.pid</span><br><span class="line"># Whether to use the configuration obtained from the configuration file</span><br><span class="line">--local_config=true</span><br><span class="line"></span><br><span class="line">########## logging ##########</span><br><span class="line"># The directory to host logging files</span><br><span class="line">--log_dir=/home/nebula/storage/logs</span><br><span class="line"># Log level, 0, 1, 2, 3 for INFO, WARNING, ERROR, FATAL respectively</span><br><span class="line">--minloglevel=0</span><br><span class="line"># Verbose log level, 1, 2, 3, 4, the higher of the level, the more verbose of the logging</span><br><span class="line">--v=0</span><br><span class="line"># Maximum seconds to buffer the log messages</span><br><span class="line">--logbufsecs=0</span><br><span class="line"># Whether to redirect stdout and stderr to separate output files</span><br><span class="line">--redirect_stdout=true</span><br><span class="line"># Destination filename of stdout and stderr, which will also reside in log_dir.</span><br><span class="line">--stdout_log_file=storaged-stdout.log</span><br><span class="line">--stderr_log_file=storaged-stderr.log</span><br><span class="line"># Copy log messages at or above this level to stderr in addition to logfiles. The numbers of severity levels INFO, WARNING, ERROR, and FATAL are 0, 1, 2, and 3, respectively.</span><br><span class="line">--stderrthreshold=3</span><br><span class="line"># Wether logging files&apos; name contain time stamp.</span><br><span class="line">--timestamp_in_logfile_name=true</span><br><span class="line"></span><br><span class="line">########## networking ##########</span><br><span class="line"># Comma separated Meta server addresses</span><br><span class="line">--meta_server_addrs=192.168.9.103:9559</span><br><span class="line"># Local IP used to identify the nebula-storaged process.</span><br><span class="line"># Change it to an address other than loopback if the service is distributed or</span><br><span class="line"># will be accessed remotely.</span><br><span class="line">--local_ip=192.168.9.103</span><br><span class="line"># Storage daemon listening port</span><br><span class="line">--port=9779</span><br><span class="line"># HTTP service ip</span><br><span class="line">--ws_ip=0.0.0.0</span><br><span class="line"># HTTP service port</span><br><span class="line">--ws_http_port=19779</span><br><span class="line"># heartbeat with meta service</span><br><span class="line">--heartbeat_interval_secs=10</span><br><span class="line"></span><br><span class="line">######### Raft #########</span><br><span class="line"># Raft election timeout</span><br><span class="line">--raft_heartbeat_interval_secs=30</span><br><span class="line"># RPC timeout for raft client (ms)</span><br><span class="line">--raft_rpc_timeout_ms=500</span><br><span class="line">## recycle Raft WAL</span><br><span class="line">--wal_ttl=14400</span><br><span class="line"></span><br><span class="line">########## Disk ##########</span><br><span class="line"># Root data path. Split by comma. e.g. --data_path=/disk1/path1/,/disk2/path2/</span><br><span class="line"># One path per Rocksdb instance.</span><br><span class="line">--data_path=/home/nebula/data/storage</span><br><span class="line"></span><br><span class="line"># Minimum reserved bytes of each data path</span><br><span class="line">--minimum_reserved_bytes=268435456</span><br><span class="line"></span><br><span class="line"># The default reserved bytes for one batch operation</span><br><span class="line">--rocksdb_batch_size=4096</span><br><span class="line"># The default block cache size used in BlockBasedTable.</span><br><span class="line"># The unit is MB.</span><br><span class="line">--rocksdb_block_cache=4</span><br><span class="line"># The type of storage engine, `rocksdb&apos;, `memory&apos;, etc.</span><br><span class="line">--engine_type=rocksdb</span><br><span class="line"></span><br><span class="line"># Compression algorithm, options: no,snappy,lz4,lz4hc,zlib,bzip2,zstd</span><br><span class="line"># For the sake of binary compatibility, the default value is snappy.</span><br><span class="line"># Recommend to use:</span><br><span class="line">#   * lz4 to gain more CPU performance, with the same compression ratio with snappy</span><br><span class="line">#   * zstd to occupy less disk space</span><br><span class="line">#   * lz4hc for the read-heavy write-light scenario</span><br><span class="line">--rocksdb_compression=lz4</span><br><span class="line"></span><br><span class="line"># Set different compressions for different levels</span><br><span class="line"># For example, if --rocksdb_compression is snappy,</span><br><span class="line"># &quot;no:no:lz4:lz4::zstd&quot; is identical to &quot;no:no:lz4:lz4:snappy:zstd:snappy&quot;</span><br><span class="line"># In order to disable compression for level 0/1, set it to &quot;no:no&quot;</span><br><span class="line">--rocksdb_compression_per_level=</span><br><span class="line"></span><br><span class="line"># Whether or not to enable rocksdb&apos;s statistics, disabled by default</span><br><span class="line">--enable_rocksdb_statistics=false</span><br><span class="line"></span><br><span class="line"># Statslevel used by rocksdb to collection statistics, optional values are</span><br><span class="line">#   * kExceptHistogramOrTimers, disable timer stats, and skip histogram stats</span><br><span class="line">#   * kExceptTimers, Skip timer stats</span><br><span class="line">#   * kExceptDetailedTimers, Collect all stats except time inside mutex lock AND time spent on compression.</span><br><span class="line">#   * kExceptTimeForMutex, Collect all stats except the counters requiring to get time inside the mutex lock.</span><br><span class="line">#   * kAll, Collect all stats</span><br><span class="line">--rocksdb_stats_level=kExceptHistogramOrTimers</span><br><span class="line"></span><br><span class="line"># Whether or not to enable rocksdb&apos;s prefix bloom filter, enabled by default.</span><br><span class="line">--enable_rocksdb_prefix_filtering=true</span><br><span class="line"># Whether or not to enable rocksdb&apos;s whole key bloom filter, disabled by default.</span><br><span class="line">--enable_rocksdb_whole_key_filtering=false</span><br><span class="line"></span><br><span class="line">############## rocksdb Options ##############</span><br><span class="line"># rocksdb DBOptions in json, each name and value of option is a string, given as &quot;option_name&quot;:&quot;option_value&quot; separated by comma</span><br><span class="line">--rocksdb_db_options=&#123;&#125;</span><br><span class="line"># rocksdb ColumnFamilyOptions in json, each name and value of option is string, given as &quot;option_name&quot;:&quot;option_value&quot; separated by comma</span><br><span class="line">--rocksdb_column_family_options=&#123;&quot;write_buffer_size&quot;:&quot;67108864&quot;,&quot;max_write_buffer_number&quot;:&quot;4&quot;,&quot;max_bytes_for_level_base&quot;:&quot;268435456&quot;&#125;</span><br><span class="line"># rocksdb BlockBasedTableOptions in json, each name and value of option is string, given as &quot;option_name&quot;:&quot;option_value&quot; separated by comma</span><br><span class="line">--rocksdb_block_based_table_options=&#123;&quot;block_size&quot;:&quot;8192&quot;&#125;</span><br><span class="line"></span><br><span class="line">############### misc ####################</span><br><span class="line"># Whether turn on query in multiple thread</span><br><span class="line">--query_concurrently=true</span><br><span class="line"># Whether remove outdated space data</span><br><span class="line">--auto_remove_invalid_space=true</span><br><span class="line"># Network IO threads number</span><br><span class="line">--num_io_threads=16</span><br><span class="line"># Max active connections for all networking threads. 0 means no limit.</span><br><span class="line"># Max connections for each networking thread = num_max_connections / num_netio_threads</span><br><span class="line">--num_max_connections=0</span><br><span class="line"># Worker threads number to handle request</span><br><span class="line">--num_worker_threads=32</span><br><span class="line"># Maximum subtasks to run admin jobs concurrently</span><br><span class="line">--max_concurrent_subtasks=10</span><br><span class="line"># The rate limit in bytes when leader synchronizes snapshot data</span><br><span class="line">--snapshot_part_rate_limit=10485760</span><br><span class="line"># The amount of data sent in each batch when leader synchronizes snapshot data</span><br><span class="line">--snapshot_batch_size=1048576</span><br><span class="line"># The rate limit in bytes when leader synchronizes rebuilding index</span><br><span class="line">--rebuild_index_part_rate_limit=4194304</span><br><span class="line"># The amount of data sent in each batch when leader synchronizes rebuilding index</span><br><span class="line">--rebuild_index_batch_size=1048576</span><br><span class="line"></span><br><span class="line">########## memory tracker ##########</span><br><span class="line"># trackable memory ratio (trackable_memory / (total_memory - untracked_reserved_memory) )</span><br><span class="line">--memory_tracker_limit_ratio=0.8</span><br><span class="line"># untracked reserved memory in Mib</span><br><span class="line">--memory_tracker_untracked_reserved_memory_mb=50</span><br><span class="line"></span><br><span class="line"># enable log memory tracker stats periodically</span><br><span class="line">--memory_tracker_detail_log=false</span><br><span class="line"># log memory tacker stats interval in milliseconds</span><br><span class="line">--memory_tracker_detail_log_interval_ms=60000</span><br><span class="line"></span><br><span class="line"># enable memory background purge (if jemalloc is used)</span><br><span class="line">--memory_purge_enabled=true</span><br><span class="line"># memory background purge interval in seconds</span><br><span class="line">--memory_purge_interval_seconds=10</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><p>å›åˆ°nebulaæ ¹ç›®å½•</p><p><code>cd ..</code></p><p>æ‰§è¡Œå¯åŠ¨è„šæœ¬</p><p><code>./scripts/nebula.service start all</code></p><p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€</p><p><code>./scripts/nebula.service status all</code></p><p>é‡å¯æœåŠ¡</p><p><code>./scripts/nebula.service restart all</code></p><p>å…³é—­æœåŠ¡</p><p><code>./scripts/nebula.service stop all</code></p><h2 id="nebula-graph-studioéƒ¨ç½²"><a href="#nebula-graph-studioéƒ¨ç½²" class="headerlink" title="nebula-graph-studioéƒ¨ç½²"></a>nebula-graph-studioéƒ¨ç½²</h2><p>v3.2.3ä¸‹è½½åœ°å€ï¼ˆå…è´¹ä½¿ç”¨å›¾æ¢ç´¢çš„æœ€é«˜ç¤¾åŒºç‰ˆæœ¬ï¼‰</p><p><a href="https://github.com/vesoft-inc/nebula-studio/releases/tag/v3.2.3" target="_blank" rel="noopener">https://github.com/vesoft-inc/nebula-studio/releases/tag/v3.2.3</a></p><p>æºç å®‰è£…åï¼Œè¿›å…¥å¯¹åº”ç›®å½•ï¼Œæ‰§è¡Œå¯åŠ¨è„šæœ¬</p><p><code>./service</code></p><p><img src="/2023/09/27/Nebula3å•æœºç‰ˆå¿«é€Ÿå®‰è£…/A.png" alt></p><p><img src="/2023/09/27/Nebula3å•æœºç‰ˆå¿«é€Ÿå®‰è£…/B.png" alt></p>]]></content>
    
    
    <summary type="html">&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt; ç³»ç»Ÿï¼šCentOS7&lt;/font&gt;

&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt; nebulaç‰ˆæœ¬ï¼š3.6.0ï¼ˆå¼€æºç¤¾åŒºç‰ˆï¼‰&lt;/font&gt;

&lt;font color=&quot;gold&quot;&gt;&lt;strong&gt;Â·&lt;/strong&gt; nebula-graph-studioç‰ˆæœ¬ï¼š3.2.3&lt;/font&gt;

&lt;h2 id=&quot;å•æœºéƒ¨ç½²&quot;&gt;&lt;a href=&quot;#å•æœºéƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;å•æœºéƒ¨ç½²&quot;&gt;&lt;/a&gt;å•æœºéƒ¨ç½²&lt;/h2&gt;&lt;h3 id=&quot;taråŒ…æºç ä¸‹è½½&quot;&gt;&lt;a href=&quot;#taråŒ…æºç ä¸‹è½½&quot; class=&quot;headerlink&quot; title=&quot;taråŒ…æºç ä¸‹è½½&quot;&gt;&lt;/a&gt;taråŒ…æºç ä¸‹è½½&lt;/h3&gt;&lt;p&gt;&lt;code&gt;wget https://oss-cdn.nebula-graph.com.cn/package/3.6.0/nebula-graph-3.6.0.el7.x86_64.tar.gz&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;è§£å‹å¹¶é‡å‘½å&quot;&gt;&lt;a href=&quot;#è§£å‹å¹¶é‡å‘½å&quot; class=&quot;headerlink&quot; title=&quot;è§£å‹å¹¶é‡å‘½å&quot;&gt;&lt;/a&gt;è§£å‹å¹¶é‡å‘½å&lt;/h3&gt;&lt;p&gt;&lt;code&gt;tar -xvzf nebula-graph-3.6.0.el7.x86_64.tar.gz&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mv nebula-graph-3.6.0.el7.x86_64 nebula&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;ä¿®æ”¹é…ç½®æ–‡ä»¶&quot;&gt;&lt;a href=&quot;#ä¿®æ”¹é…ç½®æ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;ä¿®æ”¹é…ç½®æ–‡ä»¶&quot;&gt;&lt;/a&gt;ä¿®æ”¹é…ç½®æ–‡ä»¶&lt;/h3&gt;&lt;p&gt;&lt;code&gt;cd nebula/etc&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mv nebula-graphd.conf.default nebula-graphd.conf&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mv nebula-metad.conf.default nebula-metad.conf&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mv nebula-storaged.conf.default nebula-storaged.conf&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;ä¿®æ”¹å¯¹åº”æ–‡ä»¶å­˜å‚¨ä½ç½®ã€èŠ‚ç‚¹ipåœ°å€ï¼Œé›†ç¾¤åŒç†&lt;/p&gt;</summary>
    
    
    
    <category term="BigData" scheme="http://yoursite.com/categories/BigData/"/>
    
    
    <category term="database" scheme="http://yoursite.com/tags/database/"/>
    
    <category term="nebula" scheme="http://yoursite.com/tags/nebula/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢</title>
    <link href="http://yoursite.com/2023/09/07/%E5%9F%BA%E4%BA%8EVGG16%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%83%8F%E8%89%BA%E6%9C%AF%E9%A3%8E%E6%A0%BC%E8%BD%AC%E6%8D%A2/"/>
    <id>http://yoursite.com/2023/09/07/%E5%9F%BA%E4%BA%8EVGG16%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%83%8F%E8%89%BA%E6%9C%AF%E9%A3%8E%E6%A0%BC%E8%BD%AC%E6%8D%A2/</id>
    <published>2023-09-07T07:04:43.000Z</published>
    <updated>2024-04-18T10:07:42.612Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p>é€šè¿‡vgg16æˆ–å…¶ä»–ç¥ç»ç½‘ç»œæå–å›¾åƒç‰¹å¾ï¼Œå¹¶ä½¿ç”¨æ ¼æ‹‰å§†çŸ©é˜µï¼ˆGram matrixï¼‰è¿›è¡Œå›¾åƒé£æ ¼çš„è¿ç§»ã€‚</p><h3 id="VGG16"><a href="#VGG16" class="headerlink" title="VGG16"></a>VGG16</h3><p>ä¸å¿…å¤šè¯´ï¼Œ2014å¹´ImageNetå›¾åƒåˆ†ç±»ç«èµ›äºšå†›ï¼Œå®šä½ç«èµ›å† å†›ï¼›VGGç½‘ç»œé‡‡ç”¨è¿ç»­çš„å°å·ç§¯æ ¸ï¼ˆ3x3ï¼‰å’Œæ± åŒ–å±‚æ„å»ºæ·±åº¦ç¥ç»ç½‘ç»œï¼Œç½‘ç»œæ·±åº¦å¯ä»¥è¾¾åˆ°16å±‚æˆ–19å±‚ï¼Œå…¶ä¸­VGG16å’ŒVGG19æœ€ä¸ºè‘—åã€‚VGG16å’ŒVGG19ç½‘ç»œæ¶æ„éå¸¸ç›¸ä¼¼ï¼Œéƒ½ç”±å¤šä¸ªå·ç§¯å±‚å’Œæ± åŒ–å±‚äº¤æ›¿å †å è€Œæˆï¼Œæœ€åä½¿ç”¨å…¨è¿æ¥å±‚è¿›è¡Œåˆ†ç±»ã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºç½‘ç»œçš„æ·±åº¦å’Œå‚æ•°é‡ï¼ŒVGG19ç›¸å¯¹äºVGG16å¢åŠ äº†3ä¸ªå·ç§¯å±‚å’Œä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œå‚æ•°é‡ä¹Ÿæ›´å¤šã€‚</p><p>å¯åœ¨kerasç›´æ¥ä½¿ç”¨vgg16/19æºç ï¼Œè‡ªåŠ¨ä¸‹è½½ç›¸å…³é¢„è®­ç»ƒæ¨¡å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> keras.applications.vgg16 <span class="keyword">import</span> VGG16</span><br><span class="line"><span class="keyword">from</span> keras.applications.vgg19 <span class="keyword">import</span> VGG19</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»“åˆtransformï¼Œåœ¨torchä¸­æ„å»ºç¥ç»ç½‘ç»œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># VGG16ç¥ç»ç½‘ç»œå®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VGG16</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="string">"""Vgg16 Net"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, requires_grad=False)</span>:</span></span><br><span class="line">        super(VGG16, self).__init__()</span><br><span class="line">        vgg_pretrained_features = models.vgg16(pretrained=<span class="literal">True</span>).features</span><br><span class="line">        self.slice1 = torch.nn.Sequential()</span><br><span class="line">        self.slice2 = torch.nn.Sequential()</span><br><span class="line">        self.slice3 = torch.nn.Sequential()</span><br><span class="line">        self.slice4 = torch.nn.Sequential()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            self.slice1.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>, <span class="number">9</span>):</span><br><span class="line">            self.slice2.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">9</span>, <span class="number">16</span>):</span><br><span class="line">            self.slice3.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">16</span>, <span class="number">23</span>):</span><br><span class="line">            self.slice4.add_module(str(x), vgg_pretrained_features[x])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> requires_grad:</span><br><span class="line">            <span class="keyword">for</span> param <span class="keyword">in</span> self.parameters():</span><br><span class="line">                param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, X)</span>:</span></span><br><span class="line">        h = self.slice1(X)</span><br><span class="line">        h_relu1_2 = h</span><br><span class="line">        h = self.slice2(h)</span><br><span class="line">        h_relu2_2 = h</span><br><span class="line">        h = self.slice3(h)</span><br><span class="line">        h_relu3_3 = h</span><br><span class="line">        h = self.slice4(h)</span><br><span class="line">        h_relu4_3 = h</span><br><span class="line"></span><br><span class="line">        vgg_outputs = namedtuple(<span class="string">"VggOutputs"</span>, [<span class="string">"relu1_2"</span>, <span class="string">"relu2_2"</span>, <span class="string">"relu3_3"</span>, <span class="string">"relu4_3"</span>])</span><br><span class="line">        output = vgg_outputs(h_relu1_2, h_relu2_2, h_relu3_3, h_relu4_3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransformerNet</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(TransformerNet, self).__init__()</span><br><span class="line">        self.model = nn.Sequential(</span><br><span class="line">            ConvBlock(<span class="number">3</span>, <span class="number">32</span>, kernel_size=<span class="number">9</span>, stride=<span class="number">1</span>),</span><br><span class="line">            ConvBlock(<span class="number">32</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">            ConvBlock(<span class="number">64</span>, <span class="number">128</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ResidualBlock(<span class="number">128</span>),</span><br><span class="line">            ConvBlock(<span class="number">128</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, upsample=<span class="literal">True</span>),</span><br><span class="line">            ConvBlock(<span class="number">64</span>, <span class="number">32</span>, kernel_size=<span class="number">3</span>, upsample=<span class="literal">True</span>),</span><br><span class="line">            ConvBlock(<span class="number">32</span>, <span class="number">3</span>, kernel_size=<span class="number">9</span>, stride=<span class="number">1</span>, normalize=<span class="literal">False</span>, relu=<span class="literal">False</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.model(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResidualBlock</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, channels)</span>:</span></span><br><span class="line">        super(ResidualBlock, self).__init__()</span><br><span class="line">        self.block = nn.Sequential(</span><br><span class="line">            ConvBlock(channels, channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, normalize=<span class="literal">True</span>, relu=<span class="literal">True</span>),</span><br><span class="line">            ConvBlock(channels, channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, normalize=<span class="literal">True</span>, relu=<span class="literal">False</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.block(x) + x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvBlock</span><span class="params">(torch.nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, out_channels, kernel_size, stride=<span class="number">1</span>, upsample=False, normalize=True, relu=True)</span>:</span></span><br><span class="line">        super(ConvBlock, self).__init__()</span><br><span class="line">        self.upsample = upsample</span><br><span class="line">        self.block = nn.Sequential(</span><br><span class="line">            nn.ReflectionPad2d(kernel_size // <span class="number">2</span>),</span><br><span class="line">            nn.Conv2d(in_channels, out_channels, kernel_size, (stride,))</span><br><span class="line">        )</span><br><span class="line">        self.norm = nn.InstanceNorm2d(out_channels, affine=<span class="literal">True</span>) <span class="keyword">if</span> normalize <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        self.relu = relu</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.upsample:</span><br><span class="line">            x = F.interpolate(x, scale_factor=<span class="number">2</span>)</span><br><span class="line">        x = self.block(x)</span><br><span class="line">        <span class="keyword">if</span> self.norm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            x = self.norm(x)</span><br><span class="line">        <span class="keyword">if</span> self.relu:</span><br><span class="line">            x = F.relu(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">æµ‹è¯•æ¨¡å‹</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    input1 = torch.rand([<span class="number">224</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>])</span><br><span class="line">    model_x = VGG16()</span><br><span class="line">    print(model_x)</span><br></pre></td></tr></table></figure><h3 id="æ ¼æ‹‰å§†çŸ©é˜µ"><a href="#æ ¼æ‹‰å§†çŸ©é˜µ" class="headerlink" title="æ ¼æ‹‰å§†çŸ©é˜µ"></a>æ ¼æ‹‰å§†çŸ©é˜µ</h3><p>æ ¼æ‹‰å§†çŸ©é˜µï¼ˆGram matrixï¼‰å³nç»´æ¬§å¼ç©ºé—´ä¸­ä»»æ„kä¸ªå‘é‡ä¹‹é—´ä¸¤ä¸¤çš„å†…ç§¯æ‰€ç»„æˆçš„çŸ©é˜µï¼Œæ˜¯ä¸€ä¸ªå¯¹ç§°çŸ©é˜µã€‚</p><p><img src="/2023/09/07/åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢/A.png" alt></p><p>æ›´ç›´è§‚çš„ç†è§£ï¼š</p><p><img src="/2023/09/07/åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢/B.png" alt></p><p>è¾“å…¥å›¾åƒçš„feature mapä¸º[ ch, h, w]ã€‚æˆ‘ä»¬ç»è¿‡flattenï¼ˆå³æ˜¯å°†h<em>wè¿›è¡Œå¹³é“ºæˆä¸€ç»´å‘é‡ï¼‰å’ŒçŸ©é˜µè½¬ç½®æ“ä½œï¼Œå¯ä»¥å˜å½¢ä¸º[ ch, h</em>w]å’Œ[ h*w, ch]çš„çŸ©é˜µã€‚å†å¯¹ä¸¤ä¸ªä½œå†…ç§¯å¾—åˆ°æ ¼æ‹‰å§†çŸ©é˜µã€‚</p><p>ä½¿ç”¨æ ¼æ‹‰å§†çŸ©é˜µè¿›è¡Œé£æ ¼è¿ç§»ï¼š</p><p>1.å‡†å¤‡ç›®æ ‡å›¾åƒå’Œç›®æ ‡é£æ ¼å›¾åƒï¼›</p><p>2.ä½¿ç”¨æ·±å±‚ç½‘ç»œåŠ ç™½å™ªå£°æå–ç›®æ ‡å›¾åƒå’Œé£æ ¼ç›®æ ‡çš„ç‰¹å¾å‘é‡ã€‚å¯¹ä¸¤ä¸ªå›¾åƒçš„ç‰¹å¾å‘é‡è®¡ç®—æ ¼æ‹‰å§†çŸ©é˜µï¼Œä»¥çŸ©é˜µå·®å¼‚æœ€å°åŒ–ä¸ºä¼˜åŒ–ç›®æ ‡ï¼Œä¸æ–­è°ƒæ•´ç›®æ ‡å›¾åƒï¼Œä½¿é£æ ¼ä¸æ–­ç›¸ä¼¼ã€‚</p><p>torchä¸­æ ¼æ‹‰å§†çŸ©é˜µä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gram_matrix</span><span class="params">(y)</span>:</span></span><br><span class="line">    (b, c, h, w) = y.size()</span><br><span class="line">    features = y.view(b, c, w * h)</span><br><span class="line">    features_t = features.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    gram = features.bmm(features_t) / (c * h * w)</span><br><span class="line">    <span class="keyword">return</span> gram</span><br></pre></td></tr></table></figure><h2 id="å¼€å§‹è®­ç»ƒ"><a href="#å¼€å§‹è®­ç»ƒ" class="headerlink" title="å¼€å§‹è®­ç»ƒ"></a>å¼€å§‹è®­ç»ƒ</h2><p>å‡†å¤‡è®­ç»ƒæ–‡ä»¶å’Œé£æ ¼å›¾ç‰‡ï¼Œä¾‹å¦‚éšæœºå›¾åƒ*20å’Œæ¢µé«˜åä½œæ˜Ÿæœˆå¤œ</p><p><img src="/2023/09/07/åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢/C.png" alt></p><p><img src="/2023/09/07/åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢/D.png" alt></p><h3 id="utils-pyå·¥å…·"><a href="#utils-pyå·¥å…·" class="headerlink" title="utils.pyå·¥å…·"></a>utils.pyå·¥å…·</h3><p>é…ç½®è®­ç»ƒå‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">parser = argparse.ArgumentParser(description=<span class="string">"Parser 4 Training"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--style"</span>, type=str, default=<span class="string">"images/styles/the_starry_night.jpg"</span>, help=<span class="string">"Path 2 style image"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--dataset"</span>, type=str, help=<span class="string">"path 2 training dataset"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--epochs"</span>, type=int, default=<span class="number">1</span>, help=<span class="string">"Number of training epochs"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--batch_size"</span>, type=int, default=<span class="number">4</span>, help=<span class="string">"Batch size 4 training"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--image_size"</span>, type=int, default=<span class="number">256</span>, help=<span class="string">"Size of training images"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--style_size"</span>, type=int, help=<span class="string">"Size of style image"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--lr"</span>, type=float, default=<span class="number">1e-3</span>, help=<span class="string">"Learning rate"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--lambda_img"</span>, type=float, default=<span class="number">1e5</span>, help=<span class="string">"Weight 4 image loss"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--lambda_style"</span>, type=float, default=<span class="number">1e10</span>, help=<span class="string">"Weight 4 style loss"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--model_path"</span>, type=str, help=<span class="string">"Optional path 2 checkpoint model"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--model_checkpoint"</span>, type=int, default=<span class="number">1000</span>, help=<span class="string">"Batches 4 saving model"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--result_checkpoint"</span>, type=int, default=<span class="number">1000</span>, help=<span class="string">"Batches 4 saving image result"</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¥ç»ç½‘ç»œè¿›è¡Œé£æ ¼è®­ç»ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_transform</span><span class="params">(image_size)</span>:</span></span><br><span class="line">    transform = transforms.Compose(</span><br><span class="line">        [</span><br><span class="line">            transforms.Resize(int(image_size * <span class="number">1.15</span>)),</span><br><span class="line">            transforms.RandomCrop(image_size),</span><br><span class="line">            transforms.ToTensor(),</span><br><span class="line">            transforms.Normalize(mean, std),</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> transform</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¥ç»ç½‘ç»œè¿›è¡Œé£æ ¼è½¬æ¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">style_transform</span><span class="params">(image_size=None)</span>:</span></span><br><span class="line">    resize = [transforms.Resize(image_size)] <span class="keyword">if</span> image_size <span class="keyword">else</span> []</span><br><span class="line">    transform = transforms.Compose(resize + [transforms.ToTensor(), transforms.Normalize(mean, std)])</span><br><span class="line">    <span class="keyword">return</span> transform</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‡å€¼å’Œæ ‡å‡†å¯¹å›¾åƒå¼ é‡è¿›è¡Œåè§„èŒƒåŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">denormalize</span><span class="params">(tensors)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        tensors[:, c].mul_(std[c]).add_(mean[c])</span><br><span class="line">    <span class="keyword">return</span> tensors</span><br></pre></td></tr></table></figure><h3 id="train-pyè®­ç»ƒè„šæœ¬"><a href="#train-pyè®­ç»ƒè„šæœ¬" class="headerlink" title="train.pyè®­ç»ƒè„šæœ¬"></a>train.pyè®­ç»ƒè„šæœ¬</h3><p>è®­ç»ƒé…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">train_args = TrainArgs()</span><br><span class="line">args = train_args.initialize().parse_args()</span><br><span class="line"></span><br><span class="line">args.dataset = <span class="string">'./dataset'</span></span><br><span class="line">args.style = <span class="string">'./images/styles/the_starry_night.jpg'</span></span><br><span class="line">args.epochs = <span class="number">2400</span> <span class="comment"># epochs*(æ•°æ®é›†/batch_size)æ˜¯1000çš„å…¬å€æ•°</span></span><br><span class="line">args.batch_size = <span class="number">4</span></span><br><span class="line">args.image_size = <span class="number">256</span></span><br></pre></td></tr></table></figure><p>è®­ç»ƒæµç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">style_name = args.style.split(<span class="string">"/"</span>)[<span class="number">-1</span>].split(<span class="string">"."</span>)[<span class="number">0</span>]</span><br><span class="line">os.makedirs(<span class="string">f"images/train/<span class="subst">&#123;style_name&#125;</span>_training"</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(<span class="string">f"checkpoints"</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">train_dataset = datasets.ImageFolder(args.dataset, train_transform(args.image_size))</span><br><span class="line">dataloader = DataLoader(train_dataset, batch_size=args.batch_size)</span><br><span class="line">transformer = TransformerNet().to(device)</span><br><span class="line">vgg = VGG16(requires_grad=<span class="literal">False</span>).to(device)</span><br><span class="line"><span class="keyword">if</span> args.model_path:</span><br><span class="line">    transformer.load_state_dict(torch.load(args.model_path))</span><br><span class="line">optimizer = Adam(transformer.parameters(), args.lr)</span><br><span class="line">l2_loss = torch.nn.MSELoss().to(device)</span><br><span class="line">style = style_transform(args.style_size)(Image.open(args.style))</span><br><span class="line">style = style.repeat(args.batch_size, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>).to(device)</span><br><span class="line">features_style = vgg(style)</span><br><span class="line">gram_style = [gram_matrix(y) <span class="keyword">for</span> y <span class="keyword">in</span> features_style]</span><br><span class="line">image_samples = []</span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> random.sample(glob.glob(<span class="string">f"<span class="subst">&#123;args.dataset&#125;</span>/*/*"</span>), len(train_dataset)):</span><br><span class="line">    image_samples += [style_transform(args.image_size)(Image.open(path).resize((<span class="number">224</span>, <span class="number">224</span>)))]</span><br><span class="line">image_samples = torch.stack(image_samples)</span><br></pre></td></tr></table></figure><p>å¯åŠ¨è®­ç»ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_result</span><span class="params">(sample)</span>:</span></span><br><span class="line">    transformer.eval()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        output = transformer(image_samples.to(device))</span><br><span class="line">    image_rgb = denormalize(torch.cat((image_samples.cpu(), output.cpu()), <span class="number">2</span>))</span><br><span class="line">    save_image(image_rgb, <span class="string">f"images/train/<span class="subst">&#123;style_name&#125;</span>_training/<span class="subst">&#123;sample&#125;</span>.jpg"</span>, nrow=<span class="number">4</span>)</span><br><span class="line">    transformer.train()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_model</span><span class="params">(sample)</span>:</span></span><br><span class="line">    torch.save(transformer.state_dict(), <span class="string">f"checkpoints/<span class="subst">&#123;style_name&#125;</span>_<span class="subst">&#123;sample&#125;</span>.pth"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> range(args.epochs):</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> range(len(dataloader)):</span><br><span class="line">        batch_i = line</span><br><span class="line">        batches_done = epoch * len(dataloader) + batch_i + <span class="number">1</span></span><br><span class="line">        images = list(dataloader)[line][<span class="number">0</span>]</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">        images_original = images.to(device)</span><br><span class="line">        images_transformed = transformer(images_original)</span><br><span class="line"></span><br><span class="line">        features_original = vgg(images_original)</span><br><span class="line">        features_transformed = vgg(images_transformed)</span><br><span class="line"></span><br><span class="line">        img_loss = args.lambda_img * l2_loss(features_transformed.relu2_2, features_original.relu2_2)</span><br><span class="line"></span><br><span class="line">        style_loss = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> ft_y, gm_s <span class="keyword">in</span> zip(features_transformed, gram_style):</span><br><span class="line">            gm_y = gram_matrix(ft_y)</span><br><span class="line">            style_loss += l2_loss(gm_y, gm_s[: images.size(<span class="number">0</span>), :, :])</span><br><span class="line">        style_loss *= args.lambda_style</span><br><span class="line"></span><br><span class="line">        total_loss = img_loss + style_loss</span><br><span class="line">        total_loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        <span class="keyword">if</span> batches_done % args.result_checkpoint == <span class="number">0</span>:</span><br><span class="line">            save_result(batches_done)</span><br><span class="line">        <span class="keyword">if</span> args.model_checkpoint &gt; <span class="number">0</span> <span class="keyword">and</span> batches_done % args.model_checkpoint == <span class="number">0</span>:</span><br><span class="line">            save_model(batches_done)</span><br></pre></td></tr></table></figure><p>ç¬¬1000æ¬¡è¿­ä»£</p><p><img src="/2023/09/07/åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢/1000.jpg" alt></p><p>ç¬¬12000æ¬¡è¿­ä»£ï¼ˆ2400epoch * (20/batch_size)ï¼‰ï¼Œæ•ˆæœæ˜æ˜¾</p><p><img src="/2023/09/07/åŸºäºVGG16ç¥ç»ç½‘ç»œå®ç°å›¾åƒè‰ºæœ¯é£æ ¼è½¬æ¢/12000.jpg" alt></p><p>åˆ°è¿™ä¸€æ­¥ï¼Œè®­ç»ƒç»“æŸï¼Œå¯ä»¥é¢„æµ‹ç»“æœ</p><h2 id="é¢„æµ‹ï¼š"><a href="#é¢„æµ‹ï¼š" class="headerlink" title="é¢„æµ‹ï¼š"></a>é¢„æµ‹ï¼š</h2><p>é…ç½®é¢„æµ‹å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">predict_args = PredictArgs()</span><br><span class="line">args = predict_args.initialize().parse_args()</span><br><span class="line">args.image_path = <span class="string">'./images/input/001.jpg'</span></span><br><span class="line">args.model_path = <span class="string">'./checkpoints/the_starry_night_12000.pth'</span></span><br></pre></td></tr></table></figure><p>é¢„æµ‹ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">os.makedirs(<span class="string">"images/output"</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">   device = torch.device(<span class="string">'cpu'</span>)<span class="comment">#("cuda" if torch.cuda.is_available() else "cpu")</span></span><br><span class="line">   transform = style_transform()</span><br><span class="line">   transformer = TransformerNet().to(device)</span><br><span class="line">   transformer.load_state_dict(torch.load(mod_path))</span><br><span class="line">   transformer.eval()</span><br><span class="line">   image_tensor = Variable(transform(Image.open(img_path))).to(device)</span><br><span class="line">   image_tensor = image_tensor.unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">       output_image = denormalize(transformer(image_tensor)).cpu()</span><br><span class="line">       </span><br><span class="line">   name = img_path.split(<span class="string">"/"</span>)[<span class="number">-1</span>]</span><br><span class="line">   save_image(output_image, <span class="string">f"images/output/output_<span class="subst">&#123;name&#125;</span>"</span>)</span><br></pre></td></tr></table></figure><h2 id="æ€è·¯Â·å‚è€ƒ"><a href="#æ€è·¯Â·å‚è€ƒ" class="headerlink" title="æ€è·¯Â·å‚è€ƒ"></a>æ€è·¯Â·å‚è€ƒ</h2><p><a href="https://github.com/elleryqueenhomels/fast_neural_style_transfer/tree/master" target="_blank" rel="noopener">https://github.com/elleryqueenhomels/fast_neural_style_transfer/tree/master</a></p><p><a href="https://github.com/AaronJny/DeepLearningExamples/tree/master/tf2-neural-style-transfer" target="_blank" rel="noopener">https://github.com/AaronJny/DeepLearningExamples/tree/master/tf2-neural-style-transfer</a></p><p><a href="https://github.com/Huage001/PaintTransformer" target="_blank" rel="noopener">https://github.com/Huage001/PaintTransformer</a></p><p><a href="https://github.com/eriklindernoren/Fast-Neural-Style-Transfer/tree/master" target="_blank" rel="noopener">https://github.com/eriklindernoren/Fast-Neural-Style-Transfer/tree/master</a></p><p><a href="https://github.com/NeverGiveU/PaintTransformer-Pytorch-master" target="_blank" rel="noopener">https://github.com/NeverGiveU/PaintTransformer-Pytorch-master</a></p><p><a href="https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix" target="_blank" rel="noopener">https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h2 id=&quot;åŸºæœ¬åŸç†&quot;&gt;&lt;a href=&quot;#åŸºæœ¬åŸç†&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬åŸç†&quot;&gt;&lt;/a&gt;åŸºæœ¬åŸç†&lt;/h2&gt;&lt;p&gt;é€šè¿‡vgg16æˆ–å…¶ä»–ç¥ç»</summary>
      
    
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://yoursite.com/categories/æ·±åº¦å­¦ä¹ /"/>
    
    
    <category term="VGG" scheme="http://yoursite.com/tags/VGG/"/>
    
    <category term="å·ç§¯ç¥ç»ç½‘ç»œ" scheme="http://yoursite.com/tags/å·ç§¯ç¥ç»ç½‘ç»œ/"/>
    
  </entry>
  
  <entry>
    <title>paddleDetection Demo</title>
    <link href="http://yoursite.com/2023/08/31/paddleDetection%20Demo/"/>
    <id>http://yoursite.com/2023/08/31/paddleDetection%20Demo/</id>
    <published>2023-08-31T04:20:20.000Z</published>
    <updated>2024-01-25T09:14:54.938Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="PPHuman"><a href="#PPHuman" class="headerlink" title="PPHuman"></a>PPHuman</h2><h3 id="è¡Œäººå±æ€§è¯†åˆ«"><a href="#è¡Œäººå±æ€§è¯†åˆ«" class="headerlink" title="è¡Œäººå±æ€§è¯†åˆ«"></a>è¡Œäººå±æ€§è¯†åˆ«</h3><h4 id="è¡Œäººå±æ€§"><a href="#è¡Œäººå±æ€§" class="headerlink" title="è¡Œäººå±æ€§"></a>è¡Œäººå±æ€§</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">attr_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DET:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_l_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_l_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">skip_frame_num:</span> <span class="number">-1</span> <span class="comment"># preferably no more than 3</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">KPT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/dark_hrnet_w32_256x192.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ATTR:</span></span><br><span class="line">  <span class="attr">model_dir:</span>  <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/PPLCNet_x1_0_person_attribute_945_infer.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_human.yml --device=gpu --video_file=demo_input/human.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/è¡Œäººå±æ€§.gif" alt></p><a id="more"></a><h3 id="è¡Œäººè¡Œä¸ºè¯†åˆ«"><a href="#è¡Œäººè¡Œä¸ºè¯†åˆ«" class="headerlink" title="è¡Œäººè¡Œä¸ºè¯†åˆ«"></a>è¡Œäººè¡Œä¸ºè¯†åˆ«</h3><h4 id="è·Œå€’"><a href="#è·Œå€’" class="headerlink" title="è·Œå€’"></a>è·Œå€’</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">KPT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/dark_hrnet_w32_256x192.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SKELETON_ACTION:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/STGCN.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">max_frames:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">display_frames:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">coord_size:</span> <span class="string">[384,</span> <span class="number">512</span><span class="string">]</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_fall.yml --device=gpu --video_file=demo_input/fall.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/è·Œå€’.gif" alt></p><h4 id="æ¥æ‰“ç”µè¯"><a href="#æ¥æ‰“ç”µè¯" class="headerlink" title="æ¥æ‰“ç”µè¯"></a>æ¥æ‰“ç”µè¯</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ID_BASED_CLSACTION:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/PPHGNet_tiny_calling_halfbody.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">threshold:</span> <span class="number">0.8</span></span><br><span class="line">  <span class="attr">display_frames:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">skip_frame_num:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">KPT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/dark_hrnet_w32_256x192.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_call.yml --device=gpu --video_file=demo_input/call.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/æ¥æ‰“ç”µè¯.gif" alt></p><h4 id="å¸çƒŸ"><a href="#å¸çƒŸ" class="headerlink" title="å¸çƒŸ"></a>å¸çƒŸ</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ID_BASED_DETACTION:</span></span><br><span class="line">  <span class="attr">model_dir:</span>  <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/ppyoloe_crn_s_80e_smoking_visdrone.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">threshold:</span> <span class="number">0.6</span></span><br><span class="line">  <span class="attr">display_frames:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">skip_frame_num:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">KPT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/dark_hrnet_w32_256x192.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_smoke.yml --device=gpu --video_file=demo_input/smoke.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/å¸çƒŸ.gif" style="zoom:150%;"></p><h4 id="æ‰“æ¶"><a href="#æ‰“æ¶" class="headerlink" title="æ‰“æ¶"></a>æ‰“æ¶</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">KPT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/dark_hrnet_w32_256x192.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">VIDEO_ACTION:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://videotag.bj.bcebos.com/PaddleVideo-release2.3/ppTSM_fight.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">frame_len:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">sample_freq:</span> <span class="number">7</span></span><br><span class="line">  <span class="attr">short_size:</span> <span class="number">340</span></span><br><span class="line">  <span class="attr">target_size:</span> <span class="number">320</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_fight.yml --device=gpu --video_file=demo_input/fight.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/æ‰“æ¶.gif" alt></p><h4 id="è¡Œäººè¿›å…¥"><a href="#è¡Œäººè¿›å…¥" class="headerlink" title="è¡Œäººè¿›å…¥"></a>è¡Œäººè¿›å…¥</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_l_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/backend/pp_config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">skip_frame_num:</span> <span class="number">-1</span> <span class="comment"># preferably no more than 3</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_entrance.yml --region_type=bottom --do_entrance_counting --device=gpu --video_file=demo_input/entrance.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/è¡Œäººè¿›å…¥.gif" alt></p><h4 id="ç¦åŒº"><a href="#ç¦åŒº" class="headerlink" title="ç¦åŒº"></a>ç¦åŒº</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_l_36e_pipeline.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/backend/pp_config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">skip_frame_num:</span> <span class="number">-1</span> <span class="comment"># preferably no more than 3</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_entrance.yml --do_break_in_counting=true --region_type=custom --region_polygon 355 700 1100 700 915 900 50 900 --device=gpu --video_file=demo_input/forb.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/ç¦åŒº.gif" alt></p><h2 id="PPVehicle"><a href="#PPVehicle" class="headerlink" title="PPVehicle"></a>PPVehicle</h2><h3 id="è½¦è¾†å±æ€§è¯†åˆ«"><a href="#è½¦è¾†å±æ€§è¯†åˆ«" class="headerlink" title="è½¦è¾†å±æ€§è¯†åˆ«"></a>è½¦è¾†å±æ€§è¯†åˆ«</h3><h4 id="è½¦è¾†å±æ€§"><a href="#è½¦è¾†å±æ€§" class="headerlink" title="è½¦è¾†å±æ€§"></a>è½¦è¾†å±æ€§</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DET:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_ppvehicle.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_ppvehicle.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/backend/pp_config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">skip_frame_num:</span> <span class="number">3</span> <span class="comment"># preferably no more than 3</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">VEHICLE_PLATE:</span></span><br><span class="line">  <span class="attr">det_model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/ch_PP-OCRv3_det_infer.tar.gz</span></span><br><span class="line">  <span class="attr">det_limit_side_len:</span> <span class="number">736</span></span><br><span class="line">  <span class="attr">det_limit_type:</span> <span class="string">"min"</span></span><br><span class="line">  <span class="attr">rec_model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/ch_PP-OCRv3_rec_infer.tar.gz</span></span><br><span class="line">  <span class="attr">rec_image_shape:</span> <span class="string">[3,</span> <span class="number">48</span><span class="string">,</span> <span class="number">320</span><span class="string">]</span></span><br><span class="line">  <span class="attr">rec_batch_num:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">word_dict_path:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/ppvehicle/rec_word_dict.txt</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">VEHICLE_ATTR:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/vehicle_attribute_model.zip</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">color_threshold:</span> <span class="number">0.5</span></span><br><span class="line">  <span class="attr">type_threshold:</span> <span class="number">0.5</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">LANE_SEG:</span></span><br><span class="line">  <span class="attr">lane_seg_config:</span> <span class="string">deploy/pipeline/config/lane_seg_config.yml</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/pp_lite_stdc2_bdd100k.zip</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_car.yml --device=gpu --video_file=demo_input/car.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/è½¦è¾†å±æ€§.gif" alt></p><h3 id="è½¦è¾†è¡Œä¸ºè¯†åˆ«"><a href="#è½¦è¾†è¡Œä¸ºè¯†åˆ«" class="headerlink" title="è½¦è¾†è¡Œä¸ºè¯†åˆ«"></a>è½¦è¾†è¡Œä¸ºè¯†åˆ«</h3><h4 id="ç¦æ­¢åœè½¦"><a href="#ç¦æ­¢åœè½¦" class="headerlink" title="ç¦æ­¢åœè½¦"></a>ç¦æ­¢åœè½¦</h4><p>cfgï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOT:</span></span><br><span class="line">  <span class="attr">model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_s_36e_ppvehicle.zip</span></span><br><span class="line">  <span class="attr">tracker_config:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">VEHICLE_PLATE:</span></span><br><span class="line">  <span class="attr">det_model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/ch_PP-OCRv3_det_infer.tar.gz</span></span><br><span class="line">  <span class="attr">det_limit_side_len:</span> <span class="number">736</span></span><br><span class="line">  <span class="attr">det_limit_type:</span> <span class="string">"min"</span></span><br><span class="line">  <span class="attr">rec_model_dir:</span> <span class="string">https://bj.bcebos.com/v1/paddledet/models/pipeline/ch_PP-OCRv3_rec_infer.tar.gz</span></span><br><span class="line">  <span class="attr">rec_image_shape:</span> <span class="string">[3,</span> <span class="number">48</span><span class="string">,</span> <span class="number">320</span><span class="string">]</span></span><br><span class="line">  <span class="attr">rec_batch_num:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">word_dict_path:</span> <span class="string">/exp/work/video/PaddleDetection/deploy/pipeline/ppvehicle/rec_word_dict.txt</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_park.yml --region_type=custom --FLAGS.illegal_parking_time=5 --region_polygon 600 200 1400 200 1400 900 600 900 --device=gpu --video_file=demo_input/park.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/ç¦æ­¢åœè½¦.gif" alt></p><h2 id="äººè„¸è¯†åˆ«"><a href="#äººè„¸è¯†åˆ«" class="headerlink" title="äººè„¸è¯†åˆ«"></a>äººè„¸è¯†åˆ«</h2><h4 id="äººè„¸è¯†åˆ«-1"><a href="#äººè„¸è¯†åˆ«-1" class="headerlink" title="äººè„¸è¯†åˆ«"></a>äººè„¸è¯†åˆ«</h4><p>cfgï¼ˆéœ€paddleDetectioné›†æˆarcfaceï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">attr_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FACE_DET:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FACE_REC:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_face.yml --device=gpu --video_file=demo_input/face.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/äººè„¸è¯†åˆ«.gif" style="zoom: 200%;"></p><h2 id="OCR"><a href="#OCR" class="headerlink" title="OCR"></a>OCR</h2><h3 id="è§†é¢‘OCR"><a href="#è§†é¢‘OCR" class="headerlink" title="è§†é¢‘OCR"></a>è§†é¢‘OCR</h3><p>cfgï¼ˆéœ€paddleDetectioné›†æˆpaddleOCRï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crop_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">attr_thresh:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">kpt_thresh:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">visual:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">warmup_frame:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">OCR:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>cliï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_ocr.yml --device=gpu --video_file=demo_input/ocr.mp4 --output_dir=demo_output/</span><br></pre></td></tr></table></figure><p><img src="/2023/08/31/paddleDetection Demo/OCR.gif" alt></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;PPHuman&quot;&gt;&lt;a href=&quot;#PPHuman&quot; class=&quot;headerlink&quot; title=&quot;PPHuman&quot;&gt;&lt;/a&gt;PPHuman&lt;/h2&gt;&lt;h3 id=&quot;è¡Œäººå±æ€§è¯†åˆ«&quot;&gt;&lt;a href=&quot;#è¡Œäººå±æ€§è¯†åˆ«&quot; class=&quot;headerlink&quot; title=&quot;è¡Œäººå±æ€§è¯†åˆ«&quot;&gt;&lt;/a&gt;è¡Œäººå±æ€§è¯†åˆ«&lt;/h3&gt;&lt;h4 id=&quot;è¡Œäººå±æ€§&quot;&gt;&lt;a href=&quot;#è¡Œäººå±æ€§&quot; class=&quot;headerlink&quot; title=&quot;è¡Œäººå±æ€§&quot;&gt;&lt;/a&gt;è¡Œäººå±æ€§&lt;/h4&gt;&lt;p&gt;cfgï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;crop_thresh:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;attr_thresh:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kpt_thresh:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0.2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;visual:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;warmup_frame:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;50&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;DET:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;model_dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_l_36e_pipeline.zip&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;batch_size:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;MOT:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;model_dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;https://bj.bcebos.com/v1/paddledet/models/pipeline/mot_ppyoloe_l_36e_pipeline.zip&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;tracker_config:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/exp/work/video/PaddleDetection/deploy/pipeline/config/tracker_config.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;batch_size:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;skip_frame_num:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# preferably no more than 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;enable:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;KPT:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;model_dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;https://bj.bcebos.com/v1/paddledet/models/pipeline/dark_hrnet_w32_256x192.zip&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;batch_size:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ATTR:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;model_dir:&lt;/span&gt;  &lt;span class=&quot;string&quot;&gt;https://bj.bcebos.com/v1/paddledet/models/pipeline/PPLCNet_x1_0_person_attribute_945_infer.zip&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;batch_size:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;enable:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;cliï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;python deploy/pipeline/pipeline.py --config deploy/pipeline/config/cache/cfg_human.yml --device=gpu --video_file=demo_input/human.mp4 --output_dir=demo_output/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;/2023/08/31/paddleDetection Demo/è¡Œäººå±æ€§.gif&quot; alt&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://yoursite.com/categories/æ·±åº¦å­¦ä¹ /"/>
    
    
    <category term="paddlepaddle" scheme="http://yoursite.com/tags/paddlepaddle/"/>
    
    <category term="opencv" scheme="http://yoursite.com/tags/opencv/"/>
    
  </entry>
  
</feed>
