<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>关键信息提取（kie） | 青域</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="OCRpaddleKIE">
  
  
  
  
  <meta name="description" content="环境准备服务器· OS: CentOS7.9· GPU:  RTX3090 24G2· CUDA:  11.7· CUDNN:  8.9.2### 飞桨· paddlepaddle:  paddlepaddle-gpu==2.4.2（cudatoolkit=11.7，建议conda安装）1conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7">
<meta name="keywords" content="OCR,paddle,KIE">
<meta property="og:type" content="article">
<meta property="og:title" content="关键信息提取（KIE）">
<meta property="og:url" content="http://yoursite.com/2024/11/26/关键信息提取（KIE）/index.html">
<meta property="og:site_name" content="青域">
<meta property="og:description" content="环境准备服务器· OS: CentOS7.9· GPU:  RTX3090 24G2· CUDA:  11.7· CUDNN:  8.9.2### 飞桨· paddlepaddle:  paddlepaddle-gpu==2.4.2（cudatoolkit=11.7，建议conda安装）1conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2024/11/26/关键信息提取（KIE）/4.png">
<meta property="og:updated_time" content="2024-11-28T09:07:02.581Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关键信息提取（KIE）">
<meta name="twitter:description" content="环境准备服务器· OS: CentOS7.9· GPU:  RTX3090 24G2· CUDA:  11.7· CUDNN:  8.9.2### 飞桨· paddlepaddle:  paddlepaddle-gpu==2.4.2（cudatoolkit=11.7，建议conda安装）1conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7">
<meta name="twitter:image" content="http://yoursite.com/2024/11/26/关键信息提取（KIE）/4.png">
  
    <link rel="alternate" href="/atom.xml" title="青域" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  

</head>
</html>

  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-关键信息提取（KIE）" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      关键信息提取（KIE）
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/11/26/关键信息提取（KIE）/" class="article-date">
	  <time datetime="2024-11-26T11:24:34.000Z" itemprop="datePublished">2024-11-26</time>
	</a>

      
      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <script src="\assets\js\APlayer.min.js"> </script><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><font color="gold"><strong>· OS: </strong></font>CentOS7.9<br><br><font color="gold"><strong>· GPU: </strong></font> RTX3090 24G<em>2<br><br><font color="gold"><strong>· CUDA: </strong></font> 11.7<br><br><font color="gold"><strong>· CUDNN: </strong></font> 8.9.2<br><br>### 飞桨<br><br><font color="gold"><strong>· paddlepaddle: </strong></font> paddlepaddle-gpu==2.4.2（cudatoolkit=11.7，建议conda安装）<br><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge</span><br></pre></td></tr></table></figure><br><br><font color="gold"><strong>· paddleocr: </strong></font> 2.9.1<br><br><font color="gold"><strong>· paddlenlp: </strong></font> 2.5.2<br><br>### 项目依赖包<br><br><strong><code>requirements.txt</code></strong><br><br><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># paddlepaddle 2.4.2 注：必须</span><br><span class="line"># conda install paddlepaddle-gpu==2.4.2 cudatoolkit=11.7 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/ -c conda-forge</span><br><span class="line"></span><br><span class="line">shapely</span><br><span class="line">scikit-image</span><br><span class="line">pyclipper</span><br><span class="line">lmdb</span><br><span class="line">tqdm</span><br><span class="line">numpy</span><br><span class="line">rapidfuzz</span><br><span class="line">opencv-python</span><br><span class="line">opencv-contrib-python</span><br><span class="line">cython</span><br><span class="line">Pillow</span><br><span class="line">pyyaml</span><br><span class="line">requests</span><br><span class="line">albumentations==1.4.10</span><br><span class="line"># to be compatible with albumentations</span><br><span class="line">albucore==0.0.13</span><br><span class="line"></span><br><span class="line">sentencepiece</span><br><span class="line">yacs</span><br><span class="line">seqeval</span><br><span class="line">pypandoc</span><br><span class="line">attrdict3</span><br><span class="line">python_docx</span><br><span class="line">paddlenlp==2.5.2</span><br></pre></td></tr></table></figure><br><br><font color="red"><strong>注：</strong></font> <strong>bugfix</strong><br><br><font color="gold"><strong>1.</strong></font> `ModuleNotFoundError: No module named ‘ppocr.**</em>‘<code>前往官方github主页（&lt;https://github.com/PaddlePaddle/PaddleOCR&gt;）补齐源码到python环境

e.g.conda 虚拟环境下，需要补齐的源码根目录为：</code>/root/anaconda3/envs/py39_kie/lib/python3.9/site-packages/paddleocr/ppocr<code>&lt;font color=&#39;gold&#39;&gt;**2.**&lt;/font&gt;</code>ModuleNotFoundError: No module named ‘paddle.fluid’<code>安装较低版本paddle</code>paddlepaddle2.4.2/2.5.0<code>&lt;font color=&#39;gold&#39;&gt;**3.**&lt;/font&gt; 类型错误：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InvalidArgumentError: The type of data we are trying to retrieve does not match the type of data currently contained in the container.</span><br><span class="line">      [Hint: Expected dtype() == paddle::experimental::CppTypeToDataType&lt;T&gt;::Type(), but received dtype():10 != paddle::experimental::CppTypeToDataType&lt;T&gt;::Type():9.] (at /paddle/paddle/phi/core/dense_tensor.cc:143)</span><br><span class="line">      [operator &lt; less_equal &gt; error]</span><br></pre></td></tr></table></figure>

官方示例bug，需要添加参数项</code>–use_visual_backbone = False<code>&lt;!--more--&gt;

## 模型

参考：&lt;https://paddlepaddle.github.io/PaddleOCR/latest/ppstructure/model_train/train_kie.html&gt;

### 准备（inference模型）

SER任务模型下载链接：&lt;https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/ser_vi_layoutxlm_xfund_infer.tar&gt;

RE任务模型下载链接：&lt;https://paddleocr.bj.bcebos.com/ppstructure/models/vi_layoutxlm/re_vi_layoutxlm_xfund_infer.tar&gt;

创建项目根目录</code>demo<code>并添加测试图片</code>1.png<code>，在</code>demo<code>目录下新建</code>models<code>文件夹用于存放OCR、SER、RE模型、字典文件、字体文件。其中OCR模型可使用ppocrv3、v4版本下检测和识别（det/rec）模型，字典文件复制源码目录下</code>paddleocr/ppocr/utils/dict/kie_dict/xfund_class_list.txt<code>，字体文件使用</code>simfang.ttf<code>### SER/RE模型串联

&lt;font color=&#39;gold&#39;&gt;**1.**&lt;/font&gt;创建官方代码示例</code>demo/test.py<code>用于测试和显示图像（源码：</code>paddleocr/ppstructure/kie/predict_kie_token_ser_re.py<code>）

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2022 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">"../.."</span>)))</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">"FLAGS_allocator_strategy"</span>] = <span class="string">"auto_growth"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.infer.utility <span class="keyword">as</span> utility</span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.infer_kie_token_ser_re <span class="keyword">import</span> make_input</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.postprocess <span class="keyword">import</span> build_post_process</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.logging <span class="keyword">import</span> get_logger</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.visual <span class="keyword">import</span> draw_ser_results, draw_re_results</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.utility <span class="keyword">import</span> get_image_file_list, check_and_read</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.utility <span class="keyword">import</span> parse_args</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.kie.predict_kie_token_ser <span class="keyword">import</span> SerPredictor</span><br><span class="line"></span><br><span class="line">logger = get_logger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerRePredictor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.use_visual_backbone = args.use_visual_backbone</span><br><span class="line">        self.ser_engine = SerPredictor(args)</span><br><span class="line">        <span class="keyword">if</span> args.re_model_dir <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            postprocess_params = &#123;<span class="string">"name"</span>: <span class="string">"VQAReTokenLayoutLMPostProcess"</span>&#125;</span><br><span class="line">            self.postprocess_op = build_post_process(postprocess_params)</span><br><span class="line">            (</span><br><span class="line">                self.predictor,</span><br><span class="line">                self.input_tensor,</span><br><span class="line">                self.output_tensors,</span><br><span class="line">                self.config,</span><br><span class="line">            ) = utility.create_predictor(args, <span class="string">"re"</span>, logger)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.predictor = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        starttime = time.time()</span><br><span class="line">        ser_results, ser_inputs, ser_elapse = self.ser_engine(img)</span><br><span class="line">        <span class="keyword">if</span> self.predictor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ser_results, ser_elapse</span><br><span class="line"></span><br><span class="line">        re_input, entity_idx_dict_batch = make_input(ser_inputs, ser_results)</span><br><span class="line">        <span class="keyword">if</span> self.use_visual_backbone == <span class="literal">False</span>:</span><br><span class="line">            re_input.pop(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(self.input_tensor)):</span><br><span class="line">            self.input_tensor[idx].copy_from_cpu(re_input[idx])</span><br><span class="line"></span><br><span class="line">        self.predictor.run()</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> output_tensor <span class="keyword">in</span> self.output_tensors:</span><br><span class="line">            output = output_tensor.copy_to_cpu()</span><br><span class="line">            outputs.append(output)</span><br><span class="line">        preds = dict(</span><br><span class="line">            loss=outputs[<span class="number">1</span>],</span><br><span class="line">            pred_relations=outputs[<span class="number">2</span>],</span><br><span class="line">            hidden_states=outputs[<span class="number">0</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        post_result = self.postprocess_op(</span><br><span class="line">            preds, ser_results=ser_results, entity_idx_dict_batch=entity_idx_dict_batch</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        elapse = time.time() - starttime</span><br><span class="line">        <span class="keyword">return</span> post_result, elapse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(args)</span>:</span></span><br><span class="line">    image_file_list = get_image_file_list(args.image_dir)</span><br><span class="line">    ser_re_predictor = SerRePredictor(args)</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    total_time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    os.makedirs(args.output, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> open(</span><br><span class="line">            os.path.join(args.output, <span class="string">"infer.txt"</span>), mode=<span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span></span><br><span class="line">    ) <span class="keyword">as</span> f_w:</span><br><span class="line">        <span class="keyword">for</span> image_file <span class="keyword">in</span> image_file_list:</span><br><span class="line">            img, flag, _ = check_and_read(image_file)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">                img = cv2.imread(image_file)</span><br><span class="line">                img = img[:, :, ::<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                logger.info(<span class="string">"error in loading image:&#123;&#125;"</span>.format(image_file))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            re_res, elapse = ser_re_predictor(img)</span><br><span class="line">            re_res = re_res[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            res_str = <span class="string">"&#123;&#125;\t&#123;&#125;\n"</span>.format(</span><br><span class="line">                image_file,</span><br><span class="line">                json.dumps(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"ocr_info"</span>: re_res,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ensure_ascii=<span class="literal">False</span>,</span><br><span class="line">                ),</span><br><span class="line">            )</span><br><span class="line">            f_w.write(res_str)</span><br><span class="line">            <span class="keyword">if</span> ser_re_predictor.predictor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                img_res = draw_re_results(</span><br><span class="line">                    image_file, re_res, font_path=args.vis_font_path</span><br><span class="line">                )</span><br><span class="line">                img_save_path = os.path.join(</span><br><span class="line">                    args.output,</span><br><span class="line">                    os.path.splitext(os.path.basename(image_file))[<span class="number">0</span>] + <span class="string">"_ser_re.jpg"</span>,</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img_res = draw_ser_results(</span><br><span class="line">                    image_file, re_res, font_path=args.vis_font_path</span><br><span class="line">                )</span><br><span class="line">                img_save_path = os.path.join(</span><br><span class="line">                    args.output,</span><br><span class="line">                    os.path.splitext(os.path.basename(image_file))[<span class="number">0</span>] + <span class="string">"_ser.jpg"</span>,</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            cv2.imwrite(img_save_path, img_res)</span><br><span class="line">            logger.info(<span class="string">"save vis result to &#123;&#125;"</span>.format(img_save_path))</span><br><span class="line">            <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">                total_time += elapse</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            logger.info(<span class="string">"Predict time of &#123;&#125;: &#123;&#125;"</span>.format(image_file, elapse))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    args.mode = <span class="string">'kie'</span></span><br><span class="line">    args.use_visual_backbone = <span class="literal">False</span></span><br><span class="line">    args.kie_algorithm = <span class="string">'LayoutXLM'</span></span><br><span class="line">    args.re_model_dir = <span class="string">'./models/re_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_model_dir = <span class="string">'./models/ser_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_dict_path = <span class="string">'./models/xfund_class_list.txt'</span></span><br><span class="line">    args.vis_font_path = <span class="string">'./models/simfang.ttf'</span></span><br><span class="line">    args.ocr_order_method = <span class="string">"tb-yx"</span></span><br><span class="line">    args.det_model_dir = <span class="string">'./models/ch_PP-OCRv3_det_infer'</span></span><br><span class="line">    args.rec_model_dir = <span class="string">'./models/ch_PP-OCRv4_rec_infer'</span></span><br><span class="line">    args.image_dir = <span class="string">'./1.png'</span></span><br><span class="line">    main(args)</span><br></pre></td></tr></table></figure>

![](关键信息提取（KIE）\1.png)

&lt;font color=&#39;gold&#39;&gt;**2.**&lt;/font&gt;创建</code>demo/main.py<code>用于测试

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.kie.predict_kie_token_ser_re <span class="keyword">import</span> SerRePredictor</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppstructure.utility <span class="keyword">import</span> parse_args</span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.infer_kie_token_ser_re <span class="keyword">import</span> make_input</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承SerRePredictor类，重写__call__方法，实现同时输出Ser模型结果</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KIE</span><span class="params">(SerRePredictor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, para)</span>:</span></span><br><span class="line">        super().__init__(para)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, im)</span>:</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        ser_results, ser_inputs, ser_elapse = self.ser_engine(im)</span><br><span class="line">        <span class="keyword">if</span> self.predictor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> ser_results, ser_elapse</span><br><span class="line"></span><br><span class="line">        re_input, entity_idx_dict_batch = make_input(ser_inputs, ser_results)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.use_visual_backbone:</span><br><span class="line">            re_input.pop(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(self.input_tensor)):</span><br><span class="line">            self.input_tensor[idx].copy_from_cpu(re_input[idx])</span><br><span class="line"></span><br><span class="line">        self.predictor.run()</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> output_tensor <span class="keyword">in</span> self.output_tensors:</span><br><span class="line">            output = output_tensor.copy_to_cpu()</span><br><span class="line">            outputs.append(output)</span><br><span class="line">        preds = dict(</span><br><span class="line">            loss=outputs[<span class="number">1</span>],</span><br><span class="line">            pred_relations=outputs[<span class="number">2</span>],</span><br><span class="line">            hidden_states=outputs[<span class="number">0</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        post_result = self.postprocess_op(</span><br><span class="line">            preds, ser_results=ser_results, entity_idx_dict_batch=entity_idx_dict_batch</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        elapse_time = time.time() - start_time</span><br><span class="line">        <span class="keyword">return</span> ser_results, post_result, elapse_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    args.mode = <span class="string">'kie'</span></span><br><span class="line">    args.show_log = <span class="literal">True</span></span><br><span class="line">    args.use_visual_backbone = <span class="literal">False</span></span><br><span class="line">    args.kie_algorithm = <span class="string">'LayoutXLM'</span></span><br><span class="line">    args.re_model_dir = <span class="string">'./models/re_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_model_dir = <span class="string">'./models/ser_vi_layoutxlm_xfund_infer'</span></span><br><span class="line">    args.ser_dict_path = <span class="string">'./models/xfund_class_list.txt'</span></span><br><span class="line">    args.vis_font_path = <span class="string">'./models/simfang.ttf'</span></span><br><span class="line">    args.ocr_order_method = <span class="string">"tb-yx"</span></span><br><span class="line">    args.det_model_dir = <span class="string">'./models/ch_PP-OCRv3_det_infer'</span></span><br><span class="line">    args.rec_model_dir = <span class="string">'./models/ch_PP-OCRv4_rec_infer'</span></span><br><span class="line">    args.det_limit_side_len = <span class="number">1600</span>,</span><br><span class="line"></span><br><span class="line">    kie = KIE(args)</span><br><span class="line">    img = cv2.imread(<span class="string">'./1.png'</span>)</span><br><span class="line">    ser_res, re_res, elapse = kie(img)</span><br><span class="line">    print(ser_res, <span class="string">'\n'</span>, re_res, <span class="string">'\n'</span>, elapse)</span><br></pre></td></tr></table></figure>

输出：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[&#123;&apos;transcription&apos;: &apos;证号&apos;, &apos;bbox&apos;: [239, 113, 267, 128], &apos;points&apos;: [[239.0, 113.0], [267.0, 113.0], [267.0, 128.0], [239.0, 128.0]], &apos;pred_id&apos;: 0, &apos;pred&apos;: &apos;O&apos;&#125;, &#123;&apos;transcription&apos;: &apos;T4105051990090&apos;, &apos;bbox&apos;: [240, 135, 441, 157], &apos;points&apos;: [[240.0, 135.0], [441.0, 136.0], [440.0, 157.0], [240.0, 156.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;姓名&apos;, &apos;bbox&apos;: [239, 162, 266, 178], &apos;points&apos;: [[239.0, 162.0], [266.0, 162.0], [266.0, 178.0], [239.0, 178.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;作业类别&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;毕宏&apos;, &apos;bbox&apos;: [237, 182, 296, 203], &apos;points&apos;: [[237.0, 182.0], [296.0, 182.0], [296.0, 203.0], [237.0, 203.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 185, 586, 204], &apos;points&apos;: [[432.0, 185.0], [586.0, 185.0], [586.0, 204.0], [432.0, 204.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;男&apos;, &apos;bbox&apos;: [237, 246, 259, 269], &apos;points&apos;: [[237.0, 246.0], [259.0, 246.0], [259.0, 269.0], [237.0, 269.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;性别&apos;, &apos;bbox&apos;: [238, 227, 269, 246], &apos;points&apos;: [[238.0, 227.0], [269.0, 227.0], [269.0, 246.0], [238.0, 246.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;操作项目&apos;, &apos;bbox&apos;: [430, 228, 484, 245], &apos;points&apos;: [[430.0, 228.0], [484.0, 228.0], [484.0, 245.0], [430.0, 245.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;熔化焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 251, 622, 268], &apos;points&apos;: [[432.0, 251.0], [622.0, 251.0], [622.0, 268.0], [432.0, 268.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29&apos;, &apos;bbox&apos;: [71, 342, 173, 362], &apos;points&apos;: [[72.0, 342.0], [173.0, 345.0], [173.0, 362.0], [71.0, 360.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;初领日期&apos;, &apos;bbox&apos;: [73, 325, 128, 341], &apos;points&apos;: [[73.0, 325.0], [128.0, 325.0], [128.0, 341.0], [73.0, 341.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;有效期限&apos;, &apos;bbox&apos;: [226, 327, 278, 342], &apos;points&apos;: [[226.0, 327.0], [278.0, 327.0], [278.0, 342.0], [226.0, 342.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29至2029-03-28&apos;, &apos;bbox&apos;: [226, 345, 448, 362], &apos;points&apos;: [[226.0, 345.0], [448.0, 345.0], [448.0, 362.0], [226.0, 362.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2026-03-28前&apos;, &apos;bbox&apos;: [71, 389, 192, 413], &apos;points&apos;: [[72.0, 389.0], [192.0, 392.0], [192.0, 413.0], [71.0, 410.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;, &#123;&apos;transcription&apos;: &apos;应复审日期&apos;, &apos;bbox&apos;: [74, 373, 140, 390], &apos;points&apos;: [[74.0, 373.0], [140.0, 373.0], [140.0, 390.0], [74.0, 390.0]], &apos;pred_id&apos;: 0, &apos;pred&apos;: &apos;O&apos;&#125;, &#123;&apos;transcription&apos;: &apos;签发机关&apos;, &apos;bbox&apos;: [223, 374, 278, 393], &apos;points&apos;: [[223.0, 375.0], [277.0, 374.0], [278.0, 392.0], [224.0, 393.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;河南省应急管理厅&apos;, &apos;bbox&apos;: [224, 394, 378, 414], &apos;points&apos;: [[224.0, 394.0], [378.0, 394.0], [378.0, 414.0], [224.0, 414.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;]] </span><br><span class="line"> [[(&#123;&apos;transcription&apos;: &apos;姓名&apos;, &apos;bbox&apos;: [239, 162, 266, 178], &apos;points&apos;: [[239.0, 162.0], [266.0, 162.0], [266.0, 178.0], [239.0, 178.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;毕宏&apos;, &apos;bbox&apos;: [237, 182, 296, 203], &apos;points&apos;: [[237.0, 182.0], [296.0, 182.0], [296.0, 203.0], [237.0, 203.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;作业类别&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 185, 586, 204], &apos;points&apos;: [[432.0, 185.0], [586.0, 185.0], [586.0, 204.0], [432.0, 204.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;作业类别&apos;, &apos;bbox&apos;: [431, 162, 486, 179], &apos;points&apos;: [[431.0, 162.0], [486.0, 162.0], [486.0, 179.0], [431.0, 179.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;熔化焊接与热切割作业&apos;, &apos;bbox&apos;: [432, 251, 622, 268], &apos;points&apos;: [[432.0, 251.0], [622.0, 251.0], [622.0, 268.0], [432.0, 268.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;性别&apos;, &apos;bbox&apos;: [238, 227, 269, 246], &apos;points&apos;: [[238.0, 227.0], [269.0, 227.0], [269.0, 246.0], [238.0, 246.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;男&apos;, &apos;bbox&apos;: [237, 246, 259, 269], &apos;points&apos;: [[237.0, 246.0], [259.0, 246.0], [259.0, 269.0], [237.0, 269.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;初领日期&apos;, &apos;bbox&apos;: [73, 325, 128, 341], &apos;points&apos;: [[73.0, 325.0], [128.0, 325.0], [128.0, 341.0], [73.0, 341.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29&apos;, &apos;bbox&apos;: [71, 342, 173, 362], &apos;points&apos;: [[72.0, 342.0], [173.0, 345.0], [173.0, 362.0], [71.0, 360.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;有效期限&apos;, &apos;bbox&apos;: [226, 327, 278, 342], &apos;points&apos;: [[226.0, 327.0], [278.0, 327.0], [278.0, 342.0], [226.0, 342.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;2023-03-29至2029-03-28&apos;, &apos;bbox&apos;: [226, 345, 448, 362], &apos;points&apos;: [[226.0, 345.0], [448.0, 345.0], [448.0, 362.0], [226.0, 362.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;), (&#123;&apos;transcription&apos;: &apos;签发机关&apos;, &apos;bbox&apos;: [223, 374, 278, 393], &apos;points&apos;: [[223.0, 375.0], [277.0, 374.0], [278.0, 392.0], [224.0, 393.0]], &apos;pred_id&apos;: 1, &apos;pred&apos;: &apos;QUESTION&apos;&#125;, &#123;&apos;transcription&apos;: &apos;河南省应急管理厅&apos;, &apos;bbox&apos;: [224, 394, 378, 414], &apos;points&apos;: [[224.0, 394.0], [378.0, 394.0], [378.0, 414.0], [224.0, 414.0]], &apos;pred_id&apos;: 3, &apos;pred&apos;: &apos;ANSWER&apos;&#125;)]] </span><br><span class="line"> 0.959315299987793</span><br></pre></td></tr></table></figure>

## 训练（基于XFUND数据集）

参考：&lt;https://paddlepaddle.github.io/PaddleOCR/latest/ppocr/model_train/kie.html&gt;

### 数据下载

XFUND github主页：&lt;https://github.com/doc-analysis/XFUND&gt;

数据集下载地址：&lt;https://github.com/doc-analysis/XFUND/releases/tag/v1.0&gt;

选择中文数据集</code>zh.train.json<code>、</code>zh.train.zip<code>、</code>zh.val.json<code>、</code>zh.val.zip<code>并下载

![](关键信息提取（KIE）\2.png)

### 数据格式转换

创建XFUND格式转Paddle训练格式代码</code>demo/trans_xfun_data.py<code>（源码：</code>paddleocr/ppstructure/kie/tools/trans_xfun_data.py<code>）

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transfer_xfun_data</span><span class="params">(json_path=None, output_file=None)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(json_path, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fin:</span><br><span class="line">        lines = fin.readlines()</span><br><span class="line"></span><br><span class="line">    json_info = json.loads(lines[<span class="number">0</span>])</span><br><span class="line">    documents = json_info[<span class="string">"documents"</span>]</span><br><span class="line">    <span class="keyword">with</span> open(output_file, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        <span class="keyword">for</span> idx, document <span class="keyword">in</span> enumerate(documents):</span><br><span class="line">            label_info = []</span><br><span class="line">            img_info = document[<span class="string">"img"</span>]</span><br><span class="line">            document = document[<span class="string">"document"</span>]</span><br><span class="line">            image_path = img_info[<span class="string">"fname"</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> doc <span class="keyword">in</span> document:</span><br><span class="line">                x1, y1, x2, y2 = doc[<span class="string">"box"</span>]</span><br><span class="line">                points = [[x1, y1], [x2, y1], [x2, y2], [x1, y2]]</span><br><span class="line">                label_info.append(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"transcription"</span>: doc[<span class="string">"text"</span>],</span><br><span class="line">                        <span class="string">"label"</span>: doc[<span class="string">"label"</span>],</span><br><span class="line">                        <span class="string">"points"</span>: points,</span><br><span class="line">                        <span class="string">"id"</span>: doc[<span class="string">"id"</span>],</span><br><span class="line">                        <span class="string">"linking"</span>: doc[<span class="string">"linking"</span>],</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            fout.write(</span><br><span class="line">                image_path + <span class="string">"\t"</span> + json.dumps(label_info, ensure_ascii=<span class="literal">False</span>) + <span class="string">"\n"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"===ok===="</span>)</span><br><span class="line"></span><br><span class="line">ori_gt_path = <span class="string">r'D:\pycharmproject_2\kie\demo\dataset\zh.val.json'</span></span><br><span class="line">output_path = <span class="string">r'D:\pycharmproject_2\kie\demo\dataset\xfun_val.json'</span></span><br><span class="line"></span><br><span class="line">transfer_xfun_data(ori_gt_path, output_path)</span><br></pre></td></tr></table></figure>

原始格式：

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"lang"</span>: <span class="string">"zh"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.1"</span>,</span><br><span class="line">  <span class="attr">"split"</span>: <span class="string">"train"</span>,</span><br><span class="line">  <span class="attr">"documents"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"zh_train_0"</span>,</span><br><span class="line">      <span class="attr">"uid"</span>: <span class="string">"640a0301a1cb24331748b579405502b44d6791883b25ea0eafc8a68126ccdadd"</span>,</span><br><span class="line">      <span class="attr">"document"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"box"</span>: [</span><br><span class="line">            <span class="number">104</span>,</span><br><span class="line">            <span class="number">114</span>,</span><br><span class="line">            <span class="number">530</span>,</span><br><span class="line">            <span class="number">175</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"汇丰晋信"</span>,</span><br><span class="line">          <span class="attr">"label"</span>: <span class="string">"other"</span>,</span><br><span class="line">          <span class="attr">"words"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">110</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">152</span>,</span><br><span class="line">                <span class="number">175</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"汇"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">189</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">229</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"丰"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">385</span>,</span><br><span class="line">                <span class="number">117</span>,</span><br><span class="line">                <span class="number">426</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"晋"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"box"</span>: [</span><br><span class="line">                <span class="number">466</span>,</span><br><span class="line">                <span class="number">116</span>,</span><br><span class="line">                <span class="number">508</span>,</span><br><span class="line">                <span class="number">177</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">"text"</span>: <span class="string">"信"</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"linking"</span>: [],</span><br><span class="line">          <span class="attr">"id"</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">          ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">      ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

转换：

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zh_train_0.jpg	[&#123;"transcription": "汇丰晋信", "label": "other", "points": [[104, 114], [530, 114], [530, 175], [104, 175]], "id": 1, "linking": []&#125;, &#123;"transcription": "受理时间:", "label": "question", "points": [[126, 267], [266, 267], [266, 305], [126, 305]], "id": 7, "linking": [[7, 13]]&#125;, &#123;"transcription": "2020.6.15", "label": "answer", "points": [[321, 239], [537, 239], [537, 285], [321, 285]], "id": 13, "linking": [[7, 13]]&#125;...]</span><br><span class="line">zh_train_1.jpg	[...]</span><br></pre></td></tr></table></figure>

### 配置字典文件

用于存储各段文本的标签类别，这里使用</code>models/xfund_class_list.txt<code>字典文件

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OTHER</span><br><span class="line">QUESTION</span><br><span class="line">ANSWER</span><br><span class="line">HEADER</span><br></pre></td></tr></table></figure>

&lt;font color=&#39;red&#39;&gt;**注：**&lt;/font&gt; 字典中的标签和json文件中的标签不区分大小写

### 配置训练文件

#### SER模型训练文件

创建并修改SER模型训练yaml文件</code>demo/ser_vi_layoutxlm_xfund_zh.yml<code>，源文件路径：</code>configs/kie/vi_layoutxlm/ser_vi_layoutxlm_xfund_zh.yml<code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Global:</span></span><br><span class="line">  <span class="attr">use_gpu:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">epoch_num:</span> <span class="string">&amp;epoch_num</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">log_smooth_window:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">print_batch_step:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">save_model_dir:</span> <span class="string">./output/ser_vi_layoutxlm_xfund_zh</span></span><br><span class="line">  <span class="attr">save_epoch_step:</span> <span class="number">2000</span></span><br><span class="line">  <span class="comment"># evaluation is run every 10 iterations after the 0th iteration</span></span><br><span class="line">  <span class="attr">eval_batch_step:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">19</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">cal_metric_during_train:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">save_inference_dir:</span></span><br><span class="line">  <span class="attr">use_visualdl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">seed:</span> <span class="number">2022</span></span><br><span class="line">  <span class="attr">infer_img:</span> <span class="string">dataset/xfund_train/zh_train/zh_val_42.jpg</span></span><br><span class="line">  <span class="attr">d2s_train_image_shape:</span> <span class="string">[3,</span> <span class="number">224</span><span class="string">,</span> <span class="number">224</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># if you want to predict using the groundtruth ocr info,</span></span><br><span class="line">  <span class="comment"># you can use the following config</span></span><br><span class="line">  <span class="comment"># infer_img: train_data/XFUND/zh_val/val.json</span></span><br><span class="line">  <span class="comment"># infer_mode: False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">save_res_path:</span> <span class="string">./output/ser/xfund_zh/res</span></span><br><span class="line">  <span class="attr">kie_rec_model_dir:</span></span><br><span class="line">  <span class="attr">kie_det_model_dir:</span></span><br><span class="line">  <span class="attr">amp_custom_white_list:</span> <span class="string">['scale',</span> <span class="string">'concat'</span><span class="string">,</span> <span class="string">'elementwise_add'</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Architecture:</span></span><br><span class="line">  <span class="attr">model_type:</span> <span class="string">kie</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&amp;algorithm</span> <span class="string">"LayoutXLM"</span></span><br><span class="line">  <span class="attr">Transform:</span></span><br><span class="line">  <span class="attr">Backbone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LayoutXLMForSer</span></span><br><span class="line">    <span class="attr">pretrained:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">checkpoints:</span></span><br><span class="line">    <span class="comment"># one of base or vi</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">vi</span></span><br><span class="line">    <span class="attr">num_classes:</span> <span class="string">&amp;num_classes</span> <span class="number">7</span> <span class="comment"># &lt;--------------------------------------当标签数为n时，存在OTHER标签，取2n-1；不存在OTHER标签，取2n+1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Loss:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenLayoutLMLoss</span></span><br><span class="line">  <span class="attr">num_classes:</span> <span class="meta">*num_classes</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">"backbone_out"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizer:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">AdamW</span></span><br><span class="line">  <span class="attr">beta1:</span> <span class="number">0.9</span></span><br><span class="line">  <span class="attr">beta2:</span> <span class="number">0.999</span></span><br><span class="line">  <span class="attr">lr:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Linear</span></span><br><span class="line">    <span class="attr">learning_rate:</span> <span class="number">0.00005</span></span><br><span class="line">    <span class="attr">epochs:</span> <span class="meta">*epoch_num</span></span><br><span class="line">    <span class="attr">warmup_epoch:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">regularizer:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">L2</span></span><br><span class="line">    <span class="attr">factor:</span> <span class="number">0.00000</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">PostProcess:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenLayoutLMPostProcess</span></span><br><span class="line">  <span class="attr">class_path:</span> <span class="string">&amp;class_path</span> <span class="string">models/xfund_class_list.txt</span> <span class="comment"># &lt;--------------------------------------字典文件路径</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metric:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQASerTokenMetric</span></span><br><span class="line">  <span class="attr">main_indicator:</span> <span class="string">hmean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Train:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_train</span> <span class="comment"># &lt;--------------------------------------训练集图像路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_train.json</span> <span class="comment"># &lt;--------------------------------------训练集json文件路径</span></span><br><span class="line">    <span class="attr">ratio_list:</span> <span class="string">[</span> <span class="number">1.0</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">False</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="string">&amp;use_textline_bbox_info</span> <span class="literal">True</span></span><br><span class="line">          <span class="comment"># one of [None, "tb-yx"]</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="string">&amp;order_method</span> <span class="string">"tb-yx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="string">&amp;max_seq_len</span> <span class="number">512</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQASerTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'image'</span><span class="string">,</span> <span class="string">'labels'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Eval:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_val</span> <span class="comment"># &lt;--------------------------------------验证集图片路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_val.json</span> <span class="comment"># &lt;--------------------------------------验证集json文件路径</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">False</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="meta">*use_textline_bbox_info</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="meta">*order_method</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQASerTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'image'</span><span class="string">,</span> <span class="string">'labels'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

#### RE模型训练文件

创建并修改RE模型训练yaml文件</code>demo/re_vi_layoutxlm_xfund_zh.yml<code>，源文件路径：</code>configs/kie/vi_layoutxlm/re_vi_layoutxlm_xfund_zh.yml<code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Global:</span></span><br><span class="line">  <span class="attr">use_gpu:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">epoch_num:</span> <span class="string">&amp;epoch_num</span> <span class="number">130</span></span><br><span class="line">  <span class="attr">log_smooth_window:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">print_batch_step:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">save_model_dir:</span> <span class="string">./output/re_vi_layoutxlm_xfund_zh</span></span><br><span class="line">  <span class="attr">save_epoch_step:</span> <span class="number">2000</span></span><br><span class="line">  <span class="comment"># evaluation is run every 10 iterations after the 0th iteration</span></span><br><span class="line">  <span class="attr">eval_batch_step:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">19</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">cal_metric_during_train:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">save_inference_dir:</span></span><br><span class="line">  <span class="attr">use_visualdl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">seed:</span> <span class="number">2022</span></span><br><span class="line">  <span class="attr">infer_img:</span> <span class="string">dataset/xfund_train/zh_train/zh_val_21.jpg</span></span><br><span class="line">  <span class="attr">save_res_path:</span> <span class="string">./output/re/xfund_zh/with_gt</span></span><br><span class="line">  <span class="attr">kie_rec_model_dir:</span> </span><br><span class="line">  <span class="attr">kie_det_model_dir:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Architecture:</span></span><br><span class="line">  <span class="attr">model_type:</span> <span class="string">kie</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&amp;algorithm</span> <span class="string">"LayoutXLM"</span></span><br><span class="line">  <span class="attr">Transform:</span></span><br><span class="line">  <span class="attr">Backbone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LayoutXLMForRe</span></span><br><span class="line">    <span class="attr">pretrained:</span> <span class="string">dataset/re_vi_layoutxlm_xfund_pretrained</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">vi</span></span><br><span class="line">    <span class="attr">checkpoints:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Loss:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">LossFromOutput</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">loss</span></span><br><span class="line">  <span class="attr">reduction:</span> <span class="string">mean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizer:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">AdamW</span></span><br><span class="line">  <span class="attr">beta1:</span> <span class="number">0.9</span></span><br><span class="line">  <span class="attr">beta2:</span> <span class="number">0.999</span></span><br><span class="line">  <span class="attr">clip_norm:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">lr:</span></span><br><span class="line">    <span class="attr">learning_rate:</span> <span class="number">0.00005</span></span><br><span class="line">    <span class="attr">warmup_epoch:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">regularizer:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">L2</span></span><br><span class="line">    <span class="attr">factor:</span> <span class="number">0.00000</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">PostProcess:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQAReTokenLayoutLMPostProcess</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metric:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">VQAReTokenMetric</span></span><br><span class="line">  <span class="attr">main_indicator:</span> <span class="string">hmean</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Train:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_train</span> <span class="comment"># &lt;--------------------------------------训练集图片路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_train.json</span> <span class="comment"># &lt;--------------------------------------训练集json文件路径</span></span><br><span class="line">    <span class="attr">ratio_list:</span> <span class="string">[</span> <span class="number">1.0</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="string">&amp;class_path</span> <span class="string">models/xfund_class_list.txt</span> <span class="comment"># &lt;--------------------------------------字典文件路径</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="string">&amp;use_textline_bbox_info</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="string">&amp;order_method</span> <span class="string">"tb-yx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="string">&amp;max_seq_len</span> <span class="number">512</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenRelation:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">TensorizeEntitiesRelations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,'attention_mask',</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'entities'</span><span class="string">,</span> <span class="string">'relations'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Eval:</span></span><br><span class="line">  <span class="attr">dataset:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SimpleDataSet</span></span><br><span class="line">    <span class="attr">data_dir:</span> <span class="string">dataset/xfund_train/zh_val</span> <span class="comment"># &lt;--------------------------------------验证集图片路径</span></span><br><span class="line">    <span class="attr">label_file_list:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dataset/xfund_train/xfun_val.json</span> <span class="comment"># &lt;--------------------------------------验证集json文件路径</span></span><br><span class="line">    <span class="attr">transforms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">DecodeImage:</span> <span class="comment"># load image</span></span><br><span class="line">          <span class="attr">img_mode:</span> <span class="string">RGB</span></span><br><span class="line">          <span class="attr">channel_first:</span> <span class="literal">False</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenLabelEncode:</span> <span class="comment"># Class handling label</span></span><br><span class="line">          <span class="attr">contains_re:</span> <span class="literal">True</span></span><br><span class="line">          <span class="attr">algorithm:</span> <span class="meta">*algorithm</span></span><br><span class="line">          <span class="attr">class_path:</span> <span class="meta">*class_path</span></span><br><span class="line">          <span class="attr">use_textline_bbox_info:</span> <span class="meta">*use_textline_bbox_info</span></span><br><span class="line">          <span class="attr">order_method:</span> <span class="meta">*order_method</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQATokenPad:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">          <span class="attr">return_attention_mask:</span> <span class="literal">True</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenRelation:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">VQAReTokenChunk:</span></span><br><span class="line">          <span class="attr">max_seq_len:</span> <span class="meta">*max_seq_len</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">TensorizeEntitiesRelations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Resize:</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">[224,224]</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">NormalizeImage:</span></span><br><span class="line">          <span class="attr">scale:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">mean:</span> <span class="string">[</span> <span class="number">123.675</span><span class="string">,</span> <span class="number">116.28</span><span class="string">,</span> <span class="number">103.53</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">std:</span> <span class="string">[</span> <span class="number">58.395</span><span class="string">,</span> <span class="number">57.12</span><span class="string">,</span> <span class="number">57.375</span> <span class="string">]</span></span><br><span class="line">          <span class="attr">order:</span> <span class="string">'hwc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ToCHWImage:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">KeepKeys:</span></span><br><span class="line">          <span class="attr">keep_keys:</span> <span class="string">[</span> <span class="string">'input_ids'</span><span class="string">,</span> <span class="string">'bbox'</span><span class="string">,</span> <span class="string">'attention_mask'</span><span class="string">,</span> <span class="string">'token_type_ids'</span><span class="string">,</span> <span class="string">'entities'</span><span class="string">,</span> <span class="string">'relations'</span><span class="string">]</span> <span class="comment"># dataloader will return list in this order</span></span><br><span class="line">  <span class="attr">loader:</span></span><br><span class="line">    <span class="attr">shuffle:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">drop_last:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">batch_size_per_card:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">num_workers:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure>

### 开始训练

创建训练代码</code>demo/train.py<code>，训练源码位置：</code>paddleocr/tools/train.py<code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2020 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">".."</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> paddle</span><br><span class="line"><span class="keyword">import</span> paddle.distributed <span class="keyword">as</span> dist</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.data <span class="keyword">import</span> build_dataloader, set_signal_handlers</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.modeling.architectures <span class="keyword">import</span> build_model</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.losses <span class="keyword">import</span> build_loss</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.optimizer <span class="keyword">import</span> build_optimizer</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.postprocess <span class="keyword">import</span> build_post_process</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.metrics <span class="keyword">import</span> build_metric</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.save_load <span class="keyword">import</span> load_model</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.utility <span class="keyword">import</span> set_seed</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.modeling.architectures <span class="keyword">import</span> apply_to_static</span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.program <span class="keyword">as</span> program</span><br><span class="line"><span class="keyword">import</span> paddleocr.tools.naive_sync_bn <span class="keyword">as</span> naive_sync_bn</span><br><span class="line"></span><br><span class="line">dist.get_world_size()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(config, device, logger, vdl_writer, seed)</span>:</span></span><br><span class="line">    <span class="comment"># init dist environment</span></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Global"</span>][<span class="string">"distributed"</span>]:</span><br><span class="line">        dist.init_parallel_env()</span><br><span class="line"></span><br><span class="line">    global_config = config[<span class="string">"Global"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build dataloader</span></span><br><span class="line">    set_signal_handlers()</span><br><span class="line">    train_dataloader = build_dataloader(config, <span class="string">"Train"</span>, device, logger, seed)</span><br><span class="line">    <span class="keyword">if</span> len(train_dataloader) == <span class="number">0</span>:</span><br><span class="line">        logger.error(</span><br><span class="line">            <span class="string">"No Images in train dataset, please ensure\n"</span></span><br><span class="line">            + <span class="string">"\t1. The images num in the train label_file_list should be larger than or equal with batch size.\n"</span></span><br><span class="line">            + <span class="string">"\t2. The annotation file and path in the configuration file are provided normally."</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Eval"</span>]:</span><br><span class="line">        valid_dataloader = build_dataloader(config, <span class="string">"Eval"</span>, device, logger, seed)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        valid_dataloader = <span class="literal">None</span></span><br><span class="line">    step_pre_epoch = len(train_dataloader)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build post process</span></span><br><span class="line">    post_process_class = build_post_process(config[<span class="string">"PostProcess"</span>], global_config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build model</span></span><br><span class="line">    <span class="comment"># for rec algorithm</span></span><br><span class="line">    <span class="keyword">if</span> hasattr(post_process_class, <span class="string">"character"</span>):</span><br><span class="line">        char_num = len(getattr(post_process_class, <span class="string">"character"</span>))</span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"Architecture"</span>][<span class="string">"algorithm"</span>] <span class="keyword">in</span> [</span><br><span class="line">            <span class="string">"Distillation"</span>,</span><br><span class="line">        ]:  <span class="comment"># distillation model</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>]:</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][<span class="string">"name"</span>] == <span class="string">"MultiHead"</span></span><br><span class="line">                ):  <span class="comment"># for multi head</span></span><br><span class="line">                    <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"DistillationSARLabelDecode"</span>:</span><br><span class="line">                        char_num = char_num - <span class="number">2</span></span><br><span class="line">                    <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"DistillationNRTRLabelDecode"</span>:</span><br><span class="line">                        char_num = char_num - <span class="number">3</span></span><br><span class="line">                    out_channels_list = &#123;&#125;</span><br><span class="line">                    out_channels_list[<span class="string">"CTCLabelDecode"</span>] = char_num</span><br><span class="line">                    <span class="comment"># update SARLoss params</span></span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">-1</span>].keys())[<span class="number">0</span>]</span><br><span class="line">                        == <span class="string">"DistillationSARLoss"</span></span><br><span class="line">                    ):</span><br><span class="line">                        config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">-1</span>][<span class="string">"DistillationSARLoss"</span>][</span><br><span class="line">                            <span class="string">"ignore_index"</span></span><br><span class="line">                        ] = (char_num + <span class="number">1</span>)</span><br><span class="line">                        out_channels_list[<span class="string">"SARLabelDecode"</span>] = char_num + <span class="number">2</span></span><br><span class="line">                    <span class="keyword">elif</span> any(</span><br><span class="line">                        <span class="string">"DistillationNRTRLoss"</span> <span class="keyword">in</span> d</span><br><span class="line">                        <span class="keyword">for</span> d <span class="keyword">in</span> config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>]</span><br><span class="line">                    ):</span><br><span class="line">                        out_channels_list[<span class="string">"NRTRLabelDecode"</span>] = char_num + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][</span><br><span class="line">                        <span class="string">"out_channels_list"</span></span><br><span class="line">                    ] = out_channels_list</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    config[<span class="string">"Architecture"</span>][<span class="string">"Models"</span>][key][<span class="string">"Head"</span>][</span><br><span class="line">                        <span class="string">"out_channels"</span></span><br><span class="line">                    ] = char_num</span><br><span class="line">        <span class="keyword">elif</span> config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"name"</span>] == <span class="string">"MultiHead"</span>:  <span class="comment"># for multi head</span></span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"SARLabelDecode"</span>:</span><br><span class="line">                char_num = char_num - <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"NRTRLabelDecode"</span>:</span><br><span class="line">                char_num = char_num - <span class="number">3</span></span><br><span class="line">            out_channels_list = &#123;&#125;</span><br><span class="line">            out_channels_list[<span class="string">"CTCLabelDecode"</span>] = char_num</span><br><span class="line">            <span class="comment"># update SARLoss params</span></span><br><span class="line">            <span class="keyword">if</span> list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>].keys())[<span class="number">0</span>] == <span class="string">"SARLoss"</span>:</span><br><span class="line">                <span class="keyword">if</span> config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>] = &#123;</span><br><span class="line">                        <span class="string">"ignore_index"</span>: char_num + <span class="number">1</span></span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>][<span class="string">"SARLoss"</span>][<span class="string">"ignore_index"</span>] = (</span><br><span class="line">                        char_num + <span class="number">1</span></span><br><span class="line">                    )</span><br><span class="line">                out_channels_list[<span class="string">"SARLabelDecode"</span>] = char_num + <span class="number">2</span></span><br><span class="line">            <span class="keyword">elif</span> list(config[<span class="string">"Loss"</span>][<span class="string">"loss_config_list"</span>][<span class="number">1</span>].keys())[<span class="number">0</span>] == <span class="string">"NRTRLoss"</span>:</span><br><span class="line">                out_channels_list[<span class="string">"NRTRLabelDecode"</span>] = char_num + <span class="number">3</span></span><br><span class="line">            config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"out_channels_list"</span>] = out_channels_list</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># base rec model</span></span><br><span class="line">            config[<span class="string">"Architecture"</span>][<span class="string">"Head"</span>][<span class="string">"out_channels"</span>] = char_num</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"PostProcess"</span>][<span class="string">"name"</span>] == <span class="string">"SARLabelDecode"</span>:  <span class="comment"># for SAR model</span></span><br><span class="line">            config[<span class="string">"Loss"</span>][<span class="string">"ignore_index"</span>] = char_num - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    model = build_model(config[<span class="string">"Architecture"</span>])</span><br><span class="line"></span><br><span class="line">    use_sync_bn = config[<span class="string">"Global"</span>].get(<span class="string">"use_sync_bn"</span>, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> use_sync_bn:</span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">"Global"</span>].get(<span class="string">"use_npu"</span>, <span class="literal">False</span>):</span><br><span class="line">            naive_sync_bn.convert_syncbn(model)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            model = paddle.nn.SyncBatchNorm.convert_sync_batchnorm(model)</span><br><span class="line">        logger.info(<span class="string">"convert_sync_batchnorm"</span>)</span><br><span class="line"></span><br><span class="line">    model = apply_to_static(model, config, logger)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build loss</span></span><br><span class="line">    loss_class = build_loss(config[<span class="string">"Loss"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build optim</span></span><br><span class="line">    optimizer, lr_scheduler = build_optimizer(</span><br><span class="line">        config[<span class="string">"Optimizer"</span>],</span><br><span class="line">        epochs=config[<span class="string">"Global"</span>][<span class="string">"epoch_num"</span>],</span><br><span class="line">        step_each_epoch=len(train_dataloader),</span><br><span class="line">        model=model,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build metric</span></span><br><span class="line">    eval_class = build_metric(config[<span class="string">"Metric"</span>])</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"train dataloader has &#123;&#125; iters"</span>.format(len(train_dataloader)))</span><br><span class="line">    <span class="keyword">if</span> valid_dataloader <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logger.info(<span class="string">"valid dataloader has &#123;&#125; iters"</span>.format(len(valid_dataloader)))</span><br><span class="line"></span><br><span class="line">    use_amp = config[<span class="string">"Global"</span>].get(<span class="string">"use_amp"</span>, <span class="literal">False</span>)</span><br><span class="line">    amp_level = config[<span class="string">"Global"</span>].get(<span class="string">"amp_level"</span>, <span class="string">"O2"</span>)</span><br><span class="line">    amp_dtype = config[<span class="string">"Global"</span>].get(<span class="string">"amp_dtype"</span>, <span class="string">"float16"</span>)</span><br><span class="line">    amp_custom_black_list = config[<span class="string">"Global"</span>].get(<span class="string">"amp_custom_black_list"</span>, [])</span><br><span class="line">    amp_custom_white_list = config[<span class="string">"Global"</span>].get(<span class="string">"amp_custom_white_list"</span>, [])</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(</span><br><span class="line">        os.path.join(config[<span class="string">"Global"</span>][<span class="string">"save_model_dir"</span>], <span class="string">"train_result.json"</span>)</span><br><span class="line">    ):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.remove(</span><br><span class="line">                os.path.join(config[<span class="string">"Global"</span>][<span class="string">"save_model_dir"</span>], <span class="string">"train_result.json"</span>)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> use_amp:</span><br><span class="line">        AMP_RELATED_FLAGS_SETTING = &#123;</span><br><span class="line">            <span class="string">"FLAGS_max_inplace_grad_add"</span>: <span class="number">8</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> paddle.is_compiled_with_cuda():</span><br><span class="line">            AMP_RELATED_FLAGS_SETTING.update(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"FLAGS_cudnn_batchnorm_spatial_persistent"</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">"FLAGS_gemm_use_half_precision_compute_type"</span>: <span class="number">0</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        paddle.set_flags(AMP_RELATED_FLAGS_SETTING)</span><br><span class="line">        scale_loss = config[<span class="string">"Global"</span>].get(<span class="string">"scale_loss"</span>, <span class="number">1.0</span>)</span><br><span class="line">        use_dynamic_loss_scaling = config[<span class="string">"Global"</span>].get(</span><br><span class="line">            <span class="string">"use_dynamic_loss_scaling"</span>, <span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        scaler = paddle.amp.GradScaler(</span><br><span class="line">            init_loss_scaling=scale_loss,</span><br><span class="line">            use_dynamic_loss_scaling=use_dynamic_loss_scaling,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> amp_level == <span class="string">"O2"</span>:</span><br><span class="line">            model, optimizer = paddle.amp.decorate(</span><br><span class="line">                models=model,</span><br><span class="line">                optimizers=optimizer,</span><br><span class="line">                level=amp_level,</span><br><span class="line">                master_weight=<span class="literal">True</span>,</span><br><span class="line">                dtype=amp_dtype,</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        scaler = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># load pretrain model</span></span><br><span class="line">    pre_best_model_dict = load_model(</span><br><span class="line">        config, model, optimizer, config[<span class="string">"Architecture"</span>][<span class="string">"model_type"</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">"Global"</span>][<span class="string">"distributed"</span>]:</span><br><span class="line">        model = paddle.DataParallel(model)</span><br><span class="line">    <span class="comment"># start train</span></span><br><span class="line">    program.train(</span><br><span class="line">        config,</span><br><span class="line">        train_dataloader,</span><br><span class="line">        valid_dataloader,</span><br><span class="line">        device,</span><br><span class="line">        model,</span><br><span class="line">        loss_class,</span><br><span class="line">        optimizer,</span><br><span class="line">        lr_scheduler,</span><br><span class="line">        post_process_class,</span><br><span class="line">        eval_class,</span><br><span class="line">        pre_best_model_dict,</span><br><span class="line">        logger,</span><br><span class="line">        step_pre_epoch,</span><br><span class="line">        vdl_writer,</span><br><span class="line">        scaler,</span><br><span class="line">        amp_level,</span><br><span class="line">        amp_custom_black_list,</span><br><span class="line">        amp_custom_white_list,</span><br><span class="line">        amp_dtype,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_reader</span><span class="params">(config, device, logger)</span>:</span></span><br><span class="line">    loader = build_dataloader(config, <span class="string">"Train"</span>, device, logger)</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    starttime = time.time()</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> loader():</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count % <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">                batch_time = time.time() - starttime</span><br><span class="line">                starttime = time.time()</span><br><span class="line">                logger.info(</span><br><span class="line">                    <span class="string">"reader: &#123;&#125;, &#123;&#125;, &#123;&#125;"</span>.format(count, len(data[<span class="number">0</span>]), batch_time)</span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.info(e)</span><br><span class="line">    logger.info(<span class="string">"finish reader: &#123;&#125;, Success!"</span>.format(count))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    config, device, logger, vdl_writer = program.preprocess(is_train=<span class="literal">True</span>)</span><br><span class="line">    seed = config[<span class="string">"Global"</span>][<span class="string">"seed"</span>] <span class="keyword">if</span> <span class="string">"seed"</span> <span class="keyword">in</span> config[<span class="string">"Global"</span>] <span class="keyword">else</span> <span class="number">1024</span></span><br><span class="line">    set_seed(seed)</span><br><span class="line">    main(config, device, logger, vdl_writer, seed)</span><br><span class="line">    <span class="comment"># test_reader(config, device, logger)</span></span><br></pre></td></tr></table></figure>

根据训练目标的配置文件，分发显卡和训练任务：

&lt;font color=&#39;gold&#39;&gt;**SER**&lt;/font&gt;:</code>CUDA_VISIBLE_DEVICES=0 python train.py -c ser_vi_layoutxlm_xfund_zh.yml<code>&lt;font color=&#39;gold&#39;&gt;**RE**&lt;/font&gt;:</code>CUDA_VISIBLE_DEVICES=1 python train.py -c re_vi_layoutxlm_xfund_zh.yml<code>首次启动将自动下载预训练模型。日志输出样例如下：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2024/11/26 17:35:39] ppocr INFO: epoch: [1/200], global_step: 10, lr: 0.000006, loss: 1.838789, avg_reader_cost: 0.39165 s, avg_batch_cost: 0.54732 s, avg_samples: 8.0, ips: 14.61671 samples/s, eta: 0:34:34, max_mem_reserved: 11694 MB, max_mem_allocated: 10523 MB</span><br><span class="line">[2024/11/26 17:35:43] ppocr INFO: epoch: [1/200], global_step: 19, lr: 0.000018, loss: 1.446505, avg_reader_cost: 0.22235 s, avg_batch_cost: 0.32516 s, avg_samples: 6.9, ips: 21.22014 samples/s, eta: 0:28:56, max_mem_reserved: 11694 MB, max_mem_allocated: 10523 MB</span><br><span class="line">eval model:: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:04&lt;00:00,  1.61it/s]</span><br><span class="line">[2024/11/26 17:35:47] ppocr INFO: cur metric, precision: 0.05993363749481543, recall: 0.10410662824207492, hmean: 0.07607265069755198, fps: 101.1334614167882</span><br><span class="line">[2024/11/26 17:36:22] ppocr INFO: save best model is to ./output/ser_vi_layoutxlm_xfund_zh/best_accuracy</span><br><span class="line">[2024/11/26 17:36:22] ppocr INFO: best metric, hmean: 0.07607265069755198, precision: 0.05993363749481543, recall: 0.10410662824207492, fps: 101.1334614167882, best_epoch: 1</span><br><span class="line">[2024/11/26 17:36:39] ppocr INFO: save model in ./output/ser_vi_layoutxlm_xfund_zh/latest</span><br></pre></td></tr></table></figure>

### 模型导出

训练结束后，进入最佳模型目录</code>demo/output/re_vi_layoutxlm_xfund_zh/best_accuracy<code>，此时模型不具备</code>.pdmodel<code>文件，不能直接用于预测，需要导出为inference模型（本文适当略过模型评估步骤）

![](关键信息提取（KIE）\3.png)

创建模型导出代码</code>demo/export_model.py<code>，导出源码位置：</code>paddleocr/tools/export_model.py<code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2020 PaddlePaddle Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__dir__ = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(__dir__)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.abspath(os.path.join(__dir__, <span class="string">".."</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> paddleocr.tools.program <span class="keyword">import</span> load_config, merge_config, ArgsParser</span><br><span class="line"><span class="keyword">from</span> paddleocr.ppocr.utils.export_model <span class="keyword">import</span> export</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    FLAGS = ArgsParser().parse_args()</span><br><span class="line">    config = load_config(FLAGS.config)</span><br><span class="line">    config = merge_config(config, FLAGS.opt)</span><br><span class="line">    <span class="comment"># export model</span></span><br><span class="line">    export(config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

导出命令：

&lt;font color=&#39;gold&#39;&gt;**SER**&lt;/font&gt;:

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python export_model.py -c ser_vi_layoutxlm_xfund_zh.yml -o Architecture.Backbone.checkpoints=./output/ser_vi_layoutxlm_xfund_z</span><br><span class="line">h/best_accuracy Global.save_inference_dir=./inference/ser_vi_layoutxlm Global.save_inference_dir=./inference/ser_vi_layoutxlm</span><br></pre></td></tr></table></figure>

&lt;font color=&#39;gold&#39;&gt;**RE**&lt;/font&gt;:

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python export_model.py -c re_vi_layoutxlm_xfund_zh.yml -o Architecture.Backbone.checkpoints=./output/re_vi_layoutxlm_xfund_z</span><br><span class="line">h/best_accuracy Global.save_inference_dir=./inference/re_vi_layoutxlm Global.save_inference_dir=./inference/re_vi_layoutxlm</span><br></pre></td></tr></table></figure>

将在</code>demo/inference目录下生成导出的推理模型<code>，可修改args参数中模型路径进行验证。

## 客制化

### 标注工具：PPOCRLabel

操作系统回到windows，并创建</code>demo/dataset/temp<code>文件夹存放训练图像

安装：</code>pip install PPOCRLabel==2.1.3 -i <a href="https://pypi.tuna.tsinghua.edu.cn/simple`" target="_blank" rel="noopener">https://pypi.tuna.tsinghua.edu.cn/simple`</a><br><br>启动：<code>PPOCRLabel --lang ch --kie True</code><br><br>此时标注工具左下角显示关键词列表项<br><br><img src="/2024/11/26/关键信息提取（KIE）/4.png" alt><br><br><font color="red"><strong>注：</strong></font> 最新版可能存在bug，建议使用2.1.3版本。<strong>且截至目前（24.11月 v2.1.12版本），工具仍不具备RE任务关系标注功能，需制作后处理脚本</strong> <font color="red"><strong>*难点</strong></font>

<h3 id="后处理："><a href="#后处理：" class="headerlink" title="后处理："></a>后处理：</h3><font color="gold"><strong>SER</strong></font>

<p>创建SER任务处理代码<code>demo/trans+ppocrlabel.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./dataset/temp/Label.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> l:</span><br><span class="line">    content = l.readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> content:</span><br><span class="line">        image = line.split(<span class="string">'\t'</span>)[<span class="number">0</span>]</span><br><span class="line">        label = json.loads(line.split(<span class="string">'\t'</span>)[<span class="number">1</span>])</span><br><span class="line">        label_set = []</span><br><span class="line">        <span class="keyword">for</span> i, lab <span class="keyword">in</span> enumerate(label):</span><br><span class="line">            new_lab = &#123;</span><br><span class="line">                <span class="string">'transcription'</span>: lab.get(<span class="string">'transcription'</span>),</span><br><span class="line">                <span class="string">'points'</span>: lab.get(<span class="string">'points'</span>),</span><br><span class="line">                <span class="string">'label'</span>: lab.get(<span class="string">'key_cls'</span>),</span><br><span class="line">                <span class="string">'id'</span>: i,</span><br><span class="line">                <span class="string">'linking'</span>: []</span><br><span class="line">            &#125;</span><br><span class="line">            label_set.append(new_lab)</span><br><span class="line">            label_set_json = json.dumps(label_set, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'./dataset/project/train.json'</span>, <span class="string">'a+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(image)</span><br><span class="line">            f.write(<span class="string">'\t'</span>)</span><br><span class="line">            f.write(label_set_json)</span><br><span class="line">            f.write(<span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>
<font color="gold"><strong>RE</strong></font>

<p>测试中，未完待续</p>

      
    </div>
    <footer class="article-footer">
      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KIE/">KIE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OCR/">OCR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paddle/">paddle</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2024/08/06/间隙树排序算法的可视化/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">间隙树排序算法的可视化</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境准备"><span class="nav-number">1.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器"><span class="nav-number">1.1.</span> <span class="nav-text">服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后处理："><span class="nav-number">1.2.</span> <span class="nav-text">后处理：</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2017 - 2024 青域 All Rights Reserved.</p>

	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            青域
          </div>
          <div class="panel-body">
            Copyright © 2024 tianL.R All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/hijiki.model.json"},"display":{"position":"left","width":170,"height":340},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>